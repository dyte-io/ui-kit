var t=i;function i(){}i.mixin=function(t){var i=t.prototype||t;i.isWildEmitter=!0,i.on=function(t,i,n){this.callbacks=this.callbacks||{};var r=3===arguments.length,e=r?arguments[2]:arguments[1];return e._groupName=r?arguments[1]:void 0,(this.callbacks[t]=this.callbacks[t]||[]).push(e),this},i.once=function(t,i,n){var r=this,e=3===arguments.length,o=e?arguments[2]:arguments[1];return this.on(t,e?arguments[1]:void 0,(function i(){r.off(t,i),o.apply(this,arguments)})),this},i.releaseGroup=function(t){var i,n,r,e;for(i in this.callbacks=this.callbacks||{},this.callbacks)for(n=0,r=(e=this.callbacks[i]).length;n<r;n++)e[n]._groupName===t&&(e.splice(n,1),n--,r--);return this},i.off=function(t,i){this.callbacks=this.callbacks||{};var n,r=this.callbacks[t];return r?1===arguments.length?(delete this.callbacks[t],this):(-1!==(n=r.indexOf(i))&&(r.splice(n,1),0===r.length&&delete this.callbacks[t]),this):this},i.emit=function(t){this.callbacks=this.callbacks||{};var i,n,r,e=[].slice.call(arguments,1),o=this.callbacks[t],s=this.getWildcardCallbacks(t);if(o)for(i=0,n=(r=o.slice()).length;i<n&&r[i];++i)r[i].apply(this,e);if(s)for(n=s.length,i=0,n=(r=s.slice()).length;i<n&&r[i];++i)r[i].apply(this,[t].concat(e));return this},i.getWildcardCallbacks=function(t){this.callbacks=this.callbacks||{};var i,n,r=[];for(i in this.callbacks)n=i.split("*"),("*"===i||2===n.length&&t.slice(0,n[0].length)===n[0])&&(r=r.concat(this.callbacks[i]));return r}},i.mixin(i);var n,r=t;"undefined"!=typeof window&&(n=window.AudioContext||window.webkitAudioContext);var e=null,o=function(t,i){var o=new r;if(!n)return o;var s,f,u,h=(i=i||{}).smoothing||.1,a=i.interval||50,c=i.threshold,v=i.play,d=i.history||10,l=!0;e=i.audioContext||e||new n,(u=e.createAnalyser()).fftSize=512,u.smoothingTimeConstant=h,f=new Float32Array(u.frequencyBinCount),t.jquery&&(t=t[0]),t instanceof HTMLAudioElement||t instanceof HTMLVideoElement?(s=e.createMediaElementSource(t),void 0===v&&(v=!0),c=c||-50):(s=e.createMediaStreamSource(t),c=c||-50),s.connect(u),v&&u.connect(e.destination),o.speaking=!1,o.suspend=function(){return e.suspend()},o.resume=function(){return e.resume()},Object.defineProperty(o,"state",{get:function(){return e.state}}),e.onstatechange=function(){o.emit("state_change",e.state)},o.setThreshold=function(t){c=t},o.setInterval=function(t){a=t},o.stop=function(){l=!1,o.emit("volume_change",-100,c),o.speaking&&(o.speaking=!1,o.emit("stopped_speaking")),u.disconnect(),s.disconnect()},o.speakingHistory=[];for(var p=0;p<d;p++)o.speakingHistory.push(0);var w=function(){setTimeout((function(){if(l){var t=function(t,i){var n=-1/0;t.getFloatFrequencyData(i);for(var r=4,e=i.length;r<e;r++)i[r]>n&&i[r]<0&&(n=i[r]);return n}(u,f);o.emit("volume_change",t,c);var i=0;if(t>c&&!o.speaking){for(var n=o.speakingHistory.length-3;n<o.speakingHistory.length;n++)i+=o.speakingHistory[n];i>=2&&(o.speaking=!0,o.emit("speaking"))}else if(t<c&&o.speaking){for(n=0;n<o.speakingHistory.length;n++)i+=o.speakingHistory[n];0==i&&(o.speaking=!1,o.emit("stopped_speaking"))}o.speakingHistory.shift(),o.speakingHistory.push(0+(t>c)),w()}}),a)};return w(),o};export{o as h}