var t,i=n;function n(){}n.mixin=function(t){var i=t.prototype||t;i.isWildEmitter=!0,i.on=function(t,i,n){this.callbacks=this.callbacks||{};var r=3===arguments.length,e=r?arguments[1]:void 0,o=r?arguments[2]:arguments[1];return o._groupName=e,(this.callbacks[t]=this.callbacks[t]||[]).push(o),this},i.once=function(t,i,n){var r=this,e=3===arguments.length,o=e?arguments[1]:void 0,s=e?arguments[2]:arguments[1];function f(){r.off(t,f),s.apply(this,arguments)}return this.on(t,o,f),this},i.releaseGroup=function(t){var i,n,r,e;for(i in this.callbacks=this.callbacks||{},this.callbacks)for(n=0,r=(e=this.callbacks[i]).length;n<r;n++)e[n]._groupName===t&&(e.splice(n,1),n--,r--);return this},i.off=function(t,i){this.callbacks=this.callbacks||{};var n,r=this.callbacks[t];return r?1===arguments.length?(delete this.callbacks[t],this):(-1!==(n=r.indexOf(i))&&(r.splice(n,1),0===r.length&&delete this.callbacks[t]),this):this},i.emit=function(t){this.callbacks=this.callbacks||{};var i,n,r,e=[].slice.call(arguments,1),o=this.callbacks[t],s=this.getWildcardCallbacks(t);if(o)for(i=0,n=(r=o.slice()).length;i<n&&r[i];++i)r[i].apply(this,e);if(s)for(n=s.length,i=0,n=(r=s.slice()).length;i<n&&r[i];++i)r[i].apply(this,[t].concat(e));return this},i.getWildcardCallbacks=function(t){this.callbacks=this.callbacks||{};var i,n,r=[];for(i in this.callbacks)n=i.split("*"),("*"===i||2===n.length&&t.slice(0,n[0].length)===n[0])&&(r=r.concat(this.callbacks[i]));return r}},n.mixin(n),"undefined"!=typeof window&&(t=window.AudioContext||window.webkitAudioContext);var r=null,e=function(n,e){var o=new i;if(!t)return o;var s,f,u,h=(e=e||{}).smoothing||.1,a=e.interval||50,c=e.threshold,v=e.play,d=e.history||10,l=!0;r=e.audioContext||r||new t,(u=r.createAnalyser()).fftSize=512,u.smoothingTimeConstant=h,f=new Float32Array(u.frequencyBinCount),n.jquery&&(n=n[0]),n instanceof HTMLAudioElement||n instanceof HTMLVideoElement?(s=r.createMediaElementSource(n),void 0===v&&(v=!0),c=c||-50):(s=r.createMediaStreamSource(n),c=c||-50),s.connect(u),v&&u.connect(r.destination),o.speaking=!1,o.suspend=function(){return r.suspend()},o.resume=function(){return r.resume()},Object.defineProperty(o,"state",{get:function(){return r.state}}),r.onstatechange=function(){o.emit("state_change",r.state)},o.setThreshold=function(t){c=t},o.setInterval=function(t){a=t},o.stop=function(){l=!1,o.emit("volume_change",-100,c),o.speaking&&(o.speaking=!1,o.emit("stopped_speaking")),u.disconnect(),s.disconnect()},o.speakingHistory=[];for(var p=0;p<d;p++)o.speakingHistory.push(0);var w=function(){setTimeout((function(){if(l){var t=function(t,i){var n=-1/0;t.getFloatFrequencyData(i);for(var r=4,e=i.length;r<e;r++)i[r]>n&&i[r]<0&&(n=i[r]);return n}(u,f);o.emit("volume_change",t,c);var i=0;if(t>c&&!o.speaking){for(var n=o.speakingHistory.length-3;n<o.speakingHistory.length;n++)i+=o.speakingHistory[n];i>=2&&(o.speaking=!0,o.emit("speaking"))}else if(t<c&&o.speaking){for(n=0;n<o.speakingHistory.length;n++)i+=o.speakingHistory[n];0==i&&(o.speaking=!1,o.emit("stopped_speaking"))}o.speakingHistory.shift(),o.speakingHistory.push(0+(t>c)),w()}}),a)};return w(),o};export{e as h}