var DyteClient=function(){var Kf,Js,Ks,Qt,hi,pt,Xt,Ve,vs,zs,Ct,We,pi,mi,Ys,fi,Rr,zf,mt,te,Sn,Je,En,qa,pd,pg,Yf,md,Qf,fd,mg,gi,vi,ja,Xf,Ti,_n,Zf,yi,Ga,Iu,bn,Wa,eg,kr,Si,gd,tg,Zt,Ei,le,Ja,ks,Ts,Ka,Au,_i,$d,Ir,wn,Ar,za,Qs,ft,jt,bi,wi,Xs,Pi,Pn,Ci,sg,$e,Cn,es,Ri,Ya,rg,ki,Qa,Ii,Hd,ng,vd,ze,He,Ce,Is,ts,Xa,Td,Rn,kn,yd,Ai,ss,Sd,ig,Mi,Di,Za,Lt,In,eo,Oi,Li,xi,Vi,Zs,gt,Mr,Dr,Ed,fg,An,Mn,to,Mu,so,Or,_d,gg,Ui,Fi,Nr,Dn,Wo,er,ro,Lr,Bi,qd,tr,bd,no,Du,ag,xr,As,sr,Wn,On,xt,og,H,$i,Hi,wd,Rt,Wt,Pu,ji,kt,Gi,Ms,Vr,da,Ye,dt,qe,Xe,Wi,Ji,io,Ou,cg,ao,dg,vt,oo,Nn,Ds,Os,Kr,co,Nu,Pd,vg,Cd,Tg,ys,Ki,zi,Ln,rs,it,Ur,Yi,Gt,_s,Fr,Xi,lo,rr,Zi,It,At,xn,ea,ta,sa,Vn,Br,uo,ra,jd,ho,Lu,Rd,yg,kd,Sg,Id,Eg,Ad,_g,Md,bg,po,xu,mo,Vu,Dd,wg,na,Un,$r,ia,fo,Ns,go,Od,Pg,Nd,Cg,Ld,Rg,xd,kg,vo,Uu,To,Fu,Vd,Ig,yo,So,Tt,J,aa,Fn,Mt,Bn,$n,Hr,Eo,nr,oa,Hn,qn,jn,qr,la,at,Dt,Gn,Jo,_o,Bu,bo,$u,jr,Ss,ot,Vt,as,lg,wo,Po,ir,Ut,Qe,Gr,De,Oe,Ge,ns,ar,Co,Hu,Ro,qu,ug,ko,Ud,ca,is,Cu,Fd,st,Io,Ao,Bd,Ag,hg;"use strict";var AD=Object.defineProperty;var MD=(re,Re,Ee)=>Re in re?AD(re,Re,{enumerable:!0,configurable:!0,writable:!0,value:Ee}):re[Re]=Ee;var p=(re,Re,Ee)=>(MD(re,typeof Re!="symbol"?Re+"":Re,Ee),Ee),ku=(re,Re,Ee)=>{if(!Re.has(re))throw TypeError("Cannot "+Ee)};var o=(re,Re,Ee)=>(ku(re,Re,"read from private field"),Ee?Ee.call(re):Re.get(re)),g=(re,Re,Ee)=>{if(Re.has(re))throw TypeError("Cannot add the same private member more than once");Re instanceof WeakSet?Re.add(re):Re.set(re,Ee)},v=(re,Re,Ee,ua)=>(ku(re,Re,"write to private field"),ua?ua.call(re,Ee):Re.set(re,Ee),Ee);var $=(re,Re,Ee)=>(ku(re,Re,"access private method"),Ee);var re={},Re={get exports(){return re},set exports(s){re=s}},Ee=typeof Reflect=="object"?Reflect:null,ua=Ee&&typeof Ee.apply=="function"?Ee.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)},Ko;Ee&&typeof Ee.ownKeys=="function"?Ko=Ee.ownKeys:Object.getOwnPropertySymbols?Ko=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Ko=function(t){return Object.getOwnPropertyNames(t)};function Mg(s){console&&console.warn&&console.warn(s)}var ju=Number.isNaN||function(t){return t!==t};function he(){he.init.call(this)}Re.exports=he,re.once=Lg,he.EventEmitter=he,he.prototype._events=void 0,he.prototype._eventsCount=0,he.prototype._maxListeners=void 0;var Gu=10;function zo(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(he,"defaultMaxListeners",{enumerable:!0,get:function(){return Gu},set:function(s){if(typeof s!="number"||s<0||ju(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");Gu=s}}),he.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},he.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||ju(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Wu(s){return s._maxListeners===void 0?he.defaultMaxListeners:s._maxListeners}he.prototype.getMaxListeners=function(){return Wu(this)},he.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var n=t==="error",i=this._events;if(i!==void 0)n=n&&i.error===void 0;else if(!n)return!1;if(n){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var c=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw c.context=a,c}var d=i[t];if(d===void 0)return!1;if(typeof d=="function")ua(d,this,e);else for(var l=d.length,h=Qu(d,l),r=0;r<l;++r)ua(h[r],this,e);return!0};function Ju(s,t,e,r){var n,i,a;if(zo(e),i=s._events,i===void 0?(i=s._events=Object.create(null),s._eventsCount=0):(i.newListener!==void 0&&(s.emit("newListener",t,e.listener?e.listener:e),i=s._events),a=i[t]),a===void 0)a=i[t]=e,++s._eventsCount;else if(typeof a=="function"?a=i[t]=r?[e,a]:[a,e]:r?a.unshift(e):a.push(e),n=Wu(s),n>0&&a.length>n&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=s,c.type=t,c.count=a.length,Mg(c)}return s}he.prototype.addListener=function(t,e){return Ju(this,t,e,!1)},he.prototype.on=he.prototype.addListener,he.prototype.prependListener=function(t,e){return Ju(this,t,e,!0)};function Dg(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ku(s,t,e){var r={fired:!1,wrapFn:void 0,target:s,type:t,listener:e},n=Dg.bind(r);return n.listener=e,r.wrapFn=n,n}he.prototype.once=function(t,e){return zo(e),this.on(t,Ku(this,t,e)),this},he.prototype.prependOnceListener=function(t,e){return zo(e),this.prependListener(t,Ku(this,t,e)),this},he.prototype.removeListener=function(t,e){var r,n,i,a,c;if(zo(e),n=this._events,n===void 0)return this;if(r=n[t],r===void 0)return this;if(r===e||r.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if(typeof r!="function"){for(i=-1,a=r.length-1;a>=0;a--)if(r[a]===e||r[a].listener===e){c=r[a].listener,i=a;break}if(i<0)return this;i===0?r.shift():Og(r,i),r.length===1&&(n[t]=r[0]),n.removeListener!==void 0&&this.emit("removeListener",t,c||e)}return this},he.prototype.off=he.prototype.removeListener,he.prototype.removeAllListeners=function(t){var e,r,n;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[t]),this;if(arguments.length===0){var i=Object.keys(r),a;for(n=0;n<i.length;++n)a=i[n],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=r[t],typeof e=="function")this.removeListener(t,e);else if(e!==void 0)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this};function zu(s,t,e){var r=s._events;if(r===void 0)return[];var n=r[t];return n===void 0?[]:typeof n=="function"?e?[n.listener||n]:[n]:e?Ng(n):Qu(n,n.length)}he.prototype.listeners=function(t){return zu(this,t,!0)},he.prototype.rawListeners=function(t){return zu(this,t,!1)},he.listenerCount=function(s,t){return typeof s.listenerCount=="function"?s.listenerCount(t):Yu.call(s,t)},he.prototype.listenerCount=Yu;function Yu(s){var t=this._events;if(t!==void 0){var e=t[s];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}he.prototype.eventNames=function(){return this._eventsCount>0?Ko(this._events):[]};function Qu(s,t){for(var e=new Array(t),r=0;r<t;++r)e[r]=s[r];return e}function Og(s,t){for(;t+1<s.length;t++)s[t]=s[t+1];s.pop()}function Ng(s){for(var t=new Array(s.length),e=0;e<t.length;++e)t[e]=s[e].listener||s[e];return t}function Lg(s,t){return new Promise(function(e,r){function n(a){s.removeListener(t,i),r(a)}function i(){typeof s.removeListener=="function"&&s.removeListener("error",n),e([].slice.call(arguments))}Xu(s,t,i,{once:!0}),t!=="error"&&xg(s,n,{once:!0})})}function xg(s,t,e){typeof s.on=="function"&&Xu(s,"error",t,e)}function Xu(s,t,e,r){if(typeof s.on=="function")r.once?s.once(t,e):s.on(t,e);else if(typeof s.addEventListener=="function")s.addEventListener(t,function n(i){r.once&&s.removeEventListener(t,n),e(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var z;(function(s){s[s.MAJOR_EVENT=0]="MAJOR_EVENT",s[s.MINOR_EVENT=1]="MINOR_EVENT"})(z||(z={}));var N;(function(s){s.PRECALL_TEST_BEGIN="precall_begin",s.PRECALL_TEST_COMPLETE="precall_end",s.CALL_JOIN_BEGIN="call_join",s.NET_QUALITY_TEST_BEGIN="net_quality_test_begin",s.NET_QUALITY_TEST_END="net_quality_test_end",s.WEBSOCKET_CONNECTED="websocket_connected",s.TRANSPORT_CONNECTED="transport_connected",s.AUDIO_ON="audio_on",s.AUDIO_OFF="audio_off",s.VIDEO_ON="video_on",s.VIDEO_OFF="video_off",s.PARTICIPANT_ROLE="participant_role",s.PING_STAT="ping_stat",s.DISCONNECT="disconnect",s.RECONNECT_ATTEMPT="reconnect_attempt",s.SCREENSHARE_START_REQUESTED="screenshare_start_requested",s.SCREENSHARE_STARTED="screenshare_started",s.SCREENSHARE_STOPPED="screenshare_stopped",s.TAB_CHANGE="tab_change",s.BROWSER_BACKGROUNDED="browser_backgrounded",s.BROWSER_FOREGROUNDED="browser_foregrounded",s.DOMINANT_SPEAKER="dominant_speaker",s.AUDIO_DEVICES_UPDATES="audio_devices_updates",s.VIDEO_DEVICES_UPDATES="video_devices_updates",s.SPEAKER_DEVICES_UPDATES="speaker_devices_updates",s.SELECTED_MICROHPONE_UPDATE="selected_microphone_update",s.SELECTED_CAMERA_UPDATE="selected_camera_update",s.SELECTED_SPEAKER_UPDATE="selected_speaker_update",s.EXPECTED_VIDEO_RESOLUTION="expected_video_resolution",s.EXPECTED_SCREENSHARE_RESOLUTION="expected_screenshare_resolution",s.MEDIA_PERMISSION="media_permission",s.LEGACY_SWITCH="legacy_switch",s.AUDIO_PLAY_FAILED="audio_play_failed",s.VIDEO_PLAY_FAILED="video_play_failed",s.AUDIO_TRACK_MUTED="audio_track_muted",s.VIDEO_TRACK_MUTED="video_track_muted",s.IVS_PLAYER_REBUFFERING="ivs_player_rebuffering",s.IVS_PLAYER_AUDIO_BLOCKED="ivs_player_audio_blocked",s.IVS_PLAYER_PLAYBACK_BLOCKED="ivs_player_playback_blocked",s.IVS_PLAYER_ERROR="ivs_player_error",s.IVS_PLAYER_RECOVERABLE_ERROR="ivs_player_recoverable_error",s.IVS_PLAYER_WORKER_ERROR="ivs_player_worker_error",s.IVS_PLAYER_NETWORK_UNAVAILABLE="ivs_player_network_unavailable",s.LIVESTREAM_LATENCY="livestream_latency",s.IVS_PLAYER_ANALYTICS_EVENT="ivs_player_analytics_event",s.IVS_PLAYER_PLAYBACK_RATE_CHANGED="ivs_player_playback_rate_changed",s.IVS_PLAYER_QUALITY_CHANGED="ivs_player_quality_changed",s.IVS_PLAYER_INITIALIZED="ivs_player_initialized"})(N||(N={}));const Vg=new Map([[N.PRECALL_TEST_BEGIN,z.MINOR_EVENT],[N.PRECALL_TEST_COMPLETE,z.MINOR_EVENT],[N.CALL_JOIN_BEGIN,z.MAJOR_EVENT],[N.NET_QUALITY_TEST_BEGIN,z.MINOR_EVENT],[N.NET_QUALITY_TEST_END,z.MINOR_EVENT],[N.WEBSOCKET_CONNECTED,z.MINOR_EVENT],[N.TRANSPORT_CONNECTED,z.MAJOR_EVENT],[N.AUDIO_ON,z.MINOR_EVENT],[N.AUDIO_OFF,z.MINOR_EVENT],[N.VIDEO_ON,z.MINOR_EVENT],[N.VIDEO_OFF,z.MINOR_EVENT],[N.PARTICIPANT_ROLE,z.MINOR_EVENT],[N.PING_STAT,z.MAJOR_EVENT],[N.DISCONNECT,z.MAJOR_EVENT],[N.RECONNECT_ATTEMPT,z.MAJOR_EVENT],[N.SCREENSHARE_START_REQUESTED,z.MINOR_EVENT],[N.SCREENSHARE_STARTED,z.MINOR_EVENT],[N.SCREENSHARE_STOPPED,z.MINOR_EVENT],[N.TAB_CHANGE,z.MINOR_EVENT],[N.BROWSER_BACKGROUNDED,z.MINOR_EVENT],[N.BROWSER_FOREGROUNDED,z.MINOR_EVENT],[N.DOMINANT_SPEAKER,z.MINOR_EVENT],[N.AUDIO_DEVICES_UPDATES,z.MINOR_EVENT],[N.VIDEO_DEVICES_UPDATES,z.MINOR_EVENT],[N.SPEAKER_DEVICES_UPDATES,z.MINOR_EVENT],[N.SELECTED_MICROHPONE_UPDATE,z.MINOR_EVENT],[N.SELECTED_CAMERA_UPDATE,z.MINOR_EVENT],[N.SELECTED_SPEAKER_UPDATE,z.MINOR_EVENT],[N.MEDIA_PERMISSION,z.MINOR_EVENT],[N.LEGACY_SWITCH,z.MINOR_EVENT],[N.AUDIO_PLAY_FAILED,z.MINOR_EVENT],[N.VIDEO_PLAY_FAILED,z.MINOR_EVENT],[N.AUDIO_TRACK_MUTED,z.MINOR_EVENT],[N.VIDEO_TRACK_MUTED,z.MINOR_EVENT],[N.IVS_PLAYER_REBUFFERING,z.MAJOR_EVENT],[N.IVS_PLAYER_AUDIO_BLOCKED,z.MAJOR_EVENT],[N.IVS_PLAYER_PLAYBACK_BLOCKED,z.MAJOR_EVENT],[N.IVS_PLAYER_ERROR,z.MAJOR_EVENT],[N.IVS_PLAYER_RECOVERABLE_ERROR,z.MAJOR_EVENT],[N.IVS_PLAYER_WORKER_ERROR,z.MAJOR_EVENT],[N.IVS_PLAYER_NETWORK_UNAVAILABLE,z.MAJOR_EVENT],[N.LIVESTREAM_LATENCY,z.MAJOR_EVENT],[N.IVS_PLAYER_ANALYTICS_EVENT,z.MINOR_EVENT],[N.IVS_PLAYER_PLAYBACK_RATE_CHANGED,z.MINOR_EVENT],[N.IVS_PLAYER_QUALITY_CHANGED,z.MINOR_EVENT],[N.IVS_PLAYER_INITIALIZED,z.MINOR_EVENT],[N.EXPECTED_VIDEO_RESOLUTION,z.MINOR_EVENT],[N.EXPECTED_SCREENSHARE_RESOLUTION,z.MINOR_EVENT]]);class Ug{constructor(){p(this,"events");this.events=[]}add(t){this.events.push(t)}flush(){return{entries:this.events.splice(0,25)}}}class Fg extends re{constructor({logger:e,peerId:r,apiHostnames:n}){super();p(this,"logger");p(this,"peerId");p(this,"eventStore");p(this,"apiEndpoint");this.logger=e,this.peerId=r,this.apiEndpoint=`https://${n.daCollector}/api/v1/message`,this.eventStore=new Ug}async sendEventsChunkToServer(e){var n;const r={payload:e,peerId:this.peerId};try{return await fetch(this.apiEndpoint,{method:"POST",body:JSON.stringify(r)}),!0}catch(i){return this.logger.error("callStats::sendEventsChunkToServer::catch",{error:i}),(n=e.entries)==null||n.forEach(a=>{this.eventStore.add(a)}),!1}}callEvent(e){e.timestamp=new Date,this.eventStore.add(e),this.emit(e.event,e.metaData),Vg.get(e.event)===z.MAJOR_EVENT&&this.flush()}async flush(){var r;const e=this.eventStore.flush();return(r=e==null?void 0:e.entries)!=null&&r.length?(await this.sendEventsChunkToServer(e),!0):!1}}var Zu;(function(s){s.CHROMIUM="chromum",s.FIREFOX="firefox",s.SAFARI="safari"})(Zu||(Zu={}));const ha={DEVEL:"devel",PREPROD:"preprod",PROD:"prod"};var Jt;(function(s){s.AUDIO="AUDIO",s.VIDEO="VIDEO",s.SPEAKER="SPEAKER",s.SCREENSHARE="SCREENSHARE"})(Jt||(Jt={}));var eh;(function(s){s[s.INIT=0]="INIT",s[s.ACCEPTED=1]="ACCEPTED",s[s.DENIED=2]="DENIED",s[s.SYS_DENIED=3]="SYS_DENIED",s[s.FAILED=4]="FAILED",s[s.NOTFOUND=5]="NOTFOUND",s[s.NOT_APPLICABLE=6]="NOT_APPLICABLE"})(eh||(eh={}));function cr(s){return s?s.split(".").slice(0,2).concat(["0","0"]).join("."):""}function Yo({packetsLost:s,packetsSent:t}){return t>0?s*100/t:0}function Qo({packetsLost:s,packetsReceived:t}){return t+s>0?s*100/(t+s):0}const th=240,sh=720,rh=8,nh=3,Xo=10,Zo=.02,ec=.03;function xs({stat:s,weight:t,rangeMin:e,rangeMax:r,rangeRankingDirection:n}){return s==null?t:e===r?n==="UP"?s<=e?t:0:s>=r?t:0:n==="UP"?(1-Math.max(Math.min(r,Math.abs(s))-e,0)/(r-e))*t:n==="DOWN"?Math.max(Math.min(r,Math.abs(s))-e,0)/(r-e)*t:t}function ih({isLowQualityVideo:s,isVideoStuck:t,isVideoLagging:e,jitterQuality:r,packetsLostQuality:n}){const i=.8*((s?.85:1)*(e?.7:1)*(t?.5:1))+.2*(r*n);return Math.round((i+Number.EPSILON)*100)/100}function ah({packetsLost:s,packetsSent:t}){return t>0?s*100/t:0}function oh({packetsLost:s,packetsSent:t,jitter:e}){const n=xs({stat:ah({packetsLost:s,packetsSent:t}),weight:.7,rangeMin:0,rangeMax:Xo,rangeRankingDirection:"UP"}),a=xs({stat:e,weight:.3,rangeMin:Zo,rangeMax:ec,rangeRankingDirection:"UP"});return n+a}function Bg({frameWidth:s,isScreenShare:t}){return s<(t?sh:th)}function $g({framesPerSecond:s,isScreenShare:t}){return s<(t?nh:rh)}function Hg({framesEncoded:s}){return s===0}function ch({frameWidth:s,framesPerSecond:t,packetsLost:e,packetsSent:r,jitter:n,isScreenShare:i,framesEncoded:a}){const c=xs({stat:ah({packetsLost:e,packetsSent:r}),weight:1,rangeMin:0,rangeMax:Xo,rangeRankingDirection:"UP"}),d=xs({stat:n,weight:1,rangeMin:Zo,rangeMax:ec,rangeRankingDirection:"UP"}),l=Bg({frameWidth:s,isScreenShare:i}),h=$g({framesPerSecond:t,isScreenShare:i}),m=Hg({framesEncoded:a,isScreenShare:i});return ih({isLowQualityVideo:l,isVideoLagging:h,isVideoStuck:m,jitterQuality:d,packetsLostQuality:c})}function dh({packetsLost:s,packetsReceived:t}){return t+s>0?s*100/(t+s):0}function lh({concealmentEvents:s,packetsLost:t,packetsReceived:e,jitter:r}){const i=xs({stat:s,weight:.2,rangeMin:0,rangeMax:3,rangeRankingDirection:"UP"}),a=.5,c=xs({stat:dh({packetsLost:t,packetsReceived:e}),weight:a,rangeMin:0,rangeMax:Xo,rangeRankingDirection:"UP"}),l=xs({stat:r,weight:.3,rangeMin:Zo,rangeMax:ec,rangeRankingDirection:"UP"});return i+c+l}function qg({framesDecoded:s}){return s===0}function jg({framesPerSecond:s,isScreenShare:t}){return s<(t?nh:rh)}function Gg({frameWidth:s,isScreenShare:t}){return s<(t?sh:th)}function uh({frameWidth:s,framesPerSecond:t,packetsLost:e,packetsReceived:r,jitter:n,isScreenShare:i,framesDecoded:a}){const c=xs({stat:dh({packetsLost:e,packetsReceived:r}),weight:1,rangeMin:0,rangeMax:Xo,rangeRankingDirection:"UP"}),d=xs({stat:n,weight:1,rangeMin:Zo,rangeMax:ec,rangeRankingDirection:"UP"}),l=Gg({frameWidth:s,isScreenShare:i}),h=jg({framesPerSecond:t,isScreenShare:i}),m=qg({framesDecoded:a,isScreenShare:i});return ih({isLowQualityVideo:l,isVideoLagging:h,isVideoStuck:m,jitterQuality:d,packetsLostQuality:c})}class Vs{constructor(t){p(this,"pc1");p(this,"pc2");p(this,"constrainVideoBitrateKbps");p(this,"constrainOfferToRemoveVideoFec",!1);p(this,"iceCandidateFilter");const e=new RTCPeerConnection(t),r=new RTCPeerConnection(t);this.pc1=e,this.pc2=r,this.iceCandidateFilter=Vs.noFilter,this.pc1.addEventListener("icecandidate",this.onIceCandidate.bind(this,this.pc2)),this.pc2.addEventListener("icecandidate",this.onIceCandidate.bind(this,this.pc1))}static parseCandidate(t){const e="candidate:",r=t.indexOf(e)+e.length,n=t.substr(r).split(" ");return{type:n[7],protocol:n[2],address:n[4]}}static isNotHostCandidate(t){return t.type!=="host"}static isHost(t){return t.type==="host"}static isRelay(t){return t.type==="relay"}static isReflexive(t){return t.type==="srflx"}static noFilter(t){return!0}onIceCandidate(t,e){if(e.candidate){const r=Vs.parseCandidate(e.candidate.candidate);this.iceCandidateFilter(r)&&t.addIceCandidate(e.candidate)}}setIceCandidateFilter(t){this.iceCandidateFilter=t}constrainVideoBitrate(t){this.constrainVideoBitrateKbps=t}disableVideoFec(){this.constrainOfferToRemoveVideoFec=!0}gotOffer(t){this.constrainOfferToRemoveVideoFec&&(t.sdp=t.sdp.replace(/(m=video 1 [^\r]+)(116 117)(\r\n)/g,`$1\r
`),t.sdp=t.sdp.replace(/a=rtpmap:116 red\/90000\r\n/g,""),t.sdp=t.sdp.replace(/a=rtpmap:117 ulpfec\/90000\r\n/g,""),t.sdp=t.sdp.replace(/a=rtpmap:98 rtx\/90000\r\n/g,""),t.sdp=t.sdp.replace(/a=fmtp:98 apt=116\r\n/g,"")),this.pc1.setLocalDescription(t),this.pc2.setRemoteDescription(t),this.pc2.createAnswer().then(this.gotAnswer.bind(this),this.reportFatal.bind(this))}gotAnswer(t){this.constrainVideoBitrateKbps&&(t.sdp=t.sdp.replace(/a=mid:video\r\n/g,`a=mid:video\r
b=AS:${this.constrainVideoBitrateKbps}\r
`)),this.pc2.setLocalDescription(t),this.pc1.setRemoteDescription(t)}establishConnection(){this.pc1.createOffer().then(this.gotOffer.bind(this),this.reportFatal.bind(this))}reportFatal(t){console.error("Error:",t)}async getRoundTripTime(){const[t,e]=await Promise.all([this.pc1.getStats(),this.pc2.getStats()]);let r,n;if(t.forEach(i=>{i.type==="candidate-pair"&&i.nominated===!0&&i.bytesSent>0&&(r=i)}),e.forEach(i=>{i.type==="candidate-pair"&&i.nominated===!0&&i.bytesReceived>0&&(n=i)}),r&&n)try{if(r.currentRoundTripTime&&n.currentRoundTripTime)return{rtt:r.currentRoundTripTime,backendRTT:n.currentRoundTripTime};const i=(n.lastPacketReceivedTimestamp-r.lastPacketSentTimestamp)/1e3;return{rtt:i,backendRTT:i}}catch(i){return}}close(){this.pc1.close(),this.pc2.close()}}class hh extends re{constructor(e){super();p(this,"call");p(this,"timeOut");this.call=new Vs(e)}start(e=1e4){this.call.establishConnection(),this.timeOut=setTimeout(this.testFailed.bind(this),e)}testComplete(e){clearTimeout(this.timeOut),this.call.close(),this.emit("done",e)}testFailed(e){this.call.close(),this.emit("failed",e)}}const Wg=8,Jg=1/1e3;class Kg extends hh{constructor(e){super(e);p(this,"senderChannel");p(this,"recieveChannel");p(this,"startTime");p(this,"lastBitrateMeasureTime");p(this,"sentPayloadBytes",0);p(this,"recievedPayloadBytes",0);p(this,"lastReceivedPayloadBytes",0);p(this,"stopSending",!1);p(this,"testProgress",0);p(this,"samplePacket","");p(this,"finalBitrateSum",0);p(this,"bitRateSampels",0);p(this,"maxNumberOfPacketsToSend",0);p(this,"bytesToKeepBuffered",0);p(this,"testDurationSeconds",5);this.call.setIceCandidateFilter(Vs.isNotHostCandidate),this.senderChannel=this.call.pc1.createDataChannel(null);for(let r=0;r<262144;r+=1)this.samplePacket+="h";this.maxNumberOfPacketsToSend=1,this.bytesToKeepBuffered=1024*this.maxNumberOfPacketsToSend,this.testDurationSeconds=4,this.senderChannel.addEventListener("open",this.sendingStep.bind(this)),this.call.pc2.addEventListener("datachannel",this.onRecieverChannel.bind(this))}sendingStep(){const e=new Date;this.startTime||(this.startTime=e,this.lastBitrateMeasureTime=e);for(let n=0;n!==this.maxNumberOfPacketsToSend&&!(this.senderChannel.bufferedAmount>=this.bytesToKeepBuffered);n+=1){this.sentPayloadBytes+=this.samplePacket.length;try{this.senderChannel.send(this.samplePacket)}catch(i){}}const r=e.getTime()-this.startTime.getTime();r>=1e3*this.testDurationSeconds?(this.stopSending=!0,this.testProgress=100):(this.testProgress=r/(10*this.testDurationSeconds),setTimeout(this.sendingStep.bind(this),1))}onMessageRecieved(e){this.recievedPayloadBytes+=e.data.length;const r=new Date,n=r.getTime()-this.lastBitrateMeasureTime.getTime();if(n>=1e3){const a=(this.recievedPayloadBytes-this.lastReceivedPayloadBytes)*Wg/(n/1e3);this.finalBitrateSum+=a,this.bitRateSampels+=1,this.lastReceivedPayloadBytes=this.recievedPayloadBytes,this.lastBitrateMeasureTime=r}if(this.stopSending&&this.sentPayloadBytes===this.recievedPayloadBytes){const i=this.finalBitrateSum/this.bitRateSampels;this.testComplete({throughput:Math.round(i*Jg)})}}testComplete(e){this.call.getRoundTripTime().then(({rtt:r,backendRTT:n})=>super.testComplete({RTT:r,backendRTT:n,throughput:e.throughput}))}onRecieverChannel(e){this.recieveChannel=e.channel,this.recieveChannel.addEventListener("message",this.onMessageRecieved.bind(this))}}class Gd extends hh{constructor(e,r=Vs.noFilter){super(e);p(this,"ch1");p(this,"ch2");this.call.setIceCandidateFilter(r);const n=this.call.pc1.createDataChannel(null);this.ch1=n,n.addEventListener("open",()=>{n.send("hello")}),n.addEventListener("message",this.onCh1Recieve.bind(this)),this.call.pc2.addEventListener("datachannel",this.dataChannelHandler.bind(this))}onCh1Recieve(e){e.data!=="world"?this.hangup("Invalid data transmitted."):this.testComplete({connectivity:!0})}onCh2Recieve(e){if(e.data!=="hello")this.hangup("Invalid data transmitted.");else try{this.ch2.send("world")}catch(r){}}dataChannelHandler(e){const r=e.channel;this.ch2=r,r.addEventListener("message",this.onCh2Recieve.bind(this))}hangup(e){this.testFailed(e)}}class zg extends Gd{constructor(t){super(t,Vs.isHost)}}class Yg extends Gd{constructor(t){super(t,Vs.isRelay)}}class Qg extends Gd{constructor(t){super(t,Vs.isReflexive)}}class Xg{constructor(){p(this,"ipInformation",null)}async getIPDetails({peerId:t,apiHostnames:e,logger:r}){var n,i,a;if(!this.ipInformation){try{const c=`https://${e.location}`,l=await(await fetch(c)).json();if(((n=l.loc)==null?void 0:n.length)>5)return this.ipInformation=l,(i=this.ipInformation)!=null&&i.ip&&(this.ipInformation.ip=cr(this.ipInformation.ip)),l;throw Error("Insufficient data")}catch(c){r.error("callstats::ipDetails:: failed to fetch ip using location service",{error:c})}try{const c=await fetch(`https://${e.locationLegacy}/?token=3c493932b0624c&peerId=${t}`,{method:"POST"});this.ipInformation=await c.json(),(a=this.ipInformation)!=null&&a.ip&&(this.ipInformation.ip=cr(this.ipInformation.ip))}catch(c){r.error("callstats::ipDetails:: failed to fetch ip using legacy location service",{error:c})}}return this.ipInformation}resetCache(){this.ipInformation=null}}const Wd=new Xg,ph=[{urls:"turn:turn.dyte.in:443?transport=tcp",username:"dyte",credential:"dytein",credentialType:"password"},{urls:"turn:turn.dyte.in:3478?transport=udp",username:"dyte",credential:"dytein",credentialType:"password"}];function mh(s){const[t,e]=s.split(",");return{coords:{latitude:Number(t),longitude:Number(e)}}}class fh{constructor(){p(this,"transport");p(this,"candidatePair");p(this,"outboundVideoRtp",new Map);p(this,"inboundVideoRtp",new Map);p(this,"outboundAudioRtp",new Map);p(this,"inboundAudioRtp",new Map);p(this,"remoteInboundRtp",new Map);p(this,"producerStreamMap",new Map);p(this,"consumerStreamMap",new Map);p(this,"staleProducerStreamMap",!1);p(this,"staleConsumerStreamMap",!1)}}class gh extends re{constructor(){super();p(this,"observer");p(this,"outboundProducerMap",new Map);p(this,"inboundConsumerMap",new Map);p(this,"consumerPeerIdMap",new Map);p(this,"pausedConsumerMap",new Map);p(this,"pausedProducerMap",new Map);p(this,"overallProducingTransportsStatsMap",{});p(this,"overallConsumingTransportsStatsMap",{});p(this,"overallConsumersStatsMap",{});p(this,"overallProducersStatsMap",{});p(this,"videoProducerToStatsMap",new Map);p(this,"audioProducerToStatsMap",new Map);p(this,"videoConsumerToStatsMap",new Map);p(this,"audioConsumerToStatsMap",new Map);p(this,"consumerIdsWithFreezedVideo",new Set);p(this,"consumerIdsWithFreezedAudio",new Set);p(this,"producerIdsWithFreezedVideo",new Set);p(this,"producerIdsWithFreezedAudio",new Set);p(this,"freezedProducingTransportIds",new Set);p(this,"freezedConsumingTransportIds",new Set);p(this,"screenShareProducers",new Set);p(this,"screenShareConsumers",new Set);p(this,"ipDetails");p(this,"callStatsInstance");this.observer=new re}async registerProducer(e){await this.generateProducerStreamMap(e),e.on("close",this.deregisterProducer.bind(this,e)),e.on("pause",this.pauseProducer.bind(this,e.id)),e.on("resume",this.resumeProducer.bind(this,e.id)),e.appData.screenShare===!0&&this.screenShareProducers.add(e.id)}pauseProducer(e){this.pausedProducerMap.set(e,{lastReportCalculated:!1})}resumeProducer(e){this.pausedProducerMap.delete(e)}processInboundConsumerVideoStats(e,r,n){var a,c;const i=((c=(a=this==null?void 0:this.callStatsInstance)==null?void 0:a.consumerSharedMediaStatesMap)==null?void 0:c.get(e))||{};r.totalVideoPacketsReceived===n.packetsReceived?(this.consumerIdsWithFreezedVideo.add(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callstats::measurements::consumerVideoFreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_video_status","pause",e))):(r.totalVideoPacketsReceived=n.packetsReceived,this.consumerIdsWithFreezedVideo.has(e)&&(this.consumerIdsWithFreezedVideo.delete(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callstats::measurements::consumerVideoDefreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_video_status","resume",e))))}processInboundConsumerAudioStats(e,r,n){var a,c;const i=((c=(a=this==null?void 0:this.callStatsInstance)==null?void 0:a.consumerSharedMediaStatesMap)==null?void 0:c.get(e))||{};r.totalAudioPacketsReceived===n.packetsReceived?(this.consumerIdsWithFreezedAudio.add(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::consumerAudioFreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_audio_status","pause",e))):(r.totalAudioPacketsReceived=n.packetsReceived,this.consumerIdsWithFreezedAudio.has(e)&&(this.consumerIdsWithFreezedAudio.delete(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::consumerAudioDefreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_audio_status","resume",e))))}processOutboundProducerVideoStats(e,r,n){var a;const i=((a=this==null?void 0:this.callStatsInstance)==null?void 0:a.currentUserMediaStates)||{};r.totalVideoPacketsSent===n.packetsSent?(this.producerIdsWithFreezedVideo.add(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callStats::measurements::producerVideoFreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_video_status","pause",e))):(r.totalVideoPacketsSent=n.packetsSent,this.producerIdsWithFreezedVideo.has(e)&&(this.producerIdsWithFreezedVideo.delete(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callStats::measurements::producerVideoDefreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_video_status","resume",e))))}processOutboundProducerAudioStats(e,r,n){var a;const i=((a=this==null?void 0:this.callStatsInstance)==null?void 0:a.currentUserMediaStates)||{};r.totalAudioPacketsSent===n.packetsSent?(this.producerIdsWithFreezedAudio.add(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::producerAudioFreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_audio_status","pause",e))):(r.totalAudioPacketsSent=n.packetsSent,this.producerIdsWithFreezedAudio.has(e)&&(this.producerIdsWithFreezedAudio.delete(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::producerAudioDefreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_audio_status","resume",e))))}processProducingTransportStats(e,r,n){var h;const i=((h=this==null?void 0:this.callStatsInstance)==null?void 0:h.currentUserMediaStates)||{},{audio:a,video:c,screen:d}=i,l=a||c||d;r.totalPacketsSent===n.packetsSent?(this.freezedProducingTransportIds.add(e),this.callStatsInstance&&l&&(this.callStatsInstance.logger.debug("callStats::measurements::producingTransportFreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("producing_transport_status","pause",e))):(r.totalPacketsSent=n.packetsSent,this.freezedProducingTransportIds.has(e)&&(this.freezedProducingTransportIds.delete(e),this.callStatsInstance&&l&&(this.callStatsInstance.logger.debug("callStats::measurements::producingTransportDefreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("producing_transport_status","resume",e))))}processConsumingTransportStats(e,r,n){var c,d;const a=!!Array.from(((d=(c=this==null?void 0:this.callStatsInstance)==null?void 0:c.consumerSharedMediaStatesMap)==null?void 0:d.values())||[]).reduce((l,h)=>l||h.audio||h.video||h.screen,!1);r.totalPacketsReceived===n.packetsSent?(this.freezedConsumingTransportIds.add(e),this.callStatsInstance&&a&&(this.callStatsInstance.logger.debug("callStats::measurements::consumingTransportFreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("consuming_transport_status","pause",e))):(r.totalPacketsReceived=n.packetsSent,this.freezedConsumingTransportIds.has(e)&&(this.freezedConsumingTransportIds.delete(e),this.callStatsInstance&&a&&(this.callStatsInstance.logger.debug("callStats::measurements::consumingTransportDefreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("consuming_transport_status","resume",e))))}async registerConsumer(e){await this.generateConsumerStreamMap(e),this.consumerPeerIdMap.set(e.id,{producerId:e.producerId,peerId:e.appData.peerId,appData:e.appData}),e.on("close",this.deregisterConsumer.bind(this,e)),e.on("pause",this.pauseConsumer.bind(this,e.id)),e.on("resume",this.resumeConsumer.bind(this,e.id)),e.appData.screenShare===!0&&this.screenShareConsumers.add(e.id)}pauseConsumer(e){this.pausedConsumerMap.set(e,{lastReportCalculated:!1})}resumeConsumer(e){this.pausedConsumerMap.delete(e)}async generateProducerStreamMap(e,r=!1){const n=await e.getStats(),i=r?this.getProducerStatsFromReport(this.parseRTCReport(n,["outbound-rtp","remote-inbound-rtp"],!1,e.id))[0]:void 0;for(const a of n.values())switch(a.type){case"outbound-rtp":{this.outboundProducerMap.set(a.id,e.id);break}}return i}async generateConsumerStreamMap(e,r=!1){const n=await e.getStats(),i=r?this.getConsumerStatsFromReport(this.parseRTCReport(n,["inbound-rtp"],!1,e.id))[0]:void 0;for(const a of n.values())switch(a.type){case"inbound-rtp":{this.inboundConsumerMap.set(a.id,e.id);break}}return i}deregisterProducer(e){this.outboundProducerMap.forEach((r,n)=>{r===e.id&&this.outboundProducerMap.delete(n)}),this.pausedProducerMap.delete(e.id),this.screenShareProducers.delete(e.id)}deregisterConsumer(e){this.inboundConsumerMap.forEach((r,n)=>{r===e.id&&this.inboundConsumerMap.delete(n)}),this.consumerPeerIdMap.delete(e.id),this.pausedConsumerMap.delete(e.id),this.screenShareConsumers.delete(e.id)}getIceCandidateStats(e){var r;return{id:e.id,type:e.candidateType||e.type,address:e.address,port:e.port,url:e.url,protocol:(r=e.relayProtocol)!=null?r:e.protocol,networkType:e.networkType,relatedAddress:e.relatedAddress,relatedPort:e.relatedPort}}getWorkingSimulcastVideoStats(e){return e.find(n=>{const i=n.framesEncoded>0,a=n.packetsSent>0,c=n.frameWidth&&n.frameHeight;return i&&a&&!!c})||e[e.length-1]}parseRTCReport(e,r=[],n=!1,i=void 0,a=void 0){var b,I,L,B,q,F,X,ne,ve,ct,Ls,Es,Jr;const c=e,d=new fh,l=r.length?new Set(r):void 0,h=[],m=[],f=[],y=new Map,_=new Map;for(const A of c.values()){if(l){if(l.size===0)break;if(l.has(A.type))n&&l.delete(A.type);else continue}switch(A.type){case"local-candidate":{h.push(this.getIceCandidateStats(A));break}case"remote-candidate":{m.push(this.getIceCandidateStats(A));break}case"candidate-pair":{const{nominated:E}=A,{selected:w}=A,U=A,Ae={nominated:E!=null?E:w,currentRoundTripTime:U.currentRoundTripTime,totalRoundTripTime:U.totalRoundTripTime,bytesReceived:U.bytesReceived,bytesSent:U.bytesSent,availableOutgoingBitrate:U.availableOutgoingBitrate,availableIncomingBitrate:U.availableIncomingBitrate,lastPacketReceivedTimestamp:U.lastPacketReceivedTimestamp,lastPacketSentTimestamp:U.lastPacketSentTimestamp,localCandidateId:U.localCandidateId,remoteCandidateId:U.remoteCandidateId,bytesDiscardedOnSend:U.bytesDiscardedOnSend,packetsSent:U.packetsSent,packetsReceived:U.packetsReceived,packetsDiscardedOnSend:U.packetsDiscardedOnSend};f.push(Ae),(A.nominated===!0||A.selected===!0)&&(d.candidatePair=Ae);break}case"transport":{const E=A;a&&(a.producing&&(this.overallProducingTransportsStatsMap[a.id]||(this.overallProducingTransportsStatsMap[a.id]={totalPacketsSent:0})),a.consuming&&(this.overallConsumingTransportsStatsMap[a.id]||(this.overallConsumingTransportsStatsMap[a.id]={totalPacketsReceived:0})));const w={bytesReceived:E.bytesReceived,bytesSent:E.bytesSent,packetsSent:E.packetsSent,packetsReceived:E.packetsReceived,dtlsCipher:E.dtlsCipher,dtlsState:E.dtlsState,iceRole:E.iceRole};if(d.transport=w,a){if(a.producing){const U=this.overallProducingTransportsStatsMap[a.id];this.processProducingTransportStats(a.id,U,w)}if(a.consuming){const U=this.overallConsumingTransportsStatsMap[a.id];this.processConsumingTransportStats(a.id,U,w)}}break}case"remote-inbound-rtp":{const E=A,w={jitter:E.jitter,fractionLost:E.fractionLost,roundTripTime:E.roundTripTime,roundTripTimeMeasurements:E.roundTripTimeMeasurements,totalRoundTripTime:E.totalRoundTripTime,packetsLost:E.packetsLost};d.remoteInboundRtp.set(E.localId,w);break}case"outbound-rtp":{const E=A,w=i||this.outboundProducerMap.get(A.id),U=this.pausedProducerMap.get(w);if(U){if(U.lastReportCalculated===!0)break;this.pausedProducerMap.set(w,{lastReportCalculated:!0})}this.overallProducersStatsMap[w]||(this.overallProducersStatsMap[w]={totalVideoPacketsSent:0,totalAudioPacketsSent:0});const Ae=this.overallProducersStatsMap[w];if(["video","audio"].includes(E.mediaType)||["video","audio"].includes(E.kind)){if(!this.outboundProducerMap.has(A.id)){d.staleProducerStreamMap=!0;break}const je=this.callStatsInstance.producers.get(w);if(((b=je==null?void 0:je.track)==null?void 0:b.readyState)==="ended")break;d.producerStreamMap.has(w)||d.producerStreamMap.set(w,{outboundVideoRtpId:[],outboundAudioRtpId:[]});const x={bytesSent:E.bytesSent,packetsSent:E.packetsSent,nackCount:E.nackCount,ssrc:E.ssrc,mid:E.mid,active:E.active,codecId:E.codecId,headerBytesSent:E.headerBytesSent||0,totalPacketSendDelay:E.totalPacketSendDelay||0};if(E.mediaType==="video"||E.kind==="video"){const C=E,Ke={frameHeight:C.frameHeight,frameWidth:C.frameWidth,framesEncoded:C.framesEncoded,framesDropped:C.framesDropped,framesPerSecond:C.framesPerSecond,framesSent:C.framesSent,keyFramesEncoded:C.keyFramesEncoded,firCount:C.firCount,encoderImplementation:C.encoderImplementation,hugeFramesSent:C.hugeFramesSent,pliCount:C.pliCount,qpSum:C.qpSum,qualityLimitationDurations:C.qualityLimitationDurations,qualityLimitationReason:C.qualityLimitationReason,qualityLimitationResolutionChanges:C.qualityLimitationResolutionChanges,totalEncodeTime:C.targetBitrate,totalPacketSendDelay:C.totalPacketSendDelay,retransmittedBytesSent:C.retransmittedBytesSent,retransmittedPacketsSent:C.retransmittedPacketsSent,scalabilityMode:C.scalabilityMode,powerEfficientEncoder:C.powerEfficientEncoder,...x};d.outboundVideoRtp.set(A.id,Ke),d.producerStreamMap.get(w).outboundVideoRtpId.push(A.id),this.processOutboundProducerVideoStats(w,Ae,Ke)}else if(E.mediaType==="audio"||E.kind==="audio"){const C=E,Ke={retransmittedBytesSent:C.retransmittedBytesSent,retransmittedPacketsSent:C.retransmittedPacketsSent,...x};d.outboundAudioRtp.set(A.id,Ke),d.producerStreamMap.get(w).outboundAudioRtpId.push(A.id),this.processOutboundProducerAudioStats(w,Ae,Ke)}}else this.callStatsInstance.logger.error(`Callstats: Unknown Outbound-rtp. mediatype: ${E.mediaType} kind: ${E.kind}`);break}case"inbound-rtp":{const E=A,w=i||this.inboundConsumerMap.get(A.id),U=this.pausedConsumerMap.get(w);if(U){if(U.lastReportCalculated===!0)break;this.pausedConsumerMap.set(w,{lastReportCalculated:!0})}if(E.ssrc===1234)break;this.overallConsumersStatsMap[w]||(this.overallConsumersStatsMap[w]={totalVideoPacketsReceived:0,totalAudioPacketsReceived:0});const Ae=this.overallConsumersStatsMap[w];if(["video","audio"].includes(E.mediaType)||["video","audio"].includes(E.kind)){if(!this.inboundConsumerMap.has(A.id)){d.staleConsumerStreamMap=!0;break}d.consumerStreamMap.has(w)||d.consumerStreamMap.set(w,{inboundVideoRtpId:[],inboundAudioRtpId:[]});const je={bytesReceived:E.bytesReceived,packetsReceived:E.packetsReceived,packetsLost:E.packetsLost>=0?E.packetsLost:0,jitter:E.jitter,nackCount:E.nackCount,jitterBufferDelay:E.jitterBufferDelay,jitterBufferEmittedCount:E.jitterBufferEmittedCount,lastPacketReceivedTimestamp:E.lastPacketReceivedTimestamp,ssrc:E.ssrc,mid:E.mid,codecId:E.codecId,headerBytesReceived:E.headerBytesReceived||0,packetsDiscarded:E.packetsDiscarded||0,jitterBufferMinimumDelay:E.jitterBufferMinimumDelay||0,jitterBufferTargetDelay:E.jitterBufferTargetDelay||0};if(E.mediaType==="video"||E.kind==="video"){const x=E,C={frameHeight:x.frameHeight,frameWidth:x.frameWidth,framesDecoded:x.framesDecoded,framesDropped:x.framesDropped,framesPerSecond:x.framesPerSecond,framesReceived:x.framesReceived,keyFramesDecoded:x.keyFramesDecoded,firCount:x.firCount,decoderImplementation:x.decoderImplementation,pliCount:x.pliCount,totalProcessingDelay:x.totalProcessingDelay,qpSum:x.qpSum||0,totalAssemblyTime:x.totalAssemblyTime||0,totalDecodeTime:x.totalDecodeTime||0,totalFreezesDuration:x.totalFreezesDuration||0,totalInterFrameDelay:x.totalInterFrameDelay||0,totalPausesDuration:x.totalPausesDuration||0,totalSquaredInterFrameDelay:x.totalSquaredInterFrameDelay||0,freezeCount:x.freezeCount||0,pauseCount:x.pauseCount||0,powerEfficientDecoder:x.powerEfficientDecoder,...je};C.score=uh({frameWidth:C.frameWidth||0,framesDecoded:(C.framesDecoded||0)-(((I=this.videoConsumerToStatsMap.get(w))==null?void 0:I.framesDecoded)||0),framesPerSecond:C.framesPerSecond||0,packetsLost:(C.packetsLost||0)-(((L=this.videoConsumerToStatsMap.get(w))==null?void 0:L.packetsLost)||0),packetsReceived:(C.packetsReceived||0)-(((B=this.videoConsumerToStatsMap.get(w))==null?void 0:B.packetsReceived)||0),jitter:C.jitter||0,isScreenShare:this.screenShareConsumers.has(w)}),_.set(w,{score:+(C.score*10).toFixed(),frameWidth:C.frameWidth||0,frameHeight:C.frameHeight||0,framesPerSecond:C.framesPerSecond||0,packetsLostPercentage:Qo({packetsLost:(C.packetsLost||0)-(((q=this.videoConsumerToStatsMap.get(w))==null?void 0:q.packetsLost)||0),packetsReceived:(C.packetsReceived||0)-(((F=this.videoConsumerToStatsMap.get(w))==null?void 0:F.packetsReceived)||0)}),jitter:C.jitter||0,isScreenShare:this.screenShareConsumers.has(w),bitrate:((C.bytesReceived||0)-(((X=this.videoConsumerToStatsMap.get(w))==null?void 0:X.bytesReceived)||0))*8/7}),this.videoConsumerToStatsMap.set(w,C),d.inboundVideoRtp.set(A.id,C),d.consumerStreamMap.get(w).inboundVideoRtpId.push(A.id),this.processInboundConsumerVideoStats(w,Ae,C)}else if(E.mediaType==="audio"||E.kind==="audio"){const x=E,C={audioLevel:x.audioLevel,concealedSamples:x.concealedSamples,concealmentEvents:x.concealmentEvents,totalAudioEnergy:x.totalAudioEnergy,totalSamplesDuration:x.totalSamplesDuration,totalSamplesReceived:x.totalSamplesReceived,fecPacketsDiscarded:x.fecPacketsDiscarded||0,fecPacketsReceived:x.fecPacketsReceived||0,insertedSamplesForDeceleration:x.insertedSamplesForDeceleration||0,removedSamplesForAcceleration:x.removedSamplesForAcceleration||0,silentConcealedSamples:x.silentConcealedSamples||0,playoutId:x.playoutId,...je};C.score=lh({concealmentEvents:(C.concealmentEvents||0)-(((ne=this.audioConsumerToStatsMap.get(w))==null?void 0:ne.concealmentEvents)||0),packetsLost:(C.packetsLost||0)-(((ve=this.audioConsumerToStatsMap.get(w))==null?void 0:ve.packetsLost)||0),packetsReceived:(C.packetsReceived||0)-(((ct=this.audioConsumerToStatsMap.get(w))==null?void 0:ct.packetsReceived)||0),jitter:C.jitter||0}),_.set(w,{score:+(C.score*10).toFixed(),packetsLostPercentage:Qo({packetsLost:(C.packetsLost||0)-(((Ls=this.audioConsumerToStatsMap.get(w))==null?void 0:Ls.packetsLost)||0),packetsReceived:(C.packetsReceived||0)-(((Es=this.audioConsumerToStatsMap.get(w))==null?void 0:Es.packetsReceived)||0)}),jitter:C.jitter||0,isScreenShare:this.screenShareConsumers.has(w),bitrate:((C.bytesReceived||0)-(((Jr=this.audioConsumerToStatsMap.get(w))==null?void 0:Jr.bytesReceived)||0))*8/7}),this.audioConsumerToStatsMap.set(w,C),d.inboundAudioRtp.set(A.id,C),d.consumerStreamMap.get(w).inboundAudioRtpId.push(A.id),this.processInboundConsumerAudioStats(w,Ae,C)}}else this.callStatsInstance.logger.error(`Callstats: Unknown Inbound-rtp. mediatype: ${E.mediaType} kind: ${E.kind}`);break}}}if(d.producerStreamMap.forEach((A,E)=>{var w,U,Ae,je,x,C,Ke,or,Mo,Do,Oo,No,Lo,xo,Vo,Uo,Fo,Bo,$o,Ho,qo,jo,Go;if(A.outboundVideoRtpId.length>0){const Te=[];A.outboundVideoRtpId.forEach(Ru=>{Te.push(d.outboundVideoRtp.get(Ru))});const ie=this.getWorkingSimulcastVideoStats(Te);ie.score=ch({frameWidth:ie.frameWidth||0,framesPerSecond:ie.framesPerSecond||0,jitter:((w=ie.remoteData)==null?void 0:w.jitter)||0,isScreenShare:this.screenShareProducers.has(E),packetsSent:(ie.packetsSent||0)-(((U=this.videoProducerToStatsMap.get(E))==null?void 0:U.packetsSent)||0),packetsLost:(((Ae=ie.remoteData)==null?void 0:Ae.packetsLost)||0)-(((x=(je=this.videoProducerToStatsMap.get(E))==null?void 0:je.remoteData)==null?void 0:x.packetsLost)||0),framesEncoded:(ie.framesEncoded||0)-(((C=this.videoProducerToStatsMap.get(E))==null?void 0:C.framesEncoded)||0)}),y.set(E,{score:+(ie.score*10).toFixed(),frameWidth:ie.frameWidth||0,frameHeight:ie.frameHeight||0,framesPerSecond:ie.framesPerSecond||0,jitter:((Ke=ie.remoteData)==null?void 0:Ke.jitter)||0,isScreenShare:this.screenShareProducers.has(E),packetsLostPercentage:Yo({packetsSent:(ie.packetsSent||0)-(((or=this.videoProducerToStatsMap.get(E))==null?void 0:or.packetsSent)||0),packetsLost:(((Mo=ie.remoteData)==null?void 0:Mo.packetsLost)||0)-(((Oo=(Do=this.videoProducerToStatsMap.get(E))==null?void 0:Do.remoteData)==null?void 0:Oo.packetsLost)||0)}),bitrate:((ie.bytesSent||0)-(((No=this.videoProducerToStatsMap.get(E))==null?void 0:No.bytesSent)||0))*8/7,cpuLimitations:ie.qualityLimitationReason==="cpu",bandwidthLimitations:ie.qualityLimitationReason==="bandwidth"}),this.videoProducerToStatsMap.set(E,ie)}else if(A.outboundAudioRtpId.length>0){const Te=d.outboundAudioRtp.get(A.outboundAudioRtpId[0]);Te.score=oh({packetsSent:(Te.packetsSent||0)-(((Lo=this.audioProducerToStatsMap.get(E))==null?void 0:Lo.packetsSent)||0),packetsLost:(((xo=Te.remoteData)==null?void 0:xo.packetsLost)||0)-(((Uo=(Vo=this.audioProducerToStatsMap.get(E))==null?void 0:Vo.remoteData)==null?void 0:Uo.packetsLost)||0),jitter:((Fo=Te.remoteData)==null?void 0:Fo.jitter)||0}),y.set(E,{score:+(Te.score*10).toFixed(),bitrate:((Te.bytesSent||0)-(((Bo=this.audioProducerToStatsMap.get(E))==null?void 0:Bo.bytesSent)||0))*8/7,packetsLostPercentage:Yo({packetsSent:(Te.packetsSent||0)-((($o=this.audioProducerToStatsMap.get(E))==null?void 0:$o.packetsSent)||0),packetsLost:(((Ho=Te.remoteData)==null?void 0:Ho.packetsLost)||0)-(((jo=(qo=this.audioProducerToStatsMap.get(E))==null?void 0:qo.remoteData)==null?void 0:jo.packetsLost)||0)}),jitter:((Go=Te.remoteData)==null?void 0:Go.jitter)||0,isScreenShare:this.screenShareProducers.has(E)}),this.audioProducerToStatsMap.set(E,Te)}}),f.forEach(A=>{const E=h.find(U=>U.id===A.localCandidateId?(A.localCandidateId=U.id,U):null),w=m.find(U=>U.id===A.remoteCandidateId?(A.remoteCandidateId=U.id,U):null);E&&(A.localCandidateType=E.type,A.localCandidateAddress=cr(E.address),A.localCandidatePort=E.port,A.localCandidateProtocol=E.protocol,A.localCandidateUrl=E.url,A.localCandidateNetworkType=E.networkType,A.localCandidateRelatedAddress=cr(E.relatedAddress),A.localCandidateRelatedPort=E.relatedPort),w&&(A.remoteCandidateType=w.type,A.remoteCandidateAddress=cr(w.address),A.remoteCandidatePort=w.port,A.remoteCandidateProtocol=w.protocol,A.remoteCandidateUrl=w.url)}),d.candidatePair&&(d.transport?(d.transport.totalRoundTripTime=d.candidatePair.totalRoundTripTime,d.transport.availableOutgoingBitrate=d.candidatePair.availableOutgoingBitrate,d.transport.availableIncomingBitrate=d.candidatePair.availableIncomingBitrate,d.transport.roundTripTime=d.candidatePair.currentRoundTripTime):d.transport={bytesReceived:d.candidatePair.bytesReceived,bytesSent:d.candidatePair.bytesSent,totalRoundTripTime:d.candidatePair.totalRoundTripTime,availableOutgoingBitrate:d.candidatePair.availableOutgoingBitrate,availableIncomingBitrate:d.candidatePair.availableIncomingBitrate,roundTripTime:d.candidatePair.currentRoundTripTime}),d.transport&&(d.transport.candidatePairs=f),d.transport&&!d.transport.roundTripTime){let A=0,E=0;d.remoteInboundRtp.forEach((w,U)=>{w.roundTripTime&&w.roundTripTime>A&&(A=w.roundTripTime,E=w.totalRoundTripTime)}),d.transport.roundTripTime=A,d.transport.totalRoundTripTime=E}if(_.size>0)try{this.observer.emit("consumer_score",_)}catch(A){}if(y.size>0)try{this.observer.emit("producer_score",y)}catch(A){}return d}async getProducersReport(e){const r=e.map(n=>this.generateProducerStreamMap(n,!0));return r.length>0?Promise.all(r):void 0}async getConsumersReport(e){const r=e.map(n=>this.generateConsumerStreamMap(n,!0));return r.length>0?Promise.all(r):void 0}async getTransportReport(e){return e.getStats()}async getProcessedStats(e,r,n){const i=await this.getTransportReport(e),a={producing:n,consuming:r,id:e.id},c=i,d=this.parseRTCReport(c,["transport","candidate-pair","inbound-rtp","outbound-rtp","remote-inbound-rtp","local-candidate","remote-candidate"],!1,void 0,a);if(!d)return;const l={stats:d.transport,transportId:e.id,consuming:r,producing:n},h=d.staleProducerStreamMap?void 0:this.getProducerStatsFromReport(d),m=d.staleConsumerStreamMap?void 0:this.getConsumerStatsFromReport(d);return{transportReport:l,producerReport:h,consumerReport:m}}getProducerStatsFromReport(e){const r=[];try{e.producerStreamMap.forEach((n,i)=>{var a,c;r.push({producerId:i,videoStats:n.outboundVideoRtpId.map(d=>e.outboundVideoRtp.get(d)),audioStats:n.outboundAudioRtpId.map(d=>e.outboundAudioRtp.get(d)),appData:((c=(a=this.callStatsInstance.producers)==null?void 0:a.get(i))==null?void 0:c.appData)||null})})}catch(n){this.callStatsInstance.logger.error("callStats::measurements::getProducerStatsFromReport",{error:{reason:n.reason,message:n.message}})}return r}getConsumerStatsFromReport(e){const r=[];try{e.consumerStreamMap.forEach((n,i)=>{const{peerId:a,producerId:c,appData:d}=this.consumerPeerIdMap.get(i);r.push({consumerId:i,peerId:a,producerId:c,appData:d,videoStats:n.inboundVideoRtpId.map(l=>e.inboundVideoRtp.get(l)),audioStats:n.inboundAudioRtpId.map(l=>e.inboundAudioRtp.get(l))})})}catch(n){console.error("getConsumersReport: ",n,e)}return r}async getUserLocation(){return new Promise((e,r)=>{try{navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>{e(n)}):r()}catch(n){r(n)}})}async getConnectivity(e){try{const r={iceServers:e||ph},n=new Promise((h,m)=>{try{const f=new zg(r);f.addListener("done",h),f.addListener("failed",()=>{h({connectivity:!1})}),f.start(2e3)}catch(f){m(f)}}),i=new Promise((h,m)=>{try{const f=new Yg(r);f.addListener("done",h),f.addListener("failed",()=>{h({connectivity:!1})}),f.start(2e3)}catch(f){m(f)}}),a=new Promise((h,m)=>{try{const f=new Qg(r);f.addListener("done",h),f.addListener("failed",()=>{h({connectivity:!1})}),f.start(2e3)}catch(f){m(f)}}),[c,d,l]=await Promise.all([n,i,a]);return{host:c==null?void 0:c.connectivity,relay:d==null?void 0:d.connectivity,reflexive:l==null?void 0:l.connectivity}}catch(r){return{host:!1,relay:!1,reflexive:!1}}}async getThroughput(e){try{const n=await new Promise((i,a)=>{try{const c={iceServers:e||ph},d=new Kg(c);d.addListener("done",i),d.addListener("failed",a),d.start(1e4)}catch(c){a(c)}});return{throughput:n.throughput,fractionalLoss:0,RTT:n.RTT,jitter:0,backendRTT:n.backendRTT}}catch(r){return}}async getIPDetails(){var e,r;try{return this.ipDetails||(this.ipDetails=await Wd.getIPDetails({peerId:(e=this.callStatsInstance)==null?void 0:e.peerId,apiHostnames:(r=this.callStatsInstance)==null?void 0:r.apiHostnames,logger:this.callStatsInstance.logger})),this.ipDetails}catch(n){return}}async getNetworkQuality(e){const[r,n]=await Promise.all([this.getConnectivity(e),this.getThroughput(e)]);return{connectivity:r,throughput:n==null?void 0:n.throughput,fractionalLoss:n==null?void 0:n.fractionalLoss,RTT:n==null?void 0:n.RTT,jitter:n==null?void 0:n.jitter,backendRTT:n==null?void 0:n.backendRTT}}async getNetworkInfo(e,r=!1){var c,d;if(r){const l=await this.getIPDetails();return{ipDetails:l,effectiveNetworkType:(c=navigator.connection)==null?void 0:c.effectiveType,location:l!=null&&l.loc?mh(l==null?void 0:l.loc):void 0}}const[n,i,a]=await Promise.all([this.getConnectivity(e),this.getThroughput(e),this.getIPDetails()]);return{ipDetails:a,effectiveNetworkType:(d=navigator.connection)==null?void 0:d.effectiveType,location:a!=null&&a.loc?mh(a==null?void 0:a.loc):void 0,turnConnectivity:n?n.host||n.relay||n.reflexive:!1,connectivity:n,throughput:i==null?void 0:i.throughput,fractionalLoss:i==null?void 0:i.fractionalLoss,RTT:i==null?void 0:i.RTT,jitter:i==null?void 0:i.jitter,backendRTT:i==null?void 0:i.backendRTT}}}class Zg extends gh{}class vh extends gh{constructor(){super(...arguments);p(this,"producerMap",new Map);p(this,"consumerMap",new Map)}async registerProducer(e){this.producerMap.set(e.id,e),await this.generateProducerStreamMap(e),e.on("close",this.deregisterProducer.bind(this,e)),e.on("pause",this.pauseProducer.bind(this,e.id)),e.on("resume",this.resumeProducer.bind(this,e.id)),e.appData.screenShare===!0&&this.screenShareProducers.add(e.id)}async registerConsumer(e){this.consumerMap.set(e.id,e),await this.generateConsumerStreamMap(e),this.consumerPeerIdMap.set(e.id,{producerId:e.producerId,peerId:e.appData.peerId,appData:e.appData}),e.on("close",this.deregisterConsumer.bind(this,e)),e.on("pause",this.pauseConsumer.bind(this,e.id)),e.on("resume",this.resumeConsumer.bind(this,e.id)),e.appData.screenShare===!0&&this.screenShareConsumers.add(e.id)}async generateConsumerStreamMap(e,r=!1){const n=await e.getStats(),i=this.parseRTCReport(n,["inbound-rtp"],!1,e.id),a=[...i.consumerStreamMap.values()][0],c=r?this.getConsumerStatsFromParsedConsumerStats(i,a,e.id):void 0;for(const d of n.values())switch(d.type){case"inbound-rtp":{this.inboundConsumerMap.set(d.id,e.id);break}}return c}deregisterProducer(e){this.producerMap.delete(e.id),this.outboundProducerMap.forEach((r,n)=>{r===e.id&&this.outboundProducerMap.delete(n)}),this.pausedProducerMap.delete(e.id),this.screenShareProducers.delete(e.id)}deregisterConsumer(e){this.consumerMap.delete(e.id),this.inboundConsumerMap.forEach((r,n)=>{r===e.id&&this.inboundConsumerMap.delete(n)}),this.consumerPeerIdMap.delete(e.id),this.pausedConsumerMap.delete(e.id),this.screenShareConsumers.delete(e.id)}getIceCandidateStats(e){var r;return{id:e.id,type:e.candidateType||e.type,address:e.address,port:e.port,url:e.url,protocol:(r=e.relayProtocol)!=null?r:e.protocol,networkType:e.networkType,relatedAddress:e.relatedAddress,relatedPort:e.relatedPort}}parseRTCReport(e,r=[],n=!1,i=void 0,a=void 0){var b,I,L,B,q,F,X,ne,ve,ct,Ls,Es,Jr;const c=e,d=new fh,l=r.length?new Set(r):void 0,h=[],m=[],f=[],y=new Map,_=new Map;for(const A of c.values()){if(l){if(l.size===0)break;if(l.has(A.type))n&&l.delete(A.type);else continue}switch(A.type){case"local-candidate":{h.push(this.getIceCandidateStats(A));break}case"remote-candidate":{m.push(this.getIceCandidateStats(A));break}case"candidate-pair":{const{nominated:E}=A,{selected:w}=A,U=A,Ae={nominated:E!=null?E:w,currentRoundTripTime:U.currentRoundTripTime,totalRoundTripTime:U.totalRoundTripTime,bytesReceived:U.bytesReceived,bytesSent:U.bytesSent,availableOutgoingBitrate:U.availableOutgoingBitrate,availableIncomingBitrate:U.availableIncomingBitrate,lastPacketReceivedTimestamp:U.lastPacketReceivedTimestamp,lastPacketSentTimestamp:U.lastPacketSentTimestamp,localCandidateId:U.localCandidateId,remoteCandidateId:U.remoteCandidateId,bytesDiscardedOnSend:U.bytesDiscardedOnSend,packetsSent:U.packetsSent,packetsReceived:U.packetsReceived,packetsDiscardedOnSend:U.packetsDiscardedOnSend};f.push(Ae),(A.nominated===!0||A.selected===!0)&&(d.candidatePair=Ae);break}case"transport":{const E=A;a&&(a.producing&&(this.overallProducingTransportsStatsMap[a.id]||(this.overallProducingTransportsStatsMap[a.id]={totalPacketsSent:0})),a.consuming&&(this.overallConsumingTransportsStatsMap[a.id]||(this.overallConsumingTransportsStatsMap[a.id]={totalPacketsReceived:0})));const w={bytesReceived:E.bytesReceived,bytesSent:E.bytesSent,packetsSent:E.packetsSent,packetsReceived:E.packetsReceived,dtlsCipher:E.dtlsCipher,dtlsState:E.dtlsState,iceRole:E.iceRole};if(d.transport=w,a){if(a.producing){const U=this.overallProducingTransportsStatsMap[a.id];this.processProducingTransportStats(a.id,U,w)}if(a.consuming){const U=this.overallConsumingTransportsStatsMap[a.id];this.processConsumingTransportStats(a.id,U,w)}}break}case"remote-inbound-rtp":{const E=A,w={jitter:E.jitter,fractionLost:E.fractionLost,roundTripTime:E.roundTripTime,roundTripTimeMeasurements:E.roundTripTimeMeasurements,totalRoundTripTime:E.totalRoundTripTime,packetsLost:E.packetsLost};d.remoteInboundRtp.set(E.localId,w);break}case"outbound-rtp":{const E=A,w=i||this.outboundProducerMap.get(A.id),U=this.pausedProducerMap.get(w);if(U){if(U.lastReportCalculated===!0)break;this.pausedProducerMap.set(w,{lastReportCalculated:!0})}this.overallProducersStatsMap[w]||(this.overallProducersStatsMap[w]={totalVideoPacketsSent:0,totalAudioPacketsSent:0});const Ae=this.overallProducersStatsMap[w];if(["video","audio"].includes(E.mediaType)||["video","audio"].includes(E.kind)){if(!this.outboundProducerMap.has(A.id)){d.staleProducerStreamMap=!0;break}const je=this.callStatsInstance.producers.get(w);if(((b=je==null?void 0:je.track)==null?void 0:b.readyState)==="ended")break;d.producerStreamMap.has(w)||d.producerStreamMap.set(w,{outboundVideoRtpId:[],outboundAudioRtpId:[]});const x={bytesSent:E.bytesSent,packetsSent:E.packetsSent,nackCount:E.nackCount,ssrc:E.ssrc,mid:E.mid,active:E.active,codecId:E.codecId,headerBytesSent:E.headerBytesSent||0,totalPacketSendDelay:E.totalPacketSendDelay||0};if(E.mediaType==="video"||E.kind==="video"){const C=E,Ke={frameHeight:C.frameHeight,frameWidth:C.frameWidth,framesEncoded:C.framesEncoded,framesDropped:C.framesDropped?C.framesDropped:C.droppedFrames,framesPerSecond:C.framesPerSecond?C.framesPerSecond:C.framerateMean,framesSent:C.framesSent,keyFramesEncoded:C.keyFramesEncoded,firCount:C.firCount,encoderImplementation:C.encoderImplementation,hugeFramesSent:C.hugeFramesSent,pliCount:C.pliCount,qpSum:C.qpSum,qualityLimitationReason:C.qualityLimitationReason,qualityLimitationDurations:C.qualityLimitationDurations,qualityLimitationResolutionChanges:C.qualityLimitationResolutionChanges,totalEncodeTime:C.totalEncodeTime,totalPacketSendDelay:C.totalEncodeTime,retransmittedBytesSent:C.retransmittedBytesSent,retransmittedPacketsSent:C.retransmittedPacketsSent,scalabilityMode:C.scalabilityMode,powerEfficientEncoder:C.powerEfficientEncoder,...x};d.outboundVideoRtp.set(A.id,Ke),d.producerStreamMap.get(w).outboundVideoRtpId.push(A.id),this.processOutboundProducerVideoStats(w,Ae,Ke)}else if(E.mediaType==="audio"||E.kind==="audio"){const C=E,Ke={retransmittedBytesSent:C.retransmittedBytesSent,retransmittedPacketsSent:C.retransmittedPacketsSent,...x};d.outboundAudioRtp.set(A.id,Ke),d.producerStreamMap.get(w).outboundAudioRtpId.push(A.id),this.processOutboundProducerAudioStats(w,Ae,Ke)}}else this.callStatsInstance.logger.error(`Callstats: Unknown Outbound-rtp. mediatype: ${E.mediaType} kind: ${E.kind}`);break}case"inbound-rtp":{const E=A,w=i||this.inboundConsumerMap.get(A.id),U=this.pausedConsumerMap.get(w);if(U){if(U.lastReportCalculated===!0)break;this.pausedConsumerMap.set(w,{lastReportCalculated:!0})}if(E.ssrc===1234)break;this.overallConsumersStatsMap[w]||(this.overallConsumersStatsMap[w]={totalVideoPacketsReceived:0,totalAudioPacketsReceived:0});const Ae=this.overallConsumersStatsMap[w];if(["video","audio"].includes(E.mediaType)||["video","audio"].includes(E.kind)){if(!this.inboundConsumerMap.has(A.id)){d.staleConsumerStreamMap=!0;break}d.consumerStreamMap.has(w)||d.consumerStreamMap.set(w,{inboundVideoRtpId:[],inboundAudioRtpId:[]});const je={bytesReceived:E.bytesReceived,packetsReceived:E.packetsReceived,packetsLost:E.packetsLost>=0?E.packetsLost:0,jitter:E.jitter,nackCount:E.nackCount,jitterBufferDelay:E.jitterBufferDelay,jitterBufferEmittedCount:E.jitterBufferEmittedCount,lastPacketReceivedTimestamp:E.lastPacketReceivedTimestamp,ssrc:E.ssrc,mid:E.mid,codecId:E.codecId,headerBytesReceived:E.headerBytesReceived||0,packetsDiscarded:E.packetsDiscarded||0,jitterBufferMinimumDelay:E.jitterBufferMinimumDelay||0,jitterBufferTargetDelay:E.jitterBufferTargetDelay||0};if(E.mediaType==="video"||E.kind==="video"){const x=E,C={frameHeight:x.frameHeight,frameWidth:x.frameWidth,framesDecoded:x.framesDecoded,framesDropped:x.framesDropped?x.framesDropped:x.droppedFrames,framesPerSecond:x.framesPerSecond?x.framesPerSecond:x.framerateMean,framesReceived:x.framesReceived,keyFramesDecoded:x.keyFramesDecoded,firCount:x.firCount,decoderImplementation:x.decoderImplementation,pliCount:x.pliCount,totalProcessingDelay:x.totalProcessingDelay,qpSum:x.qpSum||0,totalAssemblyTime:x.totalAssemblyTime||0,totalDecodeTime:x.totalDecodeTime||0,totalFreezesDuration:x.totalFreezesDuration||0,totalInterFrameDelay:x.totalInterFrameDelay||0,totalPausesDuration:x.totalPausesDuration||0,totalSquaredInterFrameDelay:x.totalSquaredInterFrameDelay||0,freezeCount:x.freezeCount||0,pauseCount:x.pauseCount||0,powerEfficientDecoder:x.powerEfficientDecoder,...je};C.score=uh({frameWidth:C.frameWidth||0,framesDecoded:(C.framesDecoded||0)-(((I=this.videoConsumerToStatsMap.get(w))==null?void 0:I.framesDecoded)||0),framesPerSecond:C.framesPerSecond||0,packetsLost:(C.packetsLost||0)-(((L=this.videoConsumerToStatsMap.get(w))==null?void 0:L.packetsLost)||0),packetsReceived:(C.packetsReceived||0)-(((B=this.videoConsumerToStatsMap.get(w))==null?void 0:B.packetsReceived)||0),jitter:C.jitter||0,isScreenShare:this.screenShareConsumers.has(w)}),_.set(w,{score:+(C.score*10).toFixed(),frameWidth:C.frameWidth||0,frameHeight:C.frameHeight||0,framesPerSecond:C.framesPerSecond||0,packetsLostPercentage:Qo({packetsLost:(C.packetsLost||0)-(((q=this.videoConsumerToStatsMap.get(w))==null?void 0:q.packetsLost)||0),packetsReceived:(C.packetsReceived||0)-(((F=this.videoConsumerToStatsMap.get(w))==null?void 0:F.packetsReceived)||0)}),jitter:C.jitter||0,isScreenShare:this.screenShareConsumers.has(w),bitrate:((C.bytesReceived||0)-(((X=this.videoConsumerToStatsMap.get(w))==null?void 0:X.bytesReceived)||0))*8/7}),this.videoConsumerToStatsMap.set(w,C),d.inboundVideoRtp.set(A.id,C),d.consumerStreamMap.get(w).inboundVideoRtpId.push(A.id),this.processInboundConsumerVideoStats(w,Ae,C)}else if(E.mediaType==="audio"||E.kind==="audio"){const x=E,C={audioLevel:x.audioLevel,concealedSamples:x.concealedSamples,concealmentEvents:x.concealmentEvents,totalAudioEnergy:x.totalAudioEnergy,totalSamplesDuration:x.totalSamplesDuration,totalSamplesReceived:x.totalSamplesReceived,fecPacketsDiscarded:x.fecPacketsDiscarded||0,fecPacketsReceived:x.fecPacketsReceived||0,insertedSamplesForDeceleration:x.insertedSamplesForDeceleration||0,removedSamplesForAcceleration:x.removedSamplesForAcceleration||0,silentConcealedSamples:x.silentConcealedSamples||0,playoutId:x.playoutId,...je};C.score=lh({concealmentEvents:(C.concealmentEvents||0)-(((ne=this.audioConsumerToStatsMap.get(w))==null?void 0:ne.concealmentEvents)||0),packetsLost:(C.packetsLost||0)-(((ve=this.audioConsumerToStatsMap.get(w))==null?void 0:ve.packetsLost)||0),packetsReceived:(C.packetsReceived||0)-(((ct=this.audioConsumerToStatsMap.get(w))==null?void 0:ct.packetsReceived)||0),jitter:C.jitter||0}),_.set(w,{score:+(C.score*10).toFixed(),packetsLostPercentage:Qo({packetsLost:(C.packetsLost||0)-(((Ls=this.audioConsumerToStatsMap.get(w))==null?void 0:Ls.packetsLost)||0),packetsReceived:(C.packetsReceived||0)-(((Es=this.audioConsumerToStatsMap.get(w))==null?void 0:Es.packetsReceived)||0)}),jitter:C.jitter||0,isScreenShare:this.screenShareConsumers.has(w),bitrate:((C.bytesReceived||0)-(((Jr=this.audioConsumerToStatsMap.get(w))==null?void 0:Jr.bytesReceived)||0))*8/7}),this.audioConsumerToStatsMap.set(w,C),d.inboundAudioRtp.set(A.id,C),d.consumerStreamMap.get(w).inboundAudioRtpId.push(A.id),this.processInboundConsumerAudioStats(w,Ae,C)}}else this.callStatsInstance.logger.error(`Callstats: Unknown Inbound-rtp. mediatype: ${E.mediaType} kind: ${E.kind}`);break}}}if(d.producerStreamMap.forEach((A,E)=>{var w,U,Ae,je,x,C,Ke,or,Mo,Do,Oo,No,Lo,xo,Vo,Uo,Fo,Bo,$o,Ho,qo,jo,Go;if(A.outboundVideoRtpId.length>0){const Te=[];A.outboundVideoRtpId.forEach(Ru=>{Te.push(d.outboundVideoRtp.get(Ru))});const ie=this.getWorkingSimulcastVideoStats(Te);ie.score=ch({frameWidth:ie.frameWidth||0,framesPerSecond:ie.framesPerSecond||0,jitter:((w=ie.remoteData)==null?void 0:w.jitter)||0,isScreenShare:this.screenShareProducers.has(E),packetsSent:(ie.packetsSent||0)-(((U=this.videoProducerToStatsMap.get(E))==null?void 0:U.packetsSent)||0),packetsLost:(((Ae=ie.remoteData)==null?void 0:Ae.packetsLost)||0)-(((x=(je=this.videoProducerToStatsMap.get(E))==null?void 0:je.remoteData)==null?void 0:x.packetsLost)||0),framesEncoded:(ie.framesEncoded||0)-(((C=this.videoProducerToStatsMap.get(E))==null?void 0:C.framesEncoded)||0)}),y.set(E,{score:+(ie.score*10).toFixed(),frameWidth:ie.frameWidth||0,frameHeight:ie.frameHeight||0,framesPerSecond:ie.framesPerSecond||0,jitter:((Ke=ie.remoteData)==null?void 0:Ke.jitter)||0,isScreenShare:this.screenShareProducers.has(E),packetsLostPercentage:Yo({packetsSent:(ie.packetsSent||0)-(((or=this.videoProducerToStatsMap.get(E))==null?void 0:or.packetsSent)||0),packetsLost:(((Mo=ie.remoteData)==null?void 0:Mo.packetsLost)||0)-(((Oo=(Do=this.videoProducerToStatsMap.get(E))==null?void 0:Do.remoteData)==null?void 0:Oo.packetsLost)||0)}),bitrate:((ie.bytesSent||0)-(((No=this.videoProducerToStatsMap.get(E))==null?void 0:No.bytesSent)||0))*8/7,cpuLimitations:ie.qualityLimitationReason==="cpu",bandwidthLimitations:ie.qualityLimitationReason==="bandwidth"}),this.videoProducerToStatsMap.set(E,ie)}else if(A.outboundAudioRtpId.length>0){const Te=d.outboundAudioRtp.get(A.outboundAudioRtpId[0]);Te.score=oh({packetsSent:(Te.packetsSent||0)-(((Lo=this.audioProducerToStatsMap.get(E))==null?void 0:Lo.packetsSent)||0),packetsLost:(((xo=Te.remoteData)==null?void 0:xo.packetsLost)||0)-(((Uo=(Vo=this.audioProducerToStatsMap.get(E))==null?void 0:Vo.remoteData)==null?void 0:Uo.packetsLost)||0),jitter:((Fo=Te.remoteData)==null?void 0:Fo.jitter)||0}),y.set(E,{score:+(Te.score*10).toFixed(),bitrate:((Te.bytesSent||0)-(((Bo=this.audioProducerToStatsMap.get(E))==null?void 0:Bo.bytesSent)||0))*8/7,packetsLostPercentage:Yo({packetsSent:(Te.packetsSent||0)-((($o=this.audioProducerToStatsMap.get(E))==null?void 0:$o.packetsSent)||0),packetsLost:(((Ho=Te.remoteData)==null?void 0:Ho.packetsLost)||0)-(((jo=(qo=this.audioProducerToStatsMap.get(E))==null?void 0:qo.remoteData)==null?void 0:jo.packetsLost)||0)}),jitter:((Go=Te.remoteData)==null?void 0:Go.jitter)||0,isScreenShare:this.screenShareProducers.has(E)}),this.audioProducerToStatsMap.set(E,Te)}}),f.forEach(A=>{const E=h.find(U=>U.id===A.localCandidateId?(A.localCandidateId=U.id,U):null),w=m.find(U=>U.id===A.remoteCandidateId?(A.remoteCandidateId=U.id,U):null);E&&(A.localCandidateType=E.type,A.localCandidateAddress=cr(E.address),A.localCandidatePort=E.port,A.localCandidateProtocol=E.protocol,A.localCandidateUrl=E.url,A.localCandidateNetworkType=E.networkType,A.localCandidateRelatedAddress=cr(E.relatedAddress),A.localCandidateRelatedPort=E.relatedPort),w&&(A.remoteCandidateType=w.type,A.remoteCandidateAddress=cr(w.address),A.remoteCandidatePort=w.port,A.remoteCandidateProtocol=w.protocol,A.remoteCandidateUrl=w.url)}),d.candidatePair&&(d.transport?(d.transport.bytesReceived=d.candidatePair.bytesReceived,d.transport.bytesSent=d.candidatePair.bytesSent,d.transport.totalRoundTripTime=d.candidatePair.totalRoundTripTime,d.transport.availableOutgoingBitrate=d.candidatePair.availableOutgoingBitrate,d.transport.availableIncomingBitrate=d.candidatePair.availableIncomingBitrate,d.transport.roundTripTime=d.candidatePair.currentRoundTripTime):d.transport={bytesReceived:d.candidatePair.bytesReceived,bytesSent:d.candidatePair.bytesSent,totalRoundTripTime:d.candidatePair.totalRoundTripTime,availableOutgoingBitrate:d.candidatePair.availableOutgoingBitrate,availableIncomingBitrate:d.candidatePair.availableIncomingBitrate,roundTripTime:d.candidatePair.currentRoundTripTime}),d.transport&&(d.transport.candidatePairs=f),d.transport&&!d.transport.roundTripTime){let A=0,E=0;d.remoteInboundRtp.forEach((w,U)=>{w.roundTripTime&&w.roundTripTime>A&&(A=w.roundTripTime,E=w.totalRoundTripTime)}),d.transport.roundTripTime=A,d.transport.totalRoundTripTime=E}if(_.size>0)try{this.observer.emit("consumer_score",_)}catch(A){}if(y.size>0)try{this.observer.emit("producer_score",y)}catch(A){}return d}getProducerStatsFromReport(e){const r=[];try{e.producerStreamMap.forEach((n,i)=>{const a=this.producerMap.get(i),c=a.track.getSettings(),d=n.outboundVideoRtpId.map(h=>{const m=e.outboundVideoRtp.get(h);return m.frameHeight||(m.frameHeight=c.height,m.frameWidth=c.width,m.framesPerSecond=c.frameRate),m}),l={producerId:i,appData:a.appData,videoStats:d,audioStats:n.outboundAudioRtpId.map(h=>e.outboundAudioRtp.get(h))};r.push(l)})}catch(n){console.error("getProducersReport: ",n,e)}return r}getConsumerStatsFromParsedConsumerStats(e,r,n){let i;try{const{peerId:a,producerId:c,appData:d}=this.consumerPeerIdMap.get(n),l=r==null?void 0:r.inboundVideoRtpId.map(h=>{const f=this.consumerMap.get(n).track.getSettings(),y=e.inboundVideoRtp.get(h);return y.frameHeight||(y.frameHeight=f.height,y.frameWidth=f.width,y.framesPerSecond=f.frameRate),y});i={consumerId:n,peerId:a,producerId:c,appData:d,videoStats:l,audioStats:r==null?void 0:r.inboundAudioRtpId.map(h=>e.inboundAudioRtp.get(h))}}catch(a){console.error("getConsumerStatsFromParsedConsumerStats: ",a,e)}return i}getConsumerStatsFromReport(e){const r=[];try{e.consumerStreamMap.forEach((n,i)=>{r.push(this.getConsumerStatsFromParsedConsumerStats(e,n,i))})}catch(n){console.error("getConsumerStatsFromReport: ",n,e)}return r}}class ev extends vh{}function tc(s,t,e,r){if(s!=null&&s.logger&&s.logger.error("Callstats::handleError",{error:r}),typeof e=="function"&&r instanceof t)e.call(null,r,s);else throw r}function Th(s,t,e){const r=s.value;return s.value=function(...n){try{const i=r.apply(this,n);return i&&i instanceof Promise?i.catch(a=>{tc(this,t,e,a)}):i}catch(i){tc(this,t,e,i)}return null},s}const Z=(s,t)=>(e,r,n)=>{const i=n.value;return n.value=function(...a){try{const c=i.apply(this,a);return c&&c instanceof Promise?c.catch(d=>{tc(this,s,t,d)}):c}catch(c){tc(this,s,t,c)}return null},n},tv=(s,t)=>(e,r,n)=>{if(n)return Th(n,s,t);for(const i of Reflect.ownKeys(e.prototype).filter(a=>a!=="constructor")){const a=Object.getOwnPropertyDescriptor(e.prototype,i);a.value instanceof Function&&Object.defineProperty(e.prototype,i,Th(a,s,t))}};var Y=globalThis&&globalThis.__decorate||function(s,t,e,r){var n=arguments.length,i=n<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,e):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(s,t,e,r);else for(var c=s.length-1;c>=0;c--)(a=s[c])&&(i=(n<3?a(i):n>3?a(t,e,i):a(t,e))||i);return n>3&&i&&Object.defineProperty(t,e,i),i};const Q=console;let K=class extends re{constructor(e="https://api.testingv3.dyte.in",r="Blink",n=ha.PROD,i,a,c,d){super();p(this,"observer");p(this,"eventHandler");p(this,"measurements");p(this,"producingTransport");p(this,"consumingTransport");p(this,"producers",new Map);p(this,"consumers",new Map);p(this,"iceServers");p(this,"connectionInfoPromise");p(this,"pingStatsTimeout");p(this,"logger");p(this,"env");p(this,"apiHostnames");p(this,"peerId");p(this,"consumerSharedMediaStatesMap",new Map);p(this,"currentUserMediaStates",{});switch(this.env=n,this.apiHostnames=d,this.logger=a,this.peerId=c,this.eventHandler=new Fg({logger:a,peerId:c,apiHostnames:d}),this.logger.debug("callStats::engineName: ",{engineName:r}),r){case"Blink":this.measurements=new Zg;break;case"Gecko":this.measurements=new vh;break;case"WebKit":this.measurements=new ev;break;default:throw Error(`Unknown engineName! ${r}`)}this.measurements.callStatsInstance=this,this.registerProducer=this.registerProducer.bind(this),this.registerConsumer=this.registerConsumer.bind(this),this.observer=new re,this.measurements.observer.on("consumer_score",l=>{a.debug(`callStats::consumer_score ${[...l.entries()]}`),this.eventHandler.emit("consumer_score",l)}),this.measurements.observer.on("producer_score",l=>{a.debug(`callStats::producer_score ${[...l.entries()]}`),this.eventHandler.emit("producer_score",l)})}registerIceServers(e){this.iceServers=e}registerConsumer(e){var r;this.consumerSharedMediaStatesMap.has(e.id)||this.consumerSharedMediaStatesMap.set(e.id,{}),this.consumers.set(e.id,e),this.measurements.registerConsumer(e),this.logger.debug("callStats::registerConsumer",{consumerId:e.id,consumerkind:e.kind,isScreenShare:!!((r=e.appData)!=null&&r.screenShare)}),e.on("close",this.deRegisterConsumer.bind(this,e))}registerProducer(e){var r;this.producers.set(e.id,e),this.measurements.registerProducer(e),this.logger.debug("callStats::registerProducer",{producerId:e.id,producerKind:e.kind,isScreenShare:!!((r=e.appData)!=null&&r.screenShare)}),e.on("close",this.deRegisterProducer.bind(this,e))}sendConsumerSharedMediaStateEvent(e,r){this.consumerSharedMediaStatesMap.has(e)||this.consumerSharedMediaStatesMap.set(e,{});const n=this.consumerSharedMediaStatesMap.get(e);this.consumerSharedMediaStatesMap.set(e,Object.assign(n,r))}registerProducingTransport(e){var n;this.producingTransport=e,e.observer.on("close",this.disconnectProducingTransport.bind(this,e)),e.observer.on("disconnect",this.disconnectProducingTransport.bind(this,e)),Array.from(((n=e._producers)==null?void 0:n.values())||[]).forEach(i=>{this.registerProducer(i)}),e.observer.on("newproducer",this.registerProducer)}registerConsumingTransport(e){var n;this.consumingTransport=e,e.observer.on("close",this.disconnectConsumingTransport.bind(this,e)),e.observer.on("disconnect",this.disconnectConsumingTransport.bind(this,e)),Array.from(((n=e._consumers)==null?void 0:n.values())||[]).forEach(i=>{this.registerConsumer(i)}),e.observer.on("newconsumer",this.registerConsumer)}deRegisterConsumer(e){this.consumers.delete(e.id)}deRegisterProducer(e){var r;this.producers.delete(e.id),this.logger.debug("callStats::deRegisterProducer",{producerId:e.id,producerKind:e.kind,isScreenShare:!!((r=e.appData)!=null&&r.screenShare)})}disconnectConsumingTransport(){this.consumingTransport=void 0}disconnectProducingTransport(){this.producingTransport=void 0}callEvent(e){this.eventHandler.callEvent(e)}sendPreCallTestBeginEvent(e=!1,r){this.connectionInfoPromise=this.measurements.getNetworkInfo(this.iceServers,e),this.eventHandler.callEvent({event:N.PRECALL_TEST_BEGIN,timestamp:r}),this.connectionInfoPromise&&this.connectionInfoPromise.then(n=>{this.eventHandler.callEvent({event:N.PRECALL_TEST_COMPLETE,metaData:{connectionInfo:n},timestamp:r})})}sendScreenShareToggleEvent(e,r=null,n){this.currentUserMediaStates.screen=e,this.eventHandler.callEvent({event:e?N.SCREENSHARE_STARTED:N.SCREENSHARE_STOPPED,metaData:{ssrc:r},timestamp:n})}sendScreenShareRequestedEvent(e){this.eventHandler.callEvent({event:N.SCREENSHARE_START_REQUESTED,timestamp:e})}sendActiveSpeakerEvent(e,r){this.eventHandler.callEvent({event:N.DOMINANT_SPEAKER,metaData:{peerId:e},timestamp:r})}devices(e,r,n){this.eventHandler.callEvent({event:e===Jt.AUDIO&&N.AUDIO_DEVICES_UPDATES||e===Jt.VIDEO&&N.VIDEO_DEVICES_UPDATES||e===Jt.SPEAKER&&N.SPEAKER_DEVICES_UPDATES,metaData:{deviceList:r},timestamp:n})}selectedDevice(e,r,n){this.eventHandler.callEvent({event:e===Jt.AUDIO&&N.SELECTED_MICROHPONE_UPDATE||e===Jt.VIDEO&&N.SELECTED_CAMERA_UPDATE||e===Jt.SPEAKER&&N.SELECTED_SPEAKER_UPDATE,metaData:{device:r},timestamp:n})}mediaPermission(e,r,n){this.eventHandler.callEvent({event:N.MEDIA_PERMISSION,metaData:{deviceType:e,permission:r},timestamp:n})}mediaPlaybackFailed(e,r){this.eventHandler.callEvent({event:e===Jt.AUDIO&&N.AUDIO_PLAY_FAILED||e===Jt.VIDEO&&N.VIDEO_PLAY_FAILED,metaData:{deviceType:e},timestamp:r})}mediaTrackMuted(e,r){this.eventHandler.callEvent({event:e===Jt.AUDIO&&N.AUDIO_TRACK_MUTED||e===Jt.VIDEO&&N.VIDEO_TRACK_MUTED,metaData:{deviceType:e},timestamp:r})}tabChanged(e,r){this.eventHandler.callEvent({event:N.TAB_CHANGE,metaData:{isMeetingsTabActive:e},timestamp:r})}browserBackgrounded(e){this.eventHandler.callEvent({event:N.BROWSER_BACKGROUNDED,timestamp:e})}browserForegrounded(e){this.eventHandler.callEvent({event:N.BROWSER_FOREGROUNDED,timestamp:e})}legacySwitch(e,r){this.eventHandler.callEvent({event:N.LEGACY_SWITCH,metadata:{on:e},timestamp:r})}async getPreCallTestResults(){return this.connectionInfoPromise}sendCallJoinBeginEvent(e,r){e={...e,meetingEnv:this.env},e.deviceInfo={...e.deviceInfo,userAgent:navigator.userAgent,cpus:navigator.hardwareConcurrency,memory:navigator.deviceMemory},this.eventHandler.callEvent({event:N.CALL_JOIN_BEGIN,metaData:{peerMetaData:e},timestamp:r})}sendNetworkQualityTestBeginEvent(e,r){this.eventHandler.callEvent({event:N.NET_QUALITY_TEST_BEGIN,timestamp:r}),new Promise(async(i,a)=>{const c=[];try{for(const d of e)try{if(d.iceServers&&d.iceServers.length>0){const l=await this.measurements.getNetworkQuality(d.iceServers);c.push({...d,networkResults:l})}}catch(l){console.warn("Error handling ",l)}i({regionData:c})}catch(d){console.warn("Error in callstats, ",d),a(d)}}).then(i=>{this.eventHandler.callEvent({event:N.NET_QUALITY_TEST_END,timestamp:r,metaData:i})})}sendWebSocketConnectedEvent(e){this.eventHandler.callEvent({event:N.WEBSOCKET_CONNECTED,timestamp:e})}sendTransportConnectedEvent(e){this.eventHandler.callEvent({event:N.TRANSPORT_CONNECTED,timestamp:e})}sendAudioToggleEvent(e,r){this.currentUserMediaStates.audio=e;let n;e?n=N.AUDIO_ON:n=N.AUDIO_OFF,this.eventHandler.callEvent({event:n,timestamp:r})}sendVideoToggleEvent(e,r){this.currentUserMediaStates.video=e;let n;e?n=N.VIDEO_ON:n=N.VIDEO_OFF,this.eventHandler.callEvent({event:n,timestamp:r})}sendParticipantRoleToggleEvent(e,r){this.eventHandler.callEvent({event:N.PARTICIPANT_ROLE,timestamp:r,metaData:e})}startPingStats(e=7e3){this.sendPingStatsEvent(!1,new Date),this.pingStatsTimeout=setInterval(this.sendPingStatsEvent.bind(this),e)}stopPingStats(){clearInterval(this.pingStatsTimeout)}async sendPingStatsEvent(e=!0,r){let n,i;if(this.producingTransport&&(n=await this.measurements.getProcessedStats(this.producingTransport,!1,!0),!n||!(n!=null&&n.producerReport))){this.logger.debug("callStats::sendPingStatsEvent::staleProducingTransport",{disclaimer:"Stale producer? Regenerating Stream Maps!"});const c=await this.measurements.getProducersReport([...this.producers.values()]);n&&c?n.producerReport=c:(n=await this.measurements.getProcessedStats(this.producingTransport,!1,!0),(!n||!(n!=null&&n.producerReport))&&this.logger.debug("callStats::sendPingStatsEvent::noProducingTransportReport",{disclaimer:"Stream maps invalid despite regenerating!"}))}if(this.consumingTransport&&(i=await this.measurements.getProcessedStats(this.consumingTransport,!0,!1),!i||!i.consumerReport)){this.logger.debug("callStats::sendPingStatsEvent::staleConsumingTransport",{disclaimer:"Stale consumer? Regenerating Stream Maps!"});const c=await this.measurements.getConsumersReport([...this.consumers.values()]);i&&c?i.consumerReport=c:(i=await this.measurements.getProcessedStats(this.consumingTransport,!0,!1),(!i||!i.consumerReport)&&this.logger.debug("callStats::sendPingStatsEvent::noConsumingTransportReport",{disclaimer:"Stream maps invalid despite regenerating!"}))}const a={producingTransportStats:n?n==null?void 0:n.transportReport:void 0,consumingTransportStats:i?i==null?void 0:i.transportReport:void 0,producerStats:[].concat((n==null?void 0:n.producerReport)||[]).concat((i==null?void 0:i.producerReport)||[]),consumerStats:[].concat((i==null?void 0:i.consumerReport)||[]).concat((n==null?void 0:n.consumerReport)||[])};if(e&&a.producerStats.length===0&&a.consumerStats.length===0){await this.eventHandler.flush();return}this.eventHandler.callEvent({event:N.PING_STAT,metaData:a,timestamp:r})}sendIVSPlayerRebufferEvent(e){this.eventHandler.callEvent({event:N.IVS_PLAYER_REBUFFERING,timestamp:e})}sendIVSPlayerAudioBlockEvent(e){this.eventHandler.callEvent({event:N.IVS_PLAYER_AUDIO_BLOCKED,timestamp:e})}sendIVSPlayerPlaybackBlockedEvent(e){this.eventHandler.callEvent({event:N.IVS_PLAYER_PLAYBACK_BLOCKED,timestamp:e})}sendIVSPlayerNetworkUnavailableEvent(e){this.eventHandler.callEvent({event:N.IVS_PLAYER_NETWORK_UNAVAILABLE,timestamp:e})}sendIVSPlayerInitializedEvent(e){this.eventHandler.callEvent({event:N.IVS_PLAYER_INITIALIZED,timestamp:e})}sendIVSPlayerWorkerErrorEvent(e){this.eventHandler.callEvent({event:N.IVS_PLAYER_WORKER_ERROR,timestamp:e})}sendIVSPlayerErrorEvent(e,r){this.eventHandler.callEvent({event:N.IVS_PLAYER_ERROR,timestamp:r,metaData:e})}sendIVSPlayerRecoverableErrorEvent(e,r){this.eventHandler.callEvent({event:N.IVS_PLAYER_RECOVERABLE_ERROR,timestamp:r,metaData:e})}sendIVSPlayerAnalyticsEvent(e,r){this.eventHandler.callEvent({event:N.IVS_PLAYER_ANALYTICS_EVENT,timestamp:r,metaData:e})}sendIVSPlayerPlaybackRateChangedEvent(e,r){this.eventHandler.callEvent({event:N.IVS_PLAYER_PLAYBACK_RATE_CHANGED,timestamp:r,metaData:{updatedPlaybackRate:e}})}sendIVSPlayerQualityChanged(e,r){this.eventHandler.callEvent({event:N.IVS_PLAYER_QUALITY_CHANGED,timestamp:r,metaData:e})}sendPlayerLiveLatency(e,r){this.eventHandler.callEvent({event:N.LIVESTREAM_LATENCY,timestamp:r,metaData:{latency:e}})}sendDisconnectEvent(e){this.eventHandler.callEvent({event:N.DISCONNECT,timestamp:e})}sendReconnectEvent(e){this.eventHandler.callEvent({event:N.RECONNECT_ATTEMPT,timestamp:e})}expectedVideoResolution(e,r,n){this.eventHandler.callEvent({event:N.EXPECTED_VIDEO_RESOLUTION,timestamp:n,metaData:{frameWidth:e,frameHeight:r}})}expectedScreenshareResolution(e,r,n){this.eventHandler.callEvent({event:N.EXPECTED_SCREENSHARE_RESOLUTION,timestamp:n,metaData:{frameWidth:e,frameHeight:r}})}};Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"registerIceServers",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"registerConsumer",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"registerProducer",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendConsumerSharedMediaStateEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"registerProducingTransport",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"registerConsumingTransport",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"deRegisterConsumer",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"deRegisterProducer",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"disconnectConsumingTransport",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"disconnectProducingTransport",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendPreCallTestBeginEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendScreenShareToggleEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendScreenShareRequestedEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendActiveSpeakerEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"devices",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"selectedDevice",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"mediaPermission",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"mediaPlaybackFailed",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"mediaTrackMuted",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"tabChanged",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"browserBackgrounded",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"browserForegrounded",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"legacySwitch",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"getPreCallTestResults",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendCallJoinBeginEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendNetworkQualityTestBeginEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendWebSocketConnectedEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendTransportConnectedEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendAudioToggleEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendVideoToggleEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendParticipantRoleToggleEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"startPingStats",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"stopPingStats",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendPingStatsEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerRebufferEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerAudioBlockEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerPlaybackBlockedEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerNetworkUnavailableEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerInitializedEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerWorkerErrorEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerErrorEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerRecoverableErrorEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerAnalyticsEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerPlaybackRateChangedEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendIVSPlayerQualityChanged",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendPlayerLiveLatency",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendDisconnectEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"sendReconnectEvent",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"expectedVideoResolution",null),Y([Z(TypeError,(s,t)=>Q.error(t,s))],K.prototype,"expectedScreenshareResolution",null),K=Y([tv(TypeError,(s,t)=>Q.error(t,s))],K);const sv=K;class rv extends re{constructor(){super(...arguments);p(this,"stats");p(this,"peerId");p(this,"backend");p(this,"iceServers");p(this,"initialized",!1);p(this,"stalled",!1);p(this,"ipInformation");p(this,"logger")}async initialize({peerId:e,engineName:r,env:n=ha.PROD,iceServers:i,apiBase:a="https://api.cluster.dyte.in",flags:c,logger:d=console,apiHostnames:l,skipConnectivityChecks:h=!1}){var m,f,y;try{this.peerId=e,this.logger=d,this.ipInformation=await Wd.getIPDetails({peerId:e,apiHostnames:l,logger:d}),this.backend=new sv(a,r,n,c,d,e,l),this.iceServers=i,(m=this.backend)==null||m.registerIceServers(this.iceServers),this.initialized=!0,(y=(f=this.backend)==null?void 0:f.eventHandler)==null||y.emit("initialized",this.ipInformation),this.emit("initialized",this.ipInformation),this.startPreCallTest(h)}catch(_){this.logger.error("callStats::CallStatsIntegration: ",{error:_}),this.stallCallStats()}}configureSendTransport(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.registerProducingTransport(e)})}configureRecvTransport(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.registerConsumingTransport(e)})}async candidateRegionalNetworkQualityTest(e){const r=new Date;this.onSafeInitialization(()=>{var n;try{(n=this.backend)==null||n.sendNetworkQualityTestBeginEvent(e,r)}catch(i){this.logger.error("callStats::sendNetworkQualityTestBeginEvent",{error:{reason:i.reason}})}})}async roomJoined(e){const r=new Date;this.onSafeInitialization(()=>{var n,i;(n=this.backend)==null||n.sendCallJoinBeginEvent(e,r),this.backend,(i=this.backend)==null||i.startPingStats()})}audioOff(){const e=new Date;this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.sendAudioToggleEvent(!1,e)})}audioOn(){const e=new Date;this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.sendAudioToggleEvent(!0,e)})}videoOff(){const e=new Date;this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.sendVideoToggleEvent(!1,e)})}videoOn(){const e=new Date;this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.sendVideoToggleEvent(!0,e)})}callEnded(){const e=new Date;this.onSafeInitialization(()=>{var r,n;(r=this.backend)==null||r.stopPingStats(),(n=this.backend)==null||n.sendDisconnectEvent(e)})}screenShareStart(e){const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.sendScreenShareToggleEvent(!0,e,r)})}consumerSharedMediaState(e,r){this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.sendConsumerSharedMediaStateEvent(e,r)})}screenShareStop(e){const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.sendScreenShareToggleEvent(!1,e,r)})}screenShareRequested(){const e=new Date;this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.sendScreenShareRequestedEvent(e)})}activeSpeaker(e){if(e!==this.peerId)return;const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.sendActiveSpeakerEvent(e,r)})}devices(e,r){const n=new Date;this.onSafeInitialization(()=>{var i;(i=this.backend)==null||i.devices(e,r,n)})}selectedDevice(e,r){const n=new Date;this.onSafeInitialization(()=>{var i;(i=this.backend)==null||i.selectedDevice(e,r,n)})}mediaPermission(e,r){const n=new Date;this.onSafeInitialization(()=>{var i;(i=this.backend)==null||i.mediaPermission(e,r,n)})}mediaPlaybackFailed(e){const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.mediaPlaybackFailed(e,r)})}mediaTrackMuted(e){const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.mediaTrackMuted(e,r)})}tabChanged(e=!1){const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.tabChanged(e,r)})}browserBackgrounded(){const e=new Date;this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.browserBackgrounded(e)})}browserForegrounded(){const e=new Date;this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.browserForegrounded(e)})}legacySwitch(e){const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.legacySwitch(e,r)})}async startPreCallTest(e=!1){const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.sendPreCallTestBeginEvent(e,r)})}onPreCallTestResults(e){return this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.once("precall_end",e)}),e}onReceivingConsumerAudioStatus(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.on("consumer_audio_status",e)})}onReceivingConsumerVideoStatus(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.on("consumer_video_status",e)})}onReceivingProducerAudioStatus(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.on("producer_audio_status",e)})}onReceivingProducerVideoStatus(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.on("producer_video_status",e)})}onReceivingProducingTransportStatus(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.on("producing_transport_status",e)})}onReceivingConsumingTransportStatus(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.on("consuming_transport_status",e)})}onProducerScore(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.on("producer_score",e)})}onConsumerScore(e){this.onSafeInitialization(()=>{var r;(r=this.backend)==null||r.eventHandler.on("consumer_score",e)})}onSafeInitialization(e){if(this.initialized)e(this.ipInformation,!1);else if(!this.stalled){const r=n=>{e(n,!0)};return this.once("initialized",r),r}return()=>{}}removeInitializationListener(e){this.removeListener("initialized",e)}stallCallStats(){this.stalled=!0,this.removeAllListeners("initialized")}ivsPlayerEvent(e,r){const n=new Date;this.onSafeInitialization(()=>{var i,a,c,d,l,h,m,f,y,_,b;switch(e){case"PlayerRebuffering":(i=this.backend)==null||i.sendIVSPlayerRebufferEvent(n);break;case"PlayerAudioBlocked":(a=this.backend)==null||a.sendIVSPlayerAudioBlockEvent(n);break;case"PlayerPlaybackBlocked":(c=this.backend)==null||c.sendIVSPlayerPlaybackBlockedEvent(n);break;case"PlayerNetworkUnavailable":(d=this.backend)==null||d.sendIVSPlayerNetworkUnavailableEvent(n);break;case"PlayerInitialized":(l=this.backend)==null||l.sendIVSPlayerInitializedEvent(n);break;case"PlayerWorkerError":(h=this.backend)==null||h.sendIVSPlayerWorkerErrorEvent(n);break;case"PlayerError":(m=this.backend)==null||m.sendIVSPlayerErrorEvent(r,n);break;case"PlayerRecoverableError":(f=this.backend)==null||f.sendIVSPlayerRecoverableErrorEvent(r,n);break;case"PlayerAnalyticsEvent":(y=this.backend)==null||y.sendIVSPlayerAnalyticsEvent(r,n);break;case"PlayerPlaybackRateChanged":(_=this.backend)==null||_.sendIVSPlayerPlaybackRateChangedEvent(r,n);break;case"PlayerQualityChanged":(b=this.backend)==null||b.sendIVSPlayerQualityChanged(r,n);break}})}livestreamLatency(e){const r=new Date;this.onSafeInitialization(()=>{var n;(n=this.backend)==null||n.sendPlayerLiveLatency(e,r)})}expectedVideoResolution(e,r){const n=new Date;this.onSafeInitialization(()=>{var i;(i=this.backend)==null||i.expectedVideoResolution(e,r,n)})}expectedScreenshareResolution(e,r){const n=new Date;this.onSafeInitialization(()=>{var i;(i=this.backend)==null||i.expectedScreenshareResolution(e,r,n)})}}const j=new rv;j.setMaxListeners(30);function nv(s){const{length:t}=this,e=s>=0?s:t+s;return e<0||e>=t?void 0:this[e]}Array.prototype.at||Object.assign(Array.prototype,{at:nv});function iv(s){const{length:t}=this,e=s>=0?s:t+s;return e<0||e>=t?void 0:this[e]}String.prototype.at||Object.assign(String.prototype,{at:iv});var sc,av=new Uint8Array(16);function ov(){if(!sc&&(sc=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!sc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return sc(av)}const cv=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Jd(s){return typeof s=="string"&&cv.test(s)}for(var rt=[],Kd=0;Kd<256;++Kd)rt.push((Kd+256).toString(16).substr(1));function dv(s){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=(rt[s[t+0]]+rt[s[t+1]]+rt[s[t+2]]+rt[s[t+3]]+"-"+rt[s[t+4]]+rt[s[t+5]]+"-"+rt[s[t+6]]+rt[s[t+7]]+"-"+rt[s[t+8]]+rt[s[t+9]]+"-"+rt[s[t+10]]+rt[s[t+11]]+rt[s[t+12]]+rt[s[t+13]]+rt[s[t+14]]+rt[s[t+15]]).toLowerCase();if(!Jd(e))throw TypeError("Stringified UUID is invalid");return e}function Jn(s,t,e){s=s||{};var r=s.random||(s.rng||ov)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){e=e||0;for(var n=0;n<16;++n)t[e+n]=r[n];return t}return dv(r)}function lv(){this.__data__=[],this.size=0}function pa(s,t){return s===t||s!==s&&t!==t}function rc(s,t){for(var e=s.length;e--;)if(pa(s[e][0],t))return e;return-1}var uv=Array.prototype,hv=uv.splice;function pv(s){var t=this.__data__,e=rc(t,s);if(e<0)return!1;var r=t.length-1;return e==r?t.pop():hv.call(t,e,1),--this.size,!0}function mv(s){var t=this.__data__,e=rc(t,s);return e<0?void 0:t[e][1]}function fv(s){return rc(this.__data__,s)>-1}function gv(s,t){var e=this.__data__,r=rc(e,s);return r<0?(++this.size,e.push([s,t])):e[r][1]=t,this}function Us(s){var t=-1,e=s==null?0:s.length;for(this.clear();++t<e;){var r=s[t];this.set(r[0],r[1])}}Us.prototype.clear=lv,Us.prototype.delete=pv,Us.prototype.get=mv,Us.prototype.has=fv,Us.prototype.set=gv;function vv(){this.__data__=new Us,this.size=0}function Tv(s){var t=this.__data__,e=t.delete(s);return this.size=t.size,e}function yv(s){return this.__data__.get(s)}function Sv(s){return this.__data__.has(s)}var Ev=typeof global=="object"&&global&&global.Object===Object&&global;const yh=Ev;var _v=typeof self=="object"&&self&&self.Object===Object&&self,bv=yh||_v||Function("return this")();const os=bv;var wv=os.Symbol;const dr=wv;var Sh=Object.prototype,Pv=Sh.hasOwnProperty,Cv=Sh.toString,ma=dr?dr.toStringTag:void 0;function Rv(s){var t=Pv.call(s,ma),e=s[ma];try{s[ma]=void 0;var r=!0}catch(i){}var n=Cv.call(s);return r&&(t?s[ma]=e:delete s[ma]),n}var kv=Object.prototype,Iv=kv.toString;function Av(s){return Iv.call(s)}var Mv="[object Null]",Dv="[object Undefined]",Eh=dr?dr.toStringTag:void 0;function zr(s){return s==null?s===void 0?Dv:Mv:Eh&&Eh in Object(s)?Rv(s):Av(s)}function cs(s){var t=typeof s;return s!=null&&(t=="object"||t=="function")}var Ov="[object AsyncFunction]",Nv="[object Function]",Lv="[object GeneratorFunction]",xv="[object Proxy]";function zd(s){if(!cs(s))return!1;var t=zr(s);return t==Nv||t==Lv||t==Ov||t==xv}var Vv=os["__core-js_shared__"];const Yd=Vv;var _h=function(){var s=/[^.]+$/.exec(Yd&&Yd.keys&&Yd.keys.IE_PROTO||"");return s?"Symbol(src)_1."+s:""}();function Uv(s){return!!_h&&_h in s}var Fv=Function.prototype,Bv=Fv.toString;function Yr(s){if(s!=null){try{return Bv.call(s)}catch(t){}try{return s+""}catch(t){}}return""}var $v=/[\\^$.*+?()[\]{}|]/g,Hv=/^\[object .+?Constructor\]$/,qv=Function.prototype,jv=Object.prototype,Gv=qv.toString,Wv=jv.hasOwnProperty,Jv=RegExp("^"+Gv.call(Wv).replace($v,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Kv(s){if(!cs(s)||Uv(s))return!1;var t=zd(s)?Jv:Hv;return t.test(Yr(s))}function zv(s,t){return s==null?void 0:s[t]}function Qr(s,t){var e=zv(s,t);return Kv(e)?e:void 0}var Yv=Qr(os,"Map");const fa=Yv;var Qv=Qr(Object,"create");const ga=Qv;function Xv(){this.__data__=ga?ga(null):{},this.size=0}function Zv(s){var t=this.has(s)&&delete this.__data__[s];return this.size-=t?1:0,t}var eT="__lodash_hash_undefined__",tT=Object.prototype,sT=tT.hasOwnProperty;function rT(s){var t=this.__data__;if(ga){var e=t[s];return e===eT?void 0:e}return sT.call(t,s)?t[s]:void 0}var nT=Object.prototype,iT=nT.hasOwnProperty;function aT(s){var t=this.__data__;return ga?t[s]!==void 0:iT.call(t,s)}var oT="__lodash_hash_undefined__";function cT(s,t){var e=this.__data__;return this.size+=this.has(s)?0:1,e[s]=ga&&t===void 0?oT:t,this}function Xr(s){var t=-1,e=s==null?0:s.length;for(this.clear();++t<e;){var r=s[t];this.set(r[0],r[1])}}Xr.prototype.clear=Xv,Xr.prototype.delete=Zv,Xr.prototype.get=rT,Xr.prototype.has=aT,Xr.prototype.set=cT;function dT(){this.size=0,this.__data__={hash:new Xr,map:new(fa||Us),string:new Xr}}function lT(s){var t=typeof s;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?s!=="__proto__":s===null}function nc(s,t){var e=s.__data__;return lT(t)?e[typeof t=="string"?"string":"hash"]:e.map}function uT(s){var t=nc(this,s).delete(s);return this.size-=t?1:0,t}function hT(s){return nc(this,s).get(s)}function pT(s){return nc(this,s).has(s)}function mT(s,t){var e=nc(this,s),r=e.size;return e.set(s,t),this.size+=e.size==r?0:1,this}function Zr(s){var t=-1,e=s==null?0:s.length;for(this.clear();++t<e;){var r=s[t];this.set(r[0],r[1])}}Zr.prototype.clear=dT,Zr.prototype.delete=uT,Zr.prototype.get=hT,Zr.prototype.has=pT,Zr.prototype.set=mT;var fT=200;function gT(s,t){var e=this.__data__;if(e instanceof Us){var r=e.__data__;if(!fa||r.length<fT-1)return r.push([s,t]),this.size=++e.size,this;e=this.__data__=new Zr(r)}return e.set(s,t),this.size=e.size,this}function bs(s){var t=this.__data__=new Us(s);this.size=t.size}bs.prototype.clear=vv,bs.prototype.delete=Tv,bs.prototype.get=yv,bs.prototype.has=Sv,bs.prototype.set=gT;function vT(s,t){for(var e=-1,r=s==null?0:s.length;++e<r&&t(s[e],e,s)!==!1;);return s}var TT=function(){try{var s=Qr(Object,"defineProperty");return s({},"",{}),s}catch(t){}}();const ic=TT;function Qd(s,t,e){t=="__proto__"&&ic?ic(s,t,{configurable:!0,enumerable:!0,value:e,writable:!0}):s[t]=e}var yT=Object.prototype,ST=yT.hasOwnProperty;function bh(s,t,e){var r=s[t];(!(ST.call(s,t)&&pa(r,e))||e===void 0&&!(t in s))&&Qd(s,t,e)}function va(s,t,e,r){var n=!e;e||(e={});for(var i=-1,a=t.length;++i<a;){var c=t[i],d=r?r(e[c],s[c],c,e,s):void 0;d===void 0&&(d=s[c]),n?Qd(e,c,d):bh(e,c,d)}return e}function ET(s,t){for(var e=-1,r=Array(s);++e<s;)r[e]=t(e);return r}function ws(s){return s!=null&&typeof s=="object"}var _T="[object Arguments]";function wh(s){return ws(s)&&zr(s)==_T}var Ph=Object.prototype,bT=Ph.hasOwnProperty,wT=Ph.propertyIsEnumerable,PT=wh(function(){return arguments}())?wh:function(s){return ws(s)&&bT.call(s,"callee")&&!wT.call(s,"callee")};const ac=PT;var CT=Array.isArray;const lr=CT;function RT(){return!1}var Ch=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Rh=Ch&&typeof module=="object"&&module&&!module.nodeType&&module,kT=Rh&&Rh.exports===Ch,kh=kT?os.Buffer:void 0,IT=kh?kh.isBuffer:void 0,AT=IT||RT;const Kn=AT;var MT=9007199254740991,DT=/^(?:0|[1-9]\d*)$/;function Ih(s,t){var e=typeof s;return t=t==null?MT:t,!!t&&(e=="number"||e!="symbol"&&DT.test(s))&&s>-1&&s%1==0&&s<t}var OT=9007199254740991;function Ah(s){return typeof s=="number"&&s>-1&&s%1==0&&s<=OT}var NT="[object Arguments]",LT="[object Array]",xT="[object Boolean]",VT="[object Date]",UT="[object Error]",FT="[object Function]",BT="[object Map]",$T="[object Number]",HT="[object Object]",qT="[object RegExp]",jT="[object Set]",GT="[object String]",WT="[object WeakMap]",JT="[object ArrayBuffer]",KT="[object DataView]",zT="[object Float32Array]",YT="[object Float64Array]",QT="[object Int8Array]",XT="[object Int16Array]",ZT="[object Int32Array]",ey="[object Uint8Array]",ty="[object Uint8ClampedArray]",sy="[object Uint16Array]",ry="[object Uint32Array]",_e={};_e[zT]=_e[YT]=_e[QT]=_e[XT]=_e[ZT]=_e[ey]=_e[ty]=_e[sy]=_e[ry]=!0,_e[NT]=_e[LT]=_e[JT]=_e[xT]=_e[KT]=_e[VT]=_e[UT]=_e[FT]=_e[BT]=_e[$T]=_e[HT]=_e[qT]=_e[jT]=_e[GT]=_e[WT]=!1;function ny(s){return ws(s)&&Ah(s.length)&&!!_e[zr(s)]}function Xd(s){return function(t){return s(t)}}var Mh=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Ta=Mh&&typeof module=="object"&&module&&!module.nodeType&&module,iy=Ta&&Ta.exports===Mh,Zd=iy&&yh.process,ay=function(){try{var s=Ta&&Ta.require&&Ta.require("util").types;return s||Zd&&Zd.binding&&Zd.binding("util")}catch(t){}}();const zn=ay;var Dh=zn&&zn.isTypedArray,oy=Dh?Xd(Dh):ny;const oc=oy;var cy=Object.prototype,dy=cy.hasOwnProperty;function Oh(s,t){var e=lr(s),r=!e&&ac(s),n=!e&&!r&&Kn(s),i=!e&&!r&&!n&&oc(s),a=e||r||n||i,c=a?ET(s.length,String):[],d=c.length;for(var l in s)(t||dy.call(s,l))&&!(a&&(l=="length"||n&&(l=="offset"||l=="parent")||i&&(l=="buffer"||l=="byteLength"||l=="byteOffset")||Ih(l,d)))&&c.push(l);return c}var ly=Object.prototype;function cc(s){var t=s&&s.constructor,e=typeof t=="function"&&t.prototype||ly;return s===e}function Nh(s,t){return function(e){return s(t(e))}}var uy=Nh(Object.keys,Object);const hy=uy;var py=Object.prototype,my=py.hasOwnProperty;function Lh(s){if(!cc(s))return hy(s);var t=[];for(var e in Object(s))my.call(s,e)&&e!="constructor"&&t.push(e);return t}function ya(s){return s!=null&&Ah(s.length)&&!zd(s)}function el(s){return ya(s)?Oh(s):Lh(s)}function fy(s,t){return s&&va(t,el(t),s)}function gy(s){var t=[];if(s!=null)for(var e in Object(s))t.push(e);return t}var vy=Object.prototype,Ty=vy.hasOwnProperty;function yy(s){if(!cs(s))return gy(s);var t=cc(s),e=[];for(var r in s)r=="constructor"&&(t||!Ty.call(s,r))||e.push(r);return e}function Sa(s){return ya(s)?Oh(s,!0):yy(s)}function Sy(s,t){return s&&va(t,Sa(t),s)}var xh=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Vh=xh&&typeof module=="object"&&module&&!module.nodeType&&module,Ey=Vh&&Vh.exports===xh,Uh=Ey?os.Buffer:void 0,Fh=Uh?Uh.allocUnsafe:void 0;function Bh(s,t){if(t)return s.slice();var e=s.length,r=Fh?Fh(e):new s.constructor(e);return s.copy(r),r}function $h(s,t){var e=-1,r=s.length;for(t||(t=Array(r));++e<r;)t[e]=s[e];return t}function _y(s,t){for(var e=-1,r=s==null?0:s.length,n=0,i=[];++e<r;){var a=s[e];t(a,e,s)&&(i[n++]=a)}return i}function Hh(){return[]}var by=Object.prototype,wy=by.propertyIsEnumerable,qh=Object.getOwnPropertySymbols,Py=qh?function(s){return s==null?[]:(s=Object(s),_y(qh(s),function(t){return wy.call(s,t)}))}:Hh;const tl=Py;function Cy(s,t){return va(s,tl(s),t)}function jh(s,t){for(var e=-1,r=t.length,n=s.length;++e<r;)s[n+e]=t[e];return s}var Ry=Nh(Object.getPrototypeOf,Object);const sl=Ry;var ky=Object.getOwnPropertySymbols,Iy=ky?function(s){for(var t=[];s;)jh(t,tl(s)),s=sl(s);return t}:Hh;const Gh=Iy;function Ay(s,t){return va(s,Gh(s),t)}function Wh(s,t,e){var r=t(s);return lr(s)?r:jh(r,e(s))}function rl(s){return Wh(s,el,tl)}function My(s){return Wh(s,Sa,Gh)}var Dy=Qr(os,"DataView");const nl=Dy;var Oy=Qr(os,"Promise");const il=Oy;var Ny=Qr(os,"Set");const al=Ny;var Ly=Qr(os,"WeakMap");const ol=Ly;var Jh="[object Map]",xy="[object Object]",Kh="[object Promise]",zh="[object Set]",Yh="[object WeakMap]",Qh="[object DataView]",Vy=Yr(nl),Uy=Yr(fa),Fy=Yr(il),By=Yr(al),$y=Yr(ol),en=zr;(nl&&en(new nl(new ArrayBuffer(1)))!=Qh||fa&&en(new fa)!=Jh||il&&en(il.resolve())!=Kh||al&&en(new al)!=zh||ol&&en(new ol)!=Yh)&&(en=function(s){var t=zr(s),e=t==xy?s.constructor:void 0,r=e?Yr(e):"";if(r)switch(r){case Vy:return Qh;case Uy:return Jh;case Fy:return Kh;case By:return zh;case $y:return Yh}return t});const Yn=en;var Hy=Object.prototype,qy=Hy.hasOwnProperty;function jy(s){var t=s.length,e=new s.constructor(t);return t&&typeof s[0]=="string"&&qy.call(s,"index")&&(e.index=s.index,e.input=s.input),e}var Gy=os.Uint8Array;const dc=Gy;function cl(s){var t=new s.constructor(s.byteLength);return new dc(t).set(new dc(s)),t}function Wy(s,t){var e=t?cl(s.buffer):s.buffer;return new s.constructor(e,s.byteOffset,s.byteLength)}var Jy=/\w*$/;function Ky(s){var t=new s.constructor(s.source,Jy.exec(s));return t.lastIndex=s.lastIndex,t}var Xh=dr?dr.prototype:void 0,Zh=Xh?Xh.valueOf:void 0;function zy(s){return Zh?Object(Zh.call(s)):{}}function ep(s,t){var e=t?cl(s.buffer):s.buffer;return new s.constructor(e,s.byteOffset,s.length)}var Yy="[object Boolean]",Qy="[object Date]",Xy="[object Map]",Zy="[object Number]",eS="[object RegExp]",tS="[object Set]",sS="[object String]",rS="[object Symbol]",nS="[object ArrayBuffer]",iS="[object DataView]",aS="[object Float32Array]",oS="[object Float64Array]",cS="[object Int8Array]",dS="[object Int16Array]",lS="[object Int32Array]",uS="[object Uint8Array]",hS="[object Uint8ClampedArray]",pS="[object Uint16Array]",mS="[object Uint32Array]";function fS(s,t,e){var r=s.constructor;switch(t){case nS:return cl(s);case Yy:case Qy:return new r(+s);case iS:return Wy(s,e);case aS:case oS:case cS:case dS:case lS:case uS:case hS:case pS:case mS:return ep(s,e);case Xy:return new r;case Zy:case sS:return new r(s);case eS:return Ky(s);case tS:return new r;case rS:return zy(s)}}var tp=Object.create,gS=function(){function s(){}return function(t){if(!cs(t))return{};if(tp)return tp(t);s.prototype=t;var e=new s;return s.prototype=void 0,e}}();const vS=gS;function sp(s){return typeof s.constructor=="function"&&!cc(s)?vS(sl(s)):{}}var TS="[object Map]";function yS(s){return ws(s)&&Yn(s)==TS}var rp=zn&&zn.isMap,SS=rp?Xd(rp):yS;const ES=SS;var _S="[object Set]";function bS(s){return ws(s)&&Yn(s)==_S}var np=zn&&zn.isSet,wS=np?Xd(np):bS;const PS=wS;var CS=1,RS=2,kS=4,ip="[object Arguments]",IS="[object Array]",AS="[object Boolean]",MS="[object Date]",DS="[object Error]",ap="[object Function]",OS="[object GeneratorFunction]",NS="[object Map]",LS="[object Number]",op="[object Object]",xS="[object RegExp]",VS="[object Set]",US="[object String]",FS="[object Symbol]",BS="[object WeakMap]",$S="[object ArrayBuffer]",HS="[object DataView]",qS="[object Float32Array]",jS="[object Float64Array]",GS="[object Int8Array]",WS="[object Int16Array]",JS="[object Int32Array]",KS="[object Uint8Array]",zS="[object Uint8ClampedArray]",YS="[object Uint16Array]",QS="[object Uint32Array]",ye={};ye[ip]=ye[IS]=ye[$S]=ye[HS]=ye[AS]=ye[MS]=ye[qS]=ye[jS]=ye[GS]=ye[WS]=ye[JS]=ye[NS]=ye[LS]=ye[op]=ye[xS]=ye[VS]=ye[US]=ye[FS]=ye[KS]=ye[zS]=ye[YS]=ye[QS]=!0,ye[DS]=ye[ap]=ye[BS]=!1;function lc(s,t,e,r,n,i){var a,c=t&CS,d=t&RS,l=t&kS;if(e&&(a=n?e(s,r,n,i):e(s)),a!==void 0)return a;if(!cs(s))return s;var h=lr(s);if(h){if(a=jy(s),!c)return $h(s,a)}else{var m=Yn(s),f=m==ap||m==OS;if(Kn(s))return Bh(s,c);if(m==op||m==ip||f&&!n){if(a=d||f?{}:sp(s),!c)return d?Ay(s,Sy(a,s)):Cy(s,fy(a,s))}else{if(!ye[m])return n?s:{};a=fS(s,m,c)}}i||(i=new bs);var y=i.get(s);if(y)return y;i.set(s,a),PS(s)?s.forEach(function(I){a.add(lc(I,t,e,I,s,i))}):ES(s)&&s.forEach(function(I,L){a.set(L,lc(I,t,e,L,s,i))});var _=l?d?My:rl:d?Sa:el,b=h?void 0:_(s);return vT(b||s,function(I,L){b&&(L=I,I=s[L]),bh(a,L,lc(I,t,e,L,s,i))}),a}var XS=1,ZS=4;function dl(s){return lc(s,XS|ZS)}var eE="[object Symbol]";function tE(s){return typeof s=="symbol"||ws(s)&&zr(s)==eE}var sE=Object.defineProperty,rE=(s,t)=>{for(var e in t)sE(s,e,{get:t[e],enumerable:!0})},nE={};rE(nE,{permissions:()=>iE,theme:()=>aE});var yt=(s=>(s.GroupCall="GROUP_CALL",s.Webinar="WEBINAR",s.AudioRoom="AUDIO_ROOM",s.Livestream="LIVESTREAM",s.Chat="CHAT",s))(yt||{}),G=(s=>(s.Allowed="ALLOWED",s.NotAllowed="NOT_ALLOWED",s.CanRequest="CAN_REQUEST",s))(G||{}),iE={view_type:"GROUP_CALL",accept_waiting_requests:!1,accept_present_requests:!1,request_produce:!1,can_allow_participant_audio:!1,can_allow_participant_screensharing:!1,can_allow_participant_video:!1,can_spotlight:!1,request_kick_participant:!1,kick_participant:!1,pin_participant:!1,can_edit_display_name:!1,can_record:!1,can_livestream:!1,can_present:!0,waiting_room_type:"SKIP_ON_ACCEPT",recorder_type:"NONE",plugins:{can_close:!0,can_start:!0},polls:{can_create:!0,can_vote:!0,can_view:!0},produce:{video:{allow:!0,quality:"vga",frame_rate:24},audio:!0,screenshare:{allow:!0,quality:"hd",frame_rate:5}},chat:{public:{can_send:!0,text:!0,files:!0},private:{can_send:!1,can_receive:!1,text:!1,files:!1}},connected_meetings:{can_alter_connected_meetings:!1,can_switch_connected_meetings:!1,can_switch_to_parent_meeting:!1},reactions:!1,hidden_participant:!1,is_recorder:!1,show_participant_list:!0,can_change_participant_role:!1,can_change_theme:!1,max_screenshare_count:1},aE={setup_screen:{is_enabled:!0},alone_here:{is_enabled:!0},waiting_room:{is_enabled:!1,enable_preview:!0},control_bar:{is_enabled:!0,elements:{plugins:!0,screenshare:!0,invite:!0,participants:!0,chat:!0,reactions:!1,polls:!0,fullscreen:!0,layout:!0}},header:{is_enabled:!0,elements:{timer:!0,title:!0,participant_count:!0,change_layout:!0}},pip_mode:!0,auto_tune:!0,grid:{multi:{maxVideoCount:6,videoFit:"cover"},single:{maxVideoCount:6,videoFit:"cover"},defaultView:"multi"},controls:{pip_toggle:!1}},cp="hXgU8Wc8pwuGNq9ms5q9Hh";typeof process!="undefined"&&(Kf=process==null?void 0:process.env)!=null&&Kf.FLAGSMITH_ENVIRONMENT_KEY&&(cp=process.env.FLAGSMITH_ENVIRONMENT_KEY);function oE(s=[]){const t={};return s.forEach(e=>{t[e.feature.name]={enabled:e.enabled,value:e.feature_state_value}}),t}var cE=class{constructor(s=cp){p(this,"flags",{});p(this,"environmentKey",null);this.environmentKey=s}async identifyAndFetchFlagsWithRetry({primaryEndpoint:s,secondaryEndpoint:t,forceEvaluate:e,timeout:r,uniqueIdentifier:n,traitsObj:i,logger:a}){var h;const c=JSON.parse(JSON.stringify(i)),d=Object.entries(c).map(m=>({trait_key:m[0],trait_value:m[1]})),l=[s,t,t];for(const m of l)try{const f=new AbortController,y=setTimeout(()=>f.abort(),r),_="_"+(Math.random()+1).toString(36).substring(2),b=await fetch(`https://${m}/api/v1/identities/`,{method:"POST",headers:{"Content-Type":"application/json","X-Environment-Key":this.environmentKey},body:JSON.stringify({identifier:n+(e?_:""),traits:d}),signal:f.signal});if(clearTimeout(y),!b.ok)throw new Error(`Request failed with status ${b.status}`);const I=await b.json();return oE(((h=I.data)==null?void 0:h.flags)||[])}catch(f){a.error("Flagsmith identify failed!!",{error:f,url:m})}return{}}async identify(s,t={},e=!1,r=5e3,n="edge.api.flagsmith.com",i=console){return this.flags=await this.identifyAndFetchFlagsWithRetry({traitsObj:t,uniqueIdentifier:s,forceEvaluate:e,timeout:r,primaryEndpoint:n,secondaryEndpoint:"edge.api.flagsmith.com",logger:i}),this.flags}getValue(s){return this.flags&&this.flags[s]&&this.flags[s].value}hasFeature(s){return this.flags&&this.flags[s]&&this.flags[s].enabled}getAllFlags(){return this.flags}},ee=new cE,dp=[-2,-1,0,1,2],dE=[0,1,2,3,4];function lE(s){s=s.trim();let t="0",e="0",r="0";return s.length==4?(t="0x"+s[1]+s[1],e="0x"+s[2]+s[2],r="0x"+s[3]+s[3]):s.length>6&&(t="0x"+s[1]+s[2],e="0x"+s[3]+s[4],r="0x"+s[5]+s[6]),[+t,+e,+r]}var uE=(s,t,e)=>{let r,n,i;if(t==0)r=n=i=e;else{const a=(l,h,m)=>(m<0&&(m+=1),m>1&&(m-=1),m<.16666666666666666?l+(h-l)*6*m:m<.5?h:m<.6666666666666666?l+(h-l)*(.6666666666666666-m)*6:l),c=e<.5?e*(1+t):e+t-e*t,d=2*e-c;r=a(d,c,s+1/3),n=a(d,c,s),i=a(d,c,s-1/3)}return[Math.round(r*255),Math.round(n*255),Math.round(i*255)]},hE=(s,t,e)=>{s/=255,t/=255,e/=255;const r=Math.max(s,t,e),n=Math.min(s,t,e);let i,a;const c=(r+n)/2;if(r==n)i=a=0;else{const d=r-n;switch(a=c>.5?d/(2-r-n):d/(r+n),r){case s:i=(t-e)/d+(t<e?6:0);break;case t:i=(e-s)/d+2;break;case e:i=(s-t)/d+4;break}i/=6}return[i,a,c]},pE=(s,t,e)=>{const r=n=>n.toString(16).padStart(2,"0");return`#${r(s)}${r(t)}${r(e)}`},lp=(s,t=dp,e=.4)=>{const r=[],[n,i,a]=lE(s),[c,d,l]=hE(n,i,a),h=Math.round(l*100);h>70?e=.8:h>60?e=.9:h<10?e=.075:h<42&&(e=.3);const m=t.findIndex(I=>I===0);if(m===-1)throw new Error("Invalid reducer provided, it must contain atleast one zero");const f=5-m,y=m+1,_=(100-h)/f,b=h/y;for(const I of t){let L;I<0?L=h+I*b*e:I>0?L=h+I*_*e:L=h;const[B,q,F]=uE(c,d,L/100);r.push(pE(B,q,F))}return r},up={dark:{background:{1e3:"#252525",900:"#2F2F2F",800:"#323232",700:"#3E3E3E",600:"#4A4A4A"},text:"#F5F5F5","video-bg":"#1C1C1C"},light:{background:{1e3:"#FFFFFF",900:"#F5F5F5",800:"#EBEBEB",700:"#E0E0E0",600:"#D6D6D6"},text:"#111111","text-on-brand":"#ffffff","video-bg":"#DADADA"}},mE=s=>{const[t,e,r,n,i]=lp(s,dp);return{300:t,400:e,500:r,600:n,700:i}},fE=s=>{if(s==="#FFFFFF")return up.light.background;if(s==="#000000")return up.dark.background;const[t,e,r,n,i]=lp(s,dE);return{1e3:t,900:e,800:r,700:n,600:i}},gE={border_radius:"rounded",border_width:"thin",spacing_base:4,theme:"dark",colors:{brand:mE("#2160FD"),background:fE("#141414"),danger:"#FF2D2D",text:"#EEEEEE",text_on_brand:"#EEEEEE",success:"#62A504",video_bg:"#191919",warning:"#FFCD07"}};function hp(){return dl(gE)}var vE={permissions:{can_accept_production_requests:!1,can_edit_display_name:!0,accept_waiting_requests:!1,disable_participant_audio:!1,disable_participant_screensharing:!1,disable_participant_video:!1,can_spotlight:!1,kick_participant:!1,pin_participant:!1,can_record:!1,can_livestream:!1,waiting_room_type:"SKIP",plugins:{can_close:!0,can_start:!0,can_edit_config:!1,config:{}},polls:{can_create:!0,can_vote:!0,can_view:!0},media:{video:{can_produce:"ALLOWED",can_consume:"ALLOWED"},audio:{can_produce:"ALLOWED"},screenshare:{can_produce:"ALLOWED",can_consume:"ALLOWED"}},chat:{public:{can_send:!0,text:!0,files:!0},private:{can_send:!1,can_receive:!1,text:!1,files:!1},channel:{can_create:"ALL",can_delete:"ALL",can_update:"ALL",can_read_all:!1},message:{can_delete:"ALL",can_edit:"ALL",delete_cutoff_time_seconds:0,edit_cutoff_time_seconds:0}},hidden_participant:!1,is_recorder:!1,recorder_type:"NONE",show_participant_list:!0,transcription_enabled:!1,can_change_participant_permissions:!1,connected_meetings:{can_alter_connected_meetings:!1,can_switch_connected_meetings:!1,can_switch_to_parent_meeting:!1},stage_enabled:!1,stage_access:void 0,accept_stage_requests:!1},ui:{oldTheme:{setup_screen:{is_enabled:!1},alone_here:{is_enabled:!1},waiting_room:{is_enabled:!1,enable_preview:!0},control_bar:{is_enabled:!0,elements:{plugins:!0,screenshare:!0,invite:!1,participants:!0,chat:!0,reactions:!1,polls:!0,fullscreen:!0,layout:!0}},header:{is_enabled:!0,elements:{timer:!0,title:!0,participant_count:!0,change_layout:!0}},pip_mode:!0,auto_tune:!0,colors:{primary:"#2160FD",secondary:"#1A1A1A",text:"#EEEEEE",background:"#1A1A1A",textPrimary:"#EEEEEE",videoBackground:"#1A1A1A"},dimensions:{mode:"fillParent"},grid:{multi:{maxVideoCount:6,videoFit:"cover"},single:{maxVideoCount:6,videoFit:"cover"},defaultView:"MULTI"},controls:{pip_toggle:!1},plugins:[]},design_tokens:hp(),config_diff:{}},config:{view_type:"GROUP_CALL",media:{audio:{enable_stereo:!1,enable_high_bitrate:!1},video:{quality:"vga",frame_rate:24},screenshare:{quality:"hd",frame_rate:5}},max_video_streams:{mobile:6,desktop:6},max_screenshare_count:1},version:"hybrid"};function TE(){return dl(vE)}var yE={permissions:{can_accept_production_requests:!1,can_edit_display_name:!0,accept_waiting_requests:!1,disable_participant_audio:!1,disable_participant_screensharing:!1,disable_participant_video:!1,can_spotlight:!1,kick_participant:!1,pin_participant:!1,can_record:!1,can_livestream:!1,waiting_room_type:"SKIP",plugins:{can_close:!0,can_start:!0,can_edit_config:!1,config:{}},polls:{can_create:!0,can_vote:!0,can_view:!0},media:{video:{can_produce:"ALLOWED"},audio:{can_produce:"ALLOWED"},screenshare:{can_produce:"ALLOWED"}},chat:{public:{can_send:!0,text:!0,files:!0},private:{can_send:!1,can_receive:!1,text:!1,files:!1}},hidden_participant:!1,is_recorder:!1,recorder_type:"NONE",show_participant_list:!0,transcription_enabled:!1,can_change_participant_permissions:!1,connected_meetings:{can_alter_connected_meetings:!1,can_switch_connected_meetings:!1,can_switch_to_parent_meeting:!1},stage_enabled:!1,stage_access:void 0,accept_stage_requests:!1},ui:{design_tokens:hp(),config_diff:{}},config:{view_type:"GROUP_CALL",media:{audio:{enable_stereo:!1,enable_high_bitrate:!1},video:{quality:"vga",frame_rate:24},screenshare:{quality:"hd",frame_rate:5}},max_video_streams:{mobile:6,desktop:6},max_screenshare_count:1},version:"2.0.0"};function ll(){return dl(yE)}var SE=/\s/;function EE(s){for(var t=s.length;t--&&SE.test(s.charAt(t)););return t}var _E=/^\s+/;function bE(s){return s&&s.slice(0,EE(s)+1).replace(_E,"")}var pp=0/0,wE=/^[-+]0x[0-9a-f]+$/i,PE=/^0b[01]+$/i,CE=/^0o[0-7]+$/i,RE=parseInt;function mp(s){if(typeof s=="number")return s;if(tE(s))return pp;if(cs(s)){var t=typeof s.valueOf=="function"?s.valueOf():s;s=cs(t)?t+"":t}if(typeof s!="string")return s===0?s:+s;s=bE(s);var e=PE.test(s);return e||CE.test(s)?RE(s.slice(2),e?2:8):wE.test(s)?pp:+s}function fp(s){return s}function kE(s,t,e){switch(e.length){case 0:return s.call(t);case 1:return s.call(t,e[0]);case 2:return s.call(t,e[0],e[1]);case 3:return s.call(t,e[0],e[1],e[2])}return s.apply(t,e)}var IE=800,AE=16,ME=Date.now;function DE(s){var t=0,e=0;return function(){var r=ME(),n=AE-(r-e);if(e=r,n>0){if(++t>=IE)return arguments[0]}else t=0;return s.apply(void 0,arguments)}}function OE(s){return function(){return s}}var NE=ic?function(s,t){return ic(s,"toString",{configurable:!0,enumerable:!1,value:OE(t),writable:!0})}:fp,LE=DE(NE);const xE=LE;var gp=Math.max;function VE(s,t,e){return t=gp(t===void 0?s.length-1:t,0),function(){for(var r=arguments,n=-1,i=gp(r.length-t,0),a=Array(i);++n<i;)a[n]=r[t+n];n=-1;for(var c=Array(t+1);++n<t;)c[n]=r[n];return c[t]=e(a),kE(s,this,c)}}function UE(s,t){return xE(VE(s,t,fp),s+"")}function FE(s,t,e){if(!cs(e))return!1;var r=typeof t;return(r=="number"?ya(e)&&Ih(t,e.length):r=="string"&&t in e)?pa(e[t],s):!1}function BE(s){return UE(function(t,e){var r=-1,n=e.length,i=n>1?e[n-1]:void 0,a=n>2?e[2]:void 0;for(i=s.length>3&&typeof i=="function"?(n--,i):void 0,a&&FE(e[0],e[1],a)&&(i=n<3?void 0:i,n=1),t=Object(t);++r<n;){var c=e[r];c&&s(t,c,r,i)}return t})}var $E="[object Object]",HE=Function.prototype,qE=Object.prototype,vp=HE.toString,jE=qE.hasOwnProperty,GE=vp.call(Object);function WE(s){if(!ws(s)||zr(s)!=$E)return!1;var t=sl(s);if(t===null)return!0;var e=jE.call(t,"constructor")&&t.constructor;return typeof e=="function"&&e instanceof e&&vp.call(e)==GE}var JE="__lodash_hash_undefined__";function KE(s){return this.__data__.set(s,JE),this}function zE(s){return this.__data__.has(s)}function uc(s){var t=-1,e=s==null?0:s.length;for(this.__data__=new Zr;++t<e;)this.add(s[t])}uc.prototype.add=uc.prototype.push=KE,uc.prototype.has=zE;function YE(s,t){for(var e=-1,r=s==null?0:s.length;++e<r;)if(t(s[e],e,s))return!0;return!1}function QE(s,t){return s.has(t)}var XE=1,ZE=2;function Tp(s,t,e,r,n,i){var a=e&XE,c=s.length,d=t.length;if(c!=d&&!(a&&d>c))return!1;var l=i.get(s),h=i.get(t);if(l&&h)return l==t&&h==s;var m=-1,f=!0,y=e&ZE?new uc:void 0;for(i.set(s,t),i.set(t,s);++m<c;){var _=s[m],b=t[m];if(r)var I=a?r(b,_,m,t,s,i):r(_,b,m,s,t,i);if(I!==void 0){if(I)continue;f=!1;break}if(y){if(!YE(t,function(L,B){if(!QE(y,B)&&(_===L||n(_,L,e,r,i)))return y.push(B)})){f=!1;break}}else if(!(_===b||n(_,b,e,r,i))){f=!1;break}}return i.delete(s),i.delete(t),f}function e_(s){var t=-1,e=Array(s.size);return s.forEach(function(r,n){e[++t]=[n,r]}),e}function t_(s){var t=-1,e=Array(s.size);return s.forEach(function(r){e[++t]=r}),e}var s_=1,r_=2,n_="[object Boolean]",i_="[object Date]",a_="[object Error]",o_="[object Map]",c_="[object Number]",d_="[object RegExp]",l_="[object Set]",u_="[object String]",h_="[object Symbol]",p_="[object ArrayBuffer]",m_="[object DataView]",yp=dr?dr.prototype:void 0,ul=yp?yp.valueOf:void 0;function f_(s,t,e,r,n,i,a){switch(e){case m_:if(s.byteLength!=t.byteLength||s.byteOffset!=t.byteOffset)return!1;s=s.buffer,t=t.buffer;case p_:return!(s.byteLength!=t.byteLength||!i(new dc(s),new dc(t)));case n_:case i_:case c_:return pa(+s,+t);case a_:return s.name==t.name&&s.message==t.message;case d_:case u_:return s==t+"";case o_:var c=e_;case l_:var d=r&s_;if(c||(c=t_),s.size!=t.size&&!d)return!1;var l=a.get(s);if(l)return l==t;r|=r_,a.set(s,t);var h=Tp(c(s),c(t),r,n,i,a);return a.delete(s),h;case h_:if(ul)return ul.call(s)==ul.call(t)}return!1}var g_=1,v_=Object.prototype,T_=v_.hasOwnProperty;function y_(s,t,e,r,n,i){var a=e&g_,c=rl(s),d=c.length,l=rl(t),h=l.length;if(d!=h&&!a)return!1;for(var m=d;m--;){var f=c[m];if(!(a?f in t:T_.call(t,f)))return!1}var y=i.get(s),_=i.get(t);if(y&&_)return y==t&&_==s;var b=!0;i.set(s,t),i.set(t,s);for(var I=a;++m<d;){f=c[m];var L=s[f],B=t[f];if(r)var q=a?r(B,L,f,t,s,i):r(L,B,f,s,t,i);if(!(q===void 0?L===B||n(L,B,e,r,i):q)){b=!1;break}I||(I=f=="constructor")}if(b&&!I){var F=s.constructor,X=t.constructor;F!=X&&"constructor"in s&&"constructor"in t&&!(typeof F=="function"&&F instanceof F&&typeof X=="function"&&X instanceof X)&&(b=!1)}return i.delete(s),i.delete(t),b}var S_=1,Sp="[object Arguments]",Ep="[object Array]",hc="[object Object]",E_=Object.prototype,_p=E_.hasOwnProperty;function __(s,t,e,r,n,i){var a=lr(s),c=lr(t),d=a?Ep:Yn(s),l=c?Ep:Yn(t);d=d==Sp?hc:d,l=l==Sp?hc:l;var h=d==hc,m=l==hc,f=d==l;if(f&&Kn(s)){if(!Kn(t))return!1;a=!0,h=!1}if(f&&!h)return i||(i=new bs),a||oc(s)?Tp(s,t,e,r,n,i):f_(s,t,d,e,r,n,i);if(!(e&S_)){var y=h&&_p.call(s,"__wrapped__"),_=m&&_p.call(t,"__wrapped__");if(y||_){var b=y?s.value():s,I=_?t.value():t;return i||(i=new bs),n(b,I,e,r,i)}}return f?(i||(i=new bs),y_(s,t,e,r,n,i)):!1}function bp(s,t,e,r,n){return s===t?!0:s==null||t==null||!ws(s)&&!ws(t)?s!==s&&t!==t:__(s,t,e,r,bp,n)}function b_(s){return function(t,e,r){for(var n=-1,i=Object(t),a=r(t),c=a.length;c--;){var d=a[s?c:++n];if(e(i[d],d,i)===!1)break}return t}}var w_=b_();const P_=w_;var C_=function(){return os.Date.now()};const hl=C_;var R_="Expected a function",k_=Math.max,I_=Math.min;function pc(s,t,e){var r,n,i,a,c,d,l=0,h=!1,m=!1,f=!0;if(typeof s!="function")throw new TypeError(R_);t=mp(t)||0,cs(e)&&(h=!!e.leading,m="maxWait"in e,i=m?k_(mp(e.maxWait)||0,t):i,f="trailing"in e?!!e.trailing:f);function y(ne){var ve=r,ct=n;return r=n=void 0,l=ne,a=s.apply(ct,ve),a}function _(ne){return l=ne,c=setTimeout(L,t),h?y(ne):a}function b(ne){var ve=ne-d,ct=ne-l,Ls=t-ve;return m?I_(Ls,i-ct):Ls}function I(ne){var ve=ne-d,ct=ne-l;return d===void 0||ve>=t||ve<0||m&&ct>=i}function L(){var ne=hl();if(I(ne))return B(ne);c=setTimeout(L,b(ne))}function B(ne){return c=void 0,f&&r?y(ne):(r=n=void 0,a)}function q(){c!==void 0&&clearTimeout(c),l=0,r=d=n=c=void 0}function F(){return c===void 0?a:B(hl())}function X(){var ne=hl(),ve=I(ne);if(r=arguments,n=this,d=ne,ve){if(c===void 0)return _(d);if(m)return clearTimeout(c),c=setTimeout(L,t),y(d)}return c===void 0&&(c=setTimeout(L,t)),a}return X.cancel=q,X.flush=F,X}function pl(s,t,e){(e!==void 0&&!pa(s[t],e)||e===void 0&&!(t in s))&&Qd(s,t,e)}function A_(s){return ws(s)&&ya(s)}function ml(s,t){if(!(t==="constructor"&&typeof s[t]=="function")&&t!="__proto__")return s[t]}function M_(s){return va(s,Sa(s))}function D_(s,t,e,r,n,i,a){var c=ml(s,e),d=ml(t,e),l=a.get(d);if(l){pl(s,e,l);return}var h=i?i(c,d,e+"",s,t,a):void 0,m=h===void 0;if(m){var f=lr(d),y=!f&&Kn(d),_=!f&&!y&&oc(d);h=d,f||y||_?lr(c)?h=c:A_(c)?h=$h(c):y?(m=!1,h=Bh(d,!0)):_?(m=!1,h=ep(d,!0)):h=[]:WE(d)||ac(d)?(h=c,ac(c)?h=M_(c):(!cs(c)||zd(c))&&(h=sp(d))):m=!1}m&&(a.set(d,h),n(h,d,r,i,a),a.delete(d)),pl(s,e,h)}function wp(s,t,e,r,n){s!==t&&P_(t,function(i,a){if(n||(n=new bs),cs(i))D_(s,t,a,e,wp,r,n);else{var c=r?r(ml(s,a),i,a+"",s,t,n):void 0;c===void 0&&(c=i),pl(s,a,c)}},Sa)}var O_="[object Map]",N_="[object Set]",L_=Object.prototype,x_=L_.hasOwnProperty;function V_(s){if(s==null)return!0;if(ya(s)&&(lr(s)||typeof s=="string"||typeof s.splice=="function"||Kn(s)||oc(s)||ac(s)))return!s.length;var t=Yn(s);if(t==O_||t==N_)return!s.size;if(cc(s))return!Lh(s).length;for(var e in s)if(x_.call(s,e))return!1;return!0}function U_(s,t){return bp(s,t)}var F_=BE(function(s,t,e){wp(s,t,e)});const ur=F_;var fl=(s=>(s.PARTICIPANT="PARTICIPANT",s.PEER="PEER",s.CLIENT="CLIENT",s))(fl||{});const se={PROPAGATE_KICK_ALL:"propagate_kick_across_rooms",REFRESH_ID_ON_DISCONNECTION:"refresh_id_on_disconnection",SIMULCAST:"simulcast",CHAT_SOCKET_SERVER:"chat_socket_server",POLL_SOCKET_SERVER:"poll_socket_server",PLUGIN_SOCKET_SERVER:"plugin_socket_server",NR_OTEL_WEB:"nr_otel_web",ICE_RESTART_ON_FAILED_STATE:"ice_restart_on_failed_state",ICE_RESTART_ON_DISCONNECTED_STATE:"ice_restart_on_disconnected_state",ENABLE_ICE_STATE_LOGGING:"enable_ice_state_logging",SUPPRESS_PEER_MUTE_UNMUTE_EMITS:"web_core_suppress_peer_mute_unmute_emits",SKIP_OTEL_TRACES:"skip_otel_traces",USE_USERIDS_IN_CHAT:"use_userids_in_chat",CUSTOM_PING_PONG:"custom_ping_pong",ENABLE_HIVE_SIMULCAST:"enable_hive_simulcast",ENABLE_HIVE_TRANSPORT_RECONNECTION_ON_ICE_FAILED:"enable_hive_transport_reconnection_on_ice_failed",ENABLE_HIVE_EXPERIMENTAL_FAIL_RECOVERY:"enable_hive_fail_recovery",ENABLE_HIVE_INFINITE_RETRIES:"enable_hive_infinite_retries",HIVE_TRANSPORT_FORCE_RELAY_ON_ICE_FAILED:"hive_transport_force_relay_on_ice_failed",ENABLE_HIVE_CONSUME_OVER_DC:"enable_hive_consume_over_dc",ENABLE_CF_SIMULCAST:"enable_cf_simulcast",ENABLE_CF_TRANSPORT_RECONNECTION_ON_ICE_FAILED:"enable_cf_transport_reconnection_on_ice_failed",ENABLE_CF_EXPERIMENTAL_FAIL_RECOVERY:"enable_cf_fail_recovery",ENABLE_CF_INFINITE_RETRIES:"enable_cf_infinite_retries",CF_TRANSPORT_FORCE_RELAY_ON_ICE_FAILED:"cf_transport_force_relay_on_ice_failed",BYPASS_LOG_EXCLUSION_LIST:"bypass_log_exclusion_list",LOG_LEVEL:"log_level",V1_PLUGINS:"v1_plugins",SCREENSHARE_DTX:"screenshare_dtx",SCREENSHARE_PRIORITY:"screenshare_priority",SCREENSHARE_MIN_BITRATE:"screenshare_minbitrate",SCREENSHARE_SIMULCAST:"screenshare_simulcast",DISABLE_WEBCAM_LAYERS_ON_SCREENSHARE:"disable_webcam_layers_on_screenshare",SCREENSHARE_FORCE_GOOG_CONFERENCE:"screenshare_force_goog_conference",LIVESTREAM:"feat_livestream",FETCH_RETRY:"fetch_retry",DISABLE_WEBCAM_SIMULCAST:"webcore_disable_webcam_simulcast",OVERRIDE_WEBCAM_SIMULCAST:"override_webcam_simulcast",SOCKET_POLLING:"socket_polling",FEAT_PAGINATED_CHAT:"feat_paginated_chat",VAL_MIN_FRAMERATE:"val_min_framerate",SCREEENSHARE_ERR_HACK:"screenshare_err_hack",SCREEENSHARE_CONSTRAINTS_RETRY:"screenshare_constraints_retry",TROUBLESHOOTING:"feat_troubleshooting",VIDEO_CONSTRAINTS:"video_constraints",SCREENSHARE_CONSTRAINTS:"screenshare_constraints",FEAT_CHAT_SDK:"feat_chat_sdk",FEAT_CHAT_SDK_SEARCH:"chat_search",OBS_QUALITY:"obs_quality",ALLOW_SAFARI_MEDIA_MIDDLEWARES:"allow_safari_media_middlewares",DYNAMIC_VIDEO_QUALITY:"dynamic_video_quality",EXP_RESHARE:"exp_reshare",LEAVE_STAGE_ON_END:"leave_stage_on_end",SKIP_SETTING_IN_USE_DEVICE:"skip_setting_in_use_device",PRECALL_BANDWIDTH_TEST:"precall_bandwidth_test",CONSUMER_BIND_NO_RETRY:"consumer_bind_no_retry",DEBUG_SOCKET_JOIN:"debug_socket_join",FORCE_RELAY:"force_relay",FORCE_VIDEO_CODEC:"force_video_codec",USE_EXPERIMENTAL_SFU_HANDLER:"use_experimental_sfu_handler",TRACK_HINT:"track_hint",OVERRIDE_HIVE_SIMULCAST_DYNAMIC:"override_hive_simulcast_dynamic",PRECREATE_PRODUCERS:"precreate_producers"};function mc(s){const t={};return typeof(s==null?void 0:s.code)=="number"&&(t.code=s.code),typeof(s==null?void 0:s.code)=="string"&&(t.code=s.code.substring(0,100)),typeof(s==null?void 0:s.name)=="string"&&(t.name=s.name.substring(0,500)),typeof(s==null?void 0:s.message)=="string"&&(t.message=s.message.substring(0,500)),typeof(s==null?void 0:s.reason)=="string"&&(t.reason=s.reason.substring(0,500)),typeof(s==null?void 0:s.stack)=="string"&&(t.stack=s.stack.substring(0,500)),t}function Pp(s){var r,n,i,a;const t=typeof navigator!="undefined"&&!navigator.isReactNative&&typeof window!="undefined"&&((r=window.location.host)==null?void 0:r.includes("devel"))&&((n=window.location.host)==null?void 0:n.includes("dyte.io")),e=!!((a=(i=s==null?void 0:s.getValue("modules"))==null?void 0:i.devTools)!=null&&a.logs);return t||e}function B_(s){var t;if(ee.hasFeature(se.LOG_LEVEL)){let e=((t=ee.getValue(se.LOG_LEVEL))==null?void 0:t.toString())||"all";if(e=e.toLowerCase().trim(),e==="off")return!1;if(e!=="all"){const r=["debug","log","info","warn","error"],n=r.indexOf(s),i=r.indexOf(e);if(n<i)return!1}}return!0}function Cp(s,t,e={}){return Object.getOwnPropertyNames(s).forEach(r=>{var i;if([null,void 0,NaN].includes(s[r])||t&&(((i=t.match(/\./g))==null?void 0:i.length)||0)>=10)return;const n=t?`${t}.${r}`:r;typeof s[r]=="object"?Cp(s[r],n,e):["number","string","boolean"].includes(typeof s[r])&&(e[n]=s[r])}),e}function Rp(s,t,e={},r=""){const n={};try{const i=JSON.stringify(e),a=JSON.parse(i),c=Cp(a,r),d=JSON.stringify(c);if(d.length>5e3){const l=`Log named: "${t}" is trying to log an flattened object of size
${d.length} chars that is beyond permitted limit of 5000 chars. Please optimize.`;throw Pp(s)&&console.error(l,{log:e,flattened:d}),new Error(l)}return JSON.parse(d)}catch(i){const a=mc(i);n[`${r}.error.message`]=a.message||"",n[`${r}.error.stack`]=a.stack||"",n[`${r}.error.reason`]=a.reason||"",n[`${r}.error.source`]="safelyFlattenObjForOpenTelemetry"}return n}const $_={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},kp={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},Ue={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},St={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},hr={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"};class D{static getFirstMatch(t,e){const r=e.match(t);return r&&r.length>0&&r[1]||""}static getSecondMatch(t,e){const r=e.match(t);return r&&r.length>1&&r[2]||""}static matchAndReturnConst(t,e,r){if(t.test(e))return r}static getWindowsVersionName(t){switch(t){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}static getMacOSVersionName(t){const e=t.split(".").splice(0,2).map(r=>parseInt(r,10)||0);if(e.push(0),e[0]===10)switch(e[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}}static getAndroidVersionName(t){const e=t.split(".").splice(0,2).map(r=>parseInt(r,10)||0);if(e.push(0),!(e[0]===1&&e[1]<5)){if(e[0]===1&&e[1]<6)return"Cupcake";if(e[0]===1&&e[1]>=6)return"Donut";if(e[0]===2&&e[1]<2)return"Eclair";if(e[0]===2&&e[1]===2)return"Froyo";if(e[0]===2&&e[1]>2)return"Gingerbread";if(e[0]===3)return"Honeycomb";if(e[0]===4&&e[1]<1)return"Ice Cream Sandwich";if(e[0]===4&&e[1]<4)return"Jelly Bean";if(e[0]===4&&e[1]>=4)return"KitKat";if(e[0]===5)return"Lollipop";if(e[0]===6)return"Marshmallow";if(e[0]===7)return"Nougat";if(e[0]===8)return"Oreo";if(e[0]===9)return"Pie"}}static getVersionPrecision(t){return t.split(".").length}static compareVersions(t,e,r=!1){const n=D.getVersionPrecision(t),i=D.getVersionPrecision(e);let a=Math.max(n,i),c=0;const d=D.map([t,e],l=>{const h=a-D.getVersionPrecision(l),m=l+new Array(h+1).join(".0");return D.map(m.split("."),f=>new Array(20-f.length).join("0")+f).reverse()});for(r&&(c=a-Math.min(n,i)),a-=1;a>=c;){if(d[0][a]>d[1][a])return 1;if(d[0][a]===d[1][a]){if(a===c)return 0;a-=1}else if(d[0][a]<d[1][a])return-1}}static map(t,e){const r=[];let n;if(Array.prototype.map)return Array.prototype.map.call(t,e);for(n=0;n<t.length;n+=1)r.push(e(t[n]));return r}static find(t,e){let r,n;if(Array.prototype.find)return Array.prototype.find.call(t,e);for(r=0,n=t.length;r<n;r+=1){const i=t[r];if(e(i,r))return i}}static assign(t,...e){const r=t;let n,i;if(Object.assign)return Object.assign(t,...e);for(n=0,i=e.length;n<i;n+=1){const a=e[n];typeof a=="object"&&a!==null&&Object.keys(a).forEach(d=>{r[d]=a[d]})}return t}static getBrowserAlias(t){return $_[t]}static getBrowserTypeByAlias(t){return kp[t]||""}}const me=/version\/(\d+(\.?_?\d+)+)/i,H_=[{test:[/googlebot/i],describe(s){const t={name:"Googlebot"},e=D.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/opera/i],describe(s){const t={name:"Opera"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/opr\/|opios/i],describe(s){const t={name:"Opera"},e=D.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/SamsungBrowser/i],describe(s){const t={name:"Samsung Internet for Android"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/Whale/i],describe(s){const t={name:"NAVER Whale Browser"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/MZBrowser/i],describe(s){const t={name:"MZ Browser"},e=D.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/focus/i],describe(s){const t={name:"Focus"},e=D.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/swing/i],describe(s){const t={name:"Swing"},e=D.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/coast/i],describe(s){const t={name:"Opera Coast"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe(s){const t={name:"Opera Touch"},e=D.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/yabrowser/i],describe(s){const t={name:"Yandex Browser"},e=D.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/ucbrowser/i],describe(s){const t={name:"UC Browser"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/Maxthon|mxios/i],describe(s){const t={name:"Maxthon"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/epiphany/i],describe(s){const t={name:"Epiphany"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/puffin/i],describe(s){const t={name:"Puffin"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/sleipnir/i],describe(s){const t={name:"Sleipnir"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/k-meleon/i],describe(s){const t={name:"K-Meleon"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/micromessenger/i],describe(s){const t={name:"WeChat"},e=D.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/qqbrowser/i],describe(s){const t={name:/qqbrowserlite/i.test(s)?"QQ Browser Lite":"QQ Browser"},e=D.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/msie|trident/i],describe(s){const t={name:"Internet Explorer"},e=D.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/\sedg\//i],describe(s){const t={name:"Microsoft Edge"},e=D.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/edg([ea]|ios)/i],describe(s){const t={name:"Microsoft Edge"},e=D.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/vivaldi/i],describe(s){const t={name:"Vivaldi"},e=D.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/seamonkey/i],describe(s){const t={name:"SeaMonkey"},e=D.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/sailfish/i],describe(s){const t={name:"Sailfish"},e=D.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,s);return e&&(t.version=e),t}},{test:[/silk/i],describe(s){const t={name:"Amazon Silk"},e=D.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/phantom/i],describe(s){const t={name:"PhantomJS"},e=D.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/slimerjs/i],describe(s){const t={name:"SlimerJS"},e=D.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(s){const t={name:"BlackBerry"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/(web|hpw)[o0]s/i],describe(s){const t={name:"WebOS Browser"},e=D.getFirstMatch(me,s)||D.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/bada/i],describe(s){const t={name:"Bada"},e=D.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/tizen/i],describe(s){const t={name:"Tizen"},e=D.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/qupzilla/i],describe(s){const t={name:"QupZilla"},e=D.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/firefox|iceweasel|fxios/i],describe(s){const t={name:"Firefox"},e=D.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/electron/i],describe(s){const t={name:"Electron"},e=D.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/MiuiBrowser/i],describe(s){const t={name:"Miui"},e=D.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/chromium/i],describe(s){const t={name:"Chromium"},e=D.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,s)||D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/chrome|crios|crmo/i],describe(s){const t={name:"Chrome"},e=D.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/GSA/i],describe(s){const t={name:"Google Search"},e=D.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test(s){const t=!s.test(/like android/i),e=s.test(/android/i);return t&&e},describe(s){const t={name:"Android Browser"},e=D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/playstation 4/i],describe(s){const t={name:"PlayStation 4"},e=D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/safari|applewebkit/i],describe(s){const t={name:"Safari"},e=D.getFirstMatch(me,s);return e&&(t.version=e),t}},{test:[/.*/i],describe(s){const t=/^(.*)\/(.*) /,e=/^(.*)\/(.*)[ \t]\((.*)/,n=s.search("\\(")!==-1?e:t;return{name:D.getFirstMatch(n,s),version:D.getSecondMatch(n,s)}}}],q_=[{test:[/Roku\/DVP/],describe(s){const t=D.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,s);return{name:St.Roku,version:t}}},{test:[/windows phone/i],describe(s){const t=D.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,s);return{name:St.WindowsPhone,version:t}}},{test:[/windows /i],describe(s){const t=D.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,s),e=D.getWindowsVersionName(t);return{name:St.Windows,version:t,versionName:e}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(s){const t={name:St.iOS},e=D.getSecondMatch(/(Version\/)(\d[\d.]+)/,s);return e&&(t.version=e),t}},{test:[/macintosh/i],describe(s){const t=D.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,s).replace(/[_\s]/g,"."),e=D.getMacOSVersionName(t),r={name:St.MacOS,version:t};return e&&(r.versionName=e),r}},{test:[/(ipod|iphone|ipad)/i],describe(s){const t=D.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,s).replace(/[_\s]/g,".");return{name:St.iOS,version:t}}},{test(s){const t=!s.test(/like android/i),e=s.test(/android/i);return t&&e},describe(s){const t=D.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,s),e=D.getAndroidVersionName(t),r={name:St.Android,version:t};return e&&(r.versionName=e),r}},{test:[/(web|hpw)[o0]s/i],describe(s){const t=D.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,s),e={name:St.WebOS};return t&&t.length&&(e.version=t),e}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(s){const t=D.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,s)||D.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,s)||D.getFirstMatch(/\bbb(\d+)/i,s);return{name:St.BlackBerry,version:t}}},{test:[/bada/i],describe(s){const t=D.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,s);return{name:St.Bada,version:t}}},{test:[/tizen/i],describe(s){const t=D.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,s);return{name:St.Tizen,version:t}}},{test:[/linux/i],describe(){return{name:St.Linux}}},{test:[/CrOS/],describe(){return{name:St.ChromeOS}}},{test:[/PlayStation 4/],describe(s){const t=D.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,s);return{name:St.PlayStation4,version:t}}}],j_=[{test:[/googlebot/i],describe(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe(s){const t=D.getFirstMatch(/(can-l01)/i,s)&&"Nova",e={type:Ue.mobile,vendor:"Huawei"};return t&&(e.model=t),e}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe(){return{type:Ue.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe(){return{type:Ue.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(){return{type:Ue.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe(){return{type:Ue.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe(){return{type:Ue.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe(){return{type:Ue.tablet}}},{test(s){const t=s.test(/ipod|iphone/i),e=s.test(/like (ipod|iphone)/i);return t&&!e},describe(s){const t=D.getFirstMatch(/(ipod|iphone)/i,s);return{type:Ue.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe(){return{type:Ue.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe(){return{type:Ue.mobile}}},{test(s){return s.getBrowserName(!0)==="blackberry"},describe(){return{type:Ue.mobile,vendor:"BlackBerry"}}},{test(s){return s.getBrowserName(!0)==="bada"},describe(){return{type:Ue.mobile}}},{test(s){return s.getBrowserName()==="windows phone"},describe(){return{type:Ue.mobile,vendor:"Microsoft"}}},{test(s){const t=Number(String(s.getOSVersion()).split(".")[0]);return s.getOSName(!0)==="android"&&t>=3},describe(){return{type:Ue.tablet}}},{test(s){return s.getOSName(!0)==="android"},describe(){return{type:Ue.mobile}}},{test(s){return s.getOSName(!0)==="macos"},describe(){return{type:Ue.desktop,vendor:"Apple"}}},{test(s){return s.getOSName(!0)==="windows"},describe(){return{type:Ue.desktop}}},{test(s){return s.getOSName(!0)==="linux"},describe(){return{type:Ue.desktop}}},{test(s){return s.getOSName(!0)==="playstation 4"},describe(){return{type:Ue.tv}}},{test(s){return s.getOSName(!0)==="roku"},describe(){return{type:Ue.tv}}}],G_=[{test(s){return s.getBrowserName(!0)==="microsoft edge"},describe(s){if(/\sedg\//i.test(s))return{name:hr.Blink};const e=D.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,s);return{name:hr.EdgeHTML,version:e}}},{test:[/trident/i],describe(s){const t={name:hr.Trident},e=D.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test(s){return s.test(/presto/i)},describe(s){const t={name:hr.Presto},e=D.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test(s){const t=s.test(/gecko/i),e=s.test(/like gecko/i);return t&&!e},describe(s){const t={name:hr.Gecko},e=D.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/(apple)?webkit\/537\.36/i],describe(){return{name:hr.Blink}}},{test:[/(apple)?webkit/i],describe(s){const t={name:hr.WebKit},e=D.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}}];class Ip{constructor(t,e=!1){if(t==null||t==="")throw new Error("UserAgent parameter can't be empty");this._ua=t,this.parsedResult={},e!==!0&&this.parse()}getUA(){return this._ua}test(t){return t.test(this._ua)}parseBrowser(){this.parsedResult.browser={};const t=D.find(H_,e=>{if(typeof e.test=="function")return e.test(this);if(e.test instanceof Array)return e.test.some(r=>this.test(r));throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.browser=t.describe(this.getUA())),this.parsedResult.browser}getBrowser(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()}getBrowserName(t){return t?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""}getBrowserVersion(){return this.getBrowser().version}getOS(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()}parseOS(){this.parsedResult.os={};const t=D.find(q_,e=>{if(typeof e.test=="function")return e.test(this);if(e.test instanceof Array)return e.test.some(r=>this.test(r));throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.os=t.describe(this.getUA())),this.parsedResult.os}getOSName(t){const{name:e}=this.getOS();return t?String(e).toLowerCase()||"":e||""}getOSVersion(){return this.getOS().version}getPlatform(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()}getPlatformType(t=!1){const{type:e}=this.getPlatform();return t?String(e).toLowerCase()||"":e||""}parsePlatform(){this.parsedResult.platform={};const t=D.find(j_,e=>{if(typeof e.test=="function")return e.test(this);if(e.test instanceof Array)return e.test.some(r=>this.test(r));throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.platform=t.describe(this.getUA())),this.parsedResult.platform}getEngine(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()}getEngineName(t){return t?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""}parseEngine(){this.parsedResult.engine={};const t=D.find(G_,e=>{if(typeof e.test=="function")return e.test(this);if(e.test instanceof Array)return e.test.some(r=>this.test(r));throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.engine=t.describe(this.getUA())),this.parsedResult.engine}parse(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this}getResult(){return D.assign({},this.parsedResult)}satisfies(t){const e={};let r=0;const n={};let i=0;if(Object.keys(t).forEach(c=>{const d=t[c];typeof d=="string"?(n[c]=d,i+=1):typeof d=="object"&&(e[c]=d,r+=1)}),r>0){const c=Object.keys(e),d=D.find(c,h=>this.isOS(h));if(d){const h=this.satisfies(e[d]);if(h!==void 0)return h}const l=D.find(c,h=>this.isPlatform(h));if(l){const h=this.satisfies(e[l]);if(h!==void 0)return h}}if(i>0){const c=Object.keys(n),d=D.find(c,l=>this.isBrowser(l,!0));if(d!==void 0)return this.compareVersion(n[d])}}isBrowser(t,e=!1){const r=this.getBrowserName().toLowerCase();let n=t.toLowerCase();const i=D.getBrowserTypeByAlias(n);return e&&i&&(n=i.toLowerCase()),n===r}compareVersion(t){let e=[0],r=t,n=!1;const i=this.getBrowserVersion();if(typeof i=="string")return t[0]===">"||t[0]==="<"?(r=t.substr(1),t[1]==="="?(n=!0,r=t.substr(2)):e=[],t[0]===">"?e.push(1):e.push(-1)):t[0]==="="?r=t.substr(1):t[0]==="~"&&(n=!0,r=t.substr(1)),e.indexOf(D.compareVersions(i,r,n))>-1}isOS(t){return this.getOSName(!0)===String(t).toLowerCase()}isPlatform(t){return this.getPlatformType(!0)===String(t).toLowerCase()}isEngine(t){return this.getEngineName(!0)===String(t).toLowerCase()}is(t,e=!1){return this.isBrowser(t,e)||this.isOS(t)||this.isPlatform(t)}some(t=[]){return t.some(e=>this.is(e))}}/*!
 * Bowser - a browser detector
 * https://github.com/lancedikson/bowser
 * MIT License | (c) Dustin Diaz 2012-2015
 * MIT License | (c) Denis Demchenko 2015-2019
 */class Ap{static getParser(t,e=!1){if(typeof t!="string")throw new Error("UserAgent should be a string");return new Ip(t,e)}static parse(t){return new Ip(t).getResult()}static get BROWSER_MAP(){return kp}static get ENGINE_MAP(){return hr}static get OS_MAP(){return St}static get PLATFORMS_MAP(){return Ue}}const Ea="chrome",Mp="opera",Dp="firefox",Op="iexplorer",Np="safari",Lp="nwjs",xp="electron",Vp="react-native",gl="unknown",fc={Chrome:Ea,Chromium:Ea,Opera:Mp,Firefox:Dp,"Internet Explorer":Op,Safari:Np};function W_(){const{userAgent:s}=navigator,t={name:gl,version:void 0};if(s.match(/Chrome/)&&!s.match(/Edge/))if(s.match(/Edg(A?)/)){const e=s.match(/Chrome\/([\d.]+)/)[1];Number.parseInt(e,10)>72&&(t.name=Ea,t.version=e)}else t.name=Ea,t.version=s.match(/Chrome\/([\d.]+)/)[1];return t}function J_(){const{userAgent:s}=navigator;if(s.match(/Electron/)){const t=s.match(/Electron\/([\d.]+)/)[1];return{name:xp,version:t}}return null}function K_(){const{userAgent:s}=navigator;if(s.match(/JitsiMeetNW/)){const t=s.match(/JitsiMeetNW\/([\d.]+)/)[1];return{name:Lp,version:t}}}function z_(){const s=navigator.userAgent.match(/\b(react[ \t_-]*native)(?:\/(\S+))?/i);let t;if(s||navigator.product==="ReactNative")return s&&s.length>2&&(s[1],t=s[2]),t||(t="unknown"),{name:Vp,version:t}}function Y_(s){let t;const e=[z_,J_,K_];for(let n=0;n<e.length;n+=1)if(t=e[n](),t)return t;const r=s.getBrowserName();return r in fc?{name:fc[r],version:s.getBrowserVersion()}:(t=W_(),t||{name:gl,version:void 0})}class Q_{constructor(){p(this,"_bowser");p(this,"_name");p(this,"_version");p(this,"getDeviceInfo",()=>({isMobile:this.isMobile(),browserName:this._bowser.getBrowserName(),osName:this._bowser.getOSName(),browserVersion:this._bowser.getBrowserVersion(),osVersionName:this._bowser.getOSVersion(),engineName:this._bowser.getEngineName()}))}init(t){let e,r;if(this._bowser=Ap.getParser(navigator.userAgent),typeof t=="undefined"){const n=Y_(this._bowser);e=n.name,r=n.version}else t.name in fc?(e=fc[t.name],r=t.version):(e=gl,r=void 0);this._name=e,this._version=r}getName(){return this._name}isChrome(){return this._name===Ea}isOpera(){return this._name===Mp}isFirefox(){return this._name===Dp}isIExplorer(){return this._name===Op}isSafari(){return this._name===Np}isNWJS(){return this._name===Lp}isElectron(){return this._name===xp}isReactNative(){return this._name===Vp||navigator.isReactNative===!0}getVersion(){return this._version}isMobile(){return this._bowser.getPlatformType()==="mobile"}_checkCondition(t){if(this._version)return this._bowser.satisfies(t)}isVersionGreaterThan(t){return this._checkCondition({[this._name]:`>${t}`})}isVersionLessThan(t){return this._checkCondition({[this._name]:`<${t}`})}isVersionEqualTo(t){return this._checkCondition({[this._name]:`~${t}`})}}class X_ extends Q_{doesVideoMuteByStreamRemove(){return this.isChromiumBased()||this.isWebKitBased()}supportsP2P(){return!this.usesUnifiedPlan()}isChromiumBased(){return this.isChrome()||this.isElectron()||this.isNWJS()||this.isOpera()}isWebKitBased(){return this._bowser.isEngine("webkit")&&typeof navigator.mediaDevices!="undefined"&&typeof navigator.mediaDevices.getUserMedia!="undefined"&&typeof window.RTCRtpTransceiver!="undefined"&&Object.keys(RTCRtpTransceiver.prototype).indexOf("currentDirection")>-1}isSupported(){return typeof RTCPeerConnection!="undefined"}isUserInteractionRequiredForUnmute(){return this.isFirefox()&&this.isVersionLessThan("68")}supportsVideoMuteOnConnInterrupted(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}supportsBandwidthStatistics(){return!this.isFirefox()&&!this.isWebKitBased()}supportsCodecPreferences(){return this.usesUnifiedPlan()&&typeof window.RTCRtpTransceiver!="undefined"&&Object.keys(window.RTCRtpTransceiver.prototype).indexOf("setCodecPreferences")>-1&&Object.keys(RTCRtpSender.prototype).indexOf("getCapabilities")>-1&&!this.isWebKitBased()}supportsDeviceChangeEvent(){return navigator.mediaDevices&&typeof navigator.mediaDevices.ondevicechange!="undefined"&&typeof navigator.mediaDevices.addEventListener!="undefined"}supportsLocalCandidateRttStatistics(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}supportsPerformanceObserver(){return typeof window.PerformanceObserver!="undefined"&&PerformanceObserver.supportedEntryTypes.indexOf("longtask")>-1}supportsReceiverStats(){return typeof window.RTCRtpReceiver!="undefined"&&Object.keys(RTCRtpReceiver.prototype).indexOf("getSynchronizationSources")>-1}supportsRTTStatistics(){return!this.isFirefox()}usesPlanB(){return!this.usesUnifiedPlan()}usesSdpMungingForSimulcast(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}usesUnifiedPlan(){return!!(this.isFirefox()||this.isWebKitBased())}usesNewGumFlow(){return!!(this.isChromiumBased()||this.isFirefox()||this.isWebKitBased())}usesAdapter(){return this.usesNewGumFlow()}usesRidsForSimulcast(){return!1}supportsGetDisplayMedia(){return typeof navigator.getDisplayMedia!="undefined"||typeof navigator.mediaDevices!="undefined"&&typeof navigator.mediaDevices.getDisplayMedia!="undefined"}supportsInsertableStreams(){if(!(typeof window.RTCRtpSender!="undefined"&&(window.RTCRtpSender.prototype.createEncodedStreams||window.RTCRtpSender.prototype.createEncodedVideoStreams)))return!1;const t=new ReadableStream;try{return window.postMessage(t,"*",[t]),!0}catch(e){return!1}}supportsAudioRed(){return Boolean(window.RTCRtpSender&&window.RTCRtpSender.getCapabilities&&window.RTCRtpSender.getCapabilities("audio").codecs.some(t=>t.mimeType==="audio/red")&&window.RTCRtpReceiver&&window.RTCRtpReceiver.getCapabilities&&window.RTCRtpReceiver.getCapabilities("audio").codecs.some(t=>t.mimeType==="audio/red"))}supportsSdpSemantics(){return this.isChromiumBased()}_getChromiumBasedVersion(){if(this.isChromiumBased()){if(this.isNWJS())return Number.parseInt(process.versions.chromium,10);const t=navigator.userAgent;if(t.match(/Chrome/))return Number.parseInt(t.match(/Chrome\/([\d.]+)/)[1],10)}return-1}isIOSMobile(){return this.isMobile&&this._bowser.getOSName()==="iOS"}}const be=new X_,Z_={audio:!0,video:!0,screenshareAudio:!0,screenshareVideo:!0},_a={baseURL:"http://localhost:5000",createdAt:"2021-08-05T10:49:56.602Z",description:"Develop plugins locally",id:"09259e3b-7be8-46f6-9801-106bf1866e1c",name:"Localhost Dev",organizationId:"4ad15a19-80e2-4105-bf43-48039fd2963e",picture:"https://dyte-uploads.s3.ap-south-1.amazonaws.com/dyte.png",private:!1,published:!0,staggered:!1,tags:["#localhost","#dev"],type:"self_hosted",updatedAt:"2021-08-05T10:50:07.681Z"},eb={pip:!0,poll:!0,chat:!0,stage:!0,theme:!0,plugin:!0,tracing:!0,internals:!0,recording:!0,livestream:!0,participant:!0,devTools:{logs:!1}};function gc(s,t){const e=s.getValue("overrides");return e&&e[t]?e[t]:!1}function tb({baseURI:s}){return s!=null&&s.includes("preprod.dyte")?ha.PREPROD:s!=null&&s.includes("devel.dyte")?ha.DEVEL:ha.PROD}function Qn({servicePrefix:s,baseURI:t}){return`${s}.${t}`}function Up(s){const t=s.getValue("baseURI");return{location:Qn({servicePrefix:"location",baseURI:t}),locationLegacy:Qn({servicePrefix:"location-legacy",baseURI:t}),daCollector:Qn({servicePrefix:"da-collector",baseURI:t})}}const sb='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m16.242 2.932 4.826 4.826a2.75 2.75 0 0 1-.715 4.404l-4.87 2.435a.75.75 0 0 0-.374.426l-1.44 4.166a1.25 1.25 0 0 1-2.065.476L8.5 16.561 4.06 21H3v-1.06l4.44-4.44-3.105-3.104a1.25 1.25 0 0 1 .476-2.066l4.166-1.44a.75.75 0 0 0 .426-.373l2.435-4.87a2.75 2.75 0 0 1 4.405-.715Zm3.766 5.886-4.826-4.826a1.25 1.25 0 0 0-2.002.325l-2.435 4.871a2.25 2.25 0 0 1-1.278 1.12l-3.789 1.31 6.705 6.704 1.308-3.789a2.25 2.25 0 0 1 1.12-1.277l4.872-2.436a1.25 1.25 0 0 0 .325-2.002Z" fill="currentColor"/></svg>',rb='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M4 12.02c0 1.06.2 2.1.6 3.08l.6 1.42c.22.55.64 1.01 1.17 1.29.27.14.56.21.86.21h2.55c.77 0 1.49-.41 1.87-1.08.5-.87 1.02-1.7 1.72-2.43l1.32-1.39c.44-.46.97-.84 1.49-1.23l.59-.45a.6.6 0 0 0 .23-.47c0-.75-.54-1.57-1.22-1.79a3.34 3.34 0 0 0-2.78.29V4.5a1.5 1.5 0 0 0-2.05-1.4 1.5 1.5 0 0 0-2.9 0A1.5 1.5 0 0 0 6 4.5v.09A1.5 1.5 0 0 0 4 6v6.02ZM8 4.5v4a.5.5 0 0 0 1 0v-5a.5.5 0 0 1 1 0v5a.5.5 0 0 0 1 0v-4a.5.5 0 0 1 1 0v6a.5.5 0 0 0 .85.37h.01c.22-.22.44-.44.72-.58.7-.35 2.22-.57 2.4.5l-.53.4c-.52.4-1.04.78-1.48 1.24l-1.33 1.38c-.75.79-1.31 1.7-1.85 2.63-.21.36-.6.58-1.01.58H7.23a.87.87 0 0 1-.4-.1 1.55 1.55 0 0 1-.71-.78l-.59-1.42a7.09 7.09 0 0 1-.53-2.7V6a.5.5 0 0 1 1 0v3.5a.5.5 0 0 0 1 0v-5a.5.5 0 0 1 1 0Z" fill="currentColor"></path></svg>',vc=s=>{if(!s)return;if(!s.startsWith("<svg"))return new Promise(i=>{i(s)});const e=new Blob([s],{type:"image/svg+xml"}),r=new Image,n=window.URL.createObjectURL(e);return new Promise((i,a)=>{r.onload=()=>{i(r),window.URL.revokeObjectURL(n)},r.onerror=()=>{a(),window.URL.revokeObjectURL(n)},r.src=n})};function nb(s){const t={...s},e=new Map,r=(l,h)=>(e.has(l)||e.set(l,new Set),e.get(l).add(h),()=>{var m;return(m=e.get(l))==null?void 0:m.delete(h)}),n=(l,h)=>{var m;(m=e.get(l))==null||m.delete(h)},i=l=>{var h;(h=e.get(l))==null||h.forEach(m=>{try{m(t[l])}catch(f){u.error(`Error in notifying for "${l.toString()}"`,f)}})};return{subscribe:r,unsubscribe:n,notify:i,setValue:(l,h,m=!0)=>{t[l]=h,m&&i(l)},getValue:l=>t[l],getAllValues:()=>t}}class ib{constructor(){p(this,"contexts",new Map);p(this,"mostRecentPeerId",null)}createContext(t,e){return this.contexts.has(t)?this.contexts.get(t):(this.contexts.set(t,nb(e)),this.mostRecentPeerId=t,this.contexts.get(t))}remapContext(t,e){const r=e.getValue("peerId");r!==t&&(e.setValue("peerId",t),this.mostRecentPeerId=t,this.contexts.set(t,e),this.contexts.delete(r))}getContext(t){return this.contexts.get(t)}getMostRecentPeerId(){return this.mostRecentPeerId}}const tn=new ib,ae=class{static get logsEndpoint(){const t=tn.getContext(ae.meetingMetadata.peerId);return`https://${Qn({servicePrefix:"api-silos",baseURI:t.getValue("baseURI")})}/otel/logs`}static resetPeerId(t){ae.meetingMetadata.peerId=t}static init(t,e){const r=t.getValue("peerId");ae.tracingEnabled=e,ae.meetingMetadata.peerId=r,ae.meetingMetadata.sdkVersion=t.getValue("sdkVersion"),ae.meetingMetadata.deviceInfo=be.getDeviceInfo(),ae.meetingMetadata.visitedUrl=!navigator.isReactNative&&typeof window!="undefined"&&window.location.href,navigator.isReactNative||document.addEventListener("visibilitychange",ae.processCachedLogs),ae.logsProcessorTimer=setInterval(ae.processCachedLogs,ae.logsProcessingInterval),e&&(ae.initialized=!0)}static trace(t,e=void 0){return(r,n,i)=>{const a=i.value;return i.value=function(...d){if(!ae.initialized||navigator.isReactNative||!ae.tracingEnabled||ee.hasFeature(se.SKIP_OTEL_TRACES))return a.apply(this,d);ae.addLogInCurrentSpan("info",t,e);const l=performance.now(),h=a.apply(this,d);return Promise.resolve(h).then(()=>{const m=performance.now();m-l>10&&ae.addLogInCurrentSpan("info",`${t}_timing`,{execTime:m-l,country:ae.location.country})}).catch(()=>{const m=performance.now();ae.addLogInCurrentSpan("info",`${t}_timing`,{execTime:m-l})}),h},i}}static injectContext(t){var n;const e=Jn().replace(/-/g,"").substring(0,16),r=(n=ae.meetingMetadata.peerId)==null?void 0:n.replace(/-/g,"");t.TRACEPARENT=`00-${r}-${e}-01`}static addLogInCurrentSpan(t,e,r={},n=!1){r!=null&&r.error&&Object.assign(r,{error:mc(r.error)});const i=tn.getContext(ae.meetingMetadata.peerId);if(Pp(i)&&(V_(r)?console[t]("DyteInternalLogs:: ",t,e):console[t]("DyteInternalLogs:: ",t,e,r)),!!B_(t))try{const c=Rp(i,e,r,"metadata"),d=new Date,l={message:e,level:t,...c,loggedAt:d.toISOString(),loggedAtTzOffset:d.getTimezoneOffset()};n?ae.sendOtelLogsToNewRelic([l]):ae.logsCache.push(l)}catch(c){ae.addLogInCurrentSpan("error","opentelemetry::addLogInCurrentSpan_failed",{error:mc(c)})}}static sendOtelLogsToNewRelic(t){const e=tn.getContext(ae.meetingMetadata.peerId);fetch(ae.logsEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({meetingMetadata:Rp(e,"sendOtelLogsToNewRelic",ae.meetingMetadata,"meetingMetadata"),serviceName:e.getValue("sdkName"),logs:t})}).catch(r=>{ae.addLogInCurrentSpan("error","opentelemetry::sendOtelLogToNewRelic_failed",{error:mc(r)}),ae.logsCache.push(...t)})}static processCachedLogs(){const t=ae.logsCache.splice(0,25);t!=null&&t.length&&ae.sendOtelLogsToNewRelic(t)}static destruct(){clearInterval(ae.logsProcessorTimer),ae.processCachedLogs(),navigator.isReactNative||document.removeEventListener("visibilitychange",ae.processCachedLogs)}};let T=ae;p(T,"logsCache",[]),p(T,"logsProcessorTimer"),p(T,"location",{country:void 0}),p(T,"tracingEnabled",!0),p(T,"initialized",!1),p(T,"logsProcessingInterval",7e3),p(T,"logExclusionList",["message","websocket/message","roomMessage","websocket/room-message","websocket/room-legacy-mode","chatMessage","websocket/new-chat-message","websocket/no-active-speaker","websocket/selected-peers","websocket/active-speaker","ping","websocket/new-consumer","websocket/producer-score","websocket/consumer-score","websocket/plugin-event","websocket/plugin-data","websocket/plugin-internal-data"]),p(T,"meetingMetadata",{});class u{static info(t,e,r){T.addLogInCurrentSpan("info",t,e,r)}static error(t,e,r){T.addLogInCurrentSpan("error",t,e,r)}static debug(t,e,r){T.addLogInCurrentSpan("debug",t,e,r)}static log(t,e,r){T.addLogInCurrentSpan("log",t,e,r)}static warn(t,e,r){T.addLogInCurrentSpan("warn",t,e,r)}}const ab=()=>{!navigator.isReactNative&&typeof window!="undefined"&&(window.addEventListener("error",s=>{var t;!((t=s.filename)!=null&&t.includes("localhost"))&&s.lineno!==0&&u.error("window::error",{error:s.error},!0)}),window.addEventListener("unhandledrejection",s=>{var t,e,r,n,i,a,c,d;u.error("window::unhandledrejection",{error:s==null?void 0:s.reason,networkCall:{url:(e=(t=s==null?void 0:s.reason)==null?void 0:t.config)==null?void 0:e.url,baseURL:(n=(r=s==null?void 0:s.reason)==null?void 0:r.config)==null?void 0:n.baseURL,method:(a=(i=s==null?void 0:s.reason)==null?void 0:i.config)==null?void 0:a.method,status:(c=s==null?void 0:s.reason)==null?void 0:c.status,statusText:(d=s==null?void 0:s.reason)==null?void 0:d.statusText}},!0)}),window.addEventListener("offline",()=>{u.info("window::offline")}),window.addEventListener("online",()=>{u.info("window::online")}))},ob={"00":"DyteClient","01":"Controller","02":"RoomNodeClient","03":"HiveNodeClient","04":"SocketService","05":"Chat","06":"Plugin","07":"Polls","08":"Meta","09":"Preset",10:"Recording",11:"Self",12:"Participant",13:"Spotlight",14:"Remote Request",15:"Webinar",16:"LocalMediaHandler",17:"End-End Encryption",18:"AI",19:"Livestream",20:"Stage"},Tc={"0000":"Internal exception.","0001":"Failed to initialize.","0002":"Failed to join room.","0003":"Failed to leave room.","0004":"Invalid auth token","0010":"Browser not supported","0011":"HTTP Network Error","0012":"Websocket Network Error","0013":"Rate Limited","0100":"Internal exception","0101":"Permission denied","0102":"Prerequisite module missing","0200":"Internal exception.","0300":"Internal exception","0400":"Internal exception","0404":"Missing prerequisites to establish a websocket connection","0500":"Internal exception","0501":"Permission denied.","0502":"Invalid message body.","0503":"Text Message is too large","0504":"Message not found by the given id","0505":"Action not permitted without joining room","0506":"Message search is disabled","0510":"Invalid channel name.","0600":"Internal exception","0601":"Permission denied.","0602":"Auth token not set for plugin","0603":"Iframe was not provided","0700":"Internal exception","0705":"Action not permitted without joining room","0800":"Internal exception","0801":"Permission denied","0900":"Internal exception","0904":"Could not load preset",1e3:"Internal exception",1001:"Permission denied",1004:"Could not find specified recording",1005:"Action not permitted in given recording state",1100:"Internal exception",1101:"Permission denied",1102:"Unsupported",1103:"Name cannot be empty",1104:"No device selected while calling meeting.self.setDevice",1105:"Action not permitted without joining room",1106:"Can't set currently used device",1200:"Internal exception",1201:"Permission denied",1202:"Invalid page number was requested",1203:"Invalid participant count per page was requested",1204:"No participants exists with the given UserIds",1205:"Action not permitted without joining room",1206:"Manual Subscription Mode was not ACTIVATED",1207:"Invalid view mode",1208:"Manual Subscription not enabled for organization",1209:"Broadcast message type must be a non-empty string",1300:"Internal exception",1400:"Internal exception",1402:"No existing remote requests",1403:"No peer exists with given id",1500:"Internal exception",1600:"Internal exception",1601:"Failed to get audio track",1602:"Failed to get video track",1603:"Incorrect device",1604:"Failed to change device",1605:"Failed to get audio & video track",1606:"No audio input devices are available",1607:"No video input devices are available",1608:"No audio output devices (speakers) are available",1609:"Failed to fetch list of media devices",1610:"No media track exists",1611:"Failed to unmute track",1612:"Failed to get screenshare tracks",1701:"Crypto error",1800:"Internal exception",1801:"Can't fetch transcript file",1900:"Internal exception",1901:"Permission denied.",1902:"Livestream that has not yet started, can't be stopped",2e3:"Internal exception",2001:"Permission denied",2002:"Unsupported",2003:"Stage is disabled",2004:"Method not implemented",2005:"Action not permitted without joining room",2006:"Action not permitted in current stage status",9900:"Internal exception"};Object.keys(Tc).forEach(s=>{Tc[s]=`{${ob[s.slice(0,2)]}} ${Tc[s]}`});class P extends Error{constructor(e,r,n=!1){super(e);p(this,"code");this.code=r,this.name="DyteError",this.message=`[ERR${this.code}]: ${Tc[this.code]}
${this.message}`;try{let i=n;r&&r.endsWith("00")&&(i=!0),i&&u.error("DyteError",{error:{message:this.message,name:this.name,code:r}});const a=tn.getContext(tn.getMostRecentPeerId());if(a){const c=a.getValue("onError");try{c(this)}catch(d){}}typeof window!="undefined"&&window.dispatchEvent(new CustomEvent("dyteError",{detail:this}))}catch(i){}}}function yc(s,t,e,r){if(r instanceof P)throw r;if(r instanceof t){const n=new P(r.message,e);throw n.stack=r.stack,n}else throw r}function Fp(s,t,e){if(!s.value){const n=s.get,i=s.set;return n&&(s.get=function(){try{return n.apply(this)}catch(a){yc(this,t,e,a)}}),i&&(s.set=function(a){try{return i.apply(this,[a])}catch(c){yc(this,t,e,c)}}),s}const r=s.value;return s.value=function(...n){try{const i=r.apply(this,n);return i&&i instanceof Promise?i.catch(a=>{yc(this,t,e,a)}):i}catch(i){yc(this,t,e,i)}},s}function cb(s,t){return(e,r,n)=>{if(n)return Fp(n,s,t);for(const i of Reflect.ownKeys(e.prototype).filter(a=>a!=="constructor")){const a=Object.getOwnPropertyDescriptor(e.prototype,i);(a.value instanceof Function||a.get instanceof Function||a.set instanceof Function)&&Object.defineProperty(e.prototype,i,Fp(a,s,t))}}}const lt=s=>cb(Error,s);function db(s){let t=0,e,r;if(!s)return t;for(e=0;e<s.length;e+=1)r=s.charCodeAt(e),t=(t<<5)-t+r,t|=0;return Math.abs(t)%100+1}class lb extends re.EventEmitter{constructor(){super();g(this,Js,void 0);g(this,Ks,void 0);p(this,"asyncPromiseTimeout");v(this,Js,new Map),v(this,Ks,new Map),this.asyncPromiseTimeout=8e3}async emitAsync(e,...r){o(this,Js).set(e,[]);const n=o(this,Ks).get(e).map(()=>new Promise(i=>{o(this,Js).get(e).push(i)}));super.emit(e,...r),await Promise.race([Promise.all(n),new Promise((i,a)=>setTimeout(()=>a(new Error(`emitAsync failed to resolve for event ${e}.`)),this.asyncPromiseTimeout))]),o(this,Js).delete(e)}onAsync(e,r){const n=o(this,Js),i=async(...a)=>{var d;try{await r(...a)}catch(l){u.error("[onAsync]",{error:l})}const c=(d=n.get(e))==null?void 0:d.shift();c==null||c()};return o(this,Ks).get(e)||o(this,Ks).set(e,[]),o(this,Ks).get(e).push(i),super.on(e,i)}reset(){v(this,Js,new Map),v(this,Ks,new Map),super.removeAllListeners()}}Js=new WeakMap,Ks=new WeakMap;const R=new lb;function ub(){be.isElectron()&&window.dyteElectronGetDisplayMediaSource&&(navigator.mediaDevices.getDisplayMedia=async()=>{const s=await window.dyteElectronGetDisplayMediaSource({types:["window","screen"]});let t=[];if(s&&(Array.isArray(s)?t=s:t=[s]),!(t!=null&&t.length))throw new Error("Couldn't find any media source for screen share.");let e=t.find(i=>{var a;return(a=i.id)==null?void 0:a.includes("screen")});e=e!=null?e:t[0];const r={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e.id}}};return await navigator.mediaDevices.getUserMedia(r)})}var k=(s=>(s.NEW_PRODUCER="NEW_PRODUCER",s.PRODUCER_TRACK_ENDED="PRODUCER_TRACK_ENDED",s.ROOM_NODE_CONNECTION_ERROR="ROOM_NODE_CONNECTION_ERROR",s.SOCKET_SERVICE_ROOM_JOINED="SOCKET_SERVICE_ROOM_JOINED",s.SOCKET_SERVICE_RECONNECTED="SOCKET_SERVICE_RECONNECTED",s.SOCKET_SERVICE_DISCONNECTED="SOCKET_SERVICE_DISCONNECTED",s.SOCKET_SERVICE_FAILED="SOCKET_SERVICE_FAILED",s.SOCKET_STATE_UPDATE="SOCKET_STATE_UPDATE",s.ROOM_NODE_RECONNECTED="ROOM_NODE_RECONNECTED",s.ROOM_NODE_DISCONNECTED="ROOM_NODE_DISCONNECTED",s.ROOM_NODE_FAILED="ROOM_NODE_FAILED",s.TRANSPORT_STATE_UPDATE="TRANSPORT_STATE_UPDATE",s.PRODUCER_SCORE_UPDATE="PRODUCER_SCORE_UPDATE",s.CONSUMER_SCORE_UPDATE="CONSUMER_SCORE_UPDATE",s.PRODUCER_STATUS_UPDATE="PRODUCER_STATUS_UPDATE",s.CONSUMER_STATUS_UPDATE="CONSUMER_STATUS_UPDATE",s.LOW_PRODUCER_SCORE="LOW_PRODUCER_SCORE",s.LOW_CONSUMER_SCORE="LOW_CONSUMER_SCORE",s.MEDIA_PERMISSION_ERROR="MEDIA_PERMISSION_ERROR",s.MEDIA_PERMISSION_UPDATE="MEDIA_PERMISSION_UPDATE",s.WAITLISTED="WAIT_LISTED",s.MESSAGE="websocket/message",s.ROOM_MESSAGE="websocket/room-message",s.PEER_JOINED_INTERNAL="peer/joined-internal",s.PEER_CLOSED="websocket/peer-closed",s.CONSUMER_CLOSED="websocket/consumer-closed",s.CONSUMER_PAUSED="websocket/consumer-paused",s.CONSUMER_RESUMED="websocket/consumer-resumed",s.PRODUCER_CLOSED="websocket/producer-closed",s.NEW_CONSUMER="websocket/new-consumer",s.PRODUCER_SCORE="websocket/producer-score",s.CONSUMER_SCORE="websocket/consumer-score",s.PRODUCER_TOGGLE="hive/producer-toggle",s.CONSUMER_TOGGLE="hive/consumer-toggle",s.SELECTED_PEERS_DIFF="hive/selected-peers-diff",s.UPDATE_ACTIVE="media/update-active",s.RESET_PRODUCER_STATE="hive/reset-producer-state",s.CF_TRANSPORT_STATE_CHANGED="cf/transport-state-changed",s.CF_ROOM_REJOINING="cf/room-rejoining",s.CF_ROOM_REJOIN_FAILED="cf/room-rejoining-failed",s.CF_ROOM_REJOINED="cf/room-rejoined",s.CF_TRANPSORT_RECONNECTING="cf/transport-reconnecting",s.ROOM_STATE="sockethub/room-state",s.PEER_DISPLAY_NAME_CHANGED="hive/display-name-changed",s.GET_STAGE_REQUESTS="GET_STAGE_REQUESTS",s.UPDATE_STAGE_REQUESTS="UPDATE_STAGE_REQUESTS",s.KICK_PEER="KICK_PEER",s.UPDATE_PEER_STAGE_STATUS="UPDATE_PEER_STAGE_STATUS",s.JOIN_MEDIA_ROOM="JOIN_MEDIA_ROOM",s.LEAVE_MEDIA_ROOM="LEAVE_MEDIA_ROOM",s.PIP_HANGUP="PIP_HANGUP",s.E2EE_ACTIVE_PRODUCER="E2EE_ACTIVE_PRODUCER",s.E2EE_INACTIVE_PRODUCER="E2EE_INACTIVE_PRODUCER",s.E2EE_ACTIVE_CONSUMER="E2EE_ACTIVE_CONSUMER",s.E2EE_INACTIVE_CONSUMER="E2EE_INACTIVE_CONSUMER",s.SOCKET_PEERS="SOCKET_PEERS",s.UPDATE_PERMISSIONS="UPDATE_PERMISSIONS",s.MAX_SPATIAL_LAYER_CHANGE="MAX_SPATIAL_LAYER_CHANGE",s.MUTE_SELF="MUTE_SELF",s.MUTE_SELF_VIDEO="MUTE_SELF_VIDEO",s))(k||{});class Xn extends re.EventEmitter{constructor(){super(),super.setMaxListeners(25)}emit(t,...e){return super.emit("*",t,...e),super.emit(t,...e)}on(t,e){try{const r=this.listenerCount(t);r>25&&r%25===0&&u.warn("DyteEventEmitter::maxListenersExceeded",{eventListener:{eventName:t.toString(),listenerCount:this.listenerCount(t)}})}catch(r){}return super.on(t,e)}addListener(t,e){try{const r=this.listenerCount(t);r>25&&r%25===0&&u.warn("DyteEventEmitter::maxListenersExceeded",{eventListener:{eventName:t.toString(),listenerCount:this.listenerCount(t)}})}catch(r){}return super.addListener(t,e)}off(t,e){return super.off(t,e)}once(t,e){return super.once(t,e)}prependListener(t,e){return super.prependListener(t,e)}prependOnceListener(t,e){return super.prependOnceListener(t,e)}removeListener(t,e){return super.removeListener(t,e)}removeAllListeners(t){return super.removeAllListeners(t)}listeners(t){return super.listeners(t)}listenerCount(t){return super.listenerCount(t)}}class Ft extends re.EventEmitter{constructor(){super(),super.setMaxListeners(25)}emit(t,...e){return super.emit("*",t,...e),super.emit(t,...e)}on(t,e){try{const r=this.listenerCount(t);r>25&&r%25===0&&u.warn("DyteEventEmitter::maxListenersExceeded",{eventListener:{eventName:t.toString(),listenerCount:this.listenerCount(t)}})}catch(r){}return super.on(t,e)}addListener(t,e){try{const r=this.listenerCount(t);r>25&&r%25===0&&u.warn("DyteEventEmitter::maxListenersExceeded",{eventListener:{eventName:t.toString(),listenerCount:this.listenerCount(t)}})}catch(r){}return super.addListener(t,e)}off(t,e){return super.off(t,e)}once(t,e){return super.once(t,e)}prependListener(t,e){return super.prependListener(t,e)}prependOnceListener(t,e){return super.prependOnceListener(t,e)}removeListener(t,e){return super.removeListener(t,e)}removeAllListeners(t){return super.removeAllListeners(t)}listeners(t){return super.listeners(t)}listenerCount(t){return super.listenerCount(t)}}function hb(s,t=2){return s.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w\s]/g,"").trim().split(/\s+/).slice(0,t).map(n=>n.charAt(0)).join("").toUpperCase()}const Bp=1080,$p=1920,pb=(s,t,e,r,n,i)=>{let a=.5,c=.5;const d=n,l=i,h=Math.min(e/d,r/l);let m=d*h,f=l*h,y,_,b,I,L=1;return m<e&&(L=e/m),Math.abs(L-1)<1e-14&&f<r&&(L=r/f),m*=L,f*=L,b=d/(m/e),I=l/(f/r),y=(d-b)*a,_=(l-I)*c,y<0&&(y=0),_<0&&(_=0),b>d&&(b=d),I>l&&(I=l),[y,_,b,I,s,t,e,r]},wu=class extends Ft{constructor(e,r,n,i){super();g(this,Qt,void 0);g(this,hi,void 0);g(this,pt,void 0);g(this,Xt,void 0);g(this,Ve,{height:Bp,width:$p});g(this,vs,{brand:"#2160FD",background:"#141414",text:"#000000",videoBackground:"#191919",textOnBrand:"#EEEEEE"});g(this,zs,void 0);g(this,Ct,{});g(this,We,void 0);g(this,pi,void 0);g(this,mi,void 0);g(this,Ys,void 0);g(this,fi,!1);p(this,"cleanupEventListeners",()=>{o(this,hi).unsubscribe("stageStatus",this.handlePipMediaControls),o(this,We).removeListener("videoUpdate",this.onSelfVideoUpdateListener),o(this,We).removeListener("audioUpdate",this.onSelfAudioUpdateListener),o(this,We).removeListener("roomLeft",()=>this.disable())});p(this,"enablePipMediaControls",()=>{this.mountAudioEvents(),this.mountVideoEvents()});p(this,"onSelfVideoUpdateListener",({videoEnabled:e})=>{this.updateMediaSession("CAMERA",e)});p(this,"onSelfAudioUpdateListener",({audioEnabled:e})=>{this.updateMediaSession("MIC",e)});p(this,"handlePipMediaControls",e=>{e==="ON_STAGE"?this.enablePipMediaControls():this.unmountEvents()});p(this,"eventCallback",e=>{e==="CAMERA"&&(o(this,We).videoEnabled?o(this,We).disableVideo():o(this,We).enableVideo(),this.emit("cameraToggled")),e==="MIC"&&(o(this,We).audioEnabled?o(this,We).disableAudio():o(this,We).enableAudio(),this.emit("micToggled")),e==="END"&&(R.emit(k.PIP_HANGUP),this.cleanupEventListeners(),this.emit("hangup"),this.cleanup())});p(this,"unmountEvents",()=>{navigator.mediaSession===void 0||navigator.mediaSession.setCameraActive===void 0||(navigator.mediaSession.setActionHandler("togglemicrophone",void 0),navigator.mediaSession.setActionHandler("togglecamera",void 0))});p(this,"animate",()=>{if(!this.isActive&&o(this,Ys)==="active"){this.disable(!0);return}o(this,Ct)!==void 0&&this.paintCanvas(),o(this,zs)!==void 0&&v(this,zs,requestAnimationFrame(()=>this.animate()))});p(this,"disable",(e=!1)=>{v(this,Ys,"idle"),this.cleanupEventListeners(),cancelAnimationFrame(o(this,zs)),e!==!0&&document.body.removeChild(o(this,pt)),v(this,zs,void 0),document.pictureInPictureElement&&document.exitPictureInPicture()});v(this,hi,e),v(this,Ys,"idle"),v(this,We,r),v(this,vs,{brand:r.config.designTokens.colors.brand[500],background:r.config.designTokens.colors.background[1e3],text:r.config.designTokens.colors.text,videoBackground:r.config.designTokens.colors.videoBg,textOnBrand:r.config.designTokens.colors.textOnBrand}),n&&this.setupIcon("pin",n),i&&this.setupIcon("handRaise",i)}static async _init(e,r){let n,i;try{n=await vc(sb),i=await vc(rb)}catch(a){}return new wu(e,r,n,i)}async setupIcon(e,r){switch(e){case"handRaise":v(this,mi,r);break;case"pin":v(this,pi,r);break}}async overrideIcon(e,r){switch(e){case"handRaise":v(this,mi,await vc(r));break;case"pin":v(this,pi,await vc(r));break}}constructImage(e){const r=new Image,n=new Blob([e],{type:"image/svg+xml"}),i=window.URL.createObjectURL(n);return new Promise(a=>{r.onload=()=>{a(r),window.URL.revokeObjectURL(i)},r.src=i})}createVideoContainer(){v(this,pt,document.createElement("div")),o(this,pt).style.width="0.1px",o(this,pt).style.height="0.1px",o(this,pt).style.overflow="hidden",o(this,pt).style.position="absolute",o(this,pt).style.bottom="0",o(this,pt).style.right="0",o(this,pt).style.opacity="0",o(this,pt).appendChild(o(this,Xt))}setupEventListeners(){o(this,hi).subscribe("stageStatus",this.handlePipMediaControls),o(this,We).addListener("videoUpdate",this.onSelfVideoUpdateListener),o(this,We).addListener("audioUpdate",this.onSelfAudioUpdateListener),o(this,We).addListener("roomLeft",()=>this.disable())}createCanvas(){const e=document.createElement("canvas");e.height=o(this,Ve).height,e.width=o(this,Ve).width,v(this,Qt,e)}setupMediaSessionEvents(){navigator.mediaSession===void 0||navigator.mediaSession.setCameraActive===void 0||(navigator.mediaSession.setActionHandler("hangup",()=>{this.eventCallback("END")}),this.mountAudioEvents(),this.mountVideoEvents())}mountAudioEvents(){navigator.mediaSession===void 0||navigator.mediaSession.setMicrophoneActive===void 0||o(this,We).permissions.canProduceAudio&&navigator.mediaSession.setActionHandler("togglemicrophone",()=>{this.eventCallback("MIC")})}mountVideoEvents(){navigator.mediaSession===void 0||navigator.mediaSession.setCameraActive===void 0||o(this,We).permissions.canProduceVideo&&navigator.mediaSession.setActionHandler("togglecamera",()=>{this.eventCallback("CAMERA")})}getSources(){const r=Object.values(o(this,Ct)).reduce((n,i)=>(n[i.pinned?"pinned":"regular"].push(i),n),{pinned:[],regular:[]});return[...r.pinned,...r.regular]}drawEmptyTile(e,r,n,i){if(o(this,Qt)===void 0)return;const a=o(this,Qt).getContext("2d"),c=o(this,Qt).width,d=0,l=0,h=r-d*2,m=n-d*2,f=Math.floor(c/h),y=Math.floor(e/f),b=e%f*(h+d)+d,I=y*(m+d)+d,{displayText:L,image:B}=i!=null?i:{};a.fillStyle=L||B?o(this,vs).videoBackground:o(this,vs).background,a.strokeStyle=o(this,vs).brand,a.beginPath(),a.moveTo(b+l,I),a.arcTo(b+h,I,b+h,I+l,l),a.arcTo(b+h,I+m,b+h-l,I+m,l),a.arcTo(b,I+m,b,I+m-l,l),a.arcTo(b,I,b+l,I,l),a.closePath(),a.fill(),a.stroke();const q=h/6,F=h/2+b,X=m/2+I;a.save(),(L||B)&&(a.beginPath(),a.arc(F,X,q,0,Math.PI*2),a.fillStyle=o(this,vs).brand,a.fill(),B?(a.clip(),a.drawImage(B,F-q,X-q,q*2,q*2),a.restore()):L&&(a.fillStyle=o(this,vs).textOnBrand,a.font=`${q/2}px sans-serif`,a.textAlign="center",a.textBaseline="middle",a.fillText(L,F,X)),this.drawIcons(i,b,I,Math.max(h,m)))}drawIcons(e,r,n,i){const a=Math.min(Math.max(i*.15,100),200),c=a*.2,d=a*.2;let l=r+c;const h=n+c,m=f=>{const y=o(this,Qt).getContext("2d");y.save(),y.fillStyle=o(this,vs).background,y.beginPath(),y.moveTo(l+d,h),y.arcTo(l+a,h,l+a,h+d,d),y.arcTo(l+a,h+a,l+a-d,h+a,d),y.arcTo(l,h+a,l,h+a-d,d),y.arcTo(l,h,l+d,h,d),y.closePath(),y.fill(),typeof f=="string"?(y.font=`${a/1.5}px sans-serif`,y.fillStyle=o(this,vs).text,y.textAlign="center",y.textBaseline="top",y.fillText(f,a/2+l,h+c)):y.drawImage(f,l+c,h+c,a-c*2,a-c*2),l+=a+c,y.restore()};e.pinned&&m(o(this,pi)),e.handRaised&&m(o(this,mi))}drawTile(e,r,n){var l,h;if(o(this,Qt)===void 0)return;const i=o(this,Qt).getContext("2d"),a=this.getSources();let c=0,d=0;for(;c<o(this,Ve).height-5;){let m=0;for(;m<o(this,Ve).width-5&&d<n;){if((l=a[d])!=null&&l.enabled){const f=a[d].element,[y,_,b,I,L,B,q,F]=pb(m,c,e,r,f.videoWidth,f.videoHeight);((h=f==null?void 0:f.classList)==null?void 0:h.contains("mirror"))?(i.save(),i.scale(-1,1),i.drawImage(f,y,_,b,I,-1*L,B,-1*q,F),i.restore()):i.drawImage(f,y,_,b,I,L,B,q,F),this.drawIcons(a[d],L,B,Math.max(q,F))}else this.drawEmptyTile(d,e,r,a[d]);d+=1,m+=e}c+=r}}calcGridElemSize(e){switch(e){case 0:case 1:return[o(this,Ve).width,o(this,Ve).height];case 2:return[Math.floor(o(this,Ve).width/2),o(this,Ve).height];case 3:case 4:return[Math.floor(o(this,Ve).width/2),Math.floor(o(this,Ve).height/2)];case 5:case 6:return[Math.floor(o(this,Ve).width/3),Math.floor(o(this,Ve).height/2)];case 7:case 8:case 9:return[Math.floor(o(this,Ve).width/3),Math.floor(o(this,Ve).height/3)];default:return[Math.floor(o(this,Ve).width/3),Math.floor(o(this,Ve).height/2)]}}paintCanvas(){let e=this.getSources().length;e!==1&&(e=e%2>0?e+1:e);const[r,n]=this.calcGridElemSize(e);this.drawTile(r,n,e)}isSupported(){return!!window.chrome&&document.pictureInPictureEnabled}get isActive(){return document.pictureInPictureElement!==null}cleanup(){if(v(this,fi,!1),this.isSupported()&&document.exitPictureInPicture!==void 0&&document.pictureInPictureElement!==null&&document.exitPictureInPicture(),o(this,pt))try{document.body.removeChild(o(this,pt))}catch(e){}this.removeAllSources(),v(this,Qt,void 0),v(this,Xt,void 0),v(this,zs,void 0)}init({height:e,width:r}={}){if(o(this,fi))return;v(this,fi,!0),this.createCanvas(),this.setupMediaSessionEvents();const n=document.createElement("video");v(this,Ve,{height:e!=null?e:Bp,width:r!=null?r:$p}),n.height=o(this,Ve).height,n.width=o(this,Ve).width,n.autoplay=!0,n.muted=!0,n.srcObject=o(this,Qt).captureStream(24),v(this,Xt,n),o(this,Xt).onloadedmetadata=()=>{try{this.emit("pipStarted"),o(this,Xt).onleavepictureinpicture=()=>{this.emit("pipEnded")}}catch(i){this.emit("pipEnded")}},this.createVideoContainer(),this.paintCanvas()}updateMediaSession(e,r){navigator.mediaSession!==void 0&&(e==="CAMERA"&&navigator.mediaSession.setCameraActive!==void 0&&navigator.mediaSession.setCameraActive(r),e==="MIC"&&navigator.mediaSession.setMicrophoneActive!==void 0&&navigator.mediaSession.setMicrophoneActive(r))}enableSource(e){o(this,Ct)[e]!==void 0&&(o(this,Ct)[e].enabled=!0)}disableSource(e){o(this,Ct)[e]!==void 0&&(o(this,Ct)[e].enabled=!1)}async generateAvatar(e,r){if(!r)return;const n=new Image;try{const i=await(await fetch(r)).blob(),a=window.URL.createObjectURL(i);n.onload=()=>{this.updateSource(e,{image:n}),window.URL.revokeObjectURL(a)},n.src=a}catch(i){u.error("DytePip::GenerateAvatar",{error:i})}}addSource(e,r,n,i=!1,a=void 0,c=void 0,d=!1){u.debug("DytePIP::AddSource",{pip:{id:e,handRaised:d}}),o(this,Ct)[e]={id:e,element:r,enabled:n,pinned:i,displayText:a?hb(a):void 0,imageUrl:c,handRaised:d},c&&this.generateAvatar(e,c)}updateSource(e,r){u.info("DytePIP::UpdateSource",{pip:{id:e,handRaised:r.handRaised}});const n=o(this,Ct)[e];n&&(o(this,Ct)[e]={...n,...r})}removeSource(e){delete o(this,Ct)[e]}removePinnedSource(){Object.values(o(this,Ct)).forEach(r=>{r.pinned&&this.removeSource(r.id)})}removeAllSources(){v(this,Ct,{})}enable(){v(this,Ys,"activating"),this.setupEventListeners(),this.updateMediaSession("CAMERA",o(this,We).videoEnabled),this.updateMediaSession("MIC",o(this,We).audioEnabled),document.body.appendChild(o(this,pt)),v(this,zs,requestAnimationFrame(()=>this.animate())),o(this,Xt).onloadedmetadata=()=>{o(this,Xt).requestPictureInPicture().then(()=>{v(this,Ys,"active")})},o(this,Xt).readyState===4&&o(this,Xt).requestPictureInPicture().then(()=>{v(this,Ys,"active")})}};let vl=wu;Qt=new WeakMap,hi=new WeakMap,pt=new WeakMap,Xt=new WeakMap,Ve=new WeakMap,vs=new WeakMap,zs=new WeakMap,Ct=new WeakMap,We=new WeakMap,pi=new WeakMap,mi=new WeakMap,Ys=new WeakMap,fi=new WeakMap;function Tl(s){let t=typeof s;if(t=="object"){if(Array.isArray(s))return"array";if(s===null)return"null"}return t}function mb(s){return s!==null&&typeof s=="object"&&!Array.isArray(s)}let Fs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Sc=[];for(let s=0;s<Fs.length;s++)Sc[Fs[s].charCodeAt(0)]=s;Sc["-".charCodeAt(0)]=Fs.indexOf("+"),Sc["_".charCodeAt(0)]=Fs.indexOf("/");function fb(s){let t=s.length*3/4;s[s.length-2]=="="?t-=2:s[s.length-1]=="="&&(t-=1);let e=new Uint8Array(t),r=0,n=0,i,a=0;for(let c=0;c<s.length;c++){if(i=Sc[s.charCodeAt(c)],i===void 0)switch(s[c]){case"=":n=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(n){case 0:a=i,n=1;break;case 1:e[r++]=a<<2|(i&48)>>4,a=i,n=2;break;case 2:e[r++]=(a&15)<<4|(i&60)>>2,a=i,n=3;break;case 3:e[r++]=(a&3)<<6|i,n=0;break}}if(n==1)throw Error("invalid base64 string.");return e.subarray(0,r)}function gb(s){let t="",e=0,r,n=0;for(let i=0;i<s.length;i++)switch(r=s[i],e){case 0:t+=Fs[r>>2],n=(r&3)<<4,e=1;break;case 1:t+=Fs[n|r>>4],n=(r&15)<<2,e=2;break;case 2:t+=Fs[n|r>>6],t+=Fs[r&63],e=0;break}return e&&(t+=Fs[n],t+="=",e==1&&(t+="=")),t}var Ec;(function(s){s.symbol=Symbol.for("protobuf-ts/unknown"),s.onRead=(e,r,n,i,a)=>{(t(r)?r[s.symbol]:r[s.symbol]=[]).push({no:n,wireType:i,data:a})},s.onWrite=(e,r,n)=>{for(let{no:i,wireType:a,data:c}of s.list(r))n.tag(i,a).raw(c)},s.list=(e,r)=>{if(t(e)){let n=e[s.symbol];return r?n.filter(i=>i.no==r):n}return[]},s.last=(e,r)=>s.list(e,r).slice(-1)[0];const t=e=>e&&Array.isArray(e[s.symbol])})(Ec||(Ec={}));var Fe;(function(s){s[s.Varint=0]="Varint",s[s.Bit64=1]="Bit64",s[s.LengthDelimited=2]="LengthDelimited",s[s.StartGroup=3]="StartGroup",s[s.EndGroup=4]="EndGroup",s[s.Bit32=5]="Bit32"})(Fe||(Fe={}));function vb(){let s=0,t=0;for(let r=0;r<28;r+=7){let n=this.buf[this.pos++];if(s|=(n&127)<<r,!(n&128))return this.assertBounds(),[s,t]}let e=this.buf[this.pos++];if(s|=(e&15)<<28,t=(e&112)>>4,!(e&128))return this.assertBounds(),[s,t];for(let r=3;r<=31;r+=7){let n=this.buf[this.pos++];if(t|=(n&127)<<r,!(n&128))return this.assertBounds(),[s,t]}throw new Error("invalid varint")}function yl(s,t,e){for(let i=0;i<28;i=i+7){const a=s>>>i,c=!(!(a>>>7)&&t==0),d=(c?a|128:a)&255;if(e.push(d),!c)return}const r=s>>>28&15|(t&7)<<4,n=!!(t>>3);if(e.push((n?r|128:r)&255),!!n){for(let i=3;i<31;i=i+7){const a=t>>>i,c=!!(a>>>7),d=(c?a|128:a)&255;if(e.push(d),!c)return}e.push(t>>>31&1)}}const _c=(1<<16)*(1<<16);function Hp(s){let t=s[0]=="-";t&&(s=s.slice(1));const e=1e6;let r=0,n=0;function i(a,c){const d=Number(s.slice(a,c));n*=e,r=r*e+d,r>=_c&&(n=n+(r/_c|0),r=r%_c)}return i(-24,-18),i(-18,-12),i(-12,-6),i(-6),[t,r,n]}function Sl(s,t){if(t>>>0<=2097151)return""+(_c*t+(s>>>0));let e=s&16777215,r=(s>>>24|t<<8)>>>0&16777215,n=t>>16&65535,i=e+r*6777216+n*6710656,a=r+n*8147497,c=n*2,d=1e7;i>=d&&(a+=Math.floor(i/d),i%=d),a>=d&&(c+=Math.floor(a/d),a%=d);function l(h,m){let f=h?String(h):"";return m?"0000000".slice(f.length)+f:f}return l(c,0)+l(a,c)+l(i,1)}function qp(s,t){if(s>=0){for(;s>127;)t.push(s&127|128),s=s>>>7;t.push(s)}else{for(let e=0;e<9;e++)t.push(s&127|128),s=s>>7;t.push(1)}}function Tb(){let s=this.buf[this.pos++],t=s&127;if(!(s&128))return this.assertBounds(),t;if(s=this.buf[this.pos++],t|=(s&127)<<7,!(s&128))return this.assertBounds(),t;if(s=this.buf[this.pos++],t|=(s&127)<<14,!(s&128))return this.assertBounds(),t;if(s=this.buf[this.pos++],t|=(s&127)<<21,!(s&128))return this.assertBounds(),t;s=this.buf[this.pos++],t|=(s&15)<<28;for(let e=5;s&128&&e<10;e++)s=this.buf[this.pos++];if(s&128)throw new Error("invalid varint");return this.assertBounds(),t>>>0}let fe;function yb(){const s=new DataView(new ArrayBuffer(8));fe=globalThis.BigInt!==void 0&&typeof s.getBigInt64=="function"&&typeof s.getBigUint64=="function"&&typeof s.setBigInt64=="function"&&typeof s.setBigUint64=="function"?{MIN:BigInt("-9223372036854775808"),MAX:BigInt("9223372036854775807"),UMIN:BigInt("0"),UMAX:BigInt("18446744073709551615"),C:BigInt,V:s}:void 0}yb();function jp(s){if(!s)throw new Error("BigInt unavailable, see https://github.com/timostamm/protobuf-ts/blob/v1.0.8/MANUAL.md#bigint-support")}const Gp=/^-?[0-9]+$/,bc=4294967296,wc=2147483648;class Wp{constructor(t,e){this.lo=t|0,this.hi=e|0}isZero(){return this.lo==0&&this.hi==0}toNumber(){let t=this.hi*bc+(this.lo>>>0);if(!Number.isSafeInteger(t))throw new Error("cannot convert to safe number");return t}}class ut extends Wp{static from(t){if(fe)switch(typeof t){case"string":if(t=="0")return this.ZERO;if(t=="")throw new Error("string is no integer");t=fe.C(t);case"number":if(t===0)return this.ZERO;t=fe.C(t);case"bigint":if(!t)return this.ZERO;if(t<fe.UMIN)throw new Error("signed value for ulong");if(t>fe.UMAX)throw new Error("ulong too large");return fe.V.setBigUint64(0,t,!0),new ut(fe.V.getInt32(0,!0),fe.V.getInt32(4,!0))}else switch(typeof t){case"string":if(t=="0")return this.ZERO;if(t=t.trim(),!Gp.test(t))throw new Error("string is no integer");let[e,r,n]=Hp(t);if(e)throw new Error("signed value for ulong");return new ut(r,n);case"number":if(t==0)return this.ZERO;if(!Number.isSafeInteger(t))throw new Error("number is no integer");if(t<0)throw new Error("signed value for ulong");return new ut(t,t/bc)}throw new Error("unknown value "+typeof t)}toString(){return fe?this.toBigInt().toString():Sl(this.lo,this.hi)}toBigInt(){return jp(fe),fe.V.setInt32(0,this.lo,!0),fe.V.setInt32(4,this.hi,!0),fe.V.getBigUint64(0,!0)}}ut.ZERO=new ut(0,0);class Se extends Wp{static from(t){if(fe)switch(typeof t){case"string":if(t=="0")return this.ZERO;if(t=="")throw new Error("string is no integer");t=fe.C(t);case"number":if(t===0)return this.ZERO;t=fe.C(t);case"bigint":if(!t)return this.ZERO;if(t<fe.MIN)throw new Error("signed long too small");if(t>fe.MAX)throw new Error("signed long too large");return fe.V.setBigInt64(0,t,!0),new Se(fe.V.getInt32(0,!0),fe.V.getInt32(4,!0))}else switch(typeof t){case"string":if(t=="0")return this.ZERO;if(t=t.trim(),!Gp.test(t))throw new Error("string is no integer");let[e,r,n]=Hp(t);if(e){if(n>wc||n==wc&&r!=0)throw new Error("signed long too small")}else if(n>=wc)throw new Error("signed long too large");let i=new Se(r,n);return e?i.negate():i;case"number":if(t==0)return this.ZERO;if(!Number.isSafeInteger(t))throw new Error("number is no integer");return t>0?new Se(t,t/bc):new Se(-t,-t/bc).negate()}throw new Error("unknown value "+typeof t)}isNegative(){return(this.hi&wc)!==0}negate(){let t=~this.hi,e=this.lo;return e?e=~e+1:t+=1,new Se(e,t)}toString(){if(fe)return this.toBigInt().toString();if(this.isNegative()){let t=this.negate();return"-"+Sl(t.lo,t.hi)}return Sl(this.lo,this.hi)}toBigInt(){return jp(fe),fe.V.setInt32(0,this.lo,!0),fe.V.setInt32(4,this.hi,!0),fe.V.getBigInt64(0,!0)}}Se.ZERO=new Se(0,0);const Jp={readUnknownField:!0,readerFactory:s=>new Eb(s)};function Sb(s){return s?Object.assign(Object.assign({},Jp),s):Jp}class Eb{constructor(t,e){this.varint64=vb,this.uint32=Tb,this.buf=t,this.len=t.length,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.textDecoder=e!=null?e:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0})}tag(){let t=this.uint32(),e=t>>>3,r=t&7;if(e<=0||r<0||r>5)throw new Error("illegal tag: field no "+e+" wire type "+r);return[e,r]}skip(t){let e=this.pos;switch(t){case Fe.Varint:for(;this.buf[this.pos++]&128;);break;case Fe.Bit64:this.pos+=4;case Fe.Bit32:this.pos+=4;break;case Fe.LengthDelimited:let r=this.uint32();this.pos+=r;break;case Fe.StartGroup:let n;for(;(n=this.tag()[1])!==Fe.EndGroup;)this.skip(n);break;default:throw new Error("cant skip wire type "+t)}return this.assertBounds(),this.buf.subarray(e,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let t=this.uint32();return t>>>1^-(t&1)}int64(){return new Se(...this.varint64())}uint64(){return new ut(...this.varint64())}sint64(){let[t,e]=this.varint64(),r=-(t&1);return t=(t>>>1|(e&1)<<31)^r,e=e>>>1^r,new Se(t,e)}bool(){let[t,e]=this.varint64();return t!==0||e!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return new ut(this.sfixed32(),this.sfixed32())}sfixed64(){return new Se(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let t=this.uint32(),e=this.pos;return this.pos+=t,this.assertBounds(),this.buf.subarray(e,e+t)}string(){return this.textDecoder.decode(this.bytes())}}function oe(s,t){if(!s)throw new Error(t)}const _b=34028234663852886e22,bb=-34028234663852886e22,wb=4294967295,Pb=2147483647,Cb=-2147483648;function ba(s){if(typeof s!="number")throw new Error("invalid int 32: "+typeof s);if(!Number.isInteger(s)||s>Pb||s<Cb)throw new Error("invalid int 32: "+s)}function Pc(s){if(typeof s!="number")throw new Error("invalid uint 32: "+typeof s);if(!Number.isInteger(s)||s>wb||s<0)throw new Error("invalid uint 32: "+s)}function El(s){if(typeof s!="number")throw new Error("invalid float 32: "+typeof s);if(Number.isFinite(s)&&(s>_b||s<bb))throw new Error("invalid float 32: "+s)}const Kp={writeUnknownFields:!0,writerFactory:()=>new kb};function Rb(s){return s?Object.assign(Object.assign({},Kp),s):Kp}class kb{constructor(t){this.stack=[],this.textEncoder=t!=null?t:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let t=0;for(let n=0;n<this.chunks.length;n++)t+=this.chunks[n].length;let e=new Uint8Array(t),r=0;for(let n=0;n<this.chunks.length;n++)e.set(this.chunks[n],r),r+=this.chunks[n].length;return this.chunks=[],e}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let t=this.finish(),e=this.stack.pop();if(!e)throw new Error("invalid state, fork stack empty");return this.chunks=e.chunks,this.buf=e.buf,this.uint32(t.byteLength),this.raw(t)}tag(t,e){return this.uint32((t<<3|e)>>>0)}raw(t){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(t),this}uint32(t){for(Pc(t);t>127;)this.buf.push(t&127|128),t=t>>>7;return this.buf.push(t),this}int32(t){return ba(t),qp(t,this.buf),this}bool(t){return this.buf.push(t?1:0),this}bytes(t){return this.uint32(t.byteLength),this.raw(t)}string(t){let e=this.textEncoder.encode(t);return this.uint32(e.byteLength),this.raw(e)}float(t){El(t);let e=new Uint8Array(4);return new DataView(e.buffer).setFloat32(0,t,!0),this.raw(e)}double(t){let e=new Uint8Array(8);return new DataView(e.buffer).setFloat64(0,t,!0),this.raw(e)}fixed32(t){Pc(t);let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t,!0),this.raw(e)}sfixed32(t){ba(t);let e=new Uint8Array(4);return new DataView(e.buffer).setInt32(0,t,!0),this.raw(e)}sint32(t){return ba(t),t=(t<<1^t>>31)>>>0,qp(t,this.buf),this}sfixed64(t){let e=new Uint8Array(8),r=new DataView(e.buffer),n=Se.from(t);return r.setInt32(0,n.lo,!0),r.setInt32(4,n.hi,!0),this.raw(e)}fixed64(t){let e=new Uint8Array(8),r=new DataView(e.buffer),n=ut.from(t);return r.setInt32(0,n.lo,!0),r.setInt32(4,n.hi,!0),this.raw(e)}int64(t){let e=Se.from(t);return yl(e.lo,e.hi,this.buf),this}sint64(t){let e=Se.from(t),r=e.hi>>31,n=e.lo<<1^r,i=(e.hi<<1|e.lo>>>31)^r;return yl(n,i,this.buf),this}uint64(t){let e=ut.from(t);return yl(e.lo,e.hi,this.buf),this}}const zp={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0},Yp={ignoreUnknownFields:!1};function Ib(s){return s?Object.assign(Object.assign({},Yp),s):Yp}function Ab(s){return s?Object.assign(Object.assign({},zp),s):zp}const Qp=Symbol.for("protobuf-ts/message-type");function Xp(s){let t=!1;const e=[];for(let r=0;r<s.length;r++){let n=s.charAt(r);n=="_"?t=!0:/\d/.test(n)?(e.push(n),t=!0):t?(e.push(n.toUpperCase()),t=!1):r==0?e.push(n.toLowerCase()):e.push(n)}return e.join("")}var M;(function(s){s[s.DOUBLE=1]="DOUBLE",s[s.FLOAT=2]="FLOAT",s[s.INT64=3]="INT64",s[s.UINT64=4]="UINT64",s[s.INT32=5]="INT32",s[s.FIXED64=6]="FIXED64",s[s.FIXED32=7]="FIXED32",s[s.BOOL=8]="BOOL",s[s.STRING=9]="STRING",s[s.BYTES=12]="BYTES",s[s.UINT32=13]="UINT32",s[s.SFIXED32=15]="SFIXED32",s[s.SFIXED64=16]="SFIXED64",s[s.SINT32=17]="SINT32",s[s.SINT64=18]="SINT64"})(M||(M={}));var Ps;(function(s){s[s.BIGINT=0]="BIGINT",s[s.STRING=1]="STRING",s[s.NUMBER=2]="NUMBER"})(Ps||(Ps={}));var Cc;(function(s){s[s.NO=0]="NO",s[s.PACKED=1]="PACKED",s[s.UNPACKED=2]="UNPACKED"})(Cc||(Cc={}));function Mb(s){var t,e,r,n;return s.localName=(t=s.localName)!==null&&t!==void 0?t:Xp(s.name),s.jsonName=(e=s.jsonName)!==null&&e!==void 0?e:Xp(s.name),s.repeat=(r=s.repeat)!==null&&r!==void 0?r:Cc.NO,s.opt=(n=s.opt)!==null&&n!==void 0?n:s.repeat||s.oneof?!1:s.kind=="message",s}function Db(s){if(typeof s!="object"||s===null||!s.hasOwnProperty("oneofKind"))return!1;switch(typeof s.oneofKind){case"string":return s[s.oneofKind]===void 0?!1:Object.keys(s).length==2;case"undefined":return Object.keys(s).length==1;default:return!1}}class Ob{constructor(t){var e;this.fields=(e=t.fields)!==null&&e!==void 0?e:[]}prepare(){if(this.data)return;const t=[],e=[],r=[];for(let n of this.fields)if(n.oneof)r.includes(n.oneof)||(r.push(n.oneof),t.push(n.oneof),e.push(n.oneof));else switch(e.push(n.localName),n.kind){case"scalar":case"enum":(!n.opt||n.repeat)&&t.push(n.localName);break;case"message":n.repeat&&t.push(n.localName);break;case"map":t.push(n.localName);break}this.data={req:t,known:e,oneofs:Object.values(r)}}is(t,e,r=!1){if(e<0)return!0;if(t==null||typeof t!="object")return!1;this.prepare();let n=Object.keys(t),i=this.data;if(n.length<i.req.length||i.req.some(a=>!n.includes(a))||!r&&n.some(a=>!i.known.includes(a)))return!1;if(e<1)return!0;for(const a of i.oneofs){const c=t[a];if(!Db(c))return!1;if(c.oneofKind===void 0)continue;const d=this.fields.find(l=>l.localName===c.oneofKind);if(!d||!this.field(c[c.oneofKind],d,r,e))return!1}for(const a of this.fields)if(a.oneof===void 0&&!this.field(t[a.localName],a,r,e))return!1;return!0}field(t,e,r,n){let i=e.repeat;switch(e.kind){case"scalar":return t===void 0?e.opt:i?this.scalars(t,e.T,n,e.L):this.scalar(t,e.T,e.L);case"enum":return t===void 0?e.opt:i?this.scalars(t,M.INT32,n):this.scalar(t,M.INT32);case"message":return t===void 0?!0:i?this.messages(t,e.T(),r,n):this.message(t,e.T(),r,n);case"map":if(typeof t!="object"||t===null)return!1;if(n<2)return!0;if(!this.mapKeys(t,e.K,n))return!1;switch(e.V.kind){case"scalar":return this.scalars(Object.values(t),e.V.T,n,e.V.L);case"enum":return this.scalars(Object.values(t),M.INT32,n);case"message":return this.messages(Object.values(t),e.V.T(),r,n)}break}return!0}message(t,e,r,n){return r?e.isAssignable(t,n):e.is(t,n)}messages(t,e,r,n){if(!Array.isArray(t))return!1;if(n<2)return!0;if(r){for(let i=0;i<t.length&&i<n;i++)if(!e.isAssignable(t[i],n-1))return!1}else for(let i=0;i<t.length&&i<n;i++)if(!e.is(t[i],n-1))return!1;return!0}scalar(t,e,r){let n=typeof t;switch(e){case M.UINT64:case M.FIXED64:case M.INT64:case M.SFIXED64:case M.SINT64:switch(r){case Ps.BIGINT:return n=="bigint";case Ps.NUMBER:return n=="number"&&!isNaN(t);default:return n=="string"}case M.BOOL:return n=="boolean";case M.STRING:return n=="string";case M.BYTES:return t instanceof Uint8Array;case M.DOUBLE:case M.FLOAT:return n=="number"&&!isNaN(t);default:return n=="number"&&Number.isInteger(t)}}scalars(t,e,r,n){if(!Array.isArray(t))return!1;if(r<2)return!0;if(Array.isArray(t)){for(let i=0;i<t.length&&i<r;i++)if(!this.scalar(t[i],e,n))return!1}return!0}mapKeys(t,e,r){let n=Object.keys(t);switch(e){case M.INT32:case M.FIXED32:case M.SFIXED32:case M.SINT32:case M.UINT32:return this.scalars(n.slice(0,r).map(i=>parseInt(i)),e,r);case M.BOOL:return this.scalars(n.slice(0,r).map(i=>i=="true"?!0:i=="false"?!1:i),e,r);default:return this.scalars(n,e,r,Ps.STRING)}}}function ds(s,t){switch(t){case Ps.BIGINT:return s.toBigInt();case Ps.NUMBER:return s.toNumber();default:return s.toString()}}class Nb{constructor(t){this.info=t}prepare(){var t;if(this.fMap===void 0){this.fMap={};const e=(t=this.info.fields)!==null&&t!==void 0?t:[];for(const r of e)this.fMap[r.name]=r,this.fMap[r.jsonName]=r,this.fMap[r.localName]=r}}assert(t,e,r){if(!t){let n=Tl(r);throw(n=="number"||n=="boolean")&&(n=r.toString()),new Error(`Cannot parse JSON ${n} for ${this.info.typeName}#${e}`)}}read(t,e,r){this.prepare();const n=[];for(const[i,a]of Object.entries(t)){const c=this.fMap[i];if(!c){if(!r.ignoreUnknownFields)throw new Error(`Found unknown field while reading ${this.info.typeName} from JSON format. JSON key: ${i}`);continue}const d=c.localName;let l;if(c.oneof){if(a===null&&(c.kind!=="enum"||c.T()[0]!=="google.protobuf.NullValue"))continue;if(n.includes(c.oneof))throw new Error(`Multiple members of the oneof group "${c.oneof}" of ${this.info.typeName} are present in JSON.`);n.push(c.oneof),l=e[c.oneof]={oneofKind:d}}else l=e;if(c.kind=="map"){if(a===null)continue;this.assert(mb(a),c.name,a);const h=l[d];for(const[m,f]of Object.entries(a)){this.assert(f!==null,c.name+" map value",null);let y;switch(c.V.kind){case"message":y=c.V.T().internalJsonRead(f,r);break;case"enum":if(y=this.enum(c.V.T(),f,c.name,r.ignoreUnknownFields),y===!1)continue;break;case"scalar":y=this.scalar(f,c.V.T,c.V.L,c.name);break}this.assert(y!==void 0,c.name+" map value",f);let _=m;c.K==M.BOOL&&(_=_=="true"?!0:_=="false"?!1:_),_=this.scalar(_,c.K,Ps.STRING,c.name).toString(),h[_]=y}}else if(c.repeat){if(a===null)continue;this.assert(Array.isArray(a),c.name,a);const h=l[d];for(const m of a){this.assert(m!==null,c.name,null);let f;switch(c.kind){case"message":f=c.T().internalJsonRead(m,r);break;case"enum":if(f=this.enum(c.T(),m,c.name,r.ignoreUnknownFields),f===!1)continue;break;case"scalar":f=this.scalar(m,c.T,c.L,c.name);break}this.assert(f!==void 0,c.name,a),h.push(f)}}else switch(c.kind){case"message":if(a===null&&c.T().typeName!="google.protobuf.Value"){this.assert(c.oneof===void 0,c.name+" (oneof member)",null);continue}l[d]=c.T().internalJsonRead(a,r,l[d]);break;case"enum":let h=this.enum(c.T(),a,c.name,r.ignoreUnknownFields);if(h===!1)continue;l[d]=h;break;case"scalar":l[d]=this.scalar(a,c.T,c.L,c.name);break}}}enum(t,e,r,n){if(t[0]=="google.protobuf.NullValue"&&oe(e===null||e==="NULL_VALUE",`Unable to parse field ${this.info.typeName}#${r}, enum ${t[0]} only accepts null.`),e===null)return 0;switch(typeof e){case"number":return oe(Number.isInteger(e),`Unable to parse field ${this.info.typeName}#${r}, enum can only be integral number, got ${e}.`),e;case"string":let i=e;t[2]&&e.substring(0,t[2].length)===t[2]&&(i=e.substring(t[2].length));let a=t[1][i];return typeof a=="undefined"&&n?!1:(oe(typeof a=="number",`Unable to parse field ${this.info.typeName}#${r}, enum ${t[0]} has no value for "${e}".`),a)}oe(!1,`Unable to parse field ${this.info.typeName}#${r}, cannot parse enum value from ${typeof e}".`)}scalar(t,e,r,n){let i;try{switch(e){case M.DOUBLE:case M.FLOAT:if(t===null)return 0;if(t==="NaN")return Number.NaN;if(t==="Infinity")return Number.POSITIVE_INFINITY;if(t==="-Infinity")return Number.NEGATIVE_INFINITY;if(t===""){i="empty string";break}if(typeof t=="string"&&t.trim().length!==t.length){i="extra whitespace";break}if(typeof t!="string"&&typeof t!="number")break;let a=Number(t);if(Number.isNaN(a)){i="not a number";break}if(!Number.isFinite(a)){i="too large or small";break}return e==M.FLOAT&&El(a),a;case M.INT32:case M.FIXED32:case M.SFIXED32:case M.SINT32:case M.UINT32:if(t===null)return 0;let c;if(typeof t=="number"?c=t:t===""?i="empty string":typeof t=="string"&&(t.trim().length!==t.length?i="extra whitespace":c=Number(t)),c===void 0)break;return e==M.UINT32?Pc(c):ba(c),c;case M.INT64:case M.SFIXED64:case M.SINT64:if(t===null)return ds(Se.ZERO,r);if(typeof t!="number"&&typeof t!="string")break;return ds(Se.from(t),r);case M.FIXED64:case M.UINT64:if(t===null)return ds(ut.ZERO,r);if(typeof t!="number"&&typeof t!="string")break;return ds(ut.from(t),r);case M.BOOL:if(t===null)return!1;if(typeof t!="boolean")break;return t;case M.STRING:if(t===null)return"";if(typeof t!="string"){i="extra whitespace";break}try{encodeURIComponent(t)}catch(d){d="invalid UTF8";break}return t;case M.BYTES:if(t===null||t==="")return new Uint8Array(0);if(typeof t!="string")break;return fb(t)}}catch(a){i=a.message}this.assert(!1,n+(i?" - "+i:""),t)}}class Lb{constructor(t){var e;this.fields=(e=t.fields)!==null&&e!==void 0?e:[]}write(t,e){const r={},n=t;for(const i of this.fields){if(!i.oneof){let l=this.field(i,n[i.localName],e);l!==void 0&&(r[e.useProtoFieldName?i.name:i.jsonName]=l);continue}const a=n[i.oneof];if(a.oneofKind!==i.localName)continue;const c=i.kind=="scalar"||i.kind=="enum"?Object.assign(Object.assign({},e),{emitDefaultValues:!0}):e;let d=this.field(i,a[i.localName],c);oe(d!==void 0),r[e.useProtoFieldName?i.name:i.jsonName]=d}return r}field(t,e,r){let n;if(t.kind=="map"){oe(typeof e=="object"&&e!==null);const i={};switch(t.V.kind){case"scalar":for(const[d,l]of Object.entries(e)){const h=this.scalar(t.V.T,l,t.name,!1,!0);oe(h!==void 0),i[d.toString()]=h}break;case"message":const a=t.V.T();for(const[d,l]of Object.entries(e)){const h=this.message(a,l,t.name,r);oe(h!==void 0),i[d.toString()]=h}break;case"enum":const c=t.V.T();for(const[d,l]of Object.entries(e)){oe(l===void 0||typeof l=="number");const h=this.enum(c,l,t.name,!1,!0,r.enumAsInteger);oe(h!==void 0),i[d.toString()]=h}break}(r.emitDefaultValues||Object.keys(i).length>0)&&(n=i)}else if(t.repeat){oe(Array.isArray(e));const i=[];switch(t.kind){case"scalar":for(let d=0;d<e.length;d++){const l=this.scalar(t.T,e[d],t.name,t.opt,!0);oe(l!==void 0),i.push(l)}break;case"enum":const a=t.T();for(let d=0;d<e.length;d++){oe(e[d]===void 0||typeof e[d]=="number");const l=this.enum(a,e[d],t.name,t.opt,!0,r.enumAsInteger);oe(l!==void 0),i.push(l)}break;case"message":const c=t.T();for(let d=0;d<e.length;d++){const l=this.message(c,e[d],t.name,r);oe(l!==void 0),i.push(l)}break}(r.emitDefaultValues||i.length>0||r.emitDefaultValues)&&(n=i)}else switch(t.kind){case"scalar":n=this.scalar(t.T,e,t.name,t.opt,r.emitDefaultValues);break;case"enum":n=this.enum(t.T(),e,t.name,t.opt,r.emitDefaultValues,r.enumAsInteger);break;case"message":n=this.message(t.T(),e,t.name,r);break}return n}enum(t,e,r,n,i,a){if(t[0]=="google.protobuf.NullValue")return!i&&!n?void 0:null;if(e===void 0){oe(n);return}if(!(e===0&&!i&&!n))return oe(typeof e=="number"),oe(Number.isInteger(e)),a||!t[1].hasOwnProperty(e)?e:t[2]?t[2]+t[1][e]:t[1][e]}message(t,e,r,n){return e===void 0?n.emitDefaultValues?null:void 0:t.internalJsonWrite(e,n)}scalar(t,e,r,n,i){if(e===void 0){oe(n);return}const a=i||n;switch(t){case M.INT32:case M.SFIXED32:case M.SINT32:return e===0?a?0:void 0:(ba(e),e);case M.FIXED32:case M.UINT32:return e===0?a?0:void 0:(Pc(e),e);case M.FLOAT:El(e);case M.DOUBLE:return e===0?a?0:void 0:(oe(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e);case M.STRING:return e===""?a?"":void 0:(oe(typeof e=="string"),e);case M.BOOL:return e===!1?a?!1:void 0:(oe(typeof e=="boolean"),e);case M.UINT64:case M.FIXED64:oe(typeof e=="number"||typeof e=="string"||typeof e=="bigint");let c=ut.from(e);return c.isZero()&&!a?void 0:c.toString();case M.INT64:case M.SFIXED64:case M.SINT64:oe(typeof e=="number"||typeof e=="string"||typeof e=="bigint");let d=Se.from(e);return d.isZero()&&!a?void 0:d.toString();case M.BYTES:return oe(e instanceof Uint8Array),e.byteLength?gb(e):a?"":void 0}}}function _l(s,t=Ps.STRING){switch(s){case M.BOOL:return!1;case M.UINT64:case M.FIXED64:return ds(ut.ZERO,t);case M.INT64:case M.SFIXED64:case M.SINT64:return ds(Se.ZERO,t);case M.DOUBLE:case M.FLOAT:return 0;case M.BYTES:return new Uint8Array(0);case M.STRING:return"";default:return 0}}class xb{constructor(t){this.info=t}prepare(){var t;if(!this.fieldNoToField){const e=(t=this.info.fields)!==null&&t!==void 0?t:[];this.fieldNoToField=new Map(e.map(r=>[r.no,r]))}}read(t,e,r,n){this.prepare();const i=n===void 0?t.len:t.pos+n;for(;t.pos<i;){const[a,c]=t.tag(),d=this.fieldNoToField.get(a);if(!d){let f=r.readUnknownField;if(f=="throw")throw new Error(`Unknown field ${a} (wire type ${c}) for ${this.info.typeName}`);let y=t.skip(c);f!==!1&&(f===!0?Ec.onRead:f)(this.info.typeName,e,a,c,y);continue}let l=e,h=d.repeat,m=d.localName;switch(d.oneof&&(l=l[d.oneof],l.oneofKind!==m&&(l=e[d.oneof]={oneofKind:m})),d.kind){case"scalar":case"enum":let f=d.kind=="enum"?M.INT32:d.T,y=d.kind=="scalar"?d.L:void 0;if(h){let I=l[m];if(c==Fe.LengthDelimited&&f!=M.STRING&&f!=M.BYTES){let L=t.uint32()+t.pos;for(;t.pos<L;)I.push(this.scalar(t,f,y))}else I.push(this.scalar(t,f,y))}else l[m]=this.scalar(t,f,y);break;case"message":if(h){let I=l[m],L=d.T().internalBinaryRead(t,t.uint32(),r);I.push(L)}else l[m]=d.T().internalBinaryRead(t,t.uint32(),r,l[m]);break;case"map":let[_,b]=this.mapEntry(d,t,r);l[m][_]=b;break}}}mapEntry(t,e,r){let n=e.uint32(),i=e.pos+n,a,c;for(;e.pos<i;){let[d,l]=e.tag();switch(d){case 1:t.K==M.BOOL?a=e.bool().toString():a=this.scalar(e,t.K,Ps.STRING);break;case 2:switch(t.V.kind){case"scalar":c=this.scalar(e,t.V.T,t.V.L);break;case"enum":c=e.int32();break;case"message":c=t.V.T().internalBinaryRead(e,e.uint32(),r);break}break;default:throw new Error(`Unknown field ${d} (wire type ${l}) in map entry for ${this.info.typeName}#${t.name}`)}}if(a===void 0){let d=_l(t.K);a=t.K==M.BOOL?d.toString():d}if(c===void 0)switch(t.V.kind){case"scalar":c=_l(t.V.T,t.V.L);break;case"enum":c=0;break;case"message":c=t.V.T().create();break}return[a,c]}scalar(t,e,r){switch(e){case M.INT32:return t.int32();case M.STRING:return t.string();case M.BOOL:return t.bool();case M.DOUBLE:return t.double();case M.FLOAT:return t.float();case M.INT64:return ds(t.int64(),r);case M.UINT64:return ds(t.uint64(),r);case M.FIXED64:return ds(t.fixed64(),r);case M.FIXED32:return t.fixed32();case M.BYTES:return t.bytes();case M.UINT32:return t.uint32();case M.SFIXED32:return t.sfixed32();case M.SFIXED64:return ds(t.sfixed64(),r);case M.SINT32:return t.sint32();case M.SINT64:return ds(t.sint64(),r)}}}class Vb{constructor(t){this.info=t}prepare(){if(!this.fields){const t=this.info.fields?this.info.fields.concat():[];this.fields=t.sort((e,r)=>e.no-r.no)}}write(t,e,r){this.prepare();for(const i of this.fields){let a,c,d=i.repeat,l=i.localName;if(i.oneof){const h=t[i.oneof];if(h.oneofKind!==l)continue;a=h[l],c=!0}else a=t[l],c=!1;switch(i.kind){case"scalar":case"enum":let h=i.kind=="enum"?M.INT32:i.T;if(d)if(oe(Array.isArray(a)),d==Cc.PACKED)this.packed(e,h,i.no,a);else for(const m of a)this.scalar(e,h,i.no,m,!0);else a===void 0?oe(i.opt):this.scalar(e,h,i.no,a,c||i.opt);break;case"message":if(d){oe(Array.isArray(a));for(const m of a)this.message(e,r,i.T(),i.no,m)}else this.message(e,r,i.T(),i.no,a);break;case"map":oe(typeof a=="object"&&a!==null);for(const[m,f]of Object.entries(a))this.mapEntry(e,r,i,m,f);break}}let n=r.writeUnknownFields;n!==!1&&(n===!0?Ec.onWrite:n)(this.info.typeName,t,e)}mapEntry(t,e,r,n,i){t.tag(r.no,Fe.LengthDelimited),t.fork();let a=n;switch(r.K){case M.INT32:case M.FIXED32:case M.UINT32:case M.SFIXED32:case M.SINT32:a=Number.parseInt(n);break;case M.BOOL:oe(n=="true"||n=="false"),a=n=="true";break}switch(this.scalar(t,r.K,1,a,!0),r.V.kind){case"scalar":this.scalar(t,r.V.T,2,i,!0);break;case"enum":this.scalar(t,M.INT32,2,i,!0);break;case"message":this.message(t,e,r.V.T(),2,i);break}t.join()}message(t,e,r,n,i){i!==void 0&&(r.internalBinaryWrite(i,t.tag(n,Fe.LengthDelimited).fork(),e),t.join())}scalar(t,e,r,n,i){let[a,c,d]=this.scalarInfo(e,n);(!d||i)&&(t.tag(r,a),t[c](n))}packed(t,e,r,n){if(!n.length)return;oe(e!==M.BYTES&&e!==M.STRING),t.tag(r,Fe.LengthDelimited),t.fork();let[,i]=this.scalarInfo(e);for(let a=0;a<n.length;a++)t[i](n[a]);t.join()}scalarInfo(t,e){let r=Fe.Varint,n,i=e===void 0,a=e===0;switch(t){case M.INT32:n="int32";break;case M.STRING:a=i||!e.length,r=Fe.LengthDelimited,n="string";break;case M.BOOL:a=e===!1,n="bool";break;case M.UINT32:n="uint32";break;case M.DOUBLE:r=Fe.Bit64,n="double";break;case M.FLOAT:r=Fe.Bit32,n="float";break;case M.INT64:a=i||Se.from(e).isZero(),n="int64";break;case M.UINT64:a=i||ut.from(e).isZero(),n="uint64";break;case M.FIXED64:a=i||ut.from(e).isZero(),r=Fe.Bit64,n="fixed64";break;case M.BYTES:a=i||!e.byteLength,r=Fe.LengthDelimited,n="bytes";break;case M.FIXED32:r=Fe.Bit32,n="fixed32";break;case M.SFIXED32:r=Fe.Bit32,n="sfixed32";break;case M.SFIXED64:a=i||Se.from(e).isZero(),r=Fe.Bit64,n="sfixed64";break;case M.SINT32:n="sint32";break;case M.SINT64:a=i||Se.from(e).isZero(),n="sint64";break}return[r,n,i||a]}}function Ub(s){const t=s.messagePrototype?Object.create(s.messagePrototype):Object.defineProperty({},Qp,{value:s});for(let e of s.fields){let r=e.localName;if(!e.opt)if(e.oneof)t[e.oneof]={oneofKind:void 0};else if(e.repeat)t[r]=[];else switch(e.kind){case"scalar":t[r]=_l(e.T,e.L);break;case"enum":t[r]=0;break;case"map":t[r]={};break}}return t}function bl(s,t,e){let r,n=e,i;for(let a of s.fields){let c=a.localName;if(a.oneof){const d=n[a.oneof];if((d==null?void 0:d.oneofKind)==null)continue;if(r=d[c],i=t[a.oneof],i.oneofKind=d.oneofKind,r==null){delete i[c];continue}}else if(r=n[c],i=t,r==null)continue;switch(a.repeat&&(i[c].length=r.length),a.kind){case"scalar":case"enum":if(a.repeat)for(let l=0;l<r.length;l++)i[c][l]=r[l];else i[c]=r;break;case"message":let d=a.T();if(a.repeat)for(let l=0;l<r.length;l++)i[c][l]=d.create(r[l]);else i[c]===void 0?i[c]=d.create(r):d.mergePartial(i[c],r);break;case"map":switch(a.V.kind){case"scalar":case"enum":Object.assign(i[c],r);break;case"message":let l=a.V.T();for(let h of Object.keys(r))i[c][h]=l.create(r[h]);break}break}}}function Fb(s,t,e){if(t===e)return!0;if(!t||!e)return!1;for(let r of s.fields){let n=r.localName,i=r.oneof?t[r.oneof][n]:t[n],a=r.oneof?e[r.oneof][n]:e[n];switch(r.kind){case"enum":case"scalar":let c=r.kind=="enum"?M.INT32:r.T;if(!(r.repeat?em(c,i,a):Zp(c,i,a)))return!1;break;case"map":if(!(r.V.kind=="message"?tm(r.V.T(),Rc(i),Rc(a)):em(r.V.kind=="enum"?M.INT32:r.V.T,Rc(i),Rc(a))))return!1;break;case"message":let d=r.T();if(!(r.repeat?tm(d,i,a):d.equals(i,a)))return!1;break}}return!0}const Rc=Object.values;function Zp(s,t,e){if(t===e)return!0;if(s!==M.BYTES)return!1;let r=t,n=e;if(r.length!==n.length)return!1;for(let i=0;i<r.length;i++)if(r[i]!=n[i])return!1;return!0}function em(s,t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(!Zp(s,t[r],e[r]))return!1;return!0}function tm(s,t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(!s.equals(t[r],e[r]))return!1;return!0}const Bb=Object.getOwnPropertyDescriptors(Object.getPrototypeOf({}));class S{constructor(t,e,r){this.defaultCheckDepth=16,this.typeName=t,this.fields=e.map(Mb),this.options=r!=null?r:{},this.messagePrototype=Object.create(null,Object.assign(Object.assign({},Bb),{[Qp]:{value:this}})),this.refTypeCheck=new Ob(this),this.refJsonReader=new Nb(this),this.refJsonWriter=new Lb(this),this.refBinReader=new xb(this),this.refBinWriter=new Vb(this)}create(t){let e=Ub(this);return t!==void 0&&bl(this,e,t),e}clone(t){let e=this.create();return bl(this,e,t),e}equals(t,e){return Fb(this,t,e)}is(t,e=this.defaultCheckDepth){return this.refTypeCheck.is(t,e,!1)}isAssignable(t,e=this.defaultCheckDepth){return this.refTypeCheck.is(t,e,!0)}mergePartial(t,e){bl(this,t,e)}fromBinary(t,e){let r=Sb(e);return this.internalBinaryRead(r.readerFactory(t),t.byteLength,r)}fromJson(t,e){return this.internalJsonRead(t,Ib(e))}fromJsonString(t,e){let r=JSON.parse(t);return this.fromJson(r,e)}toJson(t,e){return this.internalJsonWrite(t,Ab(e))}toJsonString(t,e){var r;let n=this.toJson(t,e);return JSON.stringify(n,null,(r=e==null?void 0:e.prettySpaces)!==null&&r!==void 0?r:0)}toBinary(t,e){let r=Rb(e);return this.internalBinaryWrite(t,r.writerFactory(),r).finish()}internalJsonRead(t,e,r){if(t!==null&&typeof t=="object"&&!Array.isArray(t)){let n=r!=null?r:this.create();return this.refJsonReader.read(t,n,e),n}throw new Error(`Unable to parse message ${this.typeName} from JSON ${Tl(t)}.`)}internalJsonWrite(t,e){return this.refJsonWriter.write(t,e)}internalBinaryWrite(t,e,r){return this.refBinWriter.write(t,e,r),e}internalBinaryRead(t,e,r,n){let i=n!=null?n:this.create();return this.refBinReader.read(t,i,r,e),i}}var pr;(function(s){s[s.PUBLISHER=0]="PUBLISHER",s[s.SUBSCRIBER=1]="SUBSCRIBER"})(pr||(pr={}));var Cs;(function(s){s[s.AUDIO=0]="AUDIO",s[s.VIDEO=1]="VIDEO"})(Cs||(Cs={}));class $b extends S{constructor(){super("media.Codec",[{no:1,name:"channels",kind:"scalar",opt:!0,T:5},{no:2,name:"clock_rate",kind:"scalar",T:5},{no:3,name:"mime_type",kind:"scalar",T:9},{no:4,name:"sdp_fmtp_line",kind:"scalar",opt:!0,T:9}])}}const Hb=new $b;class qb extends S{constructor(){super("media.HeaderExtension",[{no:1,name:"direction",kind:"scalar",opt:!0,T:9},{no:2,name:"uri",kind:"scalar",T:9}])}}const jb=new qb;class Gb extends S{constructor(){super("media.Fingerprint",[{no:1,name:"algorithm",kind:"scalar",T:9},{no:2,name:"value",kind:"scalar",T:9}])}}new Gb;class Wb extends S{constructor(){super("media.SessionDescription",[{no:1,name:"target",kind:"enum",T:()=>["media.Target",pr]},{no:2,name:"type",kind:"scalar",T:9},{no:3,name:"sdp",kind:"scalar",T:9}])}}const ls=new Wb;class Jb extends S{constructor(){super("media.ProducerPayload",[{no:1,name:"kind",kind:"scalar",T:9},{no:2,name:"paused",kind:"scalar",T:8},{no:3,name:"screen_share",kind:"scalar",T:8},{no:4,name:"msid",kind:"scalar",T:9},{no:5,name:"app_data",kind:"scalar",opt:!0,T:9},{no:6,name:"mime_type",kind:"scalar",opt:!0,T:9}])}}const Kb=new Jb;class zb extends S{constructor(){super("media.CreateTransportRequest",[{no:1,name:"consuming",kind:"scalar",T:8},{no:2,name:"force_tcp",kind:"scalar",opt:!0,T:8},{no:3,name:"description",kind:"message",T:()=>ls},{no:4,name:"private_ice",kind:"scalar",opt:!0,T:8},{no:5,name:"producers",kind:"message",repeat:1,T:()=>Kb}])}}const Yb=new zb;class Qb extends S{constructor(){super("media.AudioActivityRequest",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"energy",kind:"scalar",T:5},{no:3,name:"silent",kind:"scalar",T:8}])}}new Qb;class Xb extends S{constructor(){super("media.CreateTransportResponse",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>ls},{no:3,name:"transcription_enabled",kind:"scalar",opt:!0,T:8},{no:4,name:"producer_ids",kind:"scalar",repeat:2,T:9}])}}const sm=new Xb;class Zb extends S{constructor(){super("media.RenegotiateRequest",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>ls}])}}const ew=new Zb;class tw extends S{constructor(){super("media.RenegotiateResponse",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>ls}])}}new tw;class sw extends S{constructor(){super("media.NestedScore",[{no:1,name:"encoding_idx",kind:"scalar",T:5},{no:2,name:"rid",kind:"scalar",T:9},{no:3,name:"score",kind:"scalar",T:5},{no:4,name:"ssrc",kind:"scalar",T:3,L:0}])}}const rw=new sw;class nw extends S{constructor(){super("media.ProducerTrack",[{no:1,name:"track_id",kind:"scalar",T:9},{no:2,name:"producer_id",kind:"scalar",T:9},{no:3,name:"stream_id",kind:"scalar",T:9}])}}const iw=new nw;class aw extends S{constructor(){super("media.ProducerEntry",[{no:1,name:"producing_transport_id",kind:"scalar",T:9},{no:2,name:"producer_id",kind:"scalar",T:9}])}}new aw;class ow extends S{constructor(){super("media.ConsumerEntry",[{no:1,name:"consuming_transport_id",kind:"scalar",T:9},{no:2,name:"consumer_id",kind:"scalar",T:9}])}}new ow;class cw extends S{constructor(){super("media.ProducerState",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"kind",kind:"enum",T:()=>["media.ProducerKind",Cs]},{no:3,name:"pause",kind:"scalar",T:8},{no:4,name:"screen_share",kind:"scalar",T:8},{no:5,name:"app_data",kind:"scalar",opt:!0,T:9},{no:6,name:"producing_transport_id",kind:"scalar",opt:!0,T:9},{no:7,name:"mime_type",kind:"scalar",opt:!0,T:9}])}}const wa=new cw;class dw extends S{constructor(){super("media.ConsumerState",[{no:1,name:"consumer_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>wa},{no:3,name:"producer_track",kind:"message",T:()=>iw}])}}const lw=new dw;class uw extends S{constructor(){super("media.ProducerIdToConsumerMap",[{no:1,name:"map",kind:"map",K:9,V:{kind:"message",T:()=>lw}}])}}const rm=new uw;class hw extends S{constructor(){super("media.PeerRtpCapabilitites",[{no:1,name:"sender",kind:"message",T:()=>am},{no:2,name:"receiver",kind:"message",T:()=>am}])}}const nm=new hw;class pw extends S{constructor(){super("media.RtpCapability",[{no:1,name:"codecs",kind:"message",repeat:1,T:()=>Hb},{no:2,name:"header_extensions",kind:"message",repeat:1,T:()=>jb}])}}const im=new pw;class mw extends S{constructor(){super("media.RtpCapabilitites",[{no:1,name:"audio",kind:"message",T:()=>im},{no:2,name:"video",kind:"message",T:()=>im}])}}const am=new mw;class fw extends S{constructor(){super("media.PreferredCodec",[{no:1,name:"audio",kind:"scalar",opt:!0,T:9},{no:2,name:"video",kind:"scalar",opt:!0,T:9}])}}const gw=new fw;class vw extends S{constructor(){super("media.edge.GeoLocation",[{no:1,name:"latitude",kind:"scalar",T:2},{no:2,name:"longitude",kind:"scalar",T:2},{no:3,name:"region",kind:"scalar",opt:!0,T:9}])}}const Tw=new vw;class yw extends S{constructor(){super("media.edge.PeerJoinRequest",[{no:1,name:"display_name",kind:"scalar",opt:!0,T:9},{no:2,name:"prejoined",kind:"scalar",T:8},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:5,name:"preset",kind:"scalar",opt:!0,T:12},{no:6,name:"user_id",kind:"scalar",opt:!0,T:9},{no:7,name:"organization_id",kind:"scalar",opt:!0,T:9},{no:8,name:"location",kind:"message",T:()=>Tw},{no:9,name:"capabilities",kind:"message",T:()=>nm}])}}const Sw=new yw;class Ew extends S{constructor(){super("media.edge.PeerJoinCompleteRequest",[])}}const _w=new Ew;class bw extends S{constructor(){super("media.edge.PeerLeaveRequest",[{no:1,name:"close_room",kind:"scalar",T:8}])}}const ww=new bw;class Pw extends S{constructor(){super("media.edge.ConsumeMultipleProducerRequest",[{no:1,name:"producer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"paused",kind:"scalar",opt:!0,T:8}])}}new Pw;class Cw extends S{constructor(){super("media.edge.ConsumePeerRequest",[{no:1,name:"producing_peer_id",kind:"scalar",T:9},{no:2,name:"paused",kind:"scalar",opt:!0,T:8},{no:3,name:"producer_id",kind:"scalar",opt:!0,T:9},{no:4,name:"preferred_codec",kind:"message",T:()=>gw},{no:5,name:"producing_transport_id",kind:"scalar",opt:!0,T:9}])}}const Rw=new Cw;class kw extends S{constructor(){super("media.edge.ConsumePeersRequest",[{no:1,name:"requests",kind:"message",repeat:1,T:()=>Rw},{no:2,name:"consuming_transport_id",kind:"scalar",opt:!0,T:9}])}}const Iw=new kw;class Aw extends S{constructor(){super("media.edge.ProducerCreateRequest",[{no:1,name:"kind",kind:"scalar",T:9},{no:2,name:"paused",kind:"scalar",T:8},{no:3,name:"screen_share",kind:"scalar",T:8},{no:4,name:"description",kind:"message",T:()=>ls},{no:5,name:"msid",kind:"scalar",T:9},{no:6,name:"app_data",kind:"scalar",opt:!0,T:9},{no:7,name:"mime_type",kind:"scalar",opt:!0,T:9},{no:8,name:"producing_transport_id",kind:"scalar",opt:!0,T:9}])}}const Mw=new Aw;class Dw extends S{constructor(){super("media.edge.SelectedPeersRequest",[])}}new Dw;class Ow extends S{constructor(){super("media.edge.GlobalPeerPinningRequest",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const Nw=new Ow;class Lw extends S{constructor(){super("media.edge.ProducerToggleRequest",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"pause",kind:"scalar",T:8}])}}const kc=new Lw;class xw extends S{constructor(){super("media.edge.ConsumerToggleRequest",[{no:1,name:"consumer_id",kind:"scalar",T:9},{no:2,name:"pause",kind:"scalar",T:8}])}}new xw;class Vw extends S{constructor(){super("media.edge.ProducerCloseRequest",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>ls},{no:3,name:"producing_transport_id",kind:"scalar",opt:!0,T:9}])}}const Uw=new Vw;class Fw extends S{constructor(){super("media.edge.ConsumerCloseRequest",[{no:1,name:"consumer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"description",kind:"message",T:()=>ls},{no:3,name:"consuming_transport_id",kind:"scalar",opt:!0,T:9}])}}const Bw=new Fw;class $w extends S{constructor(){super("media.edge.KickPeerRequest",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const Hw=new $w;class qw extends S{constructor(){super("media.edge.KickAllPeersRequest",[{no:1,name:"propagate_kick_across_rooms",kind:"scalar",T:8}])}}const om=new qw;class jw extends S{constructor(){super("media.edge.PeerDisplayNameEditRequest",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9}])}}const Gw=new jw;class Ww extends S{constructor(){super("media.edge.HostMediaControlForPeerRequest",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"audio",kind:"scalar",T:8},{no:3,name:"video",kind:"scalar",T:8},{no:4,name:"scree_share",kind:"scalar",T:8}])}}const Jw=new Ww;class Kw extends S{constructor(){super("media.edge.HostMediaControlForAllPeerRequest",[{no:1,name:"audio",kind:"scalar",T:8},{no:2,name:"video",kind:"scalar",T:8},{no:3,name:"screen_share",kind:"scalar",T:8}])}}const zw=new Kw;class Yw extends S{constructor(){super("media.edge.GetRoomStateResponse",[{no:1,name:"display_title",kind:"scalar",T:9},{no:2,name:"locked_mode",kind:"scalar",T:8},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"room_name",kind:"scalar",T:9},{no:5,name:"current_peer_id",kind:"scalar",T:9},{no:6,name:"is_recording",kind:"scalar",opt:!0,T:8},{no:7,name:"recorder_participant_id",kind:"scalar",opt:!0,T:9},{no:8,name:"pinned_peer_ids",kind:"scalar",repeat:2,T:9}])}}const Qw=new Yw;class Xw extends S{constructor(){super("media.edge.ErrorResponse",[{no:1,name:"error_message",kind:"scalar",T:9},{no:2,name:"event_id",kind:"scalar",T:5}])}}const Zw=new Xw;class eP extends S{constructor(){super("media.edge.EmptyResponse",[])}}new eP;class tP extends S{constructor(){super("media.edge.RoomParticipants",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"producer_states",kind:"message",repeat:1,T:()=>wa},{no:3,name:"display_name",kind:"scalar",T:9},{no:4,name:"user_id",kind:"scalar",opt:!0,T:9},{no:5,name:"capabilities",kind:"message",T:()=>nm}])}}const cm=new tP;class sP extends S{constructor(){super("media.edge.SelectedPeersResponse",[{no:1,name:"audio_peers",kind:"scalar",repeat:2,T:9},{no:2,name:"compulsory_peers",kind:"scalar",repeat:2,T:9}])}}const wl=new sP;class rP extends S{constructor(){super("media.edge.SelectedPeersDiffEntry",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"priority",kind:"scalar",T:5}])}}const nP=new rP;class iP extends S{constructor(){super("media.edge.SelectedPeersDiffResponse",[{no:1,name:"entries",kind:"message",repeat:1,T:()=>nP}])}}const dm=new iP;class aP extends S{constructor(){super("media.edge.PeerJoinResponse",[])}}new aP;class oP extends S{constructor(){super("media.edge.PeerJoinCompleteResponse",[{no:1,name:"room_state",kind:"message",T:()=>Qw},{no:2,name:"participants",kind:"message",repeat:1,T:()=>cm},{no:3,name:"selected_peers",kind:"message",T:()=>wl},{no:4,name:"max_preferred_streams",kind:"scalar",T:5}])}}const Pl=new oP;class cP extends S{constructor(){super("media.edge.PeerLeaveResponse",[{no:1,name:"closed",kind:"scalar",T:8}])}}const dP=new cP;class lP extends S{constructor(){super("media.edge.ConsumeMultipleProducerResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"consumer_ids_map",kind:"message",T:()=>rm}])}}new lP;class uP extends S{constructor(){super("media.edge.ConsumePeerResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"consumer_ids_map",kind:"message",T:()=>rm},{no:3,name:"description",kind:"message",T:()=>ls}])}}const hP=new uP;class pP extends S{constructor(){super("media.edge.ProducerCreateResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"producer_id",kind:"scalar",T:9},{no:4,name:"description",kind:"message",T:()=>ls}])}}const mP=new pP;class fP extends S{constructor(){super("media.edge.ProducerScoreResponse",[{no:1,name:"responseid",kind:"scalar",T:9},{no:2,name:"score",kind:"message",T:()=>rw}])}}new fP;class gP extends S{constructor(){super("media.edge.ActiveSpeakerResponse",[{no:1,name:"responsepeer_id",kind:"scalar",T:9},{no:2,name:"volume",kind:"scalar",T:5}])}}new gP;class vP extends S{constructor(){super("media.edge.NoActiveSpeakerResponse",[])}}new vP;class TP extends S{constructor(){super("media.edge.ProducerToggleResponse",[])}}new TP;class yP extends S{constructor(){super("media.edge.ConsumerToggleResponse",[])}}new yP;class SP extends S{constructor(){super("media.edge.ProducerClosingResponse",[{no:1,name:"description",kind:"message",T:()=>ls}])}}const EP=new SP;class _P extends S{constructor(){super("media.edge.ConsumerClosingResponse",[{no:1,name:"description",kind:"message",T:()=>ls}])}}new _P;class bP extends S{constructor(){super("media.edge.GlobalPeerPinningResponse",[])}}new bP;class wP extends S{constructor(){super("media.edge.KickPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const PP=new wP;class CP extends S{constructor(){super("media.edge.KickAllPeersResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const RP=new CP;class kP extends S{constructor(){super("media.edge.HostMediaControlForPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const IP=new kP;class AP extends S{constructor(){super("media.edge.HostMediaControlForAllPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const MP=new AP;class DP extends S{constructor(){super("media.edge.PeerDisplayNameEditResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const OP=new DP;class NP extends S{constructor(){super("media.edge.PeerJoinBroadcastResponse",[{no:1,name:"participant",kind:"message",T:()=>cm}])}}const lm=new NP;class LP extends S{constructor(){super("media.edge.TrackSubscriptionKind",[{no:1,name:"audio",kind:"scalar",T:8},{no:2,name:"video",kind:"scalar",T:8}])}}const um=new LP;class xP extends S{constructor(){super("media.edge.TrackSubscription",[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"webcam",kind:"message",T:()=>um},{no:3,name:"screenshare",kind:"message",T:()=>um}])}}const VP=new xP;class UP extends S{constructor(){super("media.edge.PeerProducingTransportCreateBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"transport_details",kind:"message",T:()=>sm},{no:3,name:"track_subscriptions",kind:"message",repeat:1,T:()=>VP}])}}new UP;class FP extends S{constructor(){super("media.edge.PeerProducerCreateBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>wa}])}}const BP=new FP;class $P extends S{constructor(){super("media.edge.PeerProducerToggleBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>wa},{no:3,name:"initiator_participant_id",kind:"scalar",opt:!0,T:9}])}}const hm=new $P;class HP extends S{constructor(){super("media.edge.PeerProducerCloseBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>wa}])}}const qP=new HP;class jP extends S{constructor(){super("media.edge.PeerLeaveBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const Cl=new jP;class GP extends S{constructor(){super("media.edge.GlobalPeerPinningBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const pm=new GP;class WP extends S{constructor(){super("media.edge.GlobalPeerUnPinningBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}new WP;class JP extends S{constructor(){super("media.edge.RecordingStartedBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}new JP;class KP extends S{constructor(){super("media.edge.RecordingStoppedBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}new KP;class zP extends S{constructor(){super("media.edge.PeerDisplayNameEditBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9}])}}new zP;class YP extends S{constructor(){super("media.edge.PeerPingRequestBroadcastResponse",[{no:1,name:"password",kind:"scalar",T:9}])}}new YP;class QP extends S{constructor(){super("media.edge.MediaRoomTerminationBroadcastResponse",[{no:1,name:"reason",kind:"scalar",T:9}])}}new QP;class XP extends S{constructor(){super("socket.ai.MeetingTranscript",[{no:1,name:"meeting_id",kind:"scalar",T:9},{no:2,name:"transcript",kind:"scalar",T:9},{no:3,name:"is_partial",kind:"scalar",T:8}])}}const Rl=new XP;class ZP extends S{constructor(){super("socket.api.BaseSocketHubMessage",[{no:1,name:"event",kind:"scalar",T:5},{no:2,name:"id",kind:"scalar",T:9},{no:3,name:"peer_id",kind:"scalar",T:9},{no:4,name:"room_id",kind:"scalar",T:9},{no:5,name:"user_id",kind:"scalar",T:9},{no:6,name:"payload",kind:"scalar",T:12},{no:7,name:"error",kind:"scalar",opt:!0,T:8},{no:8,name:"sid",kind:"scalar",opt:!0,T:9}])}}new ZP;class eC extends S{constructor(){super("socket.api.ErrorMessage",[{no:1,name:"code",kind:"scalar",opt:!0,T:5},{no:2,name:"message",kind:"scalar",T:9}])}}const tC=new eC;var sn;(function(s){s[s.BROWSER=0]="BROWSER",s[s.TRACK=1]="TRACK",s[s.COMPOSITE=2]="COMPOSITE"})(sn||(sn={}));var Bs;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.ON_STAGE=1]="ON_STAGE",s[s.APPROVED_STAGE=2]="APPROVED_STAGE",s[s.REQUESTED_STAGE=3]="REQUESTED_STAGE",s[s.OFF_STAGE=4]="OFF_STAGE"})(Bs||(Bs={}));var kl;(function(s){s[s.NONE=0]="NONE",s[s.RECORDER=1]="RECORDER",s[s.LIVESTREAMER=2]="LIVESTREAMER"})(kl||(kl={}));var Il;(function(s){s[s.PEERS=0]="PEERS",s[s.ROOMS=1]="ROOMS"})(Il||(Il={}));var Ic;(function(s){s[s.HIVE=0]="HIVE",s[s.CHAT=1]="CHAT",s[s.PING=2]="PING"})(Ic||(Ic={}));class sC extends S{constructor(){super("socket.room.PeerFlags",[{no:1,name:"preset_name",kind:"scalar",T:9},{no:2,name:"recorder_type",kind:"scalar",T:9},{no:3,name:"hidden_participant",kind:"scalar",T:8}])}}const rC=new sC;class nC extends S{constructor(){super("socket.room.Peer",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"display_name",kind:"scalar",T:9},{no:4,name:"stage_type",kind:"enum",opt:!0,T:()=>["socket.room.StageType",Bs,"STAGE_TYPE_"]},{no:5,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:6,name:"preset_id",kind:"scalar",opt:!0,T:9},{no:7,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:8,name:"waitlisted",kind:"scalar",T:8},{no:9,name:"flags",kind:"message",T:()=>rC}])}}const Ac=new nC;class iC extends S{constructor(){super("socket.room.PeerInfoResponse",[{no:1,name:"peer",kind:"message",T:()=>Ac}])}}const Zn=new iC;class aC extends S{constructor(){super("socket.room.PeerStatusUpdate",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"stage_type",kind:"enum",opt:!0,T:()=>["socket.room.StageType",Bs,"STAGE_TYPE_"]}])}}const mm=new aC;class oC extends S{constructor(){super("socket.room.RoomPeersInfoRequest",[{no:1,name:"seach_query",kind:"scalar",T:9},{no:2,name:"limit",kind:"scalar",T:5},{no:3,name:"offset",kind:"scalar",T:5}])}}const cC=new oC;class dC extends S{constructor(){super("socket.room.RoomPeersInfoResponse",[{no:1,name:"peers",kind:"message",repeat:1,T:()=>Ac}])}}const Al=new dC;class lC extends S{constructor(){super("socket.room.RoomPeerCountResponse",[{no:1,name:"count",kind:"scalar",T:4,L:2}])}}const fm=new lC;class uC extends S{constructor(){super("socket.room.Room",[{no:1,name:"room_id",kind:"scalar",T:9},{no:2,name:"title",kind:"scalar",T:9},{no:4,name:"created_at",kind:"scalar",T:4,L:2},{no:5,name:"active_recordings",kind:"message",repeat:1,T:()=>pC},{no:6,name:"room_uuid",kind:"scalar",opt:!0,T:9}])}}const gm=new uC;class hC extends S{constructor(){super("socket.room.ActiveRecording",[{no:1,name:"recording_id",kind:"scalar",T:9},{no:2,name:"recording_type",kind:"enum",T:()=>["common.RecordingType",sn]},{no:3,name:"recording_status",kind:"scalar",T:9}])}}const pC=new hC;class mC extends S{constructor(){super("socket.room.RoomInfoResponse",[{no:1,name:"room",kind:"message",T:()=>gm}])}}const vm=new mC;class fC extends S{constructor(){super("socket.room.GetPeerInfoRequest",[{no:1,name:"peer_id",kind:"scalar",T:9}])}}const Tm=new fC;class gC extends S{constructor(){super("socket.room.UpdatePeerInfoRequest",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9}])}}new gC;class vC extends S{constructor(){super("socket.room.JoinRoomRequest",[{no:1,name:"peer",kind:"message",T:()=>Ac},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"organization_id",kind:"scalar",opt:!0,T:9},{no:5,name:"use_hive",kind:"scalar",opt:!0,T:8},{no:6,name:"preset",kind:"scalar",opt:!0,T:12},{no:7,name:"capabilities",kind:"enum",repeat:1,T:()=>["socket.room.Capabilities",Ic,"CAPABILITIES_"]},{no:8,name:"timestamp",kind:"scalar",opt:!0,T:4,L:2}])}}const TC=new vC;class yC extends S{constructor(){super("socket.room.LeaveRoomRequest",[{no:1,name:"peer",kind:"message",T:()=>Ac},{no:2,name:"timestamp",kind:"scalar",opt:!0,T:4,L:2}])}}const SC=new yC;class EC extends S{constructor(){super("socket.room.UpdateRoomInfoRequest",[{no:1,name:"room",kind:"message",T:()=>gm}])}}new EC;class _C extends S{constructor(){super("socket.room.GetConnectedRoomsDumpRequest",[])}}new _C;class bC extends S{constructor(){super("socket.room.ServiceError",[{no:1,name:"message",kind:"scalar",opt:!0,T:9},{no:2,name:"code",kind:"scalar",opt:!0,T:9}])}}const Ml=new bC;class wC extends S{constructor(){super("socket.room.ConnectedMeetingPeer",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9},{no:3,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:4,name:"preset_id",kind:"scalar",opt:!0,T:9},{no:5,name:"display_picture_url",kind:"scalar",opt:!0,T:9}])}}const PC=new wC;class CC extends S{constructor(){super("socket.room.ConnectedMeetingDump",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9},{no:3,name:"participants",kind:"message",repeat:1,T:()=>PC}])}}const ym=new CC;class RC extends S{constructor(){super("socket.room.GetConnectedRoomsDumpResponse",[{no:1,name:"parent_meeting",kind:"message",T:()=>ym},{no:2,name:"meetings",kind:"message",repeat:1,T:()=>ym}])}}const kC=new RC;class IC extends S{constructor(){super("socket.room.CreateRoomRequestPayload",[{no:1,name:"title",kind:"scalar",opt:!0,T:9}])}}const AC=new IC;class MC extends S{constructor(){super("socket.room.CreateConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>AC}])}}const DC=new MC;class OC extends S{constructor(){super("socket.room.CreateRoomResponsePayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9},{no:3,name:"error",kind:"message",T:()=>Ml}])}}const NC=new OC;class LC extends S{constructor(){super("socket.room.CreateConnectedRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>NC}])}}const Sm=new LC;class xC extends S{constructor(){super("socket.room.UpdateRoomRequestPayload",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9}])}}const VC=new xC;class UC extends S{constructor(){super("socket.room.UpdateConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>VC}])}}new UC;class FC extends S{constructor(){super("socket.room.DisableRoomPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9}])}}const BC=new FC;class $C extends S{constructor(){super("socket.room.DisableConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>BC}])}}const HC=new $C;class qC extends S{constructor(){super("socket.room.DisableConnectedRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>WC}])}}const jC=new qC;class GC extends S{constructor(){super("socket.room.DisableConnectedRoomPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"status",kind:"scalar",opt:!0,T:9},{no:3,name:"title",kind:"scalar",opt:!0,T:9},{no:4,name:"error",kind:"message",T:()=>Ml}])}}const WC=new GC;class JC extends S{constructor(){super("socket.room.MovePeerPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"preset_id",kind:"scalar",opt:!0,T:9}])}}const KC=new JC;class zC extends S{constructor(){super("socket.room.MovePeersBetweenRoomsRequest",[{no:1,name:"source_meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"destination_meeting_id",kind:"scalar",opt:!0,T:9},{no:3,name:"participants",kind:"message",repeat:1,T:()=>KC}])}}const YC=new zC;class QC extends S{constructor(){super("socket.room.MovedPeer",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:3,name:"error",kind:"message",T:()=>Ml}])}}const Em=new QC;class XC extends S{constructor(){super("socket.room.MovePeersBetweenRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>Em}])}}new XC;class ZC extends S{constructor(){super("socket.room.TransferPeer",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"auth_token",kind:"scalar",opt:!0,T:9}])}}const eR=new ZC;class tR extends S{constructor(){super("socket.room.GetAllAddedParticipantsResponse",[{no:1,name:"participants",kind:"message",repeat:1,T:()=>nR}])}}const sR=new tR;class rR extends S{constructor(){super("socket.room.AddedParticipant",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",opt:!0,T:9},{no:3,name:"picture",kind:"scalar",opt:!0,T:9},{no:4,name:"custom_participant_id",kind:"scalar",T:9}])}}const nR=new rR;class iR extends S{constructor(){super("socket.room.RemoveParticipantsRequest",[{no:1,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const aR=new iR;class oR extends S{constructor(){super("socket.room.BroadcastMessage",[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"timestamp",kind:"scalar",T:4,L:2},{no:4,name:"ids",kind:"scalar",repeat:2,T:9},{no:5,name:"broadcast_type",kind:"enum",opt:!0,T:()=>["socket.room.BroadcastType",Il,"BROADCAST_TYPE_"]}])}}const Pa=new oR;class cR extends S{constructor(){super("socket.room.AcceptWaitingRoomRequests",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const dR=new cR;class lR extends S{constructor(){super("socket.room.DenyWaitingRoomRequests",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const uR=new lR;class hR extends S{constructor(){super("socket.room.WaitingRoomRequest",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"display_name",kind:"scalar",T:9},{no:4,name:"picture",kind:"scalar",opt:!0,T:9},{no:5,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:6,name:"preset_name",kind:"scalar",opt:!0,T:9}])}}const pR=new hR;class mR extends S{constructor(){super("socket.room.GetWaitingRoomRequests",[{no:1,name:"requests",kind:"message",repeat:1,T:()=>pR}])}}const _m=new mR;class fR extends S{constructor(){super("socket.room.GetRoomStageStateResponse",[{no:1,name:"on_stage_peers",kind:"scalar",repeat:2,T:9},{no:2,name:"approved_stage_peers",kind:"scalar",repeat:2,T:9},{no:3,name:"requested_stage_peers",kind:"scalar",repeat:2,T:9}])}}const bm=new fR;var Dl;(function(s){s[s.NONE=0]="NONE",s[s.SKIP=1]="SKIP",s[s.ON_PRIVILEGED_USER_ENTRY=2]="ON_PRIVILEGED_USER_ENTRY",s[s.SKIP_ON_ACCEPT=3]="SKIP_ON_ACCEPT"})(Dl||(Dl={}));var mr;(function(s){s[s.NONE=0]="NONE",s[s.ALLOWED=1]="ALLOWED",s[s.NOT_ALLOWED=2]="NOT_ALLOWED",s[s.CAN_REQUEST=3]="CAN_REQUEST"})(mr||(mr={}));class gR extends S{constructor(){super("socket.preset.PollsPermissionUpdate",[{no:1,name:"can_create",kind:"scalar",opt:!0,T:8},{no:2,name:"can_vote",kind:"scalar",opt:!0,T:8},{no:3,name:"can_view",kind:"scalar",opt:!0,T:8}])}}const vR=new gR;class TR extends S{constructor(){super("socket.preset.PluginsPermissionsUpdate",[{no:1,name:"can_close",kind:"scalar",opt:!0,T:8},{no:2,name:"can_start",kind:"scalar",opt:!0,T:8}])}}const yR=new TR;class SR extends S{constructor(){super("socket.preset.PublicChatPermission",[{no:1,name:"can_send",kind:"scalar",opt:!0,T:8},{no:2,name:"text",kind:"scalar",opt:!0,T:8},{no:3,name:"files",kind:"scalar",opt:!0,T:8}])}}const ER=new SR;class _R extends S{constructor(){super("socket.preset.PrivateChatPermission",[{no:1,name:"can_send",kind:"scalar",opt:!0,T:8},{no:2,name:"can_receive",kind:"scalar",opt:!0,T:8},{no:3,name:"text",kind:"scalar",opt:!0,T:8},{no:4,name:"files",kind:"scalar",opt:!0,T:8}])}}const bR=new _R;class wR extends S{constructor(){super("socket.preset.ChatPermissionUpdate",[{no:1,name:"public",kind:"message",T:()=>ER},{no:2,name:"private",kind:"message",T:()=>bR}])}}const PR=new wR;class CR extends S{constructor(){super("socket.preset.ConnectedMeetingPermissionUpdate",[{no:1,name:"can_alter_connected_meetings",kind:"scalar",opt:!0,T:8},{no:2,name:"can_switch_to_parent_meeting",kind:"scalar",opt:!0,T:8},{no:3,name:"can_switch_connected_meetings",kind:"scalar",opt:!0,T:8}])}}const RR=new CR;class kR extends S{constructor(){super("socket.preset.StreamPermission",[{no:1,name:"can_produce",kind:"enum",opt:!0,T:()=>["socket.preset.StreamPermissionType",mr,"STREAM_PERMISSION_TYPE_"]},{no:2,name:"can_consume",kind:"enum",opt:!0,T:()=>["socket.preset.StreamPermissionType",mr,"STREAM_PERMISSION_TYPE_"]}])}}const Ol=new kR;class IR extends S{constructor(){super("socket.preset.MediaPermissionUpdate",[{no:1,name:"video",kind:"message",T:()=>Ol},{no:2,name:"audio",kind:"message",T:()=>Ol},{no:3,name:"screenshare",kind:"message",T:()=>Ol}])}}const AR=new IR;class MR extends S{constructor(){super("socket.preset.PresetUpdates",[{no:1,name:"polls",kind:"message",T:()=>vR},{no:2,name:"plugins",kind:"message",T:()=>yR},{no:3,name:"chat",kind:"message",T:()=>PR},{no:4,name:"accept_waiting_requests",kind:"scalar",opt:!0,T:8},{no:5,name:"can_accept_production_requests",kind:"scalar",opt:!0,T:8},{no:6,name:"can_edit_display_name",kind:"scalar",opt:!0,T:8},{no:7,name:"can_record",kind:"scalar",opt:!0,T:8},{no:8,name:"can_livestream",kind:"scalar",opt:!0,T:8},{no:9,name:"can_spotlight",kind:"scalar",opt:!0,T:8},{no:10,name:"disable_participant_audio",kind:"scalar",opt:!0,T:8},{no:11,name:"disable_participant_screensharing",kind:"scalar",opt:!0,T:8},{no:12,name:"disable_participant_video",kind:"scalar",opt:!0,T:8},{no:13,name:"kick_participant",kind:"scalar",opt:!0,T:8},{no:14,name:"pin_participant",kind:"scalar",opt:!0,T:8},{no:15,name:"transcription_enabled",kind:"scalar",opt:!0,T:8},{no:16,name:"waiting_room_type",kind:"enum",opt:!0,T:()=>["socket.preset.WaitingRoomType",Dl,"WAITING_ROOM_TYPE_"]},{no:17,name:"is_recorder",kind:"scalar",opt:!0,T:8},{no:18,name:"recorder_type",kind:"enum",opt:!0,T:()=>["socket.room.RecorderType",kl,"RECORDER_TYPE_"]},{no:19,name:"hidden_participant",kind:"scalar",opt:!0,T:8},{no:20,name:"show_participant_list",kind:"scalar",opt:!0,T:8},{no:21,name:"can_change_participant_permissions",kind:"scalar",opt:!0,T:8},{no:22,name:"connected_meetings",kind:"message",T:()=>RR},{no:23,name:"media",kind:"message",T:()=>AR}])}}const Nl=new MR;class DR extends S{constructor(){super("socket.preset.ReadPeersPresetRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const OR=new DR;class NR extends S{constructor(){super("socket.preset.PeerPreset",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"peer_id",kind:"scalar",T:9},{no:3,name:"preset",kind:"scalar",T:12}])}}const LR=new NR;class xR extends S{constructor(){super("socket.preset.ReadPeersPresetResponse",[{no:1,name:"peer_presets",kind:"message",repeat:1,T:()=>LR}])}}const VR=new xR;class UR extends S{constructor(){super("socket.preset.UpdatePeerPreset",[{no:1,name:"user_ids",kind:"scalar",T:9},{no:2,name:"patch",kind:"message",T:()=>Nl}])}}const wm=new UR;class FR extends S{constructor(){super("socket.preset.UpdatePeersPresetRequest",[{no:1,name:"update_peers_presets",kind:"message",repeat:1,T:()=>wm}])}}const BR=new FR;class $R extends S{constructor(){super("socket.preset.UpdatePeersPresetResponse",[{no:1,name:"update_peers_presets",kind:"message",repeat:1,T:()=>wm}])}}const Pm=new $R;class HR extends S{constructor(){super("socket.preset.PeerUserIDMap",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9}])}}const qR=new HR;class jR extends S{constructor(){super("socket.preset.BulkUpdatePeerPresetRequest",[{no:1,name:"peers",kind:"message",repeat:1,T:()=>qR},{no:2,name:"patch",kind:"message",T:()=>Nl}])}}new jR;class GR extends S{constructor(){super("socket.preset.BulkUpdatePeerPresetResponse",[{no:2,name:"patch",kind:"message",T:()=>Nl}])}}new GR;class WR extends S{constructor(){super("socket.chat.ChatMessage",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"peer_id",kind:"scalar",T:9},{no:3,name:"user_id",kind:"scalar",T:9},{no:4,name:"display_name",kind:"scalar",T:9},{no:5,name:"pinned",kind:"scalar",T:8},{no:6,name:"is_edited",kind:"scalar",T:8},{no:7,name:"payload_type",kind:"scalar",T:5},{no:8,name:"payload",kind:"scalar",T:9},{no:10,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:11,name:"created_at",kind:"scalar",T:4,L:2},{no:12,name:"created_at_ms",kind:"scalar",opt:!0,T:4,L:2},{no:13,name:"channel_id",kind:"scalar",opt:!0,T:9},{no:14,name:"channel_index",kind:"scalar",opt:!0,T:9}])}}const rn=new WR;class JR extends S{constructor(){super("socket.chat.GetPaginatedChatMessageRoomRequest",[{no:1,name:"time_stamp",kind:"scalar",T:4,L:2},{no:2,name:"size",kind:"scalar",T:5},{no:3,name:"from",kind:"scalar",T:5},{no:4,name:"reversed",kind:"scalar",T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const KR=new JR;class zR extends S{constructor(){super("socket.chat.GetPaginatedChatMessageRoomResponse",[{no:1,name:"messages",kind:"message",repeat:1,T:()=>rn},{no:2,name:"next",kind:"scalar",T:8}])}}const YR=new zR;class QR extends S{constructor(){super("socket.chat.GetChatMessagesResponse",[{no:1,name:"messages",kind:"message",repeat:1,T:()=>rn}])}}const Cm=new QR;class XR extends S{constructor(){super("socket.chat.SendChatMessageToRoomRequest",[{no:1,name:"payload_type",kind:"scalar",T:5},{no:2,name:"payload",kind:"scalar",T:9}])}}const ZR=new XR;class ek extends S{constructor(){super("socket.chat.SendChatMessageToRoomResponse",[{no:1,name:"message",kind:"message",T:()=>rn}])}}const Ll=new ek;class tk extends S{constructor(){super("socket.chat.SendChatMessageToPeersRequest",[{no:1,name:"peer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"payload_type",kind:"scalar",T:5},{no:3,name:"payload",kind:"scalar",T:9}])}}const sk=new tk;class rk extends S{constructor(){super("socket.chat.SendChatMessageToPeersResponse",[{no:1,name:"message",kind:"message",T:()=>rn}])}}const xl=new rk;class nk extends S{constructor(){super("socket.chat.SendChatMessageToChannelRequest",[{no:1,name:"channel_id",kind:"scalar",T:9},{no:2,name:"payload_type",kind:"scalar",T:5},{no:3,name:"payload",kind:"scalar",T:9}])}}const ik=new nk;class ak extends S{constructor(){super("socket.chat.SendChatMessageToChannelResponse",[{no:1,name:"message",kind:"message",T:()=>rn}])}}new ak;class ok extends S{constructor(){super("socket.chat.EditChatMessageRequest",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"payload_type",kind:"scalar",opt:!0,T:5},{no:3,name:"payload",kind:"scalar",opt:!0,T:9},{no:4,name:"pinned",kind:"scalar",opt:!0,T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const ck=new ok;class dk extends S{constructor(){super("socket.chat.PinChatMessageRequest",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"pinned",kind:"scalar",T:8},{no:3,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const lk=new dk;class uk extends S{constructor(){super("socket.chat.PinChatMessageResponse",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"pinned",kind:"scalar",T:8},{no:3,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const Mc=new uk;class hk extends S{constructor(){super("socket.chat.EditChatMessageResponse",[{no:1,name:"message",kind:"message",T:()=>rn}])}}const Dc=new hk;class pk extends S{constructor(){super("socket.chat.DeleteChatMessageRequest",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const mk=new pk;class fk extends S{constructor(){super("socket.chat.DeleteChatMessageResponse",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const Oc=new fk;class gk extends S{constructor(){super("socket.chat.SearchChatMessagesRequest",[{no:1,name:"time_stamp",kind:"scalar",T:4,L:2},{no:2,name:"size",kind:"scalar",T:5},{no:3,name:"from",kind:"scalar",T:5},{no:4,name:"reversed",kind:"scalar",T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9},{no:6,name:"search_term",kind:"scalar",T:9}])}}const vk=new gk;class Tk extends S{constructor(){super("socket.chat.MarkChannelIndexAsReadRequest",[{no:1,name:"channel_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"channel_index",kind:"scalar",T:9}])}}const yk=new Tk;class Sk extends S{constructor(){super("socket.chat.MarkChannelIndexAsReadResponse",[{no:1,name:"channel_index",kind:"scalar",T:9}])}}const Ek=new Sk;class _k extends S{constructor(){super("socket.chat.CreateChatChannelRequest",[{no:1,name:"display_name",kind:"scalar",T:9},{no:2,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:3,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:4,name:"visibility",kind:"scalar",T:9},{no:5,name:"is_direct_message",kind:"scalar",T:8}])}}const bk=new _k;class wk extends S{constructor(){super("socket.chat.UpdateChatChannelRequest",[{no:1,name:"chat_channel_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9},{no:3,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:4,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:5,name:"visibility",kind:"scalar",opt:!0,T:9},{no:6,name:"is_direct_message",kind:"scalar",opt:!0,T:8}])}}const Pk=new wk;class Ck extends S{constructor(){super("socket.chat.CreateChatChannelResponse",[{no:1,name:"chat_channel_id",kind:"scalar",T:9}])}}new Ck;class Rk extends S{constructor(){super("socket.chat.GetChatChannelRequest",[{no:1,name:"chat_channel_id",kind:"scalar",T:9}])}}const kk=new Rk;class Ik extends S{constructor(){super("socket.chat.LatestMessageAndUnreadCount",[{no:1,name:"message",kind:"message",T:()=>rn},{no:2,name:"unread_count",kind:"scalar",T:4,L:2}])}}const Ak=new Ik;class Mk extends S{constructor(){super("socket.chat.ChatChannel",[{no:1,name:"chat_channel_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9},{no:3,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:4,name:"visibility",kind:"scalar",T:9},{no:5,name:"is_direct_message",kind:"scalar",T:8},{no:6,name:"latest_message_and_unread_count",kind:"message",T:()=>Ak},{no:7,name:"target_user_ids",kind:"scalar",repeat:2,T:9}])}}const Dk=new Mk;class Ok extends S{constructor(){super("socket.chat.GetChatChannelResponse",[{no:1,name:"chat_channels",kind:"message",repeat:1,T:()=>Dk}])}}const $s=new Ok;class Nk extends S{constructor(){super("socket.chat.ChannelMember",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",opt:!0,T:9},{no:3,name:"picture",kind:"scalar",opt:!0,T:9},{no:4,name:"custom_participant_id",kind:"scalar",T:9}])}}const Lk=new Nk;class xk extends S{constructor(){super("socket.chat.GetChatChannelMembersResponse",[{no:1,name:"channel_members",kind:"message",repeat:1,T:()=>Lk}])}}const Vk=new xk;class Uk extends S{constructor(){super("socket.plugin.AddPluginRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"staggered",kind:"scalar",T:8}])}}const Fk=new Uk;class Bk extends S{constructor(){super("socket.plugin.RemovePluginRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"staggered",kind:"scalar",T:8}])}}const $k=new Bk;class Hk extends S{constructor(){super("socket.plugin.EnablePluginForRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9}])}}const qk=new Hk;class jk extends S{constructor(){super("socket.plugin.DisablePluginForRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9}])}}const Gk=new jk;class Wk extends S{constructor(){super("socket.plugin.EnablePluginForPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const Jk=new Wk;class Kk extends S{constructor(){super("socket.plugin.DisablePluginForPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const zk=new Kk;class Yk extends S{constructor(){super("socket.plugin.PluginEventToRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"plugin_data",kind:"scalar",T:12}])}}const Qk=new Yk;class Xk extends S{constructor(){super("socket.plugin.PluginEventToPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9},{no:3,name:"plugin_data",kind:"scalar",T:12}])}}const Zk=new Xk;class eI extends S{constructor(){super("socket.plugin.StoreKeys",[{no:1,name:"store_key",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",opt:!0,T:12}])}}const Vl=new eI;class tI extends S{constructor(){super("socket.plugin.PluginStoreInsertKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"insert_keys",kind:"message",repeat:1,T:()=>Vl}])}}const Rm=new tI;class sI extends S{constructor(){super("socket.plugin.PluginStoreGetKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"get_keys",kind:"message",repeat:1,T:()=>Vl}])}}const rI=new sI;class nI extends S{constructor(){super("socket.plugin.PluginStoreDeleteKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"delete_keys",kind:"message",repeat:1,T:()=>Vl}])}}const iI=new nI;class aI extends S{constructor(){super("socket.plugin.PluginStoreDeleteRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9}])}}const oI=new aI;class cI extends S{constructor(){super("socket.plugin.EnablePluginResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"enabled_by",kind:"scalar",T:9}])}}const Ul=new cI;class dI extends S{constructor(){super("socket.plugin.EnablePluginsResponse",[{no:1,name:"plugins",kind:"message",repeat:1,T:()=>Ul}])}}const lI=new dI;class uI extends S{constructor(){super("socket.plugin.DisablePluginResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"disabled_by",kind:"scalar",T:9}])}}const km=new uI;class hI extends S{constructor(){super("socket.plugin.PluginStoreItem",[{no:1,name:"timestamp",kind:"scalar",T:9},{no:2,name:"peer_id",kind:"scalar",T:9},{no:3,name:"store_key",kind:"scalar",T:9},{no:4,name:"payload",kind:"scalar",T:12}])}}const pI=new hI;class mI extends S{constructor(){super("socket.plugin.PluginStoreResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"store_items",kind:"message",repeat:1,T:()=>pI}])}}const Im=new mI;class fI extends S{constructor(){super("socket.plugin.PluginEventResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"plugin_data",kind:"scalar",T:12}])}}const Am=new fI;class gI extends S{constructor(){super("socket.livestreaming.LiveStreamingEvent",[{no:1,name:"livestream_id",kind:"scalar",T:9},{no:2,name:"err_message",kind:"scalar",T:9},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"meeting_id",kind:"scalar",T:9},{no:5,name:"playback_url",kind:"scalar",T:9},{no:6,name:"org_id",kind:"scalar",T:9},{no:7,name:"room_name",kind:"scalar",T:9},{no:8,name:"room_uuid",kind:"scalar",T:9},{no:9,name:"status",kind:"scalar",T:9},{no:10,name:"manual_ingest",kind:"scalar",opt:!0,T:8}])}}const Mm=new gI;class vI extends S{constructor(){super("socket.livestreaming.GetStagePeersResponse",[{no:1,name:"stage_peers",kind:"scalar",repeat:2,T:9}])}}const Dm=new vI;class TI extends S{constructor(){super("socket.livestreaming.StageRequest",[{no:1,name:"display_name",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"peer_id",kind:"scalar",T:9}])}}const yI=new TI;class SI extends S{constructor(){super("socket.livestreaming.GetStageRequestsResponse",[{no:1,name:"stage_requests",kind:"message",repeat:1,T:()=>yI}])}}const Fl=new SI;class EI extends S{constructor(){super("socket.livestreaming.GrantStageAccessRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const _I=new EI;class bI extends S{constructor(){super("socket.livestreaming.DenyStageAccessRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const wI=new bI;class PI extends S{constructor(){super("socket.livestreaming.LeaveStageRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const Om=new PI;class CI extends S{constructor(){super("socket.polls.Poll",[{no:1,name:"poll_id",kind:"scalar",T:9},{no:2,name:"created_by",kind:"scalar",T:9},{no:3,name:"created_by_user_id",kind:"scalar",T:9},{no:4,name:"question",kind:"scalar",T:9},{no:5,name:"options",kind:"message",repeat:1,T:()=>kI},{no:6,name:"hide_votes",kind:"scalar",T:8},{no:7,name:"anonymous",kind:"scalar",T:8},{no:8,name:"votes",kind:"scalar",repeat:2,T:9}])}}const Nm=new CI;class RI extends S{constructor(){super("socket.polls.PollOption",[{no:1,name:"text",kind:"scalar",T:9},{no:2,name:"count",kind:"scalar",opt:!0,T:4,L:2},{no:3,name:"votes",kind:"message",repeat:1,T:()=>AI}])}}const kI=new RI;class II extends S{constructor(){super("socket.polls.PollVote",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9}])}}const AI=new II;class MI extends S{constructor(){super("socket.polls.NewPollRequest",[{no:1,name:"question",kind:"scalar",T:9},{no:2,name:"options",kind:"scalar",repeat:2,T:9},{no:3,name:"anonymous",kind:"scalar",T:8},{no:4,name:"hide_votes",kind:"scalar",T:8},{no:5,name:"created_by",kind:"scalar",opt:!0,T:9},{no:6,name:"created_by_user_id",kind:"scalar",opt:!0,T:9}])}}const DI=new MI;class OI extends S{constructor(){super("socket.polls.VotePollRequest",[{no:1,name:"poll_id",kind:"scalar",T:9},{no:2,name:"index",kind:"scalar",T:4,L:2}])}}const NI=new OI;class LI extends S{constructor(){super("socket.polls.UpdatePollResponse",[{no:1,name:"poll",kind:"message",T:()=>Nm}])}}const Bl=new LI;class xI extends S{constructor(){super("socket.polls.GetPollsResponse",[{no:1,name:"polls",kind:"message",repeat:1,T:()=>Nm}])}}const VI=new xI;class UI extends S{constructor(){super("socket.recording.RecordingEvent",[{no:1,name:"recording_id",kind:"scalar",T:9},{no:2,name:"err_message",kind:"scalar",T:9},{no:3,name:"recording_type",kind:"enum",T:()=>["common.RecordingType",sn]}])}}const Lm=new UI;class FI extends S{constructor(){super("google.protobuf.Timestamp",[{no:1,name:"seconds",kind:"scalar",T:3,L:0},{no:2,name:"nanos",kind:"scalar",T:5}])}now(){const t=this.create(),e=Date.now();return t.seconds=Se.from(Math.floor(e/1e3)).toBigInt(),t.nanos=e%1e3*1e6,t}toDate(t){return new Date(Se.from(t.seconds).toNumber()*1e3+Math.ceil(t.nanos/1e6))}fromDate(t){const e=this.create(),r=t.getTime();return e.seconds=Se.from(Math.floor(r/1e3)).toBigInt(),e.nanos=r%1e3*1e6,e}internalJsonWrite(t,e){let r=Se.from(t.seconds).toNumber()*1e3;if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("Unable to encode Timestamp to JSON. Must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive.");if(t.nanos<0)throw new Error("Unable to encode invalid Timestamp to JSON. Nanos must not be negative.");let n="Z";if(t.nanos>0){let i=(t.nanos+1e9).toString().substring(1);i.substring(3)==="000000"?n="."+i.substring(0,3)+"Z":i.substring(6)==="000"?n="."+i.substring(0,6)+"Z":n="."+i+"Z"}return new Date(r).toISOString().replace(".000Z",n)}internalJsonRead(t,e,r){if(typeof t!="string")throw new Error("Unable to parse Timestamp from JSON "+Tl(t)+".");let n=t.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!n)throw new Error("Unable to parse Timestamp from JSON. Invalid format.");let i=Date.parse(n[1]+"-"+n[2]+"-"+n[3]+"T"+n[4]+":"+n[5]+":"+n[6]+(n[8]?n[8]:"Z"));if(Number.isNaN(i))throw new Error("Unable to parse Timestamp from JSON. Invalid value.");if(i<Date.parse("0001-01-01T00:00:00Z")||i>Date.parse("9999-12-31T23:59:59Z"))throw new globalThis.Error("Unable to parse Timestamp from JSON. Must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive.");return r||(r=this.create()),r.seconds=Se.from(i/1e3).toBigInt(),r.nanos=0,n[7]&&(r.nanos=parseInt("1"+n[7]+"0".repeat(9-n[7].length))-1e9),r}}new FI;class BI extends S{constructor(){super("common.BaseHubMessage",[{no:1,name:"event",kind:"scalar",T:5},{no:2,name:"id",kind:"scalar",T:9},{no:3,name:"peer_id",kind:"scalar",T:9},{no:4,name:"room_id",kind:"scalar",T:9},{no:5,name:"user_id",kind:"scalar",T:9},{no:6,name:"payload",kind:"scalar",T:12},{no:7,name:"error",kind:"scalar",opt:!0,T:8},{no:8,name:"sid",kind:"scalar",opt:!0,T:9},{no:9,name:"room_object_id",kind:"scalar",opt:!0,T:9},{no:10,name:"preset",kind:"scalar",opt:!0,T:9}])}}const $l=new BI;class $I extends S{constructor(){super("common.BulkedHubMessage",[{no:1,name:"messages",kind:"message",repeat:1,T:()=>$l}])}}new $I;class HI extends S{constructor(){super("common.CFWorkersResponse",[{no:1,name:"response",kind:"message",T:()=>$l},{no:2,name:"broadcast_responses",kind:"message",repeat:1,T:()=>$l}])}}new HI;const qI=0,jI=1,GI=2,WI=3,JI=4,KI=5,zI={getPeerInfo:0,updatePeerInfo:1,getRoomPeersInfo:2,joinRoom:3,leaveRoom:4,getRoomInfo:5,updateRoomInfo:6,closeRoom:7,startedLivestream:8,stoppedLivestream:9,erroredLivestream:10,getStagePeers:11,getStageRequests:12,requestStageAccess:13,cancelStageRequest:14,grantStageAccess:15,denyStageAccess:16,roomPeerCount:17,joinStage:18,leaveStage:19,getConnectedRoomsDump:20,createConnectedRooms:21,deleteConnectedRooms:22,movePeers:23,transferPeer:24,movedPeer:25,connectedRoomsUpdated:26,connectedRoomsDeleted:27,getAllAddedParticipants:28,broadcastMessage:29,kick:30,kickAll:31,transcript:32,getWaitingRoomRequests:33,acceptWaitingRoomRequests:34,waitingRoomRequestAccepted:35,denyWaitingRoomRequests:36,waitingRoomRequestDenied:37,peerStageStatusUpdate:38,broadcastToEntity:39,recordingStarted:40,recordingStopped:41,recordingPaused:42,getRoomStageState:43,livestreamingInvoked:44},YI={getMessages:0,sendMessageToRoom:1,sendMessageToPeers:2,editMessage:3,deleteMessage:4,getPaginatedMessages:5,sendMessageToChannel:6,searchChannelMessages:7,getAllChatChannels:8,markChannelIndexAsRead:9,pinMessage:10},QI={getPlugins:0,addPlugin:1,enablePluginForRoom:2,disablePluginForPeers:3,enablePluginForPeers:4,disablePluginForRoom:5,removePlugin:6,customPluginEventToRoom:7,customPluginEventToPeers:8,storeInsertKeys:9,storeGetKeys:10,storeDeleteKeys:11,storeDelete:12},XI={createPoll:0,getPolls:1,votePoll:2,updatePoll:3},xm={unknown:0,createWebRTCTransport:1,produce:2,consume:3,toggleProducer:4,toggleConsumer:5,closeProducer:6,closeConsumer:7,joinRoom:16,leaveRoom:17,selectedPeer:18,globalPinPeer:19,selfJoinComplete:20,peerJoinedBroadcast:25,peerLeaveBroadcast:26,peerProducerCreateBroadcast:27,peerProducerToggleBroadcast:28,peerProducerCloseBroadcast:29,globalPeerPinBroadcast:30,recordingStartedBroadcast:31,recordingStoppedBroadcast:32,peerDisplayNameEditBroadcast:33,mediaRoomTerminationBroadcastResponse:36,selectedPeerDiff:40,renegotiateSessionDescription:50,errorResponse:60,kickPeer:90,kickAll:91,changeDisplayName:92,hostControlPeer:93,hostControlAllPeers:94},ZI={createChatChannel:0,getChatChannel:1,deprecatedGetAllChatChannels:2,getChannelMembers:3,updateChatChannel:4},eA={getUserPresets:0,updateUserPreset:1};function ei(s,t){return Object.keys(t).reduce((e,r)=>(e[r]=(s<<16)+t[r],e),{})}function Vm(s,t){return Object.keys(s).reduce((e,r)=>(e[r]=t|s[r],e),{})}const V=ei(qI,zI),Me=ei(jI,YI),W=ei(GI,QI),Hs=ei(WI,XI),nn=ei(JI,ZI),Kt=Vm(xm,16777216),us=Vm(xm,50331648),Nc=ei(KI,eA);var tA=Object.defineProperty,sA=Object.getOwnPropertyDescriptor,Hl=(s,t,e,r)=>{for(var n=r>1?void 0:r?sA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&tA(t,e,n),n};const ql=(zf=class{constructor(s){g(this,Rr,void 0);v(this,Rr,s)}async createChannel(s,t,e,r="public",n=!1){const i={displayName:s,targetUserIds:t,displayPictureUrl:e,visibility:r,isDirectMessage:n};n&&(i.visibility="private");const a=await o(this,Rr).sendMessagePromise(nn.createChatChannel,bk.toBinary(i)),c=$s.fromBinary(a.payload).chatChannels;return ql.formatChannel(c[0])}async updateChannel(s,t){const e=await o(this,Rr).sendMessagePromise(nn.updateChatChannel,Pk.toBinary({chatChannelId:s,targetUserIds:t.memberIds,displayName:t.displayName,displayPictureUrl:t.displayPictureUrl,visibility:t.visibility})),r=$s.fromBinary(e.payload).chatChannels;return ql.formatChannel(r[0])}static formatChannel(s){var r;const{latestMessageAndUnreadCount:t}=s,e={...s,id:s.chatChannelId,memberIds:s.targetUserIds,unreadCount:(r=t==null?void 0:t.unreadCount)!=null?r:0};return t!=null&&t.message&&(e.latestMessage=ms.formatSocketServiceMessage(t.message)),delete e.chatChannelId,delete e.targetUserIds,delete e.latestMessageAndUnreadCount,e}async getChannelMembers(s){try{const t=await o(this,Rr).sendMessagePromise(nn.getChannelMembers,kk.toBinary({chatChannelId:s}));return Vk.fromBinary(t.payload).channelMembers.map(({id:e,...r})=>({...r,userId:e}))}catch(t){return[]}}on(s,t){let e,r;switch(s){case nn.createChatChannel:{e=$s.fromBinary.bind($s),r=$s.create();break}case nn.updateChatChannel:{e=$s.fromBinary.bind($s),r=$s.create();break}}if(!e){u.warn(`ChatChannelSocketHandler::Event ${s} is not recognized`);return}o(this,Rr).on(s,({payload:n})=>{let i=r;try{i=e(n)}catch(a){u.error("ChatChannelSocketHandler::on::binary_decode_error",{error:a})}return t(i)})}},Rr=new WeakMap,zf);let an=ql;Hl([T.trace("ChatChannelHandler.createChannel")],an.prototype,"createChannel",1),Hl([T.trace("ChatChannelHandler.updateChannel")],an.prototype,"updateChannel",1),Hl([T.trace("ChatChannelHandler.getChannelMembers")],an.prototype,"getChannelMembers",1);var rA=Object.defineProperty,nA=Object.getOwnPropertyDescriptor,hs=(s,t,e,r)=>{for(var n=r>1?void 0:r?nA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&rA(t,e,n),n},Et=(s=>(s[s.TEXT=0]="TEXT",s[s.IMAGE=1]="IMAGE",s[s.FILE=2]="FILE",s[s.CUSTOM=3]="CUSTOM",s))(Et||{});class zt{constructor(t){g(this,mt,void 0);v(this,mt,t)}getChatMessages(){return o(this,mt).sendMessagePromise(Me.getMessages)}async getChatMessagesPaginated(t,e,r,n=0,i=""){const a={timeStamp:t,size:e,from:n,reversed:r,channelId:i},c=await o(this,mt).sendMessagePromise(Me.getPaginatedMessages,KR.toBinary(a));return c.payload?YR.fromBinary(c.payload):{messages:[],next:!1}}sendMessageToRoom(t,e){const r={payloadType:e,payload:t};o(this,mt).sendMessage(Me.sendMessageToRoom,ZR.toBinary(r))}sendMessageToPeers(t,e,r){const n={payloadType:e,peerIds:r,payload:t};o(this,mt).sendMessage(Me.sendMessageToPeers,sk.toBinary(n))}sendMessageToChannel(t,e,r){const n={payloadType:e,channelId:r,payload:t};o(this,mt).sendMessage(Me.sendMessageToChannel,ik.toBinary(n))}sendMessage(t,e,r,n){if(n&&this.sendMessageToChannel(t,e,n),r&&r.length>0){this.sendMessageToPeers(t,e,r);return}this.sendMessageToRoom(t,e)}async editMessage(t,e,r,n,i){const a={chatId:t,payloadType:r,payload:e};n&&(a.channelId=n),i!==void 0&&(a.pinned=i);const c=await o(this,mt).sendMessagePromise(Me.editMessage,ck.toBinary(a));return Dc.fromBinary(c.payload).message}async deleteMessage(t,e){const r={chatId:t};e&&(r.channelId=e);const n=await o(this,mt).sendMessagePromise(Me.deleteMessage,mk.toBinary(r)),i=Oc.fromBinary(n.payload);return{id:i.chatId,...i.channelId?{channelId:i.channelId}:{}}}async searchMessages(t,e){var n,i,a;const r={searchTerm:t,timeStamp:(n=e.timestamp)!=null?n:Date.now(),size:(i=e.size)!=null?i:75,from:0,reversed:(a=e.reversed)!=null?a:!0};e.channelId&&(r.channelId=e.channelId);try{const c=await o(this,mt).sendMessagePromise(Me.searchChannelMessages,vk.toBinary(r));return Cm.fromBinary(c.payload).messages}catch(c){return[]}}async getAllChannels(){try{const t=await o(this,mt).sendMessagePromise(Me.getAllChatChannels);return $s.fromBinary(t.payload).chatChannels.map(an.formatChannel)}catch(t){return[]}}async markLastReadMessage(t,e){const r=await o(this,mt).sendMessagePromise(Me.markChannelIndexAsRead,yk.toBinary({channelId:t,userId:e.userId,channelIndex:e.channelIndex}));return Ek.fromBinary(r.payload).channelIndex}async setPinState(t,e){const r={chatId:t.id,pinned:e,channelId:t.channelId},n=await o(this,mt).sendMessagePromise(Me.pinMessage,lk.toBinary(r));return Mc.fromBinary(n.payload)}on(t,e){let r,n;switch(t){case Me.sendMessageToRoom:{r=Ll.fromBinary.bind(Ll),n=Ll.create();break}case Me.sendMessageToPeers:{r=xl.fromBinary.bind(xl),n=xl.create();break}case Me.editMessage:{r=Dc.fromBinary.bind(Dc),n=Dc.create();break}case Me.pinMessage:{r=Mc.fromBinary.bind(Mc),n=Mc.create();break}case Me.deleteMessage:{r=Oc.fromBinary.bind(Oc),n=Oc.create();break}}if(!r){u.warn(`ChatSocketHandler::Event ${t} is not recognized`);return}o(this,mt).on(t,({payload:i})=>{let a=n;try{a=r(i)}catch(c){u.error("chatSocketHandler::on::binary_decode_error",{error:c})}return e(a)})}}mt=new WeakMap,hs([T.trace("SocketService.getChatMessages")],zt.prototype,"getChatMessages",1),hs([T.trace("SocketService.getChatMessagesPaginated")],zt.prototype,"getChatMessagesPaginated",1),hs([T.trace("SocketService.sendMessageToRoom")],zt.prototype,"sendMessageToRoom",1),hs([T.trace("SocketService.sendMessageToPeers")],zt.prototype,"sendMessageToPeers",1),hs([T.trace("SocketService.sendMessageToChannel")],zt.prototype,"sendMessageToChannel",1),hs([T.trace("SocketService.sendMessage")],zt.prototype,"sendMessage",1),hs([T.trace("SocketService.editMessage")],zt.prototype,"editMessage",1),hs([T.trace("SocketService.deleteMessage")],zt.prototype,"deleteMessage",1),hs([T.trace("SocketService.searchMessages")],zt.prototype,"searchMessages",1),hs([T.trace("SocketService.getAllChannels")],zt.prototype,"getAllChannels",1),hs([T.trace("SocketService.markLastReadMessage")],zt.prototype,"markLastReadMessage",1);function iA(s){return s.replace(/([-_]\w)/g,t=>t[1].toUpperCase())}function ps(s){if(!s||typeof s!="object")return s;if(Array.isArray(s))return s.map(e=>ps(e));const t={};return Object.keys(s).forEach(e=>{const r=Jd(e)?e:iA(e);t[r]=ps(s[e])}),t}function aA(s){return s.replace(/[A-Z]/g,t=>`_${t.toLowerCase()}`)}function Um(s){if(!s||typeof s!="object")return s;if(Array.isArray(s))return s.map(e=>Um(e));const t={};return Object.keys(s).forEach(e=>{const r=Jd(e)?e:aA(e);t[r]=s[e]}),t}function Lc(s,t={}){return s==null?{}:(Object.getOwnPropertyNames(s).forEach(e=>{if(typeof s[e]!="function"){if(typeof s[e]=="object"){Lc(s[e],t[e]={});return}t[e]=s[e]}}),t)}class Fm{constructor(t){p(this,"defaults");this.defaults={baseURL:t.baseURL,headers:{common:{}},timeout:t.timeout,retry:t.retry,retryDelay:t.retryDelay}}buildURL(t,e){const{baseURL:r}=this.defaults,n=t.startsWith("http")?t:`${r}${t.startsWith("/")?t:`/${t}`}`;if(e){const i=new URLSearchParams;return Object.entries(e).forEach(([a,c])=>{i.append(a,c)}),`${n}${n.includes("?")?"&":"?"}${i.toString()}`}return n}async request(t){var l;const e=((l=t.method)==null?void 0:l.toUpperCase())||"GET",r=this.buildURL(t.url||"",t.params),n={...this.defaults.headers.common,...t.headers};e!=="GET"&&e!=="HEAD"&&t.data&&!n["Content-Type"]&&(n["Content-Type"]="application/json");const i={method:e,headers:n,body:e!=="GET"&&e!=="HEAD"&&t.data?JSON.stringify(t.data):void 0},a=t.timeout||this.defaults.timeout,c=t.retry!==void 0?t.retry:this.defaults.retry,d=t.retryDelay||this.defaults.retryDelay;try{const h=new AbortController,m=setTimeout(()=>h.abort(),a);i.signal=h.signal;const f=await fetch(r,i);clearTimeout(m);let y=null;const _=f.headers.get("content-type");_&&_.includes("application/json")?y=await f.json():y=await f.text();const b={};f.headers.forEach((L,B)=>{b[B]=L});const I={data:y,status:f.status,statusText:f.statusText,headers:b,config:t};if(!f.ok)throw I;return I}catch(h){if(h instanceof Error&&c>0)return await new Promise(m=>setTimeout(m,d)),this.defaults.baseURL==="https://api.dyte.io"?this.defaults.baseURL="https://api.cluster.dyte.in":this.defaults.baseURL==="https://api.cluster.dyte.in"&&(this.defaults.baseURL="https://api.dyte.io"),this.request({...t,retry:c-1});throw h}}async get(t,e={}){return this.request({...e,method:"GET",url:t})}async post(t,e,r={}){return this.request({...r,method:"POST",url:t,data:e})}async put(t,e,r={}){return this.request({...r,method:"PUT",url:t,data:e})}}const oA=3,cA=30,dA=8e3;class lA{constructor(t,e){p(this,"ipInfo");p(this,"fetchClient");p(this,"requests");p(this,"roomName");p(this,"roomUUID");p(this,"authToken");p(this,"organizationId");p(this,"iceServers");p(this,"pluginInformation");p(this,"userDetails");p(this,"roomDetails");p(this,"context");this.context=t;const{timeout:r=dA,retry:n=oA,retryDelay:i=cA,baseURL:a="https://api.dyte.io",authToken:c,cachedUserDetails:d}=e||{};this.iceServers=d==null?void 0:d.iceServers,this.pluginInformation=d==null?void 0:d.pluginInformation,this.userDetails=d==null?void 0:d.userDetails,this.roomDetails=d==null?void 0:d.roomDetails,this.requests=new Fm({baseURL:a,timeout:r,retry:n,retryDelay:i,responseType:"json"}),this.fetchClient=new Fm({baseURL:"",timeout:r,retry:n,retryDelay:i,responseType:"json"}),this.setAuthToken(c,{bearer:!0});const l=this.requests.request.bind(this.requests);this.requests.request=async h=>{var m,f,y,_,b;try{T.injectContext(this.requests.defaults.headers.common);const I=await l(h);return h.url!==T.logsEndpoint&&u.debug("xhr::fetch",{networkCall:{status:I.status,statusText:I.statusText,baseURL:h.baseURL||this.requests.defaults.baseURL,url:h.url,method:h.method}}),I}catch(I){throw I?(((m=I.config)==null?void 0:m.url)!==T.logsEndpoint&&u.error("xhr::fetch",{error:I,networkCall:{status:I.status,statusText:I.statusText,baseURL:((f=I.config)==null?void 0:f.baseURL)||this.requests.defaults.baseURL,url:(y=I.config)==null?void 0:y.url,retries:(_=I.config)==null?void 0:_.retry,method:(b=I.config)==null?void 0:b.method,isOnline:navigator.onLine?"online":"offline"}}),new P(I.message||"Network request failed","0011")):new P("Unknown network error occurred","0011")}}}get peerId(){return this.context.getValue("peerId")}setAuthToken(t,e){const{bearer:r}=e||{};this.authToken=t,this.requests.defaults.headers.common.Authorization=r?`Bearer ${t}`:t}setHeader(t,e){this.requests.defaults.headers.common[t]=e}setRoomName(t){this.roomName=t}setRoomUUID(t){this.roomUUID=t}setOrganizationId(t){this.organizationId=t}}var uA=Object.defineProperty,hA=Object.getOwnPropertyDescriptor,Yt=(s,t,e,r)=>{for(var n=r>1?void 0:r?hA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&uA(t,e,n),n};class Bt extends lA{constructor(t,e){super(t,e),this.setHeader("x-dyte-web-core-version",t.getValue("sdkVersion"))}async getIPDetails(){var e;const{peerId:t}=this;try{const r=await Wd.getIPDetails({peerId:t,apiHostnames:Up(this.context),logger:u});if(u.log("ipInfo",{ipInfo:r}),((e=r==null?void 0:r.loc)==null?void 0:e.length)>5)return r;throw Error("Insufficient data")}catch(r){u.warn("ApiClient.getRoomNodeLinkAndTitleV1 Failed to get ip details",{error:{name:r.name,message:r.message}});return}}async getICEServers(){if(this.iceServers)return this.iceServers;const{success:t,iceServers:e}=(await this.requests.get("/iceservers")).data;if(t)return(e==null?void 0:e.length)>0&&(this.iceServers=e),e}async getPlugins(){var n,i,a,c,d,l,h;if(this.pluginInformation)return this.pluginInformation;const{plugins:t}=(await this.requests.get("/v2/plugins/user")).data.data,e=((i=(n=ee.getValue(se.V1_PLUGINS))==null?void 0:n.toString())==null?void 0:i.split(","))||[],r=t.reduce((m,f)=>(m[e.includes(f.id)?"v1":"v2"].push({...f,name:f.name.replace("v2","")}),m),{v1:[],v2:[]});return(d=(c=(a=this.context.getValue("modules"))==null?void 0:a.devTools)==null?void 0:c.plugins)!=null&&d.length&&((h=(l=this.context.getValue("modules"))==null?void 0:l.devTools)==null||h.plugins.forEach(m=>{var y,_,b;const f={..._a,tags:[..._a.tags],baseUrl:`http://localhost:${m.port}`,name:m.name,picture:(y=m.picture)!=null?y:_a.picture,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),id:m.id,organizationId:this.organizationId,description:(_=m.description)!=null?_:_a.description,staggered:(b=m.staggered)!=null?b:_a.staggered};r.v2.push(f)})),r.v2}async getPluginDetails(t){const{plugin:e}=(await this.requests.get(`/v2/plugins/view/${t}`)).data.data;return e}async getPluginConfig(t){return(await this.fetchClient.get(`${t}/dyte-config.json`)).data}async authorizePlugin(t){const e={peerId:this.peerId},{token:r}=(await this.requests.post(`/v2/plugins/authorize/${t}`,e)).data.data;return r}async getPresignedUrls(t,e){const r=gc(this.context,"chat_upload_expiry"),n={roomUUID:this.roomUUID,filename:t,expiry:typeof r=="number"?r:void 0};ee.hasFeature(se.FEAT_CHAT_SDK)&&(n.viewType=e);const{getLocation:i,putLocation:a}=(await this.requests.post("/v1/meetings/genPreSignedUploadUrl",n)).data.data;return{getLocation:i,putLocation:a}}async uploadFile(t,e){if(navigator.isReactNative&&"uri"in t)try{await fetch(e,{method:"PUT",headers:{"Content-Type":"application/octet-stream"},body:{uri:t.uri,name:t.name}})}catch(r){u.error(`sendFileMessage::${r}`)}else await this.fetchClient.put(e,t,{headers:{"Content-Type":t.type}})}async startLivestreaming({manualIngestion:t}){const e=ps(await this.requests.post(`/v2/meetings/${this.context.getValue("meetingId")}/livestreams`,{manual_ingest:!!t})).data.data;return{playbackUrl:e.playbackUrl,status:e.status,manualIngest:e.manualIngest,ingestionCredentials:e.streamKey?{ingestionServer:e.ingestServer,streamKey:e.streamKey}:null}}async stopLivestreaming(){return this.requests.post(`/v2/meetings/${this.context.getValue("meetingId")}/active-livestream/stop`)}async getActiveLivestream(){const t=ps((await this.requests.get(`/v2/meetings/${this.context.getValue("meetingId")}/active-livestream`)).data.data);return{playbackUrl:t.playbackUrl,status:t.status,manualIngest:t.manualIngest,ingestionCredentials:t.streamKey?{ingestionServer:t.ingestServer,streamKey:t.streamKey}:null}}async getUserDetails(){if(this.userDetails)return this.userDetails;const t=(await this.requests.get("v2/internals/participant-details")).data.data;return ps(t)}async startRecording(t,e){return(await this.requests.post("/v2/recordings",{...Um(t),meeting_id:this.context.getValue("meetingId"),allow_multiple_recordings:!!e})).data.data.id}async updateRecording(t,e){return this.requests.put(`v2/recordings/${t}`,{action:e})}async getActiveRecording(){const{status:t,id:e}=(await this.requests.get(`v2/recordings/active-recording/${this.context.getValue("meetingId")}`)).data.data;return{status:t,id:e}}async getActiveTranscript(){const{transcript_download_url:t}=(await this.requests.get(`v2/meetings/${this.context.getValue("meetingId")}/active-transcript`)).data.data;try{return{transcript:(await this.fetchClient.get(t)).data}}catch(e){throw new P("Cant fetch transcript s3 url","1801")}}async getRoomNodeData(){const t=await this.getIPDetails();if(this.ipInfo=t,this.roomDetails)return this.roomDetails;const{roomNodeLink:e,title:r,useHiveMedia:n,sfu:i}=ps((await this.requests.post("v2/internals/rooms",{ip_information:t})).data.data);return{roomNodeUrl:e,meetingTitle:r,useHiveMedia:n!=null?n:!1,sfu:i}}}Yt([T.trace("APIClient.getIPDetails")],Bt.prototype,"getIPDetails",1),Yt([T.trace("APIClient.getICEServers")],Bt.prototype,"getICEServers",1),Yt([T.trace("APIClient.getPlugins")],Bt.prototype,"getPlugins",1),Yt([T.trace("APIClient.startLivestreaming")],Bt.prototype,"startLivestreaming",1),Yt([T.trace("APIClient.stopLivestreaming")],Bt.prototype,"stopLivestreaming",1),Yt([T.trace("APIClient.getActiveLivestream")],Bt.prototype,"getActiveLivestream",1),Yt([T.trace("APIClient.getUserDetails")],Bt.prototype,"getUserDetails",1),Yt([T.trace("APIClient.startRecording")],Bt.prototype,"startRecording",1),Yt([T.trace("APIClient.stopRecording")],Bt.prototype,"updateRecording",1),Yt([T.trace("APIClient.getActiveRecording")],Bt.prototype,"getActiveRecording",1),Yt([T.trace("APIClient.getActiveTranscript")],Bt.prototype,"getActiveTranscript",1),Yt([T.trace("APIClient.getRoomNodeData")],Bt.prototype,"getRoomNodeData",1);let jl;function pA(s,t){return jl=new Bt(s,t),jl}function nt(){return jl}function mA(s,t){return`<blockquote>${t.replace(/<blockquote>[.\s\S]*<\/blockquote>\n\n/m,"")}</blockquote>

${s}`}const ti={maxInvocations:5,period:1};function Ot(s,t){return function(e,r,n){const i=n.value;let a=0,c=Date.now();return n.value=function(...d){const l=Date.now(),h=t?this[t]:s;if(l-c>h.period*1e3&&(c=l,a=0),a>=h.maxInvocations)throw new P(`Method rate limit ${h.maxInvocations} invocations/${h.period}sec exceeded`,"0013");return a+=1,i.apply(this,d)},n}}var fA=Object.defineProperty,gA=Object.getOwnPropertyDescriptor,ht=(s,t,e,r)=>{for(var n=r>1?void 0:r?gA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&fA(t,e,n),n};const vA=["text","image","file","custom","poll"],xc={maxInvocations:180,period:60};let Ze=(Yf=class extends Ft{constructor(t,e,r,n,i){super();g(this,pd);p(this,"messages");p(this,"channels",[]);g(this,te,void 0);g(this,Sn,void 0);g(this,Je,void 0);g(this,En,void 0);g(this,qa,void 0);p(this,"maxTextLimit",2e3);v(this,qa,t),v(this,Je,e),v(this,En,r),v(this,te,n),v(this,Sn,i),this.messages=[]}setMaxTextLimit(t){this.maxTextLimit=t}get socketJoined(){return o(this,pd,pg).socketJoined===!0}async sendMessageInternal(t,e,r,n={}){switch(t.type){case"text":{const i=n.replyTo&&n.replyTo.type==="text"?mA(t.message,n.replyTo.message):t.message;await this.sendTextMessageInternal(i,e,r);break}case"image":await this.sendImageMessageInternal(t.image,e,r);break;case"file":await this.sendFileMessageInternal(t.file,e,r);break;default:u.error("sendMessage::message_type_not_supported",{dyteChat:{messageType:t.type}});break}}async sendTextMessageInternal(t,e,r){var i,a,c,d,l,h;if(t.length>this.maxTextLimit)throw new P("Max character limit breached","0503");if(e&&e.length>0){if(!((i=o(this,te).permissions)!=null&&i.chatPrivate.canSend)||!((a=o(this,te).permissions)!=null&&a.chatPrivate.text))throw u.error("sendTextMessage::private_chat_permission_denied"),new P("Could not send message to private chat.","0501")}else if(!((d=(c=o(this,te).permissions)==null?void 0:c.chatPublic)!=null&&d.canSend)||!((h=(l=o(this,te).permissions)==null?void 0:l.chatPublic)!=null&&h.text))throw u.error("sendTextMessage::public_chat_permission_denied"),new P("Could not send message to public chat.","0501");if(!t)throw u.error("sendTextMessage::message_can_not_be_empty"),new P("Message can not be empty.","0502");if(r){o(this,Je).sendMessageToChannel(t,Et.TEXT,r);return}let n=[];e&&e.length>0&&(e.push(o(this,te).id),n=o(this,Sn).joined.toArray().filter(m=>e.includes(m.id)).map(m=>m.userId),n.push(o(this,te).userId)),o(this,Je).sendMessage(t,Et.TEXT,e)}async sendImageMessageInternal(t,e,r){var i,a,c,d,l,h;if(e&&e.length>0){if(!((i=o(this,te).permissions)!=null&&i.chatPrivate.canSend)||!((a=o(this,te).permissions)!=null&&a.chatPrivate.files)){u.error("sendImageMessage::private_chat_permission_denied");return}}else if(!((d=(c=o(this,te).permissions)==null?void 0:c.chatPublic)!=null&&d.canSend)||!((h=(l=o(this,te).permissions)==null?void 0:l.chatPublic)!=null&&h.files)){u.error("sendImageMessage::permission_denied");return}if(!t){u.error("sendImageMessage::required_argument_image_can_not_be_empty");return}if(!["image/gif","image/jpeg","image/png"].includes(t.type)){u.error("sendImageMessage::image_type_not_supported",{dyteChat:{imageType:t.type}});return}try{const m=nt(),{getLocation:f,putLocation:y}=await m.getPresignedUrls(t.name,o(this,te).config.viewType);if(await m.uploadFile(t,y),r){o(this,Je).sendMessageToChannel(f,Et.IMAGE,r);return}let _=[];e&&e.length>0&&(e.push(o(this,te).id),_=o(this,Sn).joined.toArray().filter(b=>e.includes(b.id)).map(b=>b.userId),_.push(o(this,te).userId)),o(this,Je).sendMessage(f,Et.IMAGE,e)}catch(m){throw new P("Error sending image message.","0500")}}async sendFileMessageInternal(t,e,r){var n,i,a,c,d,l;if(e&&e.length>0){if(!((n=o(this,te).permissions)!=null&&n.chatPrivate.canSend)||!((i=o(this,te).permissions)!=null&&i.chatPrivate.files)){u.error("sendFileMessage::private_chat_permission_denied");return}}else if(!((c=(a=o(this,te).permissions)==null?void 0:a.chatPublic)!=null&&c.canSend)||!((l=(d=o(this,te).permissions)==null?void 0:d.chatPublic)!=null&&l.files)){u.error("sendFileMessage::permission_denied");return}if(!t){u.error("sendFileMessage::required_argument_file_can_not_be_empty");return}try{const h=nt(),{getLocation:m,putLocation:f}=await h.getPresignedUrls(t.name,o(this,te).config.viewType);if(await h.uploadFile(t,f),r){o(this,Je).sendMessageToChannel(JSON.stringify({link:m,name:t.name,size:"size"in t?t.size:0}),Et.FILE,r);return}let y=[];e&&e.length>0&&(e.push(o(this,te).id),y=o(this,Sn).joined.toArray().filter(b=>e.includes(b.id)).map(b=>b.userId),y.push(o(this,te).userId));const _=JSON.stringify({link:m,name:t.name,size:"size"in t?t.size:0});o(this,Je).sendMessage(_,Et.FILE,e)}catch(h){throw new P("Error sending file message.","0500")}}get rateLimits(){return xc}updateRateLimits(t,e){xc.maxInvocations=t,xc.period=e}async sendTextMessage(t,e){return this.sendTextMessageInternal(t,e)}async sendCustomMessage(t,e){var i,a,c,d,l,h,m,f,y,_,b,I,L,B,q;if(e&&e.length>0){if(!((i=o(this,te).permissions)!=null&&i.chatPrivate.canSend)||!((a=o(this,te).permissions)!=null&&a.chatPrivate.files)||!((c=o(this,te).permissions)!=null&&c.chatPrivate.text)){u.error("sendCustomMessage::private_chat_permission_denied");return}}else if(!((l=(d=o(this,te).permissions)==null?void 0:d.chatPublic)!=null&&l.canSend)||!((m=(h=o(this,te).permissions)==null?void 0:h.chatPublic)!=null&&m.files)||!((y=(f=o(this,te).permissions)==null?void 0:f.chatPublic)!=null&&y.text)){u.error("sendCustomMessage::permission_denied");return}const r=async F=>{try{if(typeof F=="string")return{link:F};const X=nt(),{getLocation:ne,putLocation:ve}=await X.getPresignedUrls(F.name,o(this,te).config.viewType);return await X.uploadFile(F,ve),{link:ne,type:F.type,name:F.name,size:F.size}}catch(X){throw new P("Error sending image message.","0500")}},n={...t,files:await Promise.all((b=(_=t.files)!=null?_:[])==null?void 0:b.map(async F=>r(F))),images:await Promise.all((L=(I=t.images)!=null?I:[])==null?void 0:L.map(async F=>r(F))),videos:await Promise.all((q=(B=t.videos)!=null?B:[])==null?void 0:q.map(async F=>r(F)))};o(this,Je).sendMessage(JSON.stringify(n),Et.CUSTOM,e)}async sendImageMessage(t,e){return this.sendImageMessageInternal(t,e)}async sendFileMessage(t,e){return this.sendFileMessageInternal(t,e)}async sendMessage(t,e){return this.sendMessageInternal(t,e)}async editTextMessage(t,e,r){var n,i,a,c,d,l;if(((i=(n=o(this,te).permissions)==null?void 0:n.chatMessage)==null?void 0:i.canEdit)==="NONE")throw new P("Not permitted to edit messages","0501");if(!((c=(a=o(this,te).permissions)==null?void 0:a.chatPublic)!=null&&c.canSend)||!((l=(d=o(this,te).permissions)==null?void 0:d.chatPublic)!=null&&l.text)){u.error("editTextMessage::permission_denied");return}if(!e){u.error("editTextMessage::message_can_not_be_empty");return}o(this,Je).editMessage(t,e,Et.TEXT,r)}async editImageMessage(t,e,r){var i,a,c,d;if(!((a=(i=o(this,te).permissions)==null?void 0:i.chatPublic)!=null&&a.canSend)||!((d=(c=o(this,te).permissions)==null?void 0:c.chatPublic)!=null&&d.files)){u.error("editImageMessage::permission_denied");return}if(!e){u.error("editImageMessage::required_argument_image_can_not_be_empty");return}if(!["image/gif","image/jpeg","image/png"].includes(e.type)){u.error("sendImageMessage::image_type_not_supported",{dyteChat:{imageType:e.type}});return}try{const l=nt(),{getLocation:h,putLocation:m}=await l.getPresignedUrls(e.name,o(this,te).config.viewType);await l.uploadFile(e,m),o(this,Je).editMessage(t,h,Et.IMAGE,r)}catch(l){throw new P("Error editing image message.","0500")}}async editFileMessage(t,e,r){var n,i,a,c;if(!((i=(n=o(this,te).permissions)==null?void 0:n.chatPublic)!=null&&i.canSend)||!((c=(a=o(this,te).permissions)==null?void 0:a.chatPublic)!=null&&c.files)){u.error("sendFileMessage::permission_denied");return}if(!e){u.error("sendFileMessage::required_argument_file_can_not_be_empty");return}try{const d=nt(),{getLocation:l,putLocation:h}=await d.getPresignedUrls(e.name,o(this,te).config.viewType);await d.uploadFile(e,h),o(this,Je).editMessage(t,JSON.stringify({link:l,name:e.name,size:"size"in e?e.size:0}),Et.FILE,r)}catch(d){throw new P("Error editing file message.","0500")}}async editMessage(t,e,r){switch(e.type){case"text":{this.editTextMessage(t,e.message,r);break}case"image":{this.editImageMessage(t,e.image,r);break}case"file":{this.editFileMessage(t,e.file,r);break}default:{u.error("editMessage::message_type_not_supported",{dyteChat:{messageType:e.type}});break}}}async deleteMessage(t,e){var r,n;if(((n=(r=o(this,te).permissions)==null?void 0:r.chatMessage)==null?void 0:n.canDelete)==="NONE")throw new P("Not permitted to delete messages","0501");o(this,Je).deleteMessage(t,e)}getMessagesByUser(t){return this.messages.filter(e=>e.userId===t)}getMessagesByType(t){return this.messages.filter(e=>e.type===t)}async pin(t){if(!this.socketJoined)throw new P("Can`t pin message without joining room","0505");if(!o(this,te).permissions.pinParticipant)throw new P("You do not have permission to pin messages.","0501");const e=this.messages.find(r=>r.id===t);if(e){o(this,Je).setPinState(e,!0);return}throw new P(`No message found with id: ${t}`,"0504")}async unpin(t){if(!this.socketJoined)throw new P("Can`t unpin message without joining room","0505");if(!o(this,te).permissions.pinParticipant)throw new P("You do not have permission to unpin messages.","0501");const e=this.messages.find(r=>r.id===t);if(e){o(this,Je).setPinState(e,!1);return}throw new P(`No message found with id: ${t}`,"0504")}async getMessages(t,e,r,n=0,i=void 0){const a=await o(this,Je).getChatMessagesPaginated(t,e,r,n,i);return{messages:a.messages.map(c=>ms.formatSocketServiceMessage(c)),next:a.next}}async createChannel(t,e,r={}){var c;const n=(c=o(this,te).permissions)==null?void 0:c.chatChannel;if(n){if(n.canCreate==="NONE")throw new P("Not permitted to create channels","0501");if(r.visibility==="public"&&!(n.canCreate==="PUBLIC"||n.canCreate==="ALL"))throw new P("Not permitted to create public channels","0501");if(r.visibility==="private"&&!(n.canCreate==="PRIVATE"||n.canCreate==="ALL"))throw new P("Not permitted to create private channels","0501")}if(!t||t.trim().length===0)throw new P("channel name cannot be empty.","0510");const i=[...new Set([...e,o(this,te).userId])];return await o(this,En).createChannel(t.trim(),i,r.displayPictureUrl,r.visibility,r.isDirectMessage)}updateChannel(t,e){var a,c,d,l,h;const r=this.channels.find(m=>m.id===t),n=(a=o(this,te).permissions)==null?void 0:a.chatChannel;if(n){if(n.canUpdate==="NONE")throw new P("Not permitted to update channels","0501");if(r.visibility==="public"&&!(n.canUpdate==="PUBLIC"||n.canUpdate==="ALL"))throw new P("Not permitted to update public channels","0501");if(r.visibility==="private"&&!(n.canUpdate==="PRIVATE"||n.canUpdate==="ALL"))throw new P("Not permitted to update private channels","0501")}const i={memberIds:(c=e.memberIds)!=null?c:r.memberIds,displayName:(d=e.displayName)!=null?d:r.displayName,displayPictureUrl:(l=e.displayPictureUrl)!=null?l:r.displayPictureUrl,visibility:(h=e.visibility)!=null?h:r.visibility};return o(this,En).updateChannel(t,i)}async sendMessageToChannel(t,e,r={}){return this.sendMessageInternal(t,null,e,r)}async getChannelMembers(t){return o(this,En).getChannelMembers(t)}async searchMessages(t,e={}){if(!ee.hasFeature(se.FEAT_CHAT_SDK_SEARCH))throw new P("searchMessages is temporarily disabled!","0506");return(await o(this,Je).searchMessages(t,e)).map(ms.formatSocketServiceMessage)}async markLastReadMessage(t,e){await o(this,Je).markLastReadMessage(t,e);const r=this.channels.find(n=>n.id===t);if(r){const n={...r,unreadCount:0};this.channels=this.channels.map(i=>i.id===t?n:i),this.emit("channelMessageUpdate",n)}}get pinned(){return this.messages.filter(t=>t.pinned)}},te=new WeakMap,Sn=new WeakMap,Je=new WeakMap,En=new WeakMap,qa=new WeakMap,pd=new WeakSet,pg=function(){return o(this,qa).getValue("connectionHandler")},Yf);ht([T.trace("DyteChat.sendTextMessage"),Ot(xc)],Ze.prototype,"sendTextMessage",1),ht([T.trace("DyteChat.sendImageMessage"),Ot({maxInvocations:20,period:60})],Ze.prototype,"sendImageMessage",1),ht([T.trace("DyteChat.sendFileMessage"),Ot({maxInvocations:20,period:60})],Ze.prototype,"sendFileMessage",1),ht([T.trace("DyteChat.sendMessage"),Ot({maxInvocations:180,period:60})],Ze.prototype,"sendMessage",1),ht([T.trace("DyteChat.editTextMessage")],Ze.prototype,"editTextMessage",1),ht([T.trace("DyteChat.editImageMessage")],Ze.prototype,"editImageMessage",1),ht([T.trace("DyteChat.editFileMessage")],Ze.prototype,"editFileMessage",1),ht([T.trace("DyteChat.editMessage")],Ze.prototype,"editMessage",1),ht([T.trace("DyteChat.deleteMessage")],Ze.prototype,"deleteMessage",1),ht([T.trace("DyteChat.createChannel")],Ze.prototype,"createChannel",1),ht([T.trace("DyteChat.updateChannel")],Ze.prototype,"updateChannel",1),ht([T.trace("DyteChat.sendMessageToChannel")],Ze.prototype,"sendMessageToChannel",1),ht([T.trace("DyteChat.getChannelMembers")],Ze.prototype,"getChannelMembers",1),ht([T.trace("DyteChat.searchMessages")],Ze.prototype,"searchMessages",1),ht([T.trace("DyteChat.markLastReadMessage")],Ze.prototype,"markLastReadMessage",1),Ze=ht([lt("0500")],Ze);var TA=Object.defineProperty,yA=Object.getOwnPropertyDescriptor,SA=(s,t,e,r)=>{for(var n=r>1?void 0:r?yA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&TA(t,e,n),n};const on=(Qf=class{constructor(s,t,e,r,n){p(this,"chat");p(this,"chatSocketHandler");p(this,"chatChannelSocketHandler");p(this,"self");g(this,md,void 0);v(this,md,s),this.chatSocketHandler=t,this.chatChannelSocketHandler=e,this.chat=new Ze(s,t,e,r,n),this.self=r,this.setupEvents()}static async init(s,t,e,r,n){return new on(s,t,e,r,n)}static formatMessage(s){return{...s,time:new Date(s.time),type:vA[s.type]}}static formatSocketServiceMessage(s){const t=s.createdAt*1e3,e={displayName:s.displayName,id:s.chatId,time:t,timeMs:s.createdAtMs,type:s.payloadType,isEdited:s.isEdited,userId:s.userId,targetUserIds:s.targetUserIds,channelId:s.channelId,channelIndex:s.channelIndex,message:"",link:"",name:"",html:"",images:[],videos:[],files:[],size:0,pinned:s.pinned};switch(e.type){case Et.TEXT:{e.message=s.payload;break}case Et.IMAGE:{e.link=s.payload;break}case Et.FILE:{const{link:r,name:n,size:i}=JSON.parse(s.payload);e.link=r,e.name=n,e.size=i;break}case Et.CUSTOM:{const{html:r,images:n,message:i,videos:a,files:c}=JSON.parse(s.payload);e.message=i,e.html=r,e.images=n,e.videos=a,e.files=c;break}}return on.formatMessage(e)}async getChatMessages(){if(this.self.config.viewType==="LIVESTREAM"||this.self.config.viewType==="CHAT"||ee.hasFeature(se.FEAT_PAGINATED_CHAT))return;const s=await this.chatSocketHandler.getChatMessages();if(!(s!=null&&s.payload))return;const t=Cm.fromBinary(s.payload).messages;this.chat.messages=t.map(e=>on.formatSocketServiceMessage(e))}setupEvents(){R.on(k.SOCKET_SERVICE_ROOM_JOINED,async()=>{this.getChatMessages()}),this.chatSocketHandler.on(Me.sendMessageToRoom,s=>{const t=on.formatSocketServiceMessage(s.message);if(!t.channelId)this.chat.messages=[...this.chat.messages,t];else{const e=this.chat.channels.find(r=>r.id===t.channelId);e&&(e.latestMessage=t,e.unreadCount+=1,this.chat.emit("channelMessageUpdate",e))}this.chat.emit("chatUpdate",{action:"add",message:t,messages:this.chat.messages})}),this.chatSocketHandler.on(Me.sendMessageToPeers,s=>{const t=on.formatSocketServiceMessage(s.message);this.chat.messages=[...this.chat.messages,t],this.chat.emit("chatUpdate",{action:"add",message:t,messages:this.chat.messages})}),this.chatSocketHandler.on(Me.editMessage,s=>{const t=on.formatSocketServiceMessage(s.message);if(t.channelId){this.chat.emit("chatUpdate",{action:"edit",message:t,messages:this.chat.messages});return}const e=this.chat.messages.findIndex(r=>r.id===t.id);e!==-1&&(this.chat.messages[e]=t,this.chat.emit("chatUpdate",{action:"edit",message:t,messages:this.chat.messages}))}),this.chatSocketHandler.on(Me.deleteMessage,s=>{if(s.channelId){this.chat.emit("chatUpdate",{action:"delete",message:{id:s.chatId,channelId:s.channelId},messages:this.chat.messages});return}const t=this.chat.messages.findIndex(r=>r.id===s.chatId);if(t===-1)return;const[e]=this.chat.messages.splice(t,1);this.chat.emit("chatUpdate",{action:"delete",message:e,messages:this.chat.messages})}),this.chatChannelSocketHandler.on(nn.createChatChannel,s=>{const[t]=s.chatChannels,e=an.formatChannel(t);this.chat.channels.push(e),this.chat.emit("channelCreate",e)}),this.chatSocketHandler.on(Me.pinMessage,s=>{const t=this.chat.messages.findIndex(r=>r.id===s.chatId);if(t===-1)return;const e=this.chat.messages[t];e.pinned=s.pinned,this.chat.messages[t]=e,this.chat.emit("chatUpdate",{action:"edit",message:e,messages:this.chat.messages})}),this.chatChannelSocketHandler.on(nn.updateChatChannel,s=>{const[t]=s.chatChannels,e=an.formatChannel(t);this.chat.channels=this.chat.channels.map(r=>r.id===e.id?e:r),this.chat.emit("channelUpdate",e)})}},md=new WeakMap,Qf);let ms=on;SA([T.trace("ChatController.setupEvents")],ms.prototype,"setupEvents",1);var EA=Object.defineProperty,_A=Object.getOwnPropertyDescriptor,bA=(s,t,e,r)=>{for(var n=r>1?void 0:r?_A(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&EA(t,e,n),n};let Gl=(Xf=class extends Ft{constructor(t,e,r){super();g(this,fd);p(this,"items");g(this,gi,void 0);g(this,vi,void 0);g(this,ja,void 0);v(this,ja,t),v(this,gi,e),v(this,vi,r),this.items=[]}get socketJoined(){var t;return((t=o(this,fd,mg))==null?void 0:t.socketJoined)===!0}async create(t,e,r=!1,n=!1){if(!this.socketJoined)throw new P("Can't create polls without joining room","0705");if(!o(this,gi).permissions.polls.canCreate){u.error("DytePolls::create::permission_denied");return}if(!t||!e){u.error("DytePolls::question_and_options_can_not_be_empty",{dytePolls:{hasQuestion:!!t,optionsLength:e==null?void 0:e.length}});return}if(e.length<2){u.error("DytePolls::there_must_be_at_least_two_options",{dytePolls:{hasQuestion:!!t,optionsLength:e.length}});return}await o(this,vi).createPoll(t,e,r,n)}async vote(t,e){if(!o(this,gi).permissions.polls.canVote){u.error("DytePolls::vote::permission_denied");return}await o(this,vi).votePoll(t,e)}},fd=new WeakSet,mg=function(){return o(this,ja).getValue("connectionHandler")},gi=new WeakMap,vi=new WeakMap,ja=new WeakMap,Xf);Gl=bA([lt("0700")],Gl);var wA=Object.defineProperty,PA=Object.getOwnPropertyDescriptor,CA=(s,t,e,r)=>{for(var n=r>1?void 0:r?PA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&wA(t,e,n),n};const si=(Zf=class{constructor(s,t,e){p(this,"polls");g(this,Ti,void 0);g(this,_n,void 0);this.polls=new Gl(s,t,e),v(this,Ti,t),v(this,_n,e),this.setupEvents()}static async init(s,t,e){return new si(s,t,e)}canViewPolls(){return o(this,Ti).permissions.polls.canView}setupEvents(){const s={[Hs.createPoll]:r=>{r.poll&&this.updatePoll(si.formatSocketServicePoll(r.poll))},[Hs.updatePoll]:r=>{r.poll&&this.updatePoll(si.formatSocketServicePoll(r.poll))},[Hs.votePoll]:r=>{r.poll&&this.updatePoll(si.formatSocketServicePoll(r.poll))}},t=()=>{R.on(k.SOCKET_SERVICE_ROOM_JOINED,()=>{this.getPolls()}),Object.keys(s).map(Number).forEach(r=>{o(this,_n).on(r,s[r])})},e=()=>{R.on(k.SOCKET_SERVICE_ROOM_JOINED,()=>{this.getPolls()}),Object.keys(s).map(Number).forEach(r=>{o(this,_n).removeListeners(r)})};o(this,Ti).permissions.on("permissionsUpdate",async r=>{var n;(n=r==null?void 0:r.polls)!=null&&n.canView?(await this.getPolls(),t()):(this.polls.items=[],e())}),this.canViewPolls()&&t()}updatePoll(s){if(!this.canViewPolls())return;const t=this.polls.items.findIndex(e=>e.id===s.id);if(t>-1){const e=JSON.stringify(this.polls.items[t]);this.polls.items[t]=s,e!==JSON.stringify(s)&&this.polls.emit("pollsUpdate",{polls:this.polls.items,newPoll:!1});return}this.polls.items=[...this.polls.items,s],this.polls.emit("pollsUpdate",{polls:this.polls.items,newPoll:!0})}async getPolls(){const s=await o(this,_n).getPolls();if(!(s!=null&&s.payload))return;const{polls:t}=VI.fromBinary(s.payload);this.polls.items=t.map(e=>si.formatSocketServicePoll(e))}static formatSocketServicePoll(s){const t=s.options.map(e=>({count:e.count,text:e.text,votes:e.votes.map(r=>({id:r.userId,name:r.name}))}));return{anonymous:s.anonymous,createdBy:s.createdBy,createdByUserId:s.createdByUserId,hideVotes:s.hideVotes,id:s.pollId,options:t,question:s.question,voted:s.votes}}},Ti=new WeakMap,_n=new WeakMap,Zf);let Bm=si;CA([T.trace("PollController.setupEvents")],Bm.prototype,"setupEvents",1);var RA=Object.defineProperty,kA=Object.getOwnPropertyDescriptor,IA=(s,t,e,r)=>{for(var n=r>1?void 0:r?kA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&RA(t,e,n),n},$m=(s=>(s[s.User=0]="User",s[s.Meeting=1]="Meeting",s))($m||{});let Wl=(eg=class extends Ft{constructor(t,e,r,n,i){super();g(this,Ga);p(this,"selfActiveTab");p(this,"broadcastTabChanges");g(this,yi,void 0);g(this,bn,void 0);g(this,Wa,void 0);p(this,"viewType");p(this,"meetingStartedTimestamp");p(this,"meetingTitle");p(this,"sessionId");v(this,yi,t),v(this,bn,e),this.viewType=r,v(this,Wa,n),this.meetingTitle=i,this.broadcastTabChanges=e.permissions.canSpotlight}get socketState(){return o(this,Ga,Iu).socketState}get mediaState(){return o(this,Ga,Iu).mediaState}get meetingId(){return o(this,yi).getValue("meetingId")}setBroadcastTabChanges(t){if(!o(this,bn).permissions.canSpotlight)throw u.error("DyteSpotlight::setSpotlighted::permission_denied"),new P("User does not have permission to toggle spotlight","0801");this.broadcastTabChanges=t,this.emit("broadcastTabChangesUpdate",this.broadcastTabChanges),this.broadcastTabChanges&&this.assertActiveTabToRoom()}setSelfActiveTab(t,e){var r;u.info("DyteSpotlight::setActiveTab",{spotlight:{currentTab:{id:t.id,type:t.type}}}),this.selfActiveTab=t,e===0&&this.emit("selfTabUpdate",t),(r=o(this,bn).permissions)!=null&&r.canSpotlight&&this.broadcastTabChanges&&e===0&&this.assertActiveTabToRoom()}assertActiveTabToRoom(){o(this,Wa).broadcastMessage("spotlight",{userId:o(this,bn).userId,currentTab:this.selfActiveTab})}},yi=new WeakMap,Ga=new WeakSet,Iu=function(){return o(this,yi).getValue("connectionHandler")},bn=new WeakMap,Wa=new WeakMap,eg);Wl=IA([lt("0800")],Wl);function AA(s){let t="",e=[""];const r=[e];let n=0,i=0,a=!0,c;for(c of s)c==='"'?(a&&c===t&&(e[n]+=c),a=!a):c===","&&a?c=e[++n]="":c===`
`&&a?(t==="\r"&&(e[n]=e[n].slice(0,-1)),e=r[++i]=[c=""],n=0):e[n]+=c,t=c;return r}var MA=Object.defineProperty,DA=Object.getOwnPropertyDescriptor,Hm=(s,t,e,r)=>{for(var n=r>1?void 0:r?DA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&MA(t,e,n),n};let fr=class extends Ft{constructor(){super();p(this,"transcripts");this.transcripts=[]}static async init(t){const e=new fr;try{t&&e.getActiveTranscript()}catch(r){u.error("Error fetching active transcriptions ",r)}return e}static parseTranscript(t,e=!1){try{if(!t)return;const[[r,n,i,a,c,d]]=AA(t);return{id:Jn(),name:c,peerId:n,userId:i,customParticipantId:a,transcript:d,isPartialTranscript:e,date:new Date(parseInt(r,10)*1e3)}}catch(r){u.error(`Failed to parse transcript: ${t}`,r);return}}static parseTranscripts(t){return t?t.split(`
`).map(e=>fr.parseTranscript(e,!1)).filter(Boolean):[]}async getActiveTranscript(){try{const t=nt(),{transcript:e}=await t.getActiveTranscript();this.transcripts=fr.parseTranscripts(e)}catch(t){}}async onTranscript(t){var r;const e=this.transcripts.filter(({peerId:n})=>n===t.peerId);if((r=e==null?void 0:e.at(-1))!=null&&r.isPartialTranscript){const n=e.at(-1);n.transcript=t.transcript,n.isPartialTranscript=t.isPartialTranscript,this.emit("transcript",n);return}this.transcripts=[...this.transcripts,t],this.emit("transcript",t)}};Hm([T.trace("DyteAi.getActiveTranscript")],fr.prototype,"getActiveTranscript",1),fr=Hm([lt("0000")],fr);var OA=Object.defineProperty,NA=Object.getOwnPropertyDescriptor,LA=(s,t,e,r)=>{for(var n=r>1?void 0:r?NA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&OA(t,e,n),n};const qm=(tg=class{constructor(s,t,e,r,n,i){p(this,"meta");p(this,"ai");g(this,kr,void 0);g(this,Si,void 0);p(this,"aiSocketHandler");g(this,gd,void 0);v(this,gd,s),this.meta=new Wl(s,t,t.config.viewType,e,i),this.ai=r,v(this,kr,t),v(this,Si,e),this.aiSocketHandler=n,t.config.viewType!==yt.Chat&&this.setupEvents()}static async init(s,t,e,r,n){const i=await fr.init(t.permissions.transcriptionEnabled);return new qm(s,t,e,i,r,n)}conditionallySetActiveTab(s){var t;s!=null&&s.currentTab&&((t=this.meta.selfActiveTab)==null?void 0:t.id)!==s.currentTab.id&&(this.meta.setSelfActiveTab(s.currentTab,$m.Meeting),this.meta.emit("activeTabUpdate",s.currentTab))}setupEvents(){R.on(k.TRANSPORT_STATE_UPDATE,s=>{this.meta.emit("mediaConnectionUpdate",s)}),R.on(k.SOCKET_STATE_UPDATE,s=>{this.meta.emit("socketConnectionUpdate",s)}),R.on(k.ROOM_STATE,({createdAt:s,roomUuid:t})=>{const e=this.meta.meetingStartedTimestamp;if(t&&(this.meta.sessionId=t),s&&!e){const r=new Date(s*1e3);this.meta.meetingStartedTimestamp=r,this.meta.emit("meetingStartTimeUpdate",{meetingStartedTimestamp:this.meta.meetingStartedTimestamp})}}),R.on(k.PRODUCER_SCORE_UPDATE,({score:s})=>{s<5&&this.meta.emit("poorConnection",{score:s})}),o(this,kr).permissions.canSpotlight&&(u.info("DyteMetaController::Asserting Spotlight"),this.meta.selfActiveTab&&o(this,Si).broadcastMessage("spotlight",{userId:o(this,kr).userId,currentTab:this.meta.selfActiveTab})),R.on(k.PEER_JOINED_INTERNAL,async s=>{o(this,kr).permissions.canSpotlight&&this.meta.selfActiveTab&&o(this,Si).broadcastToPeers("spotlight",[s.id],{userId:o(this,kr).userId,currentTab:this.meta.selfActiveTab})}),R.on(k.ROOM_MESSAGE,s=>{var e,r;let t;if("type"in s){if(s.type!=="spotlight")return;t={...s,...s.payload}}else if("roomMessageType"in s){if(s.roomMessageType!=="spotlight")return;t=s}else return;u.info("Spotlight Assertion Received",{spotlight:{spotlighter:{id:t.userId},currentTab:{id:(e=t.currentTab)==null?void 0:e.id,type:(r=t.currentTab)==null?void 0:r.type}}}),this.conditionallySetActiveTab(t)}),R.on(k.MESSAGE,s=>{var e,r;let t;if("type"in s){if(s.type!=="spotlight")return;t={...s,...s.payload}}else if("roomMessageType"in s){if(s.roomMessageType!=="spotlight")return;t=s}else return;u.info("Spotlight Assertion Received",{spotlight:{spotlighter:{id:t.userId},currentTab:{id:(e=t.currentTab)==null?void 0:e.id,type:(r=t.currentTab)==null?void 0:r.type}}}),this.conditionallySetActiveTab(t)}),this.aiSocketHandler.on(V.transcript,s=>{const{meetingId:t,transcript:e,isPartial:r}=s,n=fr.parseTranscript(e,r);if(!n){u.warn("Received empty transcript data");return}this.ai.onTranscript(n),this.meta.emit("transcript",n);const{peerId:i,name:a,transcript:c}=n;u.debug(`${t} Received transcript for peer ${i} - ${a}: ${c}`)})}},kr=new WeakMap,Si=new WeakMap,gd=new WeakMap,tg);let jm=qm;LA([T.trace("MetaController.setupEvents")],jm.prototype,"setupEvents",1);var xA=Object.defineProperty,VA=Object.getOwnPropertyDescriptor,cn=(s,t,e,r)=>{for(var n=r>1?void 0:r?VA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&xA(t,e,n),n};class gr extends Ft{constructor(e,r,n,i,a){super();g(this,Ka);g(this,_i);g(this,Zt,void 0);g(this,Ei,void 0);g(this,le,void 0);g(this,Ja,void 0);g(this,ks,void 0);g(this,Ts,void 0);v(this,Ts,e),v(this,Zt,i),v(this,Ei,a),v(this,le,r),v(this,Ja,n),v(this,ks,[]),this.setupEvents()}get status(){return o(this,Ts).getValue("stageStatus")}setupEvents(){const e={[k.GET_STAGE_REQUESTS]:async i=>{v(this,ks,i)},[k.UPDATE_STAGE_REQUESTS]:async({add:i})=>{const a=o(this,ks).length,{stageRequests:c}=this.getAccessRequests();(i||c.length>a)&&this.emit("newStageRequest",{count:c.length}),this.emit("stageAccessRequestUpdate",c)}},r=()=>{Object.entries(e).forEach(([i,a])=>{R.onAsync(i,a)})},n=()=>{Object.entries(e).forEach(([i,a])=>{R.removeListener(i,a)})};o(this,le).permissions.on("permissionsUpdate",i=>{const{canAcceptProductionRequests:a}=i;a!==void 0&&(o(this,le).permissions.acceptStageRequests?(r(),o(this,Zt).getStageRequests()):(n(),v(this,ks,[]),this.emit("stageAccessRequestUpdate",o(this,ks))))}),o(this,le).permissions.acceptStageRequests&&r()}getAccessRequests(){if(!o(this,le).permissions.stageEnabled)throw u.error("DyteStage::stage_disabled"),new P("Stage is disabled","2003");if(!o(this,le).permissions.acceptStageRequests)throw u.error("DyteStage::get_access_request::permission_denied"),new P("You do not have permission to perform this action","2001");const e=o(this,Ja).joined.toArray().filter(r=>r.stageStatus==="REQUESTED_TO_JOIN_STAGE").map(r=>({displayName:r.name,userId:r.userId,peerId:r.id}));return v(this,ks,e),{stageRequests:o(this,ks)}}async requestAccess(){if(!o(this,le).permissions.stageEnabled)throw u.error("DyteStage::stage_disabled"),new P("Stage is disabled","2003");if(this.status!=="OFF_STAGE")throw new P(`Unable to request access you are currently ${this.status}`,"2006");if(o(this,le).permissions.stageAccess===G.Allowed){$(this,_i,$d).call(this,"ACCEPTED_TO_JOIN_STAGE");return}o(this,Zt).requestAccess(),$(this,_i,$d).call(this,"REQUESTED_TO_JOIN_STAGE")}async cancelRequestAccess(){if(!o(this,le).permissions.stageEnabled)throw u.error("DyteStage::stage_disabled"),new P("Stage is disabled","2003");o(this,Zt).cancelRequestAccess(),$(this,_i,$d).call(this,"OFF_STAGE")}grantAccess(e){if(!o(this,le).roomJoined)throw new P("Can`t grant for participant without joining room");if(!o(this,le).permissions.stageEnabled)throw u.error("DyteStage::stage_disabled"),new P("Stage is disabled","2003");if(!o(this,le).permissions.acceptStageRequests)throw u.error("DyteStage::grant_access::permission_denied"),new P("You do not have permission to perform this action","2001");return o(this,Zt).grantAccess(e)}denyAccess(e){if(!o(this,le).roomJoined)throw new P("Can`t rejectRequestToJoinStage for participant without joining room","2005");if(!o(this,le).permissions.stageEnabled)throw u.error("DyteStage::stage_disabled"),new P("Stage is disabled","2003");if(!o(this,le).permissions.acceptStageRequests)throw u.error("DyteStage::deny_access::permission_denied"),new P("You do not have permission to perform this action","2001");return o(this,Zt).denyAccess(e)}async join(){const e=o(this,Ts).getValue("viewType");if(this.status==="ON_STAGE")throw new P("You are already on stage.","2006");if(this.status!=="ACCEPTED_TO_JOIN_STAGE"||o(this,le).permissions.stageAccess===G.NotAllowed)throw new P(`Unable to join stage you are currently ${this.status}`,"2006");if(await o(this,Zt).joinStage(),e===yt.Livestream){await o(this,Ei).joinRoom(o(this,le));const{peers:r}=await o(this,Ei).getStagePeers();R.emit(k.SOCKET_PEERS,r)}o(this,Ts).setValue("stageStatus","ON_STAGE"),o(this,le).audioEnabled&&o(this,Ka,Au).shareMic(o(this,le).audioTrack),o(this,le).videoEnabled&&o(this,Ka,Au).shareWebcam(o(this,le).videoTrack)}async leave(){if(!o(this,le).permissions.stageEnabled)throw u.error("DyteStage::stage_disabled"),new P("Stage is disabled","2003");if(!(this.status==="ON_STAGE"||this.status==="ACCEPTED_TO_JOIN_STAGE"))throw new P(`Unable to leave stage you are currently ${this.status}`,"2006");o(this,le).setIsPinned(!1),await o(this,Zt).leaveStage(o(this,le).userId),o(this,Ts).setValue("stageStatus","OFF_STAGE",!1),await R.emitAsync(k.LEAVE_MEDIA_ROOM,"stageLeft"),o(this,Ts).notify("stageStatus")}async kick(e){if(!o(this,le).roomJoined)throw new P("Can`t kick participant without joining room","2005");if(!o(this,le).permissions.stageEnabled)throw u.error("DyteStage::stage_disabled"),new P("Stage is disabled","2003");if(!o(this,le).permissions.acceptStageRequests)throw u.error("DyteStage::kick::permission_denied"),new P("You do not have permissions for kick","2001");return o(this,Zt).kick(e)}}Zt=new WeakMap,Ei=new WeakMap,le=new WeakMap,Ja=new WeakMap,ks=new WeakMap,Ts=new WeakMap,Ka=new WeakSet,Au=function(){return o(this,Ts).getValue("roomNodeClient")},_i=new WeakSet,$d=async function(e){this.status!==e&&o(this,Ts).setValue("stageStatus",e)},cn([T.trace("DyteStage.getStageRequests")],gr.prototype,"getAccessRequests",1),cn([T.trace("DyteStage.requestAccess")],gr.prototype,"requestAccess",1),cn([T.trace("DyteStage.cancelRequestAccess")],gr.prototype,"cancelRequestAccess",1),cn([T.trace("DyteStage.grantAccess")],gr.prototype,"grantAccess",1),cn([T.trace("DyteStage.denyAccess")],gr.prototype,"denyAccess",1),cn([T.trace("DyteStage.joinStage")],gr.prototype,"join",1),cn([T.trace("DyteStage.leaveStage")],gr.prototype,"leave",1);function UA(s){return!(s.viewType==="LIVESTREAM"||s.viewType==="CHAT")}function Jl(s){switch(s){case Bs.UNSPECIFIED:return"OFF_STAGE";case Bs.REQUESTED_STAGE:return"REQUESTED_TO_JOIN_STAGE";case Bs.APPROVED_STAGE:return"ACCEPTED_TO_JOIN_STAGE";case Bs.OFF_STAGE:return"OFF_STAGE";case Bs.ON_STAGE:return"ON_STAGE";default:return"OFF_STAGE"}}var FA=Object.defineProperty,BA=Object.getOwnPropertyDescriptor,$A=(s,t,e,r)=>{for(var n=r>1?void 0:r?BA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&FA(t,e,n),n};class Gm{constructor(t,e,r,n,i){p(this,"stage");g(this,Ir,void 0);g(this,wn,void 0);g(this,Ar,void 0);g(this,za,0);g(this,Qs,void 0);v(this,Qs,t),this.stage=new gr(t,n,i,e,r),v(this,Ar,e),v(this,Ir,n),v(this,wn,i),this.setupEvents()}setupEvents(){o(this,Qs).subscribe("stageStatus",t=>{this.stage.emit("stageStatusUpdate",t)}),o(this,Ar).on(V.grantStageAccess,()=>{o(this,Ir).permissions.stageAccess!==G.Allowed&&(this.stage.emit("stageRequestApproved"),this.setStageStatus("ACCEPTED_TO_JOIN_STAGE"))}),o(this,Ar).on(V.peerStageStatusUpdate,t=>{t!==void 0&&(t.peerId===o(this,Ir).id?this.selfStageStatusHandler(t):this.peerStageStatusHandler(t))}),o(this,Ar).on(V.denyStageAccess,()=>{o(this,Ir).permissions.stageAccess!==G.Allowed&&(this.stage.emit("stageRequestRejected"),this.setStageStatus("OFF_STAGE"))}),o(this,Ar).on(V.getStageRequests,async t=>{var r;if(o(this,Ir).permissions.stageAccess!==G.Allowed)return;const e=(r=t==null?void 0:t.stageRequests)!=null?r:[];await R.emitAsync(k.GET_STAGE_REQUESTS,e),o(this,za)<e.length&&e.length>0&&this.stage.emit("newStageRequest",{count:e.length}),v(this,za,e.length),this.stage.emit("stageAccessRequestUpdate",e)})}getCurrentStageRequests(){return o(this,wn).joined.toArray().filter(e=>e.stageStatus==="REQUESTED_TO_JOIN_STAGE").map(e=>({displayName:e.name,userId:e.userId,peerId:e.id}))}async setStageStatus(t){this.stage.status!==t&&o(this,Qs).setValue("stageStatus",t)}selfStageStatusHandler(t){const e=Jl(t.stageType),r=o(this,Qs).getValue("stageStatus");if(r!==e)switch(t.stageType){case 1:o(this,Qs).setValue("stageStatus","ACCEPTED_TO_JOIN_STAGE",!1),this.stage.join();break;case 2:case 3:this.setStageStatus(r);break;case 0:case 4:default:o(this,Qs).setValue("stageStatus","ACCEPTED_TO_JOIN_STAGE",!1),this.stage.leave();break}}async peerStageStatusHandler(t){const e=o(this,wn).joined.get(t.peerId),r=o(this,wn).viewMode==="ACTIVE_GRID";if(!e){u.warn("err::peerStageStatusUpdate: participant not found");return}switch(t.stageType){case 1:e.setStageStatus("ON_STAGE"),r&&R.emit(k.UPDATE_ACTIVE);break;case 2:e.setStageStatus("ACCEPTED_TO_JOIN_STAGE");break;case 3:e.setStageStatus("REQUESTED_TO_JOIN_STAGE");break;case 0:case 4:default:e.setStageStatus("OFF_STAGE"),r&&R.emit(k.UPDATE_ACTIVE);break}R.emit(k.UPDATE_PEER_STAGE_STATUS,{id:e.id,status:e.stageStatus})}}Ir=new WeakMap,wn=new WeakMap,Ar=new WeakMap,za=new WeakMap,Qs=new WeakMap,$A([T.trace("DyteStage.setupEvents")],Gm.prototype,"setupEvents",1);var HA=Object.defineProperty,qA=Object.getOwnPropertyDescriptor,Vc=(s,t,e,r)=>{for(var n=r>1?void 0:r?qA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&HA(t,e,n),n};const Ne={getPeer:14,getPeers:15,chatMessage:16,getRoomName:17,getDisplayTitle:18,getPluginInitiator:19,customPluginEventToParent:20,peerJoined:22,peerLeft:23,sendData:24,stageStatusUpdate:25,peerStageStatusUpdate:26};let ri=(sg=class extends Xn{constructor(t,{baseURL:e,createdAt:r,description:n,id:i,name:a,organizationId:c,picture:d,private:l,published:h,staggered:m,tags:f,type:y,updatedAt:_},b,I,L,B,q){super();g(this,ft,void 0);p(this,"baseURL");p(this,"createdAt");p(this,"description");p(this,"id");p(this,"name");g(this,jt,void 0);g(this,bi,void 0);g(this,wi,void 0);p(this,"organizationId");p(this,"picture");p(this,"private");p(this,"published");p(this,"staggered");p(this,"tags");p(this,"type");p(this,"updatedAt");g(this,Xs,void 0);p(this,"config");g(this,Pi,void 0);p(this,"active");p(this,"iframes");p(this,"enabledBy");g(this,Pn,void 0);g(this,Ci,void 0);v(this,Pn,t),this.baseURL=e,this.createdAt=new Date(r),this.description=n,this.id=i,this.name=a,v(this,jt,I),this.organizationId=c,this.picture=d,this.private=l,this.published=h,this.staggered=m,this.tags=f,this.type=y,this.updatedAt=new Date(_),this.active=!1,this.iframes=new Map,v(this,ft,b),v(this,bi,L),v(this,wi,B),this.enabledBy="",v(this,Ci,q)}sendIframeEvent(t){this.iframes.size&&this.iframes.forEach(e=>{const{iframe:r}=e;r&&(navigator.isReactNative?r.postMessage(JSON.stringify(t)):r.contentWindow.postMessage(t,"*"))})}async handleIframeMessage(t){var a;if(!this.active)return;const e=t,{payload:r,uuid:n,type:i}=e;switch(i){case W.customPluginEventToRoom:{o(this,ft).customPluginEventToRoom(this.id,r,n);break}case W.customPluginEventToPeers:{o(this,ft).customPluginEventToPeers(this.id,r.peerIds,r,n);break}case W.enablePluginForRoom:{o(this,ft).enablePluginForRoom(this.id,n);break}case W.enablePluginForPeers:{o(this,ft).enablePluginForPeers(this.id,r.peerIds,n);break}case W.disablePluginForRoom:{o(this,ft).disablePluginForRoom(this.id,n);break}case W.disablePluginForPeers:{o(this,ft).disablePluginForPeers(this.id,r.peerIds,n);break}case W.storeInsertKeys:{o(this,ft).storeInsertKeys(this.id,r.store,r.insertKeys,n);break}case W.storeGetKeys:{o(this,ft).storeGetKeys(this.id,r.store,r.getKeys,n);break}case W.storeDeleteKeys:{o(this,ft).storeDeleteKeys(this.id,r.store,r.deleteKeys,n);break}case W.storeDelete:{o(this,ft).storeDelete(this.id,r.store,n);break}case Ne.chatMessage:{const{messagePayload:c,peerIds:d}=r;if(!o(this,wi)){this.sendIframeEvent({type:Ne.chatMessage,uuid:e.uuid,payload:{error:"Chat is disabled for this room."}});return}try{await o(this,wi).sendMessage(c,d),this.sendIframeEvent({type:Ne.chatMessage,uuid:e.uuid,payload:{success:!0}})}catch(l){this.sendIframeEvent({type:Ne.chatMessage,uuid:e.uuid,payload:{error:l}})}break}case Ne.getPeer:{let c;const{peerId:d}=r,l={...o(this,jt),id:o(this,jt).id,isRecorder:(a=o(this,jt).permissions)==null?void 0:a.isRecorder,isHidden:o(this,jt).permissions.hiddenParticipant,stageStatus:o(this,jt).stageStatus};d?(c=o(this,bi).joined.get(r.peerId),o(this,jt).id===d&&(c=l)):c=l,this.sendIframeEvent({type:Ne.getPeer,payload:{peer:c&&Lc(c)},uuid:e.uuid});break}case Ne.getPeers:{const c=o(this,bi).joined.toArray().map(d=>Lc(d));this.sendIframeEvent({type:Ne.getPeers,payload:{peers:c},uuid:e.uuid});break}case Ne.getPluginInitiator:{this.sendIframeEvent({type:Ne.getPluginInitiator,payload:{enabledBy:this.enabledBy},uuid:e.uuid});break}case Ne.getDisplayTitle:{this.sendIframeEvent({type:Ne.getDisplayTitle,payload:{displayTitle:o(this,Ci)},uuid:e.uuid});break}case Ne.getRoomName:{this.sendIframeEvent({type:Ne.getRoomName,payload:{roomName:o(this,Pn).getValue("meetingId")},uuid:e.uuid});break}case Ne.customPluginEventToParent:{this.emit(e.payload.eventName,e.payload.data);break}}}sendData(t){this.active&&(u.info("DytePlugin::SendData",{plugin:{id:this.id,name:this.name,data:{eventName:t.eventName}}}),this.sendIframeEvent({type:Ne.sendData,uuid:"",payload:t}))}removePluginView(t="default"){var n;const{iframe:e,listener:r}=(n=this.iframes.get(t))!=null?n:{};(e||r)&&(navigator.isReactNative?e.props.onMessage=void 0:window.removeEventListener("message",r),this.iframes.delete(t))}addPluginView(t,e="default"){var a;if(!o(this,Pi))throw u.error("DytePlugin::addPluginView::no_auth_token_set_for_plugin"),new P("No auth token set for plugin.","0602");if(!t)throw u.error("DytePlugin::addPluginView::iframe_was_not_provided"),new P("Iframe was not provided.","0603");this.removePluginView(e);const r=t,n=new URL(this.baseURL),i={auth:o(this,Pi),parent:navigator.isReactNative?this.baseURL:window.location.origin,backend:o(this,Pn).getValue("apiBase"),pluginId:this.id,roomName:(a=o(this,Pn).getValue("meetingId"))!=null?a:"",displayTitle:o(this,Ci)};if(Object.keys(i).forEach(c=>{n.searchParams.set(c,i[c])}),r.src=n.href,r.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",r.title=e,navigator.isReactNative)r.props.onMessage=c=>{this.handleIframeMessage(JSON.parse(c.nativeEvent.data))},this.iframes.set(e,{iframe:r});else{const c=async d=>{d.source===t.contentWindow&&await this.handleIframeMessage(d.data)};window.addEventListener("message",c),this.iframes.set(e,{iframe:r,listener:c})}}setActive(t){var e,r;if(this.active=t,t){this.emit("stateUpdate",{active:this.active,pluginId:this.id,bind:this.addPluginView.bind(this),views:(e=this.config)==null?void 0:e.views});return}this.active=!1,this.emit("stateUpdate",{active:this.active,pluginId:this.id,views:(r=this.config)==null?void 0:r.views})}async activateForSelf(){const t=nt(),e=await t.authorizePlugin(this.id);v(this,Pi,e),v(this,Xs,new Date);try{const r=await t.getPluginConfig(this.baseURL);this.config=r}catch(r){u.error("DytePlugin::activateForSelf",{error:r})}this.setActive(!0),this.emit("enabled")}deactivateForSelf(){Array.from(this.iframes.keys()).forEach(t=>{this.removePluginView(t)}),v(this,Xs,void 0),this.iframes.clear(),this.setActive(!1),this.emit("closed")}async enable(){return this.activateForSelf()}disable(){return this.deactivateForSelf()}async activate(){var t,e;this.active||(e=(t=o(this,jt).permissions)==null?void 0:t.plugins)!=null&&e.canStart&&(o(this,ft).addPlugin(this.id,this.staggered),v(this,Xs,new Date),u.info("plugin::activated",{plugin:{id:this.id,enabledBy:this.enabledBy,name:this.name}}))}async deactivate(){var t,e;this.active&&(!((e=(t=o(this,jt).permissions)==null?void 0:t.plugins)!=null&&e.canClose)&&this.enabledBy!==o(this,jt).id||(o(this,ft).removePlugin(this.id),u.info("plugin::deactivated",{plugin:{id:this.id,name:this.name,duration:o(this,Xs)?new Date().getTime()-o(this,Xs).getTime():0}}),v(this,Xs,void 0)))}},ft=new WeakMap,jt=new WeakMap,bi=new WeakMap,wi=new WeakMap,Xs=new WeakMap,Pi=new WeakMap,Pn=new WeakMap,Ci=new WeakMap,sg);Vc([Ot({maxInvocations:5,period:1})],ri.prototype,"sendData",1),Vc([T.trace("DytePlugin.activatePlugin")],ri.prototype,"activate",1),Vc([T.trace("DytePlugin.deactivatePlugin")],ri.prototype,"deactivate",1),ri=Vc([lt("0600")],ri);class Wm extends Map{constructor(e){const{onAddEvent:r,onDeleteEvent:n,onClearEvent:i}=e;super();g(this,$e,void 0);g(this,Cn,void 0);p(this,"onAddEvent");p(this,"onDeleteEvent");p(this,"onClearEvent");v(this,$e,new Xn),this.onAddEvent=r,this.onDeleteEvent=n,this.onClearEvent=i,v(this,Cn,new Map)}emit(e,...r){return o(this,$e).emit(e,...r)}on(e,r){return o(this,$e).on(e,r)}addListener(e,r){return o(this,$e).addListener(e,r)}off(e,r){return o(this,$e).off(e,r)}once(e,r){return o(this,$e).once(e,r)}prependListener(e,r){return o(this,$e).prependListener(e,r)}prependOnceListener(e,r){return o(this,$e).prependOnceListener(e,r)}removeListener(e,r){return o(this,$e).removeListener(e,r)}removeAllListeners(e){return o(this,$e).removeAllListeners(e)}listeners(e){return o(this,$e).listeners(e)}listenerCount(e){return o(this,$e).listenerCount(e)}getMaxListeners(){return o(this,$e).getMaxListeners()}setMaxListeners(e){return o(this,$e).setMaxListeners(e)}eventNames(){return o(this,$e).eventNames()}add(e,r=!0){return this.set(e.id,e,r)}set(e,r,n=!0){const i=super.set(e,r),a=(c,...d)=>{this.emit(c,r,...d)};return o(this,Cn).set(e,a),r.on("*",a),n&&o(this,$e).emit(this.onAddEvent,r),i}delete(e,r=!0,n=!1){const i=this.get(e);if(!i)return!1;i.removeListener("*",o(this,Cn).get(e));const a=super.delete(e);return n&&i.removeAllListeners(),r&&o(this,$e).emit(this.onDeleteEvent,i),a}clear(e=!0,r=!1){this.forEach(i=>{i.removeListener("*",o(this,Cn).get(i.id)),r&&i.removeAllListeners()});const n=super.clear();return e&&o(this,$e).emit(this.onClearEvent),n}toArray(){return Array.from(this.values())}}$e=new WeakMap,Cn=new WeakMap;class Jm extends Wm{constructor(){super({onAddEvent:"pluginAdded",onDeleteEvent:"pluginDeleted"})}add(t,e=!0){return super.add(t,e)}delete(t,e=!0,r=!1){return super.delete(t,e,r)}}var jA=Object.defineProperty,GA=Object.getOwnPropertyDescriptor,WA=(s,t,e,r)=>{for(var n=r>1?void 0:r?GA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&jA(t,e,n),n};let Kl=class{constructor(){p(this,"all");p(this,"active");this.all=new Jm,this.active=new Jm}};Kl=WA([lt("0600")],Kl);var JA=Object.defineProperty,KA=Object.getOwnPropertyDescriptor,Uc=(s,t,e,r)=>{for(var n=r>1?void 0:r?KA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&JA(t,e,n),n};const Km=(rg=class{constructor(s,t,e,r){p(this,"plugins");g(this,es,void 0);g(this,Ri,void 0);g(this,Ya,void 0);v(this,es,t),v(this,Ri,e),v(this,Ya,s),this.plugins=r,this.setupEvents()}static async init(s,t,e,r,n,i,a,c){const d=new Kl;return t.forEach(l=>{const h=new ri(s,l,e,i,a,n,c);d.all.add(h)}),new Km(s,e,r,d)}async getRoomPlugins(){var t;const{plugins:s}=await o(this,es).getActivePlugins();(t=this.plugins.active)==null||t.toArray().forEach(e=>{this.disablePlugin({id:e.id})}),await Promise.all(s.map(e=>this.enablePlugin({id:e.pluginId,enabledBy:e.enabledBy})))}async enablePlugin({id:s,enabledBy:t}){const e=this.plugins.all.get(s);e&&(await e.activateForSelf(),e.enabledBy=t)}async disablePlugin({id:s}){const t=this.plugins.all.get(s);t&&t.deactivateForSelf()}sendIframeEvent(s,t,e,r){const n=this.plugins.all.get(t);n&&n.sendIframeEvent({type:s,uuid:e,payload:r})}broadcastIframeEvent(s,t){this.plugins.active.forEach(e=>{this.sendIframeEvent(s,e.id,"",t)})}setupEvents(){this.plugins.all.on("stateUpdate",({active:s,id:t})=>{if(s){this.plugins.active.add(this.plugins.all.get(t));return}this.plugins.active.delete(t)}),R.onAsync(k.SOCKET_SERVICE_ROOM_JOINED,async()=>{await this.getRoomPlugins(),u.debug("[SOCKET_SERVICE_ROOM_JOINED] resolved request to fetch plugins.")}),o(this,es).on(W.addPlugin,async s=>{var e;const t=s.pluginId;(e=this.plugins.all.get(t))!=null&&e.active||await this.enablePlugin({id:t,enabledBy:s.enabledBy})}),o(this,es).on(W.removePlugin,async s=>{var e;const t=s.pluginId;(e=this.plugins.all.get(t))!=null&&e.active&&await this.disablePlugin({id:t})}),[W.enablePluginForPeers,W.enablePluginForRoom].forEach(s=>{o(this,es).on(s,async(t,e)=>{this.sendIframeEvent(s,t.pluginId,e,{enabledBy:t.enabledBy})})}),[W.disablePluginForPeers,W.disablePluginForRoom].forEach(s=>{o(this,es).on(s,async(t,e)=>{this.sendIframeEvent(s,t.pluginId,e,{disabledBy:t.disabledBy})})}),[W.customPluginEventToPeers,W.customPluginEventToRoom].forEach(s=>{o(this,es).on(s,async(t,e)=>{this.sendIframeEvent(s,t.pluginId,e,{data:JSON.parse(new TextDecoder().decode(t.pluginData))})})}),[W.storeInsertKeys,W.storeGetKeys,W.storeDeleteKeys].forEach(s=>{o(this,es).on(s,async(t,e)=>{var n;const r=(n=t.storeItems)==null?void 0:n.map(i=>{var a;return{timestamp:i.timestamp,peerId:i.peerId,payload:JSON.parse((a=i.payload)!=null&&a.length?new TextDecoder().decode(i.payload):"{}"),key:i.storeKey}});this.sendIframeEvent(s,t.pluginId,e,{storeName:t.storeName,storeItems:r})})}),o(this,es).on(W.storeDelete,async(s,t)=>{this.sendIframeEvent(W.storeDelete,s.pluginId,t,{storeName:s.storeName})}),o(this,Ri).on(Me.sendMessageToPeers,s=>{const t=ms==null?void 0:ms.formatSocketServiceMessage(s.message);this.broadcastIframeEvent(Ne.chatMessage,{message:t})}),o(this,Ri).on(Me.sendMessageToRoom,s=>{const t=ms==null?void 0:ms.formatSocketServiceMessage(s.message);this.broadcastIframeEvent(Ne.chatMessage,{message:t})}),R.on(k.PEER_JOINED_INTERNAL,s=>{const t=Lc(s);this.broadcastIframeEvent(Ne.peerJoined,t)}),R.on(k.PEER_CLOSED,s=>{this.broadcastIframeEvent(Ne.peerLeft,s)}),R.on(k.UPDATE_PEER_STAGE_STATUS,s=>{this.broadcastIframeEvent(Ne.peerStageStatusUpdate,s)}),o(this,Ya).subscribe("stageStatus",s=>{this.broadcastIframeEvent(Ne.stageStatusUpdate,s)})}},es=new WeakMap,Ri=new WeakMap,Ya=new WeakMap,rg);let Ca=Km;Uc([T.trace("PluginController.getRoomPlugins")],Ca.prototype,"getRoomPlugins",1),Uc([T.trace("PluginController.enableForSelf")],Ca.prototype,"enablePlugin",1),Uc([T.trace("PluginController.disableForSelf")],Ca.prototype,"disablePlugin",1),Uc([T.trace("PluginController.setupEvents")],Ca.prototype,"setupEvents",1);class zA{constructor(){p(this,"mediaJoined");p(this,"socketJoined");p(this,"socketJoinAttempted");p(this,"mediaJoinAttempted");p(this,"socketState");p(this,"mediaState");this.mediaJoined=!1,this.socketJoined=!1,this.socketJoinAttempted=!1,this.mediaJoinAttempted=!1,this.socketState={state:void 0,reconnected:!1,reconnectionAttempt:void 0},this.mediaState={recv:void 0,send:void 0}}get joinAttempted(){return this.mediaJoinAttempted||this.socketJoinAttempted}get roomJoined(){return this.mediaJoined&&this.socketJoined}updateSocketConnectionState(t,e){let r;const{reconnected:n}=this.socketState;switch(t){case"connected":r={state:"connected",reconnected:n,reconnectionAttempt:void 0};break;case"disconnected":r={state:"disconnected",reconnected:!1,reconnectionAttempt:0},this.socketJoined=!1;break;case"reconnected":r={state:"connected",reconnected:!0,reconnectionAttempt:void 0};break;case"reconnecting":r={state:"reconnecting",reconnected:n,reconnectionAttempt:0};break;case"reconnectAttempt":r={state:"reconnecting",reconnected:n,reconnectionAttempt:e};break;case"failed":r={state:"failed",reconnected:n,reconnectionAttempt:void 0},this.socketJoined=!1;break}r&&(R.emit(k.SOCKET_STATE_UPDATE,r),this.socketState=r)}}var YA=Object.defineProperty,QA=Object.getOwnPropertyDescriptor,Ra=(s,t,e,r)=>{for(var n=r>1?void 0:r?QA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&YA(t,e,n),n};let dn=(ng=class extends Ft{constructor(t,e){super();g(this,Ii);g(this,ki,void 0);g(this,Qa,void 0);p(this,"recordingPeerIds",[]);p(this,"recordings",[]);v(this,Qa,t),v(this,ki,e)}get recordingState(){return this.recordings.some(t=>t.state==="RECORDING")?"RECORDING":this.recordings.some(t=>t.state==="PAUSED")?"PAUSED":this.recordings.some(t=>t.state==="STARTING")?"STARTING":this.recordings.some(t=>t.state==="STOPPING")?"STOPPING":"IDLE"}updateRecordings(t){this.recordings=t,this.emit("recordingUpdate",this.recordingState)}async start(t){if(!o(this,ki).permissions.canRecord)throw u.error("DyteRecording::start::permission_denied"),new P("User does not have permission to start recording","1001");if((t==null?void 0:t.allowMultiple)!==!0&&(this.recordingState==="STARTING"||this.recordingState==="RECORDING"||this.recordingState==="STOPPING"))throw u.error("DyteRecording::start::recording_in_progress",{recording:{state:this.recordingState}}),new P(`Cant start recording, recordingState irregular: ${this.recordingState}`,"1005");try{const e=nt(),{recording:r={}}=o(this,Qa).getValue("defaults"),n=await e.startRecording(r,t==null?void 0:t.allowMultiple);this.updateRecordings([...this.recordings,{id:n,state:"STARTING",type:"BROWSER"}])}catch(e){throw u.error("DyteRecording::stop::recording_failed_to_start",{error:e}),new P("Error while starting recording","1000")}}async stop(t){await $(this,Ii,Hd).call(this,"stop",["RECORDING","PAUSED"],t)}async pause(t){await $(this,Ii,Hd).call(this,"pause",["RECORDING"],t)}async resume(t){await $(this,Ii,Hd).call(this,"resume",["PAUSED"],t)}},ki=new WeakMap,Qa=new WeakMap,Ii=new WeakSet,Hd=async function(t,e,r){if(!o(this,ki).permissions.canRecord)throw u.error("DyteRecording::stop::permission_denied"),new P("User does not have permission to stop recording","1001");let n=[];if(r!==void 0){const i=this.recordings.find(a=>a.id===r);if(i===void 0)throw new P("Could not find the specified recording","1004");if(e.includes(i.state)){u.error("DyteRecording::stop::recording_not_in_expected_state",{recording:{state:i.state}});return}n.push(i)}else n=this.recordings.filter(i=>e.includes(i.state));n.forEach(async i=>{const a=i.state;t==="stop"&&(i.state="STOPPING",this.emit("recordingUpdate","STOPPING"));try{await nt().updateRecording(i.id,t)}catch(c){throw u.error("DyteRecording::stop::recording_failed_to_stop",{error:c}),i.state!==a&&(i.state=a,this.emit("recordingUpdate",a)),new P("Error while stopping recording","1000")}})},ng);Ra([T.trace("DyteRecording.start")],dn.prototype,"start",1),Ra([T.trace("DyteRecording.stop")],dn.prototype,"stop",1),Ra([T.trace("DyteRecording.stop")],dn.prototype,"pause",1),Ra([T.trace("DyteRecording.stop")],dn.prototype,"resume",1),dn=Ra([lt("1000")],dn);var XA=Object.defineProperty,ZA=Object.getOwnPropertyDescriptor,e0=(s,t,e,r)=>{for(var n=r>1?void 0:r?ZA(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&XA(t,e,n),n};class zm{constructor(t,e,r){p(this,"recording");p(this,"room");g(this,vd,void 0);v(this,vd,t),this.recording=new dn(t,e),this.room=r,this.setupEvents()}getRecordingTypeFromProtoType(t){let e;switch(t){case sn.BROWSER:e="BROWSER";break;case sn.COMPOSITE:e="COMPOSITE";break;case sn.TRACK:e="TRACK";break;default:e="BROWSER"}return e}setupEvents(){R.on(k.ROOM_STATE,t=>{t.activeRecordings.length!==0?this.recording.updateRecordings(t.activeRecordings.map(e=>{const r=this.getRecordingTypeFromProtoType(e.recordingType);return{id:e.recordingId,state:e.recordingStatus,type:r}})):this.recording.recordings.length&&this.recording.updateRecordings([])}),this.room.on(V.recordingStarted,t=>{let e=!1;const r=[...this.recording.recordings];if(r.forEach(n=>{n.id===t.recordingId&&(e=!0,n.state="RECORDING")}),e===!1){const n=this.getRecordingTypeFromProtoType(t.recordingType);r.push({id:t.recordingId,state:"RECORDING",type:n})}this.recording.updateRecordings(r)}),this.room.on(V.recordingPaused,t=>{const e=[...this.recording.recordings];e.forEach(r=>{r.id===t.recordingId&&(r.state="PAUSED")}),this.recording.updateRecordings(e)}),this.room.on(V.recordingStopped,t=>{const e=[...this.recording.recordings.filter(r=>r.id!==t.recordingId)];this.recording.updateRecordings(e)})}}vd=new WeakMap,e0([T.trace("RecordingController.setupEvents")],zm.prototype,"setupEvents",1);class t0{static hasFeature(t){var e;return(e=ee.hasFeature(t))!=null?e:!1}static getFeatureValue(t){return ee.getValue(t)}static getAllFeatures(){return ee.getAllFlags()}}class zl{constructor(t,e,r){p(this,"logger");p(this,"features");p(this,"browserSpecs");p(this,"callStats");this.logger=t,this.features=e,this.browserSpecs=be,this.callStats=r}static init(t){return new zl(u,t0,t)}}class Yl{constructor(t){p(this,"internals");this.internals=t}static async init(){const t=zl.init(j);return new Yl(t)}}var s0=Object.defineProperty,r0=Object.getOwnPropertyDescriptor,$t=(s,t,e,r)=>{for(var n=r>1?void 0:r?r0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&s0(t,e,n),n};class Nt extends Xn{constructor(e,r,n=Ql,i=!0){super();g(this,ze,void 0);g(this,He,void 0);g(this,Ce,void 0);g(this,Is,void 0);g(this,ts,void 0);g(this,Xa,void 0);g(this,Td,void 0);p(this,"audioUpdateInProgress");p(this,"videoUpdateInProgress");v(this,Td,e),this.audioUpdateInProgress=!1,this.videoUpdateInProgress=!1,v(this,ze,new rf(e,r)),v(this,He,new D0(o(this,ze),void 0,n)),v(this,Ce,new F0(o(this,ze),void 0,n)),v(this,ts,new x0(o(this,ze))),v(this,Is,new N0(o(this,ze))),v(this,Xa,i),o(this,He).on("trackMuted",this.onAudioTrackMuted.bind(this)),o(this,He).on("trackChanged",this.onAudioTrackChanged.bind(this)),o(this,Ce).on("trackChanged",this.onVideoTrackChanged.bind(this)),o(this,Ce).on("trackEnded",this.onVideoTrackEnded.bind(this)),o(this,ts).on("trackEnded",this.onScreenShareEnded.bind(this)),this.onVisibilityChange=this.onVisibilityChange.bind(this),document.addEventListener("visibilitychange",this.onVisibilityChange)}async onVisibilityChange(){j.tabChanged(document.visibilityState==="visible"),document.visibilityState!=="visible"?j.browserBackgrounded():(j.browserForegrounded(),await this.setupSpeaker())}async repopulateAvailableDevices(){return!0}async setupStreams({audio:e,video:r}){var a;e?j.audioOn():j.audioOff(),r?j.videoOn():j.videoOff();let n,i;if(e&&r)try{const c=await o(this,ze).getAudioAndVideoTrack(o(this,He).userSelectedDevice,o(this,Ce).userSelectedDevice);n=c.audioTrack,i=c.videoTrack}catch(c){u.error("LocalMediaHandler::init::Failed to get audio video tracks",{error:c})}if(!n&&e)try{n=await o(this,ze).getAudioTrack(!1,o(this,He).userSelectedDevice)}catch(c){u.error("LocalMediaHandler::init::Failed to get audio track",{error:c})}if(!i&&r)try{i=await o(this,ze).getVideoTrack(o(this,Ce).userSelectedDevice)}catch(c){u.error("LocalMediaHandler::init::Failed to get video track",{error:c})}e&&!n&&j.audioOff(),r&&!i&&j.videoOff(),await o(this,He).setMediaTrack(n),await o(this,Ce).setMediaTrack(i);try{await o(this,Is).setupSpeaker()}catch(c){}if(i){const c=await this.getDeviceById(i.getSettings().deviceId);j.selectedDevice("VIDEO",c)}if(n){const c=await this.getDeviceById(n.getSettings().deviceId);j.selectedDevice("AUDIO",c)}(a=o(this,Is).currentDevice)!=null&&a.deviceId&&j.selectedDevice("SPEAKER",o(this,Is).currentDevice),o(this,ze).onDeviceChange((c,d,l)=>{this.onDeviceChange(d,l)})}getCurrentDevices(){return{audio:o(this,He).currentDevice,video:o(this,Ce).currentDevice,speaker:o(this,Is).currentDevice}}get permissions(){return o(this,ze).permissions}getAllDevices(){return o(this,ze).getAvailableDevices()}getDeviceById(e,r){return o(this,ze).getDevice(e)}onAudioTrackMuted(){this.emit("AUDIO_TRACK_SILENT")}onAudioTrackChanged(){this.emit("AUDIO_TRACK_CHANGE")}get rawAudioTrack(){return o(this,He).mediaTrack}get audioTrack(){return o(this,He).transformedMediaTrack}get audioEnabled(){return o(this,He).trackEnabled}async enableAudio(){if(!this.audioUpdateInProgress){this.audioUpdateInProgress=!0;try{await o(this,He).unmuteTrack()}catch(e){}finally{this.audioUpdateInProgress=!1}}}disableAudio(){o(this,He).muteTrack()}getAudioDevices(e){return o(this,ze).getAudioInputDevices(e)}async setAudioDevice(e){await o(this,He).setDevice(e),e!=null&&e.deviceId&&j.selectedDevice("AUDIO",e),this.emit("AUDIO_TRACK_CHANGE"),this.emit("DEVICE_CHANGE",{device:e})}setupSpeaker(){return o(this,Is).setupSpeaker()}async setSpeakerDevice(e){await o(this,Is).setupSpeaker(e),e!=null&&e.deviceId&&j.selectedDevice("SPEAKER",e),this.emit("DEVICE_CHANGE",{device:e})}onVideoTrackChanged(){this.emit("VIDEO_TRACK_CHANGE")}onVideoTrackEnded(){this.emit("VIDEO_TRACK_CHANGE")}get rawVideoTrack(){return o(this,Ce).mediaTrack}get videoTrack(){return o(this,Ce).transformedMediaTrack}get videoEnabled(){return o(this,Ce).trackEnabled}async enableVideo(){if(!this.videoUpdateInProgress){this.videoUpdateInProgress=!0;try{await o(this,Ce).unmuteTrack()}catch(e){}finally{this.videoUpdateInProgress=!1}}}disableVideo(){o(this,Ce).disableTrack()}getVideoDevices(e){return o(this,ze).getVideoInputDevices(e)}async setVideoDevice(e){await o(this,Ce).setDevice(e),e!=null&&e.deviceId&&j.selectedDevice("VIDEO",e),this.emit("VIDEO_TRACK_CHANGE"),this.emit("DEVICE_CHANGE",{device:e})}async updateVideoConstraints(e){await o(this,Ce).updateConstraints(e)}onScreenShareEnded(){this.emit("SCREENSHARE_ENDED")}get screenShareTracks(){return{audio:o(this,ts).audioMediaTrack,video:o(this,ts).videoMediaTrack}}get screenShareEnabled(){return o(this,ts).trackEnabled}async enableScreenShare(){await o(this,ts).enableScreenShare()}async disableScreenShare(){o(this,ts).disableScreenShare()}async updateScreenshareConstraints(e){await o(this,ts).updateConstraints(e)}getSpeakerDevices(e){return o(this,ze).getAudioOutputDevices(e)}addAudioMiddleware(e){return o(this,He).addMiddleware(e)}removeAudioMiddleware(e){return o(this,He).removeMiddleware(e)}removeAllAudioMiddlewares(){return o(this,He).removeAllMiddlewares()}addVideoMiddleware(e){return o(this,Ce).addMiddleware(e)}removeVideoMiddleware(e){return o(this,Ce).removeMiddleware(e)}removeAllVideoMiddlewares(){return o(this,Ce).removeAllMiddlewares()}setVideoMiddlewareGlobalConfig(e){return o(this,Ce).setVideoMiddlewareGlobalConfig(e)}destruct(){o(this,He).disableTrack(),o(this,Ce).disableTrack(),o(this,Ce).terminateMiddlewareWebWorker(),o(this,ts).disableScreenShare(),o(this,ze).destruct()}async onDeviceChange(e,r){var n,i;this.emit("DEVICE_LIST_UPDATED",e),!(r||!o(this,Xa))&&((n=e==null?void 0:e.added)==null||n.forEach(async a=>{var c;a&&!Ql(a)&&(a.kind==="audioinput"&&((c=this.audioTrack)==null?void 0:c.enabled)===!0?await this.setAudioDevice(a):a.kind==="audiooutput"&&await this.setSpeakerDevice(a))}),(i=e==null?void 0:e.removed)==null||i.forEach(async a=>{var c;if(a.kind==="audiooutput"&&((c=this.getCurrentDevices().speaker)==null?void 0:c.deviceId)===a.deviceId){const d=(await this.getSpeakerDevices()).find(l=>l.deviceId!==a.deviceId);d&&await this.setSpeakerDevice(d)}}))}removeAllTracks(){this.destruct()}removeAudioTrack(){o(this,He).disableTrack()}removeVideoTrack(){o(this,Ce).disableTrack(),o(this,Ce).terminateMiddlewareWebWorker()}async removeDocumentEventListeners(){document.removeEventListener("visibilitychange",this.onVisibilityChange)}}ze=new WeakMap,He=new WeakMap,Ce=new WeakMap,Is=new WeakMap,ts=new WeakMap,Xa=new WeakMap,Td=new WeakMap,$t([T.trace("MediaHandler.setupStreams")],Nt.prototype,"setupStreams",1),$t([T.trace("MediaHandler.enableAudio")],Nt.prototype,"enableAudio",1),$t([T.trace("MediaHandler.disableAudio")],Nt.prototype,"disableAudio",1),$t([T.trace("MediaHandler.setAudioDevice")],Nt.prototype,"setAudioDevice",1),$t([T.trace("MediaHandler.enableVideo")],Nt.prototype,"enableVideo",1),$t([T.trace("MediaHandler.disableVideo")],Nt.prototype,"disableVideo",1),$t([T.trace("MediaHandler.setVideoDevice")],Nt.prototype,"setVideoDevice",1),$t([T.trace("MediaHandler.updateVideoConstraints")],Nt.prototype,"updateVideoConstraints",1),$t([T.trace("MediaHandler.enableScreenShare")],Nt.prototype,"enableScreenShare",1),$t([T.trace("MediaHandler.disableScreenShare")],Nt.prototype,"disableScreenShare",1),$t([T.trace("MediaHandler.updateScreenshareConstraints")],Nt.prototype,"updateScreenshareConstraints",1),$t([T.trace("MediaHandler.destruct")],Nt.prototype,"destruct",1),$t([T.trace("MediaHandler.onDeviceChange")],Nt.prototype,"onDeviceChange",1);function Fc(s,t,e){switch(!0){case be.isChromiumBased():switch(t){case"NotAllowedError":return e.includes("by system")?"SYSTEM_DENIED":s==="screenshare"?"CANCELED":"DENIED";case"NotReadableError":default:return"COULD_NOT_START"}case be.isSafari():switch(t){case"NotAllowedError":return"DENIED";default:return"COULD_NOT_START"}case be.isFirefox():switch(t){case"NotFoundError":case"NotReadableError":return"SYSTEM_DENIED";case"NotAllowedError":return"DENIED";case"AbortError":default:return"COULD_NOT_START"}default:return"COULD_NOT_START"}}const n0=["virtual","emulator","krisp","solstice conference","teams","loom","zoom","manycam","blackhole","displayport","xsplit","wirecast","vMix","elgato","epiphan","voice changer","voicemod","morphvoxx"];function Ql(s){var e,r;const t=(e=s.label)==null?void 0:e.toLowerCase();return((r=be._bowser)==null?void 0:r.getOSName())==="macOS"&&t.includes("iphone")?(u.log("isVirtualDevice::ignore_macos_continuity"),!0):n0.some(n=>t==null?void 0:t.includes(n))}async function i0(s,t){if(!(s!=null&&s.length))return t;const e=new AudioContext,r=await Promise.all(s==null?void 0:s.map(a=>a(e))),n=e.createMediaStreamSource(new MediaStream([t])),i=e.createMediaStreamDestination();try{let a=n;for(let c=0;c<r.length;c+=1)a.connect(r[c]),a=r[c];a.connect(i)}catch(a){return u.error("getTransformedAudioTrack::middleware_execution_failed",{error:a}),t}return i.stream.getAudioTracks()[0]}const a0=s=>(t,e)=>(s.set(t,e),e),Ym=Number.MAX_SAFE_INTEGER===void 0?9007199254740991:Number.MAX_SAFE_INTEGER,Qm=536870912,Xm=Qm*2,o0=(s,t)=>e=>{const r=t.get(e);let n=r===void 0?e.size:r<Xm?r+1:0;if(!e.has(n))return s(e,n);if(e.size<Qm){for(;e.has(n);)n=Math.floor(Math.random()*Xm);return s(e,n)}if(e.size>Ym)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;e.has(n);)n=Math.floor(Math.random()*Ym);return s(e,n)},Zm=new WeakMap,c0=a0(Zm),Bc=o0(c0,Zm),d0=s=>s.method!==void 0&&s.method==="call",l0=s=>s.error===null&&typeof s.id=="number",$c=((s,t)=>{let e=null;return()=>{if(e!==null)return e;const r=new Blob([t],{type:"application/javascript; charset=utf-8"}),n=URL.createObjectURL(r);return e=s(n),setTimeout(()=>URL.revokeObjectURL(n)),e}})(s=>{const t=new Map([[0,()=>{}]]),e=new Map([[0,()=>{}]]),r=new Map,n=new Worker(s);return n.addEventListener("message",({data:l})=>{if(d0(l)){const{params:{timerId:h,timerType:m}}=l;if(m==="interval"){const f=t.get(h);if(typeof f=="number"){const y=r.get(f);if(y===void 0||y.timerId!==h||y.timerType!==m)throw new Error("The timer is in an undefined state.")}else if(typeof f!="undefined")f();else throw new Error("The timer is in an undefined state.")}else if(m==="timeout"){const f=e.get(h);if(typeof f=="number"){const y=r.get(f);if(y===void 0||y.timerId!==h||y.timerType!==m)throw new Error("The timer is in an undefined state.")}else if(typeof f!="undefined")f(),e.delete(h);else throw new Error("The timer is in an undefined state.")}}else if(l0(l)){const{id:h}=l,m=r.get(h);if(m===void 0)throw new Error("The timer is in an undefined state.");const{timerId:f,timerType:y}=m;r.delete(h),y==="interval"?t.delete(f):e.delete(f)}else{const{error:{message:h}}=l;throw new Error(h)}}),{clearInterval:l=>{const h=Bc(r);r.set(h,{timerId:l,timerType:"interval"}),t.set(l,h),n.postMessage({id:h,method:"clear",params:{timerId:l,timerType:"interval"}})},clearTimeout:l=>{const h=Bc(r);r.set(h,{timerId:l,timerType:"timeout"}),e.set(l,h),n.postMessage({id:h,method:"clear",params:{timerId:l,timerType:"timeout"}})},setInterval:(l,h=0)=>{const m=Bc(t);return t.set(m,()=>{l(),typeof t.get(m)=="function"&&n.postMessage({id:null,method:"set",params:{delay:h,now:performance.now(),timerId:m,timerType:"interval"}})}),n.postMessage({id:null,method:"set",params:{delay:h,now:performance.now(),timerId:m,timerType:"interval"}}),m},setTimeout:(l,h=0)=>{const m=Bc(e);return e.set(m,l),n.postMessage({id:null,method:"set",params:{delay:h,now:performance.now(),timerId:m,timerType:"timeout"}}),m}}},`(()=>{"use strict";const e=new Map,t=new Map,r=(e,t)=>{let r,o;const i=performance.now();r=i,o=e-Math.max(0,i-t);return{expected:r+o,remainingDelay:o}},o=(e,t,r,i)=>{const s=performance.now();s>r?postMessage({id:null,method:"call",params:{timerId:t,timerType:i}}):e.set(t,setTimeout(o,r-s,e,t,r,i))};addEventListener("message",(i=>{let{data:s}=i;try{if("clear"===s.method){const{id:r,params:{timerId:o,timerType:i}}=s;if("interval"===i)(t=>{const r=e.get(t);if(void 0===r)throw new Error('There is no interval scheduled with the given id "'.concat(t,'".'));clearTimeout(r),e.delete(t)})(o),postMessage({error:null,id:r});else{if("timeout"!==i)throw new Error('The given type "'.concat(i,'" is not supported'));(e=>{const r=t.get(e);if(void 0===r)throw new Error('There is no timeout scheduled with the given id "'.concat(e,'".'));clearTimeout(r),t.delete(e)})(o),postMessage({error:null,id:r})}}else{if("set"!==s.method)throw new Error('The given method "'.concat(s.method,'" is not supported'));{const{params:{delay:i,now:n,timerId:a,timerType:d}}=s;if("interval"===d)((t,i,s)=>{const{expected:n,remainingDelay:a}=r(t,s);e.set(i,setTimeout(o,a,e,i,n,"interval"))})(i,a,n);else{if("timeout"!==d)throw new Error('The given type "'.concat(d,'" is not supported'));((e,i,s)=>{const{expected:n,remainingDelay:a}=r(e,s);t.set(i,setTimeout(o,a,t,i,n,"timeout"))})(i,a,n)}}}}catch(e){postMessage({error:{message:e.message},id:s.id,result:null})}}))})();`),ef=s=>$c().clearInterval(s),u0=s=>$c().clearTimeout(s),tf=(s,t)=>$c().setInterval(s,t),h0=Object.freeze(Object.defineProperty({__proto__:null,clearInterval:ef,clearTimeout:u0,setInterval:tf,setTimeout:(s,t)=>$c().setTimeout(s,t)},Symbol.toStringTag,{value:"Module"}));class p0{constructor(){g(this,Rn,void 0)}terminateMiddlewareWebWorker(){if(o(this,Rn))try{ef(o(this,Rn)),v(this,Rn,void 0)}catch(t){u.debug("WorkerTimers::terminateMiddlewareWebWorker::failed")}}async getTransformedVideoTrack(t,e,r){if(!(t!=null&&t.length))return e;const n=document.createElement("canvas"),i=await Promise.all(t==null?void 0:t.map(f=>f({canvas:n,WorkerTimers:h0})));if(r.disablePerFrameCanvasRendering){const y=n.captureStream().getVideoTracks()[0];return Object.defineProperty(y,"originalSettings",{value:e.getSettings()}),y}const a=document.createElement("video"),c=new MediaStream;c.addTrack(e);const d=n.getContext("2d");a.srcObject=c,a.autoplay=!0,this.terminateMiddlewareWebWorker();const l=async()=>{if(e.enabled===!1||e.readyState==="ended"){this.terminateMiddlewareWebWorker(),a.remove(),n.remove();return}try{d.drawImage(a,0,0);for(let f=0;f<i.length;f+=1)typeof i[f]=="function"&&await i[f](n,d)}catch(f){u.error("getTransformedVideoTrack::middleware_execution_failed",{error:f})}};try{a.play()}catch(f){}a.addEventListener("play",()=>{n.width=a.width||e.getSettings().width,n.height=a.width||e.getSettings().height,v(this,Rn,tf(l,50))},!1);const m=n.captureStream().getVideoTracks()[0];return Object.defineProperty(m,"originalSettings",{value:e.getSettings()}),m}}Rn=new WeakMap;const sf={gross:{width:{ideal:192},height:{ideal:144}},qvga:{width:{ideal:384},height:{ideal:288}},pvga:{width:{ideal:480},height:{ideal:360}},vga:{width:{ideal:640},height:{ideal:480}},hd:{width:{ideal:1280},height:{ideal:720}},hd_cropped:{width:{ideal:900},height:{ideal:720}},fhd:{width:{ideal:1920},height:{ideal:1080}}},m0=[[320,[{rid:"q",maxBitrate:25e4,maxFramerate:24,scalabilityMode:"L1T1"}]],[640,[{rid:"q",scaleResolutionDownBy:2,maxBitrate:25e4,maxFramerate:24,scalabilityMode:"L1T1"},{rid:"h",maxBitrate:7e5,maxFramerate:30,scalabilityMode:"L1T1"}]],[1280,[{rid:"q",scaleResolutionDownBy:2,maxBitrate:5e5,maxFramerate:24,scalabilityMode:"L1T1"},{rid:"h",maxBitrate:13e5,maxFramerate:30,scalabilityMode:"L1T1"}]],[1920,[{rid:"q",scaleResolutionDownBy:2,maxBitrate:9e5,maxFramerate:24,scalabilityMode:"L1T1"},{rid:"h",maxBitrate:15e5,maxFramerate:30,scalabilityMode:"L1T1"}]]],f0=s=>{var a;const t="getSettings"in s&&s.getSettings().width||"getConstraints"in s&&s.getConstraints().width||"originalSettings"in s&&((a=s.originalSettings)==null?void 0:a.width);let e=m0;ee.hasFeature(se.OVERRIDE_HIVE_SIMULCAST_DYNAMIC)&&(e=JSON.parse(ee.getValue(se.OVERRIDE_HIVE_SIMULCAST_DYNAMIC)));const r=e.map(([c])=>c).sort((c,d)=>c-d);let n=Number.MAX_VALUE,i=0;return r.forEach((c,d)=>{Math.abs(c-t)<n&&(n=Math.abs(c-t),i=d)}),e[i][1]};var Le=(s=>(s.WEBCAM="webcam",s.WEBCAM_BACKUP="webcam_backup",s.MIC="mic",s.SCREENSHARE_VIDEO="screenshare_video",s.SCREENSHARE_AUDIO="screenshare_audio",s))(Le||{});const g0=TE(),ni=ps(g0.config.media);function v0(s){var e,r;const t={};return s.audio&&(t.audio={enableStereo:(e=s.audio.enableStereo)!=null?e:!1,enableHighBitrate:(r=s.audio.enableHighBitrate)!=null?r:!1}),t.video=s.video.quality,t}class T0{constructor(t,e){g(this,kn,void 0);g(this,yd,void 0);p(this,"getScreenShareConstraints",()=>{var l,h,m,f,y,_,b,I,L,B,q;const t=(l=o(this,kn))==null?void 0:l.screenshare,e=(m=(h=t==null?void 0:t.width)==null?void 0:h.max)!=null?m:1920,r=(y=(f=t==null?void 0:t.height)==null?void 0:f.max)!=null?y:1080,n=(b=(_=t==null?void 0:t.frameRate)==null?void 0:_.max)!=null?b:5;let i=(L=(I=t==null?void 0:t.frameRate)==null?void 0:I.ideal)!=null?L:5;const a=t==null?void 0:t.displaySurface,c=t==null?void 0:t.selfBrowserSurface;ee.getValue(se.VAL_MIN_FRAMERATE)&&(i=parseInt((B=ee.getValue(se.VAL_MIN_FRAMERATE))==null?void 0:B.toString(),10));let d={width:{max:e},height:{max:r},frameRate:{ideal:i,max:n}};if(ee.hasFeature(se.SCREENSHARE_CONSTRAINTS)){const F=(q=ee.getValue(se.SCREENSHARE_CONSTRAINTS))==null?void 0:q.toString();d=JSON.parse(F)}return a!==void 0&&["monitor","browser","window"].includes(a)&&(d={...d,displaySurface:a}),c!==void 0&&(d={...d,selfBrowserSurface:c}),{audio:!0,video:d}});p(this,"getAudioConstraints",t=>{var i,a,c,d,l,h,m,f;const e={},r=(i=o(this,kn))==null?void 0:i.audio,n=r!=null&&r.enableStereo?2:1;return be.isFirefox()||be.isWebKitBased()?(e.audio={deviceId:t,autoGainControl:(a=r==null?void 0:r.autoGainControl)!=null?a:!0,echoCancellation:(c=r==null?void 0:r.echoCancellation)!=null?c:!0,noiseSuppression:(d=r==null?void 0:r.noiseSupression)!=null?d:!0,channelCount:n},e):(e.audio={},e.audio.optional=[t?{sourceId:t}:{sourceId:"default"},{channelCount:n},{echoCancellation:(l=r==null?void 0:r.echoCancellation)!=null?l:!0},{googEchoCancellation:(h=r==null?void 0:r.echoCancellation)!=null?h:!0},{googAutoGainControl:(m=r==null?void 0:r.autoGainControl)!=null?m:!0},{googNoiseSuppression:(f=r==null?void 0:r.noiseSupression)!=null?f:!0},{googHighpassFilter:!0}],e)});p(this,"getVideoConstraints",t=>{var i,a,c,d;const e={},r=(i=o(this,kn))==null?void 0:i.video;let n=sf.vga;if(typeof r=="string"?n=sf[r]:r!==void 0&&(n.height.ideal=r.height.ideal,n.width.ideal=r.width.ideal),n.frameRate={ideal:(c=(a=n.frameRate)==null?void 0:a.ideal)!=null?c:24},be.isChromiumBased()&&(n.frameRate.max=30),ee.hasFeature(se.VIDEO_CONSTRAINTS)){const l=(d=ee.getValue(se.VIDEO_CONSTRAINTS))==null?void 0:d.toString();n=JSON.parse(l)}return e.video=n,typeof e.video=="boolean"||(t?e.video.deviceId={exact:t}:e.video.facingMode="user"),e});v(this,yd,t),v(this,kn,e)}getUpdatedVideoConstraints(t){return t}}kn=new WeakMap,yd=new WeakMap;class Xl extends Error{constructor(e,r,n){super(r);p(this,"constraints");p(this,"name");this.name=e,this.constraints=n}}class y0{constructor(){p(this,"permissions");this.permissions={audio:"NOT_REQUESTED",video:"NOT_REQUESTED",screenshare:"NOT_REQUESTED"}}async getAudioInputDevices(t){let e=t;return t||(e=await this.getAvailableDevices()),e.filter(r=>r.kind==="audioinput")}async getVideoInputDevices(t){let e=t;return t||(e=await this.getAvailableDevices()),e.filter(r=>r.kind==="videoinput")}async getAudioOutputDevices(t){let e=t;return t||(e=await this.getAvailableDevices()),e.filter(r=>r.kind==="audiooutput")}}var S0=Object.defineProperty,E0=Object.getOwnPropertyDescriptor,fs=(s,t,e,r)=>{for(var n=r>1?void 0:r?E0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&S0(t,e,n),n};let Ht=(ig=class extends y0{constructor(t,e){super();p(this,"availableDevices");g(this,Ai,void 0);g(this,ss,void 0);g(this,Sd,void 0);v(this,Sd,t),v(this,ss,new T0(t,e)),v(this,Ai,new AbortController),this.availableDevices=[],this.getAvailableDevices()}get constraintsBuilder(){return o(this,ss)}async destruct(){var t;(t=o(this,Ai))==null||t.abort()}handlePermissionErrors(t,e){const r=Fc(t,e.name,e.message);return this.permissions[t]=r,R.emit(k.MEDIA_PERMISSION_ERROR,{message:r,constraints:e.constraints,kind:t}),r}async getAudioAndVideoTrack(t,e){const r={audio:o(this,ss).getAudioConstraints(t).audio,video:o(this,ss).getVideoConstraints(e).video};try{u.info("getUserMediaWithoutTimeout::requesting_user_media",{constraints:JSON.stringify(r)});const n=await navigator.mediaDevices.getUserMedia(r);u.info("getUserMediaWithoutTimeout::received_user_media",{constraints:JSON.stringify(r)});const i=n.getAudioTracks()[0];let a=n.getVideoTracks()[0];if(this.permissions.audio="ACCEPTED",this.permissions.video="ACCEPTED",ee.hasFeature(se.OBS_QUALITY)&&a.label.includes("OBS Virtual")){const l=(await this.getVideoInputDevices()).find(h=>h.label.includes("OBS Virtual"));a=await this.getVideoTrack(l.deviceId)}return R.emit(k.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}),R.emit(k.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"}),{audioTrack:i,videoTrack:a}}catch(n){throw u.error("WebMediaInterface.getAudioAndVideoTrack",{error:n}),new P("Couldnt fetch audio and video track","1605")}}async getAudioTrack(t,e){let r=await this.getAudioInputDevices();if(r.length===0)throw this.permissions.audio="NO_DEVICES_AVAILABLE",R.emit(k.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}),new P("No audio devices available","1606");const n=async i=>{let a;try{r=r.filter(d=>d.deviceId!==i),a=o(this,ss).getAudioConstraints(i),u.info("getUserMediaWithoutTimeout::requesting_user_media",{constraints:JSON.stringify(a)});const[c]=(await navigator.mediaDevices.getUserMedia(a)).getAudioTracks();return u.info("getUserMediaWithoutTimeout::received_user_media",{constraints:JSON.stringify(a)}),c}catch(c){const d=Fc("audio",c.name,c.message),l=new Xl(c.name,c.message,a);if(d==="COULD_NOT_START"){const h=r.shift();if(!h)throw l;u.info("getAudioTrack::gum_failed",{constraints:JSON.stringify(a),error:c});const m=o(this,ss).getAudioConstraints(h.deviceId);return u.info("getAudioTrack::retrying_gum_for_next_device",{constraints:JSON.stringify(m)}),n(h.deviceId)}throw l}};try{const i=await n(e);return i.enabled=!t,this.permissions.audio!=="ACCEPTED"&&(this.permissions.audio="ACCEPTED",R.emit(k.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"})),i}catch(i){throw i.constraints&&this.handlePermissionErrors("audio",i),new P(i.message,"1601")}}async getVideoTrack(t){var c;const e=ee.hasFeature(se.OBS_QUALITY),r=(c=await this.getCurrentDeviceLabel(t))==null?void 0:c.includes("OBS Virtual"),n=e&&r,i=await this.getVideoInputDevices();if(i.length===0)throw this.permissions.video="NO_DEVICES_AVAILABLE",R.emit(k.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"}),new P("No video devices available","1607");const a=async d=>{try{let l=d;const{video:h}=l;n&&typeof h!="boolean"&&(l={video:{deviceId:h.deviceId}}),u.info("getUserMediaWithoutTimeout::requesting_user_media",{constraints:JSON.stringify(l)});const[m]=(await navigator.mediaDevices.getUserMedia(l)).getVideoTracks();if(n&&typeof h!="boolean"&&typeof h.width=="object"){const{width:f,height:y}=m.getSettings(),{ideal:_}=h.width;m.applyConstraints({width:{ideal:_},height:{ideal:Math.floor(y*_/f)},frameRate:h.frameRate})}return u.info("getUserMediaWithoutTimeout::received_user_media",{constraints:JSON.stringify(l)}),m}catch(l){const h=Fc("video",l.name,l.message),m=new Xl(l.name,l.message,d);if(h==="COULD_NOT_START"){const f=i.shift();if(!f)throw m;u.info("getVideoTrack::gum_failed",{constraints:JSON.stringify(d),error:l});const y=o(this,ss).getVideoConstraints(f.deviceId);return u.info("getVideoTrack::retrying_gum_for_next_device",{constraints:JSON.stringify(y)}),a({video:y.video})}throw m}};try{const d=o(this,ss).getVideoConstraints(t),l=await a(d);return this.permissions.video!=="ACCEPTED"&&(this.permissions.video="ACCEPTED",R.emit(k.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"})),l}catch(d){throw d.constraints&&this.handlePermissionErrors("video",d),new P(d.message,"1602")}}async getScreenShareTracks(){const t=async e=>{try{u.info("getDisplayMediaWithoutTimeout::requesting_display_media",{constraints:JSON.stringify(e)}),j.screenShareRequested();const r=await navigator.mediaDevices.getDisplayMedia(e);return u.info("getDisplayMediaWithoutTimeout::received_display_media",{constraints:JSON.stringify(e)}),r}catch(r){const n=Fc("video",r.name,r.message),i=new Xl(r.name,r.message,e),a={video:!0};if(U_(e,a)||!ee.hasFeature(se.SCREEENSHARE_CONSTRAINTS_RETRY))throw i;if(n==="COULD_NOT_START")return t(a);throw i}};try{const e=o(this,ss).getScreenShareConstraints(),r=await t(e);return this.permissions.screenshare!=="ACCEPTED"&&(this.permissions.screenshare="ACCEPTED",R.emit(k.MEDIA_PERMISSION_UPDATE,{message:this.permissions.screenshare,kind:"screenshare"})),{audioTrack:r.getAudioTracks()[0],videoTrack:r.getVideoTracks()[0]}}catch(e){throw e.constraints&&this.handlePermissionErrors("screenshare",e),new P(e.message,"1612")}}async getCurrentDeviceLabel(t){const e=await this.getDevice(t||"default");return e==null?void 0:e.label}async getAvailableDevices(){try{const t=await navigator.mediaDevices.enumerateDevices();return this.availableDevices=t,t}catch(t){throw u.error("enumerate_devices_failed",{error:t}),new P("Failed to get available devices","1609")}}async getAvailableDevicesByKind(t){try{return(await navigator.mediaDevices.enumerateDevices()).filter(({kind:e})=>t===e)}catch(e){throw u.error("enumerate_devices_failed",{error:e}),new P("Failed to get available devices by kind","1609")}}async getDevice(t){try{return(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.deviceId===t)[0]}catch(e){throw u.error("enumerate_devices_failed",{error:e}),new P("Failed to get device","1609")}}async onDeviceChange(t){be.supportsDeviceChangeEvent()&&navigator.mediaDevices.addEventListener("devicechange",async e=>{var l,h;const r=m=>`${m.kind}-${m.deviceId}-${m.groupId}`,n=this.availableDevices,i=new Set(n.map(m=>r(m))),a=await this.getAvailableDevices(),c=new Set(a.map(m=>r(m))),d={added:a.filter(m=>!i.has(r(m))),removed:n.filter(m=>!c.has(r(m))),devices:a};if((l=d.added)!=null&&l.length||(h=d.removed)!=null&&h.length){u.info("repopulated_full_device_list",{devices:JSON.stringify(a)});const m=[...d.added,...d.removed];m.some(f=>f.kind==="audioinput")&&j.devices("AUDIO",a==null?void 0:a.filter(f=>f.kind==="audioinput")),m.some(f=>f.kind==="videoinput")&&j.devices("VIDEO",a==null?void 0:a.filter(f=>f.kind==="videoinput")),m.some(f=>f.kind==="audiooutput")&&j.devices("SPEAKER",a==null?void 0:a.filter(f=>f.kind==="audiooutput")),t(e,d,!1)}},{signal:o(this,Ai).signal})}},Ai=new WeakMap,ss=new WeakMap,Sd=new WeakMap,ig);fs([T.trace("WebMediaInterface.destruct")],Ht.prototype,"destruct",1),fs([T.trace("WebMediaInterface.handlePermissionErrors")],Ht.prototype,"handlePermissionErrors",1),fs([T.trace("WebMediaInterface.getAudioAndVideoTrack")],Ht.prototype,"getAudioAndVideoTrack",1),fs([T.trace("WebMediaInterface.getAudioTrack")],Ht.prototype,"getAudioTrack",1),fs([T.trace("WebMediaInterface.getVideoTrack")],Ht.prototype,"getVideoTrack",1),fs([T.trace("WebMediaInterface.getScreenShareTracks")],Ht.prototype,"getScreenShareTracks",1),fs([T.trace("WebMediaInterface.getAvailableDevices")],Ht.prototype,"getAvailableDevices",1),fs([T.trace("WebMediaInterface.getAvailableDevicesByKind")],Ht.prototype,"getAvailableDevicesByKind",1),fs([T.trace("WebMediaInterface.getDevice")],Ht.prototype,"getDevice",1),fs([T.trace("WebMediaInterface.onDeviceChange")],Ht.prototype,"onDeviceChange",1),Ht=fs([lt("1600")],Ht);const rf=Ht,ka={setItem:(s,t)=>{try{localStorage.setItem(s,t)}catch(e){u.error("LocalStorage::setItem::crashed",{error:e,localStorage:{key:s,value:t}})}},getItem:s=>{try{return localStorage.getItem(s)}catch(t){u.error("LocalStorage::getItem::crashed",{error:t,localStorage:{key:s}})}return null}},_0=(s=0)=>new Promise(t=>setTimeout(t,s)),b0=(s,t,e)=>{const r=typeof e=="number"?e:250,n=s.createMediaStreamSource(t),i=s.createAnalyser();i.fftSize=2048,n.connect(i);const a=new Uint8Array(i.fftSize);let c=!1;setTimeout(()=>{c=!0},r);function d(){return c?Promise.resolve(!0):(i.getByteTimeDomainData(a),a.some(l=>l!==128&&l!==0)?Promise.resolve(!1):_0().then(d))}return d().then(l=>(n.disconnect(),l),l=>{throw n.disconnect(),l})},w0=typeof AudioContext!="undefined"?AudioContext:null;class Zl{constructor(t){p(this,"_AudioContext");p(this,"audioContext");p(this,"_audioContextRefContainers");const e={AudioContext:w0,...t};Object.defineProperties(this,{_AudioContext:{value:e.AudioContext},audioContext:{value:null,writable:!0},_audioContextRefContainers:{value:new Set},AudioContextProvider:{enumerable:!0,value:Zl}})}getOrCreate(t){if(!this._audioContextRefContainers.has(t)&&(this._audioContextRefContainers.add(t),this._AudioContext&&!this.audioContext))try{this.audioContext=new this._AudioContext}catch(e){}return this.audioContext}release(t){this._audioContextRefContainers.has(t)&&(this._audioContextRefContainers.delete(t),!this._audioContextRefContainers.size&&this.audioContext&&(this.audioContext.close(),this.audioContext=null))}}const nf=new Zl,P0=3,C0=250;function R0(s){const t={},e=nf.getOrCreate(t);let r=P0;function n(){return r-=1,b0(e,s.srcObject,C0).then(i=>i?r>0?n():!0:!1).catch(()=>!0)}return n().finally(()=>{nf.release(t)})}async function af(s){const t=new Audio,e=new MediaStream;e.addTrack(s),t.srcObject=e;let r=!1;try{const n=t.play();n&&await n,r=await R0(t),r&&u.info("checkIfAudioTrackIsSilent::silence_detected")}catch(n){u.error("checkIfAudioTrackIsSilent::failed_to_detect_silence",{error:n})}finally{t.pause(),t.remove()}return r}var k0=Object.defineProperty,I0=Object.getOwnPropertyDescriptor,of=(s,t,e,r)=>{for(var n=r>1?void 0:r?I0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&k0(t,e,n),n};let Hc=class extends Xn{constructor(t,e,r){var n;super();p(this,"constructorName",this.constructor.name);p(this,"userSelectedDevice");p(this,"mediaInterface");p(this,"isNonPreferredDevice");p(this,"_mediaTrack");p(this,"transformedMediaTrack");p(this,"middlewares",[]);p(this,"currentDevice");p(this,"userPreferredDeviceKey",`Dyte::${this.constructorName}::UserDeviceID`);p(this,"setUserPreferredDevice",t=>ka.setItem(this.userPreferredDeviceKey,t));p(this,"getUserPreferredDevice",()=>ka.getItem(this.userPreferredDeviceKey));this.mediaInterface=t,e&&this.setMediaTrack(e),this.userSelectedDevice=(n=this.getUserPreferredDevice())!=null?n:void 0,this.isNonPreferredDevice=r,this.onTrackEnded=this.onTrackEnded.bind(this),this.onTrackMuted=this.onTrackMuted.bind(this)}disableTrack(){var t,e;this.removeMediaTrackListeners(),(t=this._mediaTrack)==null||t.stop(),this._mediaTrack=void 0,(e=this.transformedMediaTrack)==null||e.stop(),this.transformedMediaTrack=void 0}get mediaTrack(){return this._mediaTrack}async setMediaTrack(t){const e=r=>{u.error(`${this.constructorName}.setMediaTrack.error`,{error:r})};try{this.disableTrack()}catch(r){e(r)}this._mediaTrack=await this.conditionallyChangeTrack(t),await this.setTransformedTrack();try{this.addMediaTrackListeners(),await this.setCurrentDevice()}catch(r){e(r)}}get trackEnabled(){return!!this.mediaTrack&&this.mediaTrack.readyState==="live"&&this.mediaTrack.enabled}muteTrack(){if(!this.mediaTrack){u.warn("BaseMediaHandler.muteTrack Tried muting with no track present");return}this.transformedMediaTrack&&(this.transformedMediaTrack.enabled=!1),this.mediaTrack.enabled=!1}async unmuteTrack(){try{this.mediaTrack?this.mediaTrack.enabled=!0:await this.enableTrack(!1)}catch(t){throw u.error(`${this.constructorName}.unmuteTrack.error`,{error:t}),this.disableTrack(),new P("Failed to unmute track","1611")}}getCurrentDeviceId(){var e,r;const{kind:t}=this.mediaTrack;switch(t){case"audio":{const n=this.mediaTrack.getConstraints();return this.userSelectedDevice?(r=(e=n==null?void 0:n.deviceId)!=null?e:n==null?void 0:n.advanced[0].deviceId)!=null?r:this.mediaTrack.getSettings().deviceId:this.mediaTrack.getSettings().deviceId}default:return this.mediaTrack.getSettings().deviceId}}async setCurrentDevice(){var e;if(!this.mediaTrack){this.currentDevice=void 0;return}const t=this.getCurrentDeviceId();((e=this.currentDevice)==null?void 0:e.deviceId)!==t&&(this.currentDevice=await this.mediaInterface.getDevice(t))}async setDevice(t){if(!t)throw u.warn(`${this.constructorName}.setDevice No device received`),new P("No device received!","1603");this.userSelectedDevice=t.deviceId,this.setUserPreferredDevice(t.deviceId),this.onSetDevice(t)}async addMiddleware(t){if(be.isWebKitBased()&&!ee.hasFeature(se.ALLOW_SAFARI_MEDIA_MIDDLEWARES))return{success:!1,message:"Middlewares are not supported in this WebKit engine based browser."};if(this.middlewares.includes(t))return{success:!1,message:"This middleware has been applied, already. Skipping."};try{return this.middlewares.push(t),this.trackEnabled&&await this.setTransformedTrack(),{success:!0,message:"Successfully added the middleware."}}catch(e){return u.error("While adding middleware",{error:e}),this.removeMiddleware(t),{success:!1,message:e==null?void 0:e.message}}}async removeMiddleware(t){const e=this.middlewares.indexOf(t,0);if(e>-1)try{return this.middlewares.splice(e,1),await this.setTransformedTrack(!0),{success:!0,message:"Successfully removed the middleware."}}catch(r){return u.error("While removing middleware",{error:r}),{success:!1,message:r==null?void 0:r.message}}return{success:!1,message:"No such middleware was found. Skipping."}}async removeAllMiddlewares(){var t;if((t=this.middlewares)!=null&&t.length)try{return this.middlewares=[],await this.setTransformedTrack(!0),{success:!0,message:"Successfully removed all the middlewares."}}catch(e){return u.error("While removing all the middlewares",{error:e}),{success:!1,message:e==null?void 0:e.message}}return{success:!1,message:"No middlewares were found. Skipping."}}addMediaTrackListeners(){var t,e,r;this.mediaTrack&&(u.info(`${this.constructorName}.addMediaTrackListeners for deviceId ${(e=(t=this.mediaTrack)==null?void 0:t.getSettings())==null?void 0:e.deviceId} of type ${(r=this.mediaTrack)==null?void 0:r.kind}`),this.mediaTrack.addEventListener("ended",this.onTrackEnded),this.mediaTrack.addEventListener("mute",this.onTrackMuted))}removeMediaTrackListeners(){var t,e,r;this.mediaTrack&&(u.info(`${this.constructorName}.removeMediaTrackListeners for deviceId ${(e=(t=this.mediaTrack)==null?void 0:t.getSettings())==null?void 0:e.deviceId} of type ${(r=this.mediaTrack)==null?void 0:r.kind}`),u.info(`${this.constructorName}.removeMediaTrackListeners`),this.mediaTrack.removeEventListener("ended",this.onTrackEnded),this.mediaTrack.removeEventListener("mute",this.onTrackMuted))}};of([T.trace("BaseMediaHandler.unmuteTrack")],Hc.prototype,"unmuteTrack",1),Hc=of([lt("1600")],Hc);const cf=Hc;var A0=Object.defineProperty,M0=Object.getOwnPropertyDescriptor,eu=(s,t,e,r)=>{for(var n=r>1?void 0:r?M0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&A0(t,e,n),n};const tu="[Dyte]nonSilentDeviceLabels";class qc extends cf{async onSetDevice(t){if(!t)throw u.warn("AudioMediaHandler.setDevice No device received"),new P("No device received!","1603");if(t.kind!=="audioinput")throw u.warn("AudioMediaHandler.setDevice Received non audio device"),new P("Non audio device received while setting device!","1603");try{const e=this.trackEnabled;await this.setMediaTrack(await this.mediaInterface.getAudioTrack(!e,this.userSelectedDevice)),this.userSelectedDevice=void 0}catch(e){throw u.error("AudioMediaHandler.setDevice.error",{error:e}),this.disableTrack(),new P(e.message,"1604")}}async enableTrack(t){if(this.trackEnabled){u.warn("AudioMediaHandler.enableTrack Track already enabled!");return}const e=await this.mediaInterface.getAudioTrack(t,this.userSelectedDevice);await this.setMediaTrack(e)}async setTransformedTrack(t){var e;if(!t&&!((e=this.middlewares)!=null&&e.length)){this.transformedMediaTrack=this.mediaTrack;return}try{this.transformedMediaTrack=await i0(this.middlewares,this.mediaTrack),this.emit("trackChanged")}catch(r){u.error("AudioMediaHandler.setTransformedTrack",{error:r}),this.transformedMediaTrack=this.mediaTrack}}async onTrackEnded(){u.info("AudioMediaHandler.TrackEnded"),this.emit("trackEnded");const t=this.mediaTrack.enabled;this.disableTrack(),await this.enableTrack(!t),await this.setTransformedTrack(),this.emit("trackChanged")}onTrackMuted(){u.info("AudioMediaHandler.TrackMuted"),this.emit("trackMuted")}async conditionallyChangeTrack(t){var c;if(!t||this.userSelectedDevice)return t;let e=t;const r=await this.mediaInterface.getAudioInputDevices(),n=this.isNonPreferredDevice?r.filter(d=>d&&!this.isNonPreferredDevice(d)):r;if(!(n!=null&&n.length))return e;n.find(d=>d.deviceId===t.getSettings().deviceId)||(e.stop(),u.info("localmediahandler::setupstreams::found_audio_non_preferred"),e=await this.mediaInterface.getAudioTrack(!1,n[0].deviceId));const i=JSON.parse(ka.getItem(tu));if(i!=null&&i.devices.some(d=>d.label===e.label))return e;if(!await af(e)){const d=(c=i==null?void 0:i.devices.concat({label:e.label}))!=null?c:[{label:e.label}];return ka.setItem(tu,JSON.stringify({devices:d})),e}u.info("AudioMediaHandler.conditionallyChangeTrack.DetectedSilentTrack");const a=e.getSettings().deviceId;return n.filter(d=>d.deviceId!==a).some(async d=>{if(e=await this.mediaInterface.getAudioTrack(!1,d.deviceId),!await af(e)){const l=i.devices.concat({label:e.label});return ka.setItem(tu,JSON.stringify({devices:l})),u.info("AudioMediaHandler.conditionallyChangeTrack.SuccesfullyChangedTrack"),!0}return u.info("AudioMediaHandler.conditionallyChangeTrack.AnotherSilentTrackFound"),!1}),e}}eu([T.trace("AudioMediaHandler.setTransformedTrack")],qc.prototype,"setTransformedTrack",1),eu([T.trace("AudioMediaHandler.onTrackEnded")],qc.prototype,"onTrackEnded",1),eu([T.trace("AudioMediaHandler.conditionallyChangeTrack")],qc.prototype,"conditionallyChangeTrack",1);const D0=qc;class O0{constructor(t){g(this,Mi,void 0);p(this,"currentDevice");v(this,Mi,t)}async setupSpeaker(t){var n,i;if(!(o(this,Mi)instanceof rf))return;let e=t;if(t||([e]=(await o(this,Mi).getAvailableDevicesByKind("audiooutput")).filter(c=>!Ql(c))),!e)throw new P("No speaker found","1608");if(((n=this.currentDevice)==null?void 0:n.deviceId)===e.deviceId)return;this.currentDevice=e;const r=document.querySelectorAll("audio");(i=r[0])!=null&&i.setSinkId&&r.forEach(async a=>{if(typeof a.sinkId!="undefined"&&this.currentDevice.deviceId&&a.sinkId!==this.currentDevice.deviceId)try{await a.setSinkId(this.currentDevice.deviceId)}catch(c){}})}}Mi=new WeakMap;const N0=O0;class L0 extends Xn{constructor(e){super();p(this,"mediaInterface");p(this,"audioMediaTrack");p(this,"videoMediaTrack");this.mediaInterface=e}get trackEnabled(){return!!this.videoMediaTrack}async enableScreenShare(){var e,r;try{const{audioTrack:n,videoTrack:i}=await this.mediaInterface.getScreenShareTracks();if(this.audioMediaTrack=n,this.videoMediaTrack=i,this.addMediaTrackListeners(),((r=(e=this.mediaInterface)==null?void 0:e.permissions)==null?void 0:r.screenshare)==="ACCEPTED")return;this.mediaInterface.permissions&&(this.mediaInterface.permissions.screenshare="ACCEPTED",R.emit(k.MEDIA_PERMISSION_UPDATE,{message:this.mediaInterface.permissions.screenshare,kind:"screenshare"}))}catch(n){}}disableScreenShare(){var e,r;this.removeMediaTrackListeners(),(e=this.audioMediaTrack)==null||e.stop(),(r=this.videoMediaTrack)==null||r.stop(),this.videoMediaTrack=void 0,this.audioMediaTrack=void 0}async updateConstraints(e){if(!this.videoMediaTrack)throw new P("No media track enabled!","1610");const r=this.mediaInterface;if(!r.constraintsBuilder)throw new P("update constraints not supported for non web clients","1100");try{this.videoMediaTrack.applyConstraints(r.constraintsBuilder.getUpdatedVideoConstraints(e)),this.addMediaTrackListeners()}catch(n){u.error("ScreenShareHandler.updateConstraints.error",{error:n})}}addMediaTrackListeners(){var e,r;(e=this.videoMediaTrack)==null||e.addEventListener("ended",this.onTrackEnded.bind(this)),be.isWebKitBased()&&((r=this.videoMediaTrack)==null||r.addEventListener("mute",this.onTrackEnded.bind(this)))}removeMediaTrackListeners(){var e,r;(e=this.videoMediaTrack)==null||e.removeEventListener("ended",this.onTrackEnded),(r=this.videoMediaTrack)==null||r.removeEventListener("mute",this.onTrackEnded)}onTrackEnded(){this.emit("trackEnded")}}const x0=L0;var V0=Object.defineProperty,U0=Object.getOwnPropertyDescriptor,jc=(s,t,e,r)=>{for(var n=r>1?void 0:r?U0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&V0(t,e,n),n};class Ia extends cf{constructor(e,r,n){super(e,r,n);g(this,Di,void 0);g(this,Za,{disablePerFrameCanvasRendering:!1});v(this,Di,new p0)}async onSetDevice(e){if(!e)throw u.warn("VideoMediaHandler.setDevice No device received"),new P("No device received!","1603");if(e.kind!=="videoinput")throw u.warn("VideoMediaHandler.setDevice Received non video device",{devices:[e]}),new P("Non video device received while setting video device!","1603");if(!(this.mediaTrack&&this.mediaTrack.enabled)){u.warn("VideoMediaHandler.setDevice Tried switching device with video disabled",{devices:[e]}),this.currentDevice=e;return}try{await this.setMediaTrack(await this.mediaInterface.getVideoTrack(this.userSelectedDevice))}catch(r){throw u.error("VideoMediaHandler.setDevice.error",{error:r}),this.disableTrack(),new P("Failed to change device","1600")}}async enableTrack(){if(this.trackEnabled){u.warn("VideoMediaHandler.enableTrack Track already enabled!");return}await this.setMediaTrack(await this.mediaInterface.getVideoTrack(this.userSelectedDevice))}async setTransformedTrack(e){var r;if(!e&&!((r=this.middlewares)!=null&&r.length)){this.transformedMediaTrack=this.mediaTrack;return}try{this.transformedMediaTrack=await o(this,Di).getTransformedVideoTrack(this.middlewares,this.mediaTrack,o(this,Za)),this.emit("trackChanged")}catch(n){u.error("VideoMediaHandler.setTransformedTrack",{error:n}),this.transformedMediaTrack=this.mediaTrack}}async setVideoMiddlewareGlobalConfig(e){v(this,Za,e)}async updateConstraints(e){if(!this._mediaTrack)throw new P("No media track enabled!","1610");const r=this.mediaInterface;if(!r.constraintsBuilder)throw new P("update constraints not supported for non web clients","1100");try{this._mediaTrack.applyConstraints(r.constraintsBuilder.getUpdatedVideoConstraints(e)),await this.setTransformedTrack(),this.addMediaTrackListeners(),await this.setCurrentDevice()}catch(n){u.error("VideoMediaHandler.updateConstraints.error",{error:n})}}terminateMiddlewareWebWorker(){o(this,Di).terminateMiddlewareWebWorker()}async onTrackEnded(){u.info("VideoMediaHandler.TrackEnded"),this.disableTrack(),this.emit("trackEnded")}onTrackMuted(){u.info("VideoMediaHandler.TrackMuted"),this.emit("trackMuted")}async conditionallyChangeTrack(e){if(!e||this.userSelectedDevice)return e;let r=e;const n=await this.mediaInterface.getVideoInputDevices(),i=this.isNonPreferredDevice?n.filter(a=>!this.isNonPreferredDevice(a)):n;return!(i!=null&&i.length)||window.FAST_DYTE||i.find(a=>a.deviceId===e.getSettings().deviceId)||(r.stop(),u.info("localmediahandler::setupstreams::found_video_non_preferred"),r=await this.mediaInterface.getVideoTrack(i[0].deviceId)),r}}Di=new WeakMap,Za=new WeakMap,jc([T.trace("VideoMediaHandler.setTransformedTrack")],Ia.prototype,"setTransformedTrack",1),jc([T.trace("VideoMediaHandler.setVideoMiddlewareGlobalConfig")],Ia.prototype,"setVideoMiddlewareGlobalConfig",1),jc([T.trace("VideoMediaHandler.onTrackEnded")],Ia.prototype,"onTrackEnded",1),jc([T.trace("VideoMediaHandler.conditionallyChangeTrack")],Ia.prototype,"conditionallyChangeTrack",1);const F0=Ia,df=ps(ll()),Ni=class{constructor(t){g(this,Lt,void 0);g(this,In,void 0);g(this,eo,void 0);g(this,Oi,void 0);if(!t)throw new P("Could not load preset.","0904");v(this,Lt,t.config),v(this,eo,t.name),v(this,In,t.ui||ps(ll().ui)),v(this,Oi,t.permissions.plugins.config)}static fromResponse(t){return new Ni(t)}static default(){return new Ni(df)}static init(t,e=!0){return!t||e?new Ni(df):new Ni(t)}get setupScreen(){return{isEnabled:!0}}get waitingRoom(){return{isEnabled:!0}}get controlBar(){return{isEnabled:!0,elements:{chat:!0,fullscreen:!0,invite:!1,layout:!1,participants:!0,plugins:!0,polls:!0,reactions:!1,screenshare:!0}}}get header(){return{isEnabled:!0,elements:{logo:o(this,In).designTokens.logo,timer:!0,title:!0,participantCount:!0,changeLayout:!1}}}get pipMode(){return!0}get viewType(){return o(this,Lt).viewType}get livestreamViewerQualities(){return o(this,Lt).livestreamViewerQualities||[]}get maxVideoStreams(){return o(this,Lt).maxVideoStreams}get maxScreenShareCount(){return o(this,Lt).maxScreenshareCount}get plugins(){return[]}get disabledPlugins(){return Object.keys(o(this,Oi)).filter(t=>o(this,Oi)[t].disabled)}get designTokens(){return o(this,In).designTokens}get configDiff(){return o(this,In).configDiff}get mediaConstraints(){var t,e,r,n,i,a,c,d,l,h,m,f,y,_,b,I,L,B,q,F,X,ne,ve,ct;return{audio:{enableStereo:(n=(r=(e=(t=o(this,Lt))==null?void 0:t.media)==null?void 0:e.audio)==null?void 0:r.enableStereo)!=null?n:ni.audio.enableStereo,enableHighBitrate:(d=(c=(a=(i=o(this,Lt))==null?void 0:i.media)==null?void 0:a.audio)==null?void 0:c.enableHighBitrate)!=null?d:ni.audio.enableHighBitrate},video:{quality:(f=(m=(h=(l=o(this,Lt))==null?void 0:l.media)==null?void 0:h.video)==null?void 0:m.quality)!=null?f:ni.video.quality,frameRate:(I=(b=(_=(y=o(this,Lt))==null?void 0:y.media)==null?void 0:_.video)==null?void 0:b.frameRate)!=null?I:ni.video.frameRate},screenshare:{quality:(F=(q=(B=(L=o(this,Lt))==null?void 0:L.media)==null?void 0:B.screenshare)==null?void 0:q.quality)!=null?F:ni.screenshare.quality,frameRate:(ct=(ve=(ne=(X=o(this,Lt))==null?void 0:X.media)==null?void 0:ne.screenshare)==null?void 0:ve.frameRate)!=null?ct:ni.screenshare.frameRate}}}get name(){return o(this,eo)}};let su=Ni;Lt=new WeakMap,In=new WeakMap,eo=new WeakMap,Oi=new WeakMap;var B0=Object.defineProperty,$0=Object.getOwnPropertyDescriptor,lf=(s,t,e,r)=>{for(var n=r>1?void 0:r?$0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&B0(t,e,n),n};class ru extends Ft{constructor(e){super();g(this,Li,void 0);p(this,"state","IDLE");p(this,"playbackUrl");p(this,"ingestionCredentials");p(this,"viewerCount");v(this,Li,e),this.viewerCount=0}setLivestreamState(e){const r=this.state;this.state=e,r!==e&&this.emitCurrentLivestreamState()}emitCurrentLivestreamState(){this.emit("livestreamUpdate",this.state)}async start(e={manualIngestion:!1}){if(!o(this,Li).permissions.canLivestream)throw u.error("DyteLivestream::start::permission_denied"),new P("User does not have permission to start livestreaming","1901");this.setLivestreamState("STARTING");try{const r=nt(),{playbackUrl:n,ingestionCredentials:i}=await r.startLivestreaming(e);this.playbackUrl=n,this.ingestionCredentials=i,e!=null&&e.manualIngestion&&this.setLivestreamState("WAITING_ON_MANUAL_INGESTION")}catch(r){throw u.error("DyteRecording::stop::livestream_failed_to_start",{error:r}),this.setLivestreamState("IDLE"),new P("Error while starting livestream","1900")}}async stop(){if(!o(this,Li).permissions.canLivestream)throw u.error("DyteLivestream::stop::permission_denied"),new P("User does not have permission to stop livestreaming","1901");if(this.state!=="LIVESTREAMING"&&this.state!=="WAITING_ON_MANUAL_INGESTION")throw u.error("DyteLivestream::stop::inconsistent_state"),new P("Livestream not started yet","1902");try{this.setLivestreamState("STOPPING"),await nt().stopLivestreaming()}catch(e){throw u.error("DyteLivestream::stop::livestream_failed_to_stop",{error:e}),this.setLivestreamState("STOPPING"),new P("Error while stopping livestream","1900")}}}Li=new WeakMap,lf([T.trace("livestream.start")],ru.prototype,"start",1),lf([T.trace("livestream.stop")],ru.prototype,"stop",1);var H0=Object.defineProperty,q0=Object.getOwnPropertyDescriptor,j0=(s,t,e,r)=>{for(var n=r>1?void 0:r?q0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&H0(t,e,n),n};class uf{constructor(t,e){p(this,"livestream");g(this,xi,void 0);g(this,Vi,void 0);g(this,Zs,void 0);v(this,Vi,t),this.livestream=new ru(t),v(this,Zs,e),this.setupEvents()}async fetchInitialLivestreamingState(){const t=nt(),{status:e,playbackUrl:r,manualIngest:n,ingestionCredentials:i}=await t.getActiveLivestream();this.livestream.playbackUrl=r,this.livestream.ingestionCredentials=i,e==="LIVE"&&this.livestream.setLivestreamState("LIVESTREAMING"),e==="INVOKED"&&n&&this.livestream.setLivestreamState("WAITING_ON_MANUAL_INGESTION")}setupEvents(){o(this,Zs).on(V.startedLivestream,async t=>{this.livestream.playbackUrl=t.playbackUrl,this.livestream.setLivestreamState("LIVESTREAMING");try{o(this,Vi).permissions.canLivestream&&await this.fetchInitialLivestreamingState()}catch(e){u.error("Error: LivestreamController.fetchLivestream during startedLivestream re-fetch")}}),o(this,Zs).on(V.livestreamingInvoked,async t=>{if(t.manualIngest){this.livestream.setLivestreamState("WAITING_ON_MANUAL_INGESTION");try{o(this,Vi).permissions.canLivestream&&await this.fetchInitialLivestreamingState()}catch(e){u.error("Error: LivestreamController.fetchLivestream during livestreamingInvoked re-fetch")}}}),o(this,Zs).on(V.stoppedLivestream,()=>{this.livestream.setLivestreamState("IDLE"),this.livestream.playbackUrl=void 0,this.livestream.ingestionCredentials=void 0}),o(this,Zs).on(V.erroredLivestream,()=>{this.livestream.setLivestreamState("IDLE"),this.livestream.playbackUrl=void 0}),o(this,Zs).on(V.roomPeerCount,t=>{this.livestream.viewerCount=t.count,this.livestream.emit("viewerCountUpdate",t.count)}),R.on(k.PEER_JOINED_INTERNAL,async t=>{var e;((e=t.flags)==null?void 0:e.hiddenParticipant)===!0&&t.recorderType==="LIVESTREAMER"&&(v(this,xi,t.id),this.livestream.setLivestreamState("LIVESTREAMING"))}),R.on(k.PEER_CLOSED,t=>{t.id===o(this,xi)&&(v(this,xi,void 0),this.livestream.setLivestreamState("IDLE"))}),R.onAsync(k.LEAVE_MEDIA_ROOM,async()=>{this.livestream.playbackUrl||(u.info("Fetching livestreaming state on leave stage"),await this.fetchInitialLivestreamingState())}),R.on(k.SOCKET_SERVICE_ROOM_JOINED,async()=>{try{await this.fetchInitialLivestreamingState()}catch(t){u.error("Error: LivestreamController.fetchLivestream")}})}}xi=new WeakMap,Vi=new WeakMap,Zs=new WeakMap,j0([T.trace("LivestreamController.setupEvents")],uf.prototype,"setupEvents",1);var G0=Object.defineProperty,W0=Object.getOwnPropertyDescriptor,Aa=(s,t,e,r)=>{for(var n=r>1?void 0:r?W0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&G0(t,e,n),n};class ii{constructor({name:t,socketHandler:e,meetingId:r}){g(this,Ed);p(this,"name","");g(this,gt,{});g(this,Mr,"");g(this,Dr,void 0);p(this,"rateLimitConfig",{maxInvocations:5,period:1});p(this,"bulkRateLimitConfig",{maxInvocations:5,period:1});p(this,"listeners",{});this.name=t,v(this,Dr,e),v(this,Mr,r)}async set(t,e,r=!0,n=!1){o(this,gt)[t]=e,r&&this.remoteSet(t,e),n&&(this.listeners[t]&&this.listeners[t].forEach(i=>i({[t]:o(this,gt)[t]})),this.listeners["*"]&&this.listeners["*"].forEach(i=>i({[t]:o(this,gt)[t]})))}remoteSet(t,e){o(this,Dr).storeInsertKeys(o(this,Mr),this.name,[{key:t,payload:e}])}async bulkSet(t){t.forEach(({key:e,payload:r})=>{o(this,gt)[e]=r}),o(this,Dr).storeInsertKeys(o(this,Mr),this.name,t)}async update(t,e,r=!0){$(this,Ed,fg).call(this,t,e,r)}async delete(t,e=!0,r=!1){if(o(this,gt)[t]&&delete o(this,gt)[t],e)return o(this,Dr).storeDeleteKeys(o(this,Mr),this.name,[{key:t}]);r&&(this.listeners[t]&&(this.listeners[t].forEach(n=>n({[t]:void 0})),delete this.listeners[t]),this.listeners["*"]&&this.listeners["*"].forEach(n=>n({[t]:void 0})))}async bulkDelete(t){return t.forEach(({key:e})=>{o(this,gt)[e]&&delete o(this,gt)[e]}),o(this,Dr).storeDeleteKeys(o(this,Mr),this.name,t)}get(t){if(o(this,gt)[t])return o(this,gt)[t]}getAll(){return o(this,gt)}get rateLimits(){return this.rateLimitConfig}updateRateLimits(t,e){this.rateLimitConfig.maxInvocations=t,this.rateLimitConfig.period=e}get bulkRateLimits(){return this.bulkRateLimitConfig}updateBulkRateLimits(t,e){this.bulkRateLimitConfig.maxInvocations=t,this.bulkRateLimitConfig.period=e}subscribe(t,e){if(this.listeners[t]){this.listeners[t].push(e);return}this.listeners[t]=[e]}unsubscribe(t,e){var r;if(e){this.listeners[t]=((r=this.listeners[t])==null?void 0:r.filter(n=>n!==e))||[];return}this.listeners[t]&&delete this.listeners[t]}populate(t){v(this,gt,t)}}gt=new WeakMap,Mr=new WeakMap,Dr=new WeakMap,Ed=new WeakSet,fg=function(t,e,r=!0){let n;const i=o(this,gt)[t],a=Object.prototype.toString.call(e),c=Object.prototype.toString.call(i);if(a!==c){this.set(t,e);return}switch(c){case"[object Array]":n=[...i,...e];break;case"[object Object]":n={...i,...e};break;case"[object Map]":n=new Map([...i,...e]);break;case"[object Set]":n=new Set([...i,...e]);break;default:n=e;break}this.set(t,n,r)},Aa([Ot(ti,"rateLimitConfig")],ii.prototype,"remoteSet",1),Aa([Ot(ti,"bulkRateLimitConfig")],ii.prototype,"bulkSet",1),Aa([Ot(ti,"rateLimitConfig")],ii.prototype,"update",1),Aa([Ot(ti,"rateLimitConfig")],ii.prototype,"delete",1),Aa([Ot(ti,"bulkRateLimitConfig")],ii.prototype,"bulkDelete",1);class J0{constructor(t,e){g(this,to);g(this,_d);p(this,"stores",new Map);g(this,An,void 0);g(this,Mn,"");g(this,so,void 0);g(this,Or,new Map);v(this,An,e),v(this,Mn,t.getValue("meetingId")),v(this,so,t),$(this,_d,gg).call(this)}create(t){const e=new ii({name:t,socketHandler:o(this,An),meetingId:o(this,Mn)});return o(this,An).storeGetKeys(o(this,Mn),t,[]),new Promise((n,i)=>{const a=setTimeout(()=>i(Error("Failed")),3e3);o(this,Or).set(t,{rejectTimeout:a,resolve:n,store:e})})}}An=new WeakMap,Mn=new WeakMap,to=new WeakSet,Mu=function(){return o(this,so).getValue("peerId")},so=new WeakMap,Or=new WeakMap,_d=new WeakSet,gg=function(){[W.storeInsertKeys,W.storeGetKeys,W.storeDeleteKeys].forEach(t=>{o(this,An).on(t,async e=>{var i,a;if(e.pluginId!==o(this,Mn))return;const r=(i=e.storeItems)==null?void 0:i.map(c=>{var d;return{timestamp:c.timestamp,peerId:c.peerId,payload:JSON.parse((d=c.payload)!=null&&d.length?new TextDecoder().decode(c.payload):"{}"),key:c.storeKey}});if(t===W.storeGetKeys){const c=o(this,Or).get(e.storeName),d=this.stores.get(e.storeName)||(c==null?void 0:c.store);o(this,Or).get(e.storeName)&&(this.stores.set(e.storeName,c.store),c.resolve(d),clearTimeout(c.rejectTimeout),o(this,Or).delete(e.storeName)),r.forEach(l=>{d.set(l.key,l.payload,!1,!1)});return}const n=this.stores.get(e.storeName)||((a=o(this,Or).get(e.storeName))==null?void 0:a.store);n!==void 0&&(t===W.storeInsertKeys&&r.forEach(({key:c,peerId:d,payload:l})=>{d!==o(this,to,Mu)&&n.set(c,l,!1,!0)}),t===W.storeDeleteKeys&&r.forEach(({key:c,peerId:d})=>{d!==o(this,to,Mu)&&n.delete(c,!1,!0)}))})})};function ln(s){var t,e,r,n,i,a,c,d,l,h,m,f,y;return s?{media:{audio:{enabled:s.audioEnabled,trackId:(t=s.audioTrack)==null?void 0:t.id,permission:"mediaPermissions"in s?(e=s.mediaPermissions)==null?void 0:e.audio:null},video:{enabled:s.videoEnabled,trackId:(r=s.videoTrack)==null?void 0:r.id,permission:"mediaPermissions"in s?(n=s.mediaPermissions)==null?void 0:n.video:null},screenshare:{enabled:s.screenShareEnabled,permission:"mediaPermissions"in s?(i=s.mediaPermissions)==null?void 0:i.screenshare:null,audio:{enabled:(c=(a=s.screenShareTracks)==null?void 0:a.audio)==null?void 0:c.enabled,trackId:(l=(d=s.screenShareTracks)==null?void 0:d.audio)==null?void 0:l.id},video:{enabled:(m=(h=s.screenShareTracks)==null?void 0:h.video)==null?void 0:m.enabled,trackId:(y=(f=s.screenShareTracks)==null?void 0:f.video)==null?void 0:y.id}}}}:{}}var K0=Object.defineProperty,z0=Object.getOwnPropertyDescriptor,ai=(s,t,e,r)=>{for(var n=r>1?void 0:r?z0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&K0(t,e,n),n};const Y0=.8,Q0=1.2;let qs=(ag=class extends Ft{constructor(t,e,r,n){super();g(this,Dn);g(this,Bi);g(this,no);p(this,"id");p(this,"userId");p(this,"name");p(this,"picture");p(this,"isHost");p(this,"customParticipantId");p(this,"flags");p(this,"device");p(this,"videoTrack");p(this,"audioTrack");p(this,"screenShareTracks");p(this,"videoEnabled");p(this,"audioEnabled");p(this,"screenShareEnabled");p(this,"producers");p(this,"manualProducerConfig");g(this,Ui,void 0);p(this,"supportsRemoteControl",!1);g(this,Fi,void 0);p(this,"presetName");g(this,Nr,void 0);g(this,er,void 0);g(this,ro,void 0);g(this,Lr,new Map);g(this,tr,1);g(this,bd,pc(t=>{if(!this.videoTrack)return;const{clientWidth:e,clientHeight:r}=t,{width:n,height:i}=this.videoTrack.getSettings();if(!n||!i)return;const a=i/r,c=n/e,d=Math.max(a,c);d>Q0&&o(this,tr)===1?(v(this,tr,0),R.emit(k.MAX_SPATIAL_LAYER_CHANGE,{peerId:this.id,maxSpatialLayer:o(this,tr)})):d<Y0&&o(this,tr)===0&&(v(this,tr,1),R.emit(k.MAX_SPATIAL_LAYER_CHANGE,{peerId:this.id,maxSpatialLayer:o(this,tr)}))},2e3));v(this,Nr,t);const{id:i,userId:a,displayName:c,device:d,picture:l,isHost:h,flags:m,clientSpecificId:f,stageStatus:y,customParticipantId:_,audioMuted:b,audioTrack:I,videoEnabled:L=!1,videoTrack:B,producers:q,metadata:F}=e;this.id=i,this.userId=a,this.name=c,this.device=d,this.picture=l,this.isHost=h,this.flags=m,this.manualProducerConfig=Z_,v(this,Fi,y!=null?y:"ON_STAGE"),this.customParticipantId=_!=null?_:f,this.audioEnabled=!b,this.audioTrack=I,this.videoEnabled=L,this.videoTrack=B,this.screenShareTracks={audio:void 0,video:void 0},this.producers=q!=null?q:[],this.presetName=F==null?void 0:F.preset_name,v(this,Ui,!1),v(this,er,r),v(this,ro,n),this.setupEvents(),this.updateVideo=this.updateVideo.bind(this),$(this,no,Du).call(this)}get clientSpecificId(){return this.customParticipantId}get stageStatus(){return o(this,Fi)}get mediaJoined(){return o(this,Nr).getValue("connectionHandler").mediaJoined}get socketJoined(){return o(this,Nr).getValue("connectionHandler").socketJoined}setVideoEnabled(t,e=!0){this.videoEnabled=t,e&&(u.info("DyteParticipant::setVideoEnabled::videoUpdate",{...ln(this)}),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}))}setAudioEnabled(t,e=!0){this.audioEnabled=t,e&&(u.info("DyteParticipant::setAudioEnabled::audioUpdate",{...ln(this)}),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack}))}setScreenShareEnabled(t,e=!0){this.screenShareEnabled=t,e&&this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}setupEvents(){this.on("videoUpdate",$(this,no,Du))}async pin(){if(!this.mediaJoined)throw new P("Can`t pin participant without joining room","1205");if(!o(this,er).permissions.pinParticipant)throw new P("You do not have permission to pin participants.","1201");return o(this,Dn,Wo).pinPeer(this.id)}async unpin(){if(!this.mediaJoined)throw new P("Can`t unpin participant without joining room","1205");if(!o(this,er).permissions.pinParticipant)throw new P("You do not have permission to unpin participants.","1201");return o(this,Dn,Wo).pinPeer(null)}setIsPinned(t,e=!0){var n;v(this,Ui,t);const r=t?"pinned":"unpinned";(n=o(this,Bi,qd))==null||n.updateSource(this.id,{pinned:t}),e&&this.emit(r,this)}async disableAudio(){const t=this.id;if(u.info("DyteParticipant::disable_audio",{dyteParticipant:{id:t}}),!this.mediaJoined)throw new P("Can`t disable participant audio without joining room","1205");if(o(this,er).permissions.canDisableParticipantAudio)return o(this,Dn,Wo).disableAudio(t);throw u.error("DyteParticipant::unauthorized_disable_audio",{dyteParticipant:{id:t}}),new P("Unauthorized: User does not have permission to disable participant audio.","1201")}async kick(){const t=this.id;if(u.info("DyteParticipant::kick",{dyteParticipant:{id:t}}),!this.socketJoined)throw new P("Can`t kick participant without joining room","1205");if(o(this,er).permissions.kickParticipant){await R.emitAsync(k.KICK_PEER,{peerId:t});return}throw u.error("DyteParticipant::unauthorized_kick",{dyteParticipant:{id:t}}),new P("Unauthorized: User does not have permission to kick participants.","1201")}async disableVideo(){const t=this.id;if(u.info("DyteParticipant::disable_video",{dyteParticipant:{id:t}}),!this.mediaJoined)throw new P("Can`t disable participant video without joining room","1205");if(o(this,er).permissions.canDisableParticipantVideo)return o(this,Dn,Wo).disableVideo(t);throw u.error("DyteParticipant::unauthorized_disable_video",{dyteParticipant:{id:t}}),new P("Unauthorized: User does not have permission to disable participant video.","1201")}async getPermissions(){return o(this,ro).getUserPermissions(this.userId)}setStageStatus(t){v(this,Fi,t),this.emit("stageStatusUpdate",this)}get isPinned(){return o(this,Ui)}registerVideoElement(t){var r,n,i,a;let e;(n=(r=o(this,Lr).get(t))==null?void 0:r.observer)==null||n.disconnect(),"ResizeObserver"in window&&(e=new ResizeObserver(()=>o(this,bd).call(this,t)),e.observe(t)),o(this,Lr).set(t,{observer:e}),this.updateVideo(t),(a=o(this,Bi,qd))==null||a.addSource(this.id,t,this.videoEnabled,this.isPinned,this.name,this.picture,(i=this.raised)!=null?i:!1)}deregisterVideoElement(t){var e,r,n;t.srcObject=void 0,(r=(e=o(this,Lr).get(t))==null?void 0:e.observer)==null||r.disconnect(),o(this,Lr).delete(t),(n=o(this,Bi,qd))==null||n.removeSource(this.id)}updateVideo(t){var e;if(this.videoEnabled){if(this.videoTrack==null)return;const r=(e=t.srcObject)==null?void 0:e.getTracks()[0];if((r==null?void 0:r.id)===this.videoTrack.id)return;const n=new MediaStream;n.addTrack(this.videoTrack),t.srcObject=n}else t.srcObject=void 0;t.style.display=this.videoEnabled?"block":"none"}},Ui=new WeakMap,Fi=new WeakMap,Nr=new WeakMap,Dn=new WeakSet,Wo=function(){return o(this,Nr).getValue("roomNodeClient")},er=new WeakMap,ro=new WeakMap,Lr=new WeakMap,Bi=new WeakSet,qd=function(){return o(this,Nr).getValue("pip")},tr=new WeakMap,bd=new WeakMap,no=new WeakSet,Du=function(){Array.from(o(this,Lr).keys()).forEach(this.updateVideo)},ag);ai([T.trace("DyteParticipant.disableAudio")],qs.prototype,"disableAudio",1),ai([T.trace("DyteParticipant.kick")],qs.prototype,"kick",1),ai([T.trace("DyteParticipant.disableVideo")],qs.prototype,"disableVideo",1),ai([T.trace("DyteParticipant.getPermissions")],qs.prototype,"getPermissions",1),ai([T.trace("DyteParticipant.setStageStatus")],qs.prototype,"setStageStatus",1),qs=ai([lt("1200")],qs);class Ma extends Wm{constructor(t){const{onAddEvent:e="participantJoined",onDeleteEvent:r="participantLeft",onClearEvent:n="participantsCleared"}=t!=null?t:{};super({onAddEvent:e,onDeleteEvent:r,onClearEvent:n})}add(t,e=!0){return this.has(t.id)&&Object.is(this.get(t.id),t)===!1&&this.delete(t.id),super.add(t,e)}clear(t=!0,e=!1){return super.clear(t,e)}delete(t,e=!0,r=!1){return super.delete(t,e,r)}}class X0 extends Xn{constructor(){super();g(this,xr,void 0);v(this,xr,new Map)}__set(e,r){return o(this,xr).set(e,r)}__clear(){return o(this,xr).clear()}get(e){return o(this,xr).get(e)}toArray(){return Array.from(o(this,xr).values())}}xr=new WeakMap;class Z0{constructor(){p(this,"_orderedArray");p(this,"_map");this._map=new Map,this._orderedArray=[]}add(t,e){if(!this._map.has(t))return this._map.set(t,{peerId:t,priority:e}),this._orderedArray.splice(Math.max(e-1,0),0,t),this.index(t);const r=this.index(t);this.delete(t);const n=this.add(t,e);return r!==n?n:-1}delete(t){if(this._map.has(t)){const e=this.index(t);this._map.delete(t),this._orderedArray.splice(e,1)}}index(t){return this._map.has(t)?this._orderedArray.indexOf(t):-1}[Symbol.iterator](){return this._orderedArray[Symbol.iterator]()}}class eM{constructor(){p(this,"_activeSpeakerPeers");p(this,"_compulsoryPeers");this._activeSpeakerPeers=new Z0,this._compulsoryPeers=new Set}add(t,e){if(!t)return-1;if(e<0)return this._compulsoryPeers.add(t),0;if(this.compulsoryPeers.includes(t)&&(e>0||e===246267631)){if(u.info("DyteSelectedPeer::removing_compulsory_peer",{selectedPeer:{peerId:t}}),this._removeFromCompulsoryPeer(t),e===246267631)return-1}else if(e===229490415)return this.delete(t),-1;return this._activeSpeakerPeers.add(t,e)}delete(t){u.info("DyteSelectedPeer::deleting_peer_from_selectedPeer",{selectedPeer:{peerId:t}}),this._removeFromCompulsoryPeer(t),this._activeSpeakerPeers.delete(t)}index(t){return this._activeSpeakerPeers.index(t)}get peers(){return Array.from(new Set(this.compulsoryPeers.concat(this.activeSpeakerPeers)))}get compulsoryPeers(){return Array.from(this._compulsoryPeers.values())}get activeSpeakerPeers(){return Array.from(this._activeSpeakerPeers)}_removeFromCompulsoryPeer(t){this._compulsoryPeers.delete(t)}}const hf=new eM;var tM=Object.defineProperty,sM=Object.getOwnPropertyDescriptor,qt=(s,t,e,r)=>{for(var n=r>1?void 0:r?sM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&tM(t,e,n),n};const rM=["ACTIVE_GRID","PAGINATED","MANUAL"];let _t=(og=class extends Ft{constructor(t,e,r){super();g(this,sr);p(this,"waitlisted");p(this,"joined");p(this,"active");p(this,"videoSubscribed");p(this,"audioSubscribed");p(this,"pinned");p(this,"all");g(this,As,void 0);g(this,On,void 0);g(this,xt,void 0);p(this,"rateLimitConfig",{maxInvocations:5,period:1});p(this,"viewMode");p(this,"currentPage");p(this,"lastActiveSpeaker");p(this,"selectedPeers",hf);v(this,As,t),v(this,On,e),v(this,xt,r),this.waitlisted=new Ma,this.joined=new Ma,this.videoSubscribed=new Ma,this.audioSubscribed=new Ma,this.active=this.videoSubscribed,this.pinned=new Ma,this.all=new X0,this.viewMode="ACTIVE_GRID",this.currentPage=0,this.setupEvents()}get pip(){return o(this,As).getValue("pip")}get socketJoined(){var t;return((t=o(this,As).getValue("connectionHandler"))==null?void 0:t.socketJoined)===!0}get mediaJoined(){var t;return((t=o(this,As).getValue("connectionHandler"))==null?void 0:t.mediaJoined)===!0}get rateLimits(){return this.rateLimitConfig}updateRateLimits(t,e){this.rateLimitConfig.maxInvocations=t,this.rateLimitConfig.period=e}setupEvents(){R.on(k.E2EE_ACTIVE_CONSUMER,({peerId:t})=>{var e;((e=o(this,As).getValue("modules").e2ee)==null?void 0:e.enabled)!==!0&&this.emit("media_decode_error",{reason:`Got encrypted media for participantId ${t}, but encryption wasn't enabled in init.defaults`,code:"1702"})})}get count(){return this.joined.size}get maxActiveParticipantsCount(){var t;return(t=o(this,sr,Wn))==null?void 0:t.maxPreferredStreams}setMaxActiveParticipantsCount(t){if(t<0||t>24)throw new P("0 <= Max active participants count limit <= 24","1203");o(this,sr,Wn).maxPreferredStreams=t,this.mediaJoined&&R.emit(k.UPDATE_ACTIVE)}get pageCount(){if(this.viewMode==="PAGINATED"){const t=this.selectedPeers.compulsoryPeers.length,e=this.joined.toArray().filter(r=>r.stageStatus==="ON_STAGE");return Math.ceil((e.length-t)/Math.max(this.maxActiveParticipantsCount-t,1))}return 0}acceptWaitingRoomRequest(t){var r,n;if(!this.socketJoined)throw new P("Can`t accept waiting room request without joining room","1205");const e=(n=(r=this.waitlisted.get(t))==null?void 0:r.userId)!=null?n:t;return o(this,xt).acceptWaitingRoomRequest([e])}async acceptAllWaitingRoomRequest(t){const e=t.map(r=>{var n,i;return(i=(n=this.waitlisted.get(r))==null?void 0:n.userId)!=null?i:r});return o(this,xt).acceptWaitingRoomRequest(e)}async rejectWaitingRoomRequest(t){var r,n;if(!this.socketJoined)throw new P("Can`t reject waiting room request without joining room","1205");const e=(n=(r=this.waitlisted.get(t))==null?void 0:r.userId)!=null?n:t;o(this,xt).rejectWaitingRoomRequest([e])}async setViewMode(t){if(u.info("DyteParticipants::set_view_mode",{pageNavigation:{viewMode:t,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),!(r=>rM.includes(r))(t))throw u.error("DyteParticipants::setViewMode::invalid_view_mode",{pageNavigation:{viewMode:t,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),new P(`Invalid view mode: ${t}. Try ACTIVE_GRID, PAGINATED or MANUAL.`,"1207");if(this.viewMode===t){u.info("DyteParticipants::setViewMode::view_mode_same_as_previous");return}if(t==="MANUAL")throw new P("Manual Subscription is not enabled for your Organization. Please contact support.","1208");this.viewMode=t,t==="PAGINATED"?(this.currentPage=1,R.emit(k.UPDATE_ACTIVE,{page:this.currentPage})):t==="ACTIVE_GRID"&&(this.currentPage=0,R.emit(k.UPDATE_ACTIVE)),this.emit("viewModeChanged",{viewMode:t,currentPage:this.currentPage,pageCount:this.pageCount})}async subscribe(t,e=["audio","video","screenshareAudio","screenshareVideo"]){if(this.viewMode!=="MANUAL")throw new P("MANUAL subscription mode was not activated.","1206");const r=[];t.forEach(n=>{const i=this.joined.get(n);if(i){if(e.includes("audio")){i.manualProducerConfig={...i.manualProducerConfig,audio:!0},this.videoSubscribed.add(i);const a=i.producers.find(c=>c.kind==="audio"&&!c.screenShare);a&&r.push(a)}if(e.includes("video")){i.manualProducerConfig={...i.manualProducerConfig,video:!0},this.audioSubscribed.add(i);const a=i.producers.find(c=>c.kind==="video"&&!c.screenShare);a&&r.push(a)}if(e.includes("screenshareAudio")){i.manualProducerConfig={...i.manualProducerConfig,screenshareAudio:!0};const a=i.producers.find(c=>c.kind==="audio"&&c.screenShare);r.push(a)}if(e.includes("screenshareVideo")){i.manualProducerConfig={...i.manualProducerConfig,screenshareVideo:!0};const a=i.producers.find(c=>c.kind==="video"&&c.screenShare);r.push(a)}}}),await o(this,sr,Wn).createConsumers(r)}async unsubscribe(t,e=["audio","video","screenshareAudio","screenshareVideo"]){if(this.viewMode!=="MANUAL")throw new P("MANUAL subscription mode was not activated.","1206");const r=[];t.forEach(n=>{const i=this.joined.get(n);if(i){if(e.includes("audio")){i.manualProducerConfig={...i.manualProducerConfig,audio:!1};const a=i.producers.find(c=>c.kind==="audio"&&!c.screenShare);a&&r.push(a)}if(e.includes("video")){i.manualProducerConfig={...i.manualProducerConfig,video:!1};const a=i.producers.find(c=>c.kind==="video"&&!c.screenShare);a&&r.push(a)}if(e.includes("screenshareAudio")){i.manualProducerConfig={...i.manualProducerConfig,screenshareAudio:!1};const a=i.producers.find(c=>c.kind==="audio"&&c.screenShare);r.push(a)}if(e.includes("screenshareVideo")){i.manualProducerConfig={...i.manualProducerConfig,screenshareVideo:!1};const a=i.producers.find(c=>c.kind==="video"&&c.screenShare);r.push(a)}}}),await o(this,sr,Wn).closeConsumers(r)}getPeerIdsForCurrentPage(){u.info("DyteParticipants::getPeerIdsForCurrentPage()",{pageNavigation:{viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}});const{compulsoryPeers:t}=this.selectedPeers,e=t.filter(c=>this.joined.has(c)),r=Array.from(this.pinned.keys()).filter(c=>!e.includes(c)),n=Array.from(this.joined.toArray().filter(c=>c.stageStatus==="ON_STAGE").map(c=>c.id)),i=Math.max((this.currentPage-1)*(this.maxActiveParticipantsCount-e.length-r.length)),a=this.currentPage*(this.maxActiveParticipantsCount-e.length-r.length);return e.concat(r,n.slice(i,a))}async setPage(t){if(u.info("DyteParticipants::set_page",{pageNavigation:{settingPage:t,viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),this.viewMode==="PAGINATED"){if(!Number.isInteger(t))throw u.error("DyteParticipants::invalid_page_number"),new P(`Invalid page: ${t}. Page must be an integer and greater than 0 and less than or equal to .pageCount`,"1202");this.currentPage=t,R.emit(k.UPDATE_ACTIVE,{page:t}),this.emit("pageChanged",{viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount})}}async disableAllAudio(t){if(u.info("DyteParticipants::disable_all_audio",{actions:{disableAllAudio:{allowUnmute:t}}}),!this.mediaJoined)throw new P("Can`t disable all audio without joining room","1205");if(o(this,On).permissions.canAllowParticipantAudio)return o(this,sr,Wn).muteAll(t);throw u.error("DyteParticipants::unauthorized_disable_all_audio",{actions:{disableAllAudio:{allowUnmute:t}}}),new P("Unauthorized: User does not have permission to disable peer audio.","1201")}async disableAllVideo(){if(u.info("DyteParticipants::disable_all_video"),!this.mediaJoined)throw new P("Can`t disable all video without joining room","1205");if(o(this,On).permissions.canAllowParticipantVideo)return o(this,sr,Wn).muteAllVideo();throw u.error("DyteParticipants::unauthorized_disable_all_video"),new P("Unauthorized: User does not have permission to disable peer video.","1201")}async disableAudio(t){this.joined.get(t).disableAudio()}async disableVideo(t){this.joined.get(t).disableVideo()}async kick(t){await R.emitAsync(k.KICK_PEER,{peerId:t})}async kickAll(){if(u.info("DyteParticipants::kick_all"),o(this,As).getValue("viewType")!=="LIVESTREAM"&&!this.socketJoined)throw new P("Can`t kick all without joining room","1205");if(!o(this,On).permissions.kickParticipant)throw u.error("DyteParticipants::unauthorized_kick_all"),new P("Unauthorized: User does not have permission to kick peers.","1201");const e=ee.hasFeature(se.PROPAGATE_KICK_ALL);o(this,xt).kickAll(e)}async broadcastMessage(t,e,r){if(u.info("DyteParticipants::broadcastMessage"),!this.socketJoined)throw new P("Can`t broadcast message without joining room","1205");if(!(t!=null&&t.trim()))throw new P("`type` must be a non-empty string.","1209");if(r)if("meetingIds"in r)await o(this,xt).broadcastToMeetings(t,r.meetingIds,e);else{let n=[];"participantIds"in r?n=r.participantIds:n=this.joined.toArray().filter(i=>{var a;return(a=r.presetNames)==null?void 0:a.includes(i.presetName)}).map(i=>i.id),await o(this,xt).broadcastToPeers(t,n,e)}else await o(this,xt).broadcastMessage(t,e)}async getAllJoinedPeers(t,e,r){return(await o(this,xt).getRoomPeers(t,e,r)).peers.map(js.formatSocketServiceMessage)}async updatePermissions(t,e){const r=this.joined.toArray().filter(i=>t.includes(i.id)).map(i=>i.userId),n=[...new Set(r)];if(!n.length)throw new P("Cannot update permissions, no valid userIDs found","1204");o(this,xt).updatePermissions(n,e)}async getParticipantsInMeetingPreJoin(){return o(this,xt).getRoomPeersNonPaginated()}},As=new WeakMap,sr=new WeakSet,Wn=function(){return o(this,As).getValue("roomNodeClient")},On=new WeakMap,xt=new WeakMap,og);qt([T.trace("DyteParticipants.setViewMode")],_t.prototype,"setViewMode",1),qt([T.trace("DyteParticipants.setPage")],_t.prototype,"setPage",1),qt([T.trace("DyteParticipants.disableAllAudio")],_t.prototype,"disableAllAudio",1),qt([T.trace("DyteParticipants.disableAllVideo")],_t.prototype,"disableAllVideo",1),qt([T.trace("DyteParticipants.disablePeerAudio")],_t.prototype,"disableAudio",1),qt([T.trace("DyteParticipants.disablePeerVideo")],_t.prototype,"disableVideo",1),qt([T.trace("DyteParticipants.kickPeer")],_t.prototype,"kick",1),qt([T.trace("DyteParticipants.kickAll")],_t.prototype,"kickAll",1),qt([T.trace("DyteParticipants.broadcastMessage"),Ot(ti,"rateLimitConfig")],_t.prototype,"broadcastMessage",1),qt([T.trace("DyteParticipants.getAllJoinedPeers"),Ot({maxInvocations:10,period:60})],_t.prototype,"getAllJoinedPeers",1),qt([T.trace("DyteParticipant.updatePermissions"),Ot({maxInvocations:1e3,period:60})],_t.prototype,"updatePermissions",1),qt([T.trace("DyteParticipants.getParticipantsInMeetingPreJoin")],_t.prototype,"getParticipantsInMeetingPreJoin",1),_t=qt([lt("1200")],_t);var vr=(s=>(s.NEW="new",s.CONNECTING="connecting",s.RECONNECTING="reconnecting",s.DISCONNECTED="disconnected",s.CONNECTED="connected",s.FAILED="failed",s.CLOSED="closed",s))(vr||{}),bt=(s=>(s[s.HIVE=1]="HIVE",s[s.ROOM_NODE=2]="ROOM_NODE",s[s.CF=3]="CF",s))(bt||{}),nM=Object.defineProperty,iM=Object.getOwnPropertyDescriptor,un=(s,t,e,r)=>{for(var n=r>1?void 0:r?iM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&nM(t,e,n),n};const pf=class{constructor(s,t,e,r){p(this,"participants");p(this,"self");p(this,"selectedPeers",hf);p(this,"maxSpatialLayerUpdates",new Map);p(this,"consumerPeerMap");p(this,"events");p(this,"roomSocketHandler");p(this,"context");p(this,"videoPeerConsumerMap",new Map);p(this,"updateConsumerSpatialLayers",pc(()=>{const s={},t=new Map(this.maxSpatialLayerUpdates);this.maxSpatialLayerUpdates.clear(),Array.from(t.entries()).forEach(([e,r])=>{s[r]===void 0&&(s[r]={layer:r,consumerIds:[]}),s[r].consumerIds.push(e)}),Object.keys(s).forEach(e=>{const r=s[e];u.log(`Switching max spatial layer to ${r.layer}`,{consumerIds:r.consumerIds}),this.roomNodeClient.switchConsumersToLayer(r.consumerIds,r.layer)})},2e3));p(this,"updateConsumers",(s,t)=>{let e=Promise.resolve();t.length>0&&(u.info("Closing consumers for producers",{producers:t}),e=this.roomNodeClient.closeConsumers(t)),e.then(()=>{s.length!==0&&(u.info("Consuming producers",{producers:s}),this.roomNodeClient.createConsumers(s).catch(r=>u.error("Error activating peers",{error:r})))}).catch(r=>u.error("Error deactivating peers",{error:r}))});p(this,"updateConsumersDebounced",pc(this.updateConsumers,200,{trailing:!0}));switch(this.context=s,this.roomSocketHandler=e,this.participants=new _t(s,t,this.roomSocketHandler),this.self=t,this.consumerPeerMap=new Map,r){case bt.HIVE:{this.events=Kt;break}case bt.CF:{this.events=us;break}default:this.events=Kt}t.config.viewType!=="CHAT"&&this.setupEventsGlobal(),this.setupEvents()}get roomNodeClient(){return this.context.getValue("roomNodeClient")}get mediaJoined(){var s;return((s=this.roomNodeClient)==null?void 0:s.mediaJoined)===!0}get pip(){return this.context.getValue("pip")}setupEvents(){this.roomSocketHandler.on(V.getWaitingRoomRequests,this.waitingRoomRequestHandler.bind(this)),R.on(k.SOCKET_PEERS,async s=>{const t=ee.hasFeature(se.DEBUG_SOCKET_JOIN);if(t){const e=s&&(s==null?void 0:s.length)<20?{peers:JSON.stringify(s.map(r=>r.peerId))}:void 0;u.info("Processing socket peers",e)}s==null||s.forEach(e=>{e.waitlisted||this.onParticipantJoined(this.fromSocketService(e))}),t&&u.info("Processed socket peers")}),this.roomSocketHandler.on(this.events.peerJoinedBroadcast,({participant:s})=>{ee.hasFeature(se.DEBUG_SOCKET_JOIN)&&u.info("events.peerJoinedBroadcast",{peers:s.peerId}),this.onMediaJoined(s.peerId,s.producerStates,s.capabilities)}),this.roomSocketHandler.on(V.leaveRoom,s=>{var e;const{peerId:t}=s.peer;(e=this.roomNodeClient)==null||e.handlePeerLeaving(t)}),this.roomSocketHandler.on(this.events.selfJoinComplete,({participants:s,selectedPeers:t,roomState:e})=>{if(ee.hasFeature(se.DEBUG_SOCKET_JOIN)){const i=s&&(s==null?void 0:s.length)<20?{peers:JSON.stringify(s.map(a=>a.peerId))}:void 0;u.info("events.selfJoinComplete",i)}s.forEach(({peerId:i,producerStates:a,capabilities:c})=>this.onMediaJoined(i,a,c));const{audioPeers:r,compulsoryPeers:n}=t!=null?t:{};e.pinnedPeerIds.length!==0&&this.onParticipantPinned(e.pinnedPeerIds[0]),this.computeActivateParticipants(r!=null?r:[],n),R.emit(k.UPDATE_ACTIVE,{createAllConsumers:!0})}),R.on(k.MAX_SPATIAL_LAYER_CHANGE,({peerId:s,maxSpatialLayer:t})=>{const e=this.videoPeerConsumerMap.get(s);e&&(this.maxSpatialLayerUpdates.set(e,t),this.updateConsumerSpatialLayers())}),R.on(k.NEW_PRODUCER,({peerId:s,producer:t})=>{const e=this.participants.joined.get(s);if(!e){u.warn("ParticipantController::NEW_PRODUCER::participant not found",{producer:{id:t==null?void 0:t.producerId,kind:t==null?void 0:t.kind,status:"UNKNOWN",appData:{screenShare:t==null?void 0:t.screenShare}},dyteParticipant:{id:s}});return}if(e.producers.push(t),u.info("ParticipantController::NEW_PRODUCER::producer_added_to_participant",{producer:{id:t==null?void 0:t.producerId,peerId:s,kind:t==null?void 0:t.kind,status:"UNKNOWN",appData:{screenShare:t==null?void 0:t.screenShare}}}),this.participants.viewMode==="MANUAL"){let r=!1;const n=t.kind==="audio",i=t.kind==="video",a=e.manualProducerConfig;(n&&(a.audio&&!t.screenShare||a.screenshareAudio&&t.screenShare)||i&&(a.video&&!t.screenShare||a.screenshareVideo&&t.screenShare))&&(r=!0),r?this.roomNodeClient.createConsumers([t]):u.info("ParticipantController::NEW_PRODUCER::not_consuming_producer",{producer:{id:t==null?void 0:t.producerId,peerId:s,kind:t==null?void 0:t.kind,status:"UNKNOWN",appData:{screenShare:t==null?void 0:t.screenShare}}});return}(t==null?void 0:t.kind)==="audio"&&this.participants.audioSubscribed.get(s)||(t==null?void 0:t.kind)==="video"&&this.participants.videoSubscribed.get(s)||t!=null&&t.screenShare?this.roomNodeClient.createConsumers([t]).catch(r=>{u.error("ParticipantController::createConsumer failed",{error:r})}):u.info("ParticipantController::NEW_PRODUCER::not_consuming_producer",{producer:{id:t==null?void 0:t.producerId,peerId:s,kind:t==null?void 0:t.kind,status:"UNKNOWN",appData:{screenShare:t==null?void 0:t.screenShare}}})}),R.on(k.PRODUCER_CLOSED,({peerId:s,producerId:t})=>{const e=this.participants.joined.get(s);if(!e){u.warn("ParticipantController::NEW_PRODUCER::participant not found",{dyteParticipant:{id:s}});return}e.producers=e.producers.filter(r=>r.producerId!==t)}),R.on(k.PRODUCER_TOGGLE,({peerId:s,producerId:t,paused:e,kind:r})=>{const n=this.participants.joined.get(s);if(n){r==="audio"&&n.setAudioEnabled(!e);const i=n.producers.find(a=>a.producerId===t);i&&(i.pause=e)}}),this.roomSocketHandler.on(this.events.globalPeerPinBroadcast,s=>{let t;if(s&&(t=s.participantId),!this.mediaJoined)return;const e=t;this.onParticipantPinned(e);const r=this.participants.joined.get(e);r&&this.roomNodeClient.activatePeers(r.producers).catch(n=>{u.error("unable to create consumers",{error:n})})}),this.roomSocketHandler.on(this.events.selectedPeer,({audioPeers:s,compulsoryPeers:t})=>{this.mediaJoined&&this.onSelectedPeers(t.concat(s))}),this.roomSocketHandler.on(this.events.selectedPeerDiff,({entries:s})=>{if(!this.mediaJoined)return;const t=s.map(e=>({peerId:e.peerId,priority:e.priority}));this.updateActiveParticipantsWithPriorities(t,!0)})}waitingRoomRequestHandler(s){const t=s.requests.filter(r=>!this.participants.waitlisted.toArray().find(n=>n.userId===r.userId)),e=this.participants.waitlisted.toArray().filter(r=>!s.requests.find(n=>n.userId===r.userId));t.forEach(r=>this.participants.waitlisted.add(new qs(this.context,{id:r.peerId,displayName:r.displayName,audioMuted:!0,videoEnabled:!1,audioTrack:void 0,videoTrack:void 0,stageStatus:"OFF_STAGE",userId:r.userId,flags:{},isHost:!1,customParticipantId:r.customParticipantId,picture:r.picture,metadata:{preset_name:r.presetName}},this.self,this.roomSocketHandler))),e.forEach(r=>this.participants.waitlisted.delete(r.id))}get maxPreferredStreams(){return this.participants.maxActiveParticipantsCount}async selectPagePeers(s){const{compulsoryPeers:t}=this.selectedPeers,e=t.filter(d=>this.participants.joined.has(d)),r=Array.from(this.participants.pinned.keys()).filter(d=>!e.includes(d)),n=Array.from(this.participants.joined.toArray().filter(d=>d.stageStatus==="ON_STAGE").map(d=>d.id)),i=Math.max((s-1)*(this.roomNodeClient.maxPreferredStreams-e.length-r.length)),a=s*(this.roomNodeClient.maxPreferredStreams-e.length-r.length);return e.concat(r,n.slice(i,a))}selectActivePeers(){const s=new Map,t=Array.from(this.participants.joined.toArray().filter(l=>l.stageStatus==="ON_STAGE").map(l=>(s.set(l.id,!0),l.id))),e=this.selectedPeers.peers,r=this.participants.pinned.toArray().reduce((l,h)=>(h.stageStatus!=="ON_STAGE"?this.participants.pinned.delete(h.id):l.push(h.id),l),[]),n=this.self.stageStatus==="ON_STAGE"?1:0,i=this.participants.maxActiveParticipantsCount-n,a=new Set(e.concat(r).filter(l=>l!==this.self.id&&s.has(l)));let c=Array.from(a);const d=i-a.size;if(d>=0){const l=t.filter(h=>!a.has(h)&&h!==this.self.id).slice(0,d);c=Array.from(a).concat(l)}else c=c.slice(0,i);return c}async updateActive(s,t){const{page:e,createAllConsumers:r}=t!=null?t:{};let{strategies:n}=t!=null?t:{},i,a;switch(s){case"PAGINATED":{if(!e)return;i=await this.selectPagePeers(e),u.debug("ParticipantController::updateActive::updating_current_page_peers",{peerIds:i}),n!=null||(n={video:this.updateParticipantsMap.bind(this)}),a=this.updateConsumersDebounced;break}case"ACTIVE_GRID":{i=this.selectActivePeers(),u.debug("ParticipantController::updateActive::updating_current_selected_peers",{peerIds:i}),n!=null||(n={video:this.updateParticipantsMapMinReplacement.bind(this),audio:this.updateParticipantsMap.bind(this)}),a=this.updateConsumers;break}default:throw new Error(`View mode ${s} not supported`)}let c,d;const l=this.updateGrid(i,n);r?(c=this.mapPeerIdsToProducers(i,["audio","video","screenshare"]),d=[]):(c=[...this.mapPeerIdsToProducers([...l.video.add],["video"]),...this.mapPeerIdsToProducers([...l.audio.add],["audio"])],d=[...this.mapPeerIdsToProducers([...l.video.remove],["video"]),...this.mapPeerIdsToProducers([...l.audio.remove],["audio"])]),!(c.length===0&&d.length===0)&&a(c,d)}computeActivateParticipants(s,t){const e=s.map((n,i)=>({peerId:n,priority:i+1})),r=t==null?void 0:t.map((n,i)=>({peerId:n,priority:-(i+1)}));e.push(...r!=null?r:[]),e.length>0&&this.updateActiveParticipantsWithPriorities(e)}fromSocketService(s){const t=pf.formatSocketServiceMessage(s);return new qs(this.context,{...t,isHost:!1,videoEnabled:!1,audioMuted:!0,videoTrack:void 0,audioTrack:void 0},this.self,this.roomSocketHandler)}updatePipSource(s,t){var e,r;t?(e=this.pip)==null||e.enableSource(s):(r=this.pip)==null||r.disableSource(s)}onMediaJoined(s,t,e){if(!this.mediaJoined||s===this.self.id)return;const r=this.participants.joined.get(s);if(!r){u.warn(`Received media.peerJoinedBroadcast for non-existent peer ${s}`);return}t.forEach(n=>{n.kind===Cs.AUDIO&&!n.screenShare?r.setAudioEnabled(!n.pause):n.kind===Cs.VIDEO&&!n.screenShare&&(r.setVideoEnabled(!n.pause),this.updatePipSource(r.id,!n.pause)),r.producers.push({...n,producingTransportId:n.producingTransportId,kind:n.kind===Cs.AUDIO?"audio":"video",producingPeerId:s,mimeType:n.mimeType})}),this.roomNodeClient.handlePeerCapabilities(s,e),this.roomNodeClient.shareWebcam(this.self.videoTrack)}updateParticipantsMapMinReplacement(s,t){const e=Array.from(s.keys()),r=new Map(s),n=[],i=[],a=new Set(t),c=[];return e.forEach((d,l)=>{(!a.has(d)||!this.participants.joined.get(d))&&c.push(l)}),t.forEach(d=>{if(s.get(d))return;if(e.length<t.length){e.push(d),n.push(d);return}const l=c.shift();i.push(e[l]),e[l]=d,n.push(e[l])}),e.forEach((d,l)=>{a.has(d)||i.concat(e.splice(l,1))}),Array.from(s.keys()).forEach(d=>{s.delete(d,!a.has(d))}),e.forEach(d=>{if(!this.participants.joined.get(d)){u.warn("updateActiveParticipants::participant_not_in_joined_list",{dyteParticipant:{id:d}});return}s.add(this.participants.joined.get(d),!r.get(d))}),s.emit("participantsUpdate"),[n,i]}updateParticipantsMap(s,t){const e=Array.from(s.keys()),r=[],n=[];return e.forEach(i=>{t.includes(i)||(s.delete(i,!0),n.push(i))}),t.forEach(i=>{s.get(i)||(s.add(this.participants.joined.get(i)),r.push(i))}),s.emit("participantsUpdate"),[r,n]}updatePinnedParticipants(){this.participants.pinned.forEach(s=>{s.setIsPinned(!1),this.participants.pinned.delete(s.id)})}setupEventsGlobal(){this.roomSocketHandler.on(V.joinRoom,({peer:s})=>{if(!s.waitlisted){const t=ee.hasFeature(se.DEBUG_SOCKET_JOIN);t&&u.info("Processing socket join",{peers:s.peerId}),this.onParticipantJoined(this.fromSocketService(s)),t&&u.info("Processed socket join",{peers:s.peerId})}}),this.roomSocketHandler.on(V.leaveRoom,s=>{this.selectedPeers.delete(s.peer.peerId),this.onParticipantLeave(s.peer.peerId)}),R.on(k.SOCKET_SERVICE_ROOM_JOINED,()=>{this.self.permissions.acceptWaitingRequests&&this.roomSocketHandler.getWaitingRoomRequests()}),this.self.permissions.on("permissionsUpdate",s=>{const{acceptWaitingRequests:t}=s;t!==void 0&&(t?this.roomSocketHandler.getWaitingRoomRequests():this.participants.waitlisted.clear())}),R.on(k.SOCKET_SERVICE_DISCONNECTED,()=>{this.participants.joined.clear(),this.participants.videoSubscribed.clear(),this.participants.audioSubscribed.clear(),this.participants.pinned.clear(),this.participants.currentPage=0,this.participants.viewMode="ACTIVE_GRID",this.participants.emit("viewModeChanged",{viewMode:"ACTIVE_GRID",currentPage:this.participants.currentPage,pageCount:this.participants.pageCount})}),R.on(k.CONSUMER_PAUSED,({id:s})=>{this.processConsumerPaused(s)}),R.on(k.CONSUMER_RESUMED,({id:s})=>{this.processConsumerResumed(s)}),R.on(k.NEW_CONSUMER,({id:s})=>{this.processNewConsumer(s)}),R.on(k.CONSUMER_CLOSED,({id:s})=>{this.processConsumerClosed(s)}),R.on(k.ROOM_MESSAGE,async({payload:s,type:t,timestamp:e})=>{this.participants.emit("broadcastedMessage",{type:t,payload:s,timestamp:e})}),R.on(k.MESSAGE,async({payload:s,type:t,timestamp:e})=>{t!=="spotlight"&&this.participants.emit("broadcastedMessage",{type:t,payload:s,timestamp:e})}),R.on(k.LOW_CONSUMER_SCORE,({peerId:s,score:t,kind:e})=>{const r=this.participants.joined.get(s);r&&(r.emit("poorConnection",{score:t,kind:e}),this.participants.emit("poorConnection",{participantId:s,score:t,kind:e}))}),R.on(k.CONSUMER_SCORE_UPDATE,({score:s,kind:t,appData:e,peerId:r,scoreStats:n})=>{var c;const i=t==="video"&&((c=e==null?void 0:e.screenShare)!=null?c:!1),a=this.participants.joined.get(r);a&&(a.emit("mediaScoreUpdate",{kind:t,isScreenshare:i,score:s,participantId:r,scoreStats:n}),this.participants.emit("mediaScoreUpdate",{kind:t,isScreenshare:i,score:s,participantId:r,scoreStats:n}))}),R.onAsync(k.KICK_PEER,async({peerId:s})=>{const t=this.participants.joined.get(s);await this.roomNodeClient.kick(s),await this.roomSocketHandler.kick(s),t?t.emit("kicked"):this.participants.joined.emit("kicked",{id:s})}),R.on(k.UPDATE_ACTIVE,async({page:s,createAllConsumers:t}={})=>{await this.updateActive(s?"PAGINATED":"ACTIVE_GRID",{page:s,createAllConsumers:t})})}async onParticipantPinned(s){if(!s){this.self.isPinned&&this.self.setIsPinned(!1),this.participants.pinned.size!==0&&this.updatePinnedParticipants();return}if(s===this.self.id){this.participants.pinned.size!==0&&this.updatePinnedParticipants(),this.self.setIsPinned(!0);return}const t=this.participants.joined.get(s);this.self.isPinned&&this.self.setIsPinned(!1),this.updatePinnedParticipants(),t.setIsPinned(!0),this.participants.pinned.add(t)}async onParticipantJoined(s){var e,r,n;if(this.self.id!==s.id&&!((e=s.flags)!=null&&e.recorder)&&!((r=s.flags)!=null&&r.hidden_participant)&&!((n=s.flags)!=null&&n.hiddenParticipant)&&(this.participants.videoSubscribed.delete(s.id),this.participants.audioSubscribed.delete(s.id),this.participants.joined.add(s),this.participants.waitlisted.delete(s.id),s.stageStatus==="REQUESTED_TO_JOIN_STAGE"&&R.emit(k.UPDATE_STAGE_REQUESTS,{request:{displayName:s.name,userId:s.userId,peerId:s.id},add:!0})),R.emit(k.PEER_JOINED_INTERNAL,s),this.self.config.viewType===yt.Webinar&&s.stageStatus!=="ON_STAGE"||this.roomNodeClient===void 0||this.participants.videoSubscribed.size>=this.roomNodeClient.maxPreferredStreams)return;const t=this.participants.currentPage;this.updateActive(t?"PAGINATED":"ACTIVE_GRID",{page:t})}async onParticipantLeave(s){const t=this.participants.joined.get(s);this.participants.joined.delete(s,!0,!0),this.participants.pinned.delete(s,!0,!0),this.participants.waitlisted.delete(s,!0,!0),t&&t.stageStatus==="REQUESTED_TO_JOIN_STAGE"&&R.emit(k.UPDATE_STAGE_REQUESTS,{request:{displayName:t.name,userId:t.userId,peerId:t.id},add:!1});const{currentPage:e}=this.participants,r=this.maxPreferredStreams*(e-1),n=this.participants.videoSubscribed.get(s);r===0?this.participants.setViewMode("ACTIVE_GRID"):this.participants.joined.size<=r?e===2?this.participants.setViewMode("ACTIVE_GRID"):this.participants.setPage(e-1):n&&this.updateActive(e?"PAGINATED":"ACTIVE_GRID",{page:e})}processMedia(s){var h;const t=this.roomNodeClient.getConsumers(),{peerId:e,kind:r,appData:n,track:i,producerId:a,rtpReceiver:c,paused:d}=(h=t.get(s))!=null?h:{};if(!e)return u.warn("processMedia::Peer ID is undefined",{consumer:{id:s,kind:r,peerId:e,appData:{supportsRemoteControl:!!(n!=null&&n.supportsRemoteControl),screenShare:!!(n!=null&&n.screenShare)},remotelyPaused:d,producerId:a}}),{};const l=n;return r==="video"&&l.screenShare!==!0&&this.videoPeerConsumerMap.set(e,s),u.info("ParticipantController::processMedia",{consumer:{id:s,peerId:e,kind:r,appData:l,remotelyPaused:d,producerId:a}}),this.consumerPeerMap.set(s,{type:r,peerId:e,appData:l,remotelyPaused:d,producerId:a}),{peerId:e,kind:r,appData:l,remotelyPaused:d,track:i,producerId:a,rtpReceiver:c}}processConsumerClosed(s){const{peerId:t,type:e,appData:r,remotelyPaused:n,producerId:i}=this.consumerPeerMap.get(s)||{},a=this.participants.joined.get(t);if(u.info("ParticipantController::processConsumerClosed",{consumer:{id:s,peerId:t,appData:r,kind:e,remotelyPaused:n,producerId:i}}),this.consumerPeerMap.delete(s),e==="video"&&r.screenShare!==!0&&this.videoPeerConsumerMap.delete(t),!a)return;const c=[];r&&r.screenShare?(a.setScreenShareEnabled(!1),j.consumerSharedMediaState(s,{screen:!1}),a.screenShareTracks.video&&c.push(a.screenShareTracks.video.id),a.screenShareTracks.audio&&c.push(a.screenShareTracks.audio.id),a.screenShareTracks={audio:void 0,video:void 0}):e==="audio"?(a.setAudioEnabled(!1),a.audioTrack&&c.push(a.audioTrack.id),j.consumerSharedMediaState(s,{audio:!1}),a.audioTrack=void 0):e==="video"&&(a.setVideoEnabled(!1),this.updatePipSource(a.id,!1),a.videoTrack&&c.push(a.videoTrack.id),j.consumerSharedMediaState(s,{video:!1}),a.videoTrack=void 0),r.e2ee&&c.forEach(d=>{R.emit(k.E2EE_INACTIVE_CONSUMER,{peerId:t,trackId:d})})}processConsumerResumed(s){const{peerId:t,kind:e,appData:r,track:n,remotelyPaused:i,producerId:a,rtpReceiver:c}=this.processMedia(s);if(!t)return;u.info("ParticipantController::processConsumerResumed",{consumer:{id:s,peerId:t,kind:e,appData:r,remotelyPaused:i,producerId:a}});const d=this.participants.joined.get(t);if(d){if(r.e2ee&&R.emit(k.E2EE_ACTIVE_CONSUMER,{peerId:t,rtpReceiver:c,track:n}),r.screenShare){e==="video"?d.screenShareTracks.video=n:e==="audio"&&(d.screenShareTracks.audio=n),d.setScreenShareEnabled(!0),j.consumerSharedMediaState(s,{screen:!0});return}e==="video"?(d.videoTrack=n,d.setVideoEnabled(!0),this.updatePipSource(d.id,!0),j.consumerSharedMediaState(s,{video:!0})):e==="audio"&&(d.audioTrack=n,d.setAudioEnabled(d.audioEnabled),j.consumerSharedMediaState(s,{audio:d.audioEnabled}))}}processConsumerPaused(s){u.info(`ParticipantController::processConsumerPaused called for consumerId: ${s}`);const{peerId:t,kind:e,track:r,appData:n,remotelyPaused:i,producerId:a}=this.processMedia(s);if(!t)return;u.info("ParticipantController::processConsumerPaused",{consumer:{id:s,peerId:t,kind:e,appData:n,remotelyPaused:i,producerId:a}});const c=this.participants.joined.get(t);c&&(r&&n.e2ee&&R.emit(k.E2EE_INACTIVE_CONSUMER,{peerId:t,trackId:r.id}),e==="video"?(c.videoTrack=r,c.setVideoEnabled(!1),this.updatePipSource(c.id,!1),j.consumerSharedMediaState(s,{video:!1})):e==="audio"&&(c.audioTrack=r,c.setAudioEnabled(c.audioEnabled),j.consumerSharedMediaState(s,{audio:c.audioEnabled})))}processNewConsumer(s){const{peerId:t,kind:e,remotelyPaused:r,track:n,appData:i,producerId:a,rtpReceiver:c}=this.processMedia(s);if(!t)return;u.info("ParticipantController::processNewConsumer",{consumer:{id:s,peerId:t,kind:e,remotelyPaused:r,appData:i,producerId:a}});const d=this.participants.joined.get(t);if(d){if(i.screenShare){e==="video"?d.screenShareTracks.video=n:e==="audio"&&(d.screenShareTracks.audio=n),(!r||this.self.permissions.isRecorder||ee.hasFeature(se.SCREEENSHARE_ERR_HACK))&&d.setScreenShareEnabled(!0),i.supportsRemoteControl&&(d.supportsRemoteControl=!0),this.participants.broadcastMessage("screenshareConsumerCreated",{producerId:a,peerId:t,screenShare:!0,consumerId:s,consumerPeerId:this.self.id}),u.info("ParticipantController::newScreenshareConsumer::screenshareConsumerCreated",{consumer:{id:s,peerId:t,kind:e,remotelyPaused:r,appData:i,producerId:a}});return}e==="video"?(d.videoTrack=n,r||(d.setVideoEnabled(!0),this.updatePipSource(d.id,!0)),j.consumerSharedMediaState(s,{video:!r})):e==="audio"&&(d.audioTrack=n,r||d.setAudioEnabled(!0),j.consumerSharedMediaState(s,{audio:!r})),!r&&i.e2ee&&R.emit(k.E2EE_ACTIVE_CONSUMER,{peerId:t,rtpReceiver:c,track:n})}}static formatSocketServiceMessage(s){var e,r,n,i,a,c;if(!s)return;const t=Jl(s.stageType);return{id:s.peerId,userId:s.userId,name:s.displayName,displayName:s.displayName,stageType:t,customParticipantId:s.customParticipantId,presetId:s.presetId,picture:s.displayPictureUrl,waitlisted:s.waitlisted,stageStatus:t,metadata:{preset_name:(e=s.flags)==null?void 0:e.presetName},recorderType:(r=s.flags)==null?void 0:r.recorderType,flags:{hiddenParticipant:(n=s.flags)==null?void 0:n.hiddenParticipant,hidden_participant:(i=s.flags)==null?void 0:i.hiddenParticipant,recorder:((a=s.flags)==null?void 0:a.recorderType)!==void 0&&((c=s.flags)==null?void 0:c.recorderType)!=="NONE"}}}mapPeerIdsToProducers(s,t){const e=(n,i)=>n.filter(({kind:a,screenShare:c})=>i.includes(a)||c&&i.includes("screenshare"));return s.flatMap(n=>{const i=this.participants.joined.get(n);if(i)return e(i.producers,t)}).filter(n=>!!n)}updateGrid(s,t){let e=[],r=[],n=[],i=[];return t.video&&([e,n]=t.video(this.participants.videoSubscribed,s)),t.audio&&([r,i]=t.audio(this.participants.audioSubscribed,s)),{video:{add:e,remove:n},audio:{add:r,remove:i}}}async onSelectedPeers(s,t){this.participants.viewMode==="ACTIVE_GRID"&&this.computeActivateParticipants(s,t)}updateActiveParticipantsWithPriorities(s,t=!1){if(!this.mediaJoined){u.warn("Skipped::ParticipantController::updateActiveParticipantsWithPriorities",{roomJoined:this.mediaJoined});return}s.forEach(r=>{this.selectedPeers.add(r.peerId,r.priority)});const e=this.selectedPeers.activeSpeakerPeers.at(0);e!==void 0&&e!==this.participants.lastActiveSpeaker&&(this.participants.lastActiveSpeaker=e,this.participants.emit("activeSpeaker",{peerId:e,volume:1})),t&&(this.participants.viewMode==="ACTIVE_GRID"?this.updateActive("ACTIVE_GRID"):this.participants.viewMode==="PAGINATED"&&this.updateActive("ACTIVE_GRID",{strategies:{audio:this.updateParticipantsMap.bind(this)}}))}};let js=pf;un([T.trace("ParticipantController.setupEvents")],js.prototype,"setupEvents",1),un([T.trace("ParticipantController.setupEvents")],js.prototype,"setupEventsGlobal",1),un([T.trace("ParticipantController.processMedia")],js.prototype,"processMedia",1),un([T.trace("ParticipantController.processConsumerClosed")],js.prototype,"processConsumerClosed",1),un([T.trace("ParticipantController.processConsumerResumed")],js.prototype,"processConsumerResumed",1),un([T.trace("ParticipantController.processConsumerPaused")],js.prototype,"processConsumerPaused",1),un([T.trace("ParticipantController.processNewConsumer")],js.prototype,"processNewConsumer",1);const ge=ps(ll().permissions),qi=class extends Ft{constructor(e,r,n,i=!1){super();g(this,Rt);g(this,H,void 0);g(this,$i,void 0);g(this,Hi,void 0);g(this,wd,e=>{var l,h,m;const{chat:r,connectedMeetings:n,plugins:i,polls:a,media:c,...d}=e;if(r&&(r.private&&ur(o(this,H).chat.private,r.private),r.public&&ur(o(this,H).chat.public,r.public),this.emit("chatUpdate")),n&&ur(o(this,H).connectedMeetings,n),c){const f=_=>{switch(_){case mr.NONE:return G.Allowed;case mr.ALLOWED:return G.Allowed;case mr.NOT_ALLOWED:return G.NotAllowed;case mr.CAN_REQUEST:return G.CanRequest;default:return}},y={audio:void 0,video:void 0,screenshare:void 0};(l=c.audio)!=null&&l.canProduce&&(y.audio={canProduce:f(c.audio.canProduce)}),(h=c.video)!=null&&h.canProduce&&(y.video={canProduce:f(c.video.canProduce)}),(m=c.screenshare)!=null&&m.canProduce&&(y.screenshare={canProduce:f(c.screenshare.canProduce)}),ur(o(this,H).media,y)}i&&(ur(o(this,H).plugins,i),this.emit("pluginsUpdate")),a&&(ur(o(this,H).polls,a),this.emit("pollsUpdate")),Object.keys(d).length!==0&&ur(o(this,H),d),this.emit("permissionsUpdate",e)});if(!r)throw u.error("DytePermissionsPreset::load_preset_permissions_failed"),new P("Could not load preset permissions.","0904");v(this,Hi,e),v(this,$i,n),v(this,H,r),i&&this.setupEvents()}setupEvents(){R.on(k.UPDATE_PERMISSIONS,o(this,wd))}static fromResponse(e,r,n){return new qi(n,e,r,!0)}static default(e,r){return new qi(e,ge,r)}static init(e,r,n){let i;return n?i=new qi(e,n,r,!0):i=new qi(e,ge,r),i}get mediaRoomType(){const{sfu:e}=o(this,Hi).getValue("roomNodeOptions");return e===bt.CF?"CF":"HIVE"}get stageEnabled(){var e;return((e=o(this,H))==null?void 0:e.stageEnabled)||o(this,$i)===yt.Webinar||o(this,$i)===yt.Livestream}get acceptStageRequests(){var e,r;return this.stageEnabled?((e=o(this,H))==null?void 0:e.acceptStageRequests)||((r=o(this,H))==null?void 0:r.canAcceptProductionRequests):!1}get stageAccess(){var e,r,n;return((e=o(this,H))==null?void 0:e.stageAccess)===G.NotAllowed?G.NotAllowed:((r=o(this,H))==null?void 0:r.stageAccess)===G.CanRequest?G.CanRequest:((n=o(this,H))==null?void 0:n.stageAccess)===G.Allowed||o(this,H).media.audio.canProduce===G.Allowed||o(this,H).media.video.canProduce===G.Allowed||o(this,H).media.screenshare.canProduce===G.Allowed?G.Allowed:o(this,H).media.audio.canProduce===G.CanRequest||o(this,H).media.video.canProduce===G.CanRequest||o(this,H).media.screenshare.canProduce===G.CanRequest?G.CanRequest:G.NotAllowed}get acceptWaitingRequests(){var e,r;return(r=(e=o(this,H))==null?void 0:e.acceptWaitingRequests)!=null?r:ge.acceptWaitingRequests}get requestProduceVideo(){var e,r,n;return((n=(r=(e=o(this,H))==null?void 0:e.media)==null?void 0:r.video)==null?void 0:n.canProduce)===G.CanRequest}get requestProduceAudio(){var e,r,n;return((n=(r=(e=o(this,H))==null?void 0:e.media)==null?void 0:r.audio)==null?void 0:n.canProduce)===G.CanRequest}get requestProduceScreenshare(){var e,r,n;return((n=(r=(e=o(this,H))==null?void 0:e.media)==null?void 0:r.screenshare)==null?void 0:n.canProduce)===G.CanRequest}get canAllowParticipantAudio(){var e,r;return(r=(e=o(this,H))==null?void 0:e.disableParticipantAudio)!=null?r:ge.disableParticipantAudio}get canAllowParticipantScreensharing(){var e,r;return(r=(e=o(this,H))==null?void 0:e.canAcceptProductionRequests)!=null?r:ge.canAcceptProductionRequests}get canAllowParticipantVideo(){var e,r;return(r=(e=o(this,H))==null?void 0:e.disableParticipantVideo)!=null?r:ge.disableParticipantVideo}get canDisableParticipantAudio(){return this.canAllowParticipantAudio}get canDisableParticipantVideo(){return this.canAllowParticipantVideo}get kickParticipant(){var e,r;return(r=(e=o(this,H))==null?void 0:e.kickParticipant)!=null?r:ge.kickParticipant}get pinParticipant(){var e,r;return(r=(e=o(this,H))==null?void 0:e.pinParticipant)!=null?r:ge.pinParticipant}get canRecord(){var e,r;return(r=(e=o(this,H))==null?void 0:e.canRecord)!=null?r:ge.canRecord}get waitingRoomType(){var e,r;return(r=(e=o(this,H))==null?void 0:e.waitingRoomType)!=null?r:ge.waitingRoomType}get waitingRoomBehaviour(){var e,r;return(r=(e=o(this,H))==null?void 0:e.waitingRoomType)!=null?r:ge.waitingRoomType}get plugins(){var e,r;return(r=(e=o(this,H))==null?void 0:e.plugins)!=null?r:ge.plugins}get polls(){var e,r;return(r=(e=o(this,H))==null?void 0:e.polls)!=null?r:ge.polls}get produceVideo(){return this.canProduceVideo}get requestProduce(){return o(this,H).media.audio.canProduce===G.CanRequest||o(this,H).media.video.canProduce===G.CanRequest||o(this,H).media.screenshare.canProduce===G.CanRequest}get canProduceVideo(){var r;const e=(r=o(this,H).media.video.canProduce)!=null?r:ge.media.video.canProduce;return this.stageEnabled&&(o(this,Rt,Wt)==="ACCEPTED_TO_JOIN_STAGE"||o(this,Rt,Wt)==="ON_STAGE")&&e===G.CanRequest?G.Allowed:this.stageEnabled&&(o(this,Rt,Wt)==="OFF_STAGE"||o(this,Rt,Wt)==="REQUESTED_TO_JOIN_STAGE")&&e===G.Allowed?G.NotAllowed:e}get produceScreenshare(){return this.canProduceScreenshare}get canProduceScreenshare(){var r;const e=(r=o(this,H).media.screenshare.canProduce)!=null?r:ge.media.screenshare.canProduce;return this.stageEnabled&&(o(this,Rt,Wt)==="ACCEPTED_TO_JOIN_STAGE"||o(this,Rt,Wt)==="ON_STAGE")&&e===G.CanRequest?G.Allowed:this.stageEnabled&&(o(this,Rt,Wt)==="OFF_STAGE"||o(this,Rt,Wt)==="REQUESTED_TO_JOIN_STAGE")&&e===G.Allowed?G.NotAllowed:e}get produceAudio(){return this.canProduceAudio}get canProduceAudio(){var r;const e=(r=o(this,H).media.audio.canProduce)!=null?r:ge.media.audio.canProduce;return this.stageEnabled&&(o(this,Rt,Wt)==="ACCEPTED_TO_JOIN_STAGE"||o(this,Rt,Wt)==="ON_STAGE")&&e===G.CanRequest?G.Allowed:this.stageEnabled&&(o(this,Rt,Wt)==="OFF_STAGE"||o(this,Rt,Wt)==="REQUESTED_TO_JOIN_STAGE")&&e===G.Allowed?G.NotAllowed:e}get chatPublic(){var e,r,n;return(n=(r=(e=o(this,H))==null?void 0:e.chat)==null?void 0:r.public)!=null?n:ge.chat.public}get chatPrivate(){var e,r,n;return(n=(r=(e=o(this,H))==null?void 0:e.chat)==null?void 0:r.private)!=null?n:ge.chat.private}get chatChannel(){var e,r,n;return(n=(r=(e=o(this,H))==null?void 0:e.chat)==null?void 0:r.channel)!=null?n:ge.chat.channel}get chatMessage(){var e,r,n;return(n=(r=(e=o(this,H))==null?void 0:e.chat)==null?void 0:r.message)!=null?n:ge.chat.message}get connectedMeetings(){var e,r;return(r=(e=o(this,H))==null?void 0:e.connectedMeetings)!=null?r:ge==null?void 0:ge.connectedMeetings}get hiddenParticipant(){var e,r;return(r=(e=o(this,H))==null?void 0:e.hiddenParticipant)!=null?r:ge.hiddenParticipant}get showParticipantList(){var e;return(e=o(this,H).showParticipantList)!=null?e:ge.showParticipantList}get canChangeParticipantRole(){var e,r;return(r=(e=o(this,H))==null?void 0:e.canChangeParticipantPermissions)!=null?r:ge.canChangeParticipantPermissions}get canChangeParticipantPermissions(){var e,r;return(r=(e=o(this,H))==null?void 0:e.canChangeParticipantPermissions)!=null?r:ge.canChangeParticipantPermissions}get canChangeTheme(){return!1}get canPresent(){return o(this,H).media.audio.canProduce===G.Allowed||o(this,H).media.video.canProduce===G.Allowed||o(this,H).media.screenshare.canProduce===G.Allowed}get acceptPresentRequests(){return this.acceptStageRequests}get canEditDisplayName(){var e;return(e=o(this,H).canEditDisplayName)!=null?e:!1}get maxScreenShareCount(){return 1}get isRecorder(){return o(this,H).isRecorder}get canSpotlight(){return o(this,H).canSpotlight}get canLivestream(){return o(this,H).canLivestream}get transcriptionEnabled(){return o(this,H).transcriptionEnabled}};let nu=qi;H=new WeakMap,$i=new WeakMap,Hi=new WeakMap,wd=new WeakMap,Rt=new WeakSet,Wt=function(){return o(this,Hi).getValue("stageStatus")};class aM extends Ft{constructor(){super(...arguments);p(this,"localMediaHandler");g(this,Pu,void 0)}async updatePermission(){var d,l;const e=(h,m)=>{this.mediaPermissions[h]=m;const f={message:this.mediaPermissions[h],kind:h};m==="DENIED"?R.emit(k.MEDIA_PERMISSION_ERROR,f):R.emit(k.MEDIA_PERMISSION_UPDATE,f)};if(be.getName()==="firefox")return;const r="microphone",n="camera",i=await((d=navigator==null?void 0:navigator.permissions)==null?void 0:d.query({name:r})),a=await((l=navigator==null?void 0:navigator.permissions)==null?void 0:l.query({name:n})),c=(h,m)=>{switch(m){case"granted":e(h,"ACCEPTED");break;case"denied":e(h,"DENIED");break;case"prompt":e(h,"NOT_REQUESTED");break}this.localMediaHandler.repopulateAvailableDevices()};i&&(i.onchange=()=>c("audio",i.state)),a&&(a.onchange=()=>c("video",a.state))}async populateMediaPermissionsInCallstats({message:e,kind:r}){switch(r){case"audio":{j.mediaPermission("AUDIO",e),j.mediaPermission("SPEAKER",e);break}case"video":{j.mediaPermission("VIDEO",e);break}case"screenshare":{j.mediaPermission("SCREENSHARE",e);break}}}async init(e={},r=!1,n=null){var i,a,c,d,l,h;if(be.init(),!this.localMediaHandler)try{let m=!0;if(n!=null&&n.getValue("defaults").mediaHandler)m=!1,this.localMediaHandler=n.getValue("defaults").mediaHandler.localMediaHandler;else if(navigator.RNLocalMediaHandlerImpl){const{RNLocalMediaHandlerImpl:f}=navigator;this.localMediaHandler=await f.init()}else this.localMediaHandler=new Nt(n,e.constraints,(i=n==null?void 0:n.getValue("defaults"))==null?void 0:i.isNonPreferredDevice,(a=n==null?void 0:n.getValue("defaults"))==null?void 0:a.autoSwitchAudioDevice);if(R.on(k.MEDIA_PERMISSION_UPDATE,async f=>{if(this.populateMediaPermissionsInCallstats({message:f.message,kind:f.kind}),f.message==="NOT_REQUESTED")switch(f==null?void 0:f.kind){case"audio":this.rawAudioTrack&&(u.info("Disabling audio due to media permission update"),this.disableAudio());break;case"video":this.rawVideoTrack&&(u.info("Disabling video due to media permission update"),this.disableVideo());break;default:break}this.emit("mediaPermissionUpdate",f)}),R.on(k.MEDIA_PERMISSION_ERROR,async f=>{const{kind:y,message:_,constraints:b}=f;this.populateMediaPermissionsInCallstats({message:_,kind:y}),y==="audio"?(u.info(`Disabling audio due to media permission error  skipping: ${this.localMediaHandler.audioUpdateInProgress}`),this.localMediaHandler.audioUpdateInProgress===!1&&this.disableAudio()):y==="video"&&(u.info(`Disabling video due to media permission error skipping: ${this.localMediaHandler.videoUpdateInProgress}`),this.localMediaHandler.videoUpdateInProgress===!1&&this.disableVideo()),u.error("SelfController::mediaPermissionError",{error:{message:_},constraints:b,mediaPermissionsErrors:{kind:y,message:_}}),this.emit("mediaPermissionError",f),this.emit("mediaPermissionUpdate",{message:_,kind:y})}),m){u.info(`Setting up DyteSelfMedia streams using media handler. audio:${(c=e==null?void 0:e.audio)!=null?c:!0} video:${(d=e==null?void 0:e.video)!=null?d:!0}`);const f=this.localMediaHandler.setupStreams({video:(l=e==null?void 0:e.video)!=null?l:!0,audio:(h=e==null?void 0:e.audio)!=null?h:!0});r||await f}}catch(m){u.error("DyteSelf::init::Failed To Setup Streams",{error:{name:m.name,message:m.message}})}}get audioTrack(){return this.localMediaHandler.audioTrack}get rawAudioTrack(){return this.localMediaHandler.rawAudioTrack}get mediaPermissions(){return this.localMediaHandler.permissions}async addAudioMiddleware(e){return this.localMediaHandler.addAudioMiddleware(e)}async removeAudioMiddleware(e){return this.localMediaHandler.removeAudioMiddleware(e)}async removeAllAudioMiddlewares(){return this.localMediaHandler.removeAllAudioMiddlewares()}get videoTrack(){return this.localMediaHandler.videoTrack}get rawVideoTrack(){return this.localMediaHandler.rawVideoTrack}async addVideoMiddleware(e){return this.localMediaHandler.addVideoMiddleware(e)}async setVideoMiddlewareGlobalConfig(e={disablePerFrameCanvasRendering:!1}){return this.localMediaHandler.setVideoMiddlewareGlobalConfig(e)}async removeVideoMiddleware(e){return this.localMediaHandler.removeVideoMiddleware(e)}async removeAllVideoMiddlewares(){return this.localMediaHandler.removeAllVideoMiddlewares()}get screenShareTracks(){return this.localMediaHandler.screenShareTracks}get audioEnabled(){return this.localMediaHandler.audioEnabled}get videoEnabled(){return this.localMediaHandler.videoEnabled}get screenShareEnabled(){return this.localMediaHandler.screenShareEnabled}async enableAudio(){await this.localMediaHandler.enableAudio(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}async enableVideo(){await this.localMediaHandler.enableVideo(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}async disableAudio(){this.localMediaHandler.disableAudio(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}async enableScreenShare(){await this.localMediaHandler.enableScreenShare(),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}async disableScreenShare(){await this.localMediaHandler.disableScreenShare(),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}async disableVideo(){await this.localMediaHandler.disableVideo(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}getCurrentDevices(){return this.localMediaHandler.getCurrentDevices()}async getAudioDevices(){return await this.localMediaHandler.getAudioDevices()}async getVideoDevices(){return await this.localMediaHandler.getVideoDevices()}async getSpeakerDevices(){return await this.localMediaHandler.getSpeakerDevices()}getDeviceById(e,r){let n;return r==="audio"?n="audioinput":r==="video"?n="videoinput":r==="speaker"&&(n="audiooutput"),this.localMediaHandler.getDeviceById(e,n)}async setDevice(e){switch(e.kind){case"audioinput":try{await this.localMediaHandler.setAudioDevice(e)}catch(r){}finally{this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}break;case"audiooutput":await this.localMediaHandler.setSpeakerDevice(e);break;case"videoinput":try{await this.localMediaHandler.setVideoDevice(e)}catch(r){}finally{this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}break}this.emit("deviceUpdate",{device:e})}}Pu=new WeakMap;const Da={},Tr={executeWithLock({methodName:s,lockName:t,timeout:e}){return(r,n,i)=>{const a=i.value;return i.value=function(...d){if(Da[t]){const m=new Error(`Unsupported concurrent calls on Dyte method: ${s}.`);throw m.name="UnsupportedConcurrentMethodExecution",u.error("DyteLocker::UnsupportedConcurrentMethodExecution",{error:{stack:m.stack},dyteLocker:{methodName:s,lockName:t}}),m}Da[t]=!0;const l=setTimeout(()=>delete Da[t],e),h=a.apply(this,d);return Promise.resolve(h).then(()=>{delete Da[t],clearTimeout(l)}).catch(()=>{delete Da[t],clearTimeout(l)}),h},i}}};var oM=Object.defineProperty,cM=Object.getOwnPropertyDescriptor,wt=(s,t,e,r)=>{for(var n=r>1?void 0:r?cM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&oM(t,e,n),n};let et=(cg=class extends aM{constructor(t,e,r,n,i){var a;super();g(this,Vr);g(this,Ye);g(this,qe);g(this,io);p(this,"name");p(this,"picture");p(this,"customParticipantId");p(this,"waitlistStatus");g(this,ji,void 0);g(this,kt,void 0);g(this,Gi,void 0);p(this,"role");p(this,"userId");p(this,"organizationId");p(this,"supportsRemoteControl",!1);p(this,"device");g(this,Ms,void 0);p(this,"hidden",!1);p(this,"presetName");p(this,"roomState","init");g(this,Wi,new Set);g(this,Ji,new Set);v(this,Ms,t),this.userId=e.id,this.name=e.name,this.picture=e.picture,this.customParticipantId=(a=e.customParticipantId)!=null?a:e.clientSpecificId,this.waitlistStatus="none",v(this,kt,r),v(this,ji,n),this.hidden=!1,v(this,Gi,!1),this.organizationId=e.organizationId,this.supportsRemoteControl=be.isElectron(),this.device=be.getDeviceInfo(),this.presetName=i,n.viewType!==yt.Chat&&this.updatePermission(),this.updateVideo=this.updateVideo.bind(this),$(this,io,Ou).call(this)}get stageStatus(){return o(this,Ms).getValue("stageStatus")}get id(){return o(this,Ms).getValue("peerId")}static async __init__(t,e,r,n,i,a=!1){var m,f,y,_,b;let c=(f=(m=t.getValue("defaults"))==null?void 0:m.audio)!=null?f:!0,d=(_=(y=t.getValue("defaults"))==null?void 0:y.video)!=null?_:!0;r.canProduceAudio!=="ALLOWED"&&(c=!1),r.canProduceVideo!=="ALLOWED"&&(d=!1);const l=new et(t,e,r,n,i);if(n.viewType===yt.Chat)return l;const h=v0(n.mediaConstraints);return ur(h,(b=t.getValue("defaults"))==null?void 0:b.mediaConfiguration),await l.init({audio:c,video:d,constraints:h},a,t),l.setupEvents(),l}cleanupEvents(){this.removeAllListeners("videoUpdate"),this.localMediaHandler.removeAllListeners("AUDIO_TRACK_CHANGE"),this.localMediaHandler.removeAllListeners("VIDEO_TRACK_CHANGE"),this.localMediaHandler.removeAllListeners("DEVICE_CHANGE"),this.localMediaHandler.removeAllListeners("DEVICE_LIST_UPDATED"),this.localMediaHandler.removeAllListeners("SCREENSHARE_TRACK_CHANGE"),this.localMediaHandler.removeAllListeners("SCREENSHARE_ENDED"),this.localMediaHandler.removeAllListeners("AUDIO_TRACK_SILENT"),this.localMediaHandler.removeAllListeners("FORCE_MUTE_AUDIO"),this.localMediaHandler.removeAllListeners("FORCE_MUTE_VIDEO"),o(this,kt).removeAllListeners("permissionsUpdate")}setupEvents(){this.on("videoUpdate",$(this,io,Ou)),this.localMediaHandler.on("AUDIO_TRACK_CHANGE",async()=>{if(u.info("DyteSelf::setupEvents::AUDIO_TRACK_CHANGE",{...ln(this)}),o(this,qe,Xe)&&this.audioEnabled)try{await o(this,Ye,dt).shareMic(this.audioTrack)}catch(t){u.error("DyteSelf::setupEvents::Error while sharing mic",{error:t}),this.localMediaHandler.disableAudio()}this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}),this.localMediaHandler.on("VIDEO_TRACK_CHANGE",async()=>{if(u.info("DyteSelf::setupEvents::VIDEO_TRACK_CHANGE",{...ln(this)}),o(this,qe,Xe)&&this.rawVideoTrack===void 0)u.info("DyteSelf::VIDEO_TRACK_CHANGE::Forcing_disable_video"),this.disableVideo();else if(this.videoEnabled&&o(this,qe,Xe))try{const t=await o(this,Ye,dt).shareWebcam(this.videoTrack);t&&t.id!==this.videoTrack.id&&ee.hasFeature(se.EXP_RESHARE)&&await o(this,Ye,dt).shareWebcam(this.videoTrack)}catch(t){u.error("DyteSelf::setupEvents::failed shareWebcam",{error:t}),this.videoEnabled&&await this.localMediaHandler.disableVideo()}this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}),this.localMediaHandler.on("DEVICE_CHANGE",async({device:t})=>{this.emit("deviceUpdate",{device:t})}),this.localMediaHandler.on("DEVICE_LIST_UPDATED",t=>{this.emit("deviceListUpdate",t)}),this.localMediaHandler.on("SCREENSHARE_TRACK_CHANGE",async()=>{if(!o(this,qe,Xe)){u.error("DyteSelf.SCREENSHARE_TRACK_CHANGE.LocalMediaInitialized_WithoutRoomNode");return}if(this.screenShareEnabled)try{await o(this,Ye,dt).shareScreen(this.screenShareTracks)}catch(t){u.error("DyteSelf::setupEvents::Error while sharing screen",{error:t}),this.screenShareEnabled&&await this.localMediaHandler.disableScreenShare()}u.info("DyteSelf::setupEvents::SCREENSHARE_TRACK_CHANGE",{...ln(this)}),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}),this.localMediaHandler.on("SCREENSHARE_ENDED",async()=>{u.log("Disabling screenshare due to SCREENSHARE_ENDED"),await this.disableScreenShare(),u.info("DyteSelf::setupEvents::SCREENSHARE_ENDED",{...ln(this)})}),this.localMediaHandler.on("AUDIO_TRACK_SILENT",()=>{j.mediaTrackMuted("AUDIO")}),this.localMediaHandler.on("FORCE_MUTE_AUDIO",()=>{this.disableAudio()}),this.localMediaHandler.on("FORCE_MUTE_VIDEO",async()=>{o(this,qe,Xe)&&await o(this,Ye,dt).pauseWebcam(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),j.videoOff()}),o(this,kt).on("permissionsUpdate",t=>{var e,r,n;(e=t==null?void 0:t.media)!=null&&e.audio&&o(this,kt).canProduceAudio!==G.Allowed&&(this.disableAudio(),u.info(`Disabled audio due to dynamic preset change: canProduceAudio: ${this.permissions.canProduceAudio}`)),(r=t==null?void 0:t.media)!=null&&r.video&&o(this,kt).canProduceVideo!==G.Allowed&&(this.disableVideo(),u.info(`Disabled video due to dynamic preset change: canProduceVideo: ${this.permissions.canProduceVideo}`)),(n=t==null?void 0:t.media)!=null&&n.screenshare&&o(this,kt).canProduceScreenshare!==G.Allowed&&(this.disableScreenShare(),u.info(`Disabled screenshare due to dynamic preset change: canProduceScreenshare: ${this.permissions.canProduceScreenshare}`))})}get permissions(){return o(this,kt)}get config(){return o(this,ji)}get roomJoined(){var t;return o(this,ji).viewType===yt.Livestream&&this.stageStatus!=="ON_STAGE"?((t=o(this,Ms).getValue("connectionHandler"))==null?void 0:t.socketJoined)===!0:o(this,qe,Xe)}setName(t){if(!t)throw new P("Name cannot be empty.","1103");this.name=t}async setupTracks(t={}){t.forceReset,await this.disableAudio(),await this.disableVideo(),this.localMediaHandler.removeAudioTrack(),this.localMediaHandler.removeVideoTrack(),t.audio&&await this.enableAudio(),t.video&&await this.enableVideo()}async destructMediaHandler(){return this.localMediaHandler.destruct()}async removeDocumentEventListeners(){return this.localMediaHandler.removeDocumentEventListeners()}async enableAudio(){if(this.permissions.canProduceAudio!==G.NotAllowed&&!(o(this,kt).canProduceAudio===G.CanRequest&&(this.stageStatus==="OFF_STAGE"||this.stageStatus==="REQUESTED_TO_JOIN_STAGE"))&&!this.audioEnabled){if(j.audioOn(),await this.localMediaHandler.enableAudio(),o(this,qe,Xe)&&this.stageStatus==="ON_STAGE"){if(this.audioTrack)try{await o(this,Ye,dt).shareMic(this.audioTrack)}catch(t){u.error("DyteSelf::enableAudio::Error while sharing mic",{error:t}),this.localMediaHandler.disableAudio()}if(!this.audioEnabled)return;o(this,Ye,dt).unmuteSelf()}this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}}async enableVideo(){if(o(this,kt).canProduceVideo!==G.NotAllowed&&!(o(this,kt).canProduceVideo===G.CanRequest&&(this.stageStatus==="OFF_STAGE"||this.stageStatus==="REQUESTED_TO_JOIN_STAGE"))&&!this.videoEnabled){if(j.videoOn(),await this.localMediaHandler.enableVideo(),o(this,qe,Xe)&&this.stageStatus==="ON_STAGE")try{await o(this,Ye,dt).shareWebcam(this.videoTrack)}catch(t){u.error("DyteSelf::enableVideo::Error while sharing video",{error:t}),this.videoEnabled&&this.localMediaHandler.disableVideo()}this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),u.info("DyteSelf.enableVideo",{...ln(this)})}}async updateVideoConstraints(t){if(!this.localMediaHandler.updateVideoConstraints)throw new P("Unsupported","1102");await this.localMediaHandler.updateVideoConstraints(t)}async enableScreenShare(){if(!o(this,qe,Xe))throw new P("Can`t enable screenshare without joining room","1105");if(o(this,kt).canProduceScreenshare!==G.NotAllowed&&!(o(this,kt).canProduceScreenshare===G.CanRequest&&(this.stageStatus==="OFF_STAGE"||this.stageStatus==="REQUESTED_TO_JOIN_STAGE"))&&!this.screenShareEnabled&&(await this.localMediaHandler.enableScreenShare(),this.screenShareTracks.audio||this.screenShareTracks.video)){try{await o(this,Ye,dt).shareScreen(this.screenShareTracks)}catch(t){u.error("DyteSelf::enableScreenShare::Error while sharing screen",{error:t}),this.screenShareEnabled&&await this.localMediaHandler.disableScreenShare()}this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}}async updateScreenshareConstraints(t){if(!this.localMediaHandler.updateScreenshareConstraints)throw new P("Unsupported","1102");await this.localMediaHandler.updateScreenshareConstraints(t)}async disableAudio(){this.audioEnabled&&(this.localMediaHandler.disableAudio(),o(this,qe,Xe)&&o(this,Ye,dt).muteSelf(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack}),j.audioOff())}async disableVideo(){this.videoEnabled&&(await this.localMediaHandler.disableVideo(),o(this,qe,Xe)&&await o(this,Ye,dt).pauseWebcam(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),j.videoOff())}async disableScreenShare(){this.screenShareEnabled&&(await this.localMediaHandler.disableScreenShare(),o(this,qe,Xe)&&await o(this,Ye,dt).disableScreenShare(),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks}))}getAllDevices(){return this.localMediaHandler.getAllDevices()}setIsPinned(t,e=!0){var n;v(this,Gi,t);const r=t?"pinned":"unpinned";(n=o(this,Vr,da))==null||n.updateSource(this.id,{pinned:t}),e&&this.emit(r,this)}get isPinned(){return o(this,Gi)}async pin(){if(!o(this,qe,Xe))throw new P("Can`t pin participants without joining room","1105");return this.show(),o(this,Ye,dt).pinPeer(this.id)}async unpin(){if(!o(this,qe,Xe))throw new P("Can`t unpin participants without joining room","1105");return o(this,Ye,dt).pinPeer(null)}async hide(){if(!o(this,qe,Xe))throw new P("Can`t toggle participant tile without joining room","1105");this.hidden=!0,this.emit("toggleTile",{hidden:this.hidden})}show(){if(!o(this,qe,Xe))throw new P("Can`t toggle participant tile without joining room","1105");this.hidden=!1,this.emit("toggleTile",{hidden:this.hidden})}async setDevice(t){var r,n,i;if(!t)throw new P("No device selected","1104");const e=this.getCurrentDevices();if(t.deviceId&&(((r=e==null?void 0:e.audio)==null?void 0:r.deviceId)===t.deviceId||((n=e==null?void 0:e.video)==null?void 0:n.deviceId)===t.deviceId||((i=e==null?void 0:e.speaker)==null?void 0:i.deviceId)===t.deviceId)&&(u.warn("DyteSelf.setDevice.setting_to_in_use_device",{devices:[t]}),ee.hasFeature(se.SKIP_SETTING_IN_USE_DEVICE)))throw new P("Cannot set device currently in use","1106");switch(t.kind){case"audioinput":try{await this.localMediaHandler.setAudioDevice(t)}catch(a){o(this,qe,Xe)&&await o(this,Ye,dt).muteSelf(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}break;case"audiooutput":await this.localMediaHandler.setSpeakerDevice(t);break;case"videoinput":try{await this.localMediaHandler.setVideoDevice(t)}catch(a){o(this,qe,Xe)&&await o(this,Ye,dt).pauseWebcam(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}break}}cleanUpTracks(){var t,e,r,n;(t=this.audioTrack)==null||t.stop(),(e=this.rawAudioTrack)==null||e.stop(),(r=this.videoTrack)==null||r.stop(),(n=this.rawVideoTrack)==null||n.stop()}registerVideoElement(t,e=!1){var r,n;e?o(this,Wi).add(t):o(this,Ji).add(t),this.updateVideo(t),e||(n=o(this,Vr,da))==null||n.addSource(this.id,t,this.videoEnabled,this.isPinned,this.name,this.picture,(r=this.raised)!=null?r:!1)}deregisterVideoElement(t,e=!1){t.srcObject=void 0,e?o(this,Wi).delete(t):(o(this,Ji).delete(t),o(this,Vr,da).removeSource(this.id))}updateVideo(t,e=!1){var r,n,i;if(this.videoEnabled){if(this.videoTrack==null)return;const a=(r=t.srcObject)==null?void 0:r.getTracks()[0];if((a==null?void 0:a.id)===this.videoTrack.id)return;const c=new MediaStream;c.addTrack(this.videoTrack),t.srcObject=c,e||(n=o(this,Vr,da))==null||n.enableSource(this.id)}else t.srcObject=void 0,e||(i=o(this,Vr,da))==null||i.disableSource(this.id);t.style.display=this.videoEnabled?"block":"none"}},ji=new WeakMap,kt=new WeakMap,Gi=new WeakMap,Ms=new WeakMap,Vr=new WeakSet,da=function(){return o(this,Ms).getValue("pip")},Ye=new WeakSet,dt=function(){return o(this,Ms).getValue("roomNodeClient")},qe=new WeakSet,Xe=function(){var t;return((t=o(this,Ms).getValue("connectionHandler"))==null?void 0:t.mediaJoined)===!0},Wi=new WeakMap,Ji=new WeakMap,io=new WeakSet,Ou=function(){Array.from(o(this,Ji)).forEach(t=>this.updateVideo(t,!1)),Array.from(o(this,Wi)).forEach(t=>this.updateVideo(t,!0))},cg);wt([T.trace("DyteSelf.cleanupEvents")],et.prototype,"cleanupEvents",1),wt([T.trace("DyteSelf.setupEvents")],et.prototype,"setupEvents",1),wt([T.trace("DyteSelf.setupTracks")],et.prototype,"setupTracks",1),wt([T.trace("DyteSelf.destructMediaHandler")],et.prototype,"destructMediaHandler",1),wt([T.trace("DyteSelf.removeDocumentEventListeners")],et.prototype,"removeDocumentEventListeners",1),wt([Tr.executeWithLock({methodName:"meeting.self.enableAudio",lockName:"DyteSelf.toggleAudio",timeout:3e3}),T.trace("DyteSelf.enableAudio")],et.prototype,"enableAudio",1),wt([Tr.executeWithLock({methodName:"meeting.self.enableVideo",lockName:"DyteSelf.toggleVideo",timeout:3e3}),T.trace("DyteSelf.enableVideo")],et.prototype,"enableVideo",1),wt([T.trace("DyteSelf.updateVideoConstraints")],et.prototype,"updateVideoConstraints",1),wt([T.trace("DyteSelf.enableScreenShare"),Tr.executeWithLock({methodName:"meeting.self.enableScreenShare",lockName:"DyteSelf.toggleScreenShare",timeout:3e3})],et.prototype,"enableScreenShare",1),wt([T.trace("DyteSelf.updateScreenshareConstraints")],et.prototype,"updateScreenshareConstraints",1),wt([Tr.executeWithLock({methodName:"meeting.self.disableAudio",lockName:"DyteSelf.toggleAudio",timeout:3e3}),T.trace("DyteSelf.disableAudio")],et.prototype,"disableAudio",1),wt([Tr.executeWithLock({methodName:"meeting.self.disableVideo",lockName:"DyteSelf.toggleVideo",timeout:3e3}),T.trace("DyteSelf.disableVideo")],et.prototype,"disableVideo",1),wt([Tr.executeWithLock({methodName:"meeting.self.disableScreenShare",lockName:"DyteSelf.toggleScreenShare",timeout:3e3}),T.trace("DyteSelf.disableScreenShare")],et.prototype,"disableScreenShare",1),wt([T.trace("DyteSelf.setDevice")],et.prototype,"setDevice",1),et=wt([lt("1100")],et);var dM=Object.defineProperty,lM=Object.getOwnPropertyDescriptor,uM=(s,t,e,r)=>{for(var n=r>1?void 0:r?lM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&dM(t,e,n),n};let hn;const mf=(dg=class{constructor(s,t){p(this,"socket");g(this,ao,void 0);v(this,ao,t),this.socket=s,this.handleSocketEvents()}static create(s,t){return hn||(hn=new mf(s,t)),hn}static cleanup(){var s;try{(s=hn==null?void 0:hn.socket)==null||s.disconnect()}catch(t){u.error("roomSocketHandler::cleanup")}hn=void 0}async joinRoom(s){var r;this.socket.joinAttempted=!0;const t={capabilities:[],peer:{displayName:(r=s.name)!=null?r:"Participant",customParticipantId:s.customParticipantId,peerId:s.id,userId:s.userId,displayPictureUrl:s.picture,waitlisted:!1},roomUuid:""},e=this.socket.sendMessagePromise(V.joinRoom,TC.toBinary(t));try{const{peer:n}=Zn.fromBinary((await e).payload);o(this,ao).getValue("connectionHandler").socketJoined=!0,R.emit(k.SOCKET_SERVICE_ROOM_JOINED,{peer:n});const i=this.getRoomState(),a=this.getRoomPeersNonPaginated(),[{room:c},{peers:d}]=await Promise.all([i,a]);return R.emit(k.ROOM_STATE,c),R.emit(k.SOCKET_PEERS,d),{peer:n}}catch(n){throw u.error("RoomSocketHandler.joinRoom.failed",{error:n}),new P("Error: RoomSocketHandler.joinRoom failed.","0002",n)}}async getAllAddedParticipants(){try{return sR.fromBinary((await this.socket.sendMessagePromise(V.getAllAddedParticipants)).payload).participants.map(({id:t,...e})=>({...e,userId:t}))}catch(s){return[]}}async getRoomPeers(s,t,e){let r;try{const n={seachQuery:s,limit:t,offset:e},i=await this.socket.sendMessagePromise(V.getRoomPeersInfo,cC.toBinary(n));r=Al.fromBinary(i.payload)}catch(n){u.error("getRoomPeers::binary_decode_error",{error:n})}return r}async getRoomPeersNonPaginated(){let s;try{const t=await this.socket.sendMessagePromise(V.getRoomPeersInfo);s=Al.fromBinary(t.payload)}catch(t){u.error("getRoomJoinedPeers::binary_decode_error",{error:t})}return s}async getStagePeers(){let s;try{const t=await this.socket.sendMessagePromise(V.getRoomPeersInfo);s=Al.fromBinary(t.payload)}catch(t){u.error("getRoomJoinedPeers::binary_decode_error",{error:t})}return s}async getPeerInfo(s){let t;try{const e=await this.socket.sendMessagePromise(V.getPeerInfo,Tm.toBinary({peerId:s}));t=Zn.fromBinary(e.payload)}catch(e){u.error("getPeerInfo::binary_decode_error",{error:e})}return t}async getRoomState(){let s=vm.create();try{const t=await this.socket.sendMessagePromise(V.getRoomInfo);s=vm.fromBinary(t.payload)}catch(t){u.error("getRoomState::binary_decode_error",{error:t})}return s}async getRoomStageState(){let s=bm.create();try{const t=await this.socket.sendMessagePromise(V.getRoomStageState);s=bm.fromBinary(t.payload)}catch(t){u.error("getRoomStageState::binary_decode_error",{error:t})}return s}async broadcastMessage(s,t){const e={type:s,payload:new TextEncoder().encode(JSON.stringify(t)),timestamp:Date.now(),ids:[]};return this.socket.sendMessagePromise(V.broadcastMessage,Pa.toBinary(e))}async broadcastToMeetings(s,t,e){const r={type:s,payload:new TextEncoder().encode(JSON.stringify(e)),timestamp:Date.now(),ids:t,broadcastType:1};return this.socket.sendMessagePromise(V.broadcastToEntity,Pa.toBinary(r))}async broadcastToPeers(s,t,e){const r={type:s,payload:new TextEncoder().encode(JSON.stringify(e)),timestamp:Date.now(),ids:t,broadcastType:0};return this.socket.sendMessage(V.broadcastToEntity,Pa.toBinary(r))}async leaveRoom(){this.socket.joinAttempted=!1,this.socket.sendMessagePromise(V.leaveRoom,SC.toBinary({}))}async kick(s){const t={peerIds:[s]};this.socket.sendMessage(V.kick,aR.toBinary(t))}async kickAll(s=!1){const t={propagateKickAcrossRooms:s};this.socket.sendMessage(V.kickAll,om.toBinary(t))}getWaitingRoomRequests(){this.socket.sendMessage(V.getWaitingRoomRequests)}acceptWaitingRoomRequest(s){const t={userIds:s};this.socket.sendMessage(V.acceptWaitingRoomRequests,dR.toBinary(t))}rejectWaitingRoomRequest(s){const t={userIds:s};this.socket.sendMessage(V.denyWaitingRoomRequests,uR.toBinary(t))}async updatePermissions(s,t){const e={updatePeersPresets:[]};return s.forEach(r=>{e.updatePeersPresets.push({userIds:r,patch:t})}),this.socket.sendMessagePromise(Nc.updateUserPreset,BR.toBinary(e))}handleSocketEvents(){this.socket.on(V.broadcastMessage,({payload:s})=>{try{const t=Pa.fromBinary(s);R.emit(k.ROOM_MESSAGE,{payload:JSON.parse(new TextDecoder().decode(t.payload)),type:t.type,timestamp:t.timestamp})}catch(t){u.error("failed to decode broadcast message:",t)}}),this.socket.on(V.broadcastToEntity,({payload:s})=>{try{const t=Pa.fromBinary(s);R.emit(k.MESSAGE,{payload:JSON.parse(new TextDecoder().decode(t.payload)),type:t.type,timestamp:t.timestamp})}catch(t){u.error("failed to decode peer broadcast message:",t)}})}on(s,t){let e,r;switch(s){case V.joinRoom:case V.leaveRoom:case V.kick:case V.kickAll:{e=Zn.fromBinary.bind(Zn),r=Zn.create();break}case V.getWaitingRoomRequests:{e=(n,i)=>n?_m.fromBinary(n,i):{requests:[]},r=_m.create();break}case V.recordingPaused:case V.recordingStarted:case V.recordingStopped:{e=Lm.fromBinary.bind(Lm);break}case Nc.updateUserPreset:{e=Pm.fromBinary.bind(Pm);break}case us.peerJoinedBroadcast:case Kt.peerJoinedBroadcast:{e=lm.fromBinary.bind(lm);break}case us.selfJoinComplete:case Kt.selfJoinComplete:{e=Pl.fromBinary.bind(Pl);break}case us.globalPeerPinBroadcast:case Kt.globalPeerPinBroadcast:{e=pm.fromBinary.bind(pm);break}case us.selectedPeer:case Kt.selectedPeer:{e=wl.fromBinary.bind(wl);break}case us.selectedPeerDiff:case Kt.selectedPeerDiff:{e=dm.fromBinary.bind(dm);break}case us.leaveRoom:case Kt.leaveRoom:{e=Cl.fromBinary.bind(Cl);break}}this.socket.on(s,({payload:n})=>{let i=r;if(!e)return t(void 0);try{i=e(n)}catch(a){u.error("roomSocketHandler::on::binary_decode_error",{error:a})}return t(i)})}async getUserPermissions(s){const t={userIds:[s]};try{const e=await this.socket.sendMessagePromise(Nc.getUserPresets,OR.toBinary(t)),r=VR.fromBinary(e.payload).peerPresets[0],n=new TextDecoder().decode(r.preset),i=JSON.parse(n).permissions;return{chat:i.chat,polls:i.polls,plugins:i.plugins}}catch(e){throw u.error("Error in getting user preset",{error:e}),e}}},ao=new WeakMap,dg);let Gc=mf;uM([T.trace("RoomSocketHandler.joinRoom")],Gc.prototype,"joinRoom",1);var pn={},Wc={};Object.defineProperty(Wc,"__esModule",{value:!0}),Wc.Logger=void 0;class hM{constructor(t){}debug(){}warn(){}error(){}}Wc.Logger=hM,Object.defineProperty(pn,"__esModule",{value:!0});var Jc=pn.AwaitQueue=pn.AwaitQueueRemovedTaskError=pn.AwaitQueueStoppedError=void 0;const pM=Wc,yr=new pM.Logger;class iu extends Error{constructor(t){super(t!=null?t:"AwaitQueue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,iu)}}pn.AwaitQueueStoppedError=iu;class Kc extends Error{constructor(t){super(t!=null?t:"AwaitQueue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Kc)}}pn.AwaitQueueRemovedTaskError=Kc;class mM{constructor(){this.pendingTasks=new Map,this.nextTaskId=0,this.stopping=!1}get size(){return this.pendingTasks.size}async push(t,e){if(e=e!=null?e:t.name,yr.debug(`push() [name:${e}]`),typeof t!="function")throw new TypeError("given task is not a function");if(e)try{Object.defineProperty(t,"name",{value:e})}catch(r){}return new Promise((r,n)=>{const i={id:this.nextTaskId++,task:t,name:e,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:a=>{if(i.completed)return;i.completed=!0,this.pendingTasks.delete(i.id),yr.debug(`resolving task [name:${i.name}]`),r(a);const[c]=this.pendingTasks.values();c&&!c.executedAt&&this.execute(c)},reject:a=>{if(!i.completed&&(i.completed=!0,this.pendingTasks.delete(i.id),yr.debug(`rejecting task [name:${i.name}]: %s`,String(a)),n(a),!this.stopping)){const[c]=this.pendingTasks.values();c&&!c.executedAt&&this.execute(c)}}};this.pendingTasks.set(i.id,i),this.pendingTasks.size===1&&this.execute(i)})}stop(){yr.debug("stop()"),this.stopping=!0;for(const t of this.pendingTasks.values())yr.debug(`stop() | stopping task [name:${t.name}]`);this.stopping=!1}remove(t){yr.debug(`remove() [taskIdx:${t}]`);const e=Array.from(this.pendingTasks.values())[t];if(!e){yr.debug(`stop() | no task with given idx [taskIdx:${t}]`);return}e.reject(new Kc)}dump(){const t=Date.now();let e=0;return Array.from(this.pendingTasks.values()).map(r=>({idx:e++,task:r.task,name:r.name,enqueuedTime:r.executedAt?r.executedAt-r.enqueuedAt:t-r.enqueuedAt,executionTime:r.executedAt?t-r.executedAt:0}))}async execute(t){if(yr.debug(`execute() [name:${t.name}]`),t.executedAt)throw new Error("task already being executed");t.executedAt=Date.now();try{const e=await t.task();t.resolve(e)}catch(e){t.reject(e)}}}Jc=pn.AwaitQueue=mM;function fM(s,t){const e=new Error(t);return e.name=s,e}class Oa extends P{constructor(t){super(t),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Oa):this.stack=new Error(t).stack}}class Pt extends P{constructor(t){super(t),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Pt):this.stack=new Error(t).stack}}class oi extends P{constructor(t){super(t),this.name="TransportConnectionError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Pt):this.stack=new Error(t).stack}}class gM extends P{constructor(t){super(t),this.name="DataChannelRequestError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Pt):this.stack=new Error(t).stack}}const ff=s=>new Promise(t=>setTimeout(t,s));async function au(s,t){return new Promise(async(e,r)=>{const{strategy:n,maxRetryCount:i,delayTime:a}={strategy:"linear",maxRetryCount:3,delayTime:10,...t};let c=0,d,l=!1;const h=m=>{l=!0,r(m)};for(;c<i;){try{const m=await s(c,h);return e(m)}catch(m){if(d=m,l)break;if(c<i)n==="linear"?await ff(a*(c+1)):n==="exponential"&&await ff(a*(c+Math.max(0,c-1)));else break}c+=1}return r(d)})}function vM(s){return s.map(t=>({channels:t.channels,clockRate:t.clockRate,mimeType:t.mimeType,sdpFmtpLine:t.sdpFmtpLine}))}function TM(s){return s.map(t=>({uri:t.uri}))}function zc(s){return{codecs:vM(s.codecs),headerExtensions:TM(s.headerExtensions)}}function yM(s){const t=RTCRtpReceiver.getCapabilities("audio"),e=RTCRtpReceiver.getCapabilities("video"),r=RTCRtpSender.getCapabilities("audio"),n=RTCRtpSender.getCapabilities("video");s&&(e.codecs=e.codecs.filter(({mimeType:d})=>s===d),n.codecs=n.codecs.filter(({mimeType:d})=>s===d));const i={audio:zc(t),video:zc(e)};return{sender:{audio:zc(r),video:zc(n)},receiver:i}}class SM{constructor(t,e){g(this,vt,void 0);p(this,"events");p(this,"sfuType");v(this,vt,t),this.sfuType=e,this.events=e===bt.CF?us:Kt}async joinRoom(t,e,r,n=!1,i=null){const a={roomUuid:t,displayName:e,prejoined:n,capabilities:r};return i&&(a.location=i),(await o(this,vt).sendMessagePromiseWithTimeout({event:this.events.joinRoom,protobuf:Sw.toBinary(a),timeout:5e3})).payload}async connectTransport(t){const e=(await o(this,vt).sendMessagePromise(this.events.createWebRTCTransport,Yb.toBinary(t))).payload,{transportId:r,description:n,producerIds:i}=sm.fromBinary(e),a={sdp:n==null?void 0:n.sdp,type:n.type};return{transportId:r,answer:a,producerIds:i}}async produce(t){var i,a;const e=(await o(this,vt).sendMessagePromise(this.events.produce,Mw.toBinary(t))).payload,r=mP.fromBinary(e);return{answer:{sdp:(i=r==null?void 0:r.description)==null?void 0:i.sdp,type:(a=r==null?void 0:r.description)==null?void 0:a.type},producerId:r.producerId}}async consume(t){if(this.sfuType===bt.HIVE)throw new Error("Hive does not support socket consumer operations");const e=(await o(this,vt).sendMessagePromise(this.events.consume,Iw.toBinary(t))).payload,{consumerIdsMap:{map:r},description:n}=hP.fromBinary(e);return{consumerStateMap:r,sessionDescription:n}}async closeProducer(t){const e=(await o(this,vt).sendMessagePromise(this.events.closeProducer,Uw.toBinary(t))).payload,{description:r}=EP.fromBinary(e);return r}async closeConsumer(t){if(this.sfuType===bt.HIVE)throw new Error("Hive does not support socket consumer operations");return(await o(this,vt).sendMessagePromise(this.events.closeConsumer,Bw.toBinary(t))).payload}async hostControlForPeer(t,e){const r={audio:e==="audio",screeShare:!1,video:e==="video",participantId:t},n=(await o(this,vt).sendMessagePromise(this.events.hostControlPeer,Jw.toBinary(r))).payload;if(!n)return!1;const{status:i}=IP.fromBinary(n);return i==="success"}async hostControlForAll(t){const e={audio:t==="audio",screenShare:!1,video:t==="video"},r=(await o(this,vt).sendMessagePromise(this.events.hostControlAllPeers,zw.toBinary(e))).payload;if(!r)return!1;const{status:n}=MP.fromBinary(r);return n==="success"}async kickAll(){const t={propagateKickAcrossRooms:!1},e=(await o(this,vt).sendMessagePromise(this.events.kickAll,om.toBinary(t))).payload;if(!e)return!1;const{status:r}=RP.fromBinary(e);return r==="success"}async kickPeer(t){const e=(await o(this,vt).sendMessagePromise(this.events.kickPeer,Hw.toBinary(t))).payload;if(!e)return!1;const{status:r}=PP.fromBinary(e);return r==="success"}async changeDisplayName(t){const e=(await o(this,vt).sendMessagePromise(this.events.changeDisplayName,Gw.toBinary(t))).payload;if(!e)return!1;const{status:r}=OP.fromBinary(e);return r==="success"}async notifySelfJoinComplete(){const t={},e=(await o(this,vt).sendMessagePromise(this.events.selfJoinComplete,_w.toBinary(t))).payload;return Pl.fromBinary(e)}}vt=new WeakMap;class Na extends re.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(t,...e){const r=this.listenerCount(t);try{return this.emit(t,...e)}catch(n){return u.error(`EnhancedEventEmitter:: safeEmit() | event listener ${t} threw an error`,{error:n}),Boolean(r)}}async safeEmitAsPromise(t,...e){const r={}.EVENT_PROMISE_TIMEOUT?parseInt({}.EVENT_PROMISE_TIMEOUT,10):1e4;return this.safeEmitAsPromiseWithTimeout(t,r,...e)}async safeEmitAsPromiseWithTimeout(t,e,...r){return new Promise((n,i)=>{setTimeout(i,e,"event request timeout");try{this.emit(t.toString(),...r,n,i)}catch(a){u.error(`EnhancedEventEmitter:: safeEmitAsPromise() | event listener for event ${t.toString()} threw an error [event:%s]:%o`,{error:a}),i(a)}})}}class ou extends Na{constructor(){super();p(this,"_sendWebStream",new MediaStream);p(this,"_sendScreenShareStream",new MediaStream);p(this,"_direction");p(this,"pc");p(this,"_transportReady",!1);p(this,"_mapMidTransceiver",new Map);p(this,"_enableHighBitrate",!1);p(this,"_enableStereo",!1);this._mapMidTransceiver=new Map,this._enableHighBitrate=!1}get midTransceiverMap(){return this._mapMidTransceiver}close(){if(u.debug(`${this.name}::close()`),this.pc)try{this.pc.close()}catch(e){u.error(`${this.name}::pc.close()`,{error:e})}}async restartIce(){u.debug(`${this.name}::restartIce()`);const e=await this.pc.createOffer({iceRestart:!0});return u.debug(`${this.name}::restartIce() | calling pc.setLocalDescription() [offer:${JSON.stringify(e)}]`),{offerSdp:e,callback:async n=>{u.info(`${this.name}::restartIce() | calling pc.setRemoteDescription() [answer:${JSON.stringify(n)}]`),await this.pc.setRemoteDescription(n)}}}init({direction:e,iceServers:r,iceTransportPolicy:n,additionalSettings:i,proprietaryConstraints:a,onTrackHandler:c}){u.debug("HandlerInterface::init()"),this._direction=e,this.pc=new RTCPeerConnection({iceServers:r||[],iceTransportPolicy:n||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...i},a),c&&this.pc.addEventListener("track",d=>{c(d)}),this._addEventListeners()}async connect(){const e=this.pc.createDataChannel("dyte"),r=await this.pc.createOffer();return await this.pc.setLocalDescription(r),u.info(`connect offer: ${JSON.stringify(r)}`),{offerSdp:r,callback:async i=>{u.debug(`${this.name}::connect() | calling pc.setRemoteDescription() [answer:${JSON.stringify(i)}]`),await this.pc.setRemoteDescription(i),e.close()}}}async getTransportStats(){return this.pc.getStats()}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}async getReceiverStats(e){this._assertRecvDirection();const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");return r.receiver.getStats()}async stopSending(e){this._assertSendDirection(),u.debug(`stopSending() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.sender.replaceTrack(null),this.pc.removeTrack(r.sender),r.direction="inactive";const n=await this.pc.createOffer();return u.debug(`stopSending() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),await this.pc.setLocalDescription(n),{offerSdp:n,callback:async a=>{u.debug(`stopSending() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this.pc.setRemoteDescription(a),this.midTransceiverMap.delete(e)}}}async replaceTrack(e,r){this._assertSendDirection(),r?u.debug(`replaceTrack() [localId:${e}, track.id:${r.id}]`):u.debug(`replaceTrack() [localId:${e}, no track]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");await n.sender.replaceTrack(r)}async setMaxSpatialLayer(e,r){this._assertSendDirection(),u.debug(`setMaxSpatialLayer() [localId:${e}, spatialLayer:${r}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters();i.encodings.forEach((a,c)=>{c<=r?a.active=!0:a.active=!1}),await n.sender.setParameters(i)}async setRtpEncodingParameters(e,r){this._assertSendDirection(),u.debug(`setRtpEncodingParameters() [localId:${e}, params:${JSON.stringify(r)}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters();i.encodings.forEach((a,c)=>{i.encodings[c]={...a,...r}}),await n.sender.setParameters(i)}getSenderStats(e){this._assertSendDirection();const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");return r.sender.getStats()}_addEventListeners(){this.pc.addEventListener("icecandidate",e=>{e.candidate&&this.emit("@icecandidate",{candidate:e.candidate})}),this.pc.addEventListener("iceconnectionstatechange",()=>{switch(this.pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected"),this._transportReady=!0;break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break;default:u.warn("unknown state");break}}),this.pc.addEventListener("negotiationneeded",()=>{this.emit("@negotiationneeded",{}),u.debug("negotiationneeded")}),this.pc.addEventListener("icegatheringstatechange",()=>{switch(this.pc.iceGatheringState){case"gathering":u.debug("icegatheringstatechange | gathering"),this.emit("@icegatheringstatechange","gathering");break;case"complete":u.debug("icegatheringstatechange | complete"),this.emit("@icegatheringstatechange","complete");break;default:u.warn("unknown state");break}}),this.pc.addEventListener("icecandidateerror",e=>{u.warn("icecandidateerror",{error:{code:e.errorCode,message:e.errorText}})}),this.pc.addEventListener("datachannel",e=>{u.info("data channel created: ",{rtcChannel:{label:e.channel.label}});const{channel:r}=e;r.onopen=()=>{u.info("data channel open: ",{rtcChannel:{label:e.channel.label}}),this.safeEmit("dc_open",e.channel)},r.onclose=()=>{u.warn("data channel closed: ",{rtcChannel:{label:e.channel.label}})},r.onerror=()=>{u.error("data channel error: ",{rtcChannel:{label:e.channel.label}})}}),this.addCustomEventListeners()}addCustomEventListeners(){}}class cu extends ou{static createFactory(){return()=>new cu}get name(){return"Chrome74"}init({direction:t,iceServers:e,iceTransportPolicy:r,additionalSettings:n,proprietaryConstraints:i,onTrackHandler:a}){this._direction=t,this.pc=new RTCPeerConnection({iceServers:e||[],iceTransportPolicy:r||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...n},i),a&&this.pc.addEventListener("track",c=>{a(c)}),this._addEventListeners()}async send({track:t,encodings:e,codecOptions:r,screenShare:n}){this._assertSendDirection();const i=this.pc.addTransceiver(t,{direction:"sendonly",streams:[n?this._sendScreenShareStream:this._sendWebStream],sendEncodings:e});if(!navigator.isReactNative){u.debug("creating new transceiver");const d=RTCRtpSender.getCapabilities(typeof t=="string"?t:t.kind);u.info(`senders available params: ${JSON.stringify(d)}`);const l=[];r&&r.length&&r.forEach(h=>{var f;const m=d.codecs.find(y=>y.mimeType.includes(h.name));if(h.parameters){u.debug(`codecOption.parameters:${JSON.stringify(h.parameters)}`);const y=((f=m.sdpFmtpLine)==null?void 0:f.split(";"))||[];y.push(...h.parameters);const _=Array.from(new Set(y).values());m.sdpFmtpLine=_.join(";")}l.push(m)}),u.info(`selected codecs: ${JSON.stringify(l)}`),i.setCodecPreferences(l)}const a=await this.pc.createOffer();if(await this.pc.setLocalDescription(a),r&&r.findIndex(({name:d})=>d==="opus")>=0){const d=this._enableStereo,l=this._enableHighBitrate?d?128e3:64e3:d?64e3:32e3;a.sdp=a.sdp.replace("minptime=10;useinbandfec=1",`minptime=10;useinbandfec=1;usedtx=1${d?"":";stereo=1;sprop-stereo=1"};maxaveragebitrate=${l}`),a.sdp+=`a=rtcp-fb:111 nack\r
`}this.midTransceiverMap.set(i.mid,i);const c=async d=>(u.debug(`send() | calling pc.setRemoteDescription() [answer:${JSON.stringify(d)}]`),await this.pc.setRemoteDescription(d),i.mid);return u.debug(`send() | calling pc.setLocalDescription() [offer: ${JSON.stringify(a,void 0,2)}]`),{offerSdp:a,callback:c,sender:i.sender,mid:i.mid}}addCustomEventListeners(){this.pc.addEventListener("datachannel",t=>{const{channel:e}=t;e.onmessage=r=>{this.safeEmit("datachannel",t.channel,String.fromCharCode(...new Uint8Array(r.data)))}})}}var gf={},Yc={},EM={get exports(){return Yc},set exports(s){Yc=s}},vf=EM.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(s){return s.encoding?"rtpmap:%d %s/%s/%s":s.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(s){return s.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(s){return s.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(s){return"extmap:%d"+(s.direction?"/%s":"%v")+(s["encrypt-uri"]?" %s":"%v")+" %s"+(s.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(s){return s.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(s){var t="candidate:%s %d %s %d %s %d typ %s";return t+=s.raddr!=null?" raddr %s rport %d":"%v%v",t+=s.tcptype!=null?" tcptype %s":"%v",s.generation!=null&&(t+=" generation %d"),t+=s["network-id"]!=null?" network-id %d":"%v",t+=s["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(s){var t="ssrc:%d";return s.attribute!=null&&(t+=" %s",s.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(s){return s.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(s){return s.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(s){return"imageattr:%s %s %s"+(s.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(s){return"simulcast:%s %s"+(s.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(s){return"ts-refclk:%s"+(s.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(s){var t="mediaclk:";return t+=s.id!=null?"id=%s %s":"%v%s",t+=s.mediaClockValue!=null?"=%s":"",t+=s.rateNumerator!=null?" rate=%s":"",t+=s.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(vf).forEach(function(s){var t=vf[s];t.forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})}),function(s){var t=function(c){return String(Number(c))===c?Number(c):c},e=function(c,d,l,h){if(h&&!l)d[h]=t(c[1]);else for(var m=0;m<l.length;m+=1)c[m+1]!=null&&(d[l[m]]=t(c[m+1]))},r=function(c,d,l){var h=c.name&&c.names;c.push&&!d[c.push]?d[c.push]=[]:h&&!d[c.name]&&(d[c.name]={});var m=c.push?{}:h?d[c.name]:d;e(l.match(c.reg),m,c.names,c.name),c.push&&d[c.push].push(m)},n=Yc,i=RegExp.prototype.test.bind(/^([a-z])=(.*)/);s.parse=function(c){var d={},l=[],h=d;return c.split(/(\r\n|\r|\n)/).filter(i).forEach(function(m){var f=m[0],y=m.slice(2);f==="m"&&(l.push({rtp:[],fmtp:[]}),h=l[l.length-1]);for(var _=0;_<(n[f]||[]).length;_+=1){var b=n[f][_];if(b.reg.test(y))return r(b,h,y)}}),d.media=l,d};var a=function(c,d){var l=d.split(/=(.+)/,2);return l.length===2?c[l[0]]=t(l[1]):l.length===1&&d.length>1&&(c[l[0]]=void 0),c};s.parseParams=function(c){return c.split(/;\s?/).reduce(a,{})},s.parseFmtpConfig=s.parseParams,s.parsePayloads=function(c){return c.toString().split(" ").map(Number)},s.parseRemoteCandidates=function(c){for(var d=[],l=c.split(" ").map(t),h=0;h<l.length;h+=3)d.push({component:l[h],ip:l[h+1],port:l[h+2]});return d},s.parseImageAttributes=function(c){return c.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(a,{})})},s.parseSimulcastStreamList=function(c){return c.split(";").map(function(d){return d.split(",").map(function(l){var h,m=!1;return l[0]!=="~"?h=t(l):(h=t(l.substring(1,l.length)),m=!0),{scid:h,paused:m}})})}}(gf);var du=Yc,_M=/%[sdv%]/g,bM=function(s){var t=1,e=arguments,r=e.length;return s.replace(_M,function(n){if(t>=r)return n;var i=e[t];switch(t+=1,n){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}})},La=function(s,t,e){var r=t.format instanceof Function?t.format(t.push?e:e[t.name]):t.format,n=[s+"="+r];if(t.names)for(var i=0;i<t.names.length;i+=1){var a=t.names[i];t.name?n.push(e[t.name][a]):n.push(e[t.names[i]])}else n.push(e[t.name]);return bM.apply(null,n)},wM=["v","o","s","i","u","e","p","c","b","t","r","z","a"],PM=["i","c","b","a"],CM=function(s,t){t=t||{},s.version==null&&(s.version=0),s.name==null&&(s.name=" "),s.media.forEach(function(i){i.payloads==null&&(i.payloads="")});var e=t.outerOrder||wM,r=t.innerOrder||PM,n=[];return e.forEach(function(i){du[i].forEach(function(a){a.name in s&&s[a.name]!=null?n.push(La(i,a,s)):a.push in s&&s[a.push]!=null&&s[a.push].forEach(function(c){n.push(La(i,a,c))})})}),s.media.forEach(function(i){n.push(La("m",du.m[0],i)),r.forEach(function(a){du[a].forEach(function(c){c.name in i&&i[c.name]!=null?n.push(La(a,c,i)):c.push in i&&i[c.push]!=null&&i[c.push].forEach(function(d){n.push(La(a,c,d))})})})}),n.join(`\r
`)+`\r
`},mn=gf,RM=CM,Tf=RM,lu=mn.parse;mn.parseParams,mn.parseFmtpConfig,mn.parsePayloads,mn.parseRemoteCandidates,mn.parseImageAttributes,mn.parseSimulcastStreamList;class Qc extends ou{constructor(e){super();p(this,"supportsSendEncodings",!1);this.supportsSendEncodings=e.supportsSendEncodings}static createFactory(e){return()=>new Qc(e)}get name(){return"Firefox60"}async send({track:e,encodings:r,codecOptions:n,screenShare:i}){this._assertSendDirection();const a=this.supportsSendEncodings&&r!==void 0?{sendEncodings:r}:{},c=this.pc.addTransceiver(e,{direction:"sendonly",streams:[i?this._sendScreenShareStream:this._sendWebStream],...a});if(!this.supportsSendEncodings&&r){r.reverse();const m=c.sender.getParameters();m.encodings=r,await c.sender.setParameters(m)}const d=(m,f)=>{var q;const y=lu(m),_=y.media[y.media.length-1],b=_.rtp.filter(F=>f.some(X=>X.name===F.codec)),I=_.fmtp.filter(F=>b.some(X=>X.payload===F.payload)),L=(q=_.rtcpFb)==null?void 0:q.filter(F=>b.some(X=>X.payload===F.payload)),B=b.map(F=>F.payload);return y.media[y.media.length-1].rtp=b,y.media[y.media.length-1].fmtp=I,y.media[y.media.length-1].rtcpFb=L,y.media[y.media.length-1].payloads=B.join(" "),Tf(y)},l=await this.pc.createOffer();if(l.sdp=d(l.sdp,n),u.debug(`send() | calling pc.setLocalDescription() [offer:${JSON.stringify(l)}]`),await this.pc.setLocalDescription(l),e==="audio"||e.kind==="audio"){const m=this._enableStereo,f=this._enableHighBitrate?m?128e3:64e3:m?64e3:32e3;l.sdp=l.sdp.replace("minptime=10;useinbandfec=1",`minptime=10;useinbandfec=1;usedtx=1${this.supportsSendEncodings?"":`${m?"":";stereo=1;sprop-stereo=1"};maxaveragebitrate=${f}`}`)}return this.midTransceiverMap.set(c.mid,c),{offerSdp:l,callback:async m=>(u.debug(`send() | calling pc.setRemoteDescription() [answer:${JSON.stringify(m)}]`),await this.pc.setRemoteDescription(m),c.mid),sender:c.sender,mid:c.mid}}async setMaxSpatialLayer(e,r){this._assertSendDirection(),u.debug(`setMaxSpatialLayer() [localId:${e}, spatialLayer:${r}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters(),a=i.encodings.length-1-r;i.encodings.forEach((c,d)=>{d>=a?c.active=!0:c.active=!1}),await n.sender.setParameters(i)}addCustomEventListeners(){this.pc.addEventListener("datachannel",e=>{const{channel:r}=e;r.onmessage=async n=>{const i=await n.data.arrayBuffer();this.safeEmit("datachannel",e.channel,String.fromCharCode(...new Uint8Array(i)))}})}}class uu extends ou{static createFactory(){return()=>new uu}get name(){return"Chrome74"}async send({track:t,encodings:e,codecOptions:r,screenShare:n}){this._assertSendDirection(),u.debug("Safari12::creating new transceiver");const i=this.pc.addTransceiver(t,{direction:"sendonly",streams:[n?this._sendScreenShareStream:this._sendWebStream],sendEncodings:e}),a=RTCRtpSender.getCapabilities(typeof t=="string"?t:t.kind);u.info(`Safari12::senders available params: ${JSON.stringify(a)}`);const c=[];r&&r.length>0&&r.forEach(h=>{var f;const m=a.codecs.find(y=>y.mimeType.includes(h.name));if(h.parameters){u.info(`Safari12::codecOption.parameters:, ${JSON.stringify(h.parameters)}`);const y=((f=m.sdpFmtpLine)==null?void 0:f.split(";"))||[];y.push(...h.parameters);const _=[...new Set(y).values()];m.sdpFmtpLine=_.join(";")}c.push(m)}),u.info(`Safari12::selected codecs: ${JSON.stringify(c)}`),i.setCodecPreferences(c);const d=await this.pc.createOffer();if(await this.pc.setLocalDescription(d),t==="audio"||t.kind==="audio"){const h=this._enableStereo,m=this._enableHighBitrate?h?128e3:64e3:h?64e3:32e3;d.sdp=d.sdp.replace("minptime=10;useinbandfec=1",`minptime=10;useinbandfec=1;usedtx=1${h?"":";stereo=1;sprop-stereo=1"};maxaveragebitrate=${m}`)}return this.midTransceiverMap.set(i.mid,i),{offerSdp:d,callback:async h=>(u.debug(`Safari12::send() | calling pc.setRemoteDescription() [answer:${JSON.stringify(h)}]`),await this.pc.setRemoteDescription(h),i.mid),sender:i.sender,mid:i.mid}}addCustomEventListeners(){this.pc.ondatachannel=t=>{const{channel:e}=t;e.onmessage=async r=>{const n=String.fromCharCode(...new Uint8Array(r.data));this.safeEmit("datachannel",t.channel,n)}}}}function kM(s,t){return typeof s=="undefined"?t:typeof window!="undefined"&&Object.getOwnPropertyDescriptor(window,"structuredClone")?structuredClone(s):JSON.parse(JSON.stringify(s))}class IM extends Na{constructor(e){var r,n;super();g(this,Os);g(this,co);g(this,Pd);g(this,Cd);p(this,"rtpReceiver");p(this,"id");p(this,"localId");p(this,"producerId");p(this,"producingTransportId");p(this,"mimeType");p(this,"track");p(this,"peerId");p(this,"appData");p(this,"transceiver");p(this,"closeTranscieverOnClose");g(this,oo,void 0);g(this,Nn,void 0);g(this,Ds,void 0);this.id=e.id,this.localId=e.localId,v(this,oo,e.handler),this.appData=e.appData,this.peerId=e.producingPeerId,this.producingTransportId=e.producingTransportId,v(this,Ds,!1),this.producerId=e.producerId,this.track=e.track,v(this,Nn,(r=e.paused)!=null?r:!1),this.mimeType=e.mimeType,this.transceiver=e.transceiver,this.closeTranscieverOnClose=(n=e.closeTranscieverOnClose)!=null?n:!1,this.rtpReceiver=e.rtpReceiver,$(this,Pd,vg).call(this)}get closed(){return o(this,Ds)}get kind(){return this.track.kind}get paused(){return o(this,Nn)}close(e){o(this,Ds)||(u.debug(`Consumer::close() ${e?`with reason ${e}`:""}`,o(this,Os,Kr)),v(this,Ds,!0),this.closeTranscieverOnClose&&($(this,Cd,Tg).call(this),this.transceiver.stop()),this.safeEmit("close",e))}async getStats(){if(o(this,Ds))throw new Pt("closed");return o(this,oo).getReceiverStats(this.localId)}pause(){if(u.debug("consumer::pause()",o(this,Os,Kr)),o(this,Ds)){u.error("consumer::pause() | Consumer closed",o(this,Os,Kr));return}v(this,Nn,!0),this.track.enabled=!1,this.safeEmit("pause")}resume(){if(u.debug("consumer::resume()",o(this,Os,Kr)),o(this,Ds)){u.error("Consumer::resume() | Consumer closed",o(this,Os,Kr));return}v(this,Nn,!1),this.track.enabled=!0,this.safeEmit("resume")}}oo=new WeakMap,Nn=new WeakMap,Ds=new WeakMap,Os=new WeakSet,Kr=function(){return{consumer:{id:this.id,appData:this.appData,peerId:this.peerId,kind:this.kind}}},co=new WeakSet,Nu=function(){u.debug('Consumer::track "ended" event',o(this,Os,Kr)),this.safeEmit("trackended")},Pd=new WeakSet,vg=function(){this.track.addEventListener("ended",$(this,co,Nu).bind(this))},Cd=new WeakSet,Tg=function(){try{this.track.removeEventListener("ended",$(this,co,Nu)),this.track.stop()}catch(e){u.error("Consumer::destroyTrack()",{...o(this,Os,Kr),error:e})}};class AM extends Na{constructor(e){var r,n;super();g(this,Gt);p(this,"id");p(this,"localId");g(this,ys,void 0);p(this,"kind");p(this,"appData");p(this,"rtpSender");g(this,Ki,void 0);g(this,zi,void 0);g(this,Ln,void 0);g(this,rs,!1);g(this,it,void 0);g(this,Ur,void 0);g(this,Yi,void 0);this.id=e.id,this.localId=e.localId,v(this,it,e.track),this.kind=(r=e.track)==null?void 0:r.kind,v(this,Ur,e.disableTrackOnPause?!((n=e.track)!=null&&n.enabled):!1),v(this,Yi,void 0),v(this,Ki,e.stopTracks),v(this,zi,e.disableTrackOnPause),v(this,Ln,e.zeroRtpOnPause),this.appData=e.appData||{},this._onTrackEnded=this._onTrackEnded.bind(this),v(this,ys,e.handler),this.rtpSender=e.rtpSender,this._handleTrack()}get closed(){return o(this,rs)}get track(){return o(this,it)}get paused(){return o(this,Ur)}get maxSpatialLayer(){return o(this,Yi)}async close(e){if(o(this,rs))return;if(u.debug(`Producer::close() ${e?`with reason ${e}`:""}`,o(this,Gt,_s)),v(this,rs,!0),this._destroyTrack(),e===pu){this.safeEmit("close");return}const{offerSdp:r,callback:n}=await o(this,ys).stopSending(this.localId),{answer:i}=await this.safeEmitAsPromise("close",{offer:r,reason:e});n(i)}async getStats(){if(o(this,rs))throw new Pt("closed");return o(this,ys).getSenderStats(this.localId)}pause(){u.debug("Producer::pause()",o(this,Gt,_s)),o(this,rs)&&u.error("Producer::pause() | Producer closed",o(this,Gt,_s)),v(this,Ur,!0),o(this,it)&&o(this,zi)&&(o(this,it).enabled=!1),o(this,Ln)&&o(this,ys).replaceTrack(this.localId,null),this.emit("pause")}resume(){if(u.debug("Producer::resume()",o(this,Gt,_s)),o(this,rs)){u.error("Producer::resume() | Producer closed",o(this,Gt,_s));return}v(this,Ur,!1),o(this,it)&&o(this,zi)&&(o(this,it).enabled=!0),o(this,Ln)&&o(this,ys).replaceTrack(this.localId,o(this,it)),this.emit("resume")}async replaceTrack({track:e}){if(u.debug(`Producer::replaceTrack() trackId: ${e==null?void 0:e.id}`,o(this,Gt,_s)),o(this,rs)){if(e&&o(this,Ki))try{e.stop()}catch(r){u.error("Producer::replaceTrack",{...o(this,Gt,_s),error:r})}throw new Pt("closed")}else if(e&&e.readyState==="ended")throw new Pt("track ended");if(e===o(this,it)){u.debug(`replaceTrack() | same track, ignored trackId: ${e.id}`,o(this,Gt,_s));return}(!o(this,Ln)||!o(this,Ur))&&await o(this,ys).replaceTrack(this.localId,e),this._destroyTrack(),v(this,it,e),this._handleTrack()}async setMaxSpatialLayer(e){if(o(this,rs))throw new Pt("closed");if(this.kind!=="video")throw new Oa("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");await o(this,ys).setMaxSpatialLayer(this.localId,e),v(this,Yi,e)}async setRtpEncodingParameters(e){if(o(this,rs))throw new Pt("closed");if(typeof e!="object")throw new TypeError("invalid params");await o(this,ys).setRtpEncodingParameters(this.localId,e)}_onTrackEnded(){u.debug(`Producer::track "ended" event trackId: ${this.track.id}`,o(this,Gt,_s)),this.safeEmit("trackended",this.track.id)}_handleTrack(){o(this,it)&&o(this,it).addEventListener("ended",this._onTrackEnded)}_destroyTrack(){var e;if(o(this,it))try{o(this,it).removeEventListener("ended",this._onTrackEnded),o(this,Ki)&&o(this,it).stop()}catch(r){u.error(`Producer::_destroyTrack trackId: ${(e=this.track)==null?void 0:e.id}`,{...o(this,Gt,_s),error:r})}}}ys=new WeakMap,Ki=new WeakMap,zi=new WeakMap,Ln=new WeakMap,rs=new WeakMap,it=new WeakMap,Ur=new WeakMap,Yi=new WeakMap,Gt=new WeakSet,_s=function(){return{producer:{id:this.id,appData:this.appData,kind:this.kind}}};function yf(s){return typeof s=="object"&&!Array.isArray(s)&&s!==null}function hu(s){return Math.random().toString(36).substring(2,2+s)}const Xc=1;function Sf(s){const t=s;return delete t.payload._bolt,t}function MM(s){return s.payload&&yf(s.payload)}function Ef(s){var t,e;return MM(s)&&(e=(t=s.payload._bolt)==null?void 0:t.id)!=null?e:""}const Qi=class extends re.EventEmitter{constructor(e,r,n){super();p(this,"channel");p(this,"queue");p(this,"serverProtocolVersion");g(this,Fr,new Map);p(this,"respond",(e,r,n=!1)=>{let i;n?i=Qi.createErrorResponse(e,r):i=Qi.createResponse(e,r),this.channel.send(JSON.stringify(i))});p(this,"notify",e=>{const r=Qi.createNotification(e);this.channel.send(JSON.stringify(r))});p(this,"request",async e=>{const r=Qi.createRequest(e),n=new Promise((i,a)=>{const c=1e3*(5+.1*this.queue.size),{id:d}=r.payload._bolt,l={id:d,method:r.type,resolve:h=>{this.queue.delete(d)&&(clearTimeout(l.timer),i(h))},timer:setTimeout(()=>{this.queue.delete(d)&&a(new Error(`request timeout for message id: ${d}`))},c),cancel:h=>{this.queue.delete(d)&&(clearTimeout(l.timer),a(h))}};this.queue.set(d,l)});return this.channel.send(JSON.stringify(r)),n});p(this,"send",e=>{const r=JSON.stringify(e),n=16384;if(r.length>n){const i=n-200,a=Math.ceil(r.length/i),c=[];for(let l=0;l<a;l+=1){const h=l*i,m=(l+1)*i;c.push(r.slice(h,m))}const d=Jn();for(let l=0;l<a;l+=1){const h=c[l],f=JSON.stringify({id:d,count:a,chunkIndex:l,chunk:h});u.debug(`Sending message chunk over dc: ${f}`),this.channel.send(f)}}else u.debug(`Sending message over dc: ${r}`),this.channel.send(r)});p(this,"processMessage",e=>{var n;o(this,Fr).has(e.id)||o(this,Fr).set(e.id,[]);const r=o(this,Fr).get(e.id);if(r[e.chunkIndex]=e,(r==null?void 0:r.length)===e.count&&!r.some(i=>i===void 0)){const i=o(this,Fr).get(e.id),a=i==null?void 0:i.reduce((d,l)=>d+l.chunk,"");o(this,Fr).delete(e.id);const c=JSON.parse(a);if(!c.payload||!yf(c.payload))throw new Error("corrupted incoming message over dc",{cause:{code:"CORRUPT_DC_MESSAGE",values:c}});if(this.processBoltHandshake(c))return;if(this.serverProtocolVersion=(n=c.payload._bolt)==null?void 0:n.version,!this.processResponseMsg(c))return c}});p(this,"processResponseMsg",e=>{const{id:r}=e.payload._bolt,n=this.queue.get(r);return n?(u.debug(`resolving pending request with id: ${r}, complete response: ${JSON.stringify(e)}`),e.type==="error"?n.cancel(Sf(e)):n.resolve(Sf(e)),!0):!1});p(this,"processBoltHandshake",e=>{var r,n;return e.type==="_bolt"||e.type==="handshake"?(this.respond((n=(r=e.payload._bolt)==null?void 0:r.id)!=null?n:hu(8),{type:"_bolt",payload:{message:"pong"}}),!0):!1});this.label=r,this.transportId=n,this.channel=e,this.queue=new Map}};let fn=Qi;Fr=new WeakMap,p(fn,"createRequest",e=>{var r;if((r=e.payload)!=null&&r._bolt)throw new Error("rpc fields are internal values");return{type:e.type,payload:{...e.payload,_bolt:{id:hu(8),type:"REQUEST",version:Xc}}}}),p(fn,"createResponse",(e,r)=>{var n;if((n=r.payload)!=null&&n._bolt)throw new Error("rpc fields are internal values");return{type:r.type,payload:{...r.payload,_bolt:{id:e,type:"RESPONSE",version:Xc}}}}),p(fn,"createNotification",e=>{var r;if((r=e.payload)!=null&&r._bolt)throw new Error("rpc fields are internal values");return{type:e.type,payload:{...e.payload,bolt:{id:hu(8),type:"NOTIFY",version:Xc}}}}),p(fn,"createErrorResponse",(e,r)=>({type:"error",payload:{error:r.message,_bolt:{id:e,type:"RESPONSE",version:Xc}}}));function _f(s){if(Promise.allSettled)return Promise.allSettled(s);const t=s.map(e=>e.then(r=>({status:"fulfilled",value:r})).catch(r=>({status:"rejected",reason:r})));return Promise.all(t)}const pu="transport closed";class DM extends Na{constructor(e,{id:r,direction:n,handlerFactory:i,iceServers:a,iceTransportPolicy:c,proprietaryConstraints:d,additionalSettings:l,appData:h,config:m}){var y,_;super();p(this,"awaitQueue");p(this,"observer");g(this,Xi,void 0);p(this,"id");p(this,"serverId");p(this,"closed",!1);p(this,"direction");p(this,"maxSctpMessageSize");p(this,"handler");p(this,"connectionState","new");p(this,"producers");p(this,"consumers");p(this,"datachannels");p(this,"connected",!1);p(this,"eventsDCReadyPromise");p(this,"eventsDCReadyPromiseResolver");p(this,"eventsDCFailureTimer");p(this,"transportConnectionPromise");p(this,"consumerTrackEvents");p(this,"unknownTracksMap");p(this,"appData");u.debug(`constructor() [id: ${r}, direction: ${n}]`),v(this,Xi,e),this.id=r,this.direction=n;const f=kM(l,{});delete f.iceServers,delete f.iceTransportPolicy,delete f.bundlePolicy,delete f.rtcpMuxPolicy,delete f.sdpSemantics,this.producers=new Map,this.consumers=new Map,this.datachannels=new Map,this.consumerTrackEvents=new Map,this.unknownTracksMap=new Map,this.awaitQueue=new Jc,this.observer=new Na,this.handler=i(),this.handler._enableHighBitrate=(y=m==null?void 0:m.enableHighBitrate)!=null?y:!1,this.handler._enableStereo=(_=m==null?void 0:m.enableStereo)!=null?_:!1,this.handler.init({onTrackHandler:this._ontrack.bind(this),direction:n,iceServers:a,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:d}),this.appData=h||{},this.transportConnectionPromise=new Promise(b=>{this.observer.once("connected",()=>{b(!0)}),this.observer.once("disconnect",()=>{b(!1)}),this.observer.once("close",()=>{b(!1)})}),this.eventsDCReadyPromise=new Promise(b=>{this.eventsDCReadyPromiseResolver=b}),this.handler.on("@connectionstatechange",b=>{b!==this.connectionState&&(u.debug(`connection state changed to ${b}`),this.connectionState=b,b==="connected"&&(this.connected=!0,this.observer.emit("connected")),b==="disconnected"&&(this.connected=!1,this.observer.emit("disconnect")),(b==="failed"||b==="closed")&&(this.connected=!1,this.observer.emit("close")),this.closed||this.safeEmit("connectionstatechange",b))}),this.handler.on("@icecandidate",({candidate:b})=>{this.closed||this.safeEmit("icecandidate",b)}),this.handler.on("dc_open",b=>{let I=this.datachannels.get(b.label);I||(I||(I=new fn(b,b.label,this.serverId),this.datachannels.set(b.label,I)),this.eventsDCFailureTimer=setTimeout(()=>{b.label==="events"&&(this.eventsDCReadyPromiseResolver(!1),this.safeEmit("dc_error",b.label))},5e3))}),this.handler.on("datachannel",(b,I)=>{b.label==="events"&&(this.eventsDCReadyPromiseResolver(!0),this.eventsDCFailureTimer&&clearTimeout(this.eventsDCFailureTimer));const L=this.datachannels.get(b.label);if(!L){u.error("unregistered datachannel for message",{rtcChannel:{label:b.label,message:I}});return}try{const B=JSON.parse(I);u.debug("datachannel message chunk recieved",{dataChannelMessageChunk:{id:B.id,count:B.count,chunkIndex:B.chunkIndex,chunk:B.chunk,transprtId:this.serverId}});const q=L.processMessage(B);if(!q)return;u.debug(`datachannel message with id:${B.id} on transport:${this.serverId}complete - ${JSON.stringify(q)}`),this.emit(`datachannel:${b.label}`,L.label,q)}catch(B){u.error("error parsing message",{error:B})}})}setServerId(e){this.serverId=e}getDatachannel(e){return this.datachannels.get(e)}get isEventsDCReady(){return this.eventsDCReadyPromise}close(){this.closed||(u.debug("Transport close called"),this.connected=!1,this.closed=!0,this.handler.close(),Array.from(this.producers.values()).forEach(e=>{e.close(pu).catch(()=>{})}),this.producers.clear(),Array.from(this.consumers.values()).forEach(e=>{e.close(pu)}),this.consumers.clear(),this.consumerTrackEvents.clear(),this.emit("close"),this.observer.emit("close"))}async getStats(){if(this.closed)throw new Pt("closed");return this.handler.getTransportStats()}async connect(e,r){try{const{producerIds:n}=await this.awaitQueue.push(async()=>{const{offerSdp:i,callback:a}=await this.handler.connect(),{transportId:c,answer:d,producerIds:l}=await e(i);return this.setServerId(c),await a(d),{producerIds:l}});if(n.forEach((i,a)=>{this.createProducerObject({id:i,localId:r[a].mid,track:r[a].track,stopTracks:!0,disableTrackOnPause:!0,zeroRtpOnPause:!1,appData:JSON.parse(r[a].appData||"{}"),handler:this.handler}).catch(c=>{u.error("error creating producer:",c)})}),!await this.transportConnectionPromise)throw new Error("ice connection failed");if(o(this,Xi)===bt.HIVE&&!await this.isEventsDCReady)throw new Error("events datachannel not open")}catch(n){throw u.error("transport failed to connect:",n),n}}async restartIce(){if(u.debug("restartIce()"),this.closed)throw new Pt("closed");return this.handler.restartIce()}async canProduce(e){const{track:r,appData:n}=e;if(r){if(this.direction!=="send")throw new Oa("not a sending Transport");if(r.readyState==="ended")throw new Pt("track ended");if(this.listenerCount("connect")===0&&this.connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(n&&typeof n!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing track");if(!await this.transportConnectionPromise)throw new oi("transport not connected");return!0}async produce(e,r){if(!await this.canProduce(e))throw new Error("Cannot produce");const{track:i,encodings:a,codecOptions:c,stopTracks:d=!0,disableTrackOnPause:l=!0,zeroRtpOnPause:h=!1,appData:m={}}=e;u.debug(`produce() [track:${i.id}]`);const{producerId:f,localId:y,rtpSender:_}=await this.awaitQueue.push(async()=>{const{offerSdp:b,callback:I,sender:L,mid:B}=await this.handler.send({track:i,encodings:a,codecOptions:c,screenShare:m==null?void 0:m.screenShare}),{answer:q,producerId:F}=await r({offer:b,kind:i.kind,paused:l?!i.enabled:!1,appData:{...m||{},mid:B},codecOptions:c,producingTransportId:this.serverId}),X=await I(q);return{producerId:F,localId:X,rtpSender:L}},"producer");return this.createProducerObject({id:f,localId:y,track:i,stopTracks:d,disableTrackOnPause:l,zeroRtpOnPause:h,appData:m,handler:this.handler,rtpSender:_})}async precreateProducers(e){const r=[];for(const{kind:n,options:{encodings:i,codecOptions:a,track:c}}of e){const d=await this.handler.send({track:c,encodings:i,codecOptions:a});r.push({kind:n,result:d})}return r}async createProducerObject(e){const r=new AM(e);return this.producers.set(r.id,r),r.once("close",()=>{this.producers.delete(r.id)}),r}async closeProducer(e){await this.awaitQueue.push(e.close.bind(e),"producer")}async canConsume(){if(this.closed)throw new Pt("closed");if(this.direction!=="recv")throw new Oa("not a receiving transport");if(this.listenerCount("connect")===0&&this.connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(!await this.transportConnectionPromise)throw new oi("transport not connected");return!0}async consume(e,r,n){const i=[];return this.awaitQueue.push(async()=>{const{consumerStates:a,sessionDescription:c}=await r(e);return a.forEach((d,l)=>{i.push(this.createConsumerObjectAndWaitForTrack({...d,producerId:l}))}),c&&n(c),_f(i)},"consumer")}async setRemoteOffer(e){await this.setRemoteDescription(e);const r=await this.handler.pc.createAnswer(),n=lu(r.sdp);return n.media=n.media.map(i=>{if(i.type==="audio"){const a={...i},c=a.fmtp.find(l=>l.payload===111);return c&&(c.config+=";stereo=1;sprop-stereo=1"),a.rtcpFb||(a.rtcpFb=[]),a.rtcpFb.some(l=>l.type==="nack")||a.rtcpFb.push({payload:parseInt(a.payloads,10),type:"nack"}),a}return i}),r.sdp=Tf(n),await this.setLocalDescription(r),r}_ontrack(e){const{track:r,transceiver:n,streams:i}=e;u.info(`track event received [trackId: ${r.id}]`);let a;o(this,Xi)===bt.HIVE?a=`${i[0].id}:${r.kind}`:a=`${n.mid}:${r.kind}`,r.addEventListener("ended",()=>{u.info(`rtc consumer track ended [trackId: ${r.id}]`),this.unknownTracksMap.delete(a)});const c=this.consumerTrackEvents.get(a);c?(c(r,n),this.consumerTrackEvents.delete(a)):(u.warn(`track event handler not found ${a}`),this.unknownTracksMap.set(a,e))}sendErrorOverDC(e,r,n){const i=this.getDatachannel(e);if(!i)throw new Error("datachannel not found",{cause:{code:"DC_NOT_FOUND",values:{label:e}}});i.respond(r,n,!0)}sendResponseOverDC(e,r,n){const i=this.getDatachannel(e);if(!i)throw new Error("datachannel not found",{cause:{code:"DC_NOT_FOUND",values:{label:e}}});i.respond(r,n)}async createConsumerObjectAndWaitForTrack(e){const{consumerId:r,producerId:n,producingPeerId:i,producingTransportId:a,streamId:c,paused:d,screenShare:l,appData:h,kind:m,mimeType:f}=e,y=`${c}:${m}`,_={...e,name:"consumer creation task error",message:"consumer creation failed"};return new Promise(async(b,I)=>{const L=setTimeout(()=>{this.consumerTrackEvents.delete(y),_.isTimedout=!0,I(_)},5e3),B=(F,X)=>{try{if(F.readyState==="ended")clearTimeout(L),I(_);else{const ne=F;ne.enabled=!0,this.handler.midTransceiverMap.set(X.mid,X);const ve=new IM({id:r,localId:X.mid,transceiver:X,track:ne,paused:d,producerId:n,producingPeerId:i,producingTransportId:a,handler:this.handler,appData:{...h,screenShare:l,peerId:i},rtpReceiver:X.receiver,mimeType:f});this.consumers.set(r,ve),ve.once("close",()=>{this.consumers.delete(ve.id),this.handler.midTransceiverMap.delete(X.mid)}),u.info("consumer created for ",{consumer:{id:r,kind:m,appData:{screenShare:l},peerId:i,producerId:n}}),this.observer.emit("newconsumer",ve),clearTimeout(L),b(ve)}}catch(ne){u.warn("error while creating consumer:",ne),clearTimeout(L),I(_)}},q=this.unknownTracksMap.get(y);q?(this.unknownTracksMap.delete(y),B(q.track,q.transceiver)):this.consumerTrackEvents.set(y,B)})}async setRemoteDescription(e){await this.handler.pc.setRemoteDescription(e)}async setLocalDescription(e){u.debug(`${this.direction}() {transportId: ${this.serverId}} | calling pc.setLocalDescription() [offer:${JSON.stringify(e)}]`),await this.handler.pc.setLocalDescription(e)}async retryFailedConsumerCreationTasks(e){return _f(e.map(async r=>au(async n=>(n>0&&u.warn(`retrying failed consumer creation task: ${JSON.stringify(r)}`),this.createConsumerObjectAndWaitForTrack({...r})))))}async sendDataChannelMessage(e,r){const n=this.getDatachannel(e);if(!n)throw fM("DC_NOT_READY",`${e} datachannel not ready`);const i=(await n.request(r)).payload;return u.info(`sendDataChannelMessage::response ${JSON.stringify(i)}`),i}}Xi=new WeakMap;function OM(){if(typeof navigator=="object"&&navigator.product==="ReactNative"){if(typeof RTCPeerConnection=="undefined"){u.warn("Device::this._detectDevice() | unsupported ReactNative without RTCPeerConnection");return}return u.debug("Device::this._detectDevice() | ReactNative handler chosen"),"Chrome74"}if(typeof navigator=="object"&&typeof navigator.userAgent=="string"){const s=navigator.userAgent,t=Ap.getParser(s),e=t.getEngine();if(t.satisfies({chrome:">=74",chromium:">=74","microsoft edge":">=88"}))return"Chrome74";if(t.satisfies({chrome:">=55",chromium:">=55"}))return;if(t.satisfies({firefox:">=110"}))return"Firefox110";if(t.satisfies({firefox:">=60"}))return"Firefox60";if(t.satisfies({ios:{OS:">=14.3",firefox:">=30.0"}})||t.satisfies({safari:">=12.0"})&&typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(t.satisfies({safari:">=11"})||t.satisfies({"microsoft edge":">=11"})&&t.satisfies({"microsoft edge":"<=18"}))return;if(e.name&&e.name.toLowerCase()==="blink"){const r=s.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);return r?Number(r[1])>=74?"Chrome74":void 0:"Chrome74"}if(e.name.toLowerCase()==="webkit"&&t.getOS().name.toLowerCase()==="ios")return typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection")?"Safari12":void 0;u.warn("Device::this._detectDevice() | browser not supported");return}u.warn("Device::this._detectDevice() | unknown device")}class NM{constructor(t,{handlerName:e,handlerFactory:r}={}){p(this,"handlerFactory");g(this,lo,void 0);if(u.debug("constructor()"),v(this,lo,t),e&&r)throw new TypeError("just one of handlerName or handlerInterface can be given");if(r)this.handlerFactory=r;else{if(e)u.debug(`Device::constructor() | handler given: ${e}`);else if(e=OM(),e)u.debug(`Device::constructor() | detected handler: ${e}`);else throw new Error("device not supported");switch(e){case"Chrome74":this.handlerFactory=cu.createFactory();break;case"Safari12":this.handlerFactory=uu.createFactory();break;case"Firefox60":this.handlerFactory=Qc.createFactory({supportsSendEncodings:!1});break;case"Firefox110":this.handlerFactory=Qc.createFactory({supportsSendEncodings:!0});break;default:throw new TypeError(`unknown handlerName "${e}"`)}}}createTransport(t){const e=Jn();return new DM(o(this,lo),{id:e,...t,handlerFactory:this.handlerFactory})}}lo=new WeakMap;const LM=2e3;class xM extends re.EventEmitter{constructor(e,r,n){super();g(this,ra);g(this,ho);g(this,Rd);g(this,kd);g(this,Id);g(this,Ad);g(this,Md);g(this,po);g(this,mo);g(this,rr,void 0);g(this,Zi,void 0);g(this,It,void 0);g(this,At,void 0);g(this,xn,void 0);g(this,ea,void 0);g(this,ta,void 0);g(this,sa,{transportFailureCount:{send:0,recv:0},lastConnectionTime:0});g(this,Vn,void 0);g(this,Br,"all");g(this,uo,void 0);switch(v(this,rr,e),v(this,xn,r),v(this,uo,n),v(this,Zi,new NM(n)),v(this,ea,new SM(r,n)),n){case bt.CF:{v(this,ta,us);break}case bt.HIVE:default:{v(this,ta,Kt);break}}o(this,ra,jd).mediaState={send:{state:vr.NEW,reconnected:!1},recv:{state:vr.NEW,reconnected:!1}},ee.hasFeature(se.FORCE_RELAY)&&v(this,Br,"relay"),$(this,ho,Lu).call(this)}get socket(){return o(this,xn)}get socketHandler(){return o(this,ea)}get sendTransport(){return o(this,It)}get recvTransport(){return o(this,At)}get events(){return o(this,ta)}get nodeType(){return o(this,uo)}async createTransports(e){var a,c,d,l,h,m,f,y;ee.hasFeature(se.FORCE_RELAY)&&(u.info("ICE Transport Policy set to relay"),v(this,Br,"relay"));const n=await nt().getICEServers().catch(_=>(u.warn(`failed to get iceservers from server: ${_.message}`),[])),i=[];if(e.send){const _=$(this,kd,Sg).call(this,{iceServers:n,additionalSettings:{encodedInsertableStreams:(a=o(this,rr).getValue("modules").e2ee)==null?void 0:a.enabled},config:{enableHighBitrate:(l=(d=(c=o(this,rr).getValue("defaults").mediaConfiguration)==null?void 0:c.audio)==null?void 0:d.enableHighBitrate)!=null?l:!1,enableStereo:(f=(m=(h=o(this,rr).getValue("defaults").mediaConfiguration)==null?void 0:h.audio)==null?void 0:m.enableStereo)!=null?f:!1},iceTransportPolicy:o(this,Br)});i.push(_)}if(e.recv){const _=$(this,Id,Eg).call(this,{iceServers:n,additionalSettings:{encodedInsertableStreams:(y=o(this,rr).getValue("modules").e2ee)==null?void 0:y.enabled},iceTransportPolicy:o(this,Br)});i.push(_)}await Promise.all(i)}stopTransports(e){var r,n,i,a;e.send&&((r=o(this,It))==null||r.close(),(n=o(this,It))==null||n.removeAllListeners(),v(this,It,void 0)),e.recv&&((i=o(this,At))==null||i.close(),(a=o(this,At))==null||a.removeAllListeners(),v(this,At,void 0)),$(this,ho,Lu).call(this)}stopAllTransports(){u.info("Closing all transports"),this.stopTransports({send:!0,recv:!0})}async connectTransportWithRetry(e,r){const{id:n,serverId:i,direction:a}=e;$(this,Ad,_g).call(this,e);try{const c=ee.hasFeature(se.ENABLE_HIVE_INFINITE_RETRIES)?1/0:3;return await au(async(d,l)=>{d>0&&u.debug(`Retrying transport connect, count: ${d}`,{transport:{id:n,serverId:i,type:a}});try{await $(this,Rd,yg).call(this,e,r)}catch(h){if(h instanceof oi){l(h);return}throw h}},{delayTime:100,strategy:"exponential",maxRetryCount:c}),e}catch(c){throw u.error(`Failed to connect send transport after retry: ${e.id}`,{error:c,transport:{id:n,serverId:i,type:a}}),e.close(),e.removeAllListeners(),this.handleErrors("rejoin"),c}}handleErrors(e){throw new Error("Method not implemented.")}}rr=new WeakMap,Zi=new WeakMap,It=new WeakMap,At=new WeakMap,xn=new WeakMap,ea=new WeakMap,ta=new WeakMap,sa=new WeakMap,Vn=new WeakMap,Br=new WeakMap,uo=new WeakMap,ra=new WeakSet,jd=function(){return o(this,rr).getValue("connectionHandler")},ho=new WeakSet,Lu=function(){v(this,Vn,{send:void 0,recv:void 0})},Rd=new WeakSet,yg=async function(e,r){const{id:n,serverId:i,direction:a}=e;if(u.info(`Connecting ${a} transport`,{transport:{id:n,serverId:i,type:a}}),!o(this,xn).isConnected)throw new oi("Socket is not connected");if(e.connectionState==="closed")throw new oi("Transport is closed");try{await e.connect(c=>$(this,Md,bg).call(this,a,c,r),r),u.info(`Connected ${a} transport`,{transport:{id:n,serverId:i,type:a}})}catch(c){throw o(this,sa).transportFailureCount[a]+=1,c.message==="ice connection failed"?new oi(c.message):c}},kd=new WeakSet,Sg=async function(e){var r,n;if(o(this,It)&&o(this,It).connected){u.info("Transport send is already connected",{transport:{id:(r=o(this,It))==null?void 0:r.id,serverId:(n=o(this,It))==null?void 0:n.serverId,type:"send"}});return}v(this,It,await o(this,Zi).createTransport({...e,direction:"send"})),j.configureSendTransport(o(this,It))},Id=new WeakSet,Eg=async function(e){var r,n;if(o(this,At)&&o(this,At).connected){u.info("Transport recv is already connected",{transport:{id:(r=o(this,At))==null?void 0:r.id,serverId:(n=o(this,At))==null?void 0:n.serverId,type:"recv"}});return}v(this,At,await o(this,Zi).createTransport({...e,direction:"recv"})),j.configureRecvTransport(o(this,At))},Ad=new WeakSet,_g=function(e){const{direction:r,id:n}=e;e.on("connectionstatechange",async i=>{$(this,mo,Vu).call(this,{state:i,direction:r}),u.info(`Transport connection state changed for ${r} transport`,{transport:{id:n,serverId:e.serverId,type:r,status:i}});const a=()=>{const c=o(this,Vn)[r];c!==void 0&&(clearTimeout(c),o(this,Vn)[r]=void 0)};switch(i){case"connected":a(),o(this,sa).lastConnectionTime=performance.now();break;case"disconnected":o(this,Vn)[r]=setTimeout(async()=>{await $(this,po,xu).call(this,e)},LM);break;case"failed":if(e.closed)return;a(),await $(this,po,xu).call(this,e);break}}),e.on("icecandidate",async i=>{u.debug("Sending iceCandidate:",{iceCandidate:i})}),e.on("datachannel:events",async(i,a)=>{var c,d;u.debug("Got data channel message on event:",{rtcChannel:{label:i,message:a}});try{switch(a.type){case"handshake":{const l={type:"handshake",payload:{message:"pong"}};e.sendResponseOverDC(i,Ef(a),l);break}case"hub-disconnect":{u.debug(`media hub disconnected, full_reconnect: ${(c=a.payload)==null?void 0:c.full_reconnect}`),((d=a.payload)==null?void 0:d.full_reconnect)===!0&&this.handleErrors("rejoin");break}case"error":break;default:break}}catch(l){u.error(`Unable to handle the incoming datachannel message on channel ${i}`)}}),e.on("dc_error",()=>{e.direction==="recv"&&(u.warn("Events datachannel did not open in 5s",{country:T.location.country}),this.handleErrors("reconnectRecvTransport"))})},Md=new WeakSet,bg=async function(e,r,n){const i=e==="recv";try{const{sdp:a,type:c}=r,d={consuming:i,description:{sdp:a,type:c,target:i?pr.SUBSCRIBER:pr.PUBLISHER},producers:[]};return!i&&n&&(d.producers=n),o(this,ea).connectTransport(d)}catch(a){throw u.error(`Error in ${e} transport connection:`,{error:a,country:T.location.country}),a}},po=new WeakSet,xu=async function(e){e.close(),e.removeAllListeners();const{direction:r}=e;switch(ee.hasFeature(se.HIVE_TRANSPORT_FORCE_RELAY_ON_ICE_FAILED)&&o(this,xn).isConnected&&o(this,sa).transportFailureCount[r]>2&&(u.warn(`Multiple disconnections in ${r} transport, forcing relay`),v(this,Br,"relay")),await this.createTransports({[r]:!0}),r){case"send":{await this.connectTransportWithRetry(o(this,It)),u.info("Transport reconnected",{transport:o(this,It)}),R.emit(k.RESET_PRODUCER_STATE);break}case"recv":{await this.connectTransportWithRetry(o(this,At)),u.info("Transport reconnected",{transport:o(this,At)}),R.emit(k.UPDATE_ACTIVE,{createAllConsumers:!0});break}default:u.warn("Unknown transport direction",{transport:e})}$(this,mo,Vu).call(this,{state:vr.CONNECTED,direction:r})},mo=new WeakSet,Vu=function(e){const{state:r,direction:n}=e;o(this,ra,jd).mediaState[n]={state:r,reconnected:!0},R.emit(k.TRANSPORT_STATE_UPDATE,{transport:n,...o(this,ra,jd).mediaState[n]})};class VM{constructor(t){g(this,Dd);this.recvTransport=t,$(this,Dd,wg).call(this)}async create(t){if(!t||t&&t.length===0)throw new Error("List of producers is required");const r={type:"create_consumer",payload:{producers:t.map(({producerId:c,producingTransportId:d,kind:l,mimeType:h})=>({producerId:c,producingTransportId:d,preferredCodec:{...l==="video"&&h?{video:h}:{},...l==="audio"&&h?{audio:h}:{}}}))}},n=await this.recvTransport.sendDataChannelMessage("events",r),i=new Map;t.forEach(c=>i.set(c.producerId,c));const a=new Map;return Object.entries(n).forEach(([c,d])=>{const l=i.get(d.producerId);l&&a.set(d.producerId,{consumerId:c,producingTransportId:l.producingTransportId,producingPeerId:l.producingPeerId,kind:l.kind,paused:l.pause,streamId:d.streamId,trackId:d.trackId,screenShare:l.screenShare,mimeType:l.mimeType,appData:{}})}),{consumerStates:a}}async negotiate(t,e,r){try{u.debug(`Received offer over dc: ${t.sdp} for transport`);const n=await this.recvTransport.setRemoteOffer(t),i={type:"answer",payload:{type:n.type,sdp:n.sdp}};return u.debug(`datachannel answer: ${JSON.stringify(i)}`),this.recvTransport.sendResponseOverDC(r,e,i),n}catch(n){throw u.error("datachannel:events::Error:",n),n.code!=="DC_NOT_FOUND"&&this.recvTransport.sendErrorOverDC(r,e,n),n}}async close(t){if(!t.length)return{};const e=t.map(a=>a.id);u.info(`Closing consumers: ${JSON.stringify(e)}`);const r={type:"close_consumers",payload:{consumers:e}},n=await this.recvTransport.sendDataChannelMessage("events",r),{failedConsumers:i}=n;return{failedConsumers:i}}}Dd=new WeakSet,wg=function(){this.recvTransport.on("datachannel:events",async(e,r)=>{try{switch(r.type){case"negotiation":{const{sdp:n}=r.payload,i={sdp:n,type:"offer"};this.negotiate(i,Ef(r),e);break}default:break}}catch(n){u.error(`Unable to handle the incoming datachannel message on channel ${e}`)}})};class UM{constructor(t,e,r,n){this.events=t,this.recvTransport=e,this.socket=r,this.socketHandler=n}async create(t){if(!t||t&&t.length===0)throw new Error("List of producers is required");const e=new Map,r=[];t.forEach(c=>{const{producingPeerId:d,producerId:l,producingTransportId:h}=c;e.set(l,d),r.push({producingPeerId:d,producerId:l,producingTransportId:h})});const n=await this.socketHandler.consume({requests:r,consumingTransportId:this.recvTransport.serverId}),i=new Map;t.forEach(c=>i.set(c.producerId,c));const a=new Map;return Object.entries(n.consumerStateMap).forEach(([c,d])=>{const l=i.get(c);if(!l)return;let h={};try{h=JSON.parse(d.producerState.appData)}catch(m){}a.set(c,{consumerId:d.consumerId,producingTransportId:l.producingTransportId,producingPeerId:l.producingPeerId,kind:l.kind,paused:l.pause,streamId:d.producerTrack.streamId,trackId:d.producerTrack.trackId,screenShare:l.screenShare,mimeType:l.mimeType,appData:h})}),{consumerStates:a,sessionDescription:n.sessionDescription}}async negotiate(t){u.debug(`setting remote offer: ${JSON.stringify(t)} on recvTransport`,{transport:this.recvTransport});const e=await this.recvTransport.setRemoteOffer(t),r={transportId:this.recvTransport.serverId,description:{sdp:e.sdp,type:e.type,target:pr.SUBSCRIBER}};return u.debug(`sending renegotiate request: ${JSON.stringify(r)} on recvTransport`,{transport:this.recvTransport}),await this.socket.sendMessagePromise(this.events.renegotiateSessionDescription,ew.toBinary(r)),u.info("renegotiation done",{transport:this.recvTransport}),e}async close(t){if(!t.length)return{};const e=t.map(i=>i.localId);u.info(`Closing consumers: ${JSON.stringify(e)}`);const r={consumerIds:e};return await(async()=>{var i;return(i=this.recvTransport)==null?void 0:i.awaitQueue.push(async()=>{await this.socketHandler.closeConsumer(r)},"close_consumer").catch(a=>{u.warn("error on closing consumer:",{error:a})})})(),{}}}class Zc{constructor(t){this.socketHandler=t}static getMSIDFromSDP(t,e){return lu(t).media.filter(i=>e==="video"?i.type==="video":i.type==="audio").at(-1).msid}async create({offer:t,kind:e,paused:r,appData:n,codecOptions:i,producingTransportId:a}){var m,f;const c=Zc.getMSIDFromSDP(t.sdp,e),d={description:{sdp:t.sdp,type:t.type,target:pr.PUBLISHER},paused:r,kind:e,msid:c,appData:JSON.stringify(n),screenShare:(m=n.screenShare)!=null?m:!1,mimeType:`${e}/${(f=i[0])==null?void 0:f.name}`,producingTransportId:a},{answer:l,producerId:h}=await this.socketHandler.produce(d);return{answer:l,producerId:h}}}const FM=3;class BM extends xM{constructor(e,r,n){super(e,r,n);g(this,Od);g(this,Nd);g(this,Ld);g(this,xd);g(this,vo);g(this,To);g(this,Vd);g(this,na,void 0);g(this,Un,void 0);g(this,$r,void 0);g(this,ia,void 0);g(this,fo,void 0);g(this,Ns,void 0);g(this,go,{producerCreationFailureCount:0,consumerCreationFailureCount:0,producerNotReadyFailureCount:0});v(this,na,e),o(this,Od,Pg).mediaState={send:{state:vr.NEW,reconnected:!1},recv:{state:vr.NEW,reconnected:!1}},this.reset()}get socketHandler(){return super.socketHandler}get producers(){return o(this,Un)}get consumers(){return o(this,$r)}get producerIdToConsumerIdMap(){return o(this,ia)}reset(){v(this,Un,new Map),v(this,$r,new Map),v(this,ia,new Map)}async setupTransports(e,r){await this.createTransports(e);let n,i;e.send&&(n=$(this,Nd,Cg).call(this,r)),e.recv&&(i=$(this,Ld,Rg).call(this));const[a]=await Promise.all([n,i]);return a}async createProducer(e,r){var n;if(!this.sendTransport||this.sendTransport.closed)throw new Error("Send transport is closed");try{const i=await this.sendTransport.produce(e,$(this,xd,kg).bind(this));return(n=e.appData)!=null&&n.e2ee&&R.emit(k.E2EE_ACTIVE_PRODUCER,i),$(this,vo,Uu).call(this,i,r),i}catch(i){throw u.error("Failed to create producer",{error:i}),o(this,go).producerCreationFailureCount+=1,i}}async closeProducer(e,r){var i;const n=this.producers.get(e);if(!n){u.warn(`Producer with ID ${e} was not found`);return}r!=null&&r.stopTrack&&n.track.stop();try{await this.sendTransport.closeProducer(n),(i=o(this,na).getValue("modules").e2ee)!=null&&i.enabled&&R.emit(k.E2EE_INACTIVE_PRODUCER,n)}catch(a){u.error("Failed to close producer on server",{error:a,producer:n})}}closeAllProducers(){return Promise.all(Array.from(o(this,Un).entries()).map(([,e])=>e.close()))}createConsumer(e){return this.createConsumers([e])}async createConsumers(e){if(!this.recvTransport||this.recvTransport.closed)throw new Error("Recv transport is closed");try{const r=e.filter(({producerId:i})=>!this.producers.get(i));(await this.recvTransport.consume(r,$(this,To,Fu).bind(this),o(this,Ns).negotiate.bind(o(this,Ns)))).forEach(i=>{i.status!=="rejected"&&$(this,Vd,Ig).call(this,i.value)})}catch(r){}}closeConsumer(e){return this.closeConsumers([e])}async closeConsumers(e){if(!o(this,Ns))return;const r=e.map(i=>this.consumers.get(i)).filter(i=>i!==void 0);if(r.length===0)return;const{failedConsumers:n}=await o(this,Ns).close(r);n!=null&&n.length&&u.warn("Failed to close some consumers",{consumerIds:n})}closeAllConsumers(){return this.closeConsumers(Array.from(o(this,$r).keys()))}async switchConsumersToLayer(e,r){const n=this.recvTransport.getDatachannel("events");if(!n){u.warn("events datachannel not found");return}const i={type:"switch_consumer_layer",payload:{consumerIds:e,layer:r}};await n.request(i),u.info(`Consumers switched layers to ${r}`,{consumerIds:e})}}na=new WeakMap,Un=new WeakMap,$r=new WeakMap,ia=new WeakMap,fo=new WeakMap,Ns=new WeakMap,go=new WeakMap,Od=new WeakSet,Pg=function(){return o(this,na).getValue("connectionHandler")},Nd=new WeakSet,Cg=async function(e){v(this,fo,new Zc(this.socketHandler));const r=[];return e&&(await this.sendTransport.precreateProducers(e)).forEach(async({kind:a,result:c},d)=>{var m;const{codecOptions:l}=e[d].options,h=l[0]?`${a}/${(m=l[0])==null?void 0:m.name}`:void 0;r.push({kind:a,msid:Zc.getMSIDFromSDP(c.offerSdp.sdp,a),mid:c.mid,paused:!0,mimeType:h,appData:JSON.stringify({mid:c.mid}),screenShare:!1,track:e[d].options.track})}),await this.connectTransportWithRetry(this.sendTransport,r),this.sendTransport.producers.size?r.map(({mid:i},a)=>{const[,c]=Array.from(this.sendTransport.producers.entries()).find(([,d])=>d.localId===i);return $(this,vo,Uu).call(this,c,e[a].onClose),c}):[]},Ld=new WeakSet,Rg=async function(){switch(this.recvTransport.on("connect",()=>{o(this,ia).clear()}),await this.connectTransportWithRetry(this.recvTransport),this.nodeType){case bt.CF:{v(this,Ns,new UM(this.events,this.recvTransport,this.socket,this.socketHandler));break}case bt.HIVE:default:v(this,Ns,new VM(this.recvTransport))}},xd=new WeakSet,kg=function(e){return o(this,fo).create(e)},vo=new WeakSet,Uu=function(e,r){e.on("close",async({offer:n,reason:i},a)=>{u.info("producer::closing",{debuggingHint:i,producer:{...e,status:"closing"}});const c={producerId:e.id,description:{sdp:n.sdp,type:n.type,target:pr.PUBLISHER}};try{const d=await this.socketHandler.closeProducer(c),l={sdp:d==null?void 0:d.sdp,type:d==null?void 0:d.type};u.info("producer::closed",{producer:{...e,status:"closed"}}),a({answer:l})}catch(d){u.error("producer close error",d)}this.producers.delete(e.id),r()}),e.on("trackended",()=>{u.info("producer::trackended",{producer:{...e,status:"UNKNOWN"}})}),o(this,Un).set(e.id,e)},To=new WeakSet,Fu=async function(e,r=0){try{return await this.recvTransport.canConsume(),await o(this,Ns).create(e)}catch(n){if(n instanceof gM&&(o(this,go).consumerCreationFailureCount+=1),r<=FM)return u.error(`Error in consume request attempt:${r}`,{error:n}),$(this,To,Fu).call(this,e,r+1);throw u.error("Error in consume request",{error:n}),n}},Vd=new WeakSet,Ig=function(e){e.on("close",async r=>{u.debug("consumer closed",{consumer:{closureReason:r,id:e.id,kind:e.kind,appData:e.appData}}),o(this,$r).delete(e.id),R.emit(k.CONSUMER_CLOSED,{id:e.id})}),o(this,$r).set(e.id,e),this.producerIdToConsumerIdMap.set(e.producerId,e.id),R.emit(k.NEW_CONSUMER,{id:e.id,appData:e.appData,peerId:e.peerId})};const $M=()=>{const s=new window.AudioContext,t=s.createOscillator();t.type="triangle",t.frequency.setValueAtTime(20,s.currentTime);const e=s.createGain();e.gain.setValueAtTime(0,s.currentTime),t.connect(e);const r=s.createMediaStreamDestination();return e.connect(r),t.start(),r.stream.getAudioTracks()[0]},HM=()=>{var r,n;const s=new MediaStream().getVideoTracks()[0],t=document.createElement("canvas");t.height=(r=s==null?void 0:s.getSettings().height)!=null?r:720,t.width=(n=s==null?void 0:s.getSettings().width)!=null?n:1280;const e=t.getContext("2d");return e.fillStyle="black",e.fillRect(0,0,t.width,t.height),setInterval(()=>{e.fillStyle="black",e.fillRect(0,0,t.width,t.height)},1e3),t.captureStream().getVideoTracks()[0]};var qM=Object.defineProperty,jM=Object.getOwnPropertyDescriptor,de=(s,t,e,r)=>{for(var n=r>1?void 0:r?jM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&qM(t,e,n),n};const Rs=["video/VP9","video/VP8"];class ce{constructor(t,e,r){g(this,qr);g(this,at);g(this,Gn);g(this,_o);g(this,bo);p(this,"context");p(this,"authToken");p(this,"e2ee");g(this,yo,void 0);g(this,So,void 0);g(this,Tt,void 0);g(this,J,void 0);g(this,aa,void 0);g(this,Fn,void 0);g(this,Mt,void 0);g(this,Bn,void 0);g(this,$n,void 0);g(this,Hr,void 0);g(this,Eo,void 0);g(this,nr,void 0);p(this,"maxPreferredStreams");g(this,oa,void 0);g(this,Hn,void 0);g(this,qn,void 0);g(this,jn,void 0);p(this,"partialJoinRoomPromise");var i,a;this.context=t;const{socket:n}=r;this.mediaJoined=!1,v(this,Hn,new Map([["video/VP9",new Set],["video/VP8",new Set]])),v(this,qn,new Map([["video/VP9",new Set],["video/VP8",new Set]])),v(this,Fn,e),v(this,Tt,n),v(this,Bn,!1),v(this,J,new BM(t,n,e)),v(this,Mt,o(this,J).events),this.maxPreferredStreams=6,v(this,nr,new Set),v(this,jn,new Map),v(this,$n,!1),v(this,Hr,new Jc),this.e2ee=(a=(i=t.getValue("modules").e2ee)==null?void 0:i.enabled)!=null?a:!1,this.handleSocketEvents(),this.handleCallstatsEvents(),v(this,Eo,pc(async()=>{if(!o(this,qr,la).mediaJoinAttempted)return;const{roomJoined:c}=await this.joinRoom(o(this,So),o(this,yo),{},!0,!0);c&&(R.emit(k.RESET_PRODUCER_STATE),R.emit(k.ROOM_NODE_RECONNECTED))},5e3,{leading:!0,maxWait:1e3}))}get peerId(){return this.context.getValue("peerId")}get mediaJoined(){return o(this,qr,la).mediaJoined}set mediaJoined(t){o(this,qr,la).mediaJoined=t}reset(t=!0){o(this,J).closeAllProducers(),o(this,J).closeAllConsumers(),o(this,nr).clear(),t&&(this.partialJoinRoomPromise=void 0,o(this,Hr).stop(),o(this,J).stopAllTransports(),o(this,J).reset(),v(this,Hr,new Jc))}async joinRoom(t,e,r={},n=!1,i=!1){o(this,qr,la).mediaJoinAttempted=!0,v(this,Bn,!0),this.reset(n);const a=nt().ipInfo;if(a!=null&&a.loc&&!o(this,oa)){const d=a.loc.split(",");v(this,oa,{latitude:parseFloat(d[0]),longitude:parseFloat(d[1])})}let c;try{return c=await o(this,Hr).push(()=>this._joinRoom(t,e,r,i,o(this,oa)),"joinRoom"),c}catch(d){c={roomJoined:!1}}return c.roomJoined||R.emit(k.ROOM_NODE_FAILED),c}async _partialJoinRoom(t,e,r=!1,n=void 0){var f;const{ipInfo:i}=nt();let a=n;if(i!=null&&i.loc&&!n){const[y,_]=i.loc.split(",").map(parseFloat);a={latitude:y,longitude:_}}const c=(f=ee.getValue(se.FORCE_VIDEO_CODEC))==null?void 0:f.toString(),d=yM(c);v(this,aa,d),this.maxPreferredStreams=this.context.getValue("maxPreferredStreams"),await au(async(y,_)=>{if(!o(this,Tt).isConnected){_(new Error("socket is not connected"));return}y>0&&u.warn(`retrying sending join room request, count: ${y}`);try{await o(this,J).socketHandler.joinRoom(e,t,d,r,a)}catch(b){throw u.error("failed to send join room request, error:",{error:b}),b}},{delayTime:1e3,strategy:"exponential",maxRetryCount:ee.hasFeature(se.ENABLE_HIVE_INFINITE_RETRIES)?1/0:3});const l="video/VP8",h=ee.hasFeature(se.PRECREATE_PRODUCERS)?[{type:Le.MIC,kind:"audio",options:$(this,_o,Bu).call(this,$M()),onClose:()=>this.disableMic()},{type:Le.WEBCAM,kind:"video",options:$(this,bo,$u).call(this,HM(),l),onClose:()=>{this.disableWebcam(l)}}]:[],m=await o(this,J).setupTransports({send:!0,recv:!0},h);m!=null&&m.length&&h.forEach((y,_)=>{o(this,jn).set(y.type,m[_].id)})}async partialJoinRoom(t,e,r=!1,n=void 0){return this.partialJoinRoomPromise=o(this,Hr).push(()=>this._partialJoinRoom(t,e,r,n)),this.partialJoinRoomPromise}async _joinRoom(t,e,r={},n=!1,i=null){v(this,So,t);try{this.partialJoinRoomPromise?await this.partialJoinRoomPromise:await this._partialJoinRoom(t,e,n,i)}catch(a){u.error("error in partial join room",{error:a})}finally{this.partialJoinRoomPromise=void 0}try{return navigator.product!=="ReactNative"&&setTimeout(async()=>{const d={userId:this.context.getValue("userId"),peerId:this.peerId,roomUUID:e,roomViewType:"groupCall",deviceInfo:{...be.getDeviceInfo(),userAgent:navigator.userAgent,memory:navigator.deviceMemory,cpus:navigator.hardwareConcurrency},sdkName:this.context.getValue("sdkName"),sdkVersion:this.context.getValue("sdkVersion"),metaData:{},permissions:{}};j.roomJoined(d)}),{roomJoined:await this.completeJoinRoom()}}catch(a){return u.error("error on sending join room request",{error:a}),{roomJoined:!1}}}async completeJoinRoom(){try{this.mediaJoined=!0;const{maxPreferredStreams:t,roomState:e}=await o(this,J).socketHandler.notifySelfJoinComplete();return v(this,yo,e.roomUuid),v(this,$n,!0),v(this,Bn,!1),this.maxPreferredStreams=t!=null?t:6,!0}catch(t){return u.error("error on completing join room:",{error:t}),this.mediaJoined=!1,!1}}async leaveRoom(){o(this,J).stopAllTransports(),v(this,$n,!1),o(this,qr,la).mediaJoinAttempted=!1;const t={closeRoom:!1};o(this,Tt).sendMessagePromise(o(this,Mt).leaveRoom,ww.toBinary(t)).then(e=>{var n;((n=dP.fromBinary(e.payload))==null?void 0:n.closed)||u.warn("weird state on peer closed and should not happen")}).catch(e=>{u.error("error on sending leave room request",{error:e})}),j.callEnded(),T.destruct()}getConsumers(){return o(this,J).consumers}async activatePeers(t){return this.createConsumers(t)}async deactivatePeers(t,e="default"){const r=new Set;t.forEach(i=>{i.screenShare&&i.kind==="video"&&r.add(i.producingPeerId)});const n=e==="default"?t.filter(i=>!r.has(i.producingPeerId)).filter(i=>i.kind!=="audio"):t;await Promise.all(n.map(i=>{const a=o(this,J).producerIdToConsumerIdMap.get(i.producerId);if(!a){u.warn(`consumer not found in deactivate producers: ${i.producerId}`);return}return o(this,J).closeConsumer(a)}))}async createConsumers(t){return t.length===0?Promise.resolve():o(this,J).createConsumers(t)}async closeConsumers(t){if(!t.length)return;const e=t.reduce((r,n)=>{const i=o(this,J).producerIdToConsumerIdMap.get(n.producerId);return i?(r.push(i),r):(u.warn(`consumer not found in deactivate producers: ${n.producerId}`),r)},[]);await o(this,J).closeConsumers(e)}async _shareWebcam(t,e){const r=e==="video/VP9"?Le.WEBCAM:Le.WEBCAM_BACKUP,n=$(this,at,Dt).call(this,r);if(o(this,J).producers.has(n)){const l=o(this,J).producers.get(n);if(!l.closed&&!navigator.isReactNative)return await l.replaceTrack({track:t}),await this.resumeWebcam(r),t;await this.disableWebcam(e)}const i=$(this,bo,$u).call(this,t,e),a=gc(this.context,"disableSimulcast");o(this,Fn)===bt.HIVE&&!a&&ee.hasFeature(se.ENABLE_HIVE_SIMULCAST)?(u.info(`Simulcast enabled for SFU: ${o(this,Fn)}`),i.encodings=f0(t)):u.info(`Simulcast disabled for webcam producer, SFU: ${o(this,Fn)}`),ee.hasFeature(se.TRACK_HINT)&&(i.track.contentHint=ee.getValue(se.TRACK_HINT));const c=()=>{u.info("Disabling video due to the producer closure"),this.disableWebcam(e)},d=await o(this,J).createProducer(i,c);return $(this,Gn,Jo).call(this,r,d.id),d.track}async shareWebcam(t){if(t===void 0)return null;if(ee.hasFeature(se.FORCE_VIDEO_CODEC)){const e=ee.getValue(se.FORCE_VIDEO_CODEC).toString();if(e)return u.debug(`Calling _shareWebcam with forced video codec: ${e}`),this._shareWebcam(t,e)}return await Promise.all(Rs.map(e=>{var r,n;return((n=(r=o(this,aa).sender)==null?void 0:r.video)==null?void 0:n.codecs.findIndex(i=>i.mimeType===e))>=0&&o(this,qn).get(e).size>0?(u.debug(`Calling _shareWebcam with video codec: ${e}`),this._shareWebcam(t,e)):t})),t}async shareScreen(t){const{video:e,audio:r}=t;if(e===void 0)return;const n={track:e,codecOptions:[{name:"VP8"}],appData:{screenShare:!0,e2ee:this.e2ee,supportsRemoteControl:be.isElectron()},stopTracks:!1};let i=()=>{u.info("Disabling screenShare due to the producer closure"),this.disableScreenShare()};const a=await o(this,J).createProducer(n,i);if($(this,Gn,Jo).call(this,Le.SCREENSHARE_VIDEO,a.id),r){const c={track:r,codecOptions:[{name:"opus"}],appData:{screenShare:!0,e2ee:this.e2ee,supportsRemoteControl:be.isElectron()},stopTracks:!1,zeroRtpOnPause:!0};i=()=>{};const d=await o(this,J).createProducer(c,i);$(this,Gn,Jo).call(this,Le.SCREENSHARE_AUDIO,d.id)}j.screenShareStart()}async shareMic(t){try{if(t===void 0)throw new Pt("track undefined");const e=$(this,at,Dt).call(this,Le.MIC);if(o(this,J).producers.has(e)){const a=o(this,J).producers.get(e);if(!a.closed&&!navigator.isReactNative){await a.replaceTrack({track:t}),await this.resumeMic();return}await o(this,J).closeProducer(e,{stopTrack:!1})}const r=$(this,_o,Bu).call(this,t),n=()=>{u.info("Disabling audio due to the producer closure"),this.disableMic()},i=await o(this,J).createProducer(r,n);$(this,Gn,Jo).call(this,Le.MIC,i.id)}catch(e){throw new P(e)}}pauseMic(){const t=$(this,at,Dt).call(this,Le.MIC),e=o(this,J).producers.get(t);if(!e){u.error("pauseMic::could_not_find_mic_producer");return}if(e.paused){u.info("pauseMic::mic_producer_already_paused");return}e.pause();const r={producerId:e.id,pause:!0};o(this,Tt).sendMessage(o(this,Mt).toggleProducer,kc.toBinary(r))}async pauseWebcam(){const t=$(this,at,Dt).call(this,Le.WEBCAM),e=$(this,at,Dt).call(this,Le.WEBCAM_BACKUP),r=o(this,J).producers.get(t),n=o(this,J).producers.get(e);if(!r){u.error("pauseWebcam::could_not_find_webcam_producer");return}const i=a=>{const c={producerId:a.id,pause:!0};o(this,Tt).sendMessage(o(this,Mt).toggleProducer,kc.toBinary(c))};r.pause(),i(r),n&&(n.pause(),i(n))}async resumeMic(){const t=$(this,at,Dt).call(this,Le.MIC),e=o(this,J).producers.get(t);if(!e){u.error("resumeMic::could_not_find_mic_producer");return}if(!e.pause){u.info("resumeMic::mic_producer_already_resumed");return}e.resume(),e.appData.e2ee&&R.emit(k.E2EE_ACTIVE_PRODUCER,e);const r={producerId:e.id,pause:!1};o(this,Tt).sendMessage(o(this,Mt).toggleProducer,kc.toBinary(r))}async resumeWebcam(t=Le.WEBCAM){const e=$(this,at,Dt).call(this,t),r=o(this,J).producers.get(e);if(!r){u.error("resumeWebcam::could_not_find_webcam_producer");return}r.resume(),r.appData.e2ee&&R.emit(k.E2EE_ACTIVE_PRODUCER,r);const n={producerId:r.id,pause:!1};o(this,Tt).sendMessage(o(this,Mt).toggleProducer,kc.toBinary(n))}async disableWebcam(t){const e=t==="video/VP9"?Le.WEBCAM:Le.WEBCAM_BACKUP,r=$(this,at,Dt).call(this,e);await o(this,J).closeProducer(r)}async disableMic(){const t=$(this,at,Dt).call(this,Le.MIC);await o(this,J).closeProducer(t)}async disableScreenShare(){u.info("screen_sharing_stopped"),j.screenShareStop();const t=$(this,at,Dt).call(this,Le.SCREENSHARE_VIDEO),e=$(this,at,Dt).call(this,Le.SCREENSHARE_AUDIO);await o(this,J).closeProducer(t),await o(this,J).closeProducer(e),o(this,nr).clear()}async muteSelf(){this.pauseMic()}async unmuteSelf(){}async resetVideoProducers(t,e){if(t){const r=$(this,at,Dt).call(this,Le.WEBCAM),n=$(this,at,Dt).call(this,Le.WEBCAM_BACKUP);await o(this,J).closeProducer(r,{stopTrack:!1}),await o(this,J).closeProducer(n,{stopTrack:!1}),this.shareWebcam(t)}if(e){const r=$(this,at,Dt).call(this,Le.SCREENSHARE_VIDEO);await o(this,J).closeProducer(r,{stopTrack:!1}),this.shareScreen({video:e})}}async changeDisplayName(t,e){const r={displayName:t,participantId:e!=null?e:this.peerId};if(!await o(this,J).socketHandler.changeDisplayName(r))throw new Error("failed to change display name!")}async kick(t){const e={participantId:t};if(!await o(this,J).socketHandler.kickPeer(e))throw new Error("failed to kickout the participant!")}async kickAll(){if(!await o(this,J).socketHandler.kickAll())throw new Error("failed to kickout all participant!")}async muteAll(t){if(!await o(this,J).socketHandler.hostControlForAll("audio"))throw new Error("failed to mute all participant")}async muteAllVideo(){if(!await o(this,J).socketHandler.hostControlForAll("video"))throw new Error("failed to mute all video participant")}async disableAudio(t){if(!await o(this,J).socketHandler.hostControlForPeer(t,"audio"))throw new Error("failed to mute given participant")}async disableVideo(t){if(!await o(this,J).socketHandler.hostControlForPeer(t,"video"))throw new Error("failed to mute video of given participant")}async pinPeer(t){const e={participantId:t!=null?t:""};try{await o(this,Tt).sendMessagePromise(o(this,Mt).globalPinPeer,Nw.toBinary(e))}catch(r){u.error("Error in pinning peer:",{error:r})}}validateScreenShare(t){return this.peerId===t.peerId&&o(this,J).producers.get(t.producerId)&&o(this,nr).add(t.consumerPeerId),o(this,nr).size}async switchConsumersToLayer(t,e){o(this,J).switchConsumersToLayer(t,e)}async handleSocketEvents(){o(this,Tt).on(o(this,Mt).peerProducerCreateBroadcast,({payload:t})=>{var e,r;if(this.mediaJoined)try{const{participantId:n,producerState:i}=BP.fromBinary(t);if(n===this.peerId)return;if(i!=null&&i.mimeType||(i.mimeType=i.kind===Cs.AUDIO?"audio/opus":"video/VP8"),i.kind===Cs.VIDEO&&!i.screenShare&&((r=(e=o(this,aa).receiver)==null?void 0:e.video)==null?void 0:r.codecs.findIndex(a=>a.mimeType===Rs[0]))>=0&&o(this,Hn).get(Rs[0]).has(n)&&i.mimeType!==Rs[0]){u.warn(`Ignoring producer: ${i.producerId}`);return}u.info(`producer created broadcast: ${n}, producer state: ${i}`),R.emit(k.NEW_PRODUCER,{peerId:n,producer:{...i,kind:i.kind===Cs.AUDIO?"audio":"video",producingPeerId:n}})}catch(n){u.error("error in peer-producer-create-broadcast",{error:n})}}),o(this,Tt).on(o(this,Mt).peerProducerToggleBroadcast,({payload:t})=>{if(this.mediaJoined)try{const{participantId:e,initiatorParticipantId:r,producerState:{kind:n,pause:i,producerId:a}}=hm.fromBinary(t),c=n===Cs.AUDIO?"audio":"video";if(u.info(`producer toggle broadcast: ${e}, producerId: ${a}, kind:${c}, paused:${i} payload: ${JSON.stringify(hm.fromBinary(t))}`),e===this.peerId&&r!==this.peerId&&i&&R.emit(c==="audio"?k.MUTE_SELF:k.MUTE_SELF_VIDEO),e===this.peerId)return;R.emit(k.PRODUCER_TOGGLE,{peerId:e,producerId:a,paused:i,kind:c}),Array.from(this.getConsumers().values()).filter(l=>l.producerId===a).forEach(l=>{l.paused!==i&&(u.debug(`consumer state mismatched for ${l.id}. updating consumer pause state ${l.paused} to ${i}`),i?(l.pause(),R.emit(k.CONSUMER_PAUSED,{id:l.id})):(l.resume(),R.emit(k.CONSUMER_RESUMED,{id:l.id})))})}catch(e){u.error("error in producer toggle broadcast handler",{error:e})}}),o(this,Tt).on(o(this,Mt).peerLeaveBroadcast,({payload:t})=>{if(this.mediaJoined)try{const{participantId:e}=Cl.fromBinary(t);if(e===this.peerId)return;u.info(`peer left broadcast:${e}`),o(this,nr).delete(e),o(this,J).consumers.forEach(r=>{r.peerId===e&&r.close()}),R.emit(k.PEER_CLOSED,{id:e})}catch(e){u.error("error in peer left broadcast",{error:e})}}),o(this,Tt).on(o(this,Mt).peerProducerCloseBroadcast,({payload:t})=>{if(this.mediaJoined)try{const{participantId:e,producerState:{producerId:r}}=qP.fromBinary(t);if(e===this.peerId)return;u.info(`producer closed broadcast:${e}`),R.emit(k.PRODUCER_CLOSED,{peerId:e,producerId:r});const n=o(this,J).producerIdToConsumerIdMap.get(r);if(!n){u.warn(`no consumer found for producer:${r}`);return}u.info(`closing consumer ${n}, producer id: ${r}`),o(this,J).closeConsumer(n).then(()=>{u.info(`closed consumer: ${n}`),o(this,J).producerIdToConsumerIdMap.delete(r),R.emit(k.CONSUMER_CLOSED,{id:n})}).catch(i=>{u.error("error closing consumer",{error:i})})}catch(e){u.error("error on producer close broadcast",{error:e})}}),o(this,Tt).on(o(this,Mt).mediaRoomTerminationBroadcastResponse,()=>{!this.mediaJoined&&!o(this,Bn)&&!o(this,$n)||(u.warn("media hub termination broadcast received, rejoining room"),R.emit(k.ROOM_NODE_DISCONNECTED),o(this,Eo).call(this))})}handleCallstatsEvents(){j.onConsumerScore(t=>{t.forEach((e,r)=>{const n=o(this,J).consumers.get(r);n&&R.emit(k.CONSUMER_SCORE_UPDATE,{id:r,kind:n.kind,peerId:n.peerId,score:e.score,scoreStats:e})})}),j.onProducerScore(t=>{t.forEach((e,r)=>{const n=Array.from(o(this,J).producers.values()).find(i=>i.id===r);n&&R.emit(k.PRODUCER_SCORE_UPDATE,{id:r,kind:n.kind,appData:n.appData,score:e.score,scoreStats:e})})})}handlePeerCapabilities(t,e){var r,n,i,a;for(let c=0;c<=Rs.length;c+=1){const d=Rs[c];if(((n=(r=e==null?void 0:e.receiver)==null?void 0:r.video)==null?void 0:n.codecs.findIndex(l=>l.mimeType===d))>=0||c===Rs.length-1){o(this,qn).get(d).add(t);break}}for(let c=0;c<=Rs.length;c+=1){const d=Rs[c];if(((a=(i=e==null?void 0:e.sender)==null?void 0:i.video)==null?void 0:a.codecs.findIndex(l=>l.mimeType===d))>=0||c===Rs.length-1){o(this,Hn).get(d).add(t);break}}}handlePeerLeaving(t){o(this,Hn).forEach(e=>e.delete(t)),o(this,qn).forEach((e,r)=>{e.delete(t),e.size===0&&this.disableWebcam(r)})}}yo=new WeakMap,So=new WeakMap,Tt=new WeakMap,J=new WeakMap,aa=new WeakMap,Fn=new WeakMap,Mt=new WeakMap,Bn=new WeakMap,$n=new WeakMap,Hr=new WeakMap,Eo=new WeakMap,nr=new WeakMap,oa=new WeakMap,Hn=new WeakMap,qn=new WeakMap,jn=new WeakMap,qr=new WeakSet,la=function(){return this.context.getValue("connectionHandler")},at=new WeakSet,Dt=function(t){return o(this,jn).get(t)},Gn=new WeakSet,Jo=function(t,e){return o(this,jn).set(t,e)},_o=new WeakSet,Bu=function(t){return{track:t,encodings:[{priority:"high"}],codecOptions:[{name:"opus"}],appData:{e2ee:this.e2ee},stopTracks:!1,zeroRtpOnPause:!0}},bo=new WeakSet,$u=function(t,e){return{track:t,codecOptions:[{name:e?e.split("/")[1]:"VP8"}],appData:{screenShare:!1,e2ee:this.e2ee},stopTracks:!1}},de([T.trace("MediaNodeClient.reset",{country:T.location.country})],ce.prototype,"reset",1),de([T.trace("MediaNodeClient.joinRoom")],ce.prototype,"joinRoom",1),de([T.trace("MediaNodeClient.completeJoinRoom")],ce.prototype,"completeJoinRoom",1),de([T.trace("MediaNodeClient.leaveRoom")],ce.prototype,"leaveRoom",1),de([T.trace("MediaNodeClient.activatePeers")],ce.prototype,"activatePeers",1),de([T.trace("MediaNodeClient.deactivatePeers")],ce.prototype,"deactivatePeers",1),de([T.trace("MediaNodeClient.createConsumers")],ce.prototype,"createConsumers",1),de([T.trace("MediaNodeClient.closeConsumers")],ce.prototype,"closeConsumers",1),de([T.trace("MediaNodeClient._shareWebcam")],ce.prototype,"_shareWebcam",1),de([T.trace("MediaNodeClient.shareWebcam")],ce.prototype,"shareWebcam",1),de([T.trace("MediaNodeClient.shareScreen")],ce.prototype,"shareScreen",1),de([T.trace("MediaNodeClient.shareMic")],ce.prototype,"shareMic",1),de([T.trace("MediaNodeClient.pauseMic")],ce.prototype,"pauseMic",1),de([T.trace("MediaNodeClient.pauseWebcam")],ce.prototype,"pauseWebcam",1),de([T.trace("MediaNodeClient.resumeMic")],ce.prototype,"resumeMic",1),de([T.trace("MediaNodeClient.resumeWebcam")],ce.prototype,"resumeWebcam",1),de([T.trace("MediaNodeClient.disableWebcam")],ce.prototype,"disableWebcam",1),de([T.trace("HiveClient.disableMic")],ce.prototype,"disableMic",1),de([T.trace("HiveClient.disableScreenShare")],ce.prototype,"disableScreenShare",1),de([T.trace("MediaNodeClient.muteSelf")],ce.prototype,"muteSelf",1),de([T.trace("MediaNodeClient.resetVideoProducers")],ce.prototype,"resetVideoProducers",1),de([T.trace("MediaNodeClient.changeDisplayName")],ce.prototype,"changeDisplayName",1),de([T.trace("MediaNodeClient.kickPeer")],ce.prototype,"kick",1),de([T.trace("MediaNodeClient.kickAllPeers")],ce.prototype,"kickAll",1),de([T.trace("MediaNodeClient.muteAll")],ce.prototype,"muteAll",1),de([T.trace("MediaNodeClient.muteAllVideo")],ce.prototype,"muteAllVideo",1),de([T.trace("MediaNodeClient.disableAudio")],ce.prototype,"disableAudio",1),de([T.trace("MediaNodeClient.disableVideo")],ce.prototype,"disableVideo",1),de([T.trace("MediaNodeClient.pinPeer")],ce.prototype,"pinPeer",1),de([T.trace("MediaNodeClient.validateScreenShare")],ce.prototype,"validateScreenShare",1);function bf(s,t,e){const r=s.getValue("roomNodeClient");if(r){if(r)return r;throw new Error("Room node client already set up.")}const n=new ce(s,t,e);return s.setValue("roomNodeClient",n),n}function wf(s){const t=s.getValue("roomNodeClient");try{t==null||t.leaveRoom()}catch(e){u.error("roomNodeClient::cleanupRoomNodeClient")}s.setValue("roomNodeClient",void 0)}var GM=Object.defineProperty,WM=Object.getOwnPropertyDescriptor,gn=(s,t,e,r)=>{for(var n=r>1?void 0:r?WM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&GM(t,e,n),n};const Pf=(lg=class{constructor(s,t,e,r){g(this,Vt);p(this,"self");p(this,"authToken");g(this,jr,void 0);p(this,"viewType");g(this,Ss,void 0);g(this,ot,void 0);const{socket:n}=e,i=s.getValue("authToken");this.self=t,v(this,ot,s),this.viewType=r,this.authToken=i,v(this,jr,n),v(this,Ss,e),t.config.viewType!==yt.Chat&&this.setupEvents()}get peerId(){return o(this,ot).getValue("peerId")}get mediaJoined(){return o(this,ot).getValue("connectionHandler").mediaJoined}static async init(s,t,e,r,n){const i=nt(),a=s.getValue("peerId"),c=!!s.getValue("cachedUserDetails"),d=await et.__init__(s,e,r,n,n.name,c);if(navigator.product!=="ReactNative"){const l=!ee.hasFeature(se.PRECALL_BANDWIDTH_TEST);setTimeout(async()=>{const h=await d.getAllDevices();u.info("populated_full_device_list",{devices:JSON.stringify(h)}),j.devices("AUDIO",h==null?void 0:h.filter(m=>m.kind==="audioinput")),j.devices("VIDEO",h==null?void 0:h.filter(m=>m.kind==="videoinput")),j.devices("SPEAKER",h==null?void 0:h.filter(m=>m.kind==="audiooutput")),u.info("Callstats:: initializing");try{await j.initialize({peerId:a,engineName:be.getDeviceInfo().engineName,env:s.getValue("env"),iceServers:await i.getICEServers(),apiBase:s.getValue("apiBase"),flags:ee.getAllFlags(),logger:u,apiHostnames:Up(s),skipConnectivityChecks:l}),u.info("Callstats:: initialized")}catch(m){u.error("Callstats:: initialization failed",{error:m})}},0)}else u.info("Callstats:: Skipped initialization due to navigator product being ReactNative.");return new Pf(s,d,t,n.viewType)}async shareMediaTracks(){var c;const{audioTrack:s,videoTrack:t,permissions:e,audioEnabled:r,videoEnabled:n,screenShareEnabled:i,screenShareTracks:a}=this.self;if(e.canProduceAudio&&r)try{await o(this,Vt,as).shareMic(s)}catch(d){this.self.disableAudio()}if(e.canProduceVideo&&n)try{const d=await o(this,Vt,as).shareWebcam(t);d&&d.id!==t.id&&ee.hasFeature(se.EXP_RESHARE)&&await o(this,Vt,as).shareWebcam(d)}catch(d){this.self.disableVideo()}if(e.canProduceScreenshare&&i)try{await((c=o(this,Vt,as))==null?void 0:c.shareScreen({video:a.video,audio:a.audio}))}catch(d){this.self.disableScreenShare()}}async kickHandler(s){let t="kicked";(s==null?void 0:s.kickType)==="kickAll"&&(t="ended"),this.leaveRoom(t)}waitlistedHandler(){u.info("SelController.waitlisted"),this.self.waitlistStatus="waiting",this.self.roomState="waitlisted",this.self.emit("waitlisted")}waitlistAcceptHandler(){if(u.info("SelController.waitlistAccepted"),this.self.waitlistStatus==="accepted"){u.warn("SelfController.WAITLIST_ACCEPTED.UserAlreadyAccepted");return}this.self.waitlistStatus="accepted",this.joinRoom()}waitlistRejectedHandler(){if(u.info("SelfController.waitlistRejected"),this.self.waitlistStatus==="rejected"){u.warn("SelfController.WAITLIST_REJECTED.UserAlreadyRejected");return}this.self.waitlistStatus="rejected",this.leaveRoom("rejected")}async resetSelf(s){j.callEnded(),o(this,Vt,as).reset(),s&&await this.joinRoom(s)}setupEvents(){R.on(k.RESET_PRODUCER_STATE,async()=>{this.mediaJoined&&this.shareMediaTracks()}),R.on(k.ROOM_NODE_RECONNECTED,()=>{this.self.roomState="joined",this.self.emit("roomJoined",{reconnected:!0})}),R.on(k.ROOM_NODE_DISCONNECTED,()=>{this.self.roomState!=="disconnected"&&(this.self.roomState="disconnected",this.self.emit("roomLeft",{state:"disconnected"}))}),R.on(k.ROOM_NODE_FAILED,()=>{this.self.roomState="failed",this.self.emit("roomLeft",{state:"failed"})}),R.on(k.SOCKET_SERVICE_RECONNECTED,({wasJoinAttempted:s})=>{s===!1&&(this.self.roomState="init"),this.resetSelf(s)}),R.on(k.SOCKET_SERVICE_DISCONNECTED,({joinAttempted:s})=>{if(this.self.roomState==="disconnected")return;let{peerId:t}=this;s&&ee.hasFeature(se.REFRESH_ID_ON_DISCONNECTION)&&(t=Jn()),o(this,jr).updateURL(t),T.resetPeerId(t),nt().setHeader("dyte-tracing-id",t),tn.remapContext(t,o(this,ot)),this.self.roomState="disconnected",this.self.emit("roomLeft",{state:"disconnected"})}),R.on(k.SOCKET_SERVICE_FAILED,()=>{this.self.roomState="failed",this.self.emit("roomLeft",{state:"failed"})}),o(this,Ss).on(V.waitingRoomRequestAccepted,()=>{this.waitlistAcceptHandler()}),o(this,Ss).on(Nc.updateUserPreset,s=>{s.updatePeersPresets.forEach(t=>{t.userIds===this.self.userId&&R.emit(k.UPDATE_PERMISSIONS,t.patch)})}),o(this,Ss).on(V.waitingRoomRequestDenied,()=>{this.waitlistRejectedHandler()}),o(this,Ss).on(V.kick,()=>{this.kickHandler({kickType:"kick"})}),o(this,Ss).on(V.kickAll,()=>{this.kickHandler({kickType:"kickAll"})}),R.onAsync(k.JOIN_MEDIA_ROOM,this.joinMediaRoom.bind(this)),R.on(k.PRODUCER_SCORE_UPDATE,({score:s,kind:t,appData:e,scoreStats:r})=>{var i;const n=(i=e==null?void 0:e.screenShare)!=null?i:!1;this.self.emit("mediaScoreUpdate",{kind:t,isScreenshare:n,score:s,participantId:this.self.id,scoreStats:r})}),R.on(k.MUTE_SELF,async()=>{this.self.audioEnabled&&(await this.self.disableAudio(),j.audioOff())}),R.on(k.MUTE_SELF_VIDEO,async()=>{this.self.videoEnabled&&(await this.self.disableVideo(),j.videoOff())}),R.onAsync(k.LEAVE_MEDIA_ROOM,this.leaveMediaRoom.bind(this)),R.on(k.PIP_HANGUP,this.leaveRoom.bind(this))}async joinRoom(s=!1){try{const{peer:t}=await o(this,Ss).joinRoom(this.self);o(this,Ss).socket.flush();const e=Jl(t.stageType);if(o(this,ot).setValue("stageStatus",e,!1),t.waitlisted){this.waitlistedHandler();return}await this.joinMediaRoom(s),o(this,ot).notify("stageStatus")}catch(t){throw u.error("Error in joinRoom",{error:t}),t}}async leaveRoom(s="left"){var t,e;if(s==="rejected"){try{(t=o(this,jr))==null||t.disconnect()}catch(r){u.error("SelfController::leaveRoom::socketDisconnect")}this.self.roomState=s,this.self.emit("roomLeft",{state:s});return}this.self.setIsPinned(!1),o(this,ot).setValue("stageStatus","OFF_STAGE",!1),await this.leaveMediaRoom(s),o(this,ot).notify("stageStatus");try{(e=o(this,jr))==null||e.disconnect()}catch(r){u.error("SelfController::leaveRoom::socketDisconnect")}wf(o(this,ot)),Gc.cleanup(),this.self.roomState=s,this.self.emit("roomLeft",{state:s})}partialMediaRoom(){var s;return(s=o(this,Vt,as))==null?void 0:s.partialJoinRoom(this.self.name,o(this,ot).getValue("meetingId"),void 0)}async joinMediaRoom(s=!1){var c,d;const{peerId:t,viewType:e,meetingId:r,stageStatus:n,roomNodeOptions:i}=o(this,ot).getAllValues(),{sfu:a}=i;try{if(e===yt.Livestream){if(n!=="ON_STAGE"){this.self.roomState="joined",this.self.emit("roomJoined",{reconnected:s});return}bf(o(this,ot),a,{socket:o(this,jr),peerId:t})}const{roomJoined:l}=(d=await((c=o(this,Vt,as))==null?void 0:c.joinRoom(this.self.name,r,{audio:this.self.audioEnabled,video:this.self.videoEnabled,screen:this.self.screenShareEnabled},s,s)))!=null?d:{};if(!l)return;n==="ON_STAGE"&&await this.shareMediaTracks(),this.self.roomState="joined",this.self.emit("roomJoined",{reconnected:s})}catch(l){throw u.error("Error:SelfController.mediaRoomJoin",l),new P("Error: could not join media room","0002")}}async leaveMediaRoom(s){const t=o(this,ot).getValue("viewType");s!=="connected-meeting"&&await this.cleanupSelf(),!(s==="stageLeft"&&t===yt.Webinar)&&o(this,Vt,as)&&(o(this,Vt,as).mediaJoined&&s!=="disconnected"&&await o(this,Vt,as).leaveRoom(),!(s==="stageLeft"&&t===yt.Livestream)&&(o(this,Vt,as).mediaJoined=!1))}async cleanupSelf(){await this.self.disableAudio(),await this.self.disableVideo(),await this.self.disableScreenShare(),this.self.cleanUpTracks(),this.self.destructMediaHandler(),navigator.isReactNative||this.self.removeDocumentEventListeners()}},jr=new WeakMap,Ss=new WeakMap,ot=new WeakMap,Vt=new WeakSet,as=function(){return o(this,ot).getValue("roomNodeClient")},lg);let Sr=Pf;gn([T.trace("SelfController.resetSelf")],Sr.prototype,"resetSelf",1),gn([T.trace("SelfController.setupEvents")],Sr.prototype,"setupEvents",1),gn([T.trace("SelfController.joinRoom")],Sr.prototype,"joinRoom",1),gn([T.trace("SelfController.leaveRoom")],Sr.prototype,"leaveRoom",1),gn([T.trace("SelfController.joinMediaRoom")],Sr.prototype,"joinMediaRoom",1),gn([T.trace("SelfController.leaveMediaRoom")],Sr.prototype,"leaveMediaRoom",1),gn([T.trace("SelfController.init")],Sr,"init",1);class JM{constructor(t){g(this,wo,void 0);v(this,wo,t)}on(t,e){let r;t===V.roomPeerCount?r=fm.fromBinary.bind(fm):r=Mm.fromBinary.bind(Mm),o(this,wo).on(t,({payload:n})=>{const i=r(n);return e(i)})}}wo=new WeakMap;class KM{constructor(t){g(this,Po,void 0);v(this,Po,t)}on(t,e){let r,n;switch(t){case V.transcript:{r=Rl.fromBinary.bind(Rl),n=Rl.create();break}default:{u.debug("AISocketHandler switch case hit default, event not accounted for.");break}}o(this,Po).on(t,({payload:i})=>{let a=n;try{a=r(i)}catch(c){u.error("chatSocketHandler::on::binary_decode_error",{error:c})}return e(a)})}}Po=new WeakMap;var zM=Object.defineProperty,YM=Object.getOwnPropertyDescriptor,mu=(s,t,e,r)=>{for(var n=r>1?void 0:r?YM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&zM(t,e,n),n};class ed{constructor(t){g(this,ir,void 0);v(this,ir,t)}getPolls(){return o(this,ir).sendMessagePromise(Hs.getPolls)}createPoll(t,e,r=!1,n=!1){const i={anonymous:r,hideVotes:n,question:t,options:e};return o(this,ir).sendMessage(Hs.createPoll,DI.toBinary(i))}votePoll(t,e){const r={index:e,pollId:t};return o(this,ir).sendMessage(Hs.votePoll,NI.toBinary(r))}on(t,e){let r,n;switch(t){case Hs.updatePoll:case Hs.createPoll:case Hs.votePoll:{r=Bl.fromBinary.bind(Bl),n=Bl.create();break}}o(this,ir).on(t,({payload:i})=>{let a=n;try{a=r(i)}catch(c){u.error("pollSocketHandler::on::binary_decode_error",{error:c})}return e(a)})}removeListeners(t){o(this,ir).removeListeners(t)}}ir=new WeakMap,mu([T.trace("PollSocketHandler.getPolls")],ed.prototype,"getPolls",1),mu([T.trace("PollSocketHandler.createPoll")],ed.prototype,"createPoll",1),mu([T.trace("PollSocketHandler.votePoll")],ed.prototype,"votePoll",1);class QM{constructor(t){g(this,Ut,void 0);v(this,Ut,t)}async getStageRequests(){const{payload:t}=await o(this,Ut).sendMessagePromise(V.getStageRequests);return t?Fl.fromBinary(t):{stageRequests:[]}}requestAccess(){o(this,Ut).sendMessage(V.requestStageAccess)}cancelRequestAccess(){o(this,Ut).sendMessage(V.cancelStageRequest)}async grantAccess(t){const e={userIds:t};o(this,Ut).sendMessage(V.grantStageAccess,_I.toBinary(e))}async denyAccess(t){const e={userIds:t};o(this,Ut).sendMessage(V.denyStageAccess,wI.toBinary(e))}joinStage(){return o(this,Ut).sendMessagePromise(V.joinStage,void 0,void 0,V.peerStageStatusUpdate)}leaveStage(t){const e={userIds:[t]};return o(this,Ut).sendMessagePromise(V.leaveStage,Om.toBinary(e),void 0,V.peerStageStatusUpdate)}kick(t){const e={userIds:t};return o(this,Ut).sendMessagePromise(V.leaveStage,Om.toBinary(e))}on(t,e){let r;switch(t){case V.grantStageAccess:case V.denyStageAccess:{r=void 0;break}case V.getStagePeers:{r=Dm.fromBinary.bind(Dm);break}case V.getStageRequests:case V.requestStageAccess:case V.cancelStageRequest:{r=Fl.fromBinary.bind(Fl);break}case V.peerStageStatusUpdate:{r=mm.fromBinary.bind(mm);break}}o(this,Ut).on(t,({payload:n,id:i})=>{if(!n||!r)return e(void 0,i);const a=r(n);return e(a,i)})}async getPeerInfo(t){const e=await o(this,Ut).sendMessagePromise(V.getPeerInfo,Tm.toBinary({peerId:t}));return Zn.fromBinary(e.payload)}}Ut=new WeakMap;class XM{constructor(t){g(this,Qe,void 0);v(this,Qe,t)}addPlugin(t,e){o(this,Qe).sendMessage(W.addPlugin,Fk.toBinary({pluginId:t,staggered:e}))}removePlugin(t){o(this,Qe).sendMessage(W.removePlugin,$k.toBinary({pluginId:t,staggered:!1}))}async getActivePlugins(){const{payload:t}=await o(this,Qe).sendMessagePromise(W.getPlugins);return t?lI.fromBinary(t):{plugins:[]}}customPluginEventToRoom(t,e,r){const n={pluginId:t,pluginData:new TextEncoder().encode(JSON.stringify(e))};o(this,Qe).sendMessage(W.customPluginEventToRoom,Qk.toBinary(n),r)}customPluginEventToPeers(t,e,r,n){const i={pluginId:t,peerIds:e,pluginData:new TextEncoder().encode(JSON.stringify(r))};o(this,Qe).sendMessage(W.customPluginEventToPeers,Zk.toBinary(i),n)}enablePluginForRoom(t,e){o(this,Qe).sendMessage(W.enablePluginForRoom,qk.toBinary({pluginId:t}),e)}enablePluginForPeers(t,e,r){o(this,Qe).sendMessage(W.enablePluginForPeers,Jk.toBinary({pluginId:t,peerIds:e}),r)}disablePluginForRoom(t,e){o(this,Qe).sendMessage(W.disablePluginForRoom,Gk.toBinary({pluginId:t}),e)}disablePluginForPeers(t,e,r){o(this,Qe).sendMessage(W.disablePluginForPeers,zk.toBinary({pluginId:t,peerIds:e}),r)}storeInsertKeys(t,e,r,n){const i={pluginId:t,storeName:e,insertKeys:r.map(a=>({storeKey:a.key,payload:new TextEncoder().encode(JSON.stringify(a.payload))}))};o(this,Qe).sendMessage(W.storeInsertKeys,Rm.toBinary(i),n)}storeGetKeys(t,e,r,n){const i={pluginId:t,storeName:e,getKeys:r.map(a=>({storeKey:a.key}))};o(this,Qe).sendMessage(W.storeGetKeys,rI.toBinary(i),n)}storeDeleteKeys(t,e,r,n){const i={pluginId:t,storeName:e,deleteKeys:r.map(a=>({storeKey:a.key}))};o(this,Qe).sendMessage(W.storeDeleteKeys,iI.toBinary(i),n)}storeDelete(t,e,r){o(this,Qe).sendMessage(W.storeDelete,oI.toBinary({pluginId:t,storeName:e}),r)}getPluginDataOld(t,e){u.info("getPluginDataOld",{plugin:{id:t,storeName:e}})}storePluginDataOld(t,e,r){const n={pluginId:t,storeName:e,insertKeys:[{storeKey:r.key,payload:new TextEncoder().encode(JSON.stringify(r))}]};o(this,Qe).sendMessage(W.storeInsertKeys,Rm.toBinary(n))}on(t,e){let r;switch(t){case W.addPlugin:case W.enablePluginForPeers:case W.enablePluginForRoom:{r=Ul.fromBinary.bind(Ul);break}case W.removePlugin:case W.disablePluginForPeers:case W.disablePluginForRoom:{r=km.fromBinary.bind(km);break}case W.customPluginEventToPeers:case W.customPluginEventToRoom:{r=Am.fromBinary.bind(Am);break}case W.storeInsertKeys:case W.storeGetKeys:case W.storeDeleteKeys:case W.storeDelete:{r=Im.fromBinary.bind(Im);break}}o(this,Qe).on(t,({payload:n,id:i})=>{const a=r(n);return e(a,i)})}}Qe=new WeakMap;var ZM=Object.defineProperty,eD=(s,t,e)=>t in s?ZM(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,tD=(s,t,e)=>(eD(s,typeof t!="symbol"?t+"":t,e),e),fu=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)},O=(s,t,e)=>(fu(s,t,"read from private field"),e?e.call(s):t.get(s)),we=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},ue=(s,t,e,r)=>(fu(s,t,"write to private field"),r?r.call(s,e):t.set(s,e),e),ke=(s,t,e)=>(fu(s,t,"access private method"),e),Er,vn,Tn,xe,yn,Ie,Be,_r,tt,Gs,br,gs,ci,Ws,gu,Cf,xa,td,vu,Rf,Tu,kf,sd,yu,Su,If,Va,rd,Ua,nd,id,Eu,di,Fa,Ba,ad,_u={exports:{}},li=typeof Reflect=="object"?Reflect:null,Af=li&&typeof li.apply=="function"?li.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)},od;li&&typeof li.ownKeys=="function"?od=li.ownKeys:Object.getOwnPropertySymbols?od=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:od=function(t){return Object.getOwnPropertyNames(t)};function sD(s){console&&console.warn&&console.warn(s)}var Mf=Number.isNaN||function(t){return t!==t};function pe(){pe.init.call(this)}_u.exports=pe,_u.exports.once=aD,pe.EventEmitter=pe,pe.prototype._events=void 0,pe.prototype._eventsCount=0,pe.prototype._maxListeners=void 0;var Df=10;function cd(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(pe,"defaultMaxListeners",{enumerable:!0,get:function(){return Df},set:function(s){if(typeof s!="number"||s<0||Mf(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");Df=s}}),pe.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},pe.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Mf(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Of(s){return s._maxListeners===void 0?pe.defaultMaxListeners:s._maxListeners}pe.prototype.getMaxListeners=function(){return Of(this)},pe.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var n=t==="error",i=this._events;if(i!==void 0)n=n&&i.error===void 0;else if(!n)return!1;if(n){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var c=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw c.context=a,c}var d=i[t];if(d===void 0)return!1;if(typeof d=="function")Af(d,this,e);else for(var l=d.length,h=Uf(d,l),r=0;r<l;++r)Af(h[r],this,e);return!0};function Nf(s,t,e,r){var n,i,a;if(cd(e),i=s._events,i===void 0?(i=s._events=Object.create(null),s._eventsCount=0):(i.newListener!==void 0&&(s.emit("newListener",t,e.listener?e.listener:e),i=s._events),a=i[t]),a===void 0)a=i[t]=e,++s._eventsCount;else if(typeof a=="function"?a=i[t]=r?[e,a]:[a,e]:r?a.unshift(e):a.push(e),n=Of(s),n>0&&a.length>n&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=s,c.type=t,c.count=a.length,sD(c)}return s}pe.prototype.addListener=function(t,e){return Nf(this,t,e,!1)},pe.prototype.on=pe.prototype.addListener,pe.prototype.prependListener=function(t,e){return Nf(this,t,e,!0)};function rD(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Lf(s,t,e){var r={fired:!1,wrapFn:void 0,target:s,type:t,listener:e},n=rD.bind(r);return n.listener=e,r.wrapFn=n,n}pe.prototype.once=function(t,e){return cd(e),this.on(t,Lf(this,t,e)),this},pe.prototype.prependOnceListener=function(t,e){return cd(e),this.prependListener(t,Lf(this,t,e)),this},pe.prototype.removeListener=function(t,e){var r,n,i,a,c;if(cd(e),n=this._events,n===void 0)return this;if(r=n[t],r===void 0)return this;if(r===e||r.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if(typeof r!="function"){for(i=-1,a=r.length-1;a>=0;a--)if(r[a]===e||r[a].listener===e){c=r[a].listener,i=a;break}if(i<0)return this;i===0?r.shift():nD(r,i),r.length===1&&(n[t]=r[0]),n.removeListener!==void 0&&this.emit("removeListener",t,c||e)}return this},pe.prototype.off=pe.prototype.removeListener,pe.prototype.removeAllListeners=function(t){var e,r,n;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[t]),this;if(arguments.length===0){var i=Object.keys(r),a;for(n=0;n<i.length;++n)a=i[n],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=r[t],typeof e=="function")this.removeListener(t,e);else if(e!==void 0)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this};function xf(s,t,e){var r=s._events;if(r===void 0)return[];var n=r[t];return n===void 0?[]:typeof n=="function"?e?[n.listener||n]:[n]:e?iD(n):Uf(n,n.length)}pe.prototype.listeners=function(t){return xf(this,t,!0)},pe.prototype.rawListeners=function(t){return xf(this,t,!1)},pe.listenerCount=function(s,t){return typeof s.listenerCount=="function"?s.listenerCount(t):Vf.call(s,t)},pe.prototype.listenerCount=Vf;function Vf(s){var t=this._events;if(t!==void 0){var e=t[s];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}pe.prototype.eventNames=function(){return this._eventsCount>0?od(this._events):[]};function Uf(s,t){for(var e=new Array(t),r=0;r<t;++r)e[r]=s[r];return e}function nD(s,t){for(;t+1<s.length;t++)s[t]=s[t+1];s.pop()}function iD(s){for(var t=new Array(s.length),e=0;e<t.length;++e)t[e]=s[e].listener||s[e];return t}function aD(s,t){return new Promise(function(e,r){function n(a){s.removeListener(t,i),r(a)}function i(){typeof s.removeListener=="function"&&s.removeListener("error",n),e([].slice.call(arguments))}Ff(s,t,i,{once:!0}),t!=="error"&&oD(s,n,{once:!0})})}function oD(s,t,e){typeof s.on=="function"&&Ff(s,"error",t,e)}function Ff(s,t,e,r){if(typeof s.on=="function")r.once?s.once(t,e):s.on(t,e);else if(typeof s.addEventListener=="function")s.addEventListener(t,function n(i){r.once&&s.removeEventListener(t,n),e(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var cD=_u.exports;class dD extends S{constructor(){super("message.v1.SocketMessage",[{no:1,name:"event",kind:"scalar",T:13},{no:2,name:"id",kind:"scalar",opt:!0,T:9},{no:3,name:"payload",kind:"scalar",opt:!0,T:12},{no:4,name:"metadata",kind:"scalar",opt:!0,T:12}])}}const Bf=new dD;class $f{static encode(t){return Bf.toBinary(t)}static decode(t){return Bf.fromBinary(new Uint8Array(t))}}function lD(s,t){return Math.floor(Math.random()*(t-s+1)+s)}class uD{constructor(t={}){tD(this,"opts"),we(this,Er,void 0),this.opts={initialTimeout:t.initialTimeout||1e3,maxTimeout:t.maxTimeout||1e4,factor:t.factor||2},ue(this,Er,0)}async wait(){ue(this,Er,O(this,Er)+1);const t=lD(0,Math.min(this.opts.maxTimeout,this.opts.initialTimeout*2**O(this,Er)));await new Promise(e=>{setTimeout(e,t)})}getAttempts(){return O(this,Er)}reset(){ue(this,Er,0)}}Er=new WeakMap;const wr={debug:0,info:1,warn:2,error:3};class hD{constructor(t){we(this,vn,void 0),we(this,Tn,void 0),ue(this,vn,console),ue(this,Tn,t)}debug(...t){wr[O(this,Tn)]>wr.debug||O(this,vn).debug("[Sockrates]:",...t)}info(...t){wr[O(this,Tn)]>wr.info||O(this,vn).info("[Sockrates]:",...t)}warn(...t){wr[O(this,Tn)]>wr.warn||O(this,vn).warn("[Sockrates]:",...t)}error(...t){wr[O(this,Tn)]>wr.error||O(this,vn).error("[Sockrates]:",...t)}}vn=new WeakMap,Tn=new WeakMap;var Hf=(s=>(s[s.CONNECTING=0]="CONNECTING",s[s.OPEN=1]="OPEN",s[s.CLOSING=2]="CLOSING",s[s.CLOSED=3]="CLOSED",s))(Hf||{});const pD="2",mD="3";class fD{constructor(t,e){we(this,gu),we(this,xa),we(this,vu),we(this,Tu),we(this,sd),we(this,Su),we(this,Va),we(this,Ua),we(this,id),we(this,di),we(this,Ba),we(this,xe,void 0),we(this,yn,void 0),we(this,Ie,void 0),we(this,Be,void 0),we(this,_r,void 0),we(this,tt,void 0),we(this,Gs,void 0),we(this,br,void 0),we(this,gs,void 0),we(this,ci,void 0),we(this,Ws,void 0);var r,n,i,a,c,d,l,h,m,f,y,_,b,I,L,B,q,F,X;ue(this,yn,t),ue(this,_r,[]),ue(this,tt,new cD),ue(this,Gs,!0),ue(this,gs,!1),ue(this,Ie,e!=null?e:{}),(n=(r=O(this,Ie)).autoReconnect)!=null||(r.autoReconnect=!0),(a=(i=O(this,Ie)).retryConnectionInterval)!=null||(i.retryConnectionInterval=1e3),(d=(c=O(this,Ie)).pingTimeout)!=null||(c.pingTimeout=3e4),(h=(l=O(this,Ie)).connectionTimeout)!=null||(l.connectionTimeout=5e3),(f=(m=O(this,Ie)).debug)!=null||(m.debug=!0),(_=(y=O(this,Ie)).maxReconnectionAttempts)!=null||(y.maxReconnectionAttempts=10),(I=(b=O(this,Ie)).disconnectOnPingTimeout)!=null||(b.disconnectOnPingTimeout=!0),(B=(L=O(this,Ie)).queueOnDisconnect)!=null||(L.queueOnDisconnect=!1),(F=(q=O(this,Ie)).flushOnReconnect)!=null||(q.flushOnReconnect=!1),ue(this,br,{code:void 0,reason:void 0}),ue(this,Be,(X=O(this,Ie).logger)!=null?X:new hD(O(this,Ie).debug?"debug":"info")),ue(this,Ws,new uD)}get readyState(){var t;return(t=O(this,xe))==null?void 0:t.readyState}get url(){return O(this,yn)}updateURL(t){ue(this,yn,t),ke(this,Su,If).call(this)}get config(){return O(this,Ie)}get sendQueue(){return O(this,_r)}flush(){if(!O(this,Ie).queueOnDisconnect)return!1;const t=[];return O(this,_r).forEach(e=>{this.send(e.event,e.id,e.payload,e.metadata)||t.push(e)}),ue(this,_r,t),O(this,_r)}async connect(t=!1){if(!t&&[0,1].includes(this.readyState)){O(this,Be).debug("Websocket was already connecting or connected.");return}if(O(this,Gs)!==!1)return new Promise((e,r)=>{ke(this,di,Fa).call(this),ke(this,Ba,ad).call(this);try{ue(this,xe,new WebSocket(ke(this,gu,Cf).call(this,O(this,yn)))),O(this,xe).binaryType="arraybuffer",O(this,Be).debug("Connecting to",O(this,yn));const n=setTimeout(()=>{O(this,Be).debug("Connection timeout. Closing socket"),ue(this,Gs,!0),ke(this,Ba,ad).call(this),O(this,xe).close(3001,"Connection Timeout"),O(this,Ie).autoReconnect&&!O(this,gs)&&(O(this,tt).emit("reconnecting"),ke(this,Va,rd).call(this)),r(new Error("Connection timed out!"))},O(this,Ie).connectionTimeout);O(this,xe).onopen=()=>{O(this,Be).debug(`Ready State: ${Hf[O(this,xe).readyState]}`),n&&clearTimeout(n),ke(this,id,Eu).call(this),ue(this,br,{code:void 0,reason:void 0}),O(this,tt).emit("connected"),O(this,Ie).flushOnReconnect&&this.flush(),e()},O(this,xe).onclose=i=>{try{n&&clearTimeout(n);const{code:a,reason:c}=i;r(c),O(this,Be).debug("Socket closed. Close event:",i),O(this,Be).debug("Connection closed code:",a),O(this,Be).debug("Connection closed reason:",c),O(this,gs)||ke(this,sd,yu).call(this,a,c)}catch(a){ke(this,xa,td).call(this,a)}},O(this,xe).onerror=i=>{ke(this,xa,td).call(this,i)},O(this,xe).onmessage=i=>ke(this,vu,Rf).call(this,i)}catch(n){ke(this,xa,td).call(this,n,r)}})}send(t,e,r,n){const i={event:t,id:e,payload:r,metadata:n};if(O(this,Ie).queueOnDisconnect&&(!O(this,xe)||O(this,xe).readyState!==1))return O(this,Be).debug("Queuing message since socket is not connected!",i),O(this,_r).push(i),!1;const a=$f.encode(i);return ke(this,Ua,nd).call(this,a)}emit(t,e,r,n){return this.send(t,e,r,n)}sendRaw(t){return ke(this,Ua,nd).call(this,t)}receive(t,e){return O(this,tt).on(t.toString(),e)}on(t,e){if(typeof t=="string"&&(t==="connected"||t==="disconnected"||t==="errored"||t==="reconnected"||t==="reconnecting"||t==="reconnectAttempt"||t==="reconnectFailure"||t==="failed")){O(this,tt).on(t,e);return}this.receive(t,e)}removeAllListeners(){O(this,tt).removeAllListeners()}removeReceiver(t,e){this.removeListener(t,e)}removeListener(t,e){O(this,tt).removeListener(t.toString(),e)}removeReceivers(t){this.removeListeners(t)}removeListeners(t){O(this,tt).listeners(t.toString()).map(e=>this.removeListener(t,e))}disconnect(){ue(this,Gs,!1),ke(this,di,Fa).call(this),this.removeAllListeners(),ue(this,br,{code:1e3,reason:"Sockrates disconnect method called"}),O(this,xe).close(1e3,"Sockrates disconnect method called.")}}xe=new WeakMap,yn=new WeakMap,Ie=new WeakMap,Be=new WeakMap,_r=new WeakMap,tt=new WeakMap,Gs=new WeakMap,br=new WeakMap,gs=new WeakMap,ci=new WeakMap,Ws=new WeakMap,gu=new WeakSet,Cf=function(s){if(s.startsWith("ws://")||s.startsWith("wss://"))return s;if(s.startsWith("https://"))return`wss://${s.substring(8)}`;if(s.startsWith("http://"))return`ws://${s.substring(7)}`;throw new Error("Invalid URL. URL must start with http(s):// or ws(s)://.")},xa=new WeakSet,td=function(s,t){O(this,Be).error("Error:",{error:s}),O(this,tt).emit("errored",{error:s}),t==null||t(s)},vu=new WeakSet,Rf=function(s){if(ke(this,id,Eu).call(this),s.data===pD){O(this,Be).debug("Received ping from server"),ke(this,Ua,nd).call(this,mD);return}const t=$f.decode(s.data),{id:e,payload:r}=t;O(this,Be).debug("Received message",{event:t.event,messageID:e}),O(this,tt).emit(t.event.toString(),{id:e,payload:r})},Tu=new WeakSet,kf=function(){return O(this,xe).readyState===1},sd=new WeakSet,yu=function(s,t){ue(this,br,{reason:t,code:s}),O(this,tt).emit("disconnected",{code:s,reason:t})},Su=new WeakSet,If=function(){const{reason:s,code:t}=O(this,br);t&&t!==1e3&&O(this,Gs)&&O(this,Ie).autoReconnect&&!O(this,gs)&&(O(this,Be).debug(`Triggering reconnection due to ${s}.`),O(this,tt).emit("reconnecting"),ke(this,Va,rd).call(this))},Va=new WeakSet,rd=async function(s=!0){if(s&&O(this,gs)){O(this,Be).debug("Reconnect called when already in a reconnect loop. Ignoring.");return}if(O(this,gs)||O(this,Ws).reset(),O(this,Ie).maxReconnectionAttempts!==null&&O(this,Ws).getAttempts()>=O(this,Ie).maxReconnectionAttempts){O(this,tt).emit("failed"),ue(this,gs,!1);return}ue(this,gs,!0),ke(this,Ba,ad).call(this),ke(this,di,Fa).call(this);try{if(await O(this,Ws).wait(),O(this,Gs)===!1)return;if(O(this,Be).debug(`Reconnection attempt ${O(this,Ws).getAttempts()}`),O(this,tt).emit("reconnectAttempt",{attempt:O(this,Ws).getAttempts()}),await this.connect(),!ke(this,Tu,kf).call(this))throw Error("Reconnect Failed");ue(this,gs,!1),ue(this,br,{code:void 0,reason:void 0}),O(this,tt).emit("reconnected")}catch(t){O(this,Be).debug("Failed to reconnect."),O(this,tt).emit("reconnectFailure",{attempt:O(this,Ws).getAttempts()}),ke(this,Va,rd).call(this,!1)}},Ua=new WeakSet,nd=function(s){try{return O(this,xe).send(s),!0}catch(t){return O(this,Be).error(t.message),!1}},id=new WeakSet,Eu=function(){this.config.disconnectOnPingTimeout&&(O(this,Be).debug("Resetting ping timeout"),ke(this,di,Fa).call(this),ue(this,ci,setTimeout(()=>{var s;O(this,Be).debug("Disconnecting the socket due to ping timeout"),ue(this,Gs,!0);const t=3002,e="Ping timeout";(s=O(this,xe))==null||s.close(t,e),ke(this,sd,yu).call(this,t,e)},O(this,Ie).pingTimeout)))},di=new WeakSet,Fa=function(){O(this,ci)&&(clearTimeout(O(this,ci)),ue(this,ci,void 0))},Ba=new WeakSet,ad=function(){O(this,xe)&&(O(this,xe).onopen=void 0,O(this,xe).onerror=void 0,O(this,xe).onmessage=void 0,O(this,xe).onclose=void 0)};var gD=Object.defineProperty,vD=Object.getOwnPropertyDescriptor,dd=(s,t,e,r)=>{for(var n=r>1?void 0:r?vD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&gD(t,e,n),n};const qf=65535,TD=3e3,jf=(ug=class{constructor(s,{peerId:t,meetingId:e,authToken:r,capabilities:n}){g(this,Oe);g(this,Co);g(this,Ro);g(this,Gr,void 0);g(this,De,void 0);p(this,"roomName");p(this,"authToken");p(this,"capabilities");g(this,ns,void 0);g(this,ar,void 0);var i;if(!t||!e||!r)throw new P("peerId, meetingId, or authToken can not be empty","0404");v(this,ns,void 0),v(this,ar,s),this.capabilities=n,this.roomName=e,this.authToken=r,v(this,Gr,$(this,Co,Hu).call(this,t)),v(this,De,new fD(o(this,Gr),{autoReconnect:!0,disconnectOnPingTimeout:(i=n.includes("PING"))!=null?i:!1,queueOnDisconnect:!0,flushOnReconnect:!1,logger:u})),this.handleSocketConnectionEvents()}get joinAttempted(){return o(this,Oe,Ge).socketJoinAttempted}set joinAttempted(s){o(this,Oe,Ge).socketJoinAttempted=s}get peerId(){return o(this,ar).getValue("peerId")}updateURL(s){s!==this.peerId&&(v(this,Gr,$(this,Co,Hu).call(this,s)),u.debug("SocketService:: Connection URL updated.")),o(this,De).updateURL(o(this,Gr))}static getSocketEdgeDomain(s){return Qn({servicePrefix:"socket-edge",baseURI:s})}get url(){return o(this,Gr)}async connect(){o(this,Oe,Ge).socketJoinAttempted=!0,await o(this,De).connect(),o(this,Oe,Ge).socketJoinAttempted=!0,o(this,Oe,Ge).socketState={state:"connected",reconnected:!1,reconnectionAttempt:void 0}}async disconnect(){o(this,Oe,Ge).socketJoinAttempted=!1,o(this,De).disconnect(),o(this,Oe,Ge).socketJoinAttempted=!0,o(this,Oe,Ge).socketState={state:"disconnected",reconnected:!1,reconnectionAttempt:void 0}}get isConnected(){try{return o(this,De).readyState===1}catch(s){return!1}}sendMessage(s,t,e){const r={};return T.injectContext(r),o(this,De).send(s,e!=null?e:$(this,Ro,qu).call(this),t,new TextEncoder().encode(JSON.stringify(r)))}sendMessagePromise(s,t,e,r){const n=parseInt({}.SOCKET_SERVICE_MESSAGE_REQUEST_TIMEOUT,10)||2e4;return this.sendMessagePromiseWithTimeout({event:s,timeout:n,protobuf:t,messageId:e,resp:r})}sendMessagePromiseWithTimeout({event:s,timeout:t,protobuf:e,messageId:r,resp:n}){const i=n!=null?n:s;return new Promise((a,c)=>{const d=(y,_)=>{o(this,De).removeListener(i,y),o(this,De).removeListener(qf,_),o(this,De).removeListener(Kt.errorResponse,_),o(this,De).removeListener(us.errorResponse,_)},l=r!=null?r:$(this,Ro,qu).call(this),h={};T.injectContext(h);const m=({id:y,payload:_})=>{if(l===y){let b;try{const I=Zw.fromBinary(_);b=new Error(I.errorMessage)}catch(I){b=new Error("failed to parse error message",{cause:I});try{const L=tC.fromBinary(_);b=new Error(L.message)}catch(L){b=new Error("failed to parse error message",{cause:L})}}c(b),d(f,m)}},f=({id:y,payload:_})=>{l===y&&(a({id:y,payload:_}),d(f,m))};o(this,De).on(i,f),o(this,De).on(qf,m),o(this,De).on(Kt.errorResponse,m),o(this,De).on(us.errorResponse,m),setTimeout(()=>{d(f,m),c(new Error(`request timeout for callback eventId:${s}`))},t),o(this,De).send(s,l,e,new TextEncoder().encode(JSON.stringify(h)))})}on(s,t){o(this,De).on(s,t)}onStateEvent(s,t){o(this,De).on(s,t)}removeListener(s,t){o(this,De).removeListener(s,t)}removeListeners(s){o(this,De).removeListeners(s)}flush(){return o(this,De).flush()}handleSocketConnectionEvents(){this.onStateEvent("connected",async()=>{u.info("SocketService::Connected to socket-edge"),o(this,ns)&&(clearTimeout(o(this,ns)),v(this,ns,void 0)),o(this,Oe,Ge).updateSocketConnectionState("connected")}),this.onStateEvent("disconnected",({code:s,reason:t})=>{var n;u.info("SocketService::Disconnected from socket-edge",{error:{code:s,reason:t},country:T.location.country});const{recv:e,send:r}=(n=o(this,Oe,Ge).mediaState)!=null?n:{};e!=null&&e.state&&(e==null?void 0:e.state)!==vr.CONNECTED||r!=null&&r.state&&(r==null?void 0:r.state)!==vr.CONNECTED?R.emit(k.SOCKET_SERVICE_DISCONNECTED,{joinAttempted:o(this,Oe,Ge).joinAttempted}):v(this,ns,setTimeout(()=>{R.emit(k.SOCKET_SERVICE_DISCONNECTED,{joinAttempted:o(this,Oe,Ge).joinAttempted}),v(this,ns,void 0)},TD)),o(this,Oe,Ge).updateSocketConnectionState("disconnected")}),this.onStateEvent("reconnecting",async()=>{u.info("SocketService::Reconnecting to socket-edge",{country:T.location.country}),o(this,Oe,Ge).updateSocketConnectionState("reconnecting")}),this.onStateEvent("reconnectAttempt",async({attempt:s})=>{u.info("SocketService::Attempting to reconnect to socket-edge",{socket:{retryAttempt:s}}),o(this,Oe,Ge).updateSocketConnectionState("reconnectAttempt",s)}),this.onStateEvent("reconnectFailure",({attempt:s})=>{u.info("SocketService::Reconnect attempt to socket-edge failed",{socket:{retryAttempt:s}}),o(this,Oe,Ge).updateSocketConnectionState("reconnectFailure",s)}),this.onStateEvent("reconnected",async()=>{u.info("SocketService::Reconnected to socket-edge",{connectionState:{joinAttempted:o(this,Oe,Ge).mediaJoinAttempted}}),o(this,ns)&&(clearTimeout(o(this,ns)),v(this,ns,void 0)),R.emit(k.SOCKET_SERVICE_RECONNECTED,{wasJoinAttempted:o(this,Oe,Ge).mediaJoinAttempted}),o(this,Oe,Ge).updateSocketConnectionState("reconnected")}),this.onStateEvent("failed",async()=>{u.info("SocketService::Failed to connect to socket-edge",{country:T.location.country}),R.emit(k.SOCKET_SERVICE_FAILED),o(this,Oe,Ge).updateSocketConnectionState("failed")})}},Gr=new WeakMap,De=new WeakMap,Oe=new WeakSet,Ge=function(){return o(this,ar).getValue("connectionHandler")},ns=new WeakMap,ar=new WeakMap,Co=new WeakSet,Hu=function(s){let t=jf.getSocketEdgeDomain(o(this,ar).getValue("baseURI"));typeof gc(o(this,ar),"socket_server_base")=="string"&&(t=gc(o(this,ar),"socket_server_base"));const e=`wss://${t}`,r=new URL(`${e}/ws`),n=this.peerId,i={roomID:this.roomName,peerID:s,authToken:this.authToken,useMediaV2:!0,...n!==s&&{oldPeerID:n},ping:this.capabilities.includes("PING"),capabilities:this.capabilities.map(a=>Ic[a]).join(" "),joinWithDetails:!0,useCfWorker:!0};return Object.entries(i).forEach(([a,c])=>{r.searchParams.append(a,c.toString())}),r.href},Ro=new WeakSet,qu=function(){return`${this.peerId}-${(Math.random()+1).toString(36).substring(7)}`},ug);let $a=jf;dd([T.trace("SocketService.connect")],$a.prototype,"connect",1),dd([T.trace("SocketService.disconnect")],$a.prototype,"disconnect",1),dd([T.trace("SocketService.sendMessagePromise")],$a.prototype,"sendMessagePromise",1),dd([T.trace("SocketService.sendMessagePromiseWithTimeout")],$a.prototype,"sendMessagePromiseWithTimeout",1);const Wr=class{static handleConnectedRoomsDumpRaw({payload:t}){var i;const e=kC.fromBinary(t),r=e.meetings.map(a=>{var c;return{id:a.id,title:a.title,participants:(c=a.participants)!=null?c:[]}});return{parentMeeting:{id:e.parentMeeting.id,title:e.parentMeeting.title,participants:(i=e.parentMeeting.participants)!=null?i:[]},meetings:r}}static handleTransferPeerRaw({payload:t}){const e=eR.fromBinary(t);return{authToken:e.authToken,meetingId:e.meetingId}}static handleMovedPeerRaw({payload:t}){const e=Em.fromBinary(t);return{meetingId:e.meetingId,customParticipantId:e.customParticipantId}}static handleConnectedRoomsUpdatedRaw({payload:t}){return Sm.fromBinary(t).payloads.map(r=>({id:r.id,title:r.title}))}static handleConnectedRoomsDeletedRaw({payload:t}){return jC.fromBinary(t).payloads}static async getConnectedRoomsDump(){const t=await Wr.socketService.sendMessagePromise(V.getConnectedRoomsDump);return Wr.handleConnectedRoomsDumpRaw(t)}static async createConnectedRooms(t){const{payload:e}=await Wr.socketService.sendMessagePromise(V.createConnectedRooms,DC.toBinary({payloads:t}));return Sm.fromBinary(e).payloads.map(n=>({id:n.id,title:n.title}))}static async updateConnectedRooms(t){}static async disableConnectedRooms(t){const e=t.map(n=>({id:n})),r=await Wr.socketService.sendMessagePromise(V.deleteConnectedRooms,HC.toBinary({payloads:e}));return Wr.handleConnectedRoomsDeletedRaw(r)}static async movePeersBetweenRooms(t){try{const e=await Wr.socketService.sendMessagePromise(V.movePeers,YC.toBinary({sourceMeetingId:t.sourceMeetingId,destinationMeetingId:t.destinationMeetingId,participants:t.participants}));return new TextDecoder().decode(e.payload).includes("error")?{success:!1,error:"failed to move participants"}:{success:!0}}catch(e){return{success:!1,error:e}}}};let Pe=Wr;p(Pe,"socketService"),p(Pe,"currentMeetingId");var yD=Object.defineProperty,SD=Object.getOwnPropertyDescriptor,ld=(s,t,e,r)=>{for(var n=r>1?void 0:r?SD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&yD(t,e,n),n};const ui=class{constructor(s,t){p(this,"apiBase");p(this,"selfController");p(this,"pollController");p(this,"chatController");p(this,"metaController");p(this,"storesManager");p(this,"stageController");p(this,"pluginController");p(this,"internalsController");p(this,"recordingController");p(this,"livestreamController");p(this,"participantController");this.apiBase=s,this.storesManager=t.storesManager,this.metaController=t.metaController,this.selfController=t.selfController,this.chatController=t.chatController,this.pollController=t.pollController,this.stageController=t.stageController,this.pluginController=t.pluginController,this.recordingController=t.recordingController,this.internalsController=t.internalsController,this.participantController=t.participantController,this.livestreamController=t.livestreamController}static async init(s){var B,q;const{peerId:t,apiBase:e,authToken:r,meetingId:n,organizationId:i,cachedUserDetails:a}=s.getAllValues();if(R.reset(),Gc.cleanup(),wf(s),be.isSupported()===!1)throw new P("Browser not supported","0010",!0);const c=pA(s,{authToken:r,baseURL:e,cachedUserDetails:a});c.setRoomName(n),c.setRoomUUID(n),c.setOrganizationId(i),c.setHeader("dyte-tracing-id",t),s.setValue("apiClient",c);const d=new zA;s.setValue("connectionHandler",d);const l=ui.createSocketService(s),h=l.connect(),m=c.getUserDetails(),f=c.getPlugins();let y=bt.HIVE,_,b="";try{await ui.setupFlagsmith(s)}catch(F){u.error("Failed to setup flagsmith",{error:F})}try{await h}catch(F){u.error("[Controller]: Failed to connect to socket server:",{error:F})}try{({sfu:y,meetingTitle:b}=await c.getRoomNodeData()),_=await m,u.info(`SFU ${y} is being used.`),s.setValue("presetName",_.preset.name),s.setValue("roomNodeOptions",{sfu:y})}catch(F){u.error("Failed to get room metadata",{error:F})}T.location.country=(B=c.ipInfo)==null?void 0:B.country;const{theme:I,controllers:L}=await ui.setupControllers(l,s,_,f,b);return UA(I)&&ui.createRoomNodeClient(s,l),ub(),(q=L.selfController.partialMediaRoom())==null||q.catch(F=>{u.error("[Controller]: Failed to queue partial media room promise:",{error:F})}),new ui(e,L)}static async setupFlagsmith(s){var d;const{peerId:t,baseURI:e,overrides:r,meetingId:n,organizationId:i}=s.getAllValues(),a=db(n),c={entity:fl.PEER,clientId:i,isAnonUser:!i,sdkVersion:s.getValue("sdkVersion"),presetName:s.getValue("presetName"),meetingHash:a,roomName:n,...be.getDeviceInfo(),isReactNative:navigator.isReactNative};try{const l=(d=r==null?void 0:r.whitelabelled_flags_endpoint)==null||d?Qn({servicePrefix:"flags",baseURI:e}):"edge.api.flagsmith.com";await ee.identify(`${fl.PEER}_${t}`,JSON.parse(JSON.stringify(c)),!1,5e3,l,u),u.info("flagsmith::allFlags",{flags:JSON.stringify(ee.getAllFlags())},!0)}catch(l){u.error("Failed to fetch flagsmith flags")}}static async setupControllers(s,t,e,r,n){var x,C,Ke;const i=t.getValue("modules"),{preset:a,participant:c}=e,d=t.getValue("defaults"),{sfu:l}=t.getValue("roomNodeOptions"),h=su.init(a,!i.theme),{viewType:m,mediaConstraints:{audio:f}}=h;t.setValue("viewType",m),t.setValue("defaults",{mediaConfiguration:{audio:{enableHighBitrate:(x=f.enableHighBitrate)!=null?x:!1,enableStereo:(C=f.enableStereo)!=null?C:!1}},...d});const y=nu.init(t,m,a.permissions);t.setValue("maxPreferredStreams",be.isMobile()?h.maxVideoStreams.mobile:h.maxVideoStreams.desktop);let _,b,I,L,B,q,F,X;const ne=new KM(s);Pe.socketService=s;const ve=new ed(s),ct=new zt(s),Ls=new QM(s),Es=Gc.create(s,t),Jr=new XM(s),A=new JM(s),E=new an(s),w=await Sr.init(t,Es,c,y,h),U=await jm.init(t,w.self,Es,ne,n);if(i.participant&&(X=new js(t,w.self,Es,l)),(Ke=i.e2ee)!=null&&Ke.enabled&&i.e2ee.manager.init(u,R),i.chat&&(b=await ms.init(t,ct,E,w.self,X.participants)),i.internals&&(B=await Yl.init()),i.livestream&&h.viewType===yt.Livestream&&ee.hasFeature(se.LIVESTREAM)&&(F=new uf(w.self,A)),h.viewType!==yt.Chat){if(i.poll&&(_=await Bm.init(t,w.self,ve)),i.recording&&(q=new zm(t,w.self,Es)),i.stage&&(I=new Gm(t,Ls,Es,w.self,X.participants)),i.plugin){if(!X)throw new P("The plugin module cannot be initialized without the `participant` module","0102");const or=await r;L=await Ca.init(t,or,Jr,ct,b==null?void 0:b.chat,w.self,X.participants,n)}if(i.pip){const or=await vl._init(t,w.self);t.setValue("pip",or)}}const je={storesManager:new J0(t,Jr),pollController:_,selfController:w,metaController:U,chatController:b,stageController:I,pluginController:L,recordingController:q,internalsController:B,livestreamController:F,participantController:X};return{theme:h,permissions:y,controllers:je}}static createRoomNodeClient(s,t){const{peerId:e,roomNodeOptions:r}=s.getAllValues(),{sfu:n}=r;return bf(s,n,{socket:t,peerId:e})}static createSocketService(s){const{peerId:t,meetingId:e,authToken:r}=s.getAllValues(),n=["PING"];return new $a(s,{peerId:t,meetingId:e,authToken:r,capabilities:n})}};let Ha=ui;ld([T.trace("Controller.init")],Ha,"init",1),ld([T.trace("setupFlagsmith")],Ha,"setupFlagsmith",1),ld([T.trace("Controller.createRoomNodeClient")],Ha,"createRoomNodeClient",1),ld([T.trace("Controller.createSocketService")],Ha,"createSocketService",1);var ED=Object.defineProperty,_D=Object.getOwnPropertyDescriptor,bD=(s,t,e,r)=>{for(var n=r>1?void 0:r?_D(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&ED(t,e,n),n};class Gf extends Ft{constructor(e,r){super();g(this,ko,void 0);p(this,"meetings",[]);p(this,"parentMeeting",null);g(this,Ud,void 0);v(this,Ud,e),v(this,ko,r.self)}get supportsConnectedMeetings(){return o(this,ko).id!==""}get isActive(){return this.meetings.length!==0}get currentMeetingId(){return Pe.currentMeetingId}validateConnectedMeetingsAction(){if(!this.supportsConnectedMeetings)throw new Error(`You are not allowed to perform this action.
Please connect with Dyte team to move you to V2 APIs & to enable connected meetings.`)}async getConnectedMeetings(){return this.validateConnectedMeetingsAction(),await Pe.getConnectedRoomsDump()}async createMeetings(e){return this.validateConnectedMeetingsAction(),(await Pe.createConnectedRooms(e)).map(n=>({id:n.id,title:n.title}))}async updateMeetings(e){this.validateConnectedMeetingsAction(),await Pe.updateConnectedRooms(e.map(r=>({meetingId:r.id,title:r.title})))}async deleteMeetings(e){this.validateConnectedMeetingsAction();const r=this.meetings.map(i=>e.includes(i.id)&&i.participants.length!==0?this.moveParticipants(i.id,this.parentMeeting.id,i.participants.map(a=>a.id)):Promise.resolve());return await Promise.all(r),await Pe.disableConnectedRooms(e)}async moveParticipants(e,r,n){this.validateConnectedMeetingsAction();const i=await Pe.movePeersBetweenRooms({sourceMeetingId:e,destinationMeetingId:r,participants:n.map(a=>({id:a}))});return i.success&&this.moveSuccessHandler(e,r,n),i}async moveParticipantsWithCustomPreset(e,r,n){this.validateConnectedMeetingsAction();const i=await Pe.movePeersBetweenRooms({sourceMeetingId:e,destinationMeetingId:r,participants:n});return i.success&&this.moveSuccessHandler(e,r,n.map(a=>a.id)),i}moveSuccessHandler(e,r,n){const i=new Map;[...this.parentMeeting.participants,...this.meetings.flatMap(a=>a.participants)].forEach(a=>i.set(a.id,a)),r===this.parentMeeting.id&&(this.parentMeeting.participants=this.parentMeeting.participants.concat(n.map(a=>i.get(a)))),e===this.parentMeeting.id&&(this.parentMeeting.participants=this.parentMeeting.participants.filter(a=>!n.includes(a.id))),this.meetings=this.meetings.map(a=>{if(r===a.id){const c=a.participants.concat(n.map(d=>i.get(d)));return{...a,participants:c}}if(e===a.id){const c=a.participants.filter(d=>!n.includes(d.id));return{...a,participants:c}}return a})}}ko=new WeakMap,Ud=new WeakMap,bD([Ot({maxInvocations:60,period:60})],Gf.prototype,"getConnectedMeetings",1);var wD=Object.defineProperty,PD=Object.getOwnPropertyDescriptor,bu=(s,t,e,r)=>{for(var n=r>1?void 0:r?PD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&wD(t,e,n),n};const Pr=(Cu=class{constructor(s,t,e){p(this,"connectedMeetings");g(this,ca,void 0);g(this,is,void 0);g(this,Fd,void 0);v(this,Fd,s),v(this,ca,e),this.connectedMeetings=new Gf(s,t),this.setCurrentMeeting(t)}static init(s,t,e){return Pr.instance||(Pr.instance=new Pr(s,t,e)),Pr.instance.connectedMeetings.supportsConnectedMeetings&&(Pr.instance.setupEvents(),t.self.once("roomJoined",()=>Pr.instance.getConnectedMeetings())),Pr.instance}setCurrentMeeting(s){v(this,is,s),Pe.currentMeetingId=s.meta.meetingId}getConnectedMeetings(){this.connectedMeetings.getConnectedMeetings()}setupEvents(){Pe.socketService&&(Pe.socketService.on(V.getConnectedRoomsDump,this.handleConnectedRoomsDump.bind(this)),Pe.socketService.on(V.transferPeer,this.handleTransferPeer.bind(this)),Pe.socketService.on(V.movedPeer,this.handleMovedPeer.bind(this)),Pe.socketService.on(V.connectedRoomsUpdated,this.handleConnectedRoomsUpdated.bind(this)),Pe.socketService.on(V.connectedRoomsDeleted,this.handleConnectedRoomsDeleted.bind(this)))}handleTransferPeer(s){const t=Pe.handleTransferPeerRaw(s);return this.switchMeeting(t)}async switchMeeting({authToken:s,meetingId:t}){var n,i,a,c;if(!this.connectedMeetings.supportsConnectedMeetings)throw new Error(`You are not allowed to perform this action.
Please connect with Dyte team to move you to V2 APIs & to enable connected meetings.`);u.info("ConnectedMeetingsController::switchMeeting:: asking ui-kit to show switching breakout UI"),this.connectedMeetings.emit("changingMeeting",t);const e={video:o(this,is).self.videoEnabled,audio:o(this,is).self.audioEnabled};try{o(this,is).self.cleanupEvents(),await o(this,is).leave("connected-meeting")}catch(d){u.error(`ConnectedMeetingsController:: switchMeeting:: issues in leaving previous meeting. Meeting Id: ${(i=(n=o(this,is))==null?void 0:n.meta)==null?void 0:i.meetingId}`,{error:d})}Pe.socketService=void 0,u.info(`ConnectedMeetingsController::switchMeeting:: initializing new meeting. Meeting Id: ${t}`);const r=await Jf.init({...o(this,ca),cachedUserDetails:null,defaults:{...o(this,ca).defaults,...e,mediaHandler:o(this,is).self},authToken:s});u.info(`ConnectedMeetingsController::switchMeeting:: initialized new meeting. Meeting Id: ${(a=r==null?void 0:r.meta)==null?void 0:a.meetingId}`);try{const{hidden:d}=o(this,is).self;r.self.setName(o(this,is).self.name),await r.join(),d&&r.self.hide()}catch(d){u.error("ConnectedMeetingsController.joinRoom",{error:d})}return u.info(`ConnectedMeetingsController::switchMeeting:: asking ui-kit to show in-meeting ui of newly joined meeting id: ${(c=r==null?void 0:r.meta)==null?void 0:c.meetingId}`),this.connectedMeetings.emit("meetingChanged",r),this.setCurrentMeeting(r),r}handleConnectedRoomsDump(s){const t=Pe.handleConnectedRoomsDumpRaw(s);this.connectedMeetings.meetings=t.meetings.map(e=>({id:e.id,title:e.title,participants:e.participants||[]})),this.connectedMeetings.parentMeeting={id:t.parentMeeting.id,title:t.parentMeeting.title,participants:t.parentMeeting.participants},this.emitStateUpdate()}handleMovedPeer(s){return Pe.handleMovedPeerRaw(s)}handleConnectedRoomsUpdated(s){const t=Pe.handleConnectedRoomsUpdatedRaw(s),e=new Map;this.connectedMeetings.meetings.forEach(r=>{e.set(r.id,r)}),t.forEach(r=>{e.has(r.id)?e.get(r.id).title=r.title:e.set(r.id,{...r,participants:[]})}),this.connectedMeetings.meetings=Array.from(e.values()),this.emitStateUpdate()}handleConnectedRoomsDeleted(s){const e=Pe.handleConnectedRoomsDeletedRaw(s).map(r=>r.id);this.connectedMeetings.meetings=this.connectedMeetings.meetings.filter(r=>!e.includes(r.id)),this.emitStateUpdate()}emitStateUpdate(){this.connectedMeetings.emit("stateUpdate",{meetings:this.connectedMeetings.meetings,parentMeeting:this.connectedMeetings.parentMeeting})}},ca=new WeakMap,is=new WeakMap,Fd=new WeakMap,p(Cu,"instance"),Cu);let ud=Pr;bu([T.trace("ConnectedMeetingsController.getConnectedMeetings")],ud.prototype,"getConnectedMeetings",1),bu([T.trace("ConnectedMeetingsController.setupEvents")],ud.prototype,"setupEvents",1),bu([T.trace("ConnectedMeetingsController.switchMeeting")],ud.prototype,"switchMeeting",1);class CD{constructor(){p(this,"battery");p(this,"init",async()=>{try{"getBattery"in navigator&&(this.battery=await navigator.getBattery(),this.battery.addEventListener("chargingchange",this.updateChargeInfo),this.battery.addEventListener("levelchange",this.updateLevelInfo),this.updateLevelInfo(),this.updateChargeInfo())}catch(t){u.error("Error getting battery",t)}});p(this,"updateChargeInfo",()=>{var t;u.log(`Battery charging? ${(t=this.battery)!=null&&t.charging?"Yes":"No"}`)});p(this,"updateLevelInfo",()=>{if(!this.battery){u.log("Battery level: Not known");return}u.log(`Battery level: ${this.battery.level*100}%`)});p(this,"cleanup",()=>{var t,e;"getBattery"in navigator&&((t=this.battery)==null||t.removeEventListener("chargingchange",this.updateChargeInfo),(e=this.battery)==null||e.removeEventListener("levelchange",this.updateLevelInfo))})}}const Wf=new CD;function RD(s,t){try{const{meetingId:e,orgId:r,participantId:n}=JSON.parse(atob(s.split(".")[1]));if(!e)throw Error(`Received V1 auth token ${s}`);let i="dyte.io";t&&(i=t);const a=`https://api.${i}`;return{meetingId:e,orgId:r,participantId:n,baseURI:i,apiBase:a}}catch(e){throw u.error("constants::decodeAuthToken",{error:e,debuggingHint:`Unable to decode auth token: ${s}`},!0),new P("Invalid auth token","0004")}}var kD=Object.defineProperty,ID=Object.getOwnPropertyDescriptor,hd=(s,t,e,r)=>{for(var n=r>1?void 0:r?ID(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&kD(t,e,n),n};let Cr=(hg=class{constructor(t,e){g(this,Bd);g(this,st,void 0);g(this,Io,void 0);g(this,Ao,void 0);v(this,Ao,t),v(this,st,e)}static async init(t){var h,m,f,y,_;ab(),be.init();const e=Jn();Wf.init();const{authToken:r,baseURI:n}=t,{meetingId:i,...a}=RD(r,n);window.__zone_symbol__DISABLE_WRAPPING_UNCAUGHT_PROMISE_REJECTION=!0;const c=Cr.setupContext(e,t,i,a);T.meetingMetadata.roomName=i,T.meetingMetadata.userId=a.participantId,T.meetingMetadata.organizationId=a.orgId,T.init(c,(m=(h=t.modules)==null?void 0:h.tracing)!=null?m:!0),u.info("DyteClient::init::options",{dyteClientInitOptions:{...t,authToken:`${(f=t.authToken)==null?void 0:f.slice(0,10)}...
${(y=t.authToken)==null?void 0:y.slice(-10)}`}});const d=await Ha.init(c),l=new Cr(c,d);return $(_=l,Bd,Ag).call(_,t),l}static setupContext(t,e,r,n){var c;const i=tn.createContext(t,e),a={...eb,...e==null?void 0:e.modules};return i.setValue("peerId",t),i.setValue("modules",a),i.setValue("sdkName","web-core"),i.setValue("meetingId",r),i.setValue("apiBase",n.apiBase),i.setValue("baseURI",n.baseURI),i.setValue("userId",n.participantId),i.setValue("organizationId",n.orgId),i.setValue("authToken",e.authToken),i.setValue("overrides",(c=e.overrides)!=null?c:{}),i.setValue("env",tb({baseURI:n.baseURI})),i.setValue("defaults",e.defaults||{audio:!0,video:!0}),i.setValue("onError",e.onError||(()=>{})),i.setValue("cachedUserDetails",ps(e.cachedUserDetails)),i.setValue("sdkVersion","2.5.0-staging.34"),i}async join(){const{selfController:t}=o(this,st);return t.self.roomJoined?null:t.joinRoom()}async leave(t){Wf.cleanup();const{selfController:e}=o(this,st);return e.leaveRoom(t)}get participants(){var t;return(t=o(this,st).participantController)==null?void 0:t.participants}get self(){var t;return(t=o(this,st).selfController)==null?void 0:t.self}get meta(){var t;return(t=o(this,st).metaController)==null?void 0:t.meta}get ai(){var t;return(t=o(this,st).metaController)==null?void 0:t.ai}get plugins(){var t;return(t=o(this,st).pluginController)==null?void 0:t.plugins}get chat(){var t;return(t=o(this,st).chatController)==null?void 0:t.chat}get polls(){var t;return(t=o(this,st).pollController)==null?void 0:t.polls}get connectedMeetings(){var t;return(t=o(this,Io))==null?void 0:t.connectedMeetings}get recording(){var t;return(t=o(this,st).recordingController)==null?void 0:t.recording}get livestream(){var t;return(t=o(this,st).livestreamController)==null?void 0:t.livestream}get stage(){var t;return(t=o(this,st).stageController)==null?void 0:t.stage}get stores(){return o(this,st).storesManager}get __internals__(){var t;return(t=o(this,st).internalsController)==null?void 0:t.internals}async joinRoom(){return this.join()}async leaveRoom(t){return this.leave(t)}},st=new WeakMap,Io=new WeakMap,Ao=new WeakMap,Bd=new WeakSet,Ag=function(t){v(this,Io,ud.init(o(this,Ao),this,t))},hg);hd([lt("0002"),Tr.executeWithLock({methodName:"meeting.join",lockName:"DyteClient.join",timeout:3e3})],Cr.prototype,"join",1),hd([lt("0003")],Cr.prototype,"leave",1),hd([lt("0001"),Tr.executeWithLock({methodName:"DyteClient.init",lockName:"DyteClient.init",timeout:3e3})],Cr,"init",1),Cr=hd([lt("0000")],Cr);const Jf=Cr;return Jf}();
