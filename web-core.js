var DyteClient=function(){var Tv,Jr,Kr,Cs,_v,vt,re,Cn,Ze,bn,Aa,hd,$v,Sv,pd,Ev,md,Vv,Pn,fi,Ma,wv,gi,Rn,Cv,Da,vi,Id,kn,Oa,bv,bs,yi,fd,Pv,Qt,Ti,Ie,Na,Pr,mr,_i,Ad,Ps,In,Rs,La,zr,yt,Xt,Si,Ei,Yr,wi,Ci,An,Do,Rv,ze,Mn,Zt,bi,Fa,kv,Pi,xa,Ri,Md,Iv,gd,st,pt,et,Rr,er,Ua,vd,Dn,On,yd,ki,kr,Td,Av,Ii,Ai,$a,Wt,Nn,Va,Mi,Oi,Ni,ks,Tt,Is,As,_d,Bv,Ln,Fn,Ba,Gu,Ha,Ms,Sd,Hv,Li,Fi,xi,Ds,Zi,Qr,qa,Os,Ui,Dd,Xr,Ed,ja,Wu,Mv,Ns,Ga,Wa,Ja,Ka,za,Ir,Ya,Qa,fr,xn,Xa,Za,eo,Ju,wd,qv,Cd,jv,Ls,_t,Zr,ye,me,Ar,Un,$n,Fs,to,ro,so,es,Vi,tr,Mr,Ks,Dv,xs,Ft,nr,Us,Jt,Ov,q,Bi,Hi,bd,Rt,Kt,Vu,no,xt,ji,$s,Vs,ea,Ye,it,Gi,Wi,io,Ku,Nv,St,ts,Ae,pe,Dr,Vn,Bn,Bs,ao,oo,co,rs,Ji,Hs,Or,zs,Lv,qs,gr,Et,Ut,ir,Fv,lo,uo,ss,$t,nt,js,Be,Gs,ho,zu,po,Yu,xv,rr,Ki,wt,sr,je,vr,ns,kt,tt,zi,Yi,is,Qi,mo,Pd,Xi,Js,Hu,Rd,ct,fo,go,kd,Gv,Uv;"use strict";var mN=Object.defineProperty;var fN=(Ne,Le,ce)=>Le in Ne?mN(Ne,Le,{enumerable:!0,configurable:!0,writable:!0,value:ce}):Ne[Le]=ce;var m=(Ne,Le,ce)=>(fN(Ne,typeof Le!="symbol"?Le+"":Le,ce),ce),ju=(Ne,Le,ce)=>{if(!Le.has(Ne))throw TypeError("Cannot "+ce)};var d=(Ne,Le,ce)=>(ju(Ne,Le,"read from private field"),ce?ce.call(Ne):Le.get(Ne)),S=(Ne,Le,ce)=>{if(Le.has(Ne))throw TypeError("Cannot add the same private member more than once");Le instanceof WeakSet?Le.add(Ne):Le.set(Ne,ce)},T=(Ne,Le,ce,Oo)=>(ju(Ne,Le,"write to private field"),Oo?Oo.call(Ne,ce):Le.set(Ne,ce),ce);var le=(Ne,Le,ce)=>(ju(Ne,Le,"access private method"),ce);var Ne=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Le(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var ce={},Oo={get exports(){return ce},set exports(s){ce=s}},Hn=typeof Reflect=="object"?Reflect:null,Qu=Hn&&typeof Hn.apply=="function"?Hn.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)},No;Hn&&typeof Hn.ownKeys=="function"?No=Hn.ownKeys:Object.getOwnPropertySymbols?No=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:No=function(t){return Object.getOwnPropertyNames(t)};function Wv(s){console&&console.warn&&console.warn(s)}var Xu=Number.isNaN||function(t){return t!==t};function _e(){_e.init.call(this)}Oo.exports=_e,ce.once=Yv,_e.EventEmitter=_e,_e.prototype._events=void 0,_e.prototype._eventsCount=0,_e.prototype._maxListeners=void 0;var Zu=10;function Lo(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(_e,"defaultMaxListeners",{enumerable:!0,get:function(){return Zu},set:function(s){if(typeof s!="number"||s<0||Xu(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");Zu=s}}),_e.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},_e.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Xu(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function eh(s){return s._maxListeners===void 0?_e.defaultMaxListeners:s._maxListeners}_e.prototype.getMaxListeners=function(){return eh(this)},_e.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var n=t==="error",i=this._events;if(i!==void 0)n=n&&i.error===void 0;else if(!n)return!1;if(n){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=i[t];if(c===void 0)return!1;if(typeof c=="function")Qu(c,this,e);else for(var u=c.length,h=ih(c,u),r=0;r<u;++r)Qu(h[r],this,e);return!0};function th(s,t,e,r){var n,i,a;if(Lo(e),i=s._events,i===void 0?(i=s._events=Object.create(null),s._eventsCount=0):(i.newListener!==void 0&&(s.emit("newListener",t,e.listener?e.listener:e),i=s._events),a=i[t]),a===void 0)a=i[t]=e,++s._eventsCount;else if(typeof a=="function"?a=i[t]=r?[e,a]:[a,e]:r?a.unshift(e):a.push(e),n=eh(s),n>0&&a.length>n&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=s,o.type=t,o.count=a.length,Wv(o)}return s}_e.prototype.addListener=function(t,e){return th(this,t,e,!1)},_e.prototype.on=_e.prototype.addListener,_e.prototype.prependListener=function(t,e){return th(this,t,e,!0)};function Jv(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function rh(s,t,e){var r={fired:!1,wrapFn:void 0,target:s,type:t,listener:e},n=Jv.bind(r);return n.listener=e,r.wrapFn=n,n}_e.prototype.once=function(t,e){return Lo(e),this.on(t,rh(this,t,e)),this},_e.prototype.prependOnceListener=function(t,e){return Lo(e),this.prependListener(t,rh(this,t,e)),this},_e.prototype.removeListener=function(t,e){var r,n,i,a,o;if(Lo(e),n=this._events,n===void 0)return this;if(r=n[t],r===void 0)return this;if(r===e||r.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if(typeof r!="function"){for(i=-1,a=r.length-1;a>=0;a--)if(r[a]===e||r[a].listener===e){o=r[a].listener,i=a;break}if(i<0)return this;i===0?r.shift():Kv(r,i),r.length===1&&(n[t]=r[0]),n.removeListener!==void 0&&this.emit("removeListener",t,o||e)}return this},_e.prototype.off=_e.prototype.removeListener,_e.prototype.removeAllListeners=function(t){var e,r,n;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[t]),this;if(arguments.length===0){var i=Object.keys(r),a;for(n=0;n<i.length;++n)a=i[n],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=r[t],typeof e=="function")this.removeListener(t,e);else if(e!==void 0)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this};function sh(s,t,e){var r=s._events;if(r===void 0)return[];var n=r[t];return n===void 0?[]:typeof n=="function"?e?[n.listener||n]:[n]:e?zv(n):ih(n,n.length)}_e.prototype.listeners=function(t){return sh(this,t,!0)},_e.prototype.rawListeners=function(t){return sh(this,t,!1)},_e.listenerCount=function(s,t){return typeof s.listenerCount=="function"?s.listenerCount(t):nh.call(s,t)},_e.prototype.listenerCount=nh;function nh(s){var t=this._events;if(t!==void 0){var e=t[s];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}_e.prototype.eventNames=function(){return this._eventsCount>0?No(this._events):[]};function ih(s,t){for(var e=new Array(t),r=0;r<t;++r)e[r]=s[r];return e}function Kv(s,t){for(;t+1<s.length;t++)s[t]=s[t+1];s.pop()}function zv(s){for(var t=new Array(s.length),e=0;e<t.length;++e)t[e]=s[e].listener||s[e];return t}function Yv(s,t){return new Promise(function(e,r){function n(a){s.removeListener(t,i),r(a)}function i(){typeof s.removeListener=="function"&&s.removeListener("error",n),e([].slice.call(arguments))}ah(s,t,i,{once:!0}),t!=="error"&&Qv(s,n,{once:!0})})}function Qv(s,t,e){typeof s.on=="function"&&ah(s,"error",t,e)}function ah(s,t,e,r){if(typeof s.on=="function")r.once?s.once(t,e):s.on(t,e);else if(typeof s.addEventListener=="function")s.addEventListener(t,function n(i){r.once&&s.removeEventListener(t,n),e(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var z;(function(s){s[s.MAJOR_EVENT=0]="MAJOR_EVENT",s[s.MINOR_EVENT=1]="MINOR_EVENT"})(z||(z={}));var F;(function(s){s.PRECALL_TEST_BEGIN="precall_begin",s.PRECALL_TEST_COMPLETE="precall_end",s.CALL_JOIN_BEGIN="call_join",s.NET_QUALITY_TEST_BEGIN="net_quality_test_begin",s.NET_QUALITY_TEST_END="net_quality_test_end",s.WEBSOCKET_CONNECTED="websocket_connected",s.TRANSPORT_CONNECTED="transport_connected",s.AUDIO_ON="audio_on",s.AUDIO_OFF="audio_off",s.VIDEO_ON="video_on",s.VIDEO_OFF="video_off",s.PARTICIPANT_ROLE="participant_role",s.PING_STAT="ping_stat",s.DISCONNECT="disconnect",s.RECONNECT_ATTEMPT="reconnect_attempt",s.SCREENSHARE_START_REQUESTED="screenshare_start_requested",s.SCREENSHARE_STARTED="screenshare_started",s.SCREENSHARE_STOPPED="screenshare_stopped",s.TAB_CHANGE="tab_change",s.BROWSER_BACKGROUNDED="browser_backgrounded",s.BROWSER_FOREGROUNDED="browser_foregrounded",s.DOMINANT_SPEAKER="dominant_speaker",s.AUDIO_DEVICES_UPDATES="audio_devices_updates",s.VIDEO_DEVICES_UPDATES="video_devices_updates",s.SPEAKER_DEVICES_UPDATES="speaker_devices_updates",s.SELECTED_MICROHPONE_UPDATE="selected_microphone_update",s.SELECTED_CAMERA_UPDATE="selected_camera_update",s.SELECTED_SPEAKER_UPDATE="selected_speaker_update",s.MEDIA_PERMISSION="media_permission",s.LEGACY_SWITCH="legacy_switch",s.AUDIO_PLAY_FAILED="audio_play_failed",s.VIDEO_PLAY_FAILED="video_play_failed",s.AUDIO_TRACK_MUTED="audio_track_muted",s.VIDEO_TRACK_MUTED="video_track_muted",s.IVS_PLAYER_REBUFFERING="ivs_player_rebuffering",s.IVS_PLAYER_AUDIO_BLOCKED="ivs_player_audio_blocked",s.IVS_PLAYER_PLAYBACK_BLOCKED="ivs_player_playback_blocked",s.IVS_PLAYER_ERROR="ivs_player_error",s.IVS_PLAYER_RECOVERABLE_ERROR="ivs_player_recoverable_error",s.IVS_PLAYER_WORKER_ERROR="ivs_player_worker_error",s.IVS_PLAYER_NETWORK_UNAVAILABLE="ivs_player_network_unavailable",s.LIVESTREAM_LATENCY="livestream_latency",s.IVS_PLAYER_ANALYTICS_EVENT="ivs_player_analytics_event",s.IVS_PLAYER_PLAYBACK_RATE_CHANGED="ivs_player_playback_rate_changed",s.IVS_PLAYER_QUALITY_CHANGED="ivs_player_quality_changed",s.IVS_PLAYER_INITIALIZED="ivs_player_initialized"})(F||(F={}));const Xv=new Map([[F.PRECALL_TEST_BEGIN,z.MINOR_EVENT],[F.PRECALL_TEST_COMPLETE,z.MINOR_EVENT],[F.CALL_JOIN_BEGIN,z.MAJOR_EVENT],[F.NET_QUALITY_TEST_BEGIN,z.MINOR_EVENT],[F.NET_QUALITY_TEST_END,z.MINOR_EVENT],[F.WEBSOCKET_CONNECTED,z.MINOR_EVENT],[F.TRANSPORT_CONNECTED,z.MAJOR_EVENT],[F.AUDIO_ON,z.MINOR_EVENT],[F.AUDIO_OFF,z.MINOR_EVENT],[F.VIDEO_ON,z.MINOR_EVENT],[F.VIDEO_OFF,z.MINOR_EVENT],[F.PARTICIPANT_ROLE,z.MINOR_EVENT],[F.PING_STAT,z.MAJOR_EVENT],[F.DISCONNECT,z.MAJOR_EVENT],[F.RECONNECT_ATTEMPT,z.MAJOR_EVENT],[F.SCREENSHARE_START_REQUESTED,z.MINOR_EVENT],[F.SCREENSHARE_STARTED,z.MINOR_EVENT],[F.SCREENSHARE_STOPPED,z.MINOR_EVENT],[F.TAB_CHANGE,z.MINOR_EVENT],[F.BROWSER_BACKGROUNDED,z.MINOR_EVENT],[F.BROWSER_FOREGROUNDED,z.MINOR_EVENT],[F.DOMINANT_SPEAKER,z.MINOR_EVENT],[F.AUDIO_DEVICES_UPDATES,z.MINOR_EVENT],[F.VIDEO_DEVICES_UPDATES,z.MINOR_EVENT],[F.SPEAKER_DEVICES_UPDATES,z.MINOR_EVENT],[F.SELECTED_MICROHPONE_UPDATE,z.MINOR_EVENT],[F.SELECTED_CAMERA_UPDATE,z.MINOR_EVENT],[F.SELECTED_SPEAKER_UPDATE,z.MINOR_EVENT],[F.MEDIA_PERMISSION,z.MINOR_EVENT],[F.LEGACY_SWITCH,z.MINOR_EVENT],[F.AUDIO_PLAY_FAILED,z.MINOR_EVENT],[F.VIDEO_PLAY_FAILED,z.MINOR_EVENT],[F.AUDIO_TRACK_MUTED,z.MINOR_EVENT],[F.VIDEO_TRACK_MUTED,z.MINOR_EVENT],[F.IVS_PLAYER_REBUFFERING,z.MAJOR_EVENT],[F.IVS_PLAYER_AUDIO_BLOCKED,z.MAJOR_EVENT],[F.IVS_PLAYER_PLAYBACK_BLOCKED,z.MAJOR_EVENT],[F.IVS_PLAYER_ERROR,z.MAJOR_EVENT],[F.IVS_PLAYER_RECOVERABLE_ERROR,z.MAJOR_EVENT],[F.IVS_PLAYER_WORKER_ERROR,z.MAJOR_EVENT],[F.IVS_PLAYER_NETWORK_UNAVAILABLE,z.MAJOR_EVENT],[F.LIVESTREAM_LATENCY,z.MAJOR_EVENT],[F.IVS_PLAYER_ANALYTICS_EVENT,z.MINOR_EVENT],[F.IVS_PLAYER_PLAYBACK_RATE_CHANGED,z.MINOR_EVENT],[F.IVS_PLAYER_QUALITY_CHANGED,z.MINOR_EVENT],[F.IVS_PLAYER_INITIALIZED,z.MINOR_EVENT]]);class Zv{constructor(){m(this,"events");this.events=[]}add(t){this.events.push(t)}flush(){return{entries:this.events.splice(0,25)}}}class ey extends ce{constructor({logger:e,peerId:r,apiHostnames:n}){super();m(this,"logger");m(this,"peerId");m(this,"eventStore");m(this,"apiEndpoint");this.logger=e,this.peerId=r,this.apiEndpoint=`https://${n.daCollector}/api/v1/message`,this.eventStore=new Zv}async sendEventsChunkToServer(e){var n;const r={payload:e,peerId:this.peerId};try{return await fetch(this.apiEndpoint,{method:"POST",body:JSON.stringify(r)}),!0}catch(i){return this.logger.error("callStats::sendEventsChunkToServer::catch",{error:i}),(n=e.entries)==null||n.forEach(a=>{this.eventStore.add(a)}),!1}}callEvent(e){e.timestamp=new Date,this.eventStore.add(e),this.emit(e.event,e.metaData),Xv.get(e.event)===z.MAJOR_EVENT&&this.flush()}async flush(){var r;const e=this.eventStore.flush();return(r=e==null?void 0:e.entries)!=null&&r.length?(await this.sendEventsChunkToServer(e),!0):!1}}var oh;(function(s){s.CHROMIUM="chromum",s.FIREFOX="firefox",s.SAFARI="safari"})(oh||(oh={}));const ta={DEVEL:"devel",PREPROD:"preprod",PROD:"prod"};var zt;(function(s){s.AUDIO="AUDIO",s.VIDEO="VIDEO",s.SPEAKER="SPEAKER",s.SCREENSHARE="SCREENSHARE"})(zt||(zt={}));var ch;(function(s){s[s.INIT=0]="INIT",s[s.ACCEPTED=1]="ACCEPTED",s[s.DENIED=2]="DENIED",s[s.SYS_DENIED=3]="SYS_DENIED",s[s.FAILED=4]="FAILED",s[s.NOTFOUND=5]="NOTFOUND",s[s.NOT_APPLICABLE=6]="NOT_APPLICABLE"})(ch||(ch={}));function Fo({packetsLost:s,packetsSent:t}){return t>0?s*100/t:0}function xo({packetsLost:s,packetsReceived:t}){return t+s>0?s*100/(t+s):0}const dh=240,lh=720,uh=8,hh=3,Uo=10,$o=.02,Vo=.03;function Nr({stat:s,weight:t,rangeMin:e,rangeMax:r,rangeRankingDirection:n}){return s==null?t:e===r?n==="UP"?s<=e?t:0:s>=r?t:0:n==="UP"?(1-Math.max(Math.min(r,Math.abs(s))-e,0)/(r-e))*t:n==="DOWN"?Math.max(Math.min(r,Math.abs(s))-e,0)/(r-e)*t:t}function ph({isLowQualityVideo:s,isVideoStuck:t,isVideoLagging:e,jitterQuality:r,packetsLostQuality:n}){const i=.8*((s?.85:1)*(e?.7:1)*(t?.5:1))+.2*(r*n);return Math.round((i+Number.EPSILON)*100)/100}function mh({packetsLost:s,packetsSent:t}){return t>0?s*100/t:0}function fh({packetsLost:s,packetsSent:t,jitter:e}){const n=Nr({stat:mh({packetsLost:s,packetsSent:t}),weight:.7,rangeMin:0,rangeMax:Uo,rangeRankingDirection:"UP"}),a=Nr({stat:e,weight:.3,rangeMin:$o,rangeMax:Vo,rangeRankingDirection:"UP"});return n+a}function ty({frameWidth:s,isScreenShare:t}){return s<(t?lh:dh)}function ry({framesPerSecond:s,isScreenShare:t}){return s<(t?hh:uh)}function sy({framesEncoded:s}){return s===0}function gh({frameWidth:s,framesPerSecond:t,packetsLost:e,packetsSent:r,jitter:n,isScreenShare:i,framesEncoded:a}){const o=Nr({stat:mh({packetsLost:e,packetsSent:r}),weight:1,rangeMin:0,rangeMax:Uo,rangeRankingDirection:"UP"}),c=Nr({stat:n,weight:1,rangeMin:$o,rangeMax:Vo,rangeRankingDirection:"UP"}),u=ty({frameWidth:s,isScreenShare:i}),h=ry({framesPerSecond:t,isScreenShare:i}),p=sy({framesEncoded:a,isScreenShare:i});return ph({isLowQualityVideo:u,isVideoLagging:h,isVideoStuck:p,jitterQuality:c,packetsLostQuality:o})}function vh({packetsLost:s,packetsReceived:t}){return t+s>0?s*100/(t+s):0}function yh({concealmentEvents:s,packetsLost:t,packetsReceived:e,jitter:r}){const i=Nr({stat:s,weight:.2,rangeMin:0,rangeMax:3,rangeRankingDirection:"UP"}),a=.5,o=Nr({stat:vh({packetsLost:t,packetsReceived:e}),weight:a,rangeMin:0,rangeMax:Uo,rangeRankingDirection:"UP"}),u=Nr({stat:r,weight:.3,rangeMin:$o,rangeMax:Vo,rangeRankingDirection:"UP"});return i+o+u}function ny({framesDecoded:s}){return s===0}function iy({framesPerSecond:s,isScreenShare:t}){return s<(t?hh:uh)}function ay({frameWidth:s,isScreenShare:t}){return s<(t?lh:dh)}function Th({frameWidth:s,framesPerSecond:t,packetsLost:e,packetsReceived:r,jitter:n,isScreenShare:i,framesDecoded:a}){const o=Nr({stat:vh({packetsLost:e,packetsReceived:r}),weight:1,rangeMin:0,rangeMax:Uo,rangeRankingDirection:"UP"}),c=Nr({stat:n,weight:1,rangeMin:$o,rangeMax:Vo,rangeRankingDirection:"UP"}),u=ay({frameWidth:s,isScreenShare:i}),h=iy({framesPerSecond:t,isScreenShare:i}),p=ny({framesDecoded:a,isScreenShare:i});return ph({isLowQualityVideo:u,isVideoLagging:h,isVideoStuck:p,jitterQuality:c,packetsLostQuality:o})}class Lr{constructor(t){m(this,"pc1");m(this,"pc2");m(this,"constrainVideoBitrateKbps");m(this,"constrainOfferToRemoveVideoFec",!1);m(this,"iceCandidateFilter");const e=new RTCPeerConnection(t),r=new RTCPeerConnection(t);this.pc1=e,this.pc2=r,this.iceCandidateFilter=Lr.noFilter,this.pc1.addEventListener("icecandidate",this.onIceCandidate.bind(this,this.pc2)),this.pc2.addEventListener("icecandidate",this.onIceCandidate.bind(this,this.pc1))}static parseCandidate(t){const e="candidate:",r=t.indexOf(e)+e.length,n=t.substr(r).split(" ");return{type:n[7],protocol:n[2],address:n[4]}}static isNotHostCandidate(t){return t.type!=="host"}static isHost(t){return t.type==="host"}static isRelay(t){return t.type==="relay"}static isReflexive(t){return t.type==="srflx"}static noFilter(t){return!0}onIceCandidate(t,e){if(e.candidate){const r=Lr.parseCandidate(e.candidate.candidate);this.iceCandidateFilter(r)&&t.addIceCandidate(e.candidate)}}setIceCandidateFilter(t){this.iceCandidateFilter=t}constrainVideoBitrate(t){this.constrainVideoBitrateKbps=t}disableVideoFec(){this.constrainOfferToRemoveVideoFec=!0}gotOffer(t){this.constrainOfferToRemoveVideoFec&&(t.sdp=t.sdp.replace(/(m=video 1 [^\r]+)(116 117)(\r\n)/g,`$1\r
`),t.sdp=t.sdp.replace(/a=rtpmap:116 red\/90000\r\n/g,""),t.sdp=t.sdp.replace(/a=rtpmap:117 ulpfec\/90000\r\n/g,""),t.sdp=t.sdp.replace(/a=rtpmap:98 rtx\/90000\r\n/g,""),t.sdp=t.sdp.replace(/a=fmtp:98 apt=116\r\n/g,"")),this.pc1.setLocalDescription(t),this.pc2.setRemoteDescription(t),this.pc2.createAnswer().then(this.gotAnswer.bind(this),this.reportFatal.bind(this))}gotAnswer(t){this.constrainVideoBitrateKbps&&(t.sdp=t.sdp.replace(/a=mid:video\r\n/g,`a=mid:video\r
b=AS:${this.constrainVideoBitrateKbps}\r
`)),this.pc2.setLocalDescription(t),this.pc1.setRemoteDescription(t)}establishConnection(){this.pc1.createOffer().then(this.gotOffer.bind(this),this.reportFatal.bind(this))}reportFatal(t){console.error("Error:",t)}async getRoundTripTime(){const[t,e]=await Promise.all([this.pc1.getStats(),this.pc2.getStats()]);let r,n;if(t.forEach(i=>{i.type==="candidate-pair"&&i.nominated===!0&&i.bytesSent>0&&(r=i)}),e.forEach(i=>{i.type==="candidate-pair"&&i.nominated===!0&&i.bytesReceived>0&&(n=i)}),r&&n)try{if(r.currentRoundTripTime&&n.currentRoundTripTime)return{rtt:r.currentRoundTripTime,backendRTT:n.currentRoundTripTime};const i=(n.lastPacketReceivedTimestamp-r.lastPacketSentTimestamp)/1e3;return{rtt:i,backendRTT:i}}catch(i){return}}close(){this.pc1.close(),this.pc2.close()}}class _h extends ce{constructor(e){super();m(this,"call");m(this,"timeOut");this.call=new Lr(e)}start(e=1e4){this.call.establishConnection(),this.timeOut=setTimeout(this.testFailed.bind(this),e)}testComplete(e){clearTimeout(this.timeOut),this.call.close(),this.emit("done",e)}testFailed(e){this.call.close(),this.emit("failed",e)}}const oy=8,cy=1/1e3;class dy extends _h{constructor(e){super(e);m(this,"senderChannel");m(this,"recieveChannel");m(this,"startTime");m(this,"lastBitrateMeasureTime");m(this,"sentPayloadBytes",0);m(this,"recievedPayloadBytes",0);m(this,"lastReceivedPayloadBytes",0);m(this,"stopSending",!1);m(this,"testProgress",0);m(this,"samplePacket","");m(this,"finalBitrateSum",0);m(this,"bitRateSampels",0);m(this,"maxNumberOfPacketsToSend",0);m(this,"bytesToKeepBuffered",0);m(this,"testDurationSeconds",5);this.call.setIceCandidateFilter(Lr.isNotHostCandidate),this.senderChannel=this.call.pc1.createDataChannel(null);for(let r=0;r<262144;r+=1)this.samplePacket+="h";this.maxNumberOfPacketsToSend=1,this.bytesToKeepBuffered=1024*this.maxNumberOfPacketsToSend,this.testDurationSeconds=4,this.senderChannel.addEventListener("open",this.sendingStep.bind(this)),this.call.pc2.addEventListener("datachannel",this.onRecieverChannel.bind(this))}sendingStep(){const e=new Date;this.startTime||(this.startTime=e,this.lastBitrateMeasureTime=e);for(let n=0;n!==this.maxNumberOfPacketsToSend&&!(this.senderChannel.bufferedAmount>=this.bytesToKeepBuffered);n+=1){this.sentPayloadBytes+=this.samplePacket.length;try{this.senderChannel.send(this.samplePacket)}catch(i){}}const r=e.getTime()-this.startTime.getTime();r>=1e3*this.testDurationSeconds?(this.stopSending=!0,this.testProgress=100):(this.testProgress=r/(10*this.testDurationSeconds),setTimeout(this.sendingStep.bind(this),1))}onMessageRecieved(e){this.recievedPayloadBytes+=e.data.length;const r=new Date,n=r.getTime()-this.lastBitrateMeasureTime.getTime();if(n>=1e3){const a=(this.recievedPayloadBytes-this.lastReceivedPayloadBytes)*oy/(n/1e3);this.finalBitrateSum+=a,this.bitRateSampels+=1,this.lastReceivedPayloadBytes=this.recievedPayloadBytes,this.lastBitrateMeasureTime=r}if(this.stopSending&&this.sentPayloadBytes===this.recievedPayloadBytes){const i=this.finalBitrateSum/this.bitRateSampels;this.testComplete({throughput:Math.round(i*cy)})}}testComplete(e){this.call.getRoundTripTime().then(({rtt:r,backendRTT:n})=>super.testComplete({RTT:r,backendRTT:n,throughput:e.throughput}))}onRecieverChannel(e){this.recieveChannel=e.channel,this.recieveChannel.addEventListener("message",this.onMessageRecieved.bind(this))}}class Od extends _h{constructor(e,r=Lr.noFilter){super(e);m(this,"ch1");m(this,"ch2");this.call.setIceCandidateFilter(r);const n=this.call.pc1.createDataChannel(null);this.ch1=n,n.addEventListener("open",()=>{n.send("hello")}),n.addEventListener("message",this.onCh1Recieve.bind(this)),this.call.pc2.addEventListener("datachannel",this.dataChannelHandler.bind(this))}onCh1Recieve(e){e.data!=="world"?this.hangup("Invalid data transmitted."):this.testComplete({connectivity:!0})}onCh2Recieve(e){if(e.data!=="hello")this.hangup("Invalid data transmitted.");else try{this.ch2.send("world")}catch(r){}}dataChannelHandler(e){const r=e.channel;this.ch2=r,r.addEventListener("message",this.onCh2Recieve.bind(this))}hangup(e){this.testFailed(e)}}class ly extends Od{constructor(t){super(t,Lr.isHost)}}class uy extends Od{constructor(t){super(t,Lr.isRelay)}}class hy extends Od{constructor(t){super(t,Lr.isReflexive)}}class py{constructor(){m(this,"ipInformation",null)}async getIPDetails({peerId:t,apiHostnames:e}){var r;if(!this.ipInformation){try{const i=`https://${e.location}`,o=await(await fetch(i)).json();if(((r=o.loc)==null?void 0:r.length)>5)return this.ipInformation=o,o;throw Error("Insufficient data")}catch(i){}const n=await fetch(`https://${e.locationLegacy}/?token=3c493932b0624c&peerId=${t}`,{method:"POST"});this.ipInformation=await n.json()}return this.ipInformation}resetCache(){this.ipInformation=null}}const Nd=new py,Sh=[{urls:"turn:turn.dyte.in:443?transport=tcp",username:"dyte",credential:"dytein",credentialType:"password"},{urls:"turn:turn.dyte.in:3478?transport=udp",username:"dyte",credential:"dytein",credentialType:"password"}];function Eh(s){const[t,e]=s.split(",");return{coords:{latitude:Number(t),longitude:Number(e)}}}class wh{constructor(){m(this,"transport");m(this,"candidatePair");m(this,"outboundVideoRtp",new Map);m(this,"inboundVideoRtp",new Map);m(this,"outboundAudioRtp",new Map);m(this,"inboundAudioRtp",new Map);m(this,"remoteInboundRtp",new Map);m(this,"producerStreamMap",new Map);m(this,"consumerStreamMap",new Map);m(this,"staleProducerStreamMap",!1);m(this,"staleConsumerStreamMap",!1)}}class Ch extends ce{constructor(){super();m(this,"observer");m(this,"outboundProducerMap",new Map);m(this,"inboundConsumerMap",new Map);m(this,"consumerPeerIdMap",new Map);m(this,"pausedConsumerMap",new Map);m(this,"pausedProducerMap",new Map);m(this,"overallProducingTransportsStatsMap",{});m(this,"overallConsumingTransportsStatsMap",{});m(this,"overallConsumersStatsMap",{});m(this,"overallProducersStatsMap",{});m(this,"videoProducerToStatsMap",new Map);m(this,"audioProducerToStatsMap",new Map);m(this,"videoConsumerToStatsMap",new Map);m(this,"audioConsumerToStatsMap",new Map);m(this,"consumerIdsWithFreezedVideo",new Set);m(this,"consumerIdsWithFreezedAudio",new Set);m(this,"producerIdsWithFreezedVideo",new Set);m(this,"producerIdsWithFreezedAudio",new Set);m(this,"freezedProducingTransportIds",new Set);m(this,"freezedConsumingTransportIds",new Set);m(this,"screenShareProducers",new Set);m(this,"screenShareConsumers",new Set);m(this,"ipDetails");m(this,"callStatsInstance");this.observer=new ce}async registerProducer(e){await this.generateProducerStreamMap(e),e.observer.on("close",this.deregisterProducer.bind(this,e)),e.observer.on("pause",this.pauseProducer.bind(this,e.id)),e.observer.on("resume",this.resumeProducer.bind(this,e.id)),e.appData.screenShare===!0&&this.screenShareProducers.add(e.id)}pauseProducer(e){this.pausedProducerMap.set(e,{lastReportCalculated:!1})}resumeProducer(e){this.pausedProducerMap.delete(e)}processInboundConsumerVideoStats(e,r,n){var a,o;const i=((o=(a=this==null?void 0:this.callStatsInstance)==null?void 0:a.consumerSharedMediaStatesMap)==null?void 0:o.get(e))||{};r.totalVideoPacketsReceived===n.packetsReceived?(this.consumerIdsWithFreezedVideo.add(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callstats::measurements::consumerVideoFreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_video_status","pause",e))):(r.totalVideoPacketsReceived=n.packetsReceived,this.consumerIdsWithFreezedVideo.has(e)&&(this.consumerIdsWithFreezedVideo.delete(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callstats::measurements::consumerVideoDefreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_video_status","resume",e))))}processInboundConsumerAudioStats(e,r,n){var a,o;const i=((o=(a=this==null?void 0:this.callStatsInstance)==null?void 0:a.consumerSharedMediaStatesMap)==null?void 0:o.get(e))||{};r.totalAudioPacketsReceived===n.packetsReceived?(this.consumerIdsWithFreezedAudio.add(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::consumerAudioFreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_audio_status","pause",e))):(r.totalAudioPacketsReceived=n.packetsReceived,this.consumerIdsWithFreezedAudio.has(e)&&(this.consumerIdsWithFreezedAudio.delete(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::consumerAudioDefreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_audio_status","resume",e))))}processOutboundProducerVideoStats(e,r,n){var a;const i=((a=this==null?void 0:this.callStatsInstance)==null?void 0:a.currentUserMediaStates)||{};r.totalVideoPacketsSent===n.packetsSent?(this.producerIdsWithFreezedVideo.add(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callStats::measurements::producerVideoFreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_video_status","pause",e))):(r.totalVideoPacketsSent=n.packetsSent,this.producerIdsWithFreezedVideo.has(e)&&(this.producerIdsWithFreezedVideo.delete(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callStats::measurements::producerVideoDefreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_video_status","resume",e))))}processOutboundProducerAudioStats(e,r,n){var a;const i=((a=this==null?void 0:this.callStatsInstance)==null?void 0:a.currentUserMediaStates)||{};r.totalAudioPacketsSent===n.packetsSent?(this.producerIdsWithFreezedAudio.add(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::producerAudioFreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_audio_status","pause",e))):(r.totalAudioPacketsSent=n.packetsSent,this.producerIdsWithFreezedAudio.has(e)&&(this.producerIdsWithFreezedAudio.delete(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::producerAudioDefreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_audio_status","resume",e))))}processProducingTransportStats(e,r,n){var h;const i=((h=this==null?void 0:this.callStatsInstance)==null?void 0:h.currentUserMediaStates)||{},{audio:a,video:o,screen:c}=i,u=a||o||c;r.totalPacketsSent===n.packetsSent?(this.freezedProducingTransportIds.add(e),this.callStatsInstance&&u&&(this.callStatsInstance.logger.debug("callStats::measurements::producingTransportFreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("producing_transport_status","pause",e))):(r.totalPacketsSent=n.packetsSent,this.freezedProducingTransportIds.has(e)&&(this.freezedProducingTransportIds.delete(e),this.callStatsInstance&&u&&(this.callStatsInstance.logger.debug("callStats::measurements::producingTransportDefreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("producing_transport_status","resume",e))))}processConsumingTransportStats(e,r,n){var o,c;const a=!!Array.from(((c=(o=this==null?void 0:this.callStatsInstance)==null?void 0:o.consumerSharedMediaStatesMap)==null?void 0:c.values())||[]).reduce((u,h)=>u||h.audio||h.video||h.screen,!1);r.totalPacketsReceived===n.packetsSent?(this.freezedConsumingTransportIds.add(e),this.callStatsInstance&&a&&(this.callStatsInstance.logger.debug("callStats::measurements::consumingTransportFreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("consuming_transport_status","pause",e))):(r.totalPacketsReceived=n.packetsSent,this.freezedConsumingTransportIds.has(e)&&(this.freezedConsumingTransportIds.delete(e),this.callStatsInstance&&a&&(this.callStatsInstance.logger.debug("callStats::measurements::consumingTransportDefreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("consuming_transport_status","resume",e))))}async registerConsumer(e){await this.generateConsumerStreamMap(e),this.consumerPeerIdMap.set(e.id,{producerId:e.producerId,peerId:e.appData.peerId,appData:e.appData}),e.observer.on("close",this.deregisterConsumer.bind(this,e)),e.observer.on("pause",this.pauseConsumer.bind(this,e.id)),e.observer.on("resume",this.resumeConsumer.bind(this,e.id)),e.appData.screenShare===!0&&this.screenShareConsumers.add(e.id)}pauseConsumer(e){this.pausedConsumerMap.set(e,{lastReportCalculated:!1})}resumeConsumer(e){this.pausedConsumerMap.delete(e)}async generateProducerStreamMap(e,r=!1){const n=await e.getStats(),i=r?this.getProducerStatsFromReport(this.parseRTCReport(n,["outbound-rtp","remote-inbound-rtp"],!1,e.id))[0]:void 0;for(const a of n.values())switch(a.type){case"outbound-rtp":{this.outboundProducerMap.set(a.id,e.id);break}}return i}async generateConsumerStreamMap(e,r=!1){const n=await e.getStats(),i=r?this.getConsumerStatsFromReport(this.parseRTCReport(n,["inbound-rtp"],!1,e.id))[0]:void 0;for(const a of n.values())switch(a.type){case"inbound-rtp":{this.inboundConsumerMap.set(a.id,e.id);break}}return i}deregisterProducer(e){this.outboundProducerMap.forEach((r,n)=>{r===e.id&&this.outboundProducerMap.delete(n)}),this.pausedProducerMap.delete(e.id),this.screenShareProducers.delete(e.id)}deregisterConsumer(e){this.inboundConsumerMap.forEach((r,n)=>{r===e.id&&this.inboundConsumerMap.delete(n)}),this.consumerPeerIdMap.delete(e.id),this.pausedConsumerMap.delete(e.id),this.screenShareConsumers.delete(e.id)}getIceCandidateStats(e){var r;return{id:e.id,type:e.candidateType||e.type,address:e.address,port:e.port,url:e.url,protocol:(r=e.relayProtocol)!=null?r:e.protocol,networkType:e.networkType,relatedAddress:e.relatedAddress,relatedPort:e.relatedPort}}getWorkingSimulcastVideoStats(e){return e.find(n=>{const i=n.framesEncoded>0,a=n.packetsSent>0,o=n.frameWidth&&n.frameHeight;return i&&a&&!!o})||e[e.length-1]}parseRTCReport(e,r=[],n=!1,i=void 0,a=void 0){var P,k,I,x,$,O,K,X,oe,Te,It,Ue,At;const o=e,c=new wh,u=r.length?new Set(r):void 0,h=[],p=[],f=[],v=new Map,y=new Map;for(const M of o.values()){if(u){if(u.size===0)break;if(u.has(M.type))n&&u.delete(M.type);else continue}switch(M.type){case"local-candidate":{h.push(this.getIceCandidateStats(M));break}case"remote-candidate":{p.push(this.getIceCandidateStats(M));break}case"candidate-pair":{const{nominated:E}=M,{selected:R}=M,B=M,$e={nominated:E!=null?E:R,currentRoundTripTime:B.currentRoundTripTime,totalRoundTripTime:B.totalRoundTripTime,bytesReceived:B.bytesReceived,bytesSent:B.bytesSent,availableOutgoingBitrate:B.availableOutgoingBitrate,lastPacketReceivedTimestamp:B.lastPacketReceivedTimestamp,lastPacketSentTimestamp:B.lastPacketSentTimestamp,localCandidateId:B.localCandidateId,remoteCandidateId:B.remoteCandidateId,bytesDiscardedOnSend:B.bytesDiscardedOnSend,packetsSent:B.packetsSent,packetsReceived:B.packetsReceived,packetsDiscardedOnSend:B.packetsDiscardedOnSend};f.push($e),(M.nominated===!0||M.selected===!0)&&(c.candidatePair=$e);break}case"transport":{const E=M;a&&(a.producing&&(this.overallProducingTransportsStatsMap[a.id]||(this.overallProducingTransportsStatsMap[a.id]={totalPacketsSent:0})),a.consuming&&(this.overallConsumingTransportsStatsMap[a.id]||(this.overallConsumingTransportsStatsMap[a.id]={totalPacketsReceived:0})));const R={bytesReceived:E.bytesReceived,bytesSent:E.bytesSent,packetsSent:E.packetsSent,packetsReceived:E.packetsReceived,dtlsCipher:E.dtlsCipher,dtlsState:E.dtlsState,iceRole:E.iceRole};if(c.transport=R,a){if(a.producing){const B=this.overallProducingTransportsStatsMap[a.id];this.processProducingTransportStats(a.id,B,R)}if(a.consuming){const B=this.overallConsumingTransportsStatsMap[a.id];this.processConsumingTransportStats(a.id,B,R)}}break}case"remote-inbound-rtp":{const E=M,R={jitter:E.jitter,fractionLost:E.fractionLost,roundTripTime:E.roundTripTime,roundTripTimeMeasurements:E.roundTripTimeMeasurements,totalRoundTripTime:E.totalRoundTripTime,packetsLost:E.packetsLost};c.remoteInboundRtp.set(E.localId,R);break}case"outbound-rtp":{const E=M,R=i||this.outboundProducerMap.get(M.id),B=this.pausedProducerMap.get(R);if(B){if(B.lastReportCalculated===!0)break;this.pausedProducerMap.set(R,{lastReportCalculated:!0})}this.overallProducersStatsMap[R]||(this.overallProducersStatsMap[R]={totalVideoPacketsSent:0,totalAudioPacketsSent:0});const $e=this.overallProducersStatsMap[R];if(["video","audio"].includes(E.mediaType)||["video","audio"].includes(E.kind)){if(!this.outboundProducerMap.has(M.id)){c.staleProducerStreamMap=!0;break}const Qe=this.callStatsInstance.producers.get(R);if(((P=Qe==null?void 0:Qe.track)==null?void 0:P.readyState)==="ended")break;c.producerStreamMap.has(R)||c.producerStreamMap.set(R,{outboundVideoRtpId:[],outboundAudioRtpId:[]});const W={bytesSent:E.bytesSent,packetsSent:E.packetsSent,nackCount:E.nackCount,ssrc:E.ssrc,mid:E.mid};if(E.mediaType==="video"||E.kind==="video"){if(E.decoderImplementation==="unknown")break;const A=E,rt={frameHeight:A.frameHeight,frameWidth:A.frameWidth,framesEncoded:A.framesEncoded,framesDropped:A.framesDropped,framesPerSecond:A.framesPerSecond,framesSent:A.framesSent,keyFramesEncoded:A.keyFramesEncoded,firCount:A.firCount,encoderImplementation:A.encoderImplementation,hugeFramesSent:A.hugeFramesSent,pliCount:A.pliCount,qpSum:A.qpSum,qualityLimitationDurations:A.qualityLimitationDurations,qualityLimitationReason:A.qualityLimitationReason,qualityLimitationResolutionChanges:A.qualityLimitationResolutionChanges,totalEncodeTime:A.targetBitrate,totalPacketSendDelay:A.totalPacketSendDelay,retransmittedBytesSent:A.retransmittedBytesSent,retransmittedPacketsSent:A.retransmittedPacketsSent,...W};c.outboundVideoRtp.set(M.id,rt),c.producerStreamMap.get(R).outboundVideoRtpId.push(M.id),this.processOutboundProducerVideoStats(R,$e,rt)}else if(E.mediaType==="audio"||E.kind==="audio"){const A=E,rt={retransmittedBytesSent:A.retransmittedBytesSent,retransmittedPacketsSent:A.retransmittedPacketsSent,...W};c.outboundAudioRtp.set(M.id,rt),c.producerStreamMap.get(R).outboundAudioRtpId.push(M.id),this.processOutboundProducerAudioStats(R,$e,rt)}}else this.callStatsInstance.logger.error(`Callstats: Unknown Outbound-rtp. mediatype: ${E.mediaType} kind: ${E.kind}`);break}case"inbound-rtp":{const E=M,R=i||this.inboundConsumerMap.get(M.id),B=this.pausedConsumerMap.get(R);if(B){if(B.lastReportCalculated===!0)break;this.pausedConsumerMap.set(R,{lastReportCalculated:!0})}if(E.ssrc===1234)break;this.overallConsumersStatsMap[R]||(this.overallConsumersStatsMap[R]={totalVideoPacketsReceived:0,totalAudioPacketsReceived:0});const $e=this.overallConsumersStatsMap[R];if(["video","audio"].includes(E.mediaType)||["video","audio"].includes(E.kind)){if(!this.inboundConsumerMap.has(M.id)){c.staleConsumerStreamMap=!0;break}c.consumerStreamMap.has(R)||c.consumerStreamMap.set(R,{inboundVideoRtpId:[],inboundAudioRtpId:[]});const Qe={bytesReceived:E.bytesReceived,packetsReceived:E.packetsReceived,packetsLost:E.packetsLost,jitter:E.jitter,nackCount:E.nackCount,jitterBufferDelay:E.jitterBufferDelay,jitterBufferEmittedCount:E.jitterBufferEmittedCount,lastPacketReceivedTimestamp:E.lastPacketReceivedTimestamp,ssrc:E.ssrc,mid:E.mid};if(E.mediaType==="video"||E.kind==="video"){if(E.decoderImplementation==="unknown")break;const W=E,A={frameHeight:W.frameHeight,frameWidth:W.frameWidth,framesDecoded:W.framesDecoded,framesDropped:W.framesDropped,framesPerSecond:W.framesPerSecond,framesReceived:W.framesReceived,keyFramesDecoded:W.keyFramesDecoded,firCount:W.firCount,decoderImplementation:W.decoderImplementation,pliCount:W.pliCount,totalProcessingDelay:W.totalProcessingDelay,...Qe};A.score=Th({frameWidth:A.frameWidth||0,framesDecoded:(A.framesDecoded||0)-(((k=this.videoConsumerToStatsMap.get(R))==null?void 0:k.framesDecoded)||0),framesPerSecond:A.framesPerSecond||0,packetsLost:(A.packetsLost||0)-(((I=this.videoConsumerToStatsMap.get(R))==null?void 0:I.packetsLost)||0),packetsReceived:(A.packetsReceived||0)-(((x=this.videoConsumerToStatsMap.get(R))==null?void 0:x.packetsReceived)||0),jitter:A.jitter||0,isScreenShare:this.screenShareConsumers.has(R)}),y.set(R,{score:+(A.score*10).toFixed(),frameWidth:A.frameWidth||0,frameHeight:A.frameHeight||0,framesPerSecond:A.framesPerSecond||0,packetsLostPercentage:xo({packetsLost:(A.packetsLost||0)-((($=this.videoConsumerToStatsMap.get(R))==null?void 0:$.packetsLost)||0),packetsReceived:(A.packetsReceived||0)-(((O=this.videoConsumerToStatsMap.get(R))==null?void 0:O.packetsReceived)||0)}),jitter:A.jitter||0,isScreenShare:this.screenShareConsumers.has(R),bitrate:((A.bytesReceived||0)-(((K=this.videoConsumerToStatsMap.get(R))==null?void 0:K.bytesReceived)||0))*8/7}),this.videoConsumerToStatsMap.set(R,A),c.inboundVideoRtp.set(M.id,A),c.consumerStreamMap.get(R).inboundVideoRtpId.push(M.id),this.processInboundConsumerVideoStats(R,$e,A)}else if(E.mediaType==="audio"||E.kind==="audio"){const W=E,A={audioLevel:W.audioLevel,concealedSampels:W.concealedSampels,concealmentEvents:W.concealmentEvents,totalAudioEnergy:W.totalAudioEnergy,totalSamplesDuration:W.totalSamplesDuration,totalSamplesReceived:W.totalSamplesReceived,...Qe};A.score=yh({concealmentEvents:(A.concealmentEvents||0)-(((X=this.audioConsumerToStatsMap.get(R))==null?void 0:X.concealmentEvents)||0),packetsLost:(A.packetsLost||0)-(((oe=this.audioConsumerToStatsMap.get(R))==null?void 0:oe.packetsLost)||0),packetsReceived:(A.packetsReceived||0)-(((Te=this.audioConsumerToStatsMap.get(R))==null?void 0:Te.packetsReceived)||0),jitter:A.jitter||0}),y.set(R,{score:+(A.score*10).toFixed(),packetsLostPercentage:xo({packetsLost:(A.packetsLost||0)-(((It=this.audioConsumerToStatsMap.get(R))==null?void 0:It.packetsLost)||0),packetsReceived:(A.packetsReceived||0)-(((Ue=this.audioConsumerToStatsMap.get(R))==null?void 0:Ue.packetsReceived)||0)}),jitter:A.jitter||0,isScreenShare:this.screenShareConsumers.has(R),bitrate:((A.bytesReceived||0)-(((At=this.audioConsumerToStatsMap.get(R))==null?void 0:At.bytesReceived)||0))*8/7}),this.audioConsumerToStatsMap.set(R,A),c.inboundAudioRtp.set(M.id,A),c.consumerStreamMap.get(R).inboundAudioRtpId.push(M.id),this.processInboundConsumerAudioStats(R,$e,A)}}else this.callStatsInstance.logger.error(`Callstats: Unknown Inbound-rtp. mediatype: ${E.mediaType} kind: ${E.kind}`);break}}}if(c.producerStreamMap.forEach((M,E)=>{var R,B,$e,Qe,W,A,rt,as,vo,yo,To,_o,So,Eo,wo,Co,bo,Po,Ro,ko,Io,Ao,Mo;if(M.outboundVideoRtpId.length>0){const Pe=[];M.outboundVideoRtpId.forEach(qu=>{Pe.push(c.outboundVideoRtp.get(qu))});const fe=this.getWorkingSimulcastVideoStats(Pe);fe.score=gh({frameWidth:fe.frameWidth||0,framesPerSecond:fe.framesPerSecond||0,jitter:((R=fe.remoteData)==null?void 0:R.jitter)||0,isScreenShare:this.screenShareProducers.has(E),packetsSent:(fe.packetsSent||0)-(((B=this.videoProducerToStatsMap.get(E))==null?void 0:B.packetsSent)||0),packetsLost:((($e=fe.remoteData)==null?void 0:$e.packetsLost)||0)-(((W=(Qe=this.videoProducerToStatsMap.get(E))==null?void 0:Qe.remoteData)==null?void 0:W.packetsLost)||0),framesEncoded:(fe.framesEncoded||0)-(((A=this.videoProducerToStatsMap.get(E))==null?void 0:A.framesEncoded)||0)}),v.set(E,{score:+(fe.score*10).toFixed(),frameWidth:fe.frameWidth||0,frameHeight:fe.frameHeight||0,framesPerSecond:fe.framesPerSecond||0,jitter:((rt=fe.remoteData)==null?void 0:rt.jitter)||0,isScreenShare:this.screenShareProducers.has(E),packetsLostPercentage:Fo({packetsSent:(fe.packetsSent||0)-(((as=this.videoProducerToStatsMap.get(E))==null?void 0:as.packetsSent)||0),packetsLost:(((vo=fe.remoteData)==null?void 0:vo.packetsLost)||0)-(((To=(yo=this.videoProducerToStatsMap.get(E))==null?void 0:yo.remoteData)==null?void 0:To.packetsLost)||0)}),bitrate:((fe.bytesSent||0)-(((_o=this.videoProducerToStatsMap.get(E))==null?void 0:_o.bytesSent)||0))*8/7}),this.videoProducerToStatsMap.set(E,fe)}else if(M.outboundAudioRtpId.length>0){const Pe=c.outboundAudioRtp.get(M.outboundAudioRtpId[0]);Pe.score=fh({packetsSent:(Pe.packetsSent||0)-(((So=this.audioProducerToStatsMap.get(E))==null?void 0:So.packetsSent)||0),packetsLost:(((Eo=Pe.remoteData)==null?void 0:Eo.packetsLost)||0)-(((Co=(wo=this.audioProducerToStatsMap.get(E))==null?void 0:wo.remoteData)==null?void 0:Co.packetsLost)||0),jitter:((bo=Pe.remoteData)==null?void 0:bo.jitter)||0}),v.set(E,{score:+(Pe.score*10).toFixed(),bitrate:((Pe.bytesSent||0)-(((Po=this.audioProducerToStatsMap.get(E))==null?void 0:Po.bytesSent)||0))*8/7,packetsLostPercentage:Fo({packetsSent:(Pe.packetsSent||0)-(((Ro=this.audioProducerToStatsMap.get(E))==null?void 0:Ro.packetsSent)||0),packetsLost:(((ko=Pe.remoteData)==null?void 0:ko.packetsLost)||0)-(((Ao=(Io=this.audioProducerToStatsMap.get(E))==null?void 0:Io.remoteData)==null?void 0:Ao.packetsLost)||0)}),jitter:((Mo=Pe.remoteData)==null?void 0:Mo.jitter)||0,isScreenShare:this.screenShareProducers.has(E)}),this.audioProducerToStatsMap.set(E,Pe)}}),f.forEach(M=>{const E=h.find(B=>B.id===M.localCandidateId?(M.localCandidateId=B.id,B):null),R=p.find(B=>B.id===M.remoteCandidateId?(M.remoteCandidateId=B.id,B):null);E&&(M.localCandidateType=E.type,M.localCandidateAddress=E.address,M.localCandidatePort=E.port,M.localCandidateProtocol=E.protocol,M.localCandidateUrl=E.url,M.localCandidateNetworkType=E.networkType,M.localCandidateRelatedAddress=E.relatedAddress,M.localCandidateRelatedPort=E.relatedPort),R&&(M.remoteCandidateType=R.type,M.remoteCandidateAddress=R.address,M.remoteCandidatePort=R.port,M.remoteCandidateProtocol=R.protocol,M.remoteCandidateUrl=R.url)}),c.candidatePair&&(c.transport?(c.transport.totalRoundTripTime=c.candidatePair.totalRoundTripTime,c.transport.availableOutgoingBitrate=c.candidatePair.availableOutgoingBitrate,c.transport.roundTripTime=c.candidatePair.currentRoundTripTime):c.transport={bytesReceived:c.candidatePair.bytesReceived,bytesSent:c.candidatePair.bytesSent,totalRoundTripTime:c.candidatePair.totalRoundTripTime,availableOutgoingBitrate:c.candidatePair.availableOutgoingBitrate,roundTripTime:c.candidatePair.currentRoundTripTime}),c.transport&&(c.transport.candidatePairs=f),c.transport&&!c.transport.roundTripTime){let M=0,E=0;c.remoteInboundRtp.forEach((R,B)=>{R.roundTripTime&&R.roundTripTime>M&&(M=R.roundTripTime,E=R.totalRoundTripTime)}),c.transport.roundTripTime=M,c.transport.totalRoundTripTime=E}if(y.size>0)try{this.observer.emit("consumer_score",y)}catch(M){}if(v.size>0)try{this.observer.emit("producer_score",v)}catch(M){}return c}async getProducersReport(e){const r=e.map(n=>this.generateProducerStreamMap(n,!0));return r.length>0?Promise.all(r):void 0}async getConsumersReport(e){const r=e.map(n=>this.generateConsumerStreamMap(n,!0));return r.length>0?Promise.all(r):void 0}async getTransportReport(e){return e.getStats()}async getProcessedStats(e,r,n){const i=await this.getTransportReport(e),a={producing:n,consuming:r,id:e.id},o=i,c=this.parseRTCReport(o,["transport","candidate-pair","inbound-rtp","outbound-rtp","remote-inbound-rtp","local-candidate","remote-candidate"],!1,void 0,a);if(!c)return;const u={stats:c.transport,transportId:e.id,consuming:r,producing:n},h=c.staleProducerStreamMap?void 0:this.getProducerStatsFromReport(c),p=c.staleConsumerStreamMap?void 0:this.getConsumerStatsFromReport(c);return{transportReport:u,producerReport:h,consumerReport:p}}getProducerStatsFromReport(e){const r=[];try{e.producerStreamMap.forEach((n,i)=>{var a,o;r.push({producerId:i,videoStats:n.outboundVideoRtpId.map(c=>e.outboundVideoRtp.get(c)),audioStats:n.outboundAudioRtpId.map(c=>e.outboundAudioRtp.get(c)),appData:((o=(a=this.callStatsInstance.producers)==null?void 0:a.get(i))==null?void 0:o.appData)||null})})}catch(n){this.callStatsInstance.logger.error("callStats::measurements::getProducerStatsFromReport",{error:{reason:n.reason,message:n.message}})}return r}getConsumerStatsFromReport(e){const r=[];try{e.consumerStreamMap.forEach((n,i)=>{const{peerId:a,producerId:o,appData:c}=this.consumerPeerIdMap.get(i);r.push({consumerId:i,peerId:a,producerId:o,appData:c,videoStats:n.inboundVideoRtpId.map(u=>e.inboundVideoRtp.get(u)),audioStats:n.inboundAudioRtpId.map(u=>e.inboundAudioRtp.get(u))})})}catch(n){console.error("getConsumersReport: ",n,e)}return r}async getUserLocation(){return new Promise((e,r)=>{try{navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>{e(n)}):r()}catch(n){r(n)}})}async getConnectivity(e){try{const r={iceServers:e||Sh},n=new Promise((h,p)=>{try{const f=new ly(r);f.addListener("done",h),f.addListener("failed",()=>{h({connectivity:!1})}),f.start(2e3)}catch(f){p(f)}}),i=new Promise((h,p)=>{try{const f=new uy(r);f.addListener("done",h),f.addListener("failed",()=>{h({connectivity:!1})}),f.start(2e3)}catch(f){p(f)}}),a=new Promise((h,p)=>{try{const f=new hy(r);f.addListener("done",h),f.addListener("failed",()=>{h({connectivity:!1})}),f.start(2e3)}catch(f){p(f)}}),[o,c,u]=await Promise.all([n,i,a]);return{host:o==null?void 0:o.connectivity,relay:c==null?void 0:c.connectivity,reflexive:u==null?void 0:u.connectivity}}catch(r){return{host:!1,relay:!1,reflexive:!1}}}async getThroughput(e){try{const n=await new Promise((i,a)=>{try{const o={iceServers:e||Sh},c=new dy(o);c.addListener("done",i),c.addListener("failed",a),c.start(1e4)}catch(o){a(o)}});return{throughput:n.throughput,fractionalLoss:0,RTT:n.RTT,jitter:0,backendRTT:n.backendRTT}}catch(r){return}}async getIPDetails(){var e,r;try{return this.ipDetails||(this.ipDetails=await Nd.getIPDetails({peerId:(e=this.callStatsInstance)==null?void 0:e.peerId,apiHostnames:(r=this.callStatsInstance)==null?void 0:r.apiHostnames})),this.ipDetails}catch(n){return}}async getNetworkQuality(e){const[r,n]=await Promise.all([this.getConnectivity(e),this.getThroughput(e)]);return{connectivity:r,throughput:n==null?void 0:n.throughput,fractionalLoss:n==null?void 0:n.fractionalLoss,RTT:n==null?void 0:n.RTT,jitter:n==null?void 0:n.jitter,backendRTT:n==null?void 0:n.backendRTT}}async getNetworkInfo(e,r=!1){var o,c;if(r){const u=await this.getIPDetails();return{ipDetails:u,effectiveNetworkType:(o=navigator.connection)==null?void 0:o.effectiveType,location:u.loc?Eh(u.loc):void 0}}const[n,i,a]=await Promise.all([this.getConnectivity(e),this.getThroughput(e),this.getIPDetails()]);return{ipDetails:a,effectiveNetworkType:(c=navigator.connection)==null?void 0:c.effectiveType,location:a.loc?Eh(a.loc):void 0,turnConnectivity:n?n.host||n.relay||n.reflexive:!1,connectivity:n,throughput:i==null?void 0:i.throughput,fractionalLoss:i==null?void 0:i.fractionalLoss,RTT:i==null?void 0:i.RTT,jitter:i==null?void 0:i.jitter,backendRTT:i==null?void 0:i.backendRTT}}}class my extends Ch{}class bh extends Ch{constructor(){super(...arguments);m(this,"producerMap",new Map);m(this,"consumerMap",new Map)}async registerProducer(e){this.producerMap.set(e.id,e),await this.generateProducerStreamMap(e),e.observer.on("close",this.deregisterProducer.bind(this,e)),e.observer.on("pause",this.pauseProducer.bind(this,e.id)),e.observer.on("resume",this.resumeProducer.bind(this,e.id)),e.appData.screenShare===!0&&this.screenShareProducers.add(e.id)}async registerConsumer(e){this.consumerMap.set(e.id,e),await this.generateConsumerStreamMap(e),this.consumerPeerIdMap.set(e.id,{producerId:e.producerId,peerId:e.appData.peerId,appData:e.appData}),e.observer.on("close",this.deregisterConsumer.bind(this,e)),e.observer.on("pause",this.pauseConsumer.bind(this,e.id)),e.observer.on("resume",this.resumeConsumer.bind(this,e.id)),e.appData.screenShare===!0&&this.screenShareConsumers.add(e.id)}async generateConsumerStreamMap(e,r=!1){const n=await e.getStats(),i=this.parseRTCReport(n,["inbound-rtp"],!1,e.id),a=[...i.consumerStreamMap.values()][0],o=r?this.getConsumerStatsFromParsedConsumerStats(i,a,e.id):void 0;for(const c of n.values())switch(c.type){case"inbound-rtp":{this.inboundConsumerMap.set(c.id,e.id);break}}return o}deregisterProducer(e){this.producerMap.delete(e.id),this.outboundProducerMap.forEach((r,n)=>{r===e.id&&this.outboundProducerMap.delete(n)}),this.pausedProducerMap.delete(e.id),this.screenShareProducers.delete(e.id)}deregisterConsumer(e){this.consumerMap.delete(e.id),this.inboundConsumerMap.forEach((r,n)=>{r===e.id&&this.inboundConsumerMap.delete(n)}),this.consumerPeerIdMap.delete(e.id),this.pausedConsumerMap.delete(e.id),this.screenShareConsumers.delete(e.id)}getIceCandidateStats(e){var r;return{id:e.id,type:e.candidateType||e.type,address:e.address,port:e.port,url:e.url,protocol:(r=e.relayProtocol)!=null?r:e.protocol,networkType:e.networkType,relatedAddress:e.relatedAddress,relatedPort:e.relatedPort}}parseRTCReport(e,r=[],n=!1,i=void 0,a=void 0){var P,k,I,x,$,O,K,X,oe,Te,It,Ue,At;const o=e,c=new wh,u=r.length?new Set(r):void 0,h=[],p=[],f=[],v=new Map,y=new Map;for(const M of o.values()){if(u){if(u.size===0)break;if(u.has(M.type))n&&u.delete(M.type);else continue}switch(M.type){case"local-candidate":{h.push(this.getIceCandidateStats(M));break}case"remote-candidate":{p.push(this.getIceCandidateStats(M));break}case"candidate-pair":{const{nominated:E}=M,{selected:R}=M,B=M,$e={nominated:E!=null?E:R,currentRoundTripTime:B.currentRoundTripTime,totalRoundTripTime:B.totalRoundTripTime,bytesReceived:B.bytesReceived,bytesSent:B.bytesSent,availableOutgoingBitrate:B.availableOutgoingBitrate,lastPacketReceivedTimestamp:B.lastPacketReceivedTimestamp,lastPacketSentTimestamp:B.lastPacketSentTimestamp,localCandidateId:B.localCandidateId,remoteCandidateId:B.remoteCandidateId,bytesDiscardedOnSend:B.bytesDiscardedOnSend,packetsSent:B.packetsSent,packetsReceived:B.packetsReceived,packetsDiscardedOnSend:B.packetsDiscardedOnSend};f.push($e),(M.nominated===!0||M.selected===!0)&&(c.candidatePair=$e);break}case"transport":{const E=M;a&&(a.producing&&(this.overallProducingTransportsStatsMap[a.id]||(this.overallProducingTransportsStatsMap[a.id]={totalPacketsSent:0})),a.consuming&&(this.overallConsumingTransportsStatsMap[a.id]||(this.overallConsumingTransportsStatsMap[a.id]={totalPacketsReceived:0})));const R={bytesReceived:E.bytesReceived,bytesSent:E.bytesSent,packetsSent:E.packetsSent,packetsReceived:E.packetsReceived,dtlsCipher:E.dtlsCipher,dtlsState:E.dtlsState,iceRole:E.iceRole};if(c.transport=R,a){if(a.producing){const B=this.overallProducingTransportsStatsMap[a.id];this.processProducingTransportStats(a.id,B,R)}if(a.consuming){const B=this.overallConsumingTransportsStatsMap[a.id];this.processConsumingTransportStats(a.id,B,R)}}break}case"remote-inbound-rtp":{const E=M,R={jitter:E.jitter,fractionLost:E.fractionLost,roundTripTime:E.roundTripTime,roundTripTimeMeasurements:E.roundTripTimeMeasurements,totalRoundTripTime:E.totalRoundTripTime,packetsLost:E.packetsLost};c.remoteInboundRtp.set(E.localId,R);break}case"outbound-rtp":{const E=M,R=i||this.outboundProducerMap.get(M.id),B=this.pausedProducerMap.get(R);if(B){if(B.lastReportCalculated===!0)break;this.pausedProducerMap.set(R,{lastReportCalculated:!0})}this.overallProducersStatsMap[R]||(this.overallProducersStatsMap[R]={totalVideoPacketsSent:0,totalAudioPacketsSent:0});const $e=this.overallProducersStatsMap[R];if(["video","audio"].includes(E.mediaType)||["video","audio"].includes(E.kind)){if(!this.outboundProducerMap.has(M.id)){c.staleProducerStreamMap=!0;break}const Qe=this.callStatsInstance.producers.get(R);if(((P=Qe==null?void 0:Qe.track)==null?void 0:P.readyState)==="ended")break;c.producerStreamMap.has(R)||c.producerStreamMap.set(R,{outboundVideoRtpId:[],outboundAudioRtpId:[]});const W={bytesSent:E.bytesSent,packetsSent:E.packetsSent,nackCount:E.nackCount,ssrc:E.ssrc,mid:E.mid};if(E.mediaType==="video"||E.kind==="video"){if(E.decoderImplementation==="unknown")break;const A=E,rt={frameHeight:A.frameHeight,frameWidth:A.frameWidth,framesEncoded:A.framesEncoded,framesDropped:A.framesDropped?A.framesDropped:A.droppedFrames,framesPerSecond:A.framesPerSecond?A.framesPerSecond:A.framerateMean,framesSent:A.framesSent,keyFramesEncoded:A.keyFramesEncoded,firCount:A.firCount,encoderImplementation:A.encoderImplementation,hugeFramesSent:A.hugeFramesSent,pliCount:A.pliCount,qpSum:A.qpSum,qualityLimitationReason:A.qualityLimitationReason,qualityLimitationDurations:A.qualityLimitationDurations,qualityLimitationResolutionChanges:A.qualityLimitationResolutionChanges,totalEncodeTime:A.totalEncodeTime,totalPacketSendDelay:A.totalEncodeTime,retransmittedBytesSent:A.retransmittedBytesSent,retransmittedPacketsSent:A.retransmittedPacketsSent,...W};c.outboundVideoRtp.set(M.id,rt),c.producerStreamMap.get(R).outboundVideoRtpId.push(M.id),this.processOutboundProducerVideoStats(R,$e,rt)}else if(E.mediaType==="audio"||E.kind==="audio"){const A=E,rt={retransmittedBytesSent:A.retransmittedBytesSent,retransmittedPacketsSent:A.retransmittedPacketsSent,...W};c.outboundAudioRtp.set(M.id,rt),c.producerStreamMap.get(R).outboundAudioRtpId.push(M.id),this.processOutboundProducerAudioStats(R,$e,rt)}}else this.callStatsInstance.logger.error(`Callstats: Unknown Outbound-rtp. mediatype: ${E.mediaType} kind: ${E.kind}`);break}case"inbound-rtp":{const E=M,R=i||this.inboundConsumerMap.get(M.id),B=this.pausedConsumerMap.get(R);if(B){if(B.lastReportCalculated===!0)break;this.pausedConsumerMap.set(R,{lastReportCalculated:!0})}if(E.ssrc===1234)break;this.overallConsumersStatsMap[R]||(this.overallConsumersStatsMap[R]={totalVideoPacketsReceived:0,totalAudioPacketsReceived:0});const $e=this.overallConsumersStatsMap[R];if(["video","audio"].includes(E.mediaType)||["video","audio"].includes(E.kind)){if(!this.inboundConsumerMap.has(M.id)){c.staleConsumerStreamMap=!0;break}c.consumerStreamMap.has(R)||c.consumerStreamMap.set(R,{inboundVideoRtpId:[],inboundAudioRtpId:[]});const Qe={bytesReceived:E.bytesReceived,packetsReceived:E.packetsReceived,packetsLost:E.packetsLost,jitter:E.jitter,nackCount:E.nackCount,jitterBufferDelay:E.jitterBufferDelay,jitterBufferEmittedCount:E.jitterBufferEmittedCount,lastPacketReceivedTimestamp:E.lastPacketReceivedTimestamp,ssrc:E.ssrc,mid:E.mid};if(E.mediaType==="video"||E.kind==="video"){if(E.decoderImplementation==="unknown")break;const W=E,A={frameHeight:W.frameHeight,frameWidth:W.frameWidth,framesDecoded:W.framesDecoded,framesDropped:W.framesDropped?W.framesDropped:W.droppedFrames,framesPerSecond:W.framesPerSecond?W.framesPerSecond:W.framerateMean,framesReceived:W.framesReceived,keyFramesDecoded:W.keyFramesDecoded,firCount:W.firCount,decoderImplementation:W.decoderImplementation,pliCount:W.pliCount,totalProcessingDelay:W.totalProcessingDelay,...Qe};A.score=Th({frameWidth:A.frameWidth||0,framesDecoded:(A.framesDecoded||0)-(((k=this.videoConsumerToStatsMap.get(R))==null?void 0:k.framesDecoded)||0),framesPerSecond:A.framesPerSecond||0,packetsLost:(A.packetsLost||0)-(((I=this.videoConsumerToStatsMap.get(R))==null?void 0:I.packetsLost)||0),packetsReceived:(A.packetsReceived||0)-(((x=this.videoConsumerToStatsMap.get(R))==null?void 0:x.packetsReceived)||0),jitter:A.jitter||0,isScreenShare:this.screenShareConsumers.has(R)}),y.set(R,{score:+(A.score*10).toFixed(),frameWidth:A.frameWidth||0,frameHeight:A.frameHeight||0,framesPerSecond:A.framesPerSecond||0,packetsLostPercentage:xo({packetsLost:(A.packetsLost||0)-((($=this.videoConsumerToStatsMap.get(R))==null?void 0:$.packetsLost)||0),packetsReceived:(A.packetsReceived||0)-(((O=this.videoConsumerToStatsMap.get(R))==null?void 0:O.packetsReceived)||0)}),jitter:A.jitter||0,isScreenShare:this.screenShareConsumers.has(R),bitrate:((A.bytesReceived||0)-(((K=this.videoConsumerToStatsMap.get(R))==null?void 0:K.bytesReceived)||0))*8/7}),this.videoConsumerToStatsMap.set(R,A),c.inboundVideoRtp.set(M.id,A),c.consumerStreamMap.get(R).inboundVideoRtpId.push(M.id),this.processInboundConsumerVideoStats(R,$e,A)}else if(E.mediaType==="audio"||E.kind==="audio"){const W=E,A={audioLevel:W.audioLevel,concealedSampels:W.concealedSampels,concealmentEvents:W.concealmentEvents,totalAudioEnergy:W.totalAudioEnergy,totalSamplesDuration:W.totalSamplesDuration,totalSamplesReceived:W.totalSamplesReceived,...Qe};A.score=yh({concealmentEvents:(A.concealmentEvents||0)-(((X=this.audioConsumerToStatsMap.get(R))==null?void 0:X.concealmentEvents)||0),packetsLost:(A.packetsLost||0)-(((oe=this.audioConsumerToStatsMap.get(R))==null?void 0:oe.packetsLost)||0),packetsReceived:(A.packetsReceived||0)-(((Te=this.audioConsumerToStatsMap.get(R))==null?void 0:Te.packetsReceived)||0),jitter:A.jitter||0}),y.set(R,{score:+(A.score*10).toFixed(),packetsLostPercentage:xo({packetsLost:(A.packetsLost||0)-(((It=this.audioConsumerToStatsMap.get(R))==null?void 0:It.packetsLost)||0),packetsReceived:(A.packetsReceived||0)-(((Ue=this.audioConsumerToStatsMap.get(R))==null?void 0:Ue.packetsReceived)||0)}),jitter:A.jitter||0,isScreenShare:this.screenShareConsumers.has(R),bitrate:((A.bytesReceived||0)-(((At=this.audioConsumerToStatsMap.get(R))==null?void 0:At.bytesReceived)||0))*8/7}),this.audioConsumerToStatsMap.set(R,A),c.inboundAudioRtp.set(M.id,A),c.consumerStreamMap.get(R).inboundAudioRtpId.push(M.id),this.processInboundConsumerAudioStats(R,$e,A)}}else this.callStatsInstance.logger.error(`Callstats: Unknown Inbound-rtp. mediatype: ${E.mediaType} kind: ${E.kind}`);break}}}if(c.producerStreamMap.forEach((M,E)=>{var R,B,$e,Qe,W,A,rt,as,vo,yo,To,_o,So,Eo,wo,Co,bo,Po,Ro,ko,Io,Ao,Mo;if(M.outboundVideoRtpId.length>0){const Pe=[];M.outboundVideoRtpId.forEach(qu=>{Pe.push(c.outboundVideoRtp.get(qu))});const fe=this.getWorkingSimulcastVideoStats(Pe);fe.score=gh({frameWidth:fe.frameWidth||0,framesPerSecond:fe.framesPerSecond||0,jitter:((R=fe.remoteData)==null?void 0:R.jitter)||0,isScreenShare:this.screenShareProducers.has(E),packetsSent:(fe.packetsSent||0)-(((B=this.videoProducerToStatsMap.get(E))==null?void 0:B.packetsSent)||0),packetsLost:((($e=fe.remoteData)==null?void 0:$e.packetsLost)||0)-(((W=(Qe=this.videoProducerToStatsMap.get(E))==null?void 0:Qe.remoteData)==null?void 0:W.packetsLost)||0),framesEncoded:(fe.framesEncoded||0)-(((A=this.videoProducerToStatsMap.get(E))==null?void 0:A.framesEncoded)||0)}),v.set(E,{score:+(fe.score*10).toFixed(),frameWidth:fe.frameWidth||0,frameHeight:fe.frameHeight||0,framesPerSecond:fe.framesPerSecond||0,jitter:((rt=fe.remoteData)==null?void 0:rt.jitter)||0,isScreenShare:this.screenShareProducers.has(E),packetsLostPercentage:Fo({packetsSent:(fe.packetsSent||0)-(((as=this.videoProducerToStatsMap.get(E))==null?void 0:as.packetsSent)||0),packetsLost:(((vo=fe.remoteData)==null?void 0:vo.packetsLost)||0)-(((To=(yo=this.videoProducerToStatsMap.get(E))==null?void 0:yo.remoteData)==null?void 0:To.packetsLost)||0)}),bitrate:((fe.bytesSent||0)-(((_o=this.videoProducerToStatsMap.get(E))==null?void 0:_o.bytesSent)||0))*8/7}),this.videoProducerToStatsMap.set(E,fe)}else if(M.outboundAudioRtpId.length>0){const Pe=c.outboundAudioRtp.get(M.outboundAudioRtpId[0]);Pe.score=fh({packetsSent:(Pe.packetsSent||0)-(((So=this.audioProducerToStatsMap.get(E))==null?void 0:So.packetsSent)||0),packetsLost:(((Eo=Pe.remoteData)==null?void 0:Eo.packetsLost)||0)-(((Co=(wo=this.audioProducerToStatsMap.get(E))==null?void 0:wo.remoteData)==null?void 0:Co.packetsLost)||0),jitter:((bo=Pe.remoteData)==null?void 0:bo.jitter)||0}),v.set(E,{score:+(Pe.score*10).toFixed(),bitrate:((Pe.bytesSent||0)-(((Po=this.audioProducerToStatsMap.get(E))==null?void 0:Po.bytesSent)||0))*8/7,packetsLostPercentage:Fo({packetsSent:(Pe.packetsSent||0)-(((Ro=this.audioProducerToStatsMap.get(E))==null?void 0:Ro.packetsSent)||0),packetsLost:(((ko=Pe.remoteData)==null?void 0:ko.packetsLost)||0)-(((Ao=(Io=this.audioProducerToStatsMap.get(E))==null?void 0:Io.remoteData)==null?void 0:Ao.packetsLost)||0)}),jitter:((Mo=Pe.remoteData)==null?void 0:Mo.jitter)||0,isScreenShare:this.screenShareProducers.has(E)}),this.audioProducerToStatsMap.set(E,Pe)}}),f.forEach(M=>{const E=h.find(B=>B.id===M.localCandidateId?(M.localCandidateId=B.id,B):null),R=p.find(B=>B.id===M.remoteCandidateId?(M.remoteCandidateId=B.id,B):null);E&&(M.localCandidateType=E.type,M.localCandidateAddress=E.address,M.localCandidatePort=E.port,M.localCandidateProtocol=E.protocol,M.localCandidateUrl=E.url,M.localCandidateNetworkType=E.networkType,M.localCandidateRelatedAddress=E.relatedAddress,M.localCandidateRelatedPort=E.relatedPort),R&&(M.remoteCandidateType=R.type,M.remoteCandidateAddress=R.address,M.remoteCandidatePort=R.port,M.remoteCandidateProtocol=R.protocol,M.remoteCandidateUrl=R.url)}),c.candidatePair&&(c.transport?(c.transport.bytesReceived=c.candidatePair.bytesReceived,c.transport.bytesSent=c.candidatePair.bytesSent,c.transport.totalRoundTripTime=c.candidatePair.totalRoundTripTime,c.transport.availableOutgoingBitrate=c.candidatePair.availableOutgoingBitrate,c.transport.roundTripTime=c.candidatePair.currentRoundTripTime):c.transport={bytesReceived:c.candidatePair.bytesReceived,bytesSent:c.candidatePair.bytesSent,totalRoundTripTime:c.candidatePair.totalRoundTripTime,availableOutgoingBitrate:c.candidatePair.availableOutgoingBitrate,roundTripTime:c.candidatePair.currentRoundTripTime}),c.transport&&(c.transport.candidatePairs=f),c.transport&&!c.transport.roundTripTime){let M=0,E=0;c.remoteInboundRtp.forEach((R,B)=>{R.roundTripTime&&R.roundTripTime>M&&(M=R.roundTripTime,E=R.totalRoundTripTime)}),c.transport.roundTripTime=M,c.transport.totalRoundTripTime=E}if(y.size>0)try{this.observer.emit("consumer_score",y)}catch(M){}if(v.size>0)try{this.observer.emit("producer_score",v)}catch(M){}return c}getProducerStatsFromReport(e){const r=[];try{e.producerStreamMap.forEach((n,i)=>{const a=this.producerMap.get(i),o=a.track.getSettings(),c=n.outboundVideoRtpId.map(h=>{const p=e.outboundVideoRtp.get(h);return p.frameHeight||(p.frameHeight=o.height,p.frameWidth=o.width,p.framesPerSecond=o.frameRate),p}),u={producerId:i,appData:a.appData,videoStats:c,audioStats:n.outboundAudioRtpId.map(h=>e.outboundAudioRtp.get(h))};r.push(u)})}catch(n){console.error("getProducersReport: ",n,e)}return r}getConsumerStatsFromParsedConsumerStats(e,r,n){let i;try{const{peerId:a,producerId:o,appData:c}=this.consumerPeerIdMap.get(n),u=r==null?void 0:r.inboundVideoRtpId.map(h=>{const f=this.consumerMap.get(n).track.getSettings(),v=e.inboundVideoRtp.get(h);return v.frameHeight||(v.frameHeight=f.height,v.frameWidth=f.width,v.framesPerSecond=f.frameRate),v});i={consumerId:n,peerId:a,producerId:o,appData:c,videoStats:u,audioStats:r==null?void 0:r.inboundAudioRtpId.map(h=>e.inboundAudioRtp.get(h))}}catch(a){console.error("getConsumerStatsFromParsedConsumerStats: ",a,e)}return i}getConsumerStatsFromReport(e){const r=[];try{e.consumerStreamMap.forEach((n,i)=>{r.push(this.getConsumerStatsFromParsedConsumerStats(e,n,i))})}catch(n){console.error("getConsumerStatsFromReport: ",n,e)}return r}}class fy extends bh{}function Bo(s,t,e,r){if(s!=null&&s.logger&&s.logger.error("Callstats::handleError",{error:r}),typeof e=="function"&&r instanceof t)e.call(null,r,s);else throw r}function Ph(s,t,e){const r=s.value;return s.value=function(...n){try{const i=r.apply(this,n);return i&&i instanceof Promise?i.catch(a=>{Bo(this,t,e,a)}):i}catch(i){Bo(this,t,e,i)}return null},s}const te=(s,t)=>(e,r,n)=>{const i=n.value;return n.value=function(...a){try{const o=i.apply(this,a);return o&&o instanceof Promise?o.catch(c=>{Bo(this,s,t,c)}):o}catch(o){Bo(this,s,t,o)}return null},n},gy=(s,t)=>(e,r,n)=>{if(n)return Ph(n,s,t);for(const i of Reflect.ownKeys(e.prototype).filter(a=>a!=="constructor")){const a=Object.getOwnPropertyDescriptor(e.prototype,i);a.value instanceof Function&&Object.defineProperty(e.prototype,i,Ph(a,s,t))}};var Z=globalThis&&globalThis.__decorate||function(s,t,e,r){var n=arguments.length,i=n<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,e):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(s,t,e,r);else for(var o=s.length-1;o>=0;o--)(a=s[o])&&(i=(n<3?a(i):n>3?a(t,e,i):a(t,e))||i);return n>3&&i&&Object.defineProperty(t,e,i),i};const ee=console;let Y=class extends ce{constructor(e="https://api.testingv3.dyte.in",r="Blink",n=ta.PROD,i,a,o,c){super();m(this,"observer");m(this,"eventHandler");m(this,"measurements");m(this,"producingTransport");m(this,"consumingTransport");m(this,"producers",new Map);m(this,"consumers",new Map);m(this,"iceServers");m(this,"connectionInfoPromise");m(this,"pingStatsTimeout");m(this,"logger");m(this,"env");m(this,"apiHostnames");m(this,"peerId");m(this,"consumerSharedMediaStatesMap",new Map);m(this,"currentUserMediaStates",{});switch(this.env=n,this.apiHostnames=c,this.logger=a,this.peerId=o,this.eventHandler=new ey({logger:a,peerId:o,apiHostnames:c}),this.logger.debug("callStats::engineName: ",{engineName:r}),r){case"Blink":this.measurements=new my;break;case"Gecko":this.measurements=new bh;break;case"WebKit":this.measurements=new fy;break;default:throw Error(`Unknown engineName! ${r}`)}this.measurements.callStatsInstance=this,this.registerProducer=this.registerProducer.bind(this),this.registerConsumer=this.registerConsumer.bind(this),this.observer=new ce,this.measurements.observer.on("consumer_score",u=>{a.debug(`callStats::consumer_score ${[...u.entries()]}`),this.eventHandler.emit("consumer_score",u)}),this.measurements.observer.on("producer_score",u=>{a.debug(`callStats::producer_score ${[...u.entries()]}`),this.eventHandler.emit("producer_score",u)})}registerIceServers(e){this.iceServers=e}registerConsumer(e){var r;this.consumerSharedMediaStatesMap.has(e.id)||this.consumerSharedMediaStatesMap.set(e.id,{}),this.consumers.set(e.id,e),this.measurements.registerConsumer(e),this.logger.debug("callStats::registerConsumer",{consumerId:e.id,consumerkind:e.kind,isScreenShare:!!((r=e.appData)!=null&&r.screenShare)}),e.observer.on("close",this.deRegisterConsumer.bind(this,e))}registerProducer(e){var r;this.producers.set(e.id,e),this.measurements.registerProducer(e),this.logger.debug("callStats::registerProducer",{producerId:e.id,producerKind:e.kind,isScreenShare:!!((r=e.appData)!=null&&r.screenShare)}),e.observer.on("close",this.deRegisterProducer.bind(this,e))}sendConsumerSharedMediaStateEvent(e,r){this.consumerSharedMediaStatesMap.has(e)||this.consumerSharedMediaStatesMap.set(e,{});const n=this.consumerSharedMediaStatesMap.get(e);this.consumerSharedMediaStatesMap.set(e,Object.assign(n,r))}registerProducingTransport(e){var n;this.producingTransport=e,e.observer.on("close",this.disconnectProducingTransport.bind(this,e)),e.observer.on("disconnect",this.disconnectProducingTransport.bind(this,e)),Array.from(((n=e._producers)==null?void 0:n.values())||[]).forEach(i=>{this.registerProducer(i)}),e.observer.on("newproducer",this.registerProducer)}registerConsumingTransport(e){var n;this.consumingTransport=e,e.observer.on("close",this.disconnectConsumingTransport.bind(this,e)),e.observer.on("disconnect",this.disconnectConsumingTransport.bind(this,e)),Array.from(((n=e._consumers)==null?void 0:n.values())||[]).forEach(i=>{this.registerConsumer(i)}),e.observer.on("newconsumer",this.registerConsumer)}deRegisterConsumer(e){this.consumers.delete(e.id)}deRegisterProducer(e){var r;this.producers.delete(e.id),this.logger.debug("callStats::deRegisterProducer",{producerId:e.id,producerKind:e.kind,isScreenShare:!!((r=e.appData)!=null&&r.screenShare)})}disconnectConsumingTransport(){this.consumingTransport=void 0}disconnectProducingTransport(){this.producingTransport=void 0}callEvent(e){this.eventHandler.callEvent(e)}sendPreCallTestBeginEvent(e=!1){this.connectionInfoPromise=this.measurements.getNetworkInfo(this.iceServers,e),this.eventHandler.callEvent({event:F.PRECALL_TEST_BEGIN,timestamp:new Date}),this.connectionInfoPromise&&this.connectionInfoPromise.then(r=>{this.eventHandler.callEvent({event:F.PRECALL_TEST_COMPLETE,metaData:{connectionInfo:r},timestamp:new Date})})}sendScreenShareToggleEvent(e,r){this.currentUserMediaStates.screen=e,this.eventHandler.callEvent({event:e?F.SCREENSHARE_STARTED:F.SCREENSHARE_STOPPED,metaData:{ssrc:r},timestamp:new Date})}sendScreenShareRequestedEvent(){this.eventHandler.callEvent({event:F.SCREENSHARE_START_REQUESTED,timestamp:new Date})}sendActiveSpeakerEvent(e){this.eventHandler.callEvent({event:F.DOMINANT_SPEAKER,metaData:{peerId:e},timestamp:new Date})}devices(e,r){this.eventHandler.callEvent({event:e===zt.AUDIO&&F.AUDIO_DEVICES_UPDATES||e===zt.VIDEO&&F.VIDEO_DEVICES_UPDATES||e===zt.SPEAKER&&F.SPEAKER_DEVICES_UPDATES,metaData:{deviceList:r},timestamp:new Date})}selectedDevice(e,r){this.eventHandler.callEvent({event:e===zt.AUDIO&&F.SELECTED_MICROHPONE_UPDATE||e===zt.VIDEO&&F.SELECTED_CAMERA_UPDATE||e===zt.SPEAKER&&F.SELECTED_SPEAKER_UPDATE,metaData:{device:r},timestamp:new Date})}mediaPermission(e,r){this.eventHandler.callEvent({event:F.MEDIA_PERMISSION,metaData:{deviceType:e,permission:r},timestamp:new Date})}mediaPlaybackFailed(e){this.eventHandler.callEvent({event:e===zt.AUDIO&&F.AUDIO_PLAY_FAILED||e===zt.VIDEO&&F.VIDEO_PLAY_FAILED,metaData:{deviceType:e},timestamp:new Date})}mediaTrackMuted(e){this.eventHandler.callEvent({event:e===zt.AUDIO&&F.AUDIO_TRACK_MUTED||e===zt.VIDEO&&F.VIDEO_TRACK_MUTED,metaData:{deviceType:e},timestamp:new Date})}tabChanged(e){this.eventHandler.callEvent({event:F.TAB_CHANGE,metaData:{isMeetingsTabActive:e},timestamp:new Date})}browserBackgrounded(){this.eventHandler.callEvent({event:F.BROWSER_BACKGROUNDED,timestamp:new Date})}browserForegrounded(){this.eventHandler.callEvent({event:F.BROWSER_FOREGROUNDED,timestamp:new Date})}legacySwitch(e){this.eventHandler.callEvent({event:F.LEGACY_SWITCH,metadata:{on:e},timestamp:new Date})}async getPreCallTestResults(){return this.connectionInfoPromise}sendCallJoinBeginEvent(e){e={...e,meetingEnv:this.env},e.deviceInfo={...e.deviceInfo,userAgent:navigator.userAgent,cpus:navigator.hardwareConcurrency,memory:navigator.deviceMemory},this.eventHandler.callEvent({event:F.CALL_JOIN_BEGIN,metaData:{peerMetaData:e},timestamp:new Date})}sendNetworkQualityTestBeginEvent(e){this.eventHandler.callEvent({event:F.NET_QUALITY_TEST_BEGIN,timestamp:new Date}),new Promise(async(n,i)=>{const a=[];try{for(const o of e)try{if(o.iceServers&&o.iceServers.length>0){const c=await this.measurements.getNetworkQuality(o.iceServers);a.push({...o,networkResults:c})}}catch(c){console.warn("Error handling ",c)}n({regionData:a})}catch(o){console.warn("Error in callstats, ",o),i(o)}}).then(n=>{this.eventHandler.callEvent({event:F.NET_QUALITY_TEST_END,timestamp:new Date,metaData:n})})}sendWebSocketConnectedEvent(){this.eventHandler.callEvent({event:F.WEBSOCKET_CONNECTED,timestamp:new Date})}sendTransportConnectedEvent(){this.eventHandler.callEvent({event:F.TRANSPORT_CONNECTED,timestamp:new Date})}sendAudioToggleEvent(e){this.currentUserMediaStates.audio=e;let r;e?r=F.AUDIO_ON:r=F.AUDIO_OFF,this.eventHandler.callEvent({event:r,timestamp:new Date})}sendVideoToggleEvent(e){this.currentUserMediaStates.video=e;let r;e?r=F.VIDEO_ON:r=F.VIDEO_OFF,this.eventHandler.callEvent({event:r,timestamp:new Date})}sendParticipantRoleToggleEvent(e){this.eventHandler.callEvent({event:F.PARTICIPANT_ROLE,timestamp:new Date,metaData:e})}startPingStats(e=7e3){this.sendPingStatsEvent(!1),this.pingStatsTimeout=setInterval(this.sendPingStatsEvent.bind(this),e)}stopPingStats(){clearInterval(this.pingStatsTimeout)}async sendPingStatsEvent(e=!0){let r,n;if(this.producingTransport&&(r=await this.measurements.getProcessedStats(this.producingTransport,!1,!0),!r||!(r!=null&&r.producerReport))){this.logger.debug("callStats::sendPingStatsEvent::staleProducingTransport",{disclaimer:"Stale producer? Regenerating Stream Maps!"});const a=await this.measurements.getProducersReport([...this.producers.values()]);r&&a?r.producerReport=a:(r=await this.measurements.getProcessedStats(this.producingTransport,!1,!0),(!r||!(r!=null&&r.producerReport))&&this.logger.debug("callStats::sendPingStatsEvent::noProducingTransportReport",{disclaimer:"Stream maps invalid despite regenerating!"}))}if(this.consumingTransport&&(n=await this.measurements.getProcessedStats(this.consumingTransport,!0,!1),!n||!n.consumerReport)){this.logger.debug("callStats::sendPingStatsEvent::staleConsumingTransport",{disclaimer:"Stale consumer? Regenerating Stream Maps!"});const a=await this.measurements.getConsumersReport([...this.consumers.values()]);n&&a?n.consumerReport=a:(n=await this.measurements.getProcessedStats(this.consumingTransport,!0,!1),(!n||!n.consumerReport)&&this.logger.debug("callStats::sendPingStatsEvent::noConsumingTransportReport",{disclaimer:"Stream maps invalid despite regenerating!"}))}const i={producingTransportStats:r?r==null?void 0:r.transportReport:void 0,consumingTransportStats:n?n==null?void 0:n.transportReport:void 0,producerStats:[].concat((r==null?void 0:r.producerReport)||[]).concat((n==null?void 0:n.producerReport)||[]),consumerStats:[].concat((n==null?void 0:n.consumerReport)||[]).concat((r==null?void 0:r.consumerReport)||[])};if(e&&i.producerStats.length===0&&i.consumerStats.length===0){await this.eventHandler.flush();return}this.eventHandler.callEvent({event:F.PING_STAT,metaData:i,timestamp:new Date})}sendIVSPlayerRebufferEvent(){this.eventHandler.callEvent({event:F.IVS_PLAYER_REBUFFERING,timestamp:new Date})}sendIVSPlayerAudioBlockEvent(){this.eventHandler.callEvent({event:F.IVS_PLAYER_AUDIO_BLOCKED,timestamp:new Date})}sendIVSPlayerPlaybackBlockedEvent(){this.eventHandler.callEvent({event:F.IVS_PLAYER_PLAYBACK_BLOCKED,timestamp:new Date})}sendIVSPlayerNetworkUnavailableEvent(){this.eventHandler.callEvent({event:F.IVS_PLAYER_NETWORK_UNAVAILABLE,timestamp:new Date})}sendIVSPlayerInitializedEvent(){this.eventHandler.callEvent({event:F.IVS_PLAYER_INITIALIZED,timestamp:new Date})}sendIVSPlayerWorkerErrorEvent(){this.eventHandler.callEvent({event:F.IVS_PLAYER_WORKER_ERROR,timestamp:new Date})}sendIVSPlayerErrorEvent(e){this.eventHandler.callEvent({event:F.IVS_PLAYER_ERROR,timestamp:new Date,metaData:e})}sendIVSPlayerRecoverableErrorEvent(e){this.eventHandler.callEvent({event:F.IVS_PLAYER_RECOVERABLE_ERROR,timestamp:new Date,metaData:e})}sendIVSPlayerAnalyticsEvent(e){this.eventHandler.callEvent({event:F.IVS_PLAYER_ANALYTICS_EVENT,timestamp:new Date,metaData:e})}sendIVSPlayerPlaybackRateChangedEvent(e){this.eventHandler.callEvent({event:F.IVS_PLAYER_PLAYBACK_RATE_CHANGED,timestamp:new Date,metaData:{updatedPlaybackRate:e}})}sendIVSPlayerQualityChanged(e){this.eventHandler.callEvent({event:F.IVS_PLAYER_QUALITY_CHANGED,timestamp:new Date,metaData:e})}sendPlayerLiveLatency(e){this.eventHandler.callEvent({event:F.LIVESTREAM_LATENCY,timestamp:new Date,metaData:{latency:e}})}sendDisconnectEvent(){this.eventHandler.callEvent({event:F.DISCONNECT,timestamp:new Date})}sendReconnectEvent(){this.eventHandler.callEvent({event:F.RECONNECT_ATTEMPT,timestamp:new Date})}};Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"registerIceServers",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"registerConsumer",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"registerProducer",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendConsumerSharedMediaStateEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"registerProducingTransport",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"registerConsumingTransport",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"deRegisterConsumer",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"deRegisterProducer",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"disconnectConsumingTransport",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"disconnectProducingTransport",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendPreCallTestBeginEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendScreenShareToggleEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendScreenShareRequestedEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendActiveSpeakerEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"devices",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"selectedDevice",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"mediaPermission",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"mediaPlaybackFailed",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"mediaTrackMuted",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"tabChanged",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"browserBackgrounded",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"browserForegrounded",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"legacySwitch",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"getPreCallTestResults",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendCallJoinBeginEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendNetworkQualityTestBeginEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendWebSocketConnectedEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendTransportConnectedEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendAudioToggleEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendVideoToggleEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendParticipantRoleToggleEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"startPingStats",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"stopPingStats",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendPingStatsEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerRebufferEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerAudioBlockEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerPlaybackBlockedEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerNetworkUnavailableEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerInitializedEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerWorkerErrorEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerErrorEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerRecoverableErrorEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerAnalyticsEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerPlaybackRateChangedEvent",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendIVSPlayerQualityChanged",null),Z([te(TypeError,(s,t)=>ee.error(t,s))],Y.prototype,"sendPlayerLiveLatency",null),Y=Z([gy(TypeError,(s,t)=>ee.error(t,s))],Y);const vy=Y;class yy extends ce{constructor(){super(...arguments);m(this,"stats");m(this,"roomURL");m(this,"peerId");m(this,"backend");m(this,"iceServers");m(this,"initialized",!1);m(this,"stalled",!1);m(this,"ipInformation");m(this,"logger")}async initialize({peerId:e,engineName:r,env:n=ta.PROD,iceServers:i,apiBase:a="https://api.cluster.dyte.in",flags:o,logger:c=console,apiHostnames:u,skipConnectivityChecks:h=!1}){var p,f,v;try{this.peerId=e,this.logger=c,this.ipInformation=await Nd.getIPDetails({peerId:e,apiHostnames:u}),this.backend=new vy(a,r,n,o,c,e,u),this.iceServers=i,(p=this.backend)==null||p.registerIceServers(this.iceServers),this.initialized=!0,(v=(f=this.backend)==null?void 0:f.eventHandler)==null||v.emit("initialized",this.ipInformation),this.emit("initialized",this.ipInformation),this.startPreCallTest(h)}catch(y){this.logger.error("callStats::CallStatsIntegration: ",{error:y}),this.stallCallStats()}}setRoomName(e){this.roomURL=e}configureSendTransport(e){var r;(r=this.backend)==null||r.registerProducingTransport(e)}configureRecvTransport(e){var r;(r=this.backend)==null||r.registerConsumingTransport(e)}async candidateRegionalNetworkQualityTest(e){var r;try{(r=this.backend)==null||r.sendNetworkQualityTestBeginEvent(e)}catch(n){this.logger.error("callStats::sendNetworkQualityTestBeginEvent",{error:{reason:n.reason}})}}async roomJoined(e){var r,n;(r=this.backend)==null||r.sendCallJoinBeginEvent(e),this.backend,(n=this.backend)==null||n.startPingStats()}audioOff(){var e;(e=this.backend)==null||e.sendAudioToggleEvent(!1)}audioOn(){var e;(e=this.backend)==null||e.sendAudioToggleEvent(!0)}videoOff(){var e;(e=this.backend)==null||e.sendVideoToggleEvent(!1)}videoOn(){var e;(e=this.backend)==null||e.sendVideoToggleEvent(!0)}callEnded(){var e,r;(e=this.backend)==null||e.stopPingStats(),(r=this.backend)==null||r.sendDisconnectEvent()}screenShareStart(e){var r;(r=this.backend)==null||r.sendScreenShareToggleEvent(!0,e)}consumerSharedMediaState(e,r){var n;(n=this.backend)==null||n.sendConsumerSharedMediaStateEvent(e,r)}screenShareStop(e){var r;(r=this.backend)==null||r.sendScreenShareToggleEvent(!1,e)}screenShareRequested(){var e;(e=this.backend)==null||e.sendScreenShareRequestedEvent()}activeSpeaker(e){var r;e===this.peerId&&((r=this.backend)==null||r.sendActiveSpeakerEvent(e))}devices(e,r){var n;(n=this.backend)==null||n.devices(e,r)}selectedDevice(e,r){var n;(n=this.backend)==null||n.selectedDevice(e,r)}mediaPermission(e,r){var n;(n=this.backend)==null||n.mediaPermission(e,r)}mediaPlaybackFailed(e){var r;(r=this.backend)==null||r.mediaPlaybackFailed(e)}mediaTrackMuted(e){var r;(r=this.backend)==null||r.mediaTrackMuted(e)}tabChanged(e=!1){var r;(r=this.backend)==null||r.tabChanged(e)}browserBackgrounded(){var e;(e=this.backend)==null||e.browserBackgrounded()}browserForegrounded(){var e;(e=this.backend)==null||e.browserForegrounded()}legacySwitch(e){var r;(r=this.backend)==null||r.legacySwitch(e)}async startPreCallTest(e=!1){var r;(r=this.backend)==null||r.sendPreCallTestBeginEvent(e)}onPreCallTestResults(e){var r;return(r=this.backend)==null||r.eventHandler.once("precall_end",e),e}onReceivingConsumerAudioStatus(e){var r;(r=this.backend)==null||r.eventHandler.on("consumer_audio_status",e)}onReceivingConsumerVideoStatus(e){var r;(r=this.backend)==null||r.eventHandler.on("consumer_video_status",e)}onReceivingProducerAudioStatus(e){var r;(r=this.backend)==null||r.eventHandler.on("producer_audio_status",e)}onReceivingProducerVideoStatus(e){var r;(r=this.backend)==null||r.eventHandler.on("producer_video_status",e)}onReceivingProducingTransportStatus(e){var r;(r=this.backend)==null||r.eventHandler.on("producing_transport_status",e)}onReceivingConsumingTransportStatus(e){var r;(r=this.backend)==null||r.eventHandler.on("consuming_transport_status",e)}onProducerScore(e){var r;(r=this.backend)==null||r.eventHandler.on("producer_score",e)}onConsumerScore(e){var r;(r=this.backend)==null||r.eventHandler.on("consumer_score",e)}onSafeInitialization(e){if(this.initialized)e(this.ipInformation,!1);else if(!this.stalled){const r=n=>{e(n,!0)};return this.once("initialized",r),r}return()=>{}}removeInitializationListener(e){this.removeListener("initialized",e)}stallCallStats(){this.stalled=!0,this.removeAllListeners("initialized")}ivsPlayerEvent(e,r){var n,i,a,o,c,u,h,p,f,v,y;switch(e){case"PlayerRebuffering":(n=this.backend)==null||n.sendIVSPlayerRebufferEvent();break;case"PlayerAudioBlocked":(i=this.backend)==null||i.sendIVSPlayerAudioBlockEvent();break;case"PlayerPlaybackBlocked":(a=this.backend)==null||a.sendIVSPlayerPlaybackBlockedEvent();break;case"PlayerNetworkUnavailable":(o=this.backend)==null||o.sendIVSPlayerNetworkUnavailableEvent();break;case"PlayerInitialized":(c=this.backend)==null||c.sendIVSPlayerInitializedEvent();break;case"PlayerWorkerError":(u=this.backend)==null||u.sendIVSPlayerWorkerErrorEvent();break;case"PlayerError":(h=this.backend)==null||h.sendIVSPlayerErrorEvent(r);break;case"PlayerRecoverableError":(p=this.backend)==null||p.sendIVSPlayerRecoverableErrorEvent(r);break;case"PlayerAnalyticsEvent":(f=this.backend)==null||f.sendIVSPlayerAnalyticsEvent(r);break;case"PlayerPlaybackRateChanged":(v=this.backend)==null||v.sendIVSPlayerPlaybackRateChangedEvent(r);break;case"PlayerQualityChanged":(y=this.backend)==null||y.sendIVSPlayerQualityChanged(r);break}}livestreamLatency(e){var r;(r=this.backend)==null||r.sendPlayerLiveLatency(e)}}const U=new yy;U.setMaxListeners(30);function Ty(s){const{length:t}=this,e=s>=0?s:t+s;return e<0||e>=t?void 0:this[e]}Array.prototype.at||Object.assign(Array.prototype,{at:Ty});function _y(s){const{length:t}=this,e=s>=0?s:t+s;return e<0||e>=t?void 0:this[e]}String.prototype.at||Object.assign(String.prototype,{at:_y});var Ho,Sy=new Uint8Array(16);function Ey(){if(!Ho&&(Ho=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!Ho))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ho(Sy)}const wy=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Ld(s){return typeof s=="string"&&wy.test(s)}for(var dt=[],Fd=0;Fd<256;++Fd)dt.push((Fd+256).toString(16).substr(1));function Cy(s){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=(dt[s[t+0]]+dt[s[t+1]]+dt[s[t+2]]+dt[s[t+3]]+"-"+dt[s[t+4]]+dt[s[t+5]]+"-"+dt[s[t+6]]+dt[s[t+7]]+"-"+dt[s[t+8]]+dt[s[t+9]]+"-"+dt[s[t+10]]+dt[s[t+11]]+dt[s[t+12]]+dt[s[t+13]]+dt[s[t+14]]+dt[s[t+15]]).toLowerCase();if(!Ld(e))throw TypeError("Stringified UUID is invalid");return e}function Ys(s,t,e){s=s||{};var r=s.random||(s.rng||Ey)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){e=e||0;for(var n=0;n<16;++n)t[e+n]=r[n];return t}return Cy(r)}var Xe;(function(s){s.GroupCall="GROUP_CALL",s.Webinar="WEBINAR",s.AudioRoom="AUDIO_ROOM",s.Livestream="LIVESTREAM",s.Chat="CHAT"})(Xe||(Xe={}));var qo;(function(s){s.Skip="SKIP",s.OnPrivilegedUserEntry="ON_PRIVILEGED_USER_ENTRY",s.SkipOnAccept="SKIP_ON_ACCEPT"})(qo||(qo={}));var H;(function(s){s.Allowed="ALLOWED",s.NotAllowed="NOT_ALLOWED",s.CanRequest="CAN_REQUEST"})(H||(H={}));var jo;(function(s){s.Allowed="ALLOWED",s.NotAllowed="NOT_ALLOWED"})(jo||(jo={}));var Rh;(function(s){s.FULL_ACCESS="FULL_ACCESS",s.VIEW_ONLY="VIEW_ONLY"})(Rh||(Rh={}));var Go;(function(s){s.skip="SKIP",s.onAccept="ON_ACCEPT",s.skipOnPrivilegedUserEntry="SKIP_ON_PRIVILEGED_USER_ENTRY",s.skipOnAccept="SKIP_ON_ACCEPT"})(Go||(Go={}));var qn;(function(s){s.none="NONE",s.recorder="RECORDER",s.livestreamer="LIVESTREAMER"})(qn||(qn={}));var xd;(function(s){s.groupCall="GROUP_CALL",s.webinar="WEBINAR",s.audioRoom="AUDIO_ROOM",s.livestream="LIVESTREAM",s.chat="CHAT"})(xd||(xd={}));var kh;(function(s){s.SKIP="skip",s.SKIP_ON_PRIVILEGED_USER_ENTRY="skipOnPrivilegedUserEntry",s.ON_ACCEPT="skipOnAccept",s.SKIP_ON_ACCEPT="skipOnAccept"})(kh||(kh={})),xd.groupCall,Go.skipOnAccept,qn.none;var Ud={},by={get exports(){return Ud},set exports(s){Ud=s}},Wo={},Py={get exports(){return Wo},set exports(s){Wo=s}},Ih=function(t,e){return function(){for(var n=new Array(arguments.length),i=0;i<n.length;i++)n[i]=arguments[i];return t.apply(e,n)}},Ry=Ih,os=Object.prototype.toString;function $d(s){return Array.isArray(s)}function Vd(s){return typeof s=="undefined"}function ky(s){return s!==null&&!Vd(s)&&s.constructor!==null&&!Vd(s.constructor)&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function Ah(s){return os.call(s)==="[object ArrayBuffer]"}function Iy(s){return os.call(s)==="[object FormData]"}function Ay(s){var t;return typeof ArrayBuffer!="undefined"&&ArrayBuffer.isView?t=ArrayBuffer.isView(s):t=s&&s.buffer&&Ah(s.buffer),t}function My(s){return typeof s=="string"}function Dy(s){return typeof s=="number"}function Mh(s){return s!==null&&typeof s=="object"}function Jo(s){if(os.call(s)!=="[object Object]")return!1;var t=Object.getPrototypeOf(s);return t===null||t===Object.prototype}function Oy(s){return os.call(s)==="[object Date]"}function Ny(s){return os.call(s)==="[object File]"}function Ly(s){return os.call(s)==="[object Blob]"}function Dh(s){return os.call(s)==="[object Function]"}function Fy(s){return Mh(s)&&Dh(s.pipe)}function xy(s){return os.call(s)==="[object URLSearchParams]"}function Uy(s){return s.trim?s.trim():s.replace(/^\s+|\s+$/g,"")}function $y(){return typeof navigator!="undefined"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof window!="undefined"&&typeof document!="undefined"}function Bd(s,t){if(!(s===null||typeof s=="undefined"))if(typeof s!="object"&&(s=[s]),$d(s))for(var e=0,r=s.length;e<r;e++)t.call(null,s[e],e,s);else for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&t.call(null,s[n],n,s)}function Hd(){var s={};function t(n,i){Jo(s[i])&&Jo(n)?s[i]=Hd(s[i],n):Jo(n)?s[i]=Hd({},n):$d(n)?s[i]=n.slice():s[i]=n}for(var e=0,r=arguments.length;e<r;e++)Bd(arguments[e],t);return s}function Vy(s,t,e){return Bd(t,function(n,i){e&&typeof n=="function"?s[i]=Ry(n,e):s[i]=n}),s}function By(s){return s.charCodeAt(0)===65279&&(s=s.slice(1)),s}var Mt={isArray:$d,isArrayBuffer:Ah,isBuffer:ky,isFormData:Iy,isArrayBufferView:Ay,isString:My,isNumber:Dy,isObject:Mh,isPlainObject:Jo,isUndefined:Vd,isDate:Oy,isFile:Ny,isBlob:Ly,isFunction:Dh,isStream:Fy,isURLSearchParams:xy,isStandardBrowserEnv:$y,forEach:Bd,merge:Hd,extend:Vy,trim:Uy,stripBOM:By},jn=Mt;function Oh(s){return encodeURIComponent(s).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var Nh=function(t,e,r){if(!e)return t;var n;if(r)n=r(e);else if(jn.isURLSearchParams(e))n=e.toString();else{var i=[];jn.forEach(e,function(c,u){c===null||typeof c=="undefined"||(jn.isArray(c)?u=u+"[]":c=[c],jn.forEach(c,function(p){jn.isDate(p)?p=p.toISOString():jn.isObject(p)&&(p=JSON.stringify(p)),i.push(Oh(u)+"="+Oh(p))}))}),n=i.join("&")}if(n){var a=t.indexOf("#");a!==-1&&(t=t.slice(0,a)),t+=(t.indexOf("?")===-1?"?":"&")+n}return t},Hy=Mt;function Ko(){this.handlers=[]}Ko.prototype.use=function(t,e,r){return this.handlers.push({fulfilled:t,rejected:e,synchronous:r?r.synchronous:!1,runWhen:r?r.runWhen:null}),this.handlers.length-1},Ko.prototype.eject=function(t){this.handlers[t]&&(this.handlers[t]=null)},Ko.prototype.forEach=function(t){Hy.forEach(this.handlers,function(r){r!==null&&t(r)})};var qy=Ko,jy=Mt,Gy=function(t,e){jy.forEach(t,function(n,i){i!==e&&i.toUpperCase()===e.toUpperCase()&&(t[e]=n,delete t[i])})},Lh=function(t,e,r,n,i){return t.config=e,r&&(t.code=r),t.request=n,t.response=i,t.isAxiosError=!0,t.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},t},qd,Fh;function xh(){if(Fh)return qd;Fh=1;var s=Lh;return qd=function(e,r,n,i,a){var o=new Error(e);return s(o,r,n,i,a)},qd}var jd,Uh;function Wy(){if(Uh)return jd;Uh=1;var s=xh();return jd=function(e,r,n){var i=n.config.validateStatus;!n.status||!i||i(n.status)?e(n):r(s("Request failed with status code "+n.status,n.config,null,n.request,n))},jd}var Gd,$h;function Jy(){if($h)return Gd;$h=1;var s=Mt;return Gd=s.isStandardBrowserEnv()?function(){return{write:function(r,n,i,a,o,c){var u=[];u.push(r+"="+encodeURIComponent(n)),s.isNumber(i)&&u.push("expires="+new Date(i).toGMTString()),s.isString(a)&&u.push("path="+a),s.isString(o)&&u.push("domain="+o),c===!0&&u.push("secure"),document.cookie=u.join("; ")},read:function(r){var n=document.cookie.match(new RegExp("(^|;\\s*)("+r+")=([^;]*)"));return n?decodeURIComponent(n[3]):null},remove:function(r){this.write(r,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}(),Gd}var Wd,Vh;function Ky(){return Vh||(Vh=1,Wd=function(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}),Wd}var Jd,Bh;function zy(){return Bh||(Bh=1,Jd=function(t,e){return e?t.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):t}),Jd}var Kd,Hh;function Yy(){if(Hh)return Kd;Hh=1;var s=Ky(),t=zy();return Kd=function(r,n){return r&&!s(n)?t(r,n):n},Kd}var zd,qh;function Qy(){if(qh)return zd;qh=1;var s=Mt,t=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];return zd=function(r){var n={},i,a,o;return r&&s.forEach(r.split(`
`),function(u){if(o=u.indexOf(":"),i=s.trim(u.substr(0,o)).toLowerCase(),a=s.trim(u.substr(o+1)),i){if(n[i]&&t.indexOf(i)>=0)return;i==="set-cookie"?n[i]=(n[i]?n[i]:[]).concat([a]):n[i]=n[i]?n[i]+", "+a:a}}),n},zd}var Yd,jh;function Xy(){if(jh)return Yd;jh=1;var s=Mt;return Yd=s.isStandardBrowserEnv()?function(){var e=/(msie|trident)/i.test(navigator.userAgent),r=document.createElement("a"),n;function i(a){var o=a;return e&&(r.setAttribute("href",o),o=r.href),r.setAttribute("href",o),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:r.pathname.charAt(0)==="/"?r.pathname:"/"+r.pathname}}return n=i(window.location.href),function(o){var c=s.isString(o)?i(o):o;return c.protocol===n.protocol&&c.host===n.host}}():function(){return function(){return!0}}(),Yd}var Qd,Gh;function zo(){if(Gh)return Qd;Gh=1;function s(t){this.message=t}return s.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},s.prototype.__CANCEL__=!0,Qd=s,Qd}var Xd,Wh;function Jh(){if(Wh)return Xd;Wh=1;var s=Mt,t=Wy(),e=Jy(),r=Nh,n=Yy(),i=Qy(),a=Xy(),o=xh(),c=Yo(),u=zo();return Xd=function(p){return new Promise(function(v,y){var P=p.data,k=p.headers,I=p.responseType,x;function $(){p.cancelToken&&p.cancelToken.unsubscribe(x),p.signal&&p.signal.removeEventListener("abort",x)}s.isFormData(P)&&delete k["Content-Type"];var O=new XMLHttpRequest;if(p.auth){var K=p.auth.username||"",X=p.auth.password?unescape(encodeURIComponent(p.auth.password)):"";k.Authorization="Basic "+btoa(K+":"+X)}var oe=n(p.baseURL,p.url);O.open(p.method.toUpperCase(),r(oe,p.params,p.paramsSerializer),!0),O.timeout=p.timeout;function Te(){if(O){var Ue="getAllResponseHeaders"in O?i(O.getAllResponseHeaders()):null,At=!I||I==="text"||I==="json"?O.responseText:O.response,M={data:At,status:O.status,statusText:O.statusText,headers:Ue,config:p,request:O};t(function(R){v(R),$()},function(R){y(R),$()},M),O=null}}if("onloadend"in O?O.onloadend=Te:O.onreadystatechange=function(){!O||O.readyState!==4||O.status===0&&!(O.responseURL&&O.responseURL.indexOf("file:")===0)||setTimeout(Te)},O.onabort=function(){O&&(y(o("Request aborted",p,"ECONNABORTED",O)),O=null)},O.onerror=function(){y(o("Network Error",p,null,O)),O=null},O.ontimeout=function(){var At=p.timeout?"timeout of "+p.timeout+"ms exceeded":"timeout exceeded",M=p.transitional||c.transitional;p.timeoutErrorMessage&&(At=p.timeoutErrorMessage),y(o(At,p,M.clarifyTimeoutError?"ETIMEDOUT":"ECONNABORTED",O)),O=null},s.isStandardBrowserEnv()){var It=(p.withCredentials||a(oe))&&p.xsrfCookieName?e.read(p.xsrfCookieName):void 0;It&&(k[p.xsrfHeaderName]=It)}"setRequestHeader"in O&&s.forEach(k,function(At,M){typeof P=="undefined"&&M.toLowerCase()==="content-type"?delete k[M]:O.setRequestHeader(M,At)}),s.isUndefined(p.withCredentials)||(O.withCredentials=!!p.withCredentials),I&&I!=="json"&&(O.responseType=p.responseType),typeof p.onDownloadProgress=="function"&&O.addEventListener("progress",p.onDownloadProgress),typeof p.onUploadProgress=="function"&&O.upload&&O.upload.addEventListener("progress",p.onUploadProgress),(p.cancelToken||p.signal)&&(x=function(Ue){O&&(y(!Ue||Ue&&Ue.type?new u("canceled"):Ue),O.abort(),O=null)},p.cancelToken&&p.cancelToken.subscribe(x),p.signal&&(p.signal.aborted?x():p.signal.addEventListener("abort",x))),P||(P=null),O.send(P)})},Xd}var Zd,Kh;function Yo(){if(Kh)return Zd;Kh=1;var s=Mt,t=Gy,e=Lh,r={"Content-Type":"application/x-www-form-urlencoded"};function n(c,u){!s.isUndefined(c)&&s.isUndefined(c["Content-Type"])&&(c["Content-Type"]=u)}function i(){var c;return(typeof XMLHttpRequest!="undefined"||typeof process!="undefined"&&Object.prototype.toString.call(process)==="[object process]")&&(c=Jh()),c}function a(c,u,h){if(s.isString(c))try{return(u||JSON.parse)(c),s.trim(c)}catch(p){if(p.name!=="SyntaxError")throw p}return(h||JSON.stringify)(c)}var o={transitional:{silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},adapter:i(),transformRequest:[function(u,h){return t(h,"Accept"),t(h,"Content-Type"),s.isFormData(u)||s.isArrayBuffer(u)||s.isBuffer(u)||s.isStream(u)||s.isFile(u)||s.isBlob(u)?u:s.isArrayBufferView(u)?u.buffer:s.isURLSearchParams(u)?(n(h,"application/x-www-form-urlencoded;charset=utf-8"),u.toString()):s.isObject(u)||h&&h["Content-Type"]==="application/json"?(n(h,"application/json"),a(u)):u}],transformResponse:[function(u){var h=this.transitional||o.transitional,p=h&&h.silentJSONParsing,f=h&&h.forcedJSONParsing,v=!p&&this.responseType==="json";if(v||f&&s.isString(u)&&u.length)try{return JSON.parse(u)}catch(y){if(v)throw y.name==="SyntaxError"?e(y,this,"E_JSON_PARSE"):y}return u}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function(u){return u>=200&&u<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};return s.forEach(["delete","get","head"],function(u){o.headers[u]={}}),s.forEach(["post","put","patch"],function(u){o.headers[u]=s.merge(r)}),Zd=o,Zd}var Zy=Mt,eT=Yo(),tT=function(t,e,r){var n=this||eT;return Zy.forEach(r,function(a){t=a.call(n,t,e)}),t},el,zh;function Yh(){return zh||(zh=1,el=function(t){return!!(t&&t.__CANCEL__)}),el}var Qh=Mt,tl=tT,rT=Yh(),sT=Yo(),nT=zo();function rl(s){if(s.cancelToken&&s.cancelToken.throwIfRequested(),s.signal&&s.signal.aborted)throw new nT("canceled")}var iT=function(t){rl(t),t.headers=t.headers||{},t.data=tl.call(t,t.data,t.headers,t.transformRequest),t.headers=Qh.merge(t.headers.common||{},t.headers[t.method]||{},t.headers),Qh.forEach(["delete","get","head","post","put","patch","common"],function(n){delete t.headers[n]});var e=t.adapter||sT.adapter;return e(t).then(function(n){return rl(t),n.data=tl.call(t,n.data,n.headers,t.transformResponse),n},function(n){return rT(n)||(rl(t),n&&n.response&&(n.response.data=tl.call(t,n.response.data,n.response.headers,t.transformResponse))),Promise.reject(n)})},Vt=Mt,Xh=function(t,e){e=e||{};var r={};function n(h,p){return Vt.isPlainObject(h)&&Vt.isPlainObject(p)?Vt.merge(h,p):Vt.isPlainObject(p)?Vt.merge({},p):Vt.isArray(p)?p.slice():p}function i(h){if(Vt.isUndefined(e[h])){if(!Vt.isUndefined(t[h]))return n(void 0,t[h])}else return n(t[h],e[h])}function a(h){if(!Vt.isUndefined(e[h]))return n(void 0,e[h])}function o(h){if(Vt.isUndefined(e[h])){if(!Vt.isUndefined(t[h]))return n(void 0,t[h])}else return n(void 0,e[h])}function c(h){if(h in e)return n(t[h],e[h]);if(h in t)return n(void 0,t[h])}var u={url:a,method:a,data:a,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:c};return Vt.forEach(Object.keys(t).concat(Object.keys(e)),function(p){var f=u[p]||i,v=f(p);Vt.isUndefined(v)&&f!==c||(r[p]=v)}),r},sl,Zh;function ep(){return Zh||(Zh=1,sl={version:"0.25.0"}),sl}var aT=ep().version,nl={};["object","boolean","number","function","string","symbol"].forEach(function(s,t){nl[s]=function(r){return typeof r===s||"a"+(t<1?"n ":" ")+s}});var tp={};nl.transitional=function(t,e,r){function n(i,a){return"[Axios v"+aT+"] Transitional option '"+i+"'"+a+(r?". "+r:"")}return function(i,a,o){if(t===!1)throw new Error(n(a," has been removed"+(e?" in "+e:"")));return e&&!tp[a]&&(tp[a]=!0,console.warn(n(a," has been deprecated since v"+e+" and will be removed in the near future"))),t?t(i,a,o):!0}};function oT(s,t,e){if(typeof s!="object")throw new TypeError("options must be an object");for(var r=Object.keys(s),n=r.length;n-- >0;){var i=r[n],a=t[i];if(a){var o=s[i],c=o===void 0||a(o,i,s);if(c!==!0)throw new TypeError("option "+i+" must be "+c);continue}if(e!==!0)throw Error("Unknown option "+i)}}var cT={assertOptions:oT,validators:nl},rp=Mt,dT=Nh,sp=qy,np=iT,Qo=Xh,ip=cT,Gn=ip.validators;function ra(s){this.defaults=s,this.interceptors={request:new sp,response:new sp}}ra.prototype.request=function(t,e){if(typeof t=="string"?(e=e||{},e.url=t):e=t||{},!e.url)throw new Error("Provided config url is not valid");e=Qo(this.defaults,e),e.method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var r=e.transitional;r!==void 0&&ip.assertOptions(r,{silentJSONParsing:Gn.transitional(Gn.boolean),forcedJSONParsing:Gn.transitional(Gn.boolean),clarifyTimeoutError:Gn.transitional(Gn.boolean)},!1);var n=[],i=!0;this.interceptors.request.forEach(function(v){typeof v.runWhen=="function"&&v.runWhen(e)===!1||(i=i&&v.synchronous,n.unshift(v.fulfilled,v.rejected))});var a=[];this.interceptors.response.forEach(function(v){a.push(v.fulfilled,v.rejected)});var o;if(!i){var c=[np,void 0];for(Array.prototype.unshift.apply(c,n),c=c.concat(a),o=Promise.resolve(e);c.length;)o=o.then(c.shift(),c.shift());return o}for(var u=e;n.length;){var h=n.shift(),p=n.shift();try{u=h(u)}catch(f){p(f);break}}try{o=np(u)}catch(f){return Promise.reject(f)}for(;a.length;)o=o.then(a.shift(),a.shift());return o},ra.prototype.getUri=function(t){if(!t.url)throw new Error("Provided config url is not valid");return t=Qo(this.defaults,t),dT(t.url,t.params,t.paramsSerializer).replace(/^\?/,"")},rp.forEach(["delete","get","head","options"],function(t){ra.prototype[t]=function(e,r){return this.request(Qo(r||{},{method:t,url:e,data:(r||{}).data}))}}),rp.forEach(["post","put","patch"],function(t){ra.prototype[t]=function(e,r,n){return this.request(Qo(n||{},{method:t,url:e,data:r}))}});var lT=ra,il,ap;function uT(){if(ap)return il;ap=1;var s=zo();function t(e){if(typeof e!="function")throw new TypeError("executor must be a function.");var r;this.promise=new Promise(function(a){r=a});var n=this;this.promise.then(function(i){if(n._listeners){var a,o=n._listeners.length;for(a=0;a<o;a++)n._listeners[a](i);n._listeners=null}}),this.promise.then=function(i){var a,o=new Promise(function(c){n.subscribe(c),a=c}).then(i);return o.cancel=function(){n.unsubscribe(a)},o},e(function(a){n.reason||(n.reason=new s(a),r(n.reason))})}return t.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},t.prototype.subscribe=function(r){if(this.reason){r(this.reason);return}this._listeners?this._listeners.push(r):this._listeners=[r]},t.prototype.unsubscribe=function(r){if(this._listeners){var n=this._listeners.indexOf(r);n!==-1&&this._listeners.splice(n,1)}},t.source=function(){var r,n=new t(function(a){r=a});return{token:n,cancel:r}},il=t,il}var al,op;function hT(){return op||(op=1,al=function(t){return function(r){return t.apply(null,r)}}),al}var ol,cp;function pT(){if(cp)return ol;cp=1;var s=Mt;return ol=function(e){return s.isObject(e)&&e.isAxiosError===!0},ol}var dp=Mt,mT=Ih,Xo=lT,fT=Xh,gT=Yo();function lp(s){var t=new Xo(s),e=mT(Xo.prototype.request,t);return dp.extend(e,Xo.prototype,t),dp.extend(e,t),e.create=function(n){return lp(fT(s,n))},e}var yr=lp(gT);yr.Axios=Xo,yr.Cancel=zo(),yr.CancelToken=uT(),yr.isCancel=Yh(),yr.VERSION=ep().version,yr.all=function(t){return Promise.all(t)},yr.spread=hT(),yr.isAxiosError=pT(),Py.exports=yr,Wo.default=yr,function(s){s.exports=Wo}(by);const Zo=Le(Ud);let up="hXgU8Wc8pwuGNq9ms5q9Hh";typeof process!="undefined"&&(Tv=process==null?void 0:process.env)!=null&&Tv.FLAGSMITH_ENVIRONMENT_KEY&&(up=process.env.FLAGSMITH_ENVIRONMENT_KEY);function vT(s=[]){const t={};return s.forEach(e=>{t[e.feature.name]={enabled:e.enabled,value:e.feature_state_value}}),t}class yT{constructor(t=up){m(this,"flags",{});m(this,"environmentKey",null);this.environmentKey=t,this.identify=this.identify.bind(this),this.getValue=this.getValue.bind(this),this.hasFeature=this.hasFeature.bind(this),this.getAllFlags=this.getAllFlags.bind(this)}async identify(t,e={},r=!1,n=5e3,i="edge.api.flagsmith.com"){const a=JSON.parse(JSON.stringify(e)),o=Object.entries(a).map(c=>({trait_key:c[0],trait_value:c[1]}));try{const c="_"+(Math.random()+1).toString(36).substring(2),u=await Zo.post(`https://${i}/api/v1/identities/`,{identifier:t+(r?c:""),traits:o},{headers:{"Content-Type":"application/json","X-Environment-Key":this.environmentKey},timeout:n});this.flags=vT(u.data.flags||[])}catch(c){}return this.flags}getValue(t){return this.flags&&this.flags[t]&&this.flags[t].value}hasFeature(t){return this.flags&&this.flags[t]&&this.flags[t].enabled}getAllFlags(){return this.flags}}const j=new yT,hp=[-2,-1,0,1,2],TT=[0,1,2,3,4];function _T(s){s=s.trim();let t="0",e="0",r="0";return s.length==4?(t="0x"+s[1]+s[1],e="0x"+s[2]+s[2],r="0x"+s[3]+s[3]):s.length>6&&(t="0x"+s[1]+s[2],e="0x"+s[3]+s[4],r="0x"+s[5]+s[6]),[+t,+e,+r]}const ST=(s,t,e)=>{let r,n,i;if(t==0)r=n=i=e;else{const a=(u,h,p)=>(p<0&&(p+=1),p>1&&(p-=1),p<.16666666666666666?u+(h-u)*6*p:p<.5?h:p<.6666666666666666?u+(h-u)*(.6666666666666666-p)*6:u),o=e<.5?e*(1+t):e+t-e*t,c=2*e-o;r=a(c,o,s+1/3),n=a(c,o,s),i=a(c,o,s-1/3)}return[Math.round(r*255),Math.round(n*255),Math.round(i*255)]},ET=(s,t,e)=>{s/=255,t/=255,e/=255;const r=Math.max(s,t,e),n=Math.min(s,t,e);let i,a;const o=(r+n)/2;if(r==n)i=a=0;else{const c=r-n;switch(a=o>.5?c/(2-r-n):c/(r+n),r){case s:i=(t-e)/c+(t<e?6:0);break;case t:i=(e-s)/c+2;break;case e:i=(s-t)/c+4;break}i/=6}return[i,a,o]},wT=(s,t,e)=>{const r=n=>n.toString(16).padStart(2,"0");return`#${r(s)}${r(t)}${r(e)}`},pp=(s,t=hp,e=.4)=>{const r=[],[n,i,a]=_T(s),[o,c,u]=ET(n,i,a),h=Math.round(u*100);h>70?e=.8:h>60?e=.9:h<10?e=.075:h<42&&(e=.3);const p=t.findIndex(k=>k===0);if(p===-1)throw new Error("Invalid reducer provided, it must contain atleast one zero");const f=5-p,v=p+1,y=(100-h)/f,P=h/v;for(const k of t){let I;k<0?I=h+k*P*e:k>0?I=h+k*y*e:I=h;const[x,$,O]=ST(o,c,I/100);r.push(wT(x,$,O))}return r},mp={dark:{background:{1e3:"#252525",900:"#2F2F2F",800:"#323232",700:"#3E3E3E",600:"#4A4A4A"},text:"#F5F5F5","video-bg":"#1C1C1C"},light:{background:{1e3:"#FFFFFF",900:"#F5F5F5",800:"#EBEBEB",700:"#E0E0E0",600:"#D6D6D6"},text:"#111111","text-on-brand":"#ffffff","video-bg":"#DADADA"}},CT=s=>{const[t,e,r,n,i]=pp(s,hp);return{300:t,400:e,500:r,600:n,700:i}},bT=s=>{if(s==="#FFFFFF")return mp.light.background;if(s==="#000000")return mp.dark.background;const[t,e,r,n,i]=pp(s,TT);return{1e3:t,900:e,800:r,700:n,600:i}};function PT(){this.__data__=[],this.size=0}function sa(s,t){return s===t||s!==s&&t!==t}function ec(s,t){for(var e=s.length;e--;)if(sa(s[e][0],t))return e;return-1}var RT=Array.prototype,kT=RT.splice;function IT(s){var t=this.__data__,e=ec(t,s);if(e<0)return!1;var r=t.length-1;return e==r?t.pop():kT.call(t,e,1),--this.size,!0}function AT(s){var t=this.__data__,e=ec(t,s);return e<0?void 0:t[e][1]}function MT(s){return ec(this.__data__,s)>-1}function DT(s,t){var e=this.__data__,r=ec(e,s);return r<0?(++this.size,e.push([s,t])):e[r][1]=t,this}function Fr(s){var t=-1,e=s==null?0:s.length;for(this.clear();++t<e;){var r=s[t];this.set(r[0],r[1])}}Fr.prototype.clear=PT,Fr.prototype.delete=IT,Fr.prototype.get=AT,Fr.prototype.has=MT,Fr.prototype.set=DT;function OT(){this.__data__=new Fr,this.size=0}function NT(s){var t=this.__data__,e=t.delete(s);return this.size=t.size,e}function LT(s){return this.__data__.get(s)}function FT(s){return this.__data__.has(s)}var xT=typeof global=="object"&&global&&global.Object===Object&&global;const fp=xT;var UT=typeof self=="object"&&self&&self.Object===Object&&self,$T=fp||UT||Function("return this")();const ar=$T;var VT=ar.Symbol;const cs=VT;var gp=Object.prototype,BT=gp.hasOwnProperty,HT=gp.toString,na=cs?cs.toStringTag:void 0;function qT(s){var t=BT.call(s,na),e=s[na];try{s[na]=void 0;var r=!0}catch(i){}var n=HT.call(s);return r&&(t?s[na]=e:delete s[na]),n}var jT=Object.prototype,GT=jT.toString;function WT(s){return GT.call(s)}var JT="[object Null]",KT="[object Undefined]",vp=cs?cs.toStringTag:void 0;function Qs(s){return s==null?s===void 0?KT:JT:vp&&vp in Object(s)?qT(s):WT(s)}function or(s){var t=typeof s;return s!=null&&(t=="object"||t=="function")}var zT="[object AsyncFunction]",YT="[object Function]",QT="[object GeneratorFunction]",XT="[object Proxy]";function cl(s){if(!or(s))return!1;var t=Qs(s);return t==YT||t==QT||t==zT||t==XT}var ZT=ar["__core-js_shared__"];const dl=ZT;var yp=function(){var s=/[^.]+$/.exec(dl&&dl.keys&&dl.keys.IE_PROTO||"");return s?"Symbol(src)_1."+s:""}();function e_(s){return!!yp&&yp in s}var t_=Function.prototype,r_=t_.toString;function Xs(s){if(s!=null){try{return r_.call(s)}catch(t){}try{return s+""}catch(t){}}return""}var s_=/[\\^$.*+?()[\]{}|]/g,n_=/^\[object .+?Constructor\]$/,i_=Function.prototype,a_=Object.prototype,o_=i_.toString,c_=a_.hasOwnProperty,d_=RegExp("^"+o_.call(c_).replace(s_,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function l_(s){if(!or(s)||e_(s))return!1;var t=cl(s)?d_:n_;return t.test(Xs(s))}function u_(s,t){return s==null?void 0:s[t]}function Zs(s,t){var e=u_(s,t);return l_(e)?e:void 0}var h_=Zs(ar,"Map");const ia=h_;var p_=Zs(Object,"create");const aa=p_;function m_(){this.__data__=aa?aa(null):{},this.size=0}function f_(s){var t=this.has(s)&&delete this.__data__[s];return this.size-=t?1:0,t}var g_="__lodash_hash_undefined__",v_=Object.prototype,y_=v_.hasOwnProperty;function T_(s){var t=this.__data__;if(aa){var e=t[s];return e===g_?void 0:e}return y_.call(t,s)?t[s]:void 0}var __=Object.prototype,S_=__.hasOwnProperty;function E_(s){var t=this.__data__;return aa?t[s]!==void 0:S_.call(t,s)}var w_="__lodash_hash_undefined__";function C_(s,t){var e=this.__data__;return this.size+=this.has(s)?0:1,e[s]=aa&&t===void 0?w_:t,this}function en(s){var t=-1,e=s==null?0:s.length;for(this.clear();++t<e;){var r=s[t];this.set(r[0],r[1])}}en.prototype.clear=m_,en.prototype.delete=f_,en.prototype.get=T_,en.prototype.has=E_,en.prototype.set=C_;function b_(){this.size=0,this.__data__={hash:new en,map:new(ia||Fr),string:new en}}function P_(s){var t=typeof s;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?s!=="__proto__":s===null}function tc(s,t){var e=s.__data__;return P_(t)?e[typeof t=="string"?"string":"hash"]:e.map}function R_(s){var t=tc(this,s).delete(s);return this.size-=t?1:0,t}function k_(s){return tc(this,s).get(s)}function I_(s){return tc(this,s).has(s)}function A_(s,t){var e=tc(this,s),r=e.size;return e.set(s,t),this.size+=e.size==r?0:1,this}function tn(s){var t=-1,e=s==null?0:s.length;for(this.clear();++t<e;){var r=s[t];this.set(r[0],r[1])}}tn.prototype.clear=b_,tn.prototype.delete=R_,tn.prototype.get=k_,tn.prototype.has=I_,tn.prototype.set=A_;var M_=200;function D_(s,t){var e=this.__data__;if(e instanceof Fr){var r=e.__data__;if(!ia||r.length<M_-1)return r.push([s,t]),this.size=++e.size,this;e=this.__data__=new tn(r)}return e.set(s,t),this.size=e.size,this}function Tr(s){var t=this.__data__=new Fr(s);this.size=t.size}Tr.prototype.clear=OT,Tr.prototype.delete=NT,Tr.prototype.get=LT,Tr.prototype.has=FT,Tr.prototype.set=D_;function O_(s,t){for(var e=-1,r=s==null?0:s.length;++e<r&&t(s[e],e,s)!==!1;);return s}var N_=function(){try{var s=Zs(Object,"defineProperty");return s({},"",{}),s}catch(t){}}();const rc=N_;function ll(s,t,e){t=="__proto__"&&rc?rc(s,t,{configurable:!0,enumerable:!0,value:e,writable:!0}):s[t]=e}var L_=Object.prototype,F_=L_.hasOwnProperty;function Tp(s,t,e){var r=s[t];(!(F_.call(s,t)&&sa(r,e))||e===void 0&&!(t in s))&&ll(s,t,e)}function oa(s,t,e,r){var n=!e;e||(e={});for(var i=-1,a=t.length;++i<a;){var o=t[i],c=r?r(e[o],s[o],o,e,s):void 0;c===void 0&&(c=s[o]),n?ll(e,o,c):Tp(e,o,c)}return e}function x_(s,t){for(var e=-1,r=Array(s);++e<s;)r[e]=t(e);return r}function _r(s){return s!=null&&typeof s=="object"}var U_="[object Arguments]";function _p(s){return _r(s)&&Qs(s)==U_}var Sp=Object.prototype,$_=Sp.hasOwnProperty,V_=Sp.propertyIsEnumerable,B_=_p(function(){return arguments}())?_p:function(s){return _r(s)&&$_.call(s,"callee")&&!V_.call(s,"callee")};const sc=B_;var H_=Array.isArray;const ds=H_;function q_(){return!1}var Ep=typeof exports=="object"&&exports&&!exports.nodeType&&exports,wp=Ep&&typeof module=="object"&&module&&!module.nodeType&&module,j_=wp&&wp.exports===Ep,Cp=j_?ar.Buffer:void 0,G_=Cp?Cp.isBuffer:void 0,W_=G_||q_;const Wn=W_;var J_=9007199254740991,K_=/^(?:0|[1-9]\d*)$/;function bp(s,t){var e=typeof s;return t=t==null?J_:t,!!t&&(e=="number"||e!="symbol"&&K_.test(s))&&s>-1&&s%1==0&&s<t}var z_=9007199254740991;function Pp(s){return typeof s=="number"&&s>-1&&s%1==0&&s<=z_}var Y_="[object Arguments]",Q_="[object Array]",X_="[object Boolean]",Z_="[object Date]",eS="[object Error]",tS="[object Function]",rS="[object Map]",sS="[object Number]",nS="[object Object]",iS="[object RegExp]",aS="[object Set]",oS="[object String]",cS="[object WeakMap]",dS="[object ArrayBuffer]",lS="[object DataView]",uS="[object Float32Array]",hS="[object Float64Array]",pS="[object Int8Array]",mS="[object Int16Array]",fS="[object Int32Array]",gS="[object Uint8Array]",vS="[object Uint8ClampedArray]",yS="[object Uint16Array]",TS="[object Uint32Array]",Me={};Me[uS]=Me[hS]=Me[pS]=Me[mS]=Me[fS]=Me[gS]=Me[vS]=Me[yS]=Me[TS]=!0,Me[Y_]=Me[Q_]=Me[dS]=Me[X_]=Me[lS]=Me[Z_]=Me[eS]=Me[tS]=Me[rS]=Me[sS]=Me[nS]=Me[iS]=Me[aS]=Me[oS]=Me[cS]=!1;function _S(s){return _r(s)&&Pp(s.length)&&!!Me[Qs(s)]}function ul(s){return function(t){return s(t)}}var Rp=typeof exports=="object"&&exports&&!exports.nodeType&&exports,ca=Rp&&typeof module=="object"&&module&&!module.nodeType&&module,SS=ca&&ca.exports===Rp,hl=SS&&fp.process,ES=function(){try{var s=ca&&ca.require&&ca.require("util").types;return s||hl&&hl.binding&&hl.binding("util")}catch(t){}}();const Jn=ES;var kp=Jn&&Jn.isTypedArray,wS=kp?ul(kp):_S;const nc=wS;var CS=Object.prototype,bS=CS.hasOwnProperty;function Ip(s,t){var e=ds(s),r=!e&&sc(s),n=!e&&!r&&Wn(s),i=!e&&!r&&!n&&nc(s),a=e||r||n||i,o=a?x_(s.length,String):[],c=o.length;for(var u in s)(t||bS.call(s,u))&&!(a&&(u=="length"||n&&(u=="offset"||u=="parent")||i&&(u=="buffer"||u=="byteLength"||u=="byteOffset")||bp(u,c)))&&o.push(u);return o}var PS=Object.prototype;function ic(s){var t=s&&s.constructor,e=typeof t=="function"&&t.prototype||PS;return s===e}function Ap(s,t){return function(e){return s(t(e))}}var RS=Ap(Object.keys,Object);const kS=RS;var IS=Object.prototype,AS=IS.hasOwnProperty;function Mp(s){if(!ic(s))return kS(s);var t=[];for(var e in Object(s))AS.call(s,e)&&e!="constructor"&&t.push(e);return t}function da(s){return s!=null&&Pp(s.length)&&!cl(s)}function pl(s){return da(s)?Ip(s):Mp(s)}function MS(s,t){return s&&oa(t,pl(t),s)}function DS(s){var t=[];if(s!=null)for(var e in Object(s))t.push(e);return t}var OS=Object.prototype,NS=OS.hasOwnProperty;function LS(s){if(!or(s))return DS(s);var t=ic(s),e=[];for(var r in s)r=="constructor"&&(t||!NS.call(s,r))||e.push(r);return e}function la(s){return da(s)?Ip(s,!0):LS(s)}function FS(s,t){return s&&oa(t,la(t),s)}var Dp=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Op=Dp&&typeof module=="object"&&module&&!module.nodeType&&module,xS=Op&&Op.exports===Dp,Np=xS?ar.Buffer:void 0,Lp=Np?Np.allocUnsafe:void 0;function Fp(s,t){if(t)return s.slice();var e=s.length,r=Lp?Lp(e):new s.constructor(e);return s.copy(r),r}function xp(s,t){var e=-1,r=s.length;for(t||(t=Array(r));++e<r;)t[e]=s[e];return t}function US(s,t){for(var e=-1,r=s==null?0:s.length,n=0,i=[];++e<r;){var a=s[e];t(a,e,s)&&(i[n++]=a)}return i}function Up(){return[]}var $S=Object.prototype,VS=$S.propertyIsEnumerable,$p=Object.getOwnPropertySymbols,BS=$p?function(s){return s==null?[]:(s=Object(s),US($p(s),function(t){return VS.call(s,t)}))}:Up;const ml=BS;function HS(s,t){return oa(s,ml(s),t)}function Vp(s,t){for(var e=-1,r=t.length,n=s.length;++e<r;)s[n+e]=t[e];return s}var qS=Ap(Object.getPrototypeOf,Object);const fl=qS;var jS=Object.getOwnPropertySymbols,GS=jS?function(s){for(var t=[];s;)Vp(t,ml(s)),s=fl(s);return t}:Up;const Bp=GS;function WS(s,t){return oa(s,Bp(s),t)}function Hp(s,t,e){var r=t(s);return ds(s)?r:Vp(r,e(s))}function gl(s){return Hp(s,pl,ml)}function JS(s){return Hp(s,la,Bp)}var KS=Zs(ar,"DataView");const vl=KS;var zS=Zs(ar,"Promise");const yl=zS;var YS=Zs(ar,"Set");const Tl=YS;var QS=Zs(ar,"WeakMap");const _l=QS;var qp="[object Map]",XS="[object Object]",jp="[object Promise]",Gp="[object Set]",Wp="[object WeakMap]",Jp="[object DataView]",ZS=Xs(vl),eE=Xs(ia),tE=Xs(yl),rE=Xs(Tl),sE=Xs(_l),rn=Qs;(vl&&rn(new vl(new ArrayBuffer(1)))!=Jp||ia&&rn(new ia)!=qp||yl&&rn(yl.resolve())!=jp||Tl&&rn(new Tl)!=Gp||_l&&rn(new _l)!=Wp)&&(rn=function(s){var t=Qs(s),e=t==XS?s.constructor:void 0,r=e?Xs(e):"";if(r)switch(r){case ZS:return Jp;case eE:return qp;case tE:return jp;case rE:return Gp;case sE:return Wp}return t});const Kn=rn;var nE=Object.prototype,iE=nE.hasOwnProperty;function aE(s){var t=s.length,e=new s.constructor(t);return t&&typeof s[0]=="string"&&iE.call(s,"index")&&(e.index=s.index,e.input=s.input),e}var oE=ar.Uint8Array;const ac=oE;function Sl(s){var t=new s.constructor(s.byteLength);return new ac(t).set(new ac(s)),t}function cE(s,t){var e=t?Sl(s.buffer):s.buffer;return new s.constructor(e,s.byteOffset,s.byteLength)}var dE=/\w*$/;function lE(s){var t=new s.constructor(s.source,dE.exec(s));return t.lastIndex=s.lastIndex,t}var Kp=cs?cs.prototype:void 0,zp=Kp?Kp.valueOf:void 0;function uE(s){return zp?Object(zp.call(s)):{}}function Yp(s,t){var e=t?Sl(s.buffer):s.buffer;return new s.constructor(e,s.byteOffset,s.length)}var hE="[object Boolean]",pE="[object Date]",mE="[object Map]",fE="[object Number]",gE="[object RegExp]",vE="[object Set]",yE="[object String]",TE="[object Symbol]",_E="[object ArrayBuffer]",SE="[object DataView]",EE="[object Float32Array]",wE="[object Float64Array]",CE="[object Int8Array]",bE="[object Int16Array]",PE="[object Int32Array]",RE="[object Uint8Array]",kE="[object Uint8ClampedArray]",IE="[object Uint16Array]",AE="[object Uint32Array]";function ME(s,t,e){var r=s.constructor;switch(t){case _E:return Sl(s);case hE:case pE:return new r(+s);case SE:return cE(s,e);case EE:case wE:case CE:case bE:case PE:case RE:case kE:case IE:case AE:return Yp(s,e);case mE:return new r;case fE:case yE:return new r(s);case gE:return lE(s);case vE:return new r;case TE:return uE(s)}}var Qp=Object.create,DE=function(){function s(){}return function(t){if(!or(t))return{};if(Qp)return Qp(t);s.prototype=t;var e=new s;return s.prototype=void 0,e}}();const OE=DE;function Xp(s){return typeof s.constructor=="function"&&!ic(s)?OE(fl(s)):{}}var NE="[object Map]";function LE(s){return _r(s)&&Kn(s)==NE}var Zp=Jn&&Jn.isMap,FE=Zp?ul(Zp):LE;const xE=FE;var UE="[object Set]";function $E(s){return _r(s)&&Kn(s)==UE}var em=Jn&&Jn.isSet,VE=em?ul(em):$E;const BE=VE;var HE=1,qE=2,jE=4,tm="[object Arguments]",GE="[object Array]",WE="[object Boolean]",JE="[object Date]",KE="[object Error]",rm="[object Function]",zE="[object GeneratorFunction]",YE="[object Map]",QE="[object Number]",sm="[object Object]",XE="[object RegExp]",ZE="[object Set]",ew="[object String]",tw="[object Symbol]",rw="[object WeakMap]",sw="[object ArrayBuffer]",nw="[object DataView]",iw="[object Float32Array]",aw="[object Float64Array]",ow="[object Int8Array]",cw="[object Int16Array]",dw="[object Int32Array]",lw="[object Uint8Array]",uw="[object Uint8ClampedArray]",hw="[object Uint16Array]",pw="[object Uint32Array]",Re={};Re[tm]=Re[GE]=Re[sw]=Re[nw]=Re[WE]=Re[JE]=Re[iw]=Re[aw]=Re[ow]=Re[cw]=Re[dw]=Re[YE]=Re[QE]=Re[sm]=Re[XE]=Re[ZE]=Re[ew]=Re[tw]=Re[lw]=Re[uw]=Re[hw]=Re[pw]=!0,Re[KE]=Re[rm]=Re[rw]=!1;function oc(s,t,e,r,n,i){var a,o=t&HE,c=t&qE,u=t&jE;if(e&&(a=n?e(s,r,n,i):e(s)),a!==void 0)return a;if(!or(s))return s;var h=ds(s);if(h){if(a=aE(s),!o)return xp(s,a)}else{var p=Kn(s),f=p==rm||p==zE;if(Wn(s))return Fp(s,o);if(p==sm||p==tm||f&&!n){if(a=c||f?{}:Xp(s),!o)return c?WS(s,FS(a,s)):HS(s,MS(a,s))}else{if(!Re[p])return n?s:{};a=ME(s,p,o)}}i||(i=new Tr);var v=i.get(s);if(v)return v;i.set(s,a),BE(s)?s.forEach(function(k){a.add(oc(k,t,e,k,s,i))}):xE(s)&&s.forEach(function(k,I){a.set(I,oc(k,t,e,I,s,i))});var y=u?c?JS:gl:c?la:pl,P=h?void 0:y(s);return O_(P||s,function(k,I){P&&(I=k,k=s[I]),Tp(a,I,oc(k,t,e,I,s,i))}),a}var mw=1,fw=4;function El(s){return oc(s,mw|fw)}var gw="[object Symbol]";function vw(s){return typeof s=="symbol"||_r(s)&&Qs(s)==gw}const yw={border_radius:"rounded",border_width:"thin",spacing_base:4,theme:"dark",colors:{brand:CT("#2160FD"),background:bT("#141414"),danger:"#FF2D2D",text:"#EEEEEE",text_on_brand:"#EEEEEE",success:"#62A504",video_bg:"#191919",warning:"#FFCD07"}};function nm(){return El(yw)}const Tw={permissions:{can_accept_production_requests:!1,can_edit_display_name:!0,accept_waiting_requests:!1,disable_participant_audio:!1,disable_participant_screensharing:!1,disable_participant_video:!1,can_spotlight:!1,kick_participant:!1,pin_participant:!1,can_record:!1,can_livestream:!1,waiting_room_type:qo.Skip,plugins:{can_close:!0,can_start:!0,can_edit_config:!1,config:{}},polls:{can_create:!0,can_vote:!0,can_view:!0},media:{video:{can_produce:H.Allowed,can_consume:jo.Allowed},audio:{can_produce:H.Allowed},screenshare:{can_produce:H.Allowed,can_consume:jo.Allowed}},chat:{public:{can_send:!0,text:!0,files:!0},private:{can_send:!1,can_receive:!1,text:!1,files:!1},channel:{can_create:"ALL",can_delete:"ALL",can_update:"ALL",can_read_all:!1},message:{can_delete:"ALL",can_edit:"ALL",delete_cutoff_time_seconds:0,edit_cutoff_time_seconds:0}},hidden_participant:!1,is_recorder:!1,recorder_type:qn.none,show_participant_list:!0,transcription_enabled:!1,can_change_participant_permissions:!1,connected_meetings:{can_alter_connected_meetings:!1,can_switch_connected_meetings:!1,can_switch_to_parent_meeting:!1},stage_enabled:!1,stage_access:void 0,accept_stage_requests:!1},ui:{oldTheme:{setup_screen:{is_enabled:!1},alone_here:{is_enabled:!1},waiting_room:{is_enabled:!1,enable_preview:!0},control_bar:{is_enabled:!0,elements:{plugins:!0,screenshare:!0,invite:!1,participants:!0,chat:!0,reactions:!1,polls:!0,fullscreen:!0,layout:!0}},header:{is_enabled:!0,elements:{timer:!0,title:!0,participant_count:!0,change_layout:!0}},pip_mode:!0,auto_tune:!0,colors:{primary:"#2160FD",secondary:"#1A1A1A",text:"#EEEEEE",background:"#1A1A1A",textPrimary:"#EEEEEE",videoBackground:"#1A1A1A"},dimensions:{mode:"fillParent"},grid:{multi:{maxVideoCount:6,videoFit:"cover"},single:{maxVideoCount:6,videoFit:"cover"},defaultView:"MULTI"},controls:{pip_toggle:!1},plugins:[]},design_tokens:nm(),config_diff:{}},config:{view_type:Xe.GroupCall,media:{audio:{enable_stereo:!1,enable_high_bitrate:!1},video:{quality:"vga",frame_rate:24},screenshare:{quality:"hd",frame_rate:5}},max_video_streams:{mobile:6,desktop:6},max_screenshare_count:1},version:"hybrid"};function _w(){return El(Tw)}qn.none,Go.skip;const Sw={permissions:{can_accept_production_requests:!1,can_edit_display_name:!0,accept_waiting_requests:!1,disable_participant_audio:!1,disable_participant_screensharing:!1,disable_participant_video:!1,can_spotlight:!1,kick_participant:!1,pin_participant:!1,can_record:!1,can_livestream:!1,waiting_room_type:qo.Skip,plugins:{can_close:!0,can_start:!0,can_edit_config:!1,config:{}},polls:{can_create:!0,can_vote:!0,can_view:!0},media:{video:{can_produce:H.Allowed},audio:{can_produce:H.Allowed},screenshare:{can_produce:H.Allowed}},chat:{public:{can_send:!0,text:!0,files:!0},private:{can_send:!1,can_receive:!1,text:!1,files:!1}},hidden_participant:!1,is_recorder:!1,recorder_type:qn.none,show_participant_list:!0,transcription_enabled:!1,can_change_participant_permissions:!1,connected_meetings:{can_alter_connected_meetings:!1,can_switch_connected_meetings:!1,can_switch_to_parent_meeting:!1},stage_enabled:!1,stage_access:void 0,accept_stage_requests:!1},ui:{design_tokens:nm(),config_diff:{}},config:{view_type:Xe.GroupCall,media:{audio:{enable_stereo:!1,enable_high_bitrate:!1},video:{quality:"vga",frame_rate:24},screenshare:{quality:"hd",frame_rate:5}},max_video_streams:{mobile:6,desktop:6},max_screenshare_count:1},version:"2.0.0"};function wl(){return El(Sw)}var Ew=/\s/;function ww(s){for(var t=s.length;t--&&Ew.test(s.charAt(t)););return t}var Cw=/^\s+/;function bw(s){return s&&s.slice(0,ww(s)+1).replace(Cw,"")}var im=0/0,Pw=/^[-+]0x[0-9a-f]+$/i,Rw=/^0b[01]+$/i,kw=/^0o[0-7]+$/i,Iw=parseInt;function am(s){if(typeof s=="number")return s;if(vw(s))return im;if(or(s)){var t=typeof s.valueOf=="function"?s.valueOf():s;s=or(t)?t+"":t}if(typeof s!="string")return s===0?s:+s;s=bw(s);var e=Rw.test(s);return e||kw.test(s)?Iw(s.slice(2),e?2:8):Pw.test(s)?im:+s}function om(s){return s}function Aw(s,t,e){switch(e.length){case 0:return s.call(t);case 1:return s.call(t,e[0]);case 2:return s.call(t,e[0],e[1]);case 3:return s.call(t,e[0],e[1],e[2])}return s.apply(t,e)}var Mw=800,Dw=16,Ow=Date.now;function Nw(s){var t=0,e=0;return function(){var r=Ow(),n=Dw-(r-e);if(e=r,n>0){if(++t>=Mw)return arguments[0]}else t=0;return s.apply(void 0,arguments)}}function Lw(s){return function(){return s}}var Fw=rc?function(s,t){return rc(s,"toString",{configurable:!0,enumerable:!1,value:Lw(t),writable:!0})}:om,xw=Nw(Fw);const Uw=xw;var cm=Math.max;function $w(s,t,e){return t=cm(t===void 0?s.length-1:t,0),function(){for(var r=arguments,n=-1,i=cm(r.length-t,0),a=Array(i);++n<i;)a[n]=r[t+n];n=-1;for(var o=Array(t+1);++n<t;)o[n]=r[n];return o[t]=e(a),Aw(s,this,o)}}function Vw(s,t){return Uw($w(s,t,om),s+"")}function Bw(s,t,e){if(!or(e))return!1;var r=typeof t;return(r=="number"?da(e)&&bp(t,e.length):r=="string"&&t in e)?sa(e[t],s):!1}function Hw(s){return Vw(function(t,e){var r=-1,n=e.length,i=n>1?e[n-1]:void 0,a=n>2?e[2]:void 0;for(i=s.length>3&&typeof i=="function"?(n--,i):void 0,a&&Bw(e[0],e[1],a)&&(i=n<3?void 0:i,n=1),t=Object(t);++r<n;){var o=e[r];o&&s(t,o,r,i)}return t})}var qw="[object Object]",jw=Function.prototype,Gw=Object.prototype,dm=jw.toString,Ww=Gw.hasOwnProperty,Jw=dm.call(Object);function Kw(s){if(!_r(s)||Qs(s)!=qw)return!1;var t=fl(s);if(t===null)return!0;var e=Ww.call(t,"constructor")&&t.constructor;return typeof e=="function"&&e instanceof e&&dm.call(e)==Jw}var zw="__lodash_hash_undefined__";function Yw(s){return this.__data__.set(s,zw),this}function Qw(s){return this.__data__.has(s)}function cc(s){var t=-1,e=s==null?0:s.length;for(this.__data__=new tn;++t<e;)this.add(s[t])}cc.prototype.add=cc.prototype.push=Yw,cc.prototype.has=Qw;function Xw(s,t){for(var e=-1,r=s==null?0:s.length;++e<r;)if(t(s[e],e,s))return!0;return!1}function Zw(s,t){return s.has(t)}var eC=1,tC=2;function lm(s,t,e,r,n,i){var a=e&eC,o=s.length,c=t.length;if(o!=c&&!(a&&c>o))return!1;var u=i.get(s),h=i.get(t);if(u&&h)return u==t&&h==s;var p=-1,f=!0,v=e&tC?new cc:void 0;for(i.set(s,t),i.set(t,s);++p<o;){var y=s[p],P=t[p];if(r)var k=a?r(P,y,p,t,s,i):r(y,P,p,s,t,i);if(k!==void 0){if(k)continue;f=!1;break}if(v){if(!Xw(t,function(I,x){if(!Zw(v,x)&&(y===I||n(y,I,e,r,i)))return v.push(x)})){f=!1;break}}else if(!(y===P||n(y,P,e,r,i))){f=!1;break}}return i.delete(s),i.delete(t),f}function rC(s){var t=-1,e=Array(s.size);return s.forEach(function(r,n){e[++t]=[n,r]}),e}function sC(s){var t=-1,e=Array(s.size);return s.forEach(function(r){e[++t]=r}),e}var nC=1,iC=2,aC="[object Boolean]",oC="[object Date]",cC="[object Error]",dC="[object Map]",lC="[object Number]",uC="[object RegExp]",hC="[object Set]",pC="[object String]",mC="[object Symbol]",fC="[object ArrayBuffer]",gC="[object DataView]",um=cs?cs.prototype:void 0,Cl=um?um.valueOf:void 0;function vC(s,t,e,r,n,i,a){switch(e){case gC:if(s.byteLength!=t.byteLength||s.byteOffset!=t.byteOffset)return!1;s=s.buffer,t=t.buffer;case fC:return!(s.byteLength!=t.byteLength||!i(new ac(s),new ac(t)));case aC:case oC:case lC:return sa(+s,+t);case cC:return s.name==t.name&&s.message==t.message;case uC:case pC:return s==t+"";case dC:var o=rC;case hC:var c=r&nC;if(o||(o=sC),s.size!=t.size&&!c)return!1;var u=a.get(s);if(u)return u==t;r|=iC,a.set(s,t);var h=lm(o(s),o(t),r,n,i,a);return a.delete(s),h;case mC:if(Cl)return Cl.call(s)==Cl.call(t)}return!1}var yC=1,TC=Object.prototype,_C=TC.hasOwnProperty;function SC(s,t,e,r,n,i){var a=e&yC,o=gl(s),c=o.length,u=gl(t),h=u.length;if(c!=h&&!a)return!1;for(var p=c;p--;){var f=o[p];if(!(a?f in t:_C.call(t,f)))return!1}var v=i.get(s),y=i.get(t);if(v&&y)return v==t&&y==s;var P=!0;i.set(s,t),i.set(t,s);for(var k=a;++p<c;){f=o[p];var I=s[f],x=t[f];if(r)var $=a?r(x,I,f,t,s,i):r(I,x,f,s,t,i);if(!($===void 0?I===x||n(I,x,e,r,i):$)){P=!1;break}k||(k=f=="constructor")}if(P&&!k){var O=s.constructor,K=t.constructor;O!=K&&"constructor"in s&&"constructor"in t&&!(typeof O=="function"&&O instanceof O&&typeof K=="function"&&K instanceof K)&&(P=!1)}return i.delete(s),i.delete(t),P}var EC=1,hm="[object Arguments]",pm="[object Array]",dc="[object Object]",wC=Object.prototype,mm=wC.hasOwnProperty;function CC(s,t,e,r,n,i){var a=ds(s),o=ds(t),c=a?pm:Kn(s),u=o?pm:Kn(t);c=c==hm?dc:c,u=u==hm?dc:u;var h=c==dc,p=u==dc,f=c==u;if(f&&Wn(s)){if(!Wn(t))return!1;a=!0,h=!1}if(f&&!h)return i||(i=new Tr),a||nc(s)?lm(s,t,e,r,n,i):vC(s,t,c,e,r,n,i);if(!(e&EC)){var v=h&&mm.call(s,"__wrapped__"),y=p&&mm.call(t,"__wrapped__");if(v||y){var P=v?s.value():s,k=y?t.value():t;return i||(i=new Tr),n(P,k,e,r,i)}}return f?(i||(i=new Tr),SC(s,t,e,r,n,i)):!1}function fm(s,t,e,r,n){return s===t?!0:s==null||t==null||!_r(s)&&!_r(t)?s!==s&&t!==t:CC(s,t,e,r,fm,n)}function bC(s){return function(t,e,r){for(var n=-1,i=Object(t),a=r(t),o=a.length;o--;){var c=a[s?o:++n];if(e(i[c],c,i)===!1)break}return t}}var PC=bC();const RC=PC;var kC=function(){return ar.Date.now()};const bl=kC;var IC="Expected a function",AC=Math.max,MC=Math.min;function Sr(s,t,e){var r,n,i,a,o,c,u=0,h=!1,p=!1,f=!0;if(typeof s!="function")throw new TypeError(IC);t=am(t)||0,or(e)&&(h=!!e.leading,p="maxWait"in e,i=p?AC(am(e.maxWait)||0,t):i,f="trailing"in e?!!e.trailing:f);function v(X){var oe=r,Te=n;return r=n=void 0,u=X,a=s.apply(Te,oe),a}function y(X){return u=X,o=setTimeout(I,t),h?v(X):a}function P(X){var oe=X-c,Te=X-u,It=t-oe;return p?MC(It,i-Te):It}function k(X){var oe=X-c,Te=X-u;return c===void 0||oe>=t||oe<0||p&&Te>=i}function I(){var X=bl();if(k(X))return x(X);o=setTimeout(I,P(X))}function x(X){return o=void 0,f&&r?v(X):(r=n=void 0,a)}function $(){o!==void 0&&clearTimeout(o),u=0,r=c=n=o=void 0}function O(){return o===void 0?a:x(bl())}function K(){var X=bl(),oe=k(X);if(r=arguments,n=this,c=X,oe){if(o===void 0)return y(c);if(p)return clearTimeout(o),o=setTimeout(I,t),v(c)}return o===void 0&&(o=setTimeout(I,t)),a}return K.cancel=$,K.flush=O,K}function Pl(s,t,e){(e!==void 0&&!sa(s[t],e)||e===void 0&&!(t in s))&&ll(s,t,e)}function DC(s){return _r(s)&&da(s)}function Rl(s,t){if(!(t==="constructor"&&typeof s[t]=="function")&&t!="__proto__")return s[t]}function OC(s){return oa(s,la(s))}function NC(s,t,e,r,n,i,a){var o=Rl(s,e),c=Rl(t,e),u=a.get(c);if(u){Pl(s,e,u);return}var h=i?i(o,c,e+"",s,t,a):void 0,p=h===void 0;if(p){var f=ds(c),v=!f&&Wn(c),y=!f&&!v&&nc(c);h=c,f||v||y?ds(o)?h=o:DC(o)?h=xp(o):v?(p=!1,h=Fp(c,!0)):y?(p=!1,h=Yp(c,!0)):h=[]:Kw(c)||sc(c)?(h=o,sc(o)?h=OC(o):(!or(o)||cl(o))&&(h=Xp(c))):p=!1}p&&(a.set(c,h),n(h,c,r,i,a),a.delete(c)),Pl(s,e,h)}function gm(s,t,e,r,n){s!==t&&RC(t,function(i,a){if(n||(n=new Tr),or(i))NC(s,t,a,e,gm,r,n);else{var o=r?r(Rl(s,a),i,a+"",s,t,n):void 0;o===void 0&&(o=i),Pl(s,a,o)}},la)}var LC="[object Map]",FC="[object Set]",xC=Object.prototype,UC=xC.hasOwnProperty;function $C(s){if(s==null)return!0;if(da(s)&&(ds(s)||typeof s=="string"||typeof s.splice=="function"||Wn(s)||nc(s)||sc(s)))return!s.length;var t=Kn(s);if(t==LC||t==FC)return!s.size;if(ic(s))return!Mp(s).length;for(var e in s)if(UC.call(s,e))return!1;return!0}function VC(s,t){return fm(s,t)}var BC=Hw(function(s,t,e){gm(s,t,e)});const ls=BC;var kl=(s=>(s.PARTICIPANT="PARTICIPANT",s.PEER="PEER",s.CLIENT="CLIENT",s))(kl||{});const J={PROPAGATE_KICK_ALL:"propagate_kick_across_rooms",REFRESH_ID_ON_DISCONNECTION:"refresh_id_on_disconnection",INTERNAL_CALL_STATS:"internal_call_stats",SIMULCAST:"simulcast",CHAT_SOCKET_SERVER:"chat_socket_server",POLL_SOCKET_SERVER:"poll_socket_server",PLUGIN_SOCKET_SERVER:"plugin_socket_server",NR_OTEL_WEB:"nr_otel_web",CONNECTED_MEETINGS:"connected_meetings",ICE_RESTART_ON_FAILED_STATE:"ice_restart_on_failed_state",ICE_RESTART_ON_DISCONNECTED_STATE:"ice_restart_on_disconnected_state",ENABLE_ICE_STATE_LOGGING:"enable_ice_state_logging",SUPPRESS_PEER_MUTE_UNMUTE_EMITS:"web_core_suppress_peer_mute_unmute_emits",SKIP_OTEL_TRACES:"skip_otel_traces",USE_USERIDS_IN_CHAT:"use_userids_in_chat",CUSTOM_PING_PONG:"custom_ping_pong",ENABLE_HIVE_SIMULCAST:"enable_hive_simulcast",ENABLE_HIVE_TRANSPORT_RECONNECTION_ON_ICE_FAILED:"enable_hive_transport_reconnection_on_ice_failed",ENABLE_HIVE_EXPERIMENTAL_FAIL_RECOVERY:"enable_hive_fail_recovery",ENABLE_HIVE_INFINITE_RETRIES:"enable_hive_infinite_retries",HIVE_TRANSPORT_FORCE_RELAY_ON_ICE_FAILED:"hive_transport_force_relay_on_ice_failed",ENABLE_HIVE_CONSUME_OVER_DC:"enable_hive_consume_over_dc",ENABLE_CF_SIMULCAST:"enable_cf_simulcast",ENABLE_CF_TRANSPORT_RECONNECTION_ON_ICE_FAILED:"enable_cf_transport_reconnection_on_ice_failed",ENABLE_CF_EXPERIMENTAL_FAIL_RECOVERY:"enable_cf_fail_recovery",ENABLE_CF_INFINITE_RETRIES:"enable_cf_infinite_retries",CF_TRANSPORT_FORCE_RELAY_ON_ICE_FAILED:"cf_transport_force_relay_on_ice_failed",BYPASS_LOG_EXCLUSION_LIST:"bypass_log_exclusion_list",LOG_LEVEL:"log_level",V1_PLUGINS:"v1_plugins",SCREENSHARE_DTX:"screenshare_dtx",SCREENSHARE_PRIORITY:"screenshare_priority",SCREENSHARE_MIN_BITRATE:"screenshare_minbitrate",SCREENSHARE_SIMULCAST:"screenshare_simulcast",DISABLE_WEBCAM_LAYERS_ON_SCREENSHARE:"disable_webcam_layers_on_screenshare",SCREENSHARE_FORCE_GOOG_CONFERENCE:"screenshare_force_goog_conference",LIVESTREAM:"feat_livestream",FETCH_RETRY:"fetch_retry",DISABLE_WEBCAM_SIMULCAST:"webcore_disable_webcam_simulcast",OVERRIDE_WEBCAM_SIMULCAST:"override_webcam_simulcast",SOCKET_POLLING:"socket_polling",FEAT_PAGINATED_CHAT:"feat_paginated_chat",VAL_MIN_FRAMERATE:"val_min_framerate",SCREEENSHARE_ERR_HACK:"screenshare_err_hack",SCREEENSHARE_CONSTRAINTS_RETRY:"screenshare_constraints_retry",TROUBLESHOOTING:"feat_troubleshooting",VIDEO_CONSTRAINTS:"video_constraints",SCREENSHARE_CONSTRAINTS:"screenshare_constraints",FEAT_CHAT_SDK:"feat_chat_sdk",FEAT_CHAT_SDK_SEARCH:"chat_search",OBS_QUALITY:"obs_quality",ALLOW_SAFARI_MEDIA_MIDDLEWARES:"allow_safari_media_middlewares",DYNAMIC_VIDEO_QUALITY:"dynamic_video_quality",EXP_RESHARE:"exp_reshare",LEAVE_STAGE_ON_END:"leave_stage_on_end",SKIP_SETTING_IN_USE_DEVICE:"skip_setting_in_use_device",PRECALL_BANDWIDTH_TEST:"precall_bandwidth_test",CONSUMER_BIND_NO_RETRY:"consumer_bind_no_retry",DEBUG_SOCKET_JOIN:"debug_socket_join"};function lc(s){const t={};return typeof(s==null?void 0:s.code)=="number"&&(t.code=s.code),typeof(s==null?void 0:s.code)=="string"&&(t.code=s.code.substring(0,100)),typeof(s==null?void 0:s.name)=="string"&&(t.name=s.name.substring(0,500)),typeof(s==null?void 0:s.message)=="string"&&(t.message=s.message.substring(0,500)),typeof(s==null?void 0:s.reason)=="string"&&(t.reason=s.reason.substring(0,500)),typeof(s==null?void 0:s.stack)=="string"&&(t.stack=s.stack.substring(0,500)),t}function vm(s){var r,n,i,a;const t=typeof navigator!="undefined"&&!navigator.isReactNative&&typeof window!="undefined"&&((r=window.location.host)==null?void 0:r.includes("devel"))&&((n=window.location.host)==null?void 0:n.includes("dyte.io")),e=!!((a=(i=s==null?void 0:s.getValue("modules"))==null?void 0:i.devTools)!=null&&a.logs);return t||e}function HC(s){if(j.hasFeature(J.LOG_LEVEL)){let t=j.getValue(J.LOG_LEVEL)||"all";if(t=t.toLowerCase().trim(),t==="off")return!1;if(t!=="all"){const e=["debug","log","info","warn","error"],r=e.indexOf(s),n=e.indexOf(t);if(r<n)return!1}}return!0}function ym(s,t,e={}){return Object.getOwnPropertyNames(s).forEach(r=>{var i;if([null,void 0,NaN].includes(s[r])||t&&(((i=t.match(/\./g))==null?void 0:i.length)||0)>=10)return;const n=t?`${t}.${r}`:r;typeof s[r]=="object"?ym(s[r],n,e):["number","string","boolean"].includes(typeof s[r])&&(e[n]=s[r])}),e}function Tm(s,t,e={},r=""){const n={};try{const i=JSON.stringify(e),a=JSON.parse(i),o=ym(a,r),c=JSON.stringify(o);if(c.length>5e3){const u=`Log named: "${t}" is trying to log an flattened object of size
${c.length} chars that is beyond permitted limit of 5000 chars. Please optimize.`;throw vm(s)&&console.error(u,{log:e,flattened:c}),new Error(u)}return JSON.parse(c)}catch(i){const a=lc(i);n[`${r}.error.message`]=a.message||"",n[`${r}.error.stack`]=a.stack||"",n[`${r}.error.reason`]=a.reason||"",n[`${r}.error.source`]="safelyFlattenObjForOpenTelemetry"}return n}const qC={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},_m={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},Ge={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},Ct={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},us={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"};class N{static getFirstMatch(t,e){const r=e.match(t);return r&&r.length>0&&r[1]||""}static getSecondMatch(t,e){const r=e.match(t);return r&&r.length>1&&r[2]||""}static matchAndReturnConst(t,e,r){if(t.test(e))return r}static getWindowsVersionName(t){switch(t){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}static getMacOSVersionName(t){const e=t.split(".").splice(0,2).map(r=>parseInt(r,10)||0);if(e.push(0),e[0]===10)switch(e[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}}static getAndroidVersionName(t){const e=t.split(".").splice(0,2).map(r=>parseInt(r,10)||0);if(e.push(0),!(e[0]===1&&e[1]<5)){if(e[0]===1&&e[1]<6)return"Cupcake";if(e[0]===1&&e[1]>=6)return"Donut";if(e[0]===2&&e[1]<2)return"Eclair";if(e[0]===2&&e[1]===2)return"Froyo";if(e[0]===2&&e[1]>2)return"Gingerbread";if(e[0]===3)return"Honeycomb";if(e[0]===4&&e[1]<1)return"Ice Cream Sandwich";if(e[0]===4&&e[1]<4)return"Jelly Bean";if(e[0]===4&&e[1]>=4)return"KitKat";if(e[0]===5)return"Lollipop";if(e[0]===6)return"Marshmallow";if(e[0]===7)return"Nougat";if(e[0]===8)return"Oreo";if(e[0]===9)return"Pie"}}static getVersionPrecision(t){return t.split(".").length}static compareVersions(t,e,r=!1){const n=N.getVersionPrecision(t),i=N.getVersionPrecision(e);let a=Math.max(n,i),o=0;const c=N.map([t,e],u=>{const h=a-N.getVersionPrecision(u),p=u+new Array(h+1).join(".0");return N.map(p.split("."),f=>new Array(20-f.length).join("0")+f).reverse()});for(r&&(o=a-Math.min(n,i)),a-=1;a>=o;){if(c[0][a]>c[1][a])return 1;if(c[0][a]===c[1][a]){if(a===o)return 0;a-=1}else if(c[0][a]<c[1][a])return-1}}static map(t,e){const r=[];let n;if(Array.prototype.map)return Array.prototype.map.call(t,e);for(n=0;n<t.length;n+=1)r.push(e(t[n]));return r}static find(t,e){let r,n;if(Array.prototype.find)return Array.prototype.find.call(t,e);for(r=0,n=t.length;r<n;r+=1){const i=t[r];if(e(i,r))return i}}static assign(t,...e){const r=t;let n,i;if(Object.assign)return Object.assign(t,...e);for(n=0,i=e.length;n<i;n+=1){const a=e[n];typeof a=="object"&&a!==null&&Object.keys(a).forEach(c=>{r[c]=a[c]})}return t}static getBrowserAlias(t){return qC[t]}static getBrowserTypeByAlias(t){return _m[t]||""}}const Ee=/version\/(\d+(\.?_?\d+)+)/i,jC=[{test:[/googlebot/i],describe(s){const t={name:"Googlebot"},e=N.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/opera/i],describe(s){const t={name:"Opera"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/opr\/|opios/i],describe(s){const t={name:"Opera"},e=N.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/SamsungBrowser/i],describe(s){const t={name:"Samsung Internet for Android"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/Whale/i],describe(s){const t={name:"NAVER Whale Browser"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/MZBrowser/i],describe(s){const t={name:"MZ Browser"},e=N.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/focus/i],describe(s){const t={name:"Focus"},e=N.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/swing/i],describe(s){const t={name:"Swing"},e=N.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/coast/i],describe(s){const t={name:"Opera Coast"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe(s){const t={name:"Opera Touch"},e=N.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/yabrowser/i],describe(s){const t={name:"Yandex Browser"},e=N.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/ucbrowser/i],describe(s){const t={name:"UC Browser"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/Maxthon|mxios/i],describe(s){const t={name:"Maxthon"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/epiphany/i],describe(s){const t={name:"Epiphany"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/puffin/i],describe(s){const t={name:"Puffin"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/sleipnir/i],describe(s){const t={name:"Sleipnir"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/k-meleon/i],describe(s){const t={name:"K-Meleon"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/micromessenger/i],describe(s){const t={name:"WeChat"},e=N.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/qqbrowser/i],describe(s){const t={name:/qqbrowserlite/i.test(s)?"QQ Browser Lite":"QQ Browser"},e=N.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/msie|trident/i],describe(s){const t={name:"Internet Explorer"},e=N.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/\sedg\//i],describe(s){const t={name:"Microsoft Edge"},e=N.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/edg([ea]|ios)/i],describe(s){const t={name:"Microsoft Edge"},e=N.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/vivaldi/i],describe(s){const t={name:"Vivaldi"},e=N.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/seamonkey/i],describe(s){const t={name:"SeaMonkey"},e=N.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/sailfish/i],describe(s){const t={name:"Sailfish"},e=N.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,s);return e&&(t.version=e),t}},{test:[/silk/i],describe(s){const t={name:"Amazon Silk"},e=N.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/phantom/i],describe(s){const t={name:"PhantomJS"},e=N.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/slimerjs/i],describe(s){const t={name:"SlimerJS"},e=N.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(s){const t={name:"BlackBerry"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/(web|hpw)[o0]s/i],describe(s){const t={name:"WebOS Browser"},e=N.getFirstMatch(Ee,s)||N.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/bada/i],describe(s){const t={name:"Bada"},e=N.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/tizen/i],describe(s){const t={name:"Tizen"},e=N.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/qupzilla/i],describe(s){const t={name:"QupZilla"},e=N.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/firefox|iceweasel|fxios/i],describe(s){const t={name:"Firefox"},e=N.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/electron/i],describe(s){const t={name:"Electron"},e=N.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/MiuiBrowser/i],describe(s){const t={name:"Miui"},e=N.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/chromium/i],describe(s){const t={name:"Chromium"},e=N.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,s)||N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/chrome|crios|crmo/i],describe(s){const t={name:"Chrome"},e=N.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/GSA/i],describe(s){const t={name:"Google Search"},e=N.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test(s){const t=!s.test(/like android/i),e=s.test(/android/i);return t&&e},describe(s){const t={name:"Android Browser"},e=N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/playstation 4/i],describe(s){const t={name:"PlayStation 4"},e=N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/safari|applewebkit/i],describe(s){const t={name:"Safari"},e=N.getFirstMatch(Ee,s);return e&&(t.version=e),t}},{test:[/.*/i],describe(s){const t=/^(.*)\/(.*) /,e=/^(.*)\/(.*)[ \t]\((.*)/,n=s.search("\\(")!==-1?e:t;return{name:N.getFirstMatch(n,s),version:N.getSecondMatch(n,s)}}}],GC=[{test:[/Roku\/DVP/],describe(s){const t=N.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,s);return{name:Ct.Roku,version:t}}},{test:[/windows phone/i],describe(s){const t=N.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,s);return{name:Ct.WindowsPhone,version:t}}},{test:[/windows /i],describe(s){const t=N.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,s),e=N.getWindowsVersionName(t);return{name:Ct.Windows,version:t,versionName:e}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(s){const t={name:Ct.iOS},e=N.getSecondMatch(/(Version\/)(\d[\d.]+)/,s);return e&&(t.version=e),t}},{test:[/macintosh/i],describe(s){const t=N.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,s).replace(/[_\s]/g,"."),e=N.getMacOSVersionName(t),r={name:Ct.MacOS,version:t};return e&&(r.versionName=e),r}},{test:[/(ipod|iphone|ipad)/i],describe(s){const t=N.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,s).replace(/[_\s]/g,".");return{name:Ct.iOS,version:t}}},{test(s){const t=!s.test(/like android/i),e=s.test(/android/i);return t&&e},describe(s){const t=N.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,s),e=N.getAndroidVersionName(t),r={name:Ct.Android,version:t};return e&&(r.versionName=e),r}},{test:[/(web|hpw)[o0]s/i],describe(s){const t=N.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,s),e={name:Ct.WebOS};return t&&t.length&&(e.version=t),e}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(s){const t=N.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,s)||N.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,s)||N.getFirstMatch(/\bbb(\d+)/i,s);return{name:Ct.BlackBerry,version:t}}},{test:[/bada/i],describe(s){const t=N.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,s);return{name:Ct.Bada,version:t}}},{test:[/tizen/i],describe(s){const t=N.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,s);return{name:Ct.Tizen,version:t}}},{test:[/linux/i],describe(){return{name:Ct.Linux}}},{test:[/CrOS/],describe(){return{name:Ct.ChromeOS}}},{test:[/PlayStation 4/],describe(s){const t=N.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,s);return{name:Ct.PlayStation4,version:t}}}],WC=[{test:[/googlebot/i],describe(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe(s){const t=N.getFirstMatch(/(can-l01)/i,s)&&"Nova",e={type:Ge.mobile,vendor:"Huawei"};return t&&(e.model=t),e}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe(){return{type:Ge.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe(){return{type:Ge.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(){return{type:Ge.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe(){return{type:Ge.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe(){return{type:Ge.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe(){return{type:Ge.tablet}}},{test(s){const t=s.test(/ipod|iphone/i),e=s.test(/like (ipod|iphone)/i);return t&&!e},describe(s){const t=N.getFirstMatch(/(ipod|iphone)/i,s);return{type:Ge.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe(){return{type:Ge.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe(){return{type:Ge.mobile}}},{test(s){return s.getBrowserName(!0)==="blackberry"},describe(){return{type:Ge.mobile,vendor:"BlackBerry"}}},{test(s){return s.getBrowserName(!0)==="bada"},describe(){return{type:Ge.mobile}}},{test(s){return s.getBrowserName()==="windows phone"},describe(){return{type:Ge.mobile,vendor:"Microsoft"}}},{test(s){const t=Number(String(s.getOSVersion()).split(".")[0]);return s.getOSName(!0)==="android"&&t>=3},describe(){return{type:Ge.tablet}}},{test(s){return s.getOSName(!0)==="android"},describe(){return{type:Ge.mobile}}},{test(s){return s.getOSName(!0)==="macos"},describe(){return{type:Ge.desktop,vendor:"Apple"}}},{test(s){return s.getOSName(!0)==="windows"},describe(){return{type:Ge.desktop}}},{test(s){return s.getOSName(!0)==="linux"},describe(){return{type:Ge.desktop}}},{test(s){return s.getOSName(!0)==="playstation 4"},describe(){return{type:Ge.tv}}},{test(s){return s.getOSName(!0)==="roku"},describe(){return{type:Ge.tv}}}],JC=[{test(s){return s.getBrowserName(!0)==="microsoft edge"},describe(s){if(/\sedg\//i.test(s))return{name:us.Blink};const e=N.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,s);return{name:us.EdgeHTML,version:e}}},{test:[/trident/i],describe(s){const t={name:us.Trident},e=N.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test(s){return s.test(/presto/i)},describe(s){const t={name:us.Presto},e=N.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test(s){const t=s.test(/gecko/i),e=s.test(/like gecko/i);return t&&!e},describe(s){const t={name:us.Gecko},e=N.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}},{test:[/(apple)?webkit\/537\.36/i],describe(){return{name:us.Blink}}},{test:[/(apple)?webkit/i],describe(s){const t={name:us.WebKit},e=N.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,s);return e&&(t.version=e),t}}];class Sm{constructor(t,e=!1){if(t==null||t==="")throw new Error("UserAgent parameter can't be empty");this._ua=t,this.parsedResult={},e!==!0&&this.parse()}getUA(){return this._ua}test(t){return t.test(this._ua)}parseBrowser(){this.parsedResult.browser={};const t=N.find(jC,e=>{if(typeof e.test=="function")return e.test(this);if(e.test instanceof Array)return e.test.some(r=>this.test(r));throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.browser=t.describe(this.getUA())),this.parsedResult.browser}getBrowser(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()}getBrowserName(t){return t?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""}getBrowserVersion(){return this.getBrowser().version}getOS(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()}parseOS(){this.parsedResult.os={};const t=N.find(GC,e=>{if(typeof e.test=="function")return e.test(this);if(e.test instanceof Array)return e.test.some(r=>this.test(r));throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.os=t.describe(this.getUA())),this.parsedResult.os}getOSName(t){const{name:e}=this.getOS();return t?String(e).toLowerCase()||"":e||""}getOSVersion(){return this.getOS().version}getPlatform(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()}getPlatformType(t=!1){const{type:e}=this.getPlatform();return t?String(e).toLowerCase()||"":e||""}parsePlatform(){this.parsedResult.platform={};const t=N.find(WC,e=>{if(typeof e.test=="function")return e.test(this);if(e.test instanceof Array)return e.test.some(r=>this.test(r));throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.platform=t.describe(this.getUA())),this.parsedResult.platform}getEngine(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()}getEngineName(t){return t?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""}parseEngine(){this.parsedResult.engine={};const t=N.find(JC,e=>{if(typeof e.test=="function")return e.test(this);if(e.test instanceof Array)return e.test.some(r=>this.test(r));throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.engine=t.describe(this.getUA())),this.parsedResult.engine}parse(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this}getResult(){return N.assign({},this.parsedResult)}satisfies(t){const e={};let r=0;const n={};let i=0;if(Object.keys(t).forEach(o=>{const c=t[o];typeof c=="string"?(n[o]=c,i+=1):typeof c=="object"&&(e[o]=c,r+=1)}),r>0){const o=Object.keys(e),c=N.find(o,h=>this.isOS(h));if(c){const h=this.satisfies(e[c]);if(h!==void 0)return h}const u=N.find(o,h=>this.isPlatform(h));if(u){const h=this.satisfies(e[u]);if(h!==void 0)return h}}if(i>0){const o=Object.keys(n),c=N.find(o,u=>this.isBrowser(u,!0));if(c!==void 0)return this.compareVersion(n[c])}}isBrowser(t,e=!1){const r=this.getBrowserName().toLowerCase();let n=t.toLowerCase();const i=N.getBrowserTypeByAlias(n);return e&&i&&(n=i.toLowerCase()),n===r}compareVersion(t){let e=[0],r=t,n=!1;const i=this.getBrowserVersion();if(typeof i=="string")return t[0]===">"||t[0]==="<"?(r=t.substr(1),t[1]==="="?(n=!0,r=t.substr(2)):e=[],t[0]===">"?e.push(1):e.push(-1)):t[0]==="="?r=t.substr(1):t[0]==="~"&&(n=!0,r=t.substr(1)),e.indexOf(N.compareVersions(i,r,n))>-1}isOS(t){return this.getOSName(!0)===String(t).toLowerCase()}isPlatform(t){return this.getPlatformType(!0)===String(t).toLowerCase()}isEngine(t){return this.getEngineName(!0)===String(t).toLowerCase()}is(t,e=!1){return this.isBrowser(t,e)||this.isOS(t)||this.isPlatform(t)}some(t=[]){return t.some(e=>this.is(e))}}/*!
 * Bowser - a browser detector
 * https://github.com/lancedikson/bowser
 * MIT License | (c) Dustin Diaz 2012-2015
 * MIT License | (c) Denis Demchenko 2015-2019
 */class Em{static getParser(t,e=!1){if(typeof t!="string")throw new Error("UserAgent should be a string");return new Sm(t,e)}static parse(t){return new Sm(t).getResult()}static get BROWSER_MAP(){return _m}static get ENGINE_MAP(){return us}static get OS_MAP(){return Ct}static get PLATFORMS_MAP(){return Ge}}const ua="chrome",wm="opera",Cm="firefox",bm="iexplorer",Pm="safari",Rm="nwjs",km="electron",Im="react-native",Il="unknown",uc={Chrome:ua,Chromium:ua,Opera:wm,Firefox:Cm,"Internet Explorer":bm,Safari:Pm};function KC(){const{userAgent:s}=navigator,t={name:Il,version:void 0};if(s.match(/Chrome/)&&!s.match(/Edge/))if(s.match(/Edg(A?)/)){const e=s.match(/Chrome\/([\d.]+)/)[1];Number.parseInt(e,10)>72&&(t.name=ua,t.version=e)}else t.name=ua,t.version=s.match(/Chrome\/([\d.]+)/)[1];return t}function zC(){const{userAgent:s}=navigator;if(s.match(/Electron/)){const t=s.match(/Electron\/([\d.]+)/)[1];return{name:km,version:t}}return null}function YC(){const{userAgent:s}=navigator;if(s.match(/JitsiMeetNW/)){const t=s.match(/JitsiMeetNW\/([\d.]+)/)[1];return{name:Rm,version:t}}}function QC(){const s=navigator.userAgent.match(/\b(react[ \t_-]*native)(?:\/(\S+))?/i);let t;if(s||navigator.product==="ReactNative")return s&&s.length>2&&(s[1],t=s[2]),t||(t="unknown"),{name:Im,version:t}}function XC(s){let t;const e=[QC,zC,YC];for(let n=0;n<e.length;n+=1)if(t=e[n](),t)return t;const r=s.getBrowserName();return r in uc?{name:uc[r],version:s.getBrowserVersion()}:(t=KC(),t||{name:Il,version:void 0})}class ZC{constructor(){m(this,"_bowser");m(this,"_name");m(this,"_version");m(this,"getDeviceInfo",()=>({isMobile:this.isMobile(),browserName:this._bowser.getBrowserName(),osName:this._bowser.getOSName(),browserVersion:this._bowser.getBrowserVersion(),osVersionName:this._bowser.getOSVersion(),engineName:this._bowser.getEngineName()}))}init(t){let e,r;if(this._bowser=Em.getParser(navigator.userAgent),typeof t=="undefined"){const n=XC(this._bowser);e=n.name,r=n.version}else t.name in uc?(e=uc[t.name],r=t.version):(e=Il,r=void 0);this._name=e,this._version=r}getName(){return this._name}isChrome(){return this._name===ua}isOpera(){return this._name===wm}isFirefox(){return this._name===Cm}isIExplorer(){return this._name===bm}isSafari(){return this._name===Pm}isNWJS(){return this._name===Rm}isElectron(){return this._name===km}isReactNative(){return this._name===Im||navigator.isReactNative===!0}getVersion(){return this._version}isMobile(){return this._bowser.getPlatformType()==="mobile"}_checkCondition(t){if(this._version)return this._bowser.satisfies(t)}isVersionGreaterThan(t){return this._checkCondition({[this._name]:`>${t}`})}isVersionLessThan(t){return this._checkCondition({[this._name]:`<${t}`})}isVersionEqualTo(t){return this._checkCondition({[this._name]:`~${t}`})}}class eb extends ZC{doesVideoMuteByStreamRemove(){return this.isChromiumBased()||this.isWebKitBased()}supportsP2P(){return!this.usesUnifiedPlan()}isChromiumBased(){return this.isChrome()||this.isElectron()||this.isNWJS()||this.isOpera()}isWebKitBased(){return this._bowser.isEngine("webkit")&&typeof navigator.mediaDevices!="undefined"&&typeof navigator.mediaDevices.getUserMedia!="undefined"&&typeof window.RTCRtpTransceiver!="undefined"&&Object.keys(RTCRtpTransceiver.prototype).indexOf("currentDirection")>-1}isSupported(){return typeof RTCPeerConnection!="undefined"}isUserInteractionRequiredForUnmute(){return this.isFirefox()&&this.isVersionLessThan("68")}supportsVideoMuteOnConnInterrupted(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}supportsBandwidthStatistics(){return!this.isFirefox()&&!this.isWebKitBased()}supportsCodecPreferences(){return this.usesUnifiedPlan()&&typeof window.RTCRtpTransceiver!="undefined"&&Object.keys(window.RTCRtpTransceiver.prototype).indexOf("setCodecPreferences")>-1&&Object.keys(RTCRtpSender.prototype).indexOf("getCapabilities")>-1&&!this.isWebKitBased()}supportsDeviceChangeEvent(){return navigator.mediaDevices&&typeof navigator.mediaDevices.ondevicechange!="undefined"&&typeof navigator.mediaDevices.addEventListener!="undefined"}supportsLocalCandidateRttStatistics(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}supportsPerformanceObserver(){return typeof window.PerformanceObserver!="undefined"&&PerformanceObserver.supportedEntryTypes.indexOf("longtask")>-1}supportsReceiverStats(){return typeof window.RTCRtpReceiver!="undefined"&&Object.keys(RTCRtpReceiver.prototype).indexOf("getSynchronizationSources")>-1}supportsRTTStatistics(){return!this.isFirefox()}usesPlanB(){return!this.usesUnifiedPlan()}usesSdpMungingForSimulcast(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}usesUnifiedPlan(){return!!(this.isFirefox()||this.isWebKitBased())}usesNewGumFlow(){return!!(this.isChromiumBased()||this.isFirefox()||this.isWebKitBased())}usesAdapter(){return this.usesNewGumFlow()}usesRidsForSimulcast(){return!1}supportsGetDisplayMedia(){return typeof navigator.getDisplayMedia!="undefined"||typeof navigator.mediaDevices!="undefined"&&typeof navigator.mediaDevices.getDisplayMedia!="undefined"}supportsInsertableStreams(){if(!(typeof window.RTCRtpSender!="undefined"&&(window.RTCRtpSender.prototype.createEncodedStreams||window.RTCRtpSender.prototype.createEncodedVideoStreams)))return!1;const t=new ReadableStream;try{return window.postMessage(t,"*",[t]),!0}catch(e){return!1}}supportsAudioRed(){return Boolean(window.RTCRtpSender&&window.RTCRtpSender.getCapabilities&&window.RTCRtpSender.getCapabilities("audio").codecs.some(t=>t.mimeType==="audio/red")&&window.RTCRtpReceiver&&window.RTCRtpReceiver.getCapabilities&&window.RTCRtpReceiver.getCapabilities("audio").codecs.some(t=>t.mimeType==="audio/red"))}supportsSdpSemantics(){return this.isChromiumBased()}_getChromiumBasedVersion(){if(this.isChromiumBased()){if(this.isNWJS())return Number.parseInt(process.versions.chromium,10);const t=navigator.userAgent;if(t.match(/Chrome/))return Number.parseInt(t.match(/Chrome\/([\d.]+)/)[1],10)}return-1}isIOSMobile(){return this.isMobile&&this._bowser.getOSName()==="iOS"}}const we=new eb,Am={audio:!0,video:!0,screenshareAudio:!0,screenshareVideo:!0},ha={baseURL:"http://localhost:5000",createdAt:"2021-08-05T10:49:56.602Z",description:"Develop plugins locally",id:"09259e3b-7be8-46f6-9801-106bf1866e1c",name:"Localhost Dev",organizationId:"4ad15a19-80e2-4105-bf43-48039fd2963e",picture:"https://dyte-uploads.s3.ap-south-1.amazonaws.com/dyte.png",private:!1,published:!0,staggered:!1,tags:["#localhost","#dev"],type:"self_hosted",updatedAt:"2021-08-05T10:50:07.681Z"},tb={pip:!0,poll:!0,chat:!0,stage:!0,theme:!0,plugin:!0,tracing:!0,internals:!0,recording:!0,livestream:!0,participant:!0,devTools:{logs:!1}};function Al(s,t){const e=s.getValue("overrides");return e&&e[t]?e[t]:!1}function rb({baseURI:s}){return s!=null&&s.includes("preprod.dyte")?ta.PREPROD:s!=null&&s.includes("devel.dyte")?ta.DEVEL:ta.PROD}function zn({servicePrefix:s,baseURI:t}){return`${s}.${t}`}function Mm(s){const t=s.getValue("baseURI");return{location:zn({servicePrefix:"location",baseURI:t}),locationLegacy:zn({servicePrefix:"location-legacy",baseURI:t}),daCollector:zn({servicePrefix:"da-collector",baseURI:t})}}const sb='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m16.242 2.932 4.826 4.826a2.75 2.75 0 0 1-.715 4.404l-4.87 2.435a.75.75 0 0 0-.374.426l-1.44 4.166a1.25 1.25 0 0 1-2.065.476L8.5 16.561 4.06 21H3v-1.06l4.44-4.44-3.105-3.104a1.25 1.25 0 0 1 .476-2.066l4.166-1.44a.75.75 0 0 0 .426-.373l2.435-4.87a2.75 2.75 0 0 1 4.405-.715Zm3.766 5.886-4.826-4.826a1.25 1.25 0 0 0-2.002.325l-2.435 4.871a2.25 2.25 0 0 1-1.278 1.12l-3.789 1.31 6.705 6.704 1.308-3.789a2.25 2.25 0 0 1 1.12-1.277l4.872-2.436a1.25 1.25 0 0 0 .325-2.002Z" fill="currentColor"/></svg>',nb='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M4 12.02c0 1.06.2 2.1.6 3.08l.6 1.42c.22.55.64 1.01 1.17 1.29.27.14.56.21.86.21h2.55c.77 0 1.49-.41 1.87-1.08.5-.87 1.02-1.7 1.72-2.43l1.32-1.39c.44-.46.97-.84 1.49-1.23l.59-.45a.6.6 0 0 0 .23-.47c0-.75-.54-1.57-1.22-1.79a3.34 3.34 0 0 0-2.78.29V4.5a1.5 1.5 0 0 0-2.05-1.4 1.5 1.5 0 0 0-2.9 0A1.5 1.5 0 0 0 6 4.5v.09A1.5 1.5 0 0 0 4 6v6.02ZM8 4.5v4a.5.5 0 0 0 1 0v-5a.5.5 0 0 1 1 0v5a.5.5 0 0 0 1 0v-4a.5.5 0 0 1 1 0v6a.5.5 0 0 0 .85.37h.01c.22-.22.44-.44.72-.58.7-.35 2.22-.57 2.4.5l-.53.4c-.52.4-1.04.78-1.48 1.24l-1.33 1.38c-.75.79-1.31 1.7-1.85 2.63-.21.36-.6.58-1.01.58H7.23a.87.87 0 0 1-.4-.1 1.55 1.55 0 0 1-.71-.78l-.59-1.42a7.09 7.09 0 0 1-.53-2.7V6a.5.5 0 0 1 1 0v3.5a.5.5 0 0 0 1 0v-5a.5.5 0 0 1 1 0Z" fill="currentColor"></path></svg>',hc=s=>{const t=s.startsWith("<svg"),e=new Image;if(!t)return new Promise(i=>{i(s)});const r=new Blob([s],{type:"image/svg+xml"}),n=window.URL.createObjectURL(r);return new Promise((i,a)=>{e.onload=()=>{i(e),window.URL.revokeObjectURL(n)},e.onerror=()=>{a(),window.URL.revokeObjectURL(n)},e.src=n})};function ib(s){const t={...s},e=new Map,r=(u,h)=>(e.has(u)||e.set(u,new Set),e.get(u).add(h),()=>{var p;return(p=e.get(u))==null?void 0:p.delete(h)}),n=(u,h)=>{var p;(p=e.get(u))==null||p.delete(h)},i=u=>{var h;(h=e.get(u))==null||h.forEach(p=>{try{p(t[u])}catch(f){l.error(`Error in notifying for "${u.toString()}"`,f)}})};return{subscribe:r,unsubscribe:n,notify:i,setValue:(u,h,p=!0)=>{t[u]=h,p&&i(u)},getValue:u=>t[u],getAllValues:()=>t}}class ab{constructor(){m(this,"contexts",new Map)}createContext(t,e){return this.contexts.has(t)?this.contexts.get(t):(this.contexts.set(t,ib(e)),this.contexts.get(t))}remapContext(t,e){const r=e.getValue("peerId");r!==t&&(e.setValue("peerId",t),this.contexts.set(t,e),this.contexts.delete(r))}getContext(t){return this.contexts.get(t)}}const pa=new ab,he=class{static get logsEndpoint(){const t=pa.getContext(he.meetingMetadata.peerId);return`https://${zn({servicePrefix:"api-silos",baseURI:t.getValue("baseURI")})}/otel/logs`}static resetPeerId(t){he.meetingMetadata.peerId=t}static init(t,e){const r=t.getValue("peerId");he.tracingEnabled=e,he.meetingMetadata.peerId=r,he.meetingMetadata.sdkVersion=t.getValue("sdkVersion"),he.meetingMetadata.deviceInfo=we.getDeviceInfo(),he.meetingMetadata.visitedUrl=!navigator.isReactNative&&typeof window!="undefined"&&window.location.href,navigator.isReactNative||document.addEventListener("visibilitychange",he.processCachedLogs),he.logsProcessorTimer=setInterval(he.processCachedLogs,he.logsProcessingInterval),e&&(he.initialized=!0)}static trace(t){return(e,r,n)=>{const i=n.value;return n.value=function(...o){if(!he.initialized||navigator.isReactNative||!he.tracingEnabled||j.hasFeature(J.SKIP_OTEL_TRACES))return i.apply(this,o);he.addLogInCurrentSpan("info",t);const c=performance.now(),u=i.apply(this,o);return Promise.resolve(u).then(()=>{const h=performance.now();h-c>10&&he.addLogInCurrentSpan("info",`${t}_timing`,{execTime:h-c,country:he.location.country})}).catch(()=>{const h=performance.now();he.addLogInCurrentSpan("info",`${t}_timing`,{execTime:h-c})}),u},n}}static injectContext(t){var n;const e=Ys().replace(/-/g,"").substring(0,16),r=(n=he.meetingMetadata.peerId)==null?void 0:n.replace(/-/g,"");t.TRACEPARENT=`00-${r}-${e}-01`}static addLogInCurrentSpan(t,e,r={},n=!1){r!=null&&r.error&&Object.assign(r,{error:lc(r.error)});const i=pa.getContext(he.meetingMetadata.peerId);if(vm(i)&&($C(r)?console[t]("DyteInternalLogs:: ",t,e):console[t]("DyteInternalLogs:: ",t,e,r)),!!HC(t))try{const o=Tm(i,e,r,"metadata"),c=new Date,u={message:e,level:t,...o,loggedAt:c.toISOString(),loggedAtTzOffset:c.getTimezoneOffset()};n?he.sendOtelLogsToNewRelic([u]):he.logsCache.push(u)}catch(o){he.addLogInCurrentSpan("error","opentelemetry::addLogInCurrentSpan_failed",{error:lc(o)})}}static sendOtelLogsToNewRelic(t){const e=pa.getContext(he.meetingMetadata.peerId);Zo.post(he.logsEndpoint,{meetingMetadata:Tm(e,"sendOtelLogsToNewRelic",he.meetingMetadata,"meetingMetadata"),serviceName:e.getValue("sdkName"),logs:t}).catch(r=>{he.addLogInCurrentSpan("error","opentelemetry::sendOtelLogToNewRelic_failed",{error:lc(r)}),he.logsCache.push(...t)})}static processCachedLogs(){const t=he.logsCache.splice(0,25);t!=null&&t.length&&he.sendOtelLogsToNewRelic(t)}static destruct(){clearInterval(he.logsProcessorTimer),he.processCachedLogs(),navigator.isReactNative||document.removeEventListener("visibilitychange",he.processCachedLogs)}};let g=he;m(g,"logsCache",[]),m(g,"logsProcessorTimer"),m(g,"location",{country:void 0}),m(g,"tracingEnabled",!0),m(g,"initialized",!1),m(g,"logsProcessingInterval",7e3),m(g,"logExclusionList",["message","websocket/message","roomMessage","websocket/room-message","websocket/room-legacy-mode","chatMessage","websocket/new-chat-message","websocket/no-active-speaker","websocket/selected-peers","websocket/active-speaker","ping","websocket/new-consumer","websocket/producer-score","websocket/consumer-score","websocket/plugin-event","websocket/plugin-data","websocket/plugin-internal-data"]),m(g,"meetingMetadata",{});class l{static info(t,e,r){g.addLogInCurrentSpan("info",t,e,r)}static error(t,e,r){g.addLogInCurrentSpan("error",t,e,r)}static debug(t,e,r){g.addLogInCurrentSpan("debug",t,e,r)}static log(t,e,r){g.addLogInCurrentSpan("log",t,e,r)}static warn(t,e,r){g.addLogInCurrentSpan("warn",t,e,r)}}const ob=()=>{!navigator.isReactNative&&typeof window!="undefined"&&(window.addEventListener("error",s=>{var t;!((t=s.filename)!=null&&t.includes("localhost"))&&s.lineno!==0&&l.error("window::error",{error:s.error},!0)}),window.addEventListener("unhandledrejection",s=>{var t,e,r,n,i,a,o,c;l.error("window::unhandledrejection",{error:s==null?void 0:s.reason,networkCall:{url:(e=(t=s==null?void 0:s.reason)==null?void 0:t.config)==null?void 0:e.url,baseURL:(n=(r=s==null?void 0:s.reason)==null?void 0:r.config)==null?void 0:n.baseURL,method:(a=(i=s==null?void 0:s.reason)==null?void 0:i.config)==null?void 0:a.method,status:(o=s==null?void 0:s.reason)==null?void 0:o.status,statusText:(c=s==null?void 0:s.reason)==null?void 0:c.statusText}},!0)}),window.addEventListener("offline",()=>{l.info("window::offline")}),window.addEventListener("online",()=>{l.info("window::online")}))},cb={"00":"DyteClient","01":"Controller","02":"RoomNodeClient","03":"HiveNodeClient","04":"SocketService","05":"Chat","06":"Plugin","07":"Polls","08":"Meta","09":"Preset",10:"Recording",11:"Self",12:"Participant",13:"Spotlight",14:"Remote Request",15:"Webinar",16:"LocalMediaHandler",17:"End-End Encryption"},pc={"0000":"Internal exception.","0001":"Failed to initialize.","0002":"Failed to join room.","0003":"Failed to leave room.","0010":"Browser not supported","0011":"HTTP Network Error","0012":"Websocket Network Error","0100":"Internal exception","0200":"Internal exception.","0300":"Internal exception","0400":"Internal exception","0500":"Internal exception","0501":"Permission denied.","0502":"Invalid message body.","0510":"Invalid channel name.","0600":"Internal exception","0700":"Internal exception","0800":"Internal exception","0900":"Internal exception",1e3:"Internal exception",1100:"Internal exception",1200:"Internal exception",1300:"Internal exception",1400:"Internal exception",1500:"Internal exception",1600:"Internal exception",1601:"Failed to get audio track",1602:"Failed to get video track",1603:"Incorrect device",1604:"Failed to change device",1701:"Crypto error",9900:"Internal exception"};Object.keys(pc).forEach(s=>{pc[s]=`{${cb[s.slice(0,2)]}} ${pc[s]}`});class b extends Error{constructor(e,r,n=!1){super(e);m(this,"code");this.code=r,this.name="DyteError",this.message=`[ERR${this.code}]: ${pc[this.code]}
${this.message}`;try{let i=n;r&&r.endsWith("00")&&(i=!0),i&&l.error("DyteError",{error:{message:this.message,name:this.name,code:r}})}catch(i){}}}function mc(s,t,e,r){if(r instanceof b)throw r;if(r instanceof t){const n=new b(r.message,e);throw n.stack=r.stack,n}else throw r}function Dm(s,t,e){if(!s.value){const n=s.get,i=s.set;return n&&(s.get=function(){try{return n.apply(this)}catch(a){mc(this,t,e,a)}}),i&&(s.set=function(a){try{return i.apply(this,[a])}catch(o){mc(this,t,e,o)}}),s}const r=s.value;return s.value=function(...n){try{const i=r.apply(this,n);return i&&i instanceof Promise?i.catch(a=>{mc(this,t,e,a)}):i}catch(i){mc(this,t,e,i)}},s}function db(s,t){return(e,r,n)=>{if(n)return Dm(n,s,t);for(const i of Reflect.ownKeys(e.prototype).filter(a=>a!=="constructor")){const a=Object.getOwnPropertyDescriptor(e.prototype,i);(a.value instanceof Function||a.get instanceof Function||a.set instanceof Function)&&Object.defineProperty(e.prototype,i,Dm(a,s,t))}}}const mt=s=>db(Error,s);function lb(s){let t=0,e,r;if(!s)return t;for(e=0;e<s.length;e+=1)r=s.charCodeAt(e),t=(t<<5)-t+r,t|=0;return Math.abs(t)%100+1}class ub extends ce.EventEmitter{constructor(){super();S(this,Jr,void 0);S(this,Kr,void 0);m(this,"asyncPromiseTimeout");T(this,Jr,new Map),T(this,Kr,new Map),this.asyncPromiseTimeout=8e3}async emitAsync(e,...r){d(this,Jr).set(e,[]);const n=d(this,Kr).get(e).map(()=>new Promise(i=>{d(this,Jr).get(e).push(i)}));super.emit(e,...r),await Promise.race([Promise.all(n),new Promise((i,a)=>setTimeout(()=>a(new Error(`emitAsync failed to resolve for event ${e}.`)),this.asyncPromiseTimeout))]),d(this,Jr).delete(e)}onAsync(e,r){const n=d(this,Jr),i=async(...a)=>{var c;try{await r(...a)}catch(u){l.error("[onAsync]",{error:u})}const o=(c=n.get(e))==null?void 0:c.shift();o==null||o()};return d(this,Kr).get(e)||d(this,Kr).set(e,[]),d(this,Kr).get(e).push(i),super.on(e,i)}reset(){T(this,Jr,new Map),T(this,Kr,new Map),super.removeAllListeners()}}Jr=new WeakMap,Kr=new WeakMap;const w=new ub;function hb(){we.isElectron()&&window.dyteElectronGetDisplayMediaSource&&(navigator.mediaDevices.getDisplayMedia=async()=>{const s=await window.dyteElectronGetDisplayMediaSource({types:["window","screen"]});let t=[];if(s&&(Array.isArray(s)?t=s:t=[s]),!(t!=null&&t.length))throw new Error("Couldn't find any media source for screen share.");let e=t.find(i=>{var a;return(a=i.id)==null?void 0:a.includes("screen")});e=e!=null?e:t[0];const r={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e.id}}};return await navigator.mediaDevices.getUserMedia(r)})}function Ml(s){let t=typeof s;if(t=="object"){if(Array.isArray(s))return"array";if(s===null)return"null"}return t}function pb(s){return s!==null&&typeof s=="object"&&!Array.isArray(s)}let xr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),fc=[];for(let s=0;s<xr.length;s++)fc[xr[s].charCodeAt(0)]=s;fc["-".charCodeAt(0)]=xr.indexOf("+"),fc["_".charCodeAt(0)]=xr.indexOf("/");function mb(s){let t=s.length*3/4;s[s.length-2]=="="?t-=2:s[s.length-1]=="="&&(t-=1);let e=new Uint8Array(t),r=0,n=0,i,a=0;for(let o=0;o<s.length;o++){if(i=fc[s.charCodeAt(o)],i===void 0)switch(s[o]){case"=":n=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(n){case 0:a=i,n=1;break;case 1:e[r++]=a<<2|(i&48)>>4,a=i,n=2;break;case 2:e[r++]=(a&15)<<4|(i&60)>>2,a=i,n=3;break;case 3:e[r++]=(a&3)<<6|i,n=0;break}}if(n==1)throw Error("invalid base64 string.");return e.subarray(0,r)}function fb(s){let t="",e=0,r,n=0;for(let i=0;i<s.length;i++)switch(r=s[i],e){case 0:t+=xr[r>>2],n=(r&3)<<4,e=1;break;case 1:t+=xr[n|r>>4],n=(r&15)<<2,e=2;break;case 2:t+=xr[n|r>>6],t+=xr[r&63],e=0;break}return e&&(t+=xr[n],t+="=",e==1&&(t+="=")),t}var gc;(function(s){s.symbol=Symbol.for("protobuf-ts/unknown"),s.onRead=(e,r,n,i,a)=>{(t(r)?r[s.symbol]:r[s.symbol]=[]).push({no:n,wireType:i,data:a})},s.onWrite=(e,r,n)=>{for(let{no:i,wireType:a,data:o}of s.list(r))n.tag(i,a).raw(o)},s.list=(e,r)=>{if(t(e)){let n=e[s.symbol];return r?n.filter(i=>i.no==r):n}return[]},s.last=(e,r)=>s.list(e,r).slice(-1)[0];const t=e=>e&&Array.isArray(e[s.symbol])})(gc||(gc={}));var We;(function(s){s[s.Varint=0]="Varint",s[s.Bit64=1]="Bit64",s[s.LengthDelimited=2]="LengthDelimited",s[s.StartGroup=3]="StartGroup",s[s.EndGroup=4]="EndGroup",s[s.Bit32=5]="Bit32"})(We||(We={}));function gb(){let s=0,t=0;for(let r=0;r<28;r+=7){let n=this.buf[this.pos++];if(s|=(n&127)<<r,!(n&128))return this.assertBounds(),[s,t]}let e=this.buf[this.pos++];if(s|=(e&15)<<28,t=(e&112)>>4,!(e&128))return this.assertBounds(),[s,t];for(let r=3;r<=31;r+=7){let n=this.buf[this.pos++];if(t|=(n&127)<<r,!(n&128))return this.assertBounds(),[s,t]}throw new Error("invalid varint")}function Dl(s,t,e){for(let i=0;i<28;i=i+7){const a=s>>>i,o=!(!(a>>>7)&&t==0),c=(o?a|128:a)&255;if(e.push(c),!o)return}const r=s>>>28&15|(t&7)<<4,n=!!(t>>3);if(e.push((n?r|128:r)&255),!!n){for(let i=3;i<31;i=i+7){const a=t>>>i,o=!!(a>>>7),c=(o?a|128:a)&255;if(e.push(c),!o)return}e.push(t>>>31&1)}}const vc=(1<<16)*(1<<16);function Om(s){let t=s[0]=="-";t&&(s=s.slice(1));const e=1e6;let r=0,n=0;function i(a,o){const c=Number(s.slice(a,o));n*=e,r=r*e+c,r>=vc&&(n=n+(r/vc|0),r=r%vc)}return i(-24,-18),i(-18,-12),i(-12,-6),i(-6),[t,r,n]}function Ol(s,t){if(t>>>0<=2097151)return""+(vc*t+(s>>>0));let e=s&16777215,r=(s>>>24|t<<8)>>>0&16777215,n=t>>16&65535,i=e+r*6777216+n*6710656,a=r+n*8147497,o=n*2,c=1e7;i>=c&&(a+=Math.floor(i/c),i%=c),a>=c&&(o+=Math.floor(a/c),a%=c);function u(h,p){let f=h?String(h):"";return p?"0000000".slice(f.length)+f:f}return u(o,0)+u(a,o)+u(i,1)}function Nm(s,t){if(s>=0){for(;s>127;)t.push(s&127|128),s=s>>>7;t.push(s)}else{for(let e=0;e<9;e++)t.push(s&127|128),s=s>>7;t.push(1)}}function vb(){let s=this.buf[this.pos++],t=s&127;if(!(s&128))return this.assertBounds(),t;if(s=this.buf[this.pos++],t|=(s&127)<<7,!(s&128))return this.assertBounds(),t;if(s=this.buf[this.pos++],t|=(s&127)<<14,!(s&128))return this.assertBounds(),t;if(s=this.buf[this.pos++],t|=(s&127)<<21,!(s&128))return this.assertBounds(),t;s=this.buf[this.pos++],t|=(s&15)<<28;for(let e=5;s&128&&e<10;e++)s=this.buf[this.pos++];if(s&128)throw new Error("invalid varint");return this.assertBounds(),t>>>0}let Ce;function yb(){const s=new DataView(new ArrayBuffer(8));Ce=globalThis.BigInt!==void 0&&typeof s.getBigInt64=="function"&&typeof s.getBigUint64=="function"&&typeof s.setBigInt64=="function"&&typeof s.setBigUint64=="function"?{MIN:BigInt("-9223372036854775808"),MAX:BigInt("9223372036854775807"),UMIN:BigInt("0"),UMAX:BigInt("18446744073709551615"),C:BigInt,V:s}:void 0}yb();function Lm(s){if(!s)throw new Error("BigInt unavailable, see https://github.com/timostamm/protobuf-ts/blob/v1.0.8/MANUAL.md#bigint-support")}const Fm=/^-?[0-9]+$/,yc=4294967296,Tc=2147483648;class xm{constructor(t,e){this.lo=t|0,this.hi=e|0}isZero(){return this.lo==0&&this.hi==0}toNumber(){let t=this.hi*yc+(this.lo>>>0);if(!Number.isSafeInteger(t))throw new Error("cannot convert to safe number");return t}}class ft extends xm{static from(t){if(Ce)switch(typeof t){case"string":if(t=="0")return this.ZERO;if(t=="")throw new Error("string is no integer");t=Ce.C(t);case"number":if(t===0)return this.ZERO;t=Ce.C(t);case"bigint":if(!t)return this.ZERO;if(t<Ce.UMIN)throw new Error("signed value for ulong");if(t>Ce.UMAX)throw new Error("ulong too large");return Ce.V.setBigUint64(0,t,!0),new ft(Ce.V.getInt32(0,!0),Ce.V.getInt32(4,!0))}else switch(typeof t){case"string":if(t=="0")return this.ZERO;if(t=t.trim(),!Fm.test(t))throw new Error("string is no integer");let[e,r,n]=Om(t);if(e)throw new Error("signed value for ulong");return new ft(r,n);case"number":if(t==0)return this.ZERO;if(!Number.isSafeInteger(t))throw new Error("number is no integer");if(t<0)throw new Error("signed value for ulong");return new ft(t,t/yc)}throw new Error("unknown value "+typeof t)}toString(){return Ce?this.toBigInt().toString():Ol(this.lo,this.hi)}toBigInt(){return Lm(Ce),Ce.V.setInt32(0,this.lo,!0),Ce.V.setInt32(4,this.hi,!0),Ce.V.getBigUint64(0,!0)}}ft.ZERO=new ft(0,0);class ke extends xm{static from(t){if(Ce)switch(typeof t){case"string":if(t=="0")return this.ZERO;if(t=="")throw new Error("string is no integer");t=Ce.C(t);case"number":if(t===0)return this.ZERO;t=Ce.C(t);case"bigint":if(!t)return this.ZERO;if(t<Ce.MIN)throw new Error("signed long too small");if(t>Ce.MAX)throw new Error("signed long too large");return Ce.V.setBigInt64(0,t,!0),new ke(Ce.V.getInt32(0,!0),Ce.V.getInt32(4,!0))}else switch(typeof t){case"string":if(t=="0")return this.ZERO;if(t=t.trim(),!Fm.test(t))throw new Error("string is no integer");let[e,r,n]=Om(t);if(e){if(n>Tc||n==Tc&&r!=0)throw new Error("signed long too small")}else if(n>=Tc)throw new Error("signed long too large");let i=new ke(r,n);return e?i.negate():i;case"number":if(t==0)return this.ZERO;if(!Number.isSafeInteger(t))throw new Error("number is no integer");return t>0?new ke(t,t/yc):new ke(-t,-t/yc).negate()}throw new Error("unknown value "+typeof t)}isNegative(){return(this.hi&Tc)!==0}negate(){let t=~this.hi,e=this.lo;return e?e=~e+1:t+=1,new ke(e,t)}toString(){if(Ce)return this.toBigInt().toString();if(this.isNegative()){let t=this.negate();return"-"+Ol(t.lo,t.hi)}return Ol(this.lo,this.hi)}toBigInt(){return Lm(Ce),Ce.V.setInt32(0,this.lo,!0),Ce.V.setInt32(4,this.hi,!0),Ce.V.getBigInt64(0,!0)}}ke.ZERO=new ke(0,0);const Um={readUnknownField:!0,readerFactory:s=>new _b(s)};function Tb(s){return s?Object.assign(Object.assign({},Um),s):Um}class _b{constructor(t,e){this.varint64=gb,this.uint32=vb,this.buf=t,this.len=t.length,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.textDecoder=e!=null?e:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0})}tag(){let t=this.uint32(),e=t>>>3,r=t&7;if(e<=0||r<0||r>5)throw new Error("illegal tag: field no "+e+" wire type "+r);return[e,r]}skip(t){let e=this.pos;switch(t){case We.Varint:for(;this.buf[this.pos++]&128;);break;case We.Bit64:this.pos+=4;case We.Bit32:this.pos+=4;break;case We.LengthDelimited:let r=this.uint32();this.pos+=r;break;case We.StartGroup:let n;for(;(n=this.tag()[1])!==We.EndGroup;)this.skip(n);break;default:throw new Error("cant skip wire type "+t)}return this.assertBounds(),this.buf.subarray(e,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let t=this.uint32();return t>>>1^-(t&1)}int64(){return new ke(...this.varint64())}uint64(){return new ft(...this.varint64())}sint64(){let[t,e]=this.varint64(),r=-(t&1);return t=(t>>>1|(e&1)<<31)^r,e=e>>>1^r,new ke(t,e)}bool(){let[t,e]=this.varint64();return t!==0||e!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return new ft(this.sfixed32(),this.sfixed32())}sfixed64(){return new ke(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let t=this.uint32(),e=this.pos;return this.pos+=t,this.assertBounds(),this.buf.subarray(e,e+t)}string(){return this.textDecoder.decode(this.bytes())}}function ge(s,t){if(!s)throw new Error(t)}const Sb=34028234663852886e22,Eb=-34028234663852886e22,wb=4294967295,Cb=2147483647,bb=-2147483648;function ma(s){if(typeof s!="number")throw new Error("invalid int 32: "+typeof s);if(!Number.isInteger(s)||s>Cb||s<bb)throw new Error("invalid int 32: "+s)}function _c(s){if(typeof s!="number")throw new Error("invalid uint 32: "+typeof s);if(!Number.isInteger(s)||s>wb||s<0)throw new Error("invalid uint 32: "+s)}function Nl(s){if(typeof s!="number")throw new Error("invalid float 32: "+typeof s);if(Number.isFinite(s)&&(s>Sb||s<Eb))throw new Error("invalid float 32: "+s)}const $m={writeUnknownFields:!0,writerFactory:()=>new Rb};function Pb(s){return s?Object.assign(Object.assign({},$m),s):$m}class Rb{constructor(t){this.stack=[],this.textEncoder=t!=null?t:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let t=0;for(let n=0;n<this.chunks.length;n++)t+=this.chunks[n].length;let e=new Uint8Array(t),r=0;for(let n=0;n<this.chunks.length;n++)e.set(this.chunks[n],r),r+=this.chunks[n].length;return this.chunks=[],e}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let t=this.finish(),e=this.stack.pop();if(!e)throw new Error("invalid state, fork stack empty");return this.chunks=e.chunks,this.buf=e.buf,this.uint32(t.byteLength),this.raw(t)}tag(t,e){return this.uint32((t<<3|e)>>>0)}raw(t){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(t),this}uint32(t){for(_c(t);t>127;)this.buf.push(t&127|128),t=t>>>7;return this.buf.push(t),this}int32(t){return ma(t),Nm(t,this.buf),this}bool(t){return this.buf.push(t?1:0),this}bytes(t){return this.uint32(t.byteLength),this.raw(t)}string(t){let e=this.textEncoder.encode(t);return this.uint32(e.byteLength),this.raw(e)}float(t){Nl(t);let e=new Uint8Array(4);return new DataView(e.buffer).setFloat32(0,t,!0),this.raw(e)}double(t){let e=new Uint8Array(8);return new DataView(e.buffer).setFloat64(0,t,!0),this.raw(e)}fixed32(t){_c(t);let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t,!0),this.raw(e)}sfixed32(t){ma(t);let e=new Uint8Array(4);return new DataView(e.buffer).setInt32(0,t,!0),this.raw(e)}sint32(t){return ma(t),t=(t<<1^t>>31)>>>0,Nm(t,this.buf),this}sfixed64(t){let e=new Uint8Array(8),r=new DataView(e.buffer),n=ke.from(t);return r.setInt32(0,n.lo,!0),r.setInt32(4,n.hi,!0),this.raw(e)}fixed64(t){let e=new Uint8Array(8),r=new DataView(e.buffer),n=ft.from(t);return r.setInt32(0,n.lo,!0),r.setInt32(4,n.hi,!0),this.raw(e)}int64(t){let e=ke.from(t);return Dl(e.lo,e.hi,this.buf),this}sint64(t){let e=ke.from(t),r=e.hi>>31,n=e.lo<<1^r,i=(e.hi<<1|e.lo>>>31)^r;return Dl(n,i,this.buf),this}uint64(t){let e=ft.from(t);return Dl(e.lo,e.hi,this.buf),this}}const Vm={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0},Bm={ignoreUnknownFields:!1};function kb(s){return s?Object.assign(Object.assign({},Bm),s):Bm}function Ib(s){return s?Object.assign(Object.assign({},Vm),s):Vm}const Hm=Symbol.for("protobuf-ts/message-type");function qm(s){let t=!1;const e=[];for(let r=0;r<s.length;r++){let n=s.charAt(r);n=="_"?t=!0:/\d/.test(n)?(e.push(n),t=!0):t?(e.push(n.toUpperCase()),t=!1):r==0?e.push(n.toLowerCase()):e.push(n)}return e.join("")}var D;(function(s){s[s.DOUBLE=1]="DOUBLE",s[s.FLOAT=2]="FLOAT",s[s.INT64=3]="INT64",s[s.UINT64=4]="UINT64",s[s.INT32=5]="INT32",s[s.FIXED64=6]="FIXED64",s[s.FIXED32=7]="FIXED32",s[s.BOOL=8]="BOOL",s[s.STRING=9]="STRING",s[s.BYTES=12]="BYTES",s[s.UINT32=13]="UINT32",s[s.SFIXED32=15]="SFIXED32",s[s.SFIXED64=16]="SFIXED64",s[s.SINT32=17]="SINT32",s[s.SINT64=18]="SINT64"})(D||(D={}));var Er;(function(s){s[s.BIGINT=0]="BIGINT",s[s.STRING=1]="STRING",s[s.NUMBER=2]="NUMBER"})(Er||(Er={}));var Sc;(function(s){s[s.NO=0]="NO",s[s.PACKED=1]="PACKED",s[s.UNPACKED=2]="UNPACKED"})(Sc||(Sc={}));function Ab(s){var t,e,r,n;return s.localName=(t=s.localName)!==null&&t!==void 0?t:qm(s.name),s.jsonName=(e=s.jsonName)!==null&&e!==void 0?e:qm(s.name),s.repeat=(r=s.repeat)!==null&&r!==void 0?r:Sc.NO,s.opt=(n=s.opt)!==null&&n!==void 0?n:s.repeat||s.oneof?!1:s.kind=="message",s}function Mb(s){if(typeof s!="object"||s===null||!s.hasOwnProperty("oneofKind"))return!1;switch(typeof s.oneofKind){case"string":return s[s.oneofKind]===void 0?!1:Object.keys(s).length==2;case"undefined":return Object.keys(s).length==1;default:return!1}}class Db{constructor(t){var e;this.fields=(e=t.fields)!==null&&e!==void 0?e:[]}prepare(){if(this.data)return;const t=[],e=[],r=[];for(let n of this.fields)if(n.oneof)r.includes(n.oneof)||(r.push(n.oneof),t.push(n.oneof),e.push(n.oneof));else switch(e.push(n.localName),n.kind){case"scalar":case"enum":(!n.opt||n.repeat)&&t.push(n.localName);break;case"message":n.repeat&&t.push(n.localName);break;case"map":t.push(n.localName);break}this.data={req:t,known:e,oneofs:Object.values(r)}}is(t,e,r=!1){if(e<0)return!0;if(t==null||typeof t!="object")return!1;this.prepare();let n=Object.keys(t),i=this.data;if(n.length<i.req.length||i.req.some(a=>!n.includes(a))||!r&&n.some(a=>!i.known.includes(a)))return!1;if(e<1)return!0;for(const a of i.oneofs){const o=t[a];if(!Mb(o))return!1;if(o.oneofKind===void 0)continue;const c=this.fields.find(u=>u.localName===o.oneofKind);if(!c||!this.field(o[o.oneofKind],c,r,e))return!1}for(const a of this.fields)if(a.oneof===void 0&&!this.field(t[a.localName],a,r,e))return!1;return!0}field(t,e,r,n){let i=e.repeat;switch(e.kind){case"scalar":return t===void 0?e.opt:i?this.scalars(t,e.T,n,e.L):this.scalar(t,e.T,e.L);case"enum":return t===void 0?e.opt:i?this.scalars(t,D.INT32,n):this.scalar(t,D.INT32);case"message":return t===void 0?!0:i?this.messages(t,e.T(),r,n):this.message(t,e.T(),r,n);case"map":if(typeof t!="object"||t===null)return!1;if(n<2)return!0;if(!this.mapKeys(t,e.K,n))return!1;switch(e.V.kind){case"scalar":return this.scalars(Object.values(t),e.V.T,n,e.V.L);case"enum":return this.scalars(Object.values(t),D.INT32,n);case"message":return this.messages(Object.values(t),e.V.T(),r,n)}break}return!0}message(t,e,r,n){return r?e.isAssignable(t,n):e.is(t,n)}messages(t,e,r,n){if(!Array.isArray(t))return!1;if(n<2)return!0;if(r){for(let i=0;i<t.length&&i<n;i++)if(!e.isAssignable(t[i],n-1))return!1}else for(let i=0;i<t.length&&i<n;i++)if(!e.is(t[i],n-1))return!1;return!0}scalar(t,e,r){let n=typeof t;switch(e){case D.UINT64:case D.FIXED64:case D.INT64:case D.SFIXED64:case D.SINT64:switch(r){case Er.BIGINT:return n=="bigint";case Er.NUMBER:return n=="number"&&!isNaN(t);default:return n=="string"}case D.BOOL:return n=="boolean";case D.STRING:return n=="string";case D.BYTES:return t instanceof Uint8Array;case D.DOUBLE:case D.FLOAT:return n=="number"&&!isNaN(t);default:return n=="number"&&Number.isInteger(t)}}scalars(t,e,r,n){if(!Array.isArray(t))return!1;if(r<2)return!0;if(Array.isArray(t)){for(let i=0;i<t.length&&i<r;i++)if(!this.scalar(t[i],e,n))return!1}return!0}mapKeys(t,e,r){let n=Object.keys(t);switch(e){case D.INT32:case D.FIXED32:case D.SFIXED32:case D.SINT32:case D.UINT32:return this.scalars(n.slice(0,r).map(i=>parseInt(i)),e,r);case D.BOOL:return this.scalars(n.slice(0,r).map(i=>i=="true"?!0:i=="false"?!1:i),e,r);default:return this.scalars(n,e,r,Er.STRING)}}}function cr(s,t){switch(t){case Er.BIGINT:return s.toBigInt();case Er.NUMBER:return s.toNumber();default:return s.toString()}}class Ob{constructor(t){this.info=t}prepare(){var t;if(this.fMap===void 0){this.fMap={};const e=(t=this.info.fields)!==null&&t!==void 0?t:[];for(const r of e)this.fMap[r.name]=r,this.fMap[r.jsonName]=r,this.fMap[r.localName]=r}}assert(t,e,r){if(!t){let n=Ml(r);throw(n=="number"||n=="boolean")&&(n=r.toString()),new Error(`Cannot parse JSON ${n} for ${this.info.typeName}#${e}`)}}read(t,e,r){this.prepare();const n=[];for(const[i,a]of Object.entries(t)){const o=this.fMap[i];if(!o){if(!r.ignoreUnknownFields)throw new Error(`Found unknown field while reading ${this.info.typeName} from JSON format. JSON key: ${i}`);continue}const c=o.localName;let u;if(o.oneof){if(a===null&&(o.kind!=="enum"||o.T()[0]!=="google.protobuf.NullValue"))continue;if(n.includes(o.oneof))throw new Error(`Multiple members of the oneof group "${o.oneof}" of ${this.info.typeName} are present in JSON.`);n.push(o.oneof),u=e[o.oneof]={oneofKind:c}}else u=e;if(o.kind=="map"){if(a===null)continue;this.assert(pb(a),o.name,a);const h=u[c];for(const[p,f]of Object.entries(a)){this.assert(f!==null,o.name+" map value",null);let v;switch(o.V.kind){case"message":v=o.V.T().internalJsonRead(f,r);break;case"enum":if(v=this.enum(o.V.T(),f,o.name,r.ignoreUnknownFields),v===!1)continue;break;case"scalar":v=this.scalar(f,o.V.T,o.V.L,o.name);break}this.assert(v!==void 0,o.name+" map value",f);let y=p;o.K==D.BOOL&&(y=y=="true"?!0:y=="false"?!1:y),y=this.scalar(y,o.K,Er.STRING,o.name).toString(),h[y]=v}}else if(o.repeat){if(a===null)continue;this.assert(Array.isArray(a),o.name,a);const h=u[c];for(const p of a){this.assert(p!==null,o.name,null);let f;switch(o.kind){case"message":f=o.T().internalJsonRead(p,r);break;case"enum":if(f=this.enum(o.T(),p,o.name,r.ignoreUnknownFields),f===!1)continue;break;case"scalar":f=this.scalar(p,o.T,o.L,o.name);break}this.assert(f!==void 0,o.name,a),h.push(f)}}else switch(o.kind){case"message":if(a===null&&o.T().typeName!="google.protobuf.Value"){this.assert(o.oneof===void 0,o.name+" (oneof member)",null);continue}u[c]=o.T().internalJsonRead(a,r,u[c]);break;case"enum":let h=this.enum(o.T(),a,o.name,r.ignoreUnknownFields);if(h===!1)continue;u[c]=h;break;case"scalar":u[c]=this.scalar(a,o.T,o.L,o.name);break}}}enum(t,e,r,n){if(t[0]=="google.protobuf.NullValue"&&ge(e===null||e==="NULL_VALUE",`Unable to parse field ${this.info.typeName}#${r}, enum ${t[0]} only accepts null.`),e===null)return 0;switch(typeof e){case"number":return ge(Number.isInteger(e),`Unable to parse field ${this.info.typeName}#${r}, enum can only be integral number, got ${e}.`),e;case"string":let i=e;t[2]&&e.substring(0,t[2].length)===t[2]&&(i=e.substring(t[2].length));let a=t[1][i];return typeof a=="undefined"&&n?!1:(ge(typeof a=="number",`Unable to parse field ${this.info.typeName}#${r}, enum ${t[0]} has no value for "${e}".`),a)}ge(!1,`Unable to parse field ${this.info.typeName}#${r}, cannot parse enum value from ${typeof e}".`)}scalar(t,e,r,n){let i;try{switch(e){case D.DOUBLE:case D.FLOAT:if(t===null)return 0;if(t==="NaN")return Number.NaN;if(t==="Infinity")return Number.POSITIVE_INFINITY;if(t==="-Infinity")return Number.NEGATIVE_INFINITY;if(t===""){i="empty string";break}if(typeof t=="string"&&t.trim().length!==t.length){i="extra whitespace";break}if(typeof t!="string"&&typeof t!="number")break;let a=Number(t);if(Number.isNaN(a)){i="not a number";break}if(!Number.isFinite(a)){i="too large or small";break}return e==D.FLOAT&&Nl(a),a;case D.INT32:case D.FIXED32:case D.SFIXED32:case D.SINT32:case D.UINT32:if(t===null)return 0;let o;if(typeof t=="number"?o=t:t===""?i="empty string":typeof t=="string"&&(t.trim().length!==t.length?i="extra whitespace":o=Number(t)),o===void 0)break;return e==D.UINT32?_c(o):ma(o),o;case D.INT64:case D.SFIXED64:case D.SINT64:if(t===null)return cr(ke.ZERO,r);if(typeof t!="number"&&typeof t!="string")break;return cr(ke.from(t),r);case D.FIXED64:case D.UINT64:if(t===null)return cr(ft.ZERO,r);if(typeof t!="number"&&typeof t!="string")break;return cr(ft.from(t),r);case D.BOOL:if(t===null)return!1;if(typeof t!="boolean")break;return t;case D.STRING:if(t===null)return"";if(typeof t!="string"){i="extra whitespace";break}try{encodeURIComponent(t)}catch(c){c="invalid UTF8";break}return t;case D.BYTES:if(t===null||t==="")return new Uint8Array(0);if(typeof t!="string")break;return mb(t)}}catch(a){i=a.message}this.assert(!1,n+(i?" - "+i:""),t)}}class Nb{constructor(t){var e;this.fields=(e=t.fields)!==null&&e!==void 0?e:[]}write(t,e){const r={},n=t;for(const i of this.fields){if(!i.oneof){let u=this.field(i,n[i.localName],e);u!==void 0&&(r[e.useProtoFieldName?i.name:i.jsonName]=u);continue}const a=n[i.oneof];if(a.oneofKind!==i.localName)continue;const o=i.kind=="scalar"||i.kind=="enum"?Object.assign(Object.assign({},e),{emitDefaultValues:!0}):e;let c=this.field(i,a[i.localName],o);ge(c!==void 0),r[e.useProtoFieldName?i.name:i.jsonName]=c}return r}field(t,e,r){let n;if(t.kind=="map"){ge(typeof e=="object"&&e!==null);const i={};switch(t.V.kind){case"scalar":for(const[c,u]of Object.entries(e)){const h=this.scalar(t.V.T,u,t.name,!1,!0);ge(h!==void 0),i[c.toString()]=h}break;case"message":const a=t.V.T();for(const[c,u]of Object.entries(e)){const h=this.message(a,u,t.name,r);ge(h!==void 0),i[c.toString()]=h}break;case"enum":const o=t.V.T();for(const[c,u]of Object.entries(e)){ge(u===void 0||typeof u=="number");const h=this.enum(o,u,t.name,!1,!0,r.enumAsInteger);ge(h!==void 0),i[c.toString()]=h}break}(r.emitDefaultValues||Object.keys(i).length>0)&&(n=i)}else if(t.repeat){ge(Array.isArray(e));const i=[];switch(t.kind){case"scalar":for(let c=0;c<e.length;c++){const u=this.scalar(t.T,e[c],t.name,t.opt,!0);ge(u!==void 0),i.push(u)}break;case"enum":const a=t.T();for(let c=0;c<e.length;c++){ge(e[c]===void 0||typeof e[c]=="number");const u=this.enum(a,e[c],t.name,t.opt,!0,r.enumAsInteger);ge(u!==void 0),i.push(u)}break;case"message":const o=t.T();for(let c=0;c<e.length;c++){const u=this.message(o,e[c],t.name,r);ge(u!==void 0),i.push(u)}break}(r.emitDefaultValues||i.length>0||r.emitDefaultValues)&&(n=i)}else switch(t.kind){case"scalar":n=this.scalar(t.T,e,t.name,t.opt,r.emitDefaultValues);break;case"enum":n=this.enum(t.T(),e,t.name,t.opt,r.emitDefaultValues,r.enumAsInteger);break;case"message":n=this.message(t.T(),e,t.name,r);break}return n}enum(t,e,r,n,i,a){if(t[0]=="google.protobuf.NullValue")return!i&&!n?void 0:null;if(e===void 0){ge(n);return}if(!(e===0&&!i&&!n))return ge(typeof e=="number"),ge(Number.isInteger(e)),a||!t[1].hasOwnProperty(e)?e:t[2]?t[2]+t[1][e]:t[1][e]}message(t,e,r,n){return e===void 0?n.emitDefaultValues?null:void 0:t.internalJsonWrite(e,n)}scalar(t,e,r,n,i){if(e===void 0){ge(n);return}const a=i||n;switch(t){case D.INT32:case D.SFIXED32:case D.SINT32:return e===0?a?0:void 0:(ma(e),e);case D.FIXED32:case D.UINT32:return e===0?a?0:void 0:(_c(e),e);case D.FLOAT:Nl(e);case D.DOUBLE:return e===0?a?0:void 0:(ge(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e);case D.STRING:return e===""?a?"":void 0:(ge(typeof e=="string"),e);case D.BOOL:return e===!1?a?!1:void 0:(ge(typeof e=="boolean"),e);case D.UINT64:case D.FIXED64:ge(typeof e=="number"||typeof e=="string"||typeof e=="bigint");let o=ft.from(e);return o.isZero()&&!a?void 0:o.toString();case D.INT64:case D.SFIXED64:case D.SINT64:ge(typeof e=="number"||typeof e=="string"||typeof e=="bigint");let c=ke.from(e);return c.isZero()&&!a?void 0:c.toString();case D.BYTES:return ge(e instanceof Uint8Array),e.byteLength?fb(e):a?"":void 0}}}function Ll(s,t=Er.STRING){switch(s){case D.BOOL:return!1;case D.UINT64:case D.FIXED64:return cr(ft.ZERO,t);case D.INT64:case D.SFIXED64:case D.SINT64:return cr(ke.ZERO,t);case D.DOUBLE:case D.FLOAT:return 0;case D.BYTES:return new Uint8Array(0);case D.STRING:return"";default:return 0}}class Lb{constructor(t){this.info=t}prepare(){var t;if(!this.fieldNoToField){const e=(t=this.info.fields)!==null&&t!==void 0?t:[];this.fieldNoToField=new Map(e.map(r=>[r.no,r]))}}read(t,e,r,n){this.prepare();const i=n===void 0?t.len:t.pos+n;for(;t.pos<i;){const[a,o]=t.tag(),c=this.fieldNoToField.get(a);if(!c){let f=r.readUnknownField;if(f=="throw")throw new Error(`Unknown field ${a} (wire type ${o}) for ${this.info.typeName}`);let v=t.skip(o);f!==!1&&(f===!0?gc.onRead:f)(this.info.typeName,e,a,o,v);continue}let u=e,h=c.repeat,p=c.localName;switch(c.oneof&&(u=u[c.oneof],u.oneofKind!==p&&(u=e[c.oneof]={oneofKind:p})),c.kind){case"scalar":case"enum":let f=c.kind=="enum"?D.INT32:c.T,v=c.kind=="scalar"?c.L:void 0;if(h){let k=u[p];if(o==We.LengthDelimited&&f!=D.STRING&&f!=D.BYTES){let I=t.uint32()+t.pos;for(;t.pos<I;)k.push(this.scalar(t,f,v))}else k.push(this.scalar(t,f,v))}else u[p]=this.scalar(t,f,v);break;case"message":if(h){let k=u[p],I=c.T().internalBinaryRead(t,t.uint32(),r);k.push(I)}else u[p]=c.T().internalBinaryRead(t,t.uint32(),r,u[p]);break;case"map":let[y,P]=this.mapEntry(c,t,r);u[p][y]=P;break}}}mapEntry(t,e,r){let n=e.uint32(),i=e.pos+n,a,o;for(;e.pos<i;){let[c,u]=e.tag();switch(c){case 1:t.K==D.BOOL?a=e.bool().toString():a=this.scalar(e,t.K,Er.STRING);break;case 2:switch(t.V.kind){case"scalar":o=this.scalar(e,t.V.T,t.V.L);break;case"enum":o=e.int32();break;case"message":o=t.V.T().internalBinaryRead(e,e.uint32(),r);break}break;default:throw new Error(`Unknown field ${c} (wire type ${u}) in map entry for ${this.info.typeName}#${t.name}`)}}if(a===void 0){let c=Ll(t.K);a=t.K==D.BOOL?c.toString():c}if(o===void 0)switch(t.V.kind){case"scalar":o=Ll(t.V.T,t.V.L);break;case"enum":o=0;break;case"message":o=t.V.T().create();break}return[a,o]}scalar(t,e,r){switch(e){case D.INT32:return t.int32();case D.STRING:return t.string();case D.BOOL:return t.bool();case D.DOUBLE:return t.double();case D.FLOAT:return t.float();case D.INT64:return cr(t.int64(),r);case D.UINT64:return cr(t.uint64(),r);case D.FIXED64:return cr(t.fixed64(),r);case D.FIXED32:return t.fixed32();case D.BYTES:return t.bytes();case D.UINT32:return t.uint32();case D.SFIXED32:return t.sfixed32();case D.SFIXED64:return cr(t.sfixed64(),r);case D.SINT32:return t.sint32();case D.SINT64:return cr(t.sint64(),r)}}}class Fb{constructor(t){this.info=t}prepare(){if(!this.fields){const t=this.info.fields?this.info.fields.concat():[];this.fields=t.sort((e,r)=>e.no-r.no)}}write(t,e,r){this.prepare();for(const i of this.fields){let a,o,c=i.repeat,u=i.localName;if(i.oneof){const h=t[i.oneof];if(h.oneofKind!==u)continue;a=h[u],o=!0}else a=t[u],o=!1;switch(i.kind){case"scalar":case"enum":let h=i.kind=="enum"?D.INT32:i.T;if(c)if(ge(Array.isArray(a)),c==Sc.PACKED)this.packed(e,h,i.no,a);else for(const p of a)this.scalar(e,h,i.no,p,!0);else a===void 0?ge(i.opt):this.scalar(e,h,i.no,a,o||i.opt);break;case"message":if(c){ge(Array.isArray(a));for(const p of a)this.message(e,r,i.T(),i.no,p)}else this.message(e,r,i.T(),i.no,a);break;case"map":ge(typeof a=="object"&&a!==null);for(const[p,f]of Object.entries(a))this.mapEntry(e,r,i,p,f);break}}let n=r.writeUnknownFields;n!==!1&&(n===!0?gc.onWrite:n)(this.info.typeName,t,e)}mapEntry(t,e,r,n,i){t.tag(r.no,We.LengthDelimited),t.fork();let a=n;switch(r.K){case D.INT32:case D.FIXED32:case D.UINT32:case D.SFIXED32:case D.SINT32:a=Number.parseInt(n);break;case D.BOOL:ge(n=="true"||n=="false"),a=n=="true";break}switch(this.scalar(t,r.K,1,a,!0),r.V.kind){case"scalar":this.scalar(t,r.V.T,2,i,!0);break;case"enum":this.scalar(t,D.INT32,2,i,!0);break;case"message":this.message(t,e,r.V.T(),2,i);break}t.join()}message(t,e,r,n,i){i!==void 0&&(r.internalBinaryWrite(i,t.tag(n,We.LengthDelimited).fork(),e),t.join())}scalar(t,e,r,n,i){let[a,o,c]=this.scalarInfo(e,n);(!c||i)&&(t.tag(r,a),t[o](n))}packed(t,e,r,n){if(!n.length)return;ge(e!==D.BYTES&&e!==D.STRING),t.tag(r,We.LengthDelimited),t.fork();let[,i]=this.scalarInfo(e);for(let a=0;a<n.length;a++)t[i](n[a]);t.join()}scalarInfo(t,e){let r=We.Varint,n,i=e===void 0,a=e===0;switch(t){case D.INT32:n="int32";break;case D.STRING:a=i||!e.length,r=We.LengthDelimited,n="string";break;case D.BOOL:a=e===!1,n="bool";break;case D.UINT32:n="uint32";break;case D.DOUBLE:r=We.Bit64,n="double";break;case D.FLOAT:r=We.Bit32,n="float";break;case D.INT64:a=i||ke.from(e).isZero(),n="int64";break;case D.UINT64:a=i||ft.from(e).isZero(),n="uint64";break;case D.FIXED64:a=i||ft.from(e).isZero(),r=We.Bit64,n="fixed64";break;case D.BYTES:a=i||!e.byteLength,r=We.LengthDelimited,n="bytes";break;case D.FIXED32:r=We.Bit32,n="fixed32";break;case D.SFIXED32:r=We.Bit32,n="sfixed32";break;case D.SFIXED64:a=i||ke.from(e).isZero(),r=We.Bit64,n="sfixed64";break;case D.SINT32:n="sint32";break;case D.SINT64:a=i||ke.from(e).isZero(),n="sint64";break}return[r,n,i||a]}}function xb(s){const t=s.messagePrototype?Object.create(s.messagePrototype):Object.defineProperty({},Hm,{value:s});for(let e of s.fields){let r=e.localName;if(!e.opt)if(e.oneof)t[e.oneof]={oneofKind:void 0};else if(e.repeat)t[r]=[];else switch(e.kind){case"scalar":t[r]=Ll(e.T,e.L);break;case"enum":t[r]=0;break;case"map":t[r]={};break}}return t}function Fl(s,t,e){let r,n=e,i;for(let a of s.fields){let o=a.localName;if(a.oneof){const c=n[a.oneof];if((c==null?void 0:c.oneofKind)==null)continue;if(r=c[o],i=t[a.oneof],i.oneofKind=c.oneofKind,r==null){delete i[o];continue}}else if(r=n[o],i=t,r==null)continue;switch(a.repeat&&(i[o].length=r.length),a.kind){case"scalar":case"enum":if(a.repeat)for(let u=0;u<r.length;u++)i[o][u]=r[u];else i[o]=r;break;case"message":let c=a.T();if(a.repeat)for(let u=0;u<r.length;u++)i[o][u]=c.create(r[u]);else i[o]===void 0?i[o]=c.create(r):c.mergePartial(i[o],r);break;case"map":switch(a.V.kind){case"scalar":case"enum":Object.assign(i[o],r);break;case"message":let u=a.V.T();for(let h of Object.keys(r))i[o][h]=u.create(r[h]);break}break}}}function Ub(s,t,e){if(t===e)return!0;if(!t||!e)return!1;for(let r of s.fields){let n=r.localName,i=r.oneof?t[r.oneof][n]:t[n],a=r.oneof?e[r.oneof][n]:e[n];switch(r.kind){case"enum":case"scalar":let o=r.kind=="enum"?D.INT32:r.T;if(!(r.repeat?Gm(o,i,a):jm(o,i,a)))return!1;break;case"map":if(!(r.V.kind=="message"?Wm(r.V.T(),Ec(i),Ec(a)):Gm(r.V.kind=="enum"?D.INT32:r.V.T,Ec(i),Ec(a))))return!1;break;case"message":let c=r.T();if(!(r.repeat?Wm(c,i,a):c.equals(i,a)))return!1;break}}return!0}const Ec=Object.values;function jm(s,t,e){if(t===e)return!0;if(s!==D.BYTES)return!1;let r=t,n=e;if(r.length!==n.length)return!1;for(let i=0;i<r.length;i++)if(r[i]!=n[i])return!1;return!0}function Gm(s,t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(!jm(s,t[r],e[r]))return!1;return!0}function Wm(s,t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(!s.equals(t[r],e[r]))return!1;return!0}const $b=Object.getOwnPropertyDescriptors(Object.getPrototypeOf({}));class _{constructor(t,e,r){this.defaultCheckDepth=16,this.typeName=t,this.fields=e.map(Ab),this.options=r!=null?r:{},this.messagePrototype=Object.create(null,Object.assign(Object.assign({},$b),{[Hm]:{value:this}})),this.refTypeCheck=new Db(this),this.refJsonReader=new Ob(this),this.refJsonWriter=new Nb(this),this.refBinReader=new Lb(this),this.refBinWriter=new Fb(this)}create(t){let e=xb(this);return t!==void 0&&Fl(this,e,t),e}clone(t){let e=this.create();return Fl(this,e,t),e}equals(t,e){return Ub(this,t,e)}is(t,e=this.defaultCheckDepth){return this.refTypeCheck.is(t,e,!1)}isAssignable(t,e=this.defaultCheckDepth){return this.refTypeCheck.is(t,e,!0)}mergePartial(t,e){Fl(this,t,e)}fromBinary(t,e){let r=Tb(e);return this.internalBinaryRead(r.readerFactory(t),t.byteLength,r)}fromJson(t,e){return this.internalJsonRead(t,kb(e))}fromJsonString(t,e){let r=JSON.parse(t);return this.fromJson(r,e)}toJson(t,e){return this.internalJsonWrite(t,Ib(e))}toJsonString(t,e){var r;let n=this.toJson(t,e);return JSON.stringify(n,null,(r=e==null?void 0:e.prettySpaces)!==null&&r!==void 0?r:0)}toBinary(t,e){let r=Pb(e);return this.internalBinaryWrite(t,r.writerFactory(),r).finish()}internalJsonRead(t,e,r){if(t!==null&&typeof t=="object"&&!Array.isArray(t)){let n=r!=null?r:this.create();return this.refJsonReader.read(t,n,e),n}throw new Error(`Unable to parse message ${this.typeName} from JSON ${Ml(t)}.`)}internalJsonWrite(t,e){return this.refJsonWriter.write(t,e)}internalBinaryWrite(t,e,r){return this.refBinWriter.write(t,e,r),e}internalBinaryRead(t,e,r,n){let i=n!=null?n:this.create();return this.refBinReader.read(t,i,r,e),i}}var Bt;(function(s){s[s.PUBLISHER=0]="PUBLISHER",s[s.SUBSCRIBER=1]="SUBSCRIBER"})(Bt||(Bt={}));var Dt;(function(s){s[s.AUDIO=0]="AUDIO",s[s.VIDEO=1]="VIDEO"})(Dt||(Dt={}));class Vb extends _{constructor(){super("media.Codec",[{no:1,name:"channels",kind:"scalar",opt:!0,T:5},{no:2,name:"clock_rate",kind:"scalar",T:5},{no:3,name:"mime_type",kind:"scalar",T:9},{no:4,name:"sdp_fmtp_line",kind:"scalar",opt:!0,T:9}])}}const Bb=new Vb;class Hb extends _{constructor(){super("media.HeaderExtension",[{no:1,name:"direction",kind:"scalar",opt:!0,T:9},{no:2,name:"uri",kind:"scalar",T:9}])}}const qb=new Hb;class jb extends _{constructor(){super("media.Fingerprint",[{no:1,name:"algorithm",kind:"scalar",T:9},{no:2,name:"value",kind:"scalar",T:9}])}}new jb;class Gb extends _{constructor(){super("media.SessionDescription",[{no:1,name:"target",kind:"enum",T:()=>["media.Target",Bt]},{no:2,name:"type",kind:"scalar",T:9},{no:3,name:"sdp",kind:"scalar",T:9}])}}const dr=new Gb;class Wb extends _{constructor(){super("media.CreateTransportRequest",[{no:1,name:"consuming",kind:"scalar",T:8},{no:2,name:"force_tcp",kind:"scalar",opt:!0,T:8},{no:3,name:"description",kind:"message",T:()=>dr}])}}const Jm=new Wb;class Jb extends _{constructor(){super("media.CreateTransportResponse",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>dr},{no:3,name:"transcription_enabled",kind:"scalar",opt:!0,T:8}])}}const xl=new Jb;class Kb extends _{constructor(){super("media.RenegotiateRequest",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>dr}])}}const Km=new Kb;class zb extends _{constructor(){super("media.RenegotiateResponse",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>dr}])}}new zb;class Yb extends _{constructor(){super("media.NestedScore",[{no:1,name:"encoding_idx",kind:"scalar",T:5},{no:2,name:"rid",kind:"scalar",T:9},{no:3,name:"score",kind:"scalar",T:5},{no:4,name:"ssrc",kind:"scalar",T:3,L:0}])}}const Qb=new Yb;class Xb extends _{constructor(){super("media.ProducerTrack",[{no:1,name:"track_id",kind:"scalar",T:9},{no:2,name:"producer_id",kind:"scalar",T:9},{no:3,name:"stream_id",kind:"scalar",T:9}])}}const Zb=new Xb;class eP extends _{constructor(){super("media.ProducerEntry",[{no:1,name:"producing_transport_id",kind:"scalar",T:9},{no:2,name:"producer_id",kind:"scalar",T:9}])}}new eP;class tP extends _{constructor(){super("media.ConsumerEntry",[{no:1,name:"consuming_transport_id",kind:"scalar",T:9},{no:2,name:"consumer_id",kind:"scalar",T:9}])}}new tP;class rP extends _{constructor(){super("media.ProducerState",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"kind",kind:"enum",T:()=>["media.ProducerKind",Dt]},{no:3,name:"pause",kind:"scalar",T:8},{no:4,name:"screen_share",kind:"scalar",T:8},{no:5,name:"app_data",kind:"scalar",opt:!0,T:9},{no:6,name:"producing_transport_id",kind:"scalar",opt:!0,T:9},{no:7,name:"mime_type",kind:"scalar",opt:!0,T:9}])}}const fa=new rP;class sP extends _{constructor(){super("media.ConsumerState",[{no:1,name:"consumer_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>fa},{no:3,name:"producer_track",kind:"message",T:()=>Zb}])}}const nP=new sP;class iP extends _{constructor(){super("media.ProducerIdToConsumerMap",[{no:1,name:"map",kind:"map",K:9,V:{kind:"message",T:()=>nP}}])}}const zm=new iP;class aP extends _{constructor(){super("media.PeerRtpCapabilitites",[{no:1,name:"sender",kind:"message",T:()=>Xm},{no:2,name:"receiver",kind:"message",T:()=>Xm}])}}const Ym=new aP;class oP extends _{constructor(){super("media.RtpCapability",[{no:1,name:"codecs",kind:"message",repeat:1,T:()=>Bb},{no:2,name:"header_extensions",kind:"message",repeat:1,T:()=>qb}])}}const Qm=new oP;class cP extends _{constructor(){super("media.RtpCapabilitites",[{no:1,name:"audio",kind:"message",T:()=>Qm},{no:2,name:"video",kind:"message",T:()=>Qm}])}}const Xm=new cP;class dP extends _{constructor(){super("media.PreferredCodec",[{no:1,name:"audio",kind:"scalar",opt:!0,T:9},{no:2,name:"video",kind:"scalar",opt:!0,T:9}])}}const lP=new dP;class uP extends _{constructor(){super("media.edge.GeoLocation",[{no:1,name:"latitude",kind:"scalar",T:2},{no:2,name:"longitude",kind:"scalar",T:2},{no:3,name:"region",kind:"scalar",opt:!0,T:9}])}}const hP=new uP;class pP extends _{constructor(){super("media.edge.PeerJoinRequest",[{no:1,name:"display_name",kind:"scalar",opt:!0,T:9},{no:2,name:"prejoined",kind:"scalar",T:8},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:5,name:"preset",kind:"scalar",opt:!0,T:12},{no:6,name:"user_id",kind:"scalar",opt:!0,T:9},{no:7,name:"organization_id",kind:"scalar",opt:!0,T:9},{no:8,name:"location",kind:"message",T:()=>hP},{no:9,name:"capabilities",kind:"message",T:()=>Ym}])}}const Zm=new pP;class mP extends _{constructor(){super("media.edge.PeerJoinCompleteRequest",[])}}const ef=new mP;class fP extends _{constructor(){super("media.edge.PeerLeaveRequest",[{no:1,name:"close_room",kind:"scalar",T:8}])}}const tf=new fP;class gP extends _{constructor(){super("media.edge.ConsumeMultipleProducerRequest",[{no:1,name:"producer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"paused",kind:"scalar",opt:!0,T:8}])}}new gP;class vP extends _{constructor(){super("media.edge.ConsumePeerRequest",[{no:1,name:"producing_peer_id",kind:"scalar",T:9},{no:2,name:"paused",kind:"scalar",opt:!0,T:8},{no:3,name:"producer_id",kind:"scalar",opt:!0,T:9},{no:4,name:"preferred_codec",kind:"message",T:()=>lP}])}}const rf=new vP;class yP extends _{constructor(){super("media.edge.ProducerCreateRequest",[{no:1,name:"kind",kind:"scalar",T:9},{no:2,name:"paused",kind:"scalar",T:8},{no:3,name:"screen_share",kind:"scalar",T:8},{no:4,name:"description",kind:"message",T:()=>dr},{no:5,name:"msid",kind:"scalar",T:9},{no:6,name:"app_data",kind:"scalar",opt:!0,T:9},{no:7,name:"mime_type",kind:"scalar",opt:!0,T:9}])}}const sf=new yP;class TP extends _{constructor(){super("media.edge.SelectedPeersRequest",[])}}new TP;class _P extends _{constructor(){super("media.edge.GlobalPeerPinningRequest",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const nf=new _P;class SP extends _{constructor(){super("media.edge.ProducerToggleRequest",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"pause",kind:"scalar",T:8}])}}const hs=new SP;class EP extends _{constructor(){super("media.edge.ConsumerToggleRequest",[{no:1,name:"consumer_id",kind:"scalar",T:9},{no:2,name:"pause",kind:"scalar",T:8}])}}const wc=new EP;class wP extends _{constructor(){super("media.edge.ProducerCloseRequest",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>dr}])}}const af=new wP;class CP extends _{constructor(){super("media.edge.ConsumerCloseRequest",[{no:1,name:"consumer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"description",kind:"message",T:()=>dr}])}}const of=new CP;class bP extends _{constructor(){super("media.edge.KickPeerRequest",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const cf=new bP;class PP extends _{constructor(){super("media.edge.KickAllPeersRequest",[{no:1,name:"propagate_kick_across_rooms",kind:"scalar",T:8}])}}const Ul=new PP;class RP extends _{constructor(){super("media.edge.PeerDisplayNameEditRequest",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9}])}}const df=new RP;class kP extends _{constructor(){super("media.edge.HostMediaControlForPeerRequest",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"audio",kind:"scalar",T:8},{no:3,name:"video",kind:"scalar",T:8},{no:4,name:"scree_share",kind:"scalar",T:8}])}}const lf=new kP;class IP extends _{constructor(){super("media.edge.HostMediaControlForAllPeerRequest",[{no:1,name:"audio",kind:"scalar",T:8},{no:2,name:"video",kind:"scalar",T:8},{no:3,name:"screen_share",kind:"scalar",T:8}])}}const uf=new IP;class AP extends _{constructor(){super("media.edge.GetRoomStateResponse",[{no:1,name:"display_title",kind:"scalar",T:9},{no:2,name:"locked_mode",kind:"scalar",T:8},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"room_name",kind:"scalar",T:9},{no:5,name:"current_peer_id",kind:"scalar",T:9},{no:6,name:"is_recording",kind:"scalar",opt:!0,T:8},{no:7,name:"recorder_participant_id",kind:"scalar",opt:!0,T:9},{no:8,name:"pinned_peer_ids",kind:"scalar",repeat:2,T:9}])}}const MP=new AP;class DP extends _{constructor(){super("media.edge.ErrorResponse",[{no:1,name:"error_message",kind:"scalar",T:9},{no:2,name:"event_id",kind:"scalar",T:5}])}}const OP=new DP;class NP extends _{constructor(){super("media.edge.EmptyResponse",[])}}new NP;class LP extends _{constructor(){super("media.edge.RoomParticipants",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"producer_states",kind:"message",repeat:1,T:()=>fa},{no:3,name:"display_name",kind:"scalar",T:9},{no:4,name:"user_id",kind:"scalar",opt:!0,T:9},{no:5,name:"capabilities",kind:"message",T:()=>Ym}])}}const hf=new LP;class FP extends _{constructor(){super("media.edge.SelectedPeersResponse",[{no:1,name:"audio_peers",kind:"scalar",repeat:2,T:9},{no:2,name:"compulsory_peers",kind:"scalar",repeat:2,T:9}])}}const $l=new FP;class xP extends _{constructor(){super("media.edge.SelectedPeersDiffEntry",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"priority",kind:"scalar",T:5}])}}const UP=new xP;class $P extends _{constructor(){super("media.edge.SelectedPeersDiffResponse",[{no:1,name:"entries",kind:"message",repeat:1,T:()=>UP}])}}const pf=new $P;class VP extends _{constructor(){super("media.edge.PeerJoinResponse",[])}}new VP;class BP extends _{constructor(){super("media.edge.PeerJoinCompleteResponse",[{no:1,name:"room_state",kind:"message",T:()=>MP},{no:2,name:"participants",kind:"message",repeat:1,T:()=>hf},{no:3,name:"selected_peers",kind:"message",T:()=>$l},{no:4,name:"max_preferred_streams",kind:"scalar",T:5}])}}const Cc=new BP;class HP extends _{constructor(){super("media.edge.PeerLeaveResponse",[{no:1,name:"closed",kind:"scalar",T:8}])}}const mf=new HP;class qP extends _{constructor(){super("media.edge.ConsumeMultipleProducerResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"consumer_ids_map",kind:"message",T:()=>zm}])}}new qP;class jP extends _{constructor(){super("media.edge.ConsumePeerResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"consumer_ids_map",kind:"message",T:()=>zm},{no:3,name:"description",kind:"message",T:()=>dr}])}}const ff=new jP;class GP extends _{constructor(){super("media.edge.ProducerCreateResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"producer_id",kind:"scalar",T:9},{no:4,name:"description",kind:"message",T:()=>dr}])}}const gf=new GP;class WP extends _{constructor(){super("media.edge.ProducerScoreResponse",[{no:1,name:"responseid",kind:"scalar",T:9},{no:2,name:"score",kind:"message",T:()=>Qb}])}}new WP;class JP extends _{constructor(){super("media.edge.ActiveSpeakerResponse",[{no:1,name:"responsepeer_id",kind:"scalar",T:9},{no:2,name:"volume",kind:"scalar",T:5}])}}new JP;class KP extends _{constructor(){super("media.edge.NoActiveSpeakerResponse",[])}}new KP;class zP extends _{constructor(){super("media.edge.ProducerToggleResponse",[])}}new zP;class YP extends _{constructor(){super("media.edge.ConsumerToggleResponse",[])}}new YP;class QP extends _{constructor(){super("media.edge.ProducerClosingResponse",[{no:1,name:"description",kind:"message",T:()=>dr}])}}const vf=new QP;class XP extends _{constructor(){super("media.edge.ConsumerClosingResponse",[{no:1,name:"description",kind:"message",T:()=>dr}])}}new XP;class ZP extends _{constructor(){super("media.edge.GlobalPeerPinningResponse",[])}}new ZP;class eR extends _{constructor(){super("media.edge.KickPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const yf=new eR;class tR extends _{constructor(){super("media.edge.KickAllPeersResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const Tf=new tR;class rR extends _{constructor(){super("media.edge.HostMediaControlForPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const _f=new rR;class sR extends _{constructor(){super("media.edge.HostMediaControlForAllPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const Sf=new sR;class nR extends _{constructor(){super("media.edge.PeerDisplayNameEditResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const Ef=new nR;class iR extends _{constructor(){super("media.edge.PeerJoinBroadcastResponse",[{no:1,name:"participant",kind:"message",T:()=>hf}])}}const wf=new iR;class aR extends _{constructor(){super("media.edge.TrackSubscriptionKind",[{no:1,name:"audio",kind:"scalar",T:8},{no:2,name:"video",kind:"scalar",T:8}])}}const Cf=new aR;class oR extends _{constructor(){super("media.edge.TrackSubscription",[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"webcam",kind:"message",T:()=>Cf},{no:3,name:"screenshare",kind:"message",T:()=>Cf}])}}const cR=new oR;class dR extends _{constructor(){super("media.edge.PeerProducingTransportCreateBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"transport_details",kind:"message",T:()=>xl},{no:3,name:"track_subscriptions",kind:"message",repeat:1,T:()=>cR}])}}new dR;class lR extends _{constructor(){super("media.edge.PeerProducerCreateBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>fa}])}}const bf=new lR;class uR extends _{constructor(){super("media.edge.PeerProducerToggleBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>fa}])}}const Pf=new uR;class hR extends _{constructor(){super("media.edge.PeerProducerCloseBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>fa}])}}const Rf=new hR;class pR extends _{constructor(){super("media.edge.PeerLeaveBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const bc=new pR;class mR extends _{constructor(){super("media.edge.GlobalPeerPinningBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const kf=new mR;class fR extends _{constructor(){super("media.edge.GlobalPeerUnPinningBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}new fR;class gR extends _{constructor(){super("media.edge.RecordingStartedBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}new gR;class vR extends _{constructor(){super("media.edge.RecordingStoppedBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}new vR;class yR extends _{constructor(){super("media.edge.PeerDisplayNameEditBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9}])}}new yR;class TR extends _{constructor(){super("media.edge.PeerPingRequestBroadcastResponse",[{no:1,name:"password",kind:"scalar",T:9}])}}new TR;class _R extends _{constructor(){super("media.edge.MediaRoomTerminationBroadcastResponse",[{no:1,name:"reason",kind:"scalar",T:9}])}}new _R;class SR extends _{constructor(){super("socket.ai.MeetingTranscript",[{no:1,name:"meeting_id",kind:"scalar",T:9},{no:2,name:"transcript",kind:"scalar",T:9},{no:3,name:"is_partial",kind:"scalar",T:8}])}}const Vl=new SR;class ER extends _{constructor(){super("socket.api.BaseSocketHubMessage",[{no:1,name:"event",kind:"scalar",T:5},{no:2,name:"id",kind:"scalar",T:9},{no:3,name:"peer_id",kind:"scalar",T:9},{no:4,name:"room_id",kind:"scalar",T:9},{no:5,name:"user_id",kind:"scalar",T:9},{no:6,name:"payload",kind:"scalar",T:12},{no:7,name:"error",kind:"scalar",opt:!0,T:8},{no:8,name:"sid",kind:"scalar",opt:!0,T:9}])}}new ER;class wR extends _{constructor(){super("socket.api.ErrorMessage",[{no:1,name:"code",kind:"scalar",opt:!0,T:5},{no:2,name:"message",kind:"scalar",T:9}])}}const CR=new wR;var sn;(function(s){s[s.BROWSER=0]="BROWSER",s[s.TRACK=1]="TRACK",s[s.COMPOSITE=2]="COMPOSITE"})(sn||(sn={}));var Ur;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.ON_STAGE=1]="ON_STAGE",s[s.APPROVED_STAGE=2]="APPROVED_STAGE",s[s.REQUESTED_STAGE=3]="REQUESTED_STAGE",s[s.OFF_STAGE=4]="OFF_STAGE"})(Ur||(Ur={}));var Bl;(function(s){s[s.NONE=0]="NONE",s[s.RECORDER=1]="RECORDER",s[s.LIVESTREAMER=2]="LIVESTREAMER"})(Bl||(Bl={}));var Pc;(function(s){s[s.HIVE=0]="HIVE",s[s.CHAT=1]="CHAT",s[s.PING=2]="PING"})(Pc||(Pc={}));class bR extends _{constructor(){super("socket.room.PeerFlags",[{no:1,name:"preset_name",kind:"scalar",T:9},{no:2,name:"recorder_type",kind:"scalar",T:9},{no:3,name:"hidden_participant",kind:"scalar",T:8}])}}const PR=new bR;class RR extends _{constructor(){super("socket.room.Peer",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"display_name",kind:"scalar",T:9},{no:4,name:"stage_type",kind:"enum",opt:!0,T:()=>["socket.room.StageType",Ur,"STAGE_TYPE_"]},{no:5,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:6,name:"preset_id",kind:"scalar",opt:!0,T:9},{no:7,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:8,name:"waitlisted",kind:"scalar",T:8},{no:9,name:"flags",kind:"message",T:()=>PR}])}}const Rc=new RR;class kR extends _{constructor(){super("socket.room.PeerInfoResponse",[{no:1,name:"peer",kind:"message",T:()=>Rc}])}}const Yn=new kR;class IR extends _{constructor(){super("socket.room.PeerStatusUpdate",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"stage_type",kind:"enum",opt:!0,T:()=>["socket.room.StageType",Ur,"STAGE_TYPE_"]}])}}const If=new IR;class AR extends _{constructor(){super("socket.room.RoomPeersInfoRequest",[{no:1,name:"seach_query",kind:"scalar",T:9},{no:2,name:"limit",kind:"scalar",T:5},{no:3,name:"offset",kind:"scalar",T:5}])}}const MR=new AR;class DR extends _{constructor(){super("socket.room.RoomPeersInfoResponse",[{no:1,name:"peers",kind:"message",repeat:1,T:()=>Rc}])}}const Hl=new DR;class OR extends _{constructor(){super("socket.room.RoomPeerCountResponse",[{no:1,name:"count",kind:"scalar",T:4,L:2}])}}const Af=new OR;class NR extends _{constructor(){super("socket.room.Room",[{no:1,name:"room_id",kind:"scalar",T:9},{no:2,name:"title",kind:"scalar",T:9},{no:4,name:"created_at",kind:"scalar",T:4,L:2},{no:5,name:"active_recordings",kind:"message",repeat:1,T:()=>FR},{no:6,name:"room_uuid",kind:"scalar",opt:!0,T:9}])}}const Mf=new NR;class LR extends _{constructor(){super("socket.room.ActiveRecording",[{no:1,name:"recording_id",kind:"scalar",T:9},{no:2,name:"recording_type",kind:"enum",T:()=>["common.RecordingType",sn]},{no:3,name:"recording_status",kind:"scalar",T:9}])}}const FR=new LR;class xR extends _{constructor(){super("socket.room.RoomInfoResponse",[{no:1,name:"room",kind:"message",T:()=>Mf}])}}const Df=new xR;class UR extends _{constructor(){super("socket.room.GetPeerInfoRequest",[{no:1,name:"peer_id",kind:"scalar",T:9}])}}const Of=new UR;class $R extends _{constructor(){super("socket.room.UpdatePeerInfoRequest",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9}])}}new $R;class VR extends _{constructor(){super("socket.room.JoinRoomRequest",[{no:1,name:"peer",kind:"message",T:()=>Rc},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"organization_id",kind:"scalar",opt:!0,T:9},{no:5,name:"use_hive",kind:"scalar",opt:!0,T:8},{no:6,name:"preset",kind:"scalar",opt:!0,T:12},{no:7,name:"capabilities",kind:"enum",repeat:1,T:()=>["socket.room.Capabilities",Pc,"CAPABILITIES_"]},{no:8,name:"timestamp",kind:"scalar",opt:!0,T:4,L:2}])}}const BR=new VR;class HR extends _{constructor(){super("socket.room.LeaveRoomRequest",[{no:1,name:"peer",kind:"message",T:()=>Rc},{no:2,name:"timestamp",kind:"scalar",opt:!0,T:4,L:2}])}}const qR=new HR;class jR extends _{constructor(){super("socket.room.UpdateRoomInfoRequest",[{no:1,name:"room",kind:"message",T:()=>Mf}])}}new jR;class GR extends _{constructor(){super("socket.room.GetConnectedRoomsDumpRequest",[])}}new GR;class WR extends _{constructor(){super("socket.room.ServiceError",[{no:1,name:"message",kind:"scalar",opt:!0,T:9},{no:2,name:"code",kind:"scalar",opt:!0,T:9}])}}const ql=new WR;class JR extends _{constructor(){super("socket.room.ConnectedMeetingPeer",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9},{no:3,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:4,name:"preset_id",kind:"scalar",opt:!0,T:9},{no:5,name:"display_picture_url",kind:"scalar",opt:!0,T:9}])}}const KR=new JR;class zR extends _{constructor(){super("socket.room.ConnectedMeetingDump",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9},{no:3,name:"participants",kind:"message",repeat:1,T:()=>KR}])}}const Nf=new zR;class YR extends _{constructor(){super("socket.room.GetConnectedRoomsDumpResponse",[{no:1,name:"parent_meeting",kind:"message",T:()=>Nf},{no:2,name:"meetings",kind:"message",repeat:1,T:()=>Nf}])}}const QR=new YR;class XR extends _{constructor(){super("socket.room.CreateRoomRequestPayload",[{no:1,name:"title",kind:"scalar",opt:!0,T:9}])}}const ZR=new XR;class ek extends _{constructor(){super("socket.room.CreateConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>ZR}])}}const tk=new ek;class rk extends _{constructor(){super("socket.room.CreateRoomResponsePayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9},{no:3,name:"error",kind:"message",T:()=>ql}])}}const sk=new rk;class nk extends _{constructor(){super("socket.room.CreateConnectedRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>sk}])}}const Lf=new nk;class ik extends _{constructor(){super("socket.room.UpdateRoomRequestPayload",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9}])}}const ak=new ik;class ok extends _{constructor(){super("socket.room.UpdateConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>ak}])}}new ok;class ck extends _{constructor(){super("socket.room.DisableRoomPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9}])}}const dk=new ck;class lk extends _{constructor(){super("socket.room.DisableConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>dk}])}}const uk=new lk;class hk extends _{constructor(){super("socket.room.DisableConnectedRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>fk}])}}const pk=new hk;class mk extends _{constructor(){super("socket.room.DisableConnectedRoomPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"status",kind:"scalar",opt:!0,T:9},{no:3,name:"title",kind:"scalar",opt:!0,T:9},{no:4,name:"error",kind:"message",T:()=>ql}])}}const fk=new mk;class gk extends _{constructor(){super("socket.room.MovePeerPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"preset_id",kind:"scalar",opt:!0,T:9}])}}const vk=new gk;class yk extends _{constructor(){super("socket.room.MovePeersBetweenRoomsRequest",[{no:1,name:"source_meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"destination_meeting_id",kind:"scalar",opt:!0,T:9},{no:3,name:"participants",kind:"message",repeat:1,T:()=>vk}])}}const Tk=new yk;class _k extends _{constructor(){super("socket.room.MovedPeer",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:3,name:"error",kind:"message",T:()=>ql}])}}const Ff=new _k;class Sk extends _{constructor(){super("socket.room.MovePeersBetweenRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>Ff}])}}new Sk;class Ek extends _{constructor(){super("socket.room.TransferPeer",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"auth_token",kind:"scalar",opt:!0,T:9}])}}const wk=new Ek;class Ck extends _{constructor(){super("socket.room.GetAllAddedParticipantsResponse",[{no:1,name:"participants",kind:"message",repeat:1,T:()=>Rk}])}}const bk=new Ck;class Pk extends _{constructor(){super("socket.room.AddedParticipant",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",opt:!0,T:9},{no:3,name:"picture",kind:"scalar",opt:!0,T:9},{no:4,name:"custom_participant_id",kind:"scalar",T:9}])}}const Rk=new Pk;class kk extends _{constructor(){super("socket.room.RemoveParticipantsRequest",[{no:1,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const Ik=new kk;class Ak extends _{constructor(){super("socket.room.BroadcastMessage",[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"timestamp",kind:"scalar",T:4,L:2},{no:4,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const kc=new Ak;class Mk extends _{constructor(){super("socket.room.AcceptWaitingRoomRequests",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const Dk=new Mk;class Ok extends _{constructor(){super("socket.room.DenyWaitingRoomRequests",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const Nk=new Ok;class Lk extends _{constructor(){super("socket.room.WaitingRoomRequest",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"display_name",kind:"scalar",T:9},{no:4,name:"picture",kind:"scalar",opt:!0,T:9},{no:5,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:6,name:"preset_name",kind:"scalar",opt:!0,T:9}])}}const Fk=new Lk;class xk extends _{constructor(){super("socket.room.GetWaitingRoomRequests",[{no:1,name:"requests",kind:"message",repeat:1,T:()=>Fk}])}}const xf=new xk;class Uk extends _{constructor(){super("socket.room.GetRoomStageStateResponse",[{no:1,name:"on_stage_peers",kind:"scalar",repeat:2,T:9},{no:2,name:"approved_stage_peers",kind:"scalar",repeat:2,T:9},{no:3,name:"requested_stage_peers",kind:"scalar",repeat:2,T:9}])}}const Uf=new Uk;var jl;(function(s){s[s.NONE=0]="NONE",s[s.SKIP=1]="SKIP",s[s.ON_PRIVILEGED_USER_ENTRY=2]="ON_PRIVILEGED_USER_ENTRY",s[s.SKIP_ON_ACCEPT=3]="SKIP_ON_ACCEPT"})(jl||(jl={}));var ps;(function(s){s[s.NONE=0]="NONE",s[s.ALLOWED=1]="ALLOWED",s[s.NOT_ALLOWED=2]="NOT_ALLOWED",s[s.CAN_REQUEST=3]="CAN_REQUEST"})(ps||(ps={}));class $k extends _{constructor(){super("socket.preset.PollsPermissionUpdate",[{no:1,name:"can_create",kind:"scalar",opt:!0,T:8},{no:2,name:"can_vote",kind:"scalar",opt:!0,T:8},{no:3,name:"can_view",kind:"scalar",opt:!0,T:8}])}}const Vk=new $k;class Bk extends _{constructor(){super("socket.preset.PluginsPermissionsUpdate",[{no:1,name:"can_close",kind:"scalar",opt:!0,T:8},{no:2,name:"can_start",kind:"scalar",opt:!0,T:8}])}}const Hk=new Bk;class qk extends _{constructor(){super("socket.preset.PublicChatPermission",[{no:1,name:"can_send",kind:"scalar",opt:!0,T:8},{no:2,name:"text",kind:"scalar",opt:!0,T:8},{no:3,name:"files",kind:"scalar",opt:!0,T:8}])}}const jk=new qk;class Gk extends _{constructor(){super("socket.preset.PrivateChatPermission",[{no:1,name:"can_send",kind:"scalar",opt:!0,T:8},{no:2,name:"can_receive",kind:"scalar",opt:!0,T:8},{no:3,name:"text",kind:"scalar",opt:!0,T:8},{no:4,name:"files",kind:"scalar",opt:!0,T:8}])}}const Wk=new Gk;class Jk extends _{constructor(){super("socket.preset.ChatPermissionUpdate",[{no:1,name:"public",kind:"message",T:()=>jk},{no:2,name:"private",kind:"message",T:()=>Wk}])}}const Kk=new Jk;class zk extends _{constructor(){super("socket.preset.ConnectedMeetingPermissionUpdate",[{no:1,name:"can_alter_connected_meetings",kind:"scalar",opt:!0,T:8},{no:2,name:"can_switch_to_parent_meeting",kind:"scalar",opt:!0,T:8},{no:3,name:"can_switch_connected_meetings",kind:"scalar",opt:!0,T:8}])}}const Yk=new zk;class Qk extends _{constructor(){super("socket.preset.StreamPermission",[{no:1,name:"can_produce",kind:"enum",opt:!0,T:()=>["socket.preset.StreamPermissionType",ps,"STREAM_PERMISSION_TYPE_"]},{no:2,name:"can_consume",kind:"enum",opt:!0,T:()=>["socket.preset.StreamPermissionType",ps,"STREAM_PERMISSION_TYPE_"]}])}}const Gl=new Qk;class Xk extends _{constructor(){super("socket.preset.MediaPermissionUpdate",[{no:1,name:"video",kind:"message",T:()=>Gl},{no:2,name:"audio",kind:"message",T:()=>Gl},{no:3,name:"screenshare",kind:"message",T:()=>Gl}])}}const Zk=new Xk;class eI extends _{constructor(){super("socket.preset.PresetUpdates",[{no:1,name:"polls",kind:"message",T:()=>Vk},{no:2,name:"plugins",kind:"message",T:()=>Hk},{no:3,name:"chat",kind:"message",T:()=>Kk},{no:4,name:"accept_waiting_requests",kind:"scalar",opt:!0,T:8},{no:5,name:"can_accept_production_requests",kind:"scalar",opt:!0,T:8},{no:6,name:"can_edit_display_name",kind:"scalar",opt:!0,T:8},{no:7,name:"can_record",kind:"scalar",opt:!0,T:8},{no:8,name:"can_livestream",kind:"scalar",opt:!0,T:8},{no:9,name:"can_spotlight",kind:"scalar",opt:!0,T:8},{no:10,name:"disable_participant_audio",kind:"scalar",opt:!0,T:8},{no:11,name:"disable_participant_screensharing",kind:"scalar",opt:!0,T:8},{no:12,name:"disable_participant_video",kind:"scalar",opt:!0,T:8},{no:13,name:"kick_participant",kind:"scalar",opt:!0,T:8},{no:14,name:"pin_participant",kind:"scalar",opt:!0,T:8},{no:15,name:"transcription_enabled",kind:"scalar",opt:!0,T:8},{no:16,name:"waiting_room_type",kind:"enum",opt:!0,T:()=>["socket.preset.WaitingRoomType",jl,"WAITING_ROOM_TYPE_"]},{no:17,name:"is_recorder",kind:"scalar",opt:!0,T:8},{no:18,name:"recorder_type",kind:"enum",opt:!0,T:()=>["socket.room.RecorderType",Bl,"RECORDER_TYPE_"]},{no:19,name:"hidden_participant",kind:"scalar",opt:!0,T:8},{no:20,name:"show_participant_list",kind:"scalar",opt:!0,T:8},{no:21,name:"can_change_participant_permissions",kind:"scalar",opt:!0,T:8},{no:22,name:"connected_meetings",kind:"message",T:()=>Yk},{no:23,name:"media",kind:"message",T:()=>Zk}])}}const Wl=new eI;class tI extends _{constructor(){super("socket.preset.ReadPeersPresetRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const rI=new tI;class sI extends _{constructor(){super("socket.preset.PeerPreset",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"peer_id",kind:"scalar",T:9},{no:3,name:"preset",kind:"scalar",T:12}])}}const nI=new sI;class iI extends _{constructor(){super("socket.preset.ReadPeersPresetResponse",[{no:1,name:"peer_presets",kind:"message",repeat:1,T:()=>nI}])}}const aI=new iI;class oI extends _{constructor(){super("socket.preset.UpdatePeerPreset",[{no:1,name:"user_ids",kind:"scalar",T:9},{no:2,name:"patch",kind:"message",T:()=>Wl}])}}const $f=new oI;class cI extends _{constructor(){super("socket.preset.UpdatePeersPresetRequest",[{no:1,name:"update_peers_presets",kind:"message",repeat:1,T:()=>$f}])}}const dI=new cI;class lI extends _{constructor(){super("socket.preset.UpdatePeersPresetResponse",[{no:1,name:"update_peers_presets",kind:"message",repeat:1,T:()=>$f}])}}const Vf=new lI;class uI extends _{constructor(){super("socket.preset.PeerUserIDMap",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9}])}}const hI=new uI;class pI extends _{constructor(){super("socket.preset.BulkUpdatePeerPresetRequest",[{no:1,name:"peers",kind:"message",repeat:1,T:()=>hI},{no:2,name:"patch",kind:"message",T:()=>Wl}])}}new pI;class mI extends _{constructor(){super("socket.preset.BulkUpdatePeerPresetResponse",[{no:2,name:"patch",kind:"message",T:()=>Wl}])}}new mI;class fI extends _{constructor(){super("socket.chat.ChatMessage",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"peer_id",kind:"scalar",T:9},{no:3,name:"user_id",kind:"scalar",T:9},{no:4,name:"display_name",kind:"scalar",T:9},{no:5,name:"pinned",kind:"scalar",T:8},{no:6,name:"is_edited",kind:"scalar",T:8},{no:7,name:"payload_type",kind:"scalar",T:5},{no:8,name:"payload",kind:"scalar",T:9},{no:10,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:11,name:"created_at",kind:"scalar",T:4,L:2},{no:12,name:"created_at_ms",kind:"scalar",opt:!0,T:4,L:2},{no:13,name:"channel_id",kind:"scalar",opt:!0,T:9},{no:14,name:"channel_index",kind:"scalar",opt:!0,T:9}])}}const nn=new fI;class gI extends _{constructor(){super("socket.chat.GetPaginatedChatMessageRoomRequest",[{no:1,name:"time_stamp",kind:"scalar",T:4,L:2},{no:2,name:"size",kind:"scalar",T:5},{no:3,name:"from",kind:"scalar",T:5},{no:4,name:"reversed",kind:"scalar",T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const vI=new gI;class yI extends _{constructor(){super("socket.chat.GetPaginatedChatMessageRoomResponse",[{no:1,name:"messages",kind:"message",repeat:1,T:()=>nn},{no:2,name:"next",kind:"scalar",T:8}])}}const TI=new yI;class _I extends _{constructor(){super("socket.chat.GetChatMessagesResponse",[{no:1,name:"messages",kind:"message",repeat:1,T:()=>nn}])}}const Bf=new _I;class SI extends _{constructor(){super("socket.chat.SendChatMessageToRoomRequest",[{no:1,name:"payload_type",kind:"scalar",T:5},{no:2,name:"payload",kind:"scalar",T:9}])}}const EI=new SI;class wI extends _{constructor(){super("socket.chat.SendChatMessageToRoomResponse",[{no:1,name:"message",kind:"message",T:()=>nn}])}}const Jl=new wI;class CI extends _{constructor(){super("socket.chat.SendChatMessageToPeersRequest",[{no:1,name:"peer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"payload_type",kind:"scalar",T:5},{no:3,name:"payload",kind:"scalar",T:9}])}}const bI=new CI;class PI extends _{constructor(){super("socket.chat.SendChatMessageToPeersResponse",[{no:1,name:"message",kind:"message",T:()=>nn}])}}const Kl=new PI;class RI extends _{constructor(){super("socket.chat.SendChatMessageToChannelRequest",[{no:1,name:"channel_id",kind:"scalar",T:9},{no:2,name:"payload_type",kind:"scalar",T:5},{no:3,name:"payload",kind:"scalar",T:9}])}}const kI=new RI;class II extends _{constructor(){super("socket.chat.SendChatMessageToChannelResponse",[{no:1,name:"message",kind:"message",T:()=>nn}])}}new II;class AI extends _{constructor(){super("socket.chat.EditChatMessageRequest",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"payload_type",kind:"scalar",opt:!0,T:5},{no:3,name:"payload",kind:"scalar",opt:!0,T:9},{no:4,name:"pinned",kind:"scalar",opt:!0,T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const MI=new AI;class DI extends _{constructor(){super("socket.chat.PinChatMessageRequest",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"pinned",kind:"scalar",T:8},{no:3,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const OI=new DI;class NI extends _{constructor(){super("socket.chat.PinChatMessageResponse",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"pinned",kind:"scalar",T:8},{no:3,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const Ic=new NI;class LI extends _{constructor(){super("socket.chat.EditChatMessageResponse",[{no:1,name:"message",kind:"message",T:()=>nn}])}}const Ac=new LI;class FI extends _{constructor(){super("socket.chat.DeleteChatMessageRequest",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const xI=new FI;class UI extends _{constructor(){super("socket.chat.DeleteChatMessageResponse",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const Mc=new UI;class $I extends _{constructor(){super("socket.chat.SearchChatMessagesRequest",[{no:1,name:"time_stamp",kind:"scalar",T:4,L:2},{no:2,name:"size",kind:"scalar",T:5},{no:3,name:"from",kind:"scalar",T:5},{no:4,name:"reversed",kind:"scalar",T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9},{no:6,name:"search_term",kind:"scalar",T:9}])}}const VI=new $I;class BI extends _{constructor(){super("socket.chat.MarkChannelIndexAsReadRequest",[{no:1,name:"channel_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"channel_index",kind:"scalar",T:9}])}}const HI=new BI;class qI extends _{constructor(){super("socket.chat.MarkChannelIndexAsReadResponse",[{no:1,name:"channel_index",kind:"scalar",T:9}])}}const jI=new qI;class GI extends _{constructor(){super("socket.chat.CreateChatChannelRequest",[{no:1,name:"display_name",kind:"scalar",T:9},{no:2,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:3,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:4,name:"visibility",kind:"scalar",T:9},{no:5,name:"is_direct_message",kind:"scalar",T:8}])}}const WI=new GI;class JI extends _{constructor(){super("socket.chat.UpdateChatChannelRequest",[{no:1,name:"chat_channel_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9},{no:3,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:4,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:5,name:"visibility",kind:"scalar",opt:!0,T:9},{no:6,name:"is_direct_message",kind:"scalar",opt:!0,T:8}])}}const KI=new JI;class zI extends _{constructor(){super("socket.chat.CreateChatChannelResponse",[{no:1,name:"chat_channel_id",kind:"scalar",T:9}])}}new zI;class YI extends _{constructor(){super("socket.chat.GetChatChannelRequest",[{no:1,name:"chat_channel_id",kind:"scalar",T:9}])}}const QI=new YI;class XI extends _{constructor(){super("socket.chat.LatestMessageAndUnreadCount",[{no:1,name:"message",kind:"message",T:()=>nn},{no:2,name:"unread_count",kind:"scalar",T:4,L:2}])}}const ZI=new XI;class eA extends _{constructor(){super("socket.chat.ChatChannel",[{no:1,name:"chat_channel_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9},{no:3,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:4,name:"visibility",kind:"scalar",T:9},{no:5,name:"is_direct_message",kind:"scalar",T:8},{no:6,name:"latest_message_and_unread_count",kind:"message",T:()=>ZI},{no:7,name:"target_user_ids",kind:"scalar",repeat:2,T:9}])}}const tA=new eA;class rA extends _{constructor(){super("socket.chat.GetChatChannelResponse",[{no:1,name:"chat_channels",kind:"message",repeat:1,T:()=>tA}])}}const $r=new rA;class sA extends _{constructor(){super("socket.chat.ChannelMember",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",opt:!0,T:9},{no:3,name:"picture",kind:"scalar",opt:!0,T:9},{no:4,name:"custom_participant_id",kind:"scalar",T:9}])}}const nA=new sA;class iA extends _{constructor(){super("socket.chat.GetChatChannelMembersResponse",[{no:1,name:"channel_members",kind:"message",repeat:1,T:()=>nA}])}}const aA=new iA;class oA extends _{constructor(){super("socket.plugin.AddPluginRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"staggered",kind:"scalar",T:8}])}}const cA=new oA;class dA extends _{constructor(){super("socket.plugin.RemovePluginRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"staggered",kind:"scalar",T:8}])}}const lA=new dA;class uA extends _{constructor(){super("socket.plugin.EnablePluginForRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9}])}}const hA=new uA;class pA extends _{constructor(){super("socket.plugin.DisablePluginForRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9}])}}const mA=new pA;class fA extends _{constructor(){super("socket.plugin.EnablePluginForPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const gA=new fA;class vA extends _{constructor(){super("socket.plugin.DisablePluginForPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const yA=new vA;class TA extends _{constructor(){super("socket.plugin.PluginEventToRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"plugin_data",kind:"scalar",T:12}])}}const _A=new TA;class SA extends _{constructor(){super("socket.plugin.PluginEventToPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9},{no:3,name:"plugin_data",kind:"scalar",T:12}])}}const EA=new SA;class wA extends _{constructor(){super("socket.plugin.StoreKeys",[{no:1,name:"store_key",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",opt:!0,T:12}])}}const zl=new wA;class CA extends _{constructor(){super("socket.plugin.PluginStoreInsertKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"insert_keys",kind:"message",repeat:1,T:()=>zl}])}}const Hf=new CA;class bA extends _{constructor(){super("socket.plugin.PluginStoreGetKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"get_keys",kind:"message",repeat:1,T:()=>zl}])}}const PA=new bA;class RA extends _{constructor(){super("socket.plugin.PluginStoreDeleteKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"delete_keys",kind:"message",repeat:1,T:()=>zl}])}}const kA=new RA;class IA extends _{constructor(){super("socket.plugin.PluginStoreDeleteRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9}])}}const AA=new IA;class MA extends _{constructor(){super("socket.plugin.EnablePluginResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"enabled_by",kind:"scalar",T:9}])}}const Yl=new MA;class DA extends _{constructor(){super("socket.plugin.EnablePluginsResponse",[{no:1,name:"plugins",kind:"message",repeat:1,T:()=>Yl}])}}const OA=new DA;class NA extends _{constructor(){super("socket.plugin.DisablePluginResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"disabled_by",kind:"scalar",T:9}])}}const qf=new NA;class LA extends _{constructor(){super("socket.plugin.PluginStoreItem",[{no:1,name:"timestamp",kind:"scalar",T:9},{no:2,name:"peer_id",kind:"scalar",T:9},{no:3,name:"store_key",kind:"scalar",T:9},{no:4,name:"payload",kind:"scalar",T:12}])}}const FA=new LA;class xA extends _{constructor(){super("socket.plugin.PluginStoreResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"store_items",kind:"message",repeat:1,T:()=>FA}])}}const jf=new xA;class UA extends _{constructor(){super("socket.plugin.PluginEventResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"plugin_data",kind:"scalar",T:12}])}}const Gf=new UA;class $A extends _{constructor(){super("socket.livestreaming.LiveStreamingEvent",[{no:1,name:"livestream_id",kind:"scalar",T:9},{no:2,name:"err_message",kind:"scalar",T:9},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"meeting_id",kind:"scalar",T:9},{no:5,name:"playback_url",kind:"scalar",T:9},{no:6,name:"org_id",kind:"scalar",T:9},{no:7,name:"room_name",kind:"scalar",T:9},{no:8,name:"room_uuid",kind:"scalar",T:9},{no:9,name:"status",kind:"scalar",T:9}])}}const Wf=new $A;class VA extends _{constructor(){super("socket.livestreaming.GetStagePeersResponse",[{no:1,name:"stage_peers",kind:"scalar",repeat:2,T:9}])}}const Jf=new VA;class BA extends _{constructor(){super("socket.livestreaming.StageRequest",[{no:1,name:"display_name",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"peer_id",kind:"scalar",T:9}])}}const HA=new BA;class qA extends _{constructor(){super("socket.livestreaming.GetStageRequestsResponse",[{no:1,name:"stage_requests",kind:"message",repeat:1,T:()=>HA}])}}const Ql=new qA;class jA extends _{constructor(){super("socket.livestreaming.GrantStageAccessRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const GA=new jA;class WA extends _{constructor(){super("socket.livestreaming.DenyStageAccessRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const JA=new WA;class KA extends _{constructor(){super("socket.livestreaming.LeaveStageRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const Kf=new KA;class zA extends _{constructor(){super("socket.polls.Poll",[{no:1,name:"poll_id",kind:"scalar",T:9},{no:2,name:"created_by",kind:"scalar",T:9},{no:3,name:"created_by_user_id",kind:"scalar",T:9},{no:4,name:"question",kind:"scalar",T:9},{no:5,name:"options",kind:"message",repeat:1,T:()=>QA},{no:6,name:"hide_votes",kind:"scalar",T:8},{no:7,name:"anonymous",kind:"scalar",T:8},{no:8,name:"votes",kind:"scalar",repeat:2,T:9}])}}const zf=new zA;class YA extends _{constructor(){super("socket.polls.PollOption",[{no:1,name:"text",kind:"scalar",T:9},{no:2,name:"count",kind:"scalar",opt:!0,T:4,L:2},{no:3,name:"votes",kind:"message",repeat:1,T:()=>ZA}])}}const QA=new YA;class XA extends _{constructor(){super("socket.polls.PollVote",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9}])}}const ZA=new XA;class eM extends _{constructor(){super("socket.polls.NewPollRequest",[{no:1,name:"question",kind:"scalar",T:9},{no:2,name:"options",kind:"scalar",repeat:2,T:9},{no:3,name:"anonymous",kind:"scalar",T:8},{no:4,name:"hide_votes",kind:"scalar",T:8},{no:5,name:"created_by",kind:"scalar",opt:!0,T:9},{no:6,name:"created_by_user_id",kind:"scalar",opt:!0,T:9}])}}const tM=new eM;class rM extends _{constructor(){super("socket.polls.VotePollRequest",[{no:1,name:"poll_id",kind:"scalar",T:9},{no:2,name:"index",kind:"scalar",T:4,L:2}])}}const sM=new rM;class nM extends _{constructor(){super("socket.polls.UpdatePollResponse",[{no:1,name:"poll",kind:"message",T:()=>zf}])}}const Xl=new nM;class iM extends _{constructor(){super("socket.polls.GetPollsResponse",[{no:1,name:"polls",kind:"message",repeat:1,T:()=>zf}])}}const aM=new iM;class oM extends _{constructor(){super("socket.recording.RecordingEvent",[{no:1,name:"recording_id",kind:"scalar",T:9},{no:2,name:"err_message",kind:"scalar",T:9},{no:3,name:"recording_type",kind:"enum",T:()=>["common.RecordingType",sn]}])}}const Yf=new oM;class cM extends _{constructor(){super("google.protobuf.Timestamp",[{no:1,name:"seconds",kind:"scalar",T:3,L:0},{no:2,name:"nanos",kind:"scalar",T:5}])}now(){const t=this.create(),e=Date.now();return t.seconds=ke.from(Math.floor(e/1e3)).toBigInt(),t.nanos=e%1e3*1e6,t}toDate(t){return new Date(ke.from(t.seconds).toNumber()*1e3+Math.ceil(t.nanos/1e6))}fromDate(t){const e=this.create(),r=t.getTime();return e.seconds=ke.from(Math.floor(r/1e3)).toBigInt(),e.nanos=r%1e3*1e6,e}internalJsonWrite(t,e){let r=ke.from(t.seconds).toNumber()*1e3;if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("Unable to encode Timestamp to JSON. Must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive.");if(t.nanos<0)throw new Error("Unable to encode invalid Timestamp to JSON. Nanos must not be negative.");let n="Z";if(t.nanos>0){let i=(t.nanos+1e9).toString().substring(1);i.substring(3)==="000000"?n="."+i.substring(0,3)+"Z":i.substring(6)==="000"?n="."+i.substring(0,6)+"Z":n="."+i+"Z"}return new Date(r).toISOString().replace(".000Z",n)}internalJsonRead(t,e,r){if(typeof t!="string")throw new Error("Unable to parse Timestamp from JSON "+Ml(t)+".");let n=t.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!n)throw new Error("Unable to parse Timestamp from JSON. Invalid format.");let i=Date.parse(n[1]+"-"+n[2]+"-"+n[3]+"T"+n[4]+":"+n[5]+":"+n[6]+(n[8]?n[8]:"Z"));if(Number.isNaN(i))throw new Error("Unable to parse Timestamp from JSON. Invalid value.");if(i<Date.parse("0001-01-01T00:00:00Z")||i>Date.parse("9999-12-31T23:59:59Z"))throw new globalThis.Error("Unable to parse Timestamp from JSON. Must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive.");return r||(r=this.create()),r.seconds=ke.from(i/1e3).toBigInt(),r.nanos=0,n[7]&&(r.nanos=parseInt("1"+n[7]+"0".repeat(9-n[7].length))-1e9),r}}new cM;class Qn extends ce.EventEmitter{constructor(){super(),super.setMaxListeners(25)}emit(t,...e){return super.emit("*",t,...e),super.emit(t,...e)}on(t,e){try{const r=this.listenerCount(t);r>25&&r%25===0&&l.warn("DyteEventEmitter::maxListenersExceeded",{eventListener:{eventName:t.toString(),listenerCount:this.listenerCount(t)}})}catch(r){}return super.on(t,e)}addListener(t,e){try{const r=this.listenerCount(t);r>25&&r%25===0&&l.warn("DyteEventEmitter::maxListenersExceeded",{eventListener:{eventName:t.toString(),listenerCount:this.listenerCount(t)}})}catch(r){}return super.addListener(t,e)}off(t,e){return super.off(t,e)}once(t,e){return super.once(t,e)}prependListener(t,e){return super.prependListener(t,e)}prependOnceListener(t,e){return super.prependOnceListener(t,e)}removeListener(t,e){return super.removeListener(t,e)}removeAllListeners(t){return super.removeAllListeners(t)}listeners(t){return super.listeners(t)}listenerCount(t){return super.listenerCount(t)}}class Ht extends ce.EventEmitter{constructor(){super(),super.setMaxListeners(25)}emit(t,...e){return super.emit("*",t,...e),super.emit(t,...e)}on(t,e){try{const r=this.listenerCount(t);r>25&&r%25===0&&l.warn("DyteEventEmitter::maxListenersExceeded",{eventListener:{eventName:t.toString(),listenerCount:this.listenerCount(t)}})}catch(r){}return super.on(t,e)}addListener(t,e){try{const r=this.listenerCount(t);r>25&&r%25===0&&l.warn("DyteEventEmitter::maxListenersExceeded",{eventListener:{eventName:t.toString(),listenerCount:this.listenerCount(t)}})}catch(r){}return super.addListener(t,e)}off(t,e){return super.off(t,e)}once(t,e){return super.once(t,e)}prependListener(t,e){return super.prependListener(t,e)}prependOnceListener(t,e){return super.prependOnceListener(t,e)}removeListener(t,e){return super.removeListener(t,e)}removeAllListeners(t){return super.removeAllListeners(t)}listeners(t){return super.listeners(t)}listenerCount(t){return super.listenerCount(t)}}const dM=0,lM=1,uM=2,hM=3,pM=4,mM=5,fM={getPeerInfo:0,updatePeerInfo:1,getRoomPeersInfo:2,joinRoom:3,leaveRoom:4,getRoomInfo:5,updateRoomInfo:6,closeRoom:7,startedLivestream:8,stoppedLivestream:9,erroredLivestream:10,getStagePeers:11,getStageRequests:12,requestStageAccess:13,cancelStageRequest:14,grantStageAccess:15,denyStageAccess:16,roomPeerCount:17,joinStage:18,leaveStage:19,getConnectedRoomsDump:20,createConnectedRooms:21,deleteConnectedRooms:22,movePeers:23,transferPeer:24,movedPeer:25,connectedRoomsUpdated:26,connectedRoomsDeleted:27,getAllAddedParticipants:28,broadcastMessage:29,kick:30,kickAll:31,transcript:32,getWaitingRoomRequests:33,acceptWaitingRoomRequests:34,waitingRoomRequestAccepted:35,denyWaitingRoomRequests:36,waitingRoomRequestDenied:37,peerStageStatusUpdate:38,broadcastToPeers:39,recordingStarted:40,recordingStopped:41,recordingPaused:42,getRoomStageState:43},gM={getMessages:0,sendMessageToRoom:1,sendMessageToPeers:2,editMessage:3,deleteMessage:4,getPaginatedMessages:5,sendMessageToChannel:6,searchChannelMessages:7,getAllChatChannels:8,markChannelIndexAsRead:9,pinMessage:10},vM={getPlugins:0,addPlugin:1,enablePluginForRoom:2,disablePluginForPeers:3,enablePluginForPeers:4,disablePluginForRoom:5,removePlugin:6,customPluginEventToRoom:7,customPluginEventToPeers:8,storeInsertKeys:9,storeGetKeys:10,storeDeleteKeys:11,storeDelete:12},yM={createPoll:0,getPolls:1,votePoll:2,updatePoll:3},Qf={unknown:0,createWebRTCTransport:1,produce:2,consume:3,toggleProducer:4,toggleConsumer:5,closeProducer:6,closeConsumer:7,joinRoom:16,leaveRoom:17,selectedPeer:18,globalPinPeer:19,selfJoinComplete:20,peerJoinedBroadcast:25,peerLeaveBroadcast:26,peerProducerCreateBroadcast:27,peerProducerToggleBroadcast:28,peerProducerCloseBroadcast:29,globalPeerPinBroadcast:30,recordingStartedBroadcast:31,recordingStoppedBroadcast:32,peerDisplayNameEditBroadcast:33,mediaRoomTerminationBroadcastResponse:36,selectedPeerDiff:40,renegotiateSessionDescription:50,errorResponse:60,kickPeer:90,kickAll:91,changeDisplayName:92,hostControlPeer:93,hostControlAllPeers:94},TM={createChatChannel:0,getChatChannel:1,deprecatedGetAllChatChannels:2,getChannelMembers:3,updateChatChannel:4},_M={getUserPresets:0,updateUserPreset:1};function Xn(s,t){return Object.keys(t).reduce((e,r)=>(e[r]=(s<<16)+t[r],e),{})}function Xf(s,t){return Object.keys(s).reduce((e,r)=>(e[r]=t|s[r],e),{})}const V=Xn(dM,fM),Ve=Xn(lM,gM),G=Xn(uM,vM),Vr=Xn(hM,yM),an=Xn(pM,TM),se=Xf(Qf,16777216),ne=Xf(Qf,50331648),Dc=Xn(mM,_M);var SM=Object.defineProperty,EM=Object.getOwnPropertyDescriptor,Zl=(s,t,e,r)=>{for(var n=r>1?void 0:r?EM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&SM(t,e,n),n};const eu=(_v=class{constructor(s){S(this,Cs,void 0);T(this,Cs,s)}async createChannel(s,t,e,r="public",n=!1){const i={displayName:s,targetUserIds:t,displayPictureUrl:e,visibility:r,isDirectMessage:n};n&&(i.visibility="private");const a=await d(this,Cs).sendMessagePromise(an.createChatChannel,WI.toBinary(i)),o=$r.fromBinary(a.payload).chatChannels;return eu.formatChannel(o[0])}async updateChannel(s,t){const e=await d(this,Cs).sendMessagePromise(an.updateChatChannel,KI.toBinary({chatChannelId:s,targetUserIds:t.memberIds,displayName:t.displayName,displayPictureUrl:t.displayPictureUrl,visibility:t.visibility})),r=$r.fromBinary(e.payload).chatChannels;return eu.formatChannel(r[0])}static formatChannel(s){var r;const{latestMessageAndUnreadCount:t}=s,e={...s,id:s.chatChannelId,memberIds:s.targetUserIds,unreadCount:(r=t==null?void 0:t.unreadCount)!=null?r:0};return t!=null&&t.message&&(e.latestMessage=ur.formatSocketServiceMessage(t.message)),delete e.chatChannelId,delete e.targetUserIds,delete e.latestMessageAndUnreadCount,e}async getChannelMembers(s){try{const t=await d(this,Cs).sendMessagePromise(an.getChannelMembers,QI.toBinary({chatChannelId:s}));return aA.fromBinary(t.payload).channelMembers.map(({id:e,...r})=>({...r,userId:e}))}catch(t){return[]}}on(s,t){let e,r;switch(s){case an.createChatChannel:{e=$r.fromBinary.bind($r),r=$r.create();break}case an.updateChatChannel:{e=$r.fromBinary.bind($r),r=$r.create();break}}if(!e){l.warn(`ChatChannelSocketHandler::Event ${s} is not recognized`);return}d(this,Cs).on(s,({payload:n})=>{let i=r;try{i=e(n)}catch(a){l.error("ChatChannelSocketHandler::on::binary_decode_error",{error:a})}return t(i)})}},Cs=new WeakMap,_v);let on=eu;Zl([g.trace("ChatChannelHandler.createChannel")],on.prototype,"createChannel",1),Zl([g.trace("ChatChannelHandler.updateChannel")],on.prototype,"updateChannel",1),Zl([g.trace("ChatChannelHandler.getChannelMembers")],on.prototype,"getChannelMembers",1);var wM=Object.defineProperty,CM=Object.getOwnPropertyDescriptor,lr=(s,t,e,r)=>{for(var n=r>1?void 0:r?CM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&wM(t,e,n),n},bt=(s=>(s[s.TEXT=0]="TEXT",s[s.IMAGE=1]="IMAGE",s[s.FILE=2]="FILE",s[s.CUSTOM=3]="CUSTOM",s))(bt||{});class Yt{constructor(t){S(this,vt,void 0);T(this,vt,t)}getChatMessages(){return d(this,vt).sendMessagePromise(Ve.getMessages)}async getChatMessagesPaginated(t,e,r,n=0,i=""){const a={timeStamp:t,size:e,from:n,reversed:r,channelId:i},o=await d(this,vt).sendMessagePromise(Ve.getPaginatedMessages,vI.toBinary(a));return o.payload?TI.fromBinary(o.payload):{messages:[],next:!1}}sendMessageToRoom(t,e){const r={payloadType:e,payload:t};d(this,vt).sendMessage(Ve.sendMessageToRoom,EI.toBinary(r))}sendMessageToPeers(t,e,r){const n={payloadType:e,peerIds:r,payload:t};d(this,vt).sendMessage(Ve.sendMessageToPeers,bI.toBinary(n))}sendMessageToChannel(t,e,r){const n={payloadType:e,channelId:r,payload:t};d(this,vt).sendMessage(Ve.sendMessageToChannel,kI.toBinary(n))}sendMessage(t,e,r,n){if(n&&this.sendMessageToChannel(t,e,n),r&&r.length>0){this.sendMessageToPeers(t,e,r);return}this.sendMessageToRoom(t,e)}async editMessage(t,e,r,n,i){const a={chatId:t,payloadType:r,payload:e};n&&(a.channelId=n),i!==void 0&&(a.pinned=i);const o=await d(this,vt).sendMessagePromise(Ve.editMessage,MI.toBinary(a));return Ac.fromBinary(o.payload).message}async deleteMessage(t,e){const r={chatId:t};e&&(r.channelId=e);const n=await d(this,vt).sendMessagePromise(Ve.deleteMessage,xI.toBinary(r)),i=Mc.fromBinary(n.payload);return{id:i.chatId,...i.channelId?{channelId:i.channelId}:{}}}async searchMessages(t,e){var n,i,a;const r={searchTerm:t,timeStamp:(n=e.timestamp)!=null?n:Date.now(),size:(i=e.size)!=null?i:75,from:0,reversed:(a=e.reversed)!=null?a:!0};e.channelId&&(r.channelId=e.channelId);try{const o=await d(this,vt).sendMessagePromise(Ve.searchChannelMessages,VI.toBinary(r));return Bf.fromBinary(o.payload).messages}catch(o){return[]}}async getAllChannels(){try{const t=await d(this,vt).sendMessagePromise(Ve.getAllChatChannels);return $r.fromBinary(t.payload).chatChannels.map(on.formatChannel)}catch(t){return[]}}async markLastReadMessage(t,e){const r=await d(this,vt).sendMessagePromise(Ve.markChannelIndexAsRead,HI.toBinary({channelId:t,userId:e.userId,channelIndex:e.channelIndex}));return jI.fromBinary(r.payload).channelIndex}async setPinState(t,e){const r={chatId:t.id,pinned:e,channelId:t.channelId},n=await d(this,vt).sendMessagePromise(Ve.pinMessage,OI.toBinary(r));return Ic.fromBinary(n.payload)}on(t,e){let r,n;switch(t){case Ve.sendMessageToRoom:{r=Jl.fromBinary.bind(Jl),n=Jl.create();break}case Ve.sendMessageToPeers:{r=Kl.fromBinary.bind(Kl),n=Kl.create();break}case Ve.editMessage:{r=Ac.fromBinary.bind(Ac),n=Ac.create();break}case Ve.pinMessage:{r=Ic.fromBinary.bind(Ic),n=Ic.create();break}case Ve.deleteMessage:{r=Mc.fromBinary.bind(Mc),n=Mc.create();break}}if(!r){l.warn(`ChatSocketHandler::Event ${t} is not recognized`);return}d(this,vt).on(t,({payload:i})=>{let a=n;try{a=r(i)}catch(o){l.error("chatSocketHandler::on::binary_decode_error",{error:o})}return e(a)})}}vt=new WeakMap,lr([g.trace("SocketService.getChatMessages")],Yt.prototype,"getChatMessages",1),lr([g.trace("SocketService.getChatMessagesPaginated")],Yt.prototype,"getChatMessagesPaginated",1),lr([g.trace("SocketService.sendMessageToRoom")],Yt.prototype,"sendMessageToRoom",1),lr([g.trace("SocketService.sendMessageToPeers")],Yt.prototype,"sendMessageToPeers",1),lr([g.trace("SocketService.sendMessageToChannel")],Yt.prototype,"sendMessageToChannel",1),lr([g.trace("SocketService.sendMessage")],Yt.prototype,"sendMessage",1),lr([g.trace("SocketService.editMessage")],Yt.prototype,"editMessage",1),lr([g.trace("SocketService.deleteMessage")],Yt.prototype,"deleteMessage",1),lr([g.trace("SocketService.searchMessages")],Yt.prototype,"searchMessages",1),lr([g.trace("SocketService.getAllChannels")],Yt.prototype,"getAllChannels",1),lr([g.trace("SocketService.markLastReadMessage")],Yt.prototype,"markLastReadMessage",1);function bM(s){return s.replace(/([-_]\w)/g,t=>t[1].toUpperCase())}function wr(s){if(!s||typeof s!="object")return s;if(Array.isArray(s))return s.map(e=>wr(e));const t={};return Object.keys(s).forEach(e=>{const r=Ld(e)?e:bM(e);t[r]=wr(s[e])}),t}function PM(s){return s.replace(/[A-Z]/g,t=>`_${t.toLowerCase()}`)}function Zf(s){if(!s||typeof s!="object")return s;if(Array.isArray(s))return s.map(e=>Zf(e));const t={};return Object.keys(s).forEach(e=>{const r=Ld(e)?e:PM(e);t[r]=s[e]}),t}function Oc(s,t={}){return s==null?{}:(Object.getOwnPropertyNames(s).forEach(e=>{if(typeof s[e]!="function"){if(typeof s[e]=="object"){Oc(s[e],t[e]={});return}t[e]=s[e]}}),t)}const RM=3,kM=30,IM=8e3;class AM{constructor(t,e){m(this,"ipInfo");m(this,"axios");m(this,"requests");m(this,"roomName");m(this,"roomUUID");m(this,"authToken");m(this,"organizationId");m(this,"iceServers");m(this,"pluginInformation");m(this,"userDetails");m(this,"roomDetails");m(this,"context");this.context=t;const{timeout:r=IM,retry:n=RM,retryDelay:i=kM,baseURL:a="https://api.cluster.dyte.in",authToken:o,cachedUserDetails:c}=e||{};this.iceServers=c==null?void 0:c.iceServers,this.pluginInformation=c==null?void 0:c.pluginInformation,this.userDetails=c==null?void 0:c.userDetails,this.roomDetails=c==null?void 0:c.roomDetails,this.requests=Zo.create({baseURL:a,responseType:"json",timeout:r,retry:n,retryDelay:i}),this.axios=Zo,this.setAuthToken(o,{bearer:!0}),this.requests.interceptors.request.use(u=>(g.injectContext(this.requests.defaults.headers.common),u),async u=>{l.error("xhr::axios",{debuggingHint:"otelRequestInterceptor failed.",error:u})}),this.requests.interceptors.response.use(u=>{try{u.config.url!==g.logsEndpoint&&l.debug("xhr::axios",{networkCall:{status:u.status,statusText:u.statusText,baseURL:u.config.baseURL,url:u.config.url,method:u.config.method}})}catch(h){console.error("xhr::dyte",{error:"responseInterceptorFailed",err:h,response:u})}return u},async u=>{var h;try{if(!u)return Promise.reject(new b("Unknown network error occurred","0011"));u&&u.config&&((h=u.config)==null?void 0:h.url)!==g.logsEndpoint&&l.error("xhr::axios",{error:u,networkCall:{status:u.status,statusText:u.statusText,baseURL:u.config.baseURL,url:u.config.url,retries:u.config.retry,method:u.config.method,isOnline:navigator.onLine?"online":"offline"}});const{config:p,message:f}=u;return p&&f&&p.retry!==void 0&&p.retry>0&&(f.includes("timeout")||f.includes("Network Error"))?(p.retry-=1,this.requests(p)):Promise.reject(new b(f,"0011"))}catch(p){return console.error("xhr::dyte",{error:"responseInterceptorFailed",err:p,responseError:u}),Promise.reject(new b(p.message,"0011"))}})}get peerId(){return this.context.getValue("peerId")}setAuthToken(t,e){const{bearer:r}=e||{};this.authToken=t,this.requests.defaults.headers.common.Authorization=r?`Bearer ${t}`:t}setHeader(t,e){this.requests.defaults.headers.common[t]=e}setRoomName(t){this.roomName=t}setRoomUUID(t){this.roomUUID=t}setOrganizationId(t){this.organizationId=t}}var MM=Object.defineProperty,DM=Object.getOwnPropertyDescriptor,tu=(s,t,e,r)=>{for(var n=r>1?void 0:r?DM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&MM(t,e,n),n};class Nc extends AM{constructor(t,e){super(t,e),this.setHeader("x-dyte-web-core-version",t.getValue("sdkVersion"))}async getIPDetails(){var e;const{peerId:t}=this;try{const r=await Nd.getIPDetails({peerId:t,apiHostnames:Mm(this.context)});if(l.log("ipInfo",{ipInfo:r}),((e=r.loc)==null?void 0:e.length)>5)return r;throw Error("Insufficient data")}catch(r){l.warn("ApiClient.getRoomNodeLinkAndTitleV1 Failed to get ip details",{error:{name:r.name,message:r.message}});return}}async getICEServers(){if(this.iceServers)return this.iceServers;const{success:t,iceServers:e}=(await this.requests.get("/iceservers")).data;if(t)return(e==null?void 0:e.length)>0&&(this.iceServers=e),e}async getPlugins(){var n,i,a,o,c,u,h;if(this.pluginInformation)return this.pluginInformation;let{plugins:t}=(await this.requests.get("/v2/plugins/user")).data.data;const e=((i=(n=j.getValue(J.V1_PLUGINS))==null?void 0:n.toString())==null?void 0:i.split(","))||[];return t=t.reduce((p,f)=>(p[e.includes(f.id)?"v1":"v2"].push(f),p),{v1:[],v2:[]}).v2,(c=(o=(a=this.context.getValue("modules"))==null?void 0:a.devTools)==null?void 0:o.plugins)!=null&&c.length&&((h=(u=this.context.getValue("modules"))==null?void 0:u.devTools)==null||h.plugins.forEach(p=>{var v,y,P;const f={...ha,tags:[...ha.tags]};f.baseURL=`http://localhost:${p.port}`,f.name=p.name,f.picture=(v=p.picture)!=null?v:ha.picture,f.description=(y=p.description)!=null?y:ha.description,f.staggered=(P=p.staggered)!=null?P:ha.staggered,f.createdAt=new Date().toISOString(),f.updatedAt=new Date().toISOString(),f.id=p.id,f.organizationId=this.organizationId,t.push(f)})),t}async getPluginDetails(t){const{plugin:e}=(await this.requests.get(`/v2/plugins/view/${t}`)).data.data;return e}async getPluginConfig(t){return(await this.axios.get(`${t}/dyte-config.json`)).data}async authorizePlugin(t){const e={peerId:this.peerId},{token:r}=(await this.requests.post(`/v2/plugins/authorize/${t}`,e)).data.data;return r}async getPresignedUrls(t,e){const r=Al(this.context,"chat_upload_expiry"),n={roomUUID:this.roomUUID,filename:t,expiry:typeof r=="number"?r:void 0};j.hasFeature(J.FEAT_CHAT_SDK)&&(n.viewType=e);const{getLocation:i,putLocation:a}=(await this.requests.post("/v1/meetings/genPreSignedUploadUrl",n)).data.data;return{getLocation:i,putLocation:a}}async uploadFile(t,e){if(navigator.isReactNative&&"uri"in t)try{await fetch(e,{method:"PUT",headers:{"Content-Type":"application/octet-stream"},body:{uri:t.uri,name:t.name}})}catch(r){l.error(`sendFileMessage::${r}`)}else await this.axios.put(e,t,{headers:{"Content-Type":t.type}})}}tu([g.trace("APIClient.getIPDetails")],Nc.prototype,"getIPDetails",1),tu([g.trace("APIClient.getICEServers")],Nc.prototype,"getICEServers",1),tu([g.trace("APIClient.getPlugins")],Nc.prototype,"getPlugins",1);var OM=Object.defineProperty,NM=Object.getOwnPropertyDescriptor,Br=(s,t,e,r)=>{for(var n=r>1?void 0:r?NM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&OM(t,e,n),n};class Cr extends Nc{async startLivestreaming(){var e,r;return(r=(e=(await this.requests.post(`/v2/meetings/${this.context.getValue("meetingId")}/livestreams`)).data)==null?void 0:e.data)==null?void 0:r.playback_url}async stopLivestreaming(){return this.requests.post(`/v2/meetings/${this.context.getValue("meetingId")}/active-livestream/stop`)}async getActiveLivestream(){const{playbackUrl:t,status:e}=wr((await this.requests.get(`/v2/meetings/${this.context.getValue("meetingId")}/active-livestream`)).data.data);return{status:e,playbackUrl:t}}async getUserDetails(){if(this.userDetails)return this.userDetails;const t=(await this.requests.get("v2/internals/participant-details")).data.data;return wr(t)}async startRecording(t,e){return(await this.requests.post("/v2/recordings",{...Zf(t),meeting_id:this.context.getValue("meetingId"),allow_multiple_recordings:!!e})).data.data.id}async updateRecording(t,e){return this.requests.put(`v2/recordings/${t}`,{action:e})}async getActiveRecording(){const{status:t,id:e}=(await this.requests.get(`v2/recordings/active-recording/${this.context.getValue("meetingId")}`)).data.data;return{status:t,id:e}}async getActiveTranscript(){const{transcript_download_url:t}=(await this.requests.get(`v2/meetings/${this.context.getValue("meetingId")}/active-transcript`)).data.data;try{return{transcript:(await this.axios.get(t)).data}}catch(e){throw new b("Cant fetch transcript s3 url")}}async getRoomNodeData(){const t=await this.getIPDetails();if(this.ipInfo=t,this.roomDetails)return this.roomDetails;const{roomNodeLink:e,title:r,useHiveMedia:n,sfu:i}=wr((await this.requests.post("v2/internals/rooms",{ip_information:t})).data.data);return{roomNodeUrl:e,meetingTitle:r,useHiveMedia:n!=null?n:!1,sfu:i}}}Br([g.trace("APIClient.startLivestreaming")],Cr.prototype,"startLivestreaming",1),Br([g.trace("APIClient.stopLivestreaming")],Cr.prototype,"stopLivestreaming",1),Br([g.trace("APIClient.getActiveLivestream")],Cr.prototype,"getActiveLivestream",1),Br([g.trace("APIClient.getUserDetails")],Cr.prototype,"getUserDetails",1),Br([g.trace("APIClient.startRecording")],Cr.prototype,"startRecording",1),Br([g.trace("APIClient.stopRecording")],Cr.prototype,"updateRecording",1),Br([g.trace("APIClient.getActiveRecording")],Cr.prototype,"getActiveRecording",1),Br([g.trace("APIClient.getActiveTranscript")],Cr.prototype,"getActiveTranscript",1),Br([g.trace("APIClient.getRoomNodeData")],Cr.prototype,"getRoomNodeData",1);let ru;function LM(s,t){return ru=new Cr(s,t),ru}function Je(){return ru}function FM(s,t){return`<blockquote>${t.replace(/<blockquote>[.\s\S]*<\/blockquote>\n\n/m,"")}</blockquote>

${s}`}function Ot(s,t){return function(e,r,n){const i=n.value;let a=0,o=Date.now();return n.value=function(...c){const u=Date.now(),h=t?this[t]:s;if(u-o>h.period*1e3&&(o=u,a=0),a>=h.maxInvocations)throw new b(`Method rate limit ${h.maxInvocations} invocations/${h.period}sec exceeded`);return a+=1,i.apply(this,c)},n}}var xM=Object.defineProperty,UM=Object.getOwnPropertyDescriptor,gt=(s,t,e,r)=>{for(var n=r>1?void 0:r?UM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&xM(t,e,n),n};const $M=["text","image","file","custom","poll"],Lc={maxInvocations:180,period:60};let at=(Sv=class extends Ht{constructor(t,e,r,n,i){super();S(this,hd);m(this,"messages");m(this,"channels",[]);S(this,re,void 0);S(this,Cn,void 0);S(this,Ze,void 0);S(this,bn,void 0);S(this,Aa,void 0);m(this,"maxTextLimit",2e3);T(this,Aa,t),T(this,Ze,e),T(this,bn,r),T(this,re,n),T(this,Cn,i),this.messages=[]}setMaxTextLimit(t){this.maxTextLimit=t}get roomJoined(){var t;return((t=d(this,hd,$v))==null?void 0:t.roomJoined)===!0}async sendMessageInternal(t,e,r,n={}){switch(t.type){case"text":{const i=n.replyTo&&n.replyTo.type==="text"?FM(t.message,n.replyTo.message):t.message;await this.sendTextMessageInternal(i,e,r);break}case"image":await this.sendImageMessageInternal(t.image,e,r);break;case"file":await this.sendFileMessageInternal(t.file,e,r);break;default:l.error("sendMessage::message_type_not_supported",{dyteChat:{messageType:t.type}});break}}async sendTextMessageInternal(t,e,r){var i,a,o,c,u,h;if(t.length>this.maxTextLimit)throw new b("Max character limit breached");if(e&&e.length>0){if(!((i=d(this,re).permissions)!=null&&i.chatPrivate.canSend)||!((a=d(this,re).permissions)!=null&&a.chatPrivate.text))throw l.error("sendTextMessage::private_chat_permission_denied"),new b("Could not send message to private chat.","0501")}else if(!((c=(o=d(this,re).permissions)==null?void 0:o.chatPublic)!=null&&c.canSend)||!((h=(u=d(this,re).permissions)==null?void 0:u.chatPublic)!=null&&h.text))throw l.error("sendTextMessage::public_chat_permission_denied"),new b("Could not send message to public chat.","0501");if(!t)throw l.error("sendTextMessage::message_can_not_be_empty"),new b("Message can not be empty.","0502");if(r){d(this,Ze).sendMessageToChannel(t,bt.TEXT,r);return}let n=[];e&&e.length>0&&(e.push(d(this,re).id),n=d(this,Cn).joined.toArray().filter(p=>e.includes(p.id)).map(p=>p.userId),n.push(d(this,re).userId)),d(this,Ze).sendMessage(t,bt.TEXT,e)}async sendImageMessageInternal(t,e,r){var i,a,o,c,u,h;if(e&&e.length>0){if(!((i=d(this,re).permissions)!=null&&i.chatPrivate.canSend)||!((a=d(this,re).permissions)!=null&&a.chatPrivate.files)){l.error("sendImageMessage::private_chat_permission_denied");return}}else if(!((c=(o=d(this,re).permissions)==null?void 0:o.chatPublic)!=null&&c.canSend)||!((h=(u=d(this,re).permissions)==null?void 0:u.chatPublic)!=null&&h.files)){l.error("sendImageMessage::permission_denied");return}if(!t){l.error("sendImageMessage::required_argument_image_can_not_be_empty");return}if(!["image/gif","image/jpeg","image/png"].includes(t.type)){l.error("sendImageMessage::image_type_not_supported",{dyteChat:{imageType:t.type}});return}try{const p=Je(),{getLocation:f,putLocation:v}=await p.getPresignedUrls(t.name,d(this,re).config.viewType);if(await p.uploadFile(t,v),r){d(this,Ze).sendMessageToChannel(f,bt.IMAGE,r);return}let y=[];e&&e.length>0&&(e.push(d(this,re).id),y=d(this,Cn).joined.toArray().filter(P=>e.includes(P.id)).map(P=>P.userId),y.push(d(this,re).userId)),d(this,Ze).sendMessage(f,bt.IMAGE,e)}catch(p){throw new b("Error sending image message.")}}async sendFileMessageInternal(t,e,r){var n,i,a,o,c,u;if(e&&e.length>0){if(!((n=d(this,re).permissions)!=null&&n.chatPrivate.canSend)||!((i=d(this,re).permissions)!=null&&i.chatPrivate.files)){l.error("sendFileMessage::private_chat_permission_denied");return}}else if(!((o=(a=d(this,re).permissions)==null?void 0:a.chatPublic)!=null&&o.canSend)||!((u=(c=d(this,re).permissions)==null?void 0:c.chatPublic)!=null&&u.files)){l.error("sendFileMessage::permission_denied");return}if(!t){l.error("sendFileMessage::required_argument_file_can_not_be_empty");return}try{const h=Je(),{getLocation:p,putLocation:f}=await h.getPresignedUrls(t.name,d(this,re).config.viewType);if(await h.uploadFile(t,f),r){d(this,Ze).sendMessageToChannel(JSON.stringify({link:p,name:t.name,size:"size"in t?t.size:0}),bt.FILE,r);return}let v=[];e&&e.length>0&&(e.push(d(this,re).id),v=d(this,Cn).joined.toArray().filter(P=>e.includes(P.id)).map(P=>P.userId),v.push(d(this,re).userId));const y=JSON.stringify({link:p,name:t.name,size:"size"in t?t.size:0});d(this,Ze).sendMessage(y,bt.FILE,e)}catch(h){throw new b("Error sending file message.")}}get rateLimits(){return Lc}updateRateLimits(t,e){Lc.maxInvocations=t,Lc.period=e}async sendTextMessage(t,e){return this.sendTextMessageInternal(t,e)}async sendCustomMessage(t,e){var i,a,o,c,u,h,p,f,v,y,P,k,I,x,$;if(e&&e.length>0){if(!((i=d(this,re).permissions)!=null&&i.chatPrivate.canSend)||!((a=d(this,re).permissions)!=null&&a.chatPrivate.files)||!((o=d(this,re).permissions)!=null&&o.chatPrivate.text)){l.error("sendCustomMessage::private_chat_permission_denied");return}}else if(!((u=(c=d(this,re).permissions)==null?void 0:c.chatPublic)!=null&&u.canSend)||!((p=(h=d(this,re).permissions)==null?void 0:h.chatPublic)!=null&&p.files)||!((v=(f=d(this,re).permissions)==null?void 0:f.chatPublic)!=null&&v.text)){l.error("sendCustomMessage::permission_denied");return}const r=async O=>{try{if(typeof O=="string")return{link:O};const K=Je(),{getLocation:X,putLocation:oe}=await K.getPresignedUrls(O.name,d(this,re).config.viewType);return await K.uploadFile(O,oe),{link:X,type:O.type,name:O.name,size:O.size}}catch(K){throw new b("Error sending image message.")}},n={...t,files:await Promise.all((P=(y=t.files)!=null?y:[])==null?void 0:P.map(async O=>r(O))),images:await Promise.all((I=(k=t.images)!=null?k:[])==null?void 0:I.map(async O=>r(O))),videos:await Promise.all(($=(x=t.videos)!=null?x:[])==null?void 0:$.map(async O=>r(O)))};d(this,Ze).sendMessage(JSON.stringify(n),bt.CUSTOM,e)}async sendImageMessage(t,e){return this.sendImageMessageInternal(t,e)}async sendFileMessage(t,e){return this.sendFileMessageInternal(t,e)}async sendMessage(t,e){return this.sendMessageInternal(t,e)}async editTextMessage(t,e,r){var n,i,a,o,c,u;if(((i=(n=d(this,re).permissions)==null?void 0:n.chatMessage)==null?void 0:i.canEdit)==="NONE")throw new b("Not permitted to edit messages","0501");if(!((o=(a=d(this,re).permissions)==null?void 0:a.chatPublic)!=null&&o.canSend)||!((u=(c=d(this,re).permissions)==null?void 0:c.chatPublic)!=null&&u.text)){l.error("editTextMessage::permission_denied");return}if(!e){l.error("editTextMessage::message_can_not_be_empty");return}d(this,Ze).editMessage(t,e,bt.TEXT,r)}async editImageMessage(t,e,r){var i,a,o,c;if(!((a=(i=d(this,re).permissions)==null?void 0:i.chatPublic)!=null&&a.canSend)||!((c=(o=d(this,re).permissions)==null?void 0:o.chatPublic)!=null&&c.files)){l.error("editImageMessage::permission_denied");return}if(!e){l.error("editImageMessage::required_argument_image_can_not_be_empty");return}if(!["image/gif","image/jpeg","image/png"].includes(e.type)){l.error("sendImageMessage::image_type_not_supported",{dyteChat:{imageType:e.type}});return}try{const u=Je(),{getLocation:h,putLocation:p}=await u.getPresignedUrls(e.name,d(this,re).config.viewType);await u.uploadFile(e,p),d(this,Ze).editMessage(t,h,bt.IMAGE,r)}catch(u){throw new b("Error editing image message.")}}async editFileMessage(t,e,r){var n,i,a,o;if(!((i=(n=d(this,re).permissions)==null?void 0:n.chatPublic)!=null&&i.canSend)||!((o=(a=d(this,re).permissions)==null?void 0:a.chatPublic)!=null&&o.files)){l.error("sendFileMessage::permission_denied");return}if(!e){l.error("sendFileMessage::required_argument_file_can_not_be_empty");return}try{const c=Je(),{getLocation:u,putLocation:h}=await c.getPresignedUrls(e.name,d(this,re).config.viewType);await c.uploadFile(e,h),d(this,Ze).editMessage(t,JSON.stringify({link:u,name:e.name,size:"size"in e?e.size:0}),bt.FILE,r)}catch(c){throw new b("Error editing file message.")}}async editMessage(t,e,r){switch(e.type){case"text":{this.editTextMessage(t,e.message,r);break}case"image":{this.editImageMessage(t,e.image,r);break}case"file":{this.editFileMessage(t,e.file,r);break}default:{l.error("editMessage::message_type_not_supported",{dyteChat:{messageType:e.type}});break}}}async deleteMessage(t,e){var r,n;if(((n=(r=d(this,re).permissions)==null?void 0:r.chatMessage)==null?void 0:n.canDelete)==="NONE")throw new b("Not permitted to delete messages","0501");d(this,Ze).deleteMessage(t,e)}getMessagesByUser(t){return this.messages.filter(e=>e.userId===t)}getMessagesByType(t){return this.messages.filter(e=>e.type===t)}async pin(t){if(!this.roomJoined)throw new b("Can`t pin message without joining room");if(!d(this,re).permissions.pinParticipant)throw new b("You do not have permission to pin messages.");const e=this.messages.find(r=>r.id===t);if(e){d(this,Ze).setPinState(e,!0);return}throw new b(`No message found with id: ${t}`)}async unpin(t){if(!this.roomJoined)throw new b("Can`t unpin message without joining room");if(!d(this,re).permissions.pinParticipant)throw new b("You do not have permission to unpin messages.");const e=this.messages.find(r=>r.id===t);if(e){d(this,Ze).setPinState(e,!1);return}throw new b(`No message found with id: ${t}`)}async getMessages(t,e,r,n=0,i=void 0){const a=await d(this,Ze).getChatMessagesPaginated(t,e,r,n,i);return{messages:a.messages.map(o=>ur.formatSocketServiceMessage(o)),next:a.next}}async createChannel(t,e,r={}){var o;const n=(o=d(this,re).permissions)==null?void 0:o.chatChannel;if(n){if(n.canCreate==="NONE")throw new b("Not permitted to create channels","0501");if(r.visibility==="public"&&!(n.canCreate==="PUBLIC"||n.canCreate==="ALL"))throw new b("Not permitted to create public channels","0501");if(r.visibility==="private"&&!(n.canCreate==="PRIVATE"||n.canCreate==="ALL"))throw new b("Not permitted to create private channels","0501")}if(!t||t.trim().length===0)throw new b("channel name cannot be empty.","0510");const i=[...new Set([...e,d(this,re).userId])];return await d(this,bn).createChannel(t.trim(),i,r.displayPictureUrl,r.visibility,r.isDirectMessage)}updateChannel(t,e){var a,o,c,u,h;const r=this.channels.find(p=>p.id===t),n=(a=d(this,re).permissions)==null?void 0:a.chatChannel;if(n){if(n.canUpdate==="NONE")throw new b("Not permitted to update channels","0501");if(r.visibility==="public"&&!(n.canUpdate==="PUBLIC"||n.canUpdate==="ALL"))throw new b("Not permitted to update public channels","0501");if(r.visibility==="private"&&!(n.canUpdate==="PRIVATE"||n.canUpdate==="ALL"))throw new b("Not permitted to update private channels","0501")}const i={memberIds:(o=e.memberIds)!=null?o:r.memberIds,displayName:(c=e.displayName)!=null?c:r.displayName,displayPictureUrl:(u=e.displayPictureUrl)!=null?u:r.displayPictureUrl,visibility:(h=e.visibility)!=null?h:r.visibility};return d(this,bn).updateChannel(t,i)}async sendMessageToChannel(t,e,r={}){return this.sendMessageInternal(t,null,e,r)}async getChannelMembers(t){return d(this,bn).getChannelMembers(t)}async searchMessages(t,e={}){if(!j.hasFeature(J.FEAT_CHAT_SDK_SEARCH))throw new b("searchMessages is temporarily disabled!");return(await d(this,Ze).searchMessages(t,e)).map(ur.formatSocketServiceMessage)}async markLastReadMessage(t,e){await d(this,Ze).markLastReadMessage(t,e);const r=this.channels.find(n=>n.id===t);if(r){const n={...r,unreadCount:0};this.channels=this.channels.map(i=>i.id===t?n:i),this.emit("channelMessageUpdate",n)}}get pinned(){return this.messages.filter(t=>t.pinned)}},re=new WeakMap,Cn=new WeakMap,Ze=new WeakMap,bn=new WeakMap,Aa=new WeakMap,hd=new WeakSet,$v=function(){return d(this,Aa).getValue("roomNodeClient")},Sv);gt([g.trace("DyteChat.sendTextMessage"),Ot(Lc)],at.prototype,"sendTextMessage",1),gt([g.trace("DyteChat.sendImageMessage"),Ot({maxInvocations:20,period:60})],at.prototype,"sendImageMessage",1),gt([g.trace("DyteChat.sendFileMessage"),Ot({maxInvocations:20,period:60})],at.prototype,"sendFileMessage",1),gt([g.trace("DyteChat.sendMessage"),Ot({maxInvocations:180,period:60})],at.prototype,"sendMessage",1),gt([g.trace("DyteChat.editTextMessage")],at.prototype,"editTextMessage",1),gt([g.trace("DyteChat.editImageMessage")],at.prototype,"editImageMessage",1),gt([g.trace("DyteChat.editFileMessage")],at.prototype,"editFileMessage",1),gt([g.trace("DyteChat.editMessage")],at.prototype,"editMessage",1),gt([g.trace("DyteChat.deleteMessage")],at.prototype,"deleteMessage",1),gt([g.trace("DyteChat.createChannel")],at.prototype,"createChannel",1),gt([g.trace("DyteChat.updateChannel")],at.prototype,"updateChannel",1),gt([g.trace("DyteChat.sendMessageToChannel")],at.prototype,"sendMessageToChannel",1),gt([g.trace("DyteChat.getChannelMembers")],at.prototype,"getChannelMembers",1),gt([g.trace("DyteChat.searchMessages")],at.prototype,"searchMessages",1),gt([g.trace("DyteChat.markLastReadMessage")],at.prototype,"markLastReadMessage",1),at=gt([mt("0500")],at);var C=(s=>(s.NEW_PRODUCER="NEW_PRODUCER",s.PRODUCER_TRACK_ENDED="PRODUCER_TRACK_ENDED",s.ROOM_NODE_CONNECTION_ERROR="ROOM_NODE_CONNECTION_ERROR",s.SOCKET_SERVICE_ROOM_JOINED="SOCKET_SERVICE_ROOM_JOINED",s.SOCKET_SERVICE_RECONNECTED="SOCKET_SERVICE_RECONNECTED",s.SOCKET_SERVICE_DISCONNECTED="SOCKET_SERVICE_DISCONNECTED",s.SOCKET_SERVICE_FAILED="SOCKET_SERVICE_FAILED",s.SOCKET_STATE_UPDATE="SOCKET_STATE_UPDATE",s.ROOM_NODE_RECONNECTED="ROOM_NODE_RECONNECTED",s.ROOM_NODE_DISCONNECTED="ROOM_NODE_DISCONNECTED",s.ROOM_NODE_FAILED="ROOM_NODE_FAILED",s.TRANSPORT_STATE_UPDATE="TRANSPORT_STATE_UPDATE",s.PRODUCER_SCORE_UPDATE="PRODUCER_SCORE_UPDATE",s.CONSUMER_SCORE_UPDATE="CONSUMER_SCORE_UPDATE",s.PRODUCER_STATUS_UPDATE="PRODUCER_STATUS_UPDATE",s.CONSUMER_STATUS_UPDATE="CONSUMER_STATUS_UPDATE",s.LOW_PRODUCER_SCORE="LOW_PRODUCER_SCORE",s.LOW_CONSUMER_SCORE="LOW_CONSUMER_SCORE",s.MEDIA_PERMISSION_ERROR="MEDIA_PERMISSION_ERROR",s.MEDIA_PERMISSION_UPDATE="MEDIA_PERMISSION_UPDATE",s.WAITLISTED="WAIT_LISTED",s.MESSAGE="websocket/message",s.ROOM_MESSAGE="websocket/room-message",s.PEER_JOINED_INTERNAL="peer/joined-internal",s.PEER_CLOSED="websocket/peer-closed",s.CONSUMER_CLOSED="websocket/consumer-closed",s.CONSUMER_PAUSED="websocket/consumer-paused",s.CONSUMER_RESUMED="websocket/consumer-resumed",s.PRODUCER_CLOSED="websocket/producer-closed",s.NEW_CONSUMER="websocket/new-consumer",s.PRODUCER_SCORE="websocket/producer-score",s.CONSUMER_SCORE="websocket/consumer-score",s.PRODUCER_TOGGLE="hive/producer-toggle",s.CONSUMER_TOGGLE="hive/consumer-toggle",s.SELECTED_PEERS_DIFF="hive/selected-peers-diff",s.REFRESH_GRID="hive/refresh-grid",s.UPDATE_ACTIVE="media/update-active",s.RESET_PRODUCER_STATE="hive/reset-producer-state",s.CF_TRANSPORT_STATE_CHANGED="cf/transport-state-changed",s.CF_ROOM_REJOINING="cf/room-rejoining",s.CF_ROOM_REJOIN_FAILED="cf/room-rejoining-failed",s.CF_ROOM_REJOINED="cf/room-rejoined",s.CF_TRANPSORT_RECONNECTING="cf/transport-reconnecting",s.ROOM_STATE="sockethub/room-state",s.PEER_DISPLAY_NAME_CHANGED="hive/display-name-changed",s.GET_STAGE_REQUESTS="GET_STAGE_REQUESTS",s.UPDATE_STAGE_REQUESTS="UPDATE_STAGE_REQUESTS",s.KICK_PEER="KICK_PEER",s.UPDATE_PEER_STAGE_STATUS="UPDATE_PEER_STAGE_STATUS",s.JOIN_MEDIA_ROOM="JOIN_MEDIA_ROOM",s.LEAVE_MEDIA_ROOM="LEAVE_MEDIA_ROOM",s.PIP_HANGUP="PIP_HANGUP",s.E2EE_ACTIVE_PRODUCER="E2EE_ACTIVE_PRODUCER",s.E2EE_INACTIVE_PRODUCER="E2EE_INACTIVE_PRODUCER",s.E2EE_ACTIVE_CONSUMER="E2EE_ACTIVE_CONSUMER",s.E2EE_INACTIVE_CONSUMER="E2EE_INACTIVE_CONSUMER",s.SOCKET_PEERS="SOCKET_PEERS",s.UPDATE_PERMISSIONS="UPDATE_PERMISSIONS",s.MAX_SPATIAL_LAYER_CHANGE="MAX_SPATIAL_LAYER_CHANGE",s.MUTE_SELF="MUTE_SELF",s.MUTE_SELF_VIDEO="MUTE_SELF_VIDEO",s))(C||{}),VM=Object.defineProperty,BM=Object.getOwnPropertyDescriptor,HM=(s,t,e,r)=>{for(var n=r>1?void 0:r?BM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&VM(t,e,n),n};const cn=(Ev=class{constructor(s,t,e,r,n){m(this,"chat");m(this,"chatSocketHandler");m(this,"chatChannelSocketHandler");m(this,"self");S(this,pd,void 0);T(this,pd,s),this.chatSocketHandler=t,this.chatChannelSocketHandler=e,this.chat=new at(s,t,e,r,n),this.self=r,this.setupEvents()}static async init(s,t,e,r,n){return new cn(s,t,e,r,n)}static formatMessage(s){return{...s,time:new Date(s.time),type:$M[s.type]}}static formatSocketServiceMessage(s){const t=s.createdAt*1e3,e={displayName:s.displayName,id:s.chatId,time:t,timeMs:s.createdAtMs,type:s.payloadType,isEdited:s.isEdited,userId:s.userId,targetUserIds:s.targetUserIds,channelId:s.channelId,channelIndex:s.channelIndex,message:"",link:"",name:"",html:"",images:[],videos:[],files:[],size:0,pinned:s.pinned};switch(e.type){case bt.TEXT:{e.message=s.payload;break}case bt.IMAGE:{e.link=s.payload;break}case bt.FILE:{const{link:r,name:n,size:i}=JSON.parse(s.payload);e.link=r,e.name=n,e.size=i;break}case bt.CUSTOM:{const{html:r,images:n,message:i,videos:a,files:o}=JSON.parse(s.payload);e.message=i,e.html=r,e.images=n,e.videos=a,e.files=o;break}}return cn.formatMessage(e)}async getChatMessages(){if(this.self.config.viewType==="LIVESTREAM"||this.self.config.viewType==="CHAT"||j.hasFeature(J.FEAT_PAGINATED_CHAT))return;const s=await this.chatSocketHandler.getChatMessages();if(!(s!=null&&s.payload))return;const t=Bf.fromBinary(s.payload).messages;this.chat.messages=t.map(e=>cn.formatSocketServiceMessage(e))}setupEvents(){w.on(C.SOCKET_SERVICE_ROOM_JOINED,async()=>{this.getChatMessages()}),this.chatSocketHandler.on(Ve.sendMessageToRoom,s=>{const t=cn.formatSocketServiceMessage(s.message);if(!t.channelId)this.chat.messages=[...this.chat.messages,t];else{const e=this.chat.channels.find(r=>r.id===t.channelId);e&&(e.latestMessage=t,e.unreadCount+=1,this.chat.emit("channelMessageUpdate",e))}this.chat.emit("chatUpdate",{action:"add",message:t,messages:this.chat.messages})}),this.chatSocketHandler.on(Ve.sendMessageToPeers,s=>{const t=cn.formatSocketServiceMessage(s.message);this.chat.messages=[...this.chat.messages,t],this.chat.emit("chatUpdate",{action:"add",message:t,messages:this.chat.messages})}),this.chatSocketHandler.on(Ve.editMessage,s=>{const t=cn.formatSocketServiceMessage(s.message);if(t.channelId){this.chat.emit("chatUpdate",{action:"edit",message:t,messages:this.chat.messages});return}const e=this.chat.messages.findIndex(r=>r.id===t.id);e!==-1&&(this.chat.messages[e]=t,this.chat.emit("chatUpdate",{action:"edit",message:t,messages:this.chat.messages}))}),this.chatSocketHandler.on(Ve.deleteMessage,s=>{if(s.channelId){this.chat.emit("chatUpdate",{action:"delete",message:{id:s.chatId,channelId:s.channelId},messages:this.chat.messages});return}const t=this.chat.messages.findIndex(r=>r.id===s.chatId);if(t===-1)return;const[e]=this.chat.messages.splice(t,1);this.chat.emit("chatUpdate",{action:"delete",message:e,messages:this.chat.messages})}),this.chatChannelSocketHandler.on(an.createChatChannel,s=>{const[t]=s.chatChannels,e=on.formatChannel(t);this.chat.channels.push(e),this.chat.emit("channelCreate",e)}),this.chatSocketHandler.on(Ve.pinMessage,s=>{const t=this.chat.messages.findIndex(r=>r.id===s.chatId);if(t===-1)return;const e=this.chat.messages[t];e.pinned=s.pinned,this.chat.messages[t]=e,this.chat.emit("chatUpdate",{action:"edit",message:e,messages:this.chat.messages})}),this.chatChannelSocketHandler.on(an.updateChatChannel,s=>{const[t]=s.chatChannels,e=on.formatChannel(t);this.chat.channels=this.chat.channels.map(r=>r.id===e.id?e:r),this.chat.emit("channelUpdate",e)})}},pd=new WeakMap,Ev);let ur=cn;HM([g.trace("ChatController.setupEvents")],ur.prototype,"setupEvents",1);var qM=Object.defineProperty,jM=Object.getOwnPropertyDescriptor,GM=(s,t,e,r)=>{for(var n=r>1?void 0:r?jM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&qM(t,e,n),n};let su=(wv=class extends Ht{constructor(t,e,r){super();S(this,md);m(this,"items");S(this,Pn,void 0);S(this,fi,void 0);S(this,Ma,void 0);T(this,Ma,t),T(this,Pn,e),T(this,fi,r),this.items=[]}get roomJoined(){var t;return((t=d(this,md,Vv))==null?void 0:t.roomJoined)===!0}async create(t,e,r=!1,n=!1){if(d(this,Pn).config.viewType!=="LIVESTREAM"&&!this.roomJoined)throw new b("Can't create polls without joining room");if(!d(this,Pn).permissions.polls.canCreate){l.error("DytePolls::create::permission_denied");return}if(!t||!e){l.error("DytePolls::question_and_options_can_not_be_empty",{dytePolls:{hasQuestion:!!t,optionsLength:e==null?void 0:e.length}});return}if(e.length<2){l.error("DytePolls::there_must_be_at_least_two_options",{dytePolls:{hasQuestion:!!t,optionsLength:e.length}});return}await d(this,fi).createPoll(t,e,r,n)}async vote(t,e){if(!d(this,Pn).permissions.polls.canVote){l.error("DytePolls::vote::permission_denied");return}await d(this,fi).votePoll(t,e)}},md=new WeakSet,Vv=function(){return d(this,Ma).getValue("roomNodeClient")},Pn=new WeakMap,fi=new WeakMap,Ma=new WeakMap,wv);su=GM([mt("0700")],su);var WM=Object.defineProperty,JM=Object.getOwnPropertyDescriptor,KM=(s,t,e,r)=>{for(var n=r>1?void 0:r?JM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&WM(t,e,n),n};const Zn=(Cv=class{constructor(s,t,e){m(this,"polls");S(this,gi,void 0);S(this,Rn,void 0);this.polls=new su(s,t,e),T(this,gi,t),T(this,Rn,e),this.setupEvents()}static async init(s,t,e){return new Zn(s,t,e)}canViewPolls(){return d(this,gi).permissions.polls.canView}setupEvents(){const s={[Vr.createPoll]:r=>{r.poll&&this.updatePoll(Zn.formatSocketServicePoll(r.poll))},[Vr.updatePoll]:r=>{r.poll&&this.updatePoll(Zn.formatSocketServicePoll(r.poll))},[Vr.votePoll]:r=>{r.poll&&this.updatePoll(Zn.formatSocketServicePoll(r.poll))}},t=()=>{w.on(C.SOCKET_SERVICE_ROOM_JOINED,()=>{this.getPolls()}),Object.keys(s).map(Number).forEach(r=>{d(this,Rn).on(r,s[r])})},e=()=>{w.on(C.SOCKET_SERVICE_ROOM_JOINED,()=>{this.getPolls()}),Object.keys(s).map(Number).forEach(r=>{d(this,Rn).removeListeners(r)})};d(this,gi).permissions.on("permissionsUpdate",async r=>{var n;(n=r==null?void 0:r.polls)!=null&&n.canView?(await this.getPolls(),t()):(this.polls.items=[],e())}),this.canViewPolls()&&t()}updatePoll(s){if(!this.canViewPolls())return;const t=this.polls.items.findIndex(e=>e.id===s.id);if(t>-1){const e=JSON.stringify(this.polls.items[t]);this.polls.items[t]=s,e!==JSON.stringify(s)&&this.polls.emit("pollsUpdate",{polls:this.polls.items,newPoll:!1});return}this.polls.items=[...this.polls.items,s],this.polls.emit("pollsUpdate",{polls:this.polls.items,newPoll:!0})}async getPolls(){const s=await d(this,Rn).getPolls();if(!(s!=null&&s.payload))return;const{polls:t}=aM.fromBinary(s.payload);this.polls.items=t.map(e=>Zn.formatSocketServicePoll(e))}static formatSocketServicePoll(s){const t=s.options.map(e=>({count:e.count,text:e.text,votes:e.votes.map(r=>({id:r.userId,name:r.name}))}));return{anonymous:s.anonymous,createdBy:s.createdBy,createdByUserId:s.createdByUserId,hideVotes:s.hideVotes,id:s.pollId,options:t,question:s.question,voted:s.votes}}},gi=new WeakMap,Rn=new WeakMap,Cv);let eg=Zn;KM([g.trace("PollController.setupEvents")],eg.prototype,"setupEvents",1);var zM=Object.defineProperty,YM=Object.getOwnPropertyDescriptor,QM=(s,t,e,r)=>{for(var n=r>1?void 0:r?YM(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&zM(t,e,n),n},tg=(s=>(s[s.User=0]="User",s[s.Meeting=1]="Meeting",s))(tg||{});let nu=(bv=class extends Ht{constructor(t,e,r,n,i){super();S(this,vi);m(this,"selfActiveTab");m(this,"broadcastTabChanges");S(this,Da,void 0);S(this,kn,void 0);S(this,Oa,void 0);m(this,"viewType");m(this,"meetingStartedTimestamp");m(this,"meetingTitle");m(this,"sessionId");T(this,Da,t),T(this,kn,e),this.viewType=r,T(this,Oa,n),this.meetingTitle=i,this.broadcastTabChanges=e.permissions.canSpotlight}get socketState(){var t;return(t=d(this,vi,Id))==null?void 0:t.socketState}get mediaState(){var t;return(t=d(this,vi,Id))==null?void 0:t.mediaState}get meetingId(){var t;return(t=d(this,vi,Id))==null?void 0:t.roomName}setBroadcastTabChanges(t){if(!d(this,kn).permissions.canSpotlight)throw l.error("DyteSpotlight::setSpotlighted::permission_denied"),new b("User does not have permission to toggle spotlight");this.broadcastTabChanges=t,this.emit("broadcastTabChangesUpdate",this.broadcastTabChanges),this.broadcastTabChanges&&this.assertActiveTabToRoom()}setSelfActiveTab(t,e){var r;l.info("DyteSpotlight::setActiveTab",{spotlight:{currentTab:{id:t.id,type:t.type}}}),this.selfActiveTab=t,e===0&&this.emit("selfTabUpdate",t),(r=d(this,kn).permissions)!=null&&r.canSpotlight&&this.broadcastTabChanges&&e===0&&this.assertActiveTabToRoom()}assertActiveTabToRoom(){d(this,Oa).broadcastMessage("spotlight",{userId:d(this,kn).userId,currentTab:this.selfActiveTab})}},Da=new WeakMap,vi=new WeakSet,Id=function(){return d(this,Da).getValue("roomNodeClient")},kn=new WeakMap,Oa=new WeakMap,bv);nu=QM([mt("0800")],nu);function XM(s){let t="",e=[""];const r=[e];let n=0,i=0,a=!0,o;for(o of s)o==='"'?(a&&o===t&&(e[n]+=o),a=!a):o===","&&a?o=e[++n]="":o===`
`&&a?(t==="\r"&&(e[n]=e[n].slice(0,-1)),e=r[++i]=[o=""],n=0):e[n]+=o,t=o;return r}var ZM=Object.defineProperty,e0=Object.getOwnPropertyDescriptor,rg=(s,t,e,r)=>{for(var n=r>1?void 0:r?e0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&ZM(t,e,n),n};let ms=class extends Ht{constructor(){super();m(this,"transcripts");this.transcripts=[]}static async init(t){const e=new ms;try{t&&e.getActiveTranscript()}catch(r){l.error("Error fetching active transcriptions ",r)}return e}static parseTranscript(t,e=!1){try{if(!t)return;const[[r,n,i,a,o,c]]=XM(t);return{id:Ys(),name:o,peerId:n,userId:i,customParticipantId:a,transcript:c,isPartialTranscript:e,date:new Date(parseInt(r,10)*1e3)}}catch(r){l.error(`Failed to parse transcript: ${t}`,r);return}}static parseTranscripts(t){return t?t.split(`
`).map(e=>ms.parseTranscript(e,!1)).filter(Boolean):[]}async getActiveTranscript(){try{const t=Je(),{transcript:e}=await t.getActiveTranscript();this.transcripts=ms.parseTranscripts(e)}catch(t){}}async onTranscript(t){var r;const e=this.transcripts.filter(({peerId:n})=>n===t.peerId);if((r=e==null?void 0:e.at(-1))!=null&&r.isPartialTranscript){const n=e.at(-1);n.transcript=t.transcript,n.isPartialTranscript=t.isPartialTranscript,this.emit("transcript",n);return}this.transcripts.push(t),this.emit("transcript",t)}};rg([g.trace("DyteAi.getActiveTranscript")],ms.prototype,"getActiveTranscript",1),ms=rg([mt("0000")],ms);var t0=Object.defineProperty,r0=Object.getOwnPropertyDescriptor,s0=(s,t,e,r)=>{for(var n=r>1?void 0:r?r0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&t0(t,e,n),n};const sg=(Pv=class{constructor(s,t,e,r,n,i){m(this,"meta");m(this,"ai");S(this,bs,void 0);S(this,yi,void 0);m(this,"aiSocketHandler");S(this,fd,void 0);T(this,fd,s),this.meta=new nu(s,t,t.config.viewType,e,i),this.ai=r,T(this,bs,t),T(this,yi,e),this.aiSocketHandler=n,t.config.viewType!==Xe.Chat&&this.setupEvents()}static async init(s,t,e,r,n){const i=await ms.init(t.permissions.transcriptionEnabled);return new sg(s,t,e,i,r,n)}conditionallySetActiveTab(s){var t;s!=null&&s.currentTab&&((t=this.meta.selfActiveTab)==null?void 0:t.id)!==s.currentTab.id&&(this.meta.setSelfActiveTab(s.currentTab,tg.Meeting),this.meta.emit("activeTabUpdate",s.currentTab))}setupEvents(){w.on(C.TRANSPORT_STATE_UPDATE,s=>{this.meta.emit("mediaConnectionUpdate",s)}),w.on(C.SOCKET_STATE_UPDATE,s=>{this.meta.emit("socketConnectionUpdate",s)}),w.on(C.ROOM_STATE,({createdAt:s,roomUuid:t})=>{const e=this.meta.meetingStartedTimestamp;if(t&&(this.meta.sessionId=t),s&&!e){const r=new Date(s*1e3);this.meta.meetingStartedTimestamp=r,this.meta.emit("meetingStartTimeUpdate",{meetingStartedTimestamp:this.meta.meetingStartedTimestamp})}}),w.on(C.PRODUCER_SCORE_UPDATE,({score:s})=>{s<5&&this.meta.emit("poorConnection",{score:s})}),d(this,bs).permissions.canSpotlight&&(l.info("DyteMetaController::Asserting Spotlight"),this.meta.selfActiveTab&&d(this,yi).broadcastMessage("spotlight",{userId:d(this,bs).userId,currentTab:this.meta.selfActiveTab})),w.on(C.PEER_JOINED_INTERNAL,async s=>{d(this,bs).permissions.canSpotlight&&this.meta.selfActiveTab&&d(this,yi).broadcastToPeers("spotlight",[s.id],{userId:d(this,bs).userId,currentTab:this.meta.selfActiveTab})}),w.on(C.ROOM_MESSAGE,s=>{var e,r;let t;if("type"in s){if(s.type!=="spotlight")return;t={...s,...s.payload}}else if("roomMessageType"in s){if(s.roomMessageType!=="spotlight")return;t=s}else return;l.info("Spotlight Assertion Received",{spotlight:{spotlighter:{id:t.userId},currentTab:{id:(e=t.currentTab)==null?void 0:e.id,type:(r=t.currentTab)==null?void 0:r.type}}}),this.conditionallySetActiveTab(t)}),w.on(C.MESSAGE,s=>{var e,r;let t;if("type"in s){if(s.type!=="spotlight")return;t={...s,...s.payload}}else if("roomMessageType"in s){if(s.roomMessageType!=="spotlight")return;t=s}else return;l.info("Spotlight Assertion Received",{spotlight:{spotlighter:{id:t.userId},currentTab:{id:(e=t.currentTab)==null?void 0:e.id,type:(r=t.currentTab)==null?void 0:r.type}}}),this.conditionallySetActiveTab(t)}),this.aiSocketHandler.on(V.transcript,s=>{const{meetingId:t,transcript:e,isPartial:r}=s,n=ms.parseTranscript(e,r);if(!n){l.warn("Received empty transcript data");return}this.ai.onTranscript(n),this.meta.emit("transcript",n);const{peerId:i,name:a,transcript:o}=n;l.debug(`${t} Received transcript for peer ${i} - ${a}: ${o}`)})}},bs=new WeakMap,yi=new WeakMap,fd=new WeakMap,Pv);let ng=sg;s0([g.trace("MetaController.setupEvents")],ng.prototype,"setupEvents",1);var n0=Object.defineProperty,i0=Object.getOwnPropertyDescriptor,dn=(s,t,e,r)=>{for(var n=r>1?void 0:r?i0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&n0(t,e,n),n};class fs extends Ht{constructor(e,r,n,i,a){super();S(this,_i);S(this,Qt,void 0);S(this,Ti,void 0);S(this,Ie,void 0);S(this,Na,void 0);S(this,Pr,void 0);S(this,mr,void 0);T(this,mr,e),T(this,Qt,i),T(this,Ti,a),T(this,Ie,r),T(this,Na,n),T(this,Pr,[]),this.setupEvents()}get status(){return d(this,mr).getValue("stageStatus")}setupEvents(){const e={[C.GET_STAGE_REQUESTS]:async i=>{T(this,Pr,i)},[C.UPDATE_STAGE_REQUESTS]:async({add:i})=>{const a=d(this,Pr).length,{stageRequests:o}=this.getAccessRequests();(i||o.length>a)&&this.emit("newStageRequest",{count:o.length}),this.emit("stageAccessRequestUpdate",o)}},r=()=>{Object.entries(e).forEach(([i,a])=>{w.onAsync(i,a)})},n=()=>{Object.entries(e).forEach(([i,a])=>{w.removeListener(i,a)})};d(this,Ie).permissions.on("permissionsUpdate",i=>{const{canAcceptProductionRequests:a}=i;a!==void 0&&(d(this,Ie).permissions.acceptStageRequests?(r(),d(this,Qt).getStageRequests()):(n(),T(this,Pr,[]),this.emit("stageAccessRequestUpdate",d(this,Pr))))}),d(this,Ie).permissions.acceptStageRequests&&r()}getAccessRequests(){if(!d(this,Ie).permissions.stageEnabled)throw l.error("DyteStage::stage_disabled"),new b("Stage is disabled");if(!d(this,Ie).permissions.acceptStageRequests)throw l.error("DyteStage::get_access_request::permission_denied"),new b("You do not have permission to perform this action/");const e=d(this,Na).joined.toArray().filter(r=>r.stageStatus==="REQUESTED_TO_JOIN_STAGE").map(r=>({displayName:r.name,userId:r.userId,peerId:r.id}));return T(this,Pr,e),{stageRequests:d(this,Pr)}}async requestAccess(){if(!d(this,Ie).permissions.stageEnabled)throw l.error("DyteStage::stage_disabled"),new b("Stage is disabled");if(this.status!=="OFF_STAGE")throw new b(`Unable to request access you are currently ${this.status}`);if(d(this,Ie).permissions.stageAccess===H.Allowed){le(this,_i,Ad).call(this,"ACCEPTED_TO_JOIN_STAGE");return}d(this,Qt).requestAccess(),le(this,_i,Ad).call(this,"REQUESTED_TO_JOIN_STAGE")}async cancelRequestAccess(){if(!d(this,Ie).permissions.stageEnabled)throw l.error("DyteStage::stage_disabled"),new b("Stage is disabled");d(this,Qt).cancelRequestAccess(),le(this,_i,Ad).call(this,"OFF_STAGE")}grantAccess(e){if(!d(this,Ie).roomJoined)throw new b("Can`t rejectRequestToJoinStage for participant without joining room");if(!d(this,Ie).permissions.stageEnabled)throw l.error("DyteStage::stage_disabled"),new b("Stage is disabled");if(!d(this,Ie).permissions.acceptStageRequests)throw l.error("DyteStage::grant_access::permission_denied"),new b("You do not have permission to perform this action/");return d(this,Qt).grantAccess(e)}denyAccess(e){if(!d(this,Ie).roomJoined)throw new b("Can`t rejectRequestToJoinStage for participant without joining room");if(!d(this,Ie).permissions.stageEnabled)throw l.error("DyteStage::stage_disabled"),new b("Stage is disabled");if(!d(this,Ie).permissions.acceptStageRequests)throw l.error("DyteStage::deny_access::permission_denied"),new b("You do not have permission to perform this action/");return d(this,Qt).denyAccess(e)}async join(){const e=d(this,mr).getValue("viewType");if(this.status==="ON_STAGE")throw new b("You are already on stage.");if(this.status!=="ACCEPTED_TO_JOIN_STAGE"||d(this,Ie).permissions.stageAccess===H.NotAllowed)throw new b(`Unable to join stage you are currently ${this.status}`);if(await d(this,Qt).joinStage(),e===Xe.Livestream&&await d(this,Ti).joinRoom(d(this,Ie),e),d(this,mr).setValue("stageStatus","ON_STAGE",!1),await w.emitAsync(C.JOIN_MEDIA_ROOM),d(this,mr).notify("stageStatus"),e===Xe.Livestream){const{peers:r}=await d(this,Ti).getStagePeers();w.emit(C.SOCKET_PEERS,r)}}async leave(){if(!d(this,Ie).permissions.stageEnabled)throw l.error("DyteStage::stage_disabled"),new b("Stage is disabled");if(!(this.status==="ON_STAGE"||this.status==="ACCEPTED_TO_JOIN_STAGE"))throw new b(`Unable to leave stage you are currently ${this.status}`);d(this,Ie).setIsPinned(!1),await d(this,Qt).leaveStage(d(this,Ie).userId),d(this,mr).setValue("stageStatus","OFF_STAGE",!1),await w.emitAsync(C.LEAVE_MEDIA_ROOM,"stageLeft"),d(this,mr).notify("stageStatus")}async kick(e){if(!d(this,Ie).roomJoined)throw new b("Can`t kick participant without joining room");if(!d(this,Ie).permissions.stageEnabled)throw l.error("DyteStage::stage_disabled"),new b("Stage is disabled");if(!d(this,Ie).permissions.acceptStageRequests)throw l.error("DyteStage::kick::permission_denied"),new b("You do not have permissions for kick");return d(this,Qt).kick(e)}}Qt=new WeakMap,Ti=new WeakMap,Ie=new WeakMap,Na=new WeakMap,Pr=new WeakMap,mr=new WeakMap,_i=new WeakSet,Ad=async function(e){this.status!==e&&d(this,mr).setValue("stageStatus",e)},dn([g.trace("DyteStage.getStageRequests")],fs.prototype,"getAccessRequests",1),dn([g.trace("DyteStage.requestAccess")],fs.prototype,"requestAccess",1),dn([g.trace("DyteStage.cancelRequestAccess")],fs.prototype,"cancelRequestAccess",1),dn([g.trace("DyteStage.grantAccess")],fs.prototype,"grantAccess",1),dn([g.trace("DyteStage.denyAccess")],fs.prototype,"denyAccess",1),dn([g.trace("DyteStage.joinStage")],fs.prototype,"join",1),dn([g.trace("DyteStage.leaveStage")],fs.prototype,"leave",1);function a0(s){return!(s.viewType==="LIVESTREAM"||s.viewType==="CHAT")}function iu(s){switch(s){case Ur.UNSPECIFIED:return"OFF_STAGE";case Ur.REQUESTED_STAGE:return"REQUESTED_TO_JOIN_STAGE";case Ur.APPROVED_STAGE:return"ACCEPTED_TO_JOIN_STAGE";case Ur.OFF_STAGE:return"OFF_STAGE";case Ur.ON_STAGE:return"ON_STAGE";default:return"OFF_STAGE"}}var o0=Object.defineProperty,c0=Object.getOwnPropertyDescriptor,d0=(s,t,e,r)=>{for(var n=r>1?void 0:r?c0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&o0(t,e,n),n};class ig{constructor(t,e,r,n,i){m(this,"stage");S(this,Ps,void 0);S(this,In,void 0);S(this,Rs,void 0);S(this,La,0);S(this,zr,void 0);T(this,zr,t),this.stage=new fs(t,n,i,e,r),T(this,Rs,e),T(this,Ps,n),T(this,In,i),this.setupEvents()}setupEvents(){d(this,zr).subscribe("stageStatus",t=>{this.stage.emit("stageStatusUpdate",t)}),d(this,Rs).on(V.grantStageAccess,()=>{d(this,Ps).permissions.stageAccess!==H.Allowed&&(this.stage.emit("stageRequestApproved"),this.setStageStatus("ACCEPTED_TO_JOIN_STAGE"))}),d(this,Rs).on(V.peerStageStatusUpdate,t=>{t!==void 0&&(t.peerId===d(this,Ps).id?this.selfStageStatusHandler(t):this.peerStageStatusHandler(t))}),d(this,Rs).on(V.denyStageAccess,()=>{d(this,Ps).permissions.stageAccess!==H.Allowed&&(this.stage.emit("stageRequestRejected"),this.setStageStatus("OFF_STAGE"))}),d(this,Rs).on(V.getStageRequests,async t=>{var r;if(d(this,Ps).permissions.stageAccess!==H.Allowed)return;const e=(r=t==null?void 0:t.stageRequests)!=null?r:[];await w.emitAsync(C.GET_STAGE_REQUESTS,e),d(this,La)<e.length&&e.length>0&&this.stage.emit("newStageRequest",{count:e.length}),T(this,La,e.length),this.stage.emit("stageAccessRequestUpdate",e)})}getCurrentStageRequests(){return d(this,In).joined.toArray().filter(e=>e.stageStatus==="REQUESTED_TO_JOIN_STAGE").map(e=>({displayName:e.name,userId:e.userId,peerId:e.id}))}async setStageStatus(t){this.stage.status!==t&&d(this,zr).setValue("stageStatus",t)}selfStageStatusHandler(t){const e=iu(t.stageType),r=d(this,zr).getValue("stageStatus");if(r!==e)switch(t.stageType){case 1:d(this,zr).setValue("stageStatus","ACCEPTED_TO_JOIN_STAGE",!1),this.stage.join();break;case 2:case 3:this.setStageStatus(r);break;case 0:case 4:default:d(this,zr).setValue("stageStatus","ACCEPTED_TO_JOIN_STAGE",!1),this.stage.leave();break}}async peerStageStatusHandler(t){const e=d(this,In).joined.get(t.peerId),r=d(this,In).viewMode==="ACTIVE_GRID";if(!e){l.warn("err::peerStageStatusUpdate: participant not found");return}switch(t.stageType){case 1:e.setStageStatus("ON_STAGE"),r&&w.emit(C.REFRESH_GRID);break;case 2:e.setStageStatus("ACCEPTED_TO_JOIN_STAGE");break;case 3:e.setStageStatus("REQUESTED_TO_JOIN_STAGE");break;case 0:case 4:default:e.setStageStatus("OFF_STAGE"),r&&w.emit(C.REFRESH_GRID);break}w.emit(C.UPDATE_PEER_STAGE_STATUS,{id:e.id,status:e.stageStatus})}}Ps=new WeakMap,In=new WeakMap,Rs=new WeakMap,La=new WeakMap,zr=new WeakMap,d0([g.trace("DyteStage.setupEvents")],ig.prototype,"setupEvents",1);var l0=Object.defineProperty,u0=Object.getOwnPropertyDescriptor,Fc=(s,t,e,r)=>{for(var n=r>1?void 0:r?u0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&l0(t,e,n),n};const He={getPeer:14,getPeers:15,chatMessage:16,getRoomName:17,getDisplayTitle:18,getPluginInitiator:19,customPluginEventToParent:20,peerJoined:22,peerLeft:23,sendData:24,stageStatusUpdate:25,peerStageStatusUpdate:26};let ei=(Rv=class extends Qn{constructor(t,{baseURL:e,createdAt:r,description:n,id:i,name:a,organizationId:o,picture:c,private:u,published:h,staggered:p,tags:f,type:v,updatedAt:y},P,k,I,x){super();S(this,An);S(this,yt,void 0);m(this,"baseURL");m(this,"createdAt");m(this,"description");m(this,"id");m(this,"name");S(this,Xt,void 0);S(this,Si,void 0);S(this,Ei,void 0);m(this,"organizationId");m(this,"picture");m(this,"private");m(this,"published");m(this,"staggered");m(this,"tags");m(this,"type");m(this,"updatedAt");S(this,Yr,void 0);m(this,"config");S(this,wi,void 0);m(this,"active");m(this,"iframes");m(this,"enabledBy");S(this,Ci,void 0);T(this,Ci,t),this.baseURL=e,this.createdAt=new Date(r),this.description=n,this.id=i,this.name=a,T(this,Xt,k),this.organizationId=o,this.picture=c,this.private=u,this.published=h,this.staggered=p,this.tags=f,this.type=v,this.updatedAt=new Date(y),this.active=!1,this.iframes=new Map,T(this,yt,P),T(this,Si,I),T(this,Ei,x),this.enabledBy=""}sendIframeEvent(t){this.iframes.size&&this.iframes.forEach(e=>{const{iframe:r}=e;r&&(navigator.isReactNative?r.postMessage(JSON.stringify(t)):r.contentWindow.postMessage(t,"*"))})}async handleIframeMessage(t){var a;if(!this.active)return;const e=t,{payload:r,uuid:n,type:i}=e;switch(i){case G.customPluginEventToRoom:{d(this,yt).customPluginEventToRoom(this.id,r,n);break}case G.customPluginEventToPeers:{d(this,yt).customPluginEventToPeers(this.id,r.peerIds,r,n);break}case G.enablePluginForRoom:{d(this,yt).enablePluginForRoom(this.id,n);break}case G.enablePluginForPeers:{d(this,yt).enablePluginForPeers(this.id,r.peerIds,n);break}case G.disablePluginForRoom:{d(this,yt).disablePluginForRoom(this.id,n);break}case G.disablePluginForPeers:{d(this,yt).disablePluginForPeers(this.id,r.peerIds,n);break}case G.storeInsertKeys:{d(this,yt).storeInsertKeys(this.id,r.store,r.insertKeys,n);break}case G.storeGetKeys:{d(this,yt).storeGetKeys(this.id,r.store,r.getKeys,n);break}case G.storeDeleteKeys:{d(this,yt).storeDeleteKeys(this.id,r.store,r.deleteKeys,n);break}case G.storeDelete:{d(this,yt).storeDelete(this.id,r.store,n);break}case He.chatMessage:{const{messagePayload:o,peerIds:c}=r;if(!d(this,Ei)){this.sendIframeEvent({type:He.chatMessage,uuid:e.uuid,payload:{error:"Chat is disabled for this room."}});return}try{await d(this,Ei).sendMessage(o,c),this.sendIframeEvent({type:He.chatMessage,uuid:e.uuid,payload:{success:!0}})}catch(u){this.sendIframeEvent({type:He.chatMessage,uuid:e.uuid,payload:{error:u}})}break}case He.getPeer:{let o;const{peerId:c}=r,u={...d(this,Xt),isRecorder:(a=d(this,Xt).permissions)==null?void 0:a.isRecorder,isHidden:d(this,Xt).permissions.hiddenParticipant,stageStatus:d(this,Xt).stageStatus};c?(o=d(this,Si).joined.get(r.peerId),d(this,Xt).id===c&&(o=u)):o=u,this.sendIframeEvent({type:He.getPeer,payload:{peer:o&&Oc(o)},uuid:e.uuid});break}case He.getPeers:{const o=d(this,Si).joined.toArray().map(c=>Oc(c));this.sendIframeEvent({type:He.getPeers,payload:{peers:o},uuid:e.uuid});break}case He.getPluginInitiator:{this.sendIframeEvent({type:He.getPluginInitiator,payload:{enabledBy:this.enabledBy},uuid:e.uuid});break}case He.getDisplayTitle:{this.sendIframeEvent({type:He.getDisplayTitle,payload:{displayTitle:d(this,An,Do).meetingTitle},uuid:e.uuid});break}case He.getRoomName:{this.sendIframeEvent({type:He.getRoomName,payload:{roomName:d(this,An,Do).roomName},uuid:e.uuid});break}case He.customPluginEventToParent:{this.emit(e.payload.eventName,e.payload.data);break}}}sendData(t){this.active&&(l.info("DytePlugin::SendData",{plugin:{id:this.id,name:this.name,data:{eventName:t.eventName}}}),this.sendIframeEvent({type:He.sendData,uuid:"",payload:t}))}removePluginView(t="default"){var n;const{iframe:e,listener:r}=(n=this.iframes.get(t))!=null?n:{};(e||r)&&(navigator.isReactNative?e.props.onMessage=void 0:window.removeEventListener("message",r),this.iframes.delete(t))}addPluginView(t,e="default"){var a;if(!d(this,wi))throw l.error("DytePlugin::addPluginView::no_auth_token_set_for_plugin"),new b("No auth token set for plugin.");if(!t)throw l.error("DytePlugin::addPluginView::iframe_was_not_provided"),new b("Iframe was not provided.");this.removePluginView(e);const r=t,n=new URL(this.baseURL),i={auth:d(this,wi),parent:navigator.isReactNative?this.baseURL:window.location.origin,backend:d(this,Ci).getValue("apiBase"),pluginId:this.id,roomName:(a=d(this,An,Do).roomName)!=null?a:"",displayTitle:d(this,An,Do).meetingTitle};if(Object.keys(i).forEach(o=>{n.searchParams.set(o,i[o])}),r.src=n.href,r.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",r.title=e,navigator.isReactNative)r.props.onMessage=o=>{this.handleIframeMessage(JSON.parse(o.nativeEvent.data))},this.iframes.set(e,{iframe:r});else{const o=async c=>{c.source===t.contentWindow&&await this.handleIframeMessage(c.data)};window.addEventListener("message",o),this.iframes.set(e,{iframe:r,listener:o})}}setActive(t){var e,r;if(this.active=t,t){this.emit("stateUpdate",{active:this.active,pluginId:this.id,bind:this.addPluginView.bind(this),views:(e=this.config)==null?void 0:e.views});return}this.active=!1,this.emit("stateUpdate",{active:this.active,pluginId:this.id,views:(r=this.config)==null?void 0:r.views})}async activateForSelf(){const t=Je(),e=await t.authorizePlugin(this.id);T(this,wi,e),T(this,Yr,new Date);try{const r=await t.getPluginConfig(this.baseURL);this.config=r}catch(r){l.error("DytePlugin::activateForSelf",{error:r})}this.setActive(!0),this.emit("enabled")}deactivateForSelf(){Array.from(this.iframes.keys()).forEach(t=>{this.removePluginView(t)}),T(this,Yr,void 0),this.iframes.clear(),this.setActive(!1),this.emit("closed")}async enable(){return this.activateForSelf()}disable(){return this.deactivateForSelf()}async activate(){var t,e;this.active||(e=(t=d(this,Xt).permissions)==null?void 0:t.plugins)!=null&&e.canStart&&(d(this,yt).addPlugin(this.id,this.staggered),T(this,Yr,new Date),l.info("plugin::activated",{plugin:{id:this.id,enabledBy:this.enabledBy,name:this.name}}))}async deactivate(){var t,e;this.active&&(!((e=(t=d(this,Xt).permissions)==null?void 0:t.plugins)!=null&&e.canClose)&&this.enabledBy!==d(this,Xt).id||(d(this,yt).removePlugin(this.id),l.info("plugin::deactivated",{plugin:{id:this.id,name:this.name,duration:d(this,Yr)?new Date().getTime()-d(this,Yr).getTime():0}}),T(this,Yr,void 0)))}},yt=new WeakMap,Xt=new WeakMap,Si=new WeakMap,Ei=new WeakMap,Yr=new WeakMap,wi=new WeakMap,Ci=new WeakMap,An=new WeakSet,Do=function(){return d(this,Ci).getValue("roomNodeClient")},Rv);Fc([Ot({maxInvocations:5,period:1})],ei.prototype,"sendData",1),Fc([g.trace("DytePlugin.activatePlugin")],ei.prototype,"activate",1),Fc([g.trace("DytePlugin.deactivatePlugin")],ei.prototype,"deactivate",1),ei=Fc([mt("0600")],ei);class ag extends Map{constructor(e){const{onAddEvent:r,onDeleteEvent:n,onClearEvent:i}=e;super();S(this,ze,void 0);S(this,Mn,void 0);m(this,"onAddEvent");m(this,"onDeleteEvent");m(this,"onClearEvent");T(this,ze,new Qn),this.onAddEvent=r,this.onDeleteEvent=n,this.onClearEvent=i,T(this,Mn,new Map)}emit(e,...r){return d(this,ze).emit(e,...r)}on(e,r){return d(this,ze).on(e,r)}addListener(e,r){return d(this,ze).addListener(e,r)}off(e,r){return d(this,ze).off(e,r)}once(e,r){return d(this,ze).once(e,r)}prependListener(e,r){return d(this,ze).prependListener(e,r)}prependOnceListener(e,r){return d(this,ze).prependOnceListener(e,r)}removeListener(e,r){return d(this,ze).removeListener(e,r)}removeAllListeners(e){return d(this,ze).removeAllListeners(e)}listeners(e){return d(this,ze).listeners(e)}listenerCount(e){return d(this,ze).listenerCount(e)}getMaxListeners(){return d(this,ze).getMaxListeners()}setMaxListeners(e){return d(this,ze).setMaxListeners(e)}eventNames(){return d(this,ze).eventNames()}add(e,r=!0){return this.set(e.id,e,r)}set(e,r,n=!0){const i=super.set(e,r),a=(o,...c)=>{this.emit(o,r,...c)};return d(this,Mn).set(e,a),r.on("*",a),n&&d(this,ze).emit(this.onAddEvent,r),i}delete(e,r=!0,n=!1){const i=this.get(e);if(!i)return!1;i.removeListener("*",d(this,Mn).get(e));const a=super.delete(e);return n&&i.removeAllListeners(),r&&d(this,ze).emit(this.onDeleteEvent,i),a}clear(e=!0,r=!1){this.forEach(i=>{i.removeListener("*",d(this,Mn).get(i.id)),r&&i.removeAllListeners()});const n=super.clear();return e&&d(this,ze).emit(this.onClearEvent),n}toArray(){return Array.from(this.values())}}ze=new WeakMap,Mn=new WeakMap;class og extends ag{constructor(){super({onAddEvent:"pluginAdded",onDeleteEvent:"pluginDeleted"})}add(t,e=!0){return super.add(t,e)}delete(t,e=!0,r=!1){return super.delete(t,e,r)}}var h0=Object.defineProperty,p0=Object.getOwnPropertyDescriptor,m0=(s,t,e,r)=>{for(var n=r>1?void 0:r?p0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&h0(t,e,n),n};let au=class{constructor(){m(this,"all");m(this,"active");this.all=new og,this.active=new og}};au=m0([mt("0600")],au);var f0=Object.defineProperty,g0=Object.getOwnPropertyDescriptor,xc=(s,t,e,r)=>{for(var n=r>1?void 0:r?g0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&f0(t,e,n),n};const cg=(kv=class{constructor(s,t,e,r){m(this,"plugins");S(this,Zt,void 0);S(this,bi,void 0);S(this,Fa,void 0);T(this,Zt,t),T(this,bi,e),T(this,Fa,s),this.plugins=r,this.setupEvents()}static async init(s,t,e,r,n,i,a){const o=new au;return t.forEach(c=>{const u=new ei(s,c,e,i,a,n);o.all.add(u)}),new cg(s,e,r,o)}async getRoomPlugins(){var t;const{plugins:s}=await d(this,Zt).getActivePlugins();(t=this.plugins.active)==null||t.toArray().forEach(e=>{this.disablePlugin({id:e.id})}),await Promise.all(s.map(e=>this.enablePlugin({id:e.pluginId,enabledBy:e.enabledBy})))}async enablePlugin({id:s,enabledBy:t}){const e=this.plugins.all.get(s);e&&(await e.activateForSelf(),e.enabledBy=t)}async disablePlugin({id:s}){const t=this.plugins.all.get(s);t&&t.deactivateForSelf()}sendIframeEvent(s,t,e,r){const n=this.plugins.all.get(t);n&&n.sendIframeEvent({type:s,uuid:e,payload:r})}broadcastIframeEvent(s,t){this.plugins.active.forEach(e=>{this.sendIframeEvent(s,e.id,"",t)})}setupEvents(){this.plugins.all.on("stateUpdate",({active:s,id:t})=>{if(s){this.plugins.active.add(this.plugins.all.get(t));return}this.plugins.active.delete(t)}),w.onAsync(C.SOCKET_SERVICE_ROOM_JOINED,async()=>{await this.getRoomPlugins(),l.debug("[SOCKET_SERVICE_ROOM_JOINED] resolved request to fetch plugins.")}),d(this,Zt).on(G.addPlugin,async s=>{var e;const t=s.pluginId;(e=this.plugins.all.get(t))!=null&&e.active||await this.enablePlugin({id:t,enabledBy:s.enabledBy})}),d(this,Zt).on(G.removePlugin,async s=>{var e;const t=s.pluginId;(e=this.plugins.all.get(t))!=null&&e.active&&await this.disablePlugin({id:t})}),[G.enablePluginForPeers,G.enablePluginForRoom].forEach(s=>{d(this,Zt).on(s,async(t,e)=>{this.sendIframeEvent(s,t.pluginId,e,{enabledBy:t.enabledBy})})}),[G.disablePluginForPeers,G.disablePluginForRoom].forEach(s=>{d(this,Zt).on(s,async(t,e)=>{this.sendIframeEvent(s,t.pluginId,e,{disabledBy:t.disabledBy})})}),[G.customPluginEventToPeers,G.customPluginEventToRoom].forEach(s=>{d(this,Zt).on(s,async(t,e)=>{this.sendIframeEvent(s,t.pluginId,e,{data:JSON.parse(new TextDecoder().decode(t.pluginData))})})}),[G.storeInsertKeys,G.storeGetKeys,G.storeDeleteKeys].forEach(s=>{d(this,Zt).on(s,async(t,e)=>{var n;const r=(n=t.storeItems)==null?void 0:n.map(i=>{var a;return{timestamp:i.timestamp,peerId:i.peerId,payload:JSON.parse((a=i.payload)!=null&&a.length?new TextDecoder().decode(i.payload):"{}"),key:i.storeKey}});this.sendIframeEvent(s,t.pluginId,e,{storeName:t.storeName,storeItems:r})})}),d(this,Zt).on(G.storeDelete,async(s,t)=>{this.sendIframeEvent(G.storeDelete,s.pluginId,t,{storeName:s.storeName})}),d(this,bi).on(Ve.sendMessageToPeers,s=>{const t=ur==null?void 0:ur.formatSocketServiceMessage(s.message);this.broadcastIframeEvent(He.chatMessage,{message:t})}),d(this,bi).on(Ve.sendMessageToRoom,s=>{const t=ur==null?void 0:ur.formatSocketServiceMessage(s.message);this.broadcastIframeEvent(He.chatMessage,{message:t})}),w.on(C.PEER_JOINED_INTERNAL,s=>{const t=Oc(s);this.broadcastIframeEvent(He.peerJoined,t)}),w.on(C.PEER_CLOSED,s=>{this.broadcastIframeEvent(He.peerLeft,s)}),w.on(C.UPDATE_PEER_STAGE_STATUS,s=>{this.broadcastIframeEvent(He.peerStageStatusUpdate,s)}),d(this,Fa).subscribe("stageStatus",s=>{this.broadcastIframeEvent(He.stageStatusUpdate,s)})}},Zt=new WeakMap,bi=new WeakMap,Fa=new WeakMap,kv);let ga=cg;xc([g.trace("PluginController.getRoomPlugins")],ga.prototype,"getRoomPlugins",1),xc([g.trace("PluginController.enableForSelf")],ga.prototype,"enablePlugin",1),xc([g.trace("PluginController.disableForSelf")],ga.prototype,"disablePlugin",1),xc([g.trace("PluginController.setupEvents")],ga.prototype,"setupEvents",1);var v0=Object.defineProperty,y0=Object.getOwnPropertyDescriptor,va=(s,t,e,r)=>{for(var n=r>1?void 0:r?y0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&v0(t,e,n),n};let ln=(Iv=class extends Ht{constructor(t,e){super();S(this,Ri);S(this,Pi,void 0);S(this,xa,void 0);m(this,"recordingPeerIds",[]);m(this,"recordings",[]);T(this,xa,t),T(this,Pi,e)}get recordingState(){return this.recordings.some(t=>t.state==="RECORDING")?"RECORDING":this.recordings.some(t=>t.state==="PAUSED")?"PAUSED":this.recordings.some(t=>t.state==="STARTING")?"STARTING":this.recordings.some(t=>t.state==="STOPPING")?"STOPPING":"IDLE"}updateRecordings(t){this.recordings=t,this.emit("recordingUpdate",this.recordingState)}async start(t){if(!d(this,Pi).permissions.canRecord)throw l.error("DyteRecording::start::permission_denied"),new b("User does not have permission to start recording");if((t==null?void 0:t.allowMultiple)!==!0&&(this.recordingState==="STARTING"||this.recordingState==="RECORDING"||this.recordingState==="STOPPING"))throw l.error("DyteRecording::start::recording_in_progress",{recording:{state:this.recordingState}}),new b(`Cant start recording, recordingState irregular: ${this.recordingState}`);try{const e=Je(),{recording:r={}}=d(this,xa).getValue("defaults"),n=await e.startRecording(r,t==null?void 0:t.allowMultiple);this.updateRecordings([...this.recordings,{id:n,state:"STARTING",type:"BROWSER"}])}catch(e){throw l.error("DyteRecording::stop::recording_failed_to_start",{error:e}),new b("Error while starting recording")}}async stop(t){await le(this,Ri,Md).call(this,"stop",["RECORDING","PAUSED"],t)}async pause(t){await le(this,Ri,Md).call(this,"pause",["RECORDING"],t)}async resume(t){await le(this,Ri,Md).call(this,"resume",["PAUSED"],t)}},Pi=new WeakMap,xa=new WeakMap,Ri=new WeakSet,Md=async function(t,e,r){if(!d(this,Pi).permissions.canRecord)throw l.error("DyteRecording::stop::permission_denied"),new b("User does not have permission to stop recording");let n=[];if(r!==void 0){const i=this.recordings.find(a=>a.id===r);if(i===void 0)throw new b("Could not find the specified recording");if(e.includes(i.state)){l.error("DyteRecording::stop::recording_not_in_expected_state",{recording:{state:i.state}});return}n.push(i)}else n=this.recordings.filter(i=>e.includes(i.state));n.forEach(async i=>{const a=i.state;t==="stop"&&(i.state="STOPPING",this.emit("recordingUpdate","STOPPING"));try{await Je().updateRecording(i.id,t)}catch(o){throw l.error("DyteRecording::stop::recording_failed_to_stop",{error:o}),i.state!==a&&(i.state=a,this.emit("recordingUpdate",a)),new b("Error while stopping recording")}})},Iv);va([g.trace("DyteRecording.start")],ln.prototype,"start",1),va([g.trace("DyteRecording.stop")],ln.prototype,"stop",1),va([g.trace("DyteRecording.stop")],ln.prototype,"pause",1),va([g.trace("DyteRecording.stop")],ln.prototype,"resume",1),ln=va([mt("1000")],ln);var T0=Object.defineProperty,_0=Object.getOwnPropertyDescriptor,S0=(s,t,e,r)=>{for(var n=r>1?void 0:r?_0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&T0(t,e,n),n};class dg{constructor(t,e,r){m(this,"recording");m(this,"room");S(this,gd,void 0);T(this,gd,t),this.recording=new ln(t,e),this.room=r,this.setupEvents()}getRecordingTypeFromProtoType(t){let e;switch(t){case sn.BROWSER:e="BROWSER";break;case sn.COMPOSITE:e="COMPOSITE";break;case sn.TRACK:e="TRACK";break;default:e="BROWSER"}return e}setupEvents(){w.on(C.ROOM_STATE,t=>{t.activeRecordings.length!==0?this.recording.updateRecordings(t.activeRecordings.map(e=>{const r=this.getRecordingTypeFromProtoType(e.recordingType);return{id:e.recordingId,state:e.recordingStatus,type:r}})):this.recording.recordings.length&&this.recording.updateRecordings([])}),this.room.on(V.recordingStarted,t=>{let e=!1;const r=[...this.recording.recordings];if(r.forEach(n=>{n.id===t.recordingId&&(e=!0,n.state="RECORDING")}),e===!1){const n=this.getRecordingTypeFromProtoType(t.recordingType);r.push({id:t.recordingId,state:"RECORDING",type:n})}this.recording.updateRecordings(r)}),this.room.on(V.recordingPaused,t=>{const e=[...this.recording.recordings];e.forEach(r=>{r.id===t.recordingId&&(r.state="PAUSED")}),this.recording.updateRecordings(e)}),this.room.on(V.recordingStopped,t=>{const e=[...this.recording.recordings.filter(r=>r.id!==t.recordingId)];this.recording.updateRecordings(e)})}}gd=new WeakMap,S0([g.trace("RecordingController.setupEvents")],dg.prototype,"setupEvents",1);class E0{static hasFeature(t){var e;return(e=j.hasFeature(t))!=null?e:!1}static getFeatureValue(t){return j.getValue(t)}static getAllFeatures(){return j.getAllFlags()}}class ou{constructor(t,e,r){m(this,"logger");m(this,"features");m(this,"browserSpecs");m(this,"callStats");this.logger=t,this.features=e,this.browserSpecs=we,this.callStats=r}static init(t){return new ou(l,E0,t)}}class cu{constructor(t){m(this,"internals");this.internals=t}static async init(){const t=ou.init(U);return new cu(t)}}var w0=Object.defineProperty,C0=Object.getOwnPropertyDescriptor,qt=(s,t,e,r)=>{for(var n=r>1?void 0:r?C0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&w0(t,e,n),n};class Nt extends Qn{constructor(e,r,n=lg,i=!0){super();S(this,st,void 0);S(this,pt,void 0);S(this,et,void 0);S(this,Rr,void 0);S(this,er,void 0);S(this,Ua,void 0);S(this,vd,void 0);m(this,"audioUpdateInProgress");m(this,"videoUpdateInProgress");T(this,vd,e),this.audioUpdateInProgress=!1,this.videoUpdateInProgress=!1,T(this,st,new _g(e,r)),T(this,pt,new Z0(d(this,st),void 0,n)),T(this,et,new aD(d(this,st),void 0,n)),T(this,er,new sD(d(this,st))),T(this,Rr,new tD(d(this,st))),T(this,Ua,i),d(this,pt).on("trackMuted",this.onAudioTrackMuted.bind(this)),d(this,pt).on("trackChanged",this.onAudioTrackChanged.bind(this)),d(this,et).on("trackChanged",this.onVideoTrackChanged.bind(this)),d(this,et).on("trackEnded",this.onVideoTrackEnded.bind(this)),d(this,er).on("trackEnded",this.onScreenShareEnded.bind(this)),this.onVisibilityChange=this.onVisibilityChange.bind(this),document.addEventListener("visibilitychange",this.onVisibilityChange)}async onVisibilityChange(){U.tabChanged(document.visibilityState==="visible"),document.visibilityState!=="visible"?U.browserBackgrounded():(U.browserForegrounded(),await this.setupSpeaker())}async repopulateAvailableDevices(){return!0}async setupStreams({audio:e,video:r}){var a;let n,i;if(e&&r)try{const o=await d(this,st).getAudioAndVideoTrack();n=o.audioTrack,i=o.videoTrack}catch(o){l.error("LocalMediaHandler::init::Failed to get audio video tracks",{error:o})}if(!n&&e)try{n=await d(this,st).getAudioTrack(!1)}catch(o){l.error("LocalMediaHandler::init::Failed to get audio track",{error:o})}if(!i&&r)try{i=await d(this,st).getVideoTrack()}catch(o){l.error("LocalMediaHandler::init::Failed to get video track",{error:o})}await d(this,pt).setMediaTrack(n),await d(this,et).setMediaTrack(i);try{await d(this,Rr).setupSpeaker()}catch(o){}if(i){const o=await this.getDeviceById(i.getSettings().deviceId);U.onSafeInitialization(()=>{U.selectedDevice("VIDEO",o)})}if(n){const o=await this.getDeviceById(n.getSettings().deviceId);U.onSafeInitialization(()=>{U.selectedDevice("AUDIO",o)})}(a=d(this,Rr).currentDevice)!=null&&a.deviceId&&U.onSafeInitialization(()=>{U.selectedDevice("SPEAKER",d(this,Rr).currentDevice)}),d(this,st).onDeviceChange((o,c,u)=>{this.onDeviceChange(c,u)})}getCurrentDevices(){return{audio:d(this,pt).currentDevice,video:d(this,et).currentDevice,speaker:d(this,Rr).currentDevice}}get permissions(){return d(this,st).permissions}getAllDevices(){return d(this,st).getAvailableDevices()}getDeviceById(e,r){return d(this,st).getDevice(e)}onAudioTrackMuted(){this.emit("AUDIO_TRACK_SILENT")}onAudioTrackChanged(){this.emit("AUDIO_TRACK_CHANGE")}get rawAudioTrack(){return d(this,pt).mediaTrack}get audioTrack(){return d(this,pt).transformedMediaTrack}get audioEnabled(){return d(this,pt).trackEnabled}async enableAudio(){if(!this.audioUpdateInProgress){this.audioUpdateInProgress=!0;try{await d(this,pt).unmuteTrack()}catch(e){}finally{this.audioUpdateInProgress=!1}}}disableAudio(){d(this,pt).muteTrack()}getAudioDevices(e){return d(this,st).getAudioInputDevices(e)}async setAudioDevice(e){await d(this,pt).setDevice(e),e!=null&&e.deviceId&&U.onSafeInitialization(()=>{U.selectedDevice("AUDIO",e)}),this.emit("AUDIO_TRACK_CHANGE"),this.emit("DEVICE_CHANGE",{device:e})}setupSpeaker(){return d(this,Rr).setupSpeaker()}async setSpeakerDevice(e){await d(this,Rr).setupSpeaker(e),e!=null&&e.deviceId&&U.onSafeInitialization(()=>{U.selectedDevice("SPEAKER",e)}),this.emit("DEVICE_CHANGE",{device:e})}onVideoTrackChanged(){this.emit("VIDEO_TRACK_CHANGE")}onVideoTrackEnded(){this.emit("VIDEO_TRACK_CHANGE")}get rawVideoTrack(){return d(this,et).mediaTrack}get videoTrack(){return d(this,et).transformedMediaTrack}get videoEnabled(){return d(this,et).trackEnabled}async enableVideo(){if(!this.videoUpdateInProgress){this.videoUpdateInProgress=!0;try{await d(this,et).unmuteTrack()}catch(e){}finally{this.videoUpdateInProgress=!1}}}disableVideo(){d(this,et).disableTrack()}getVideoDevices(e){return d(this,st).getVideoInputDevices(e)}async setVideoDevice(e){await d(this,et).setDevice(e),e!=null&&e.deviceId&&U.onSafeInitialization(()=>{U.selectedDevice("VIDEO",e)}),this.emit("VIDEO_TRACK_CHANGE"),this.emit("DEVICE_CHANGE",{device:e})}async updateVideoConstraints(e){await d(this,et).updateConstraints(e)}onScreenShareEnded(){this.emit("SCREENSHARE_ENDED")}get screenShareTracks(){return{audio:d(this,er).audioMediaTrack,video:d(this,er).videoMediaTrack}}get screenShareEnabled(){return d(this,er).trackEnabled}async enableScreenShare(){await d(this,er).enableScreenShare()}async disableScreenShare(){d(this,er).disableScreenShare()}async updateScreenshareConstraints(e){await d(this,er).updateConstraints(e)}getSpeakerDevices(e){return d(this,st).getAudioOutputDevices(e)}addAudioMiddleware(e){return d(this,pt).addMiddleware(e)}removeAudioMiddleware(e){return d(this,pt).removeMiddleware(e)}addVideoMiddleware(e){return d(this,et).addMiddleware(e)}removeVideoMiddleware(e){return d(this,et).removeMiddleware(e)}setVideoMiddlewareGlobalConfig(e){return d(this,et).setVideoMiddlewareGlobalConfig(e)}destruct(){d(this,pt).disableTrack(),d(this,et).disableTrack(),d(this,et).terminateMiddlewareWebWorker(),d(this,er).disableScreenShare(),d(this,st).destruct()}async onDeviceChange(e,r){var n,i;this.emit("DEVICE_LIST_UPDATED",e),!(r||!d(this,Ua))&&((n=e==null?void 0:e.added)==null||n.forEach(async a=>{var o;a&&!lg(a)&&(a.kind==="audioinput"&&((o=this.audioTrack)==null?void 0:o.enabled)===!0?await this.setAudioDevice(a):a.kind==="audiooutput"&&await this.setSpeakerDevice(a))}),(i=e==null?void 0:e.removed)==null||i.forEach(async a=>{var o;if(a.kind==="audiooutput"&&((o=this.getCurrentDevices().speaker)==null?void 0:o.deviceId)===a.deviceId){const c=(await this.getSpeakerDevices()).find(u=>u.deviceId!==a.deviceId);c&&await this.setSpeakerDevice(c)}}))}removeAllTracks(){this.destruct()}async removeDocumentEventListeners(){document.removeEventListener("visibilitychange",this.onVisibilityChange)}}st=new WeakMap,pt=new WeakMap,et=new WeakMap,Rr=new WeakMap,er=new WeakMap,Ua=new WeakMap,vd=new WeakMap,qt([g.trace("MediaHandler.setupStreams")],Nt.prototype,"setupStreams",1),qt([g.trace("MediaHandler.enableAudio")],Nt.prototype,"enableAudio",1),qt([g.trace("MediaHandler.disableAudio")],Nt.prototype,"disableAudio",1),qt([g.trace("MediaHandler.setAudioDevice")],Nt.prototype,"setAudioDevice",1),qt([g.trace("MediaHandler.enableVideo")],Nt.prototype,"enableVideo",1),qt([g.trace("MediaHandler.disableVideo")],Nt.prototype,"disableVideo",1),qt([g.trace("MediaHandler.setVideoDevice")],Nt.prototype,"setVideoDevice",1),qt([g.trace("MediaHandler.updateVideoConstraints")],Nt.prototype,"updateVideoConstraints",1),qt([g.trace("MediaHandler.enableScreenShare")],Nt.prototype,"enableScreenShare",1),qt([g.trace("MediaHandler.disableScreenShare")],Nt.prototype,"disableScreenShare",1),qt([g.trace("MediaHandler.updateScreenshareConstraints")],Nt.prototype,"updateScreenshareConstraints",1),qt([g.trace("MediaHandler.destruct")],Nt.prototype,"destruct",1),qt([g.trace("MediaHandler.onDeviceChange")],Nt.prototype,"onDeviceChange",1);function Uc(s,t,e){switch(!0){case we.isChromiumBased():switch(t){case"NotAllowedError":return e.includes("by system")?"SYSTEM_DENIED":s==="screenshare"?"CANCELED":"DENIED";case"NotReadableError":default:return"COULD_NOT_START"}case we.isSafari():switch(t){case"NotAllowedError":return"DENIED";default:return"COULD_NOT_START"}case we.isFirefox():switch(t){case"NotFoundError":case"NotReadableError":return"SYSTEM_DENIED";case"NotAllowedError":return"DENIED";case"AbortError":default:return"COULD_NOT_START"}default:return"COULD_NOT_START"}}const b0=["virtual","emulator","krisp","solstice conference","teams","manycam","blackHole"];function lg(s){const t=s.label.toLowerCase();return we._bowser.getOSName()==="macOS"&&t.includes("iphone")?(l.log("isVirtualDevice::ignore_macos_continuity"),!0):b0.some(e=>t.includes(e))}async function P0(s,t){if(!(s!=null&&s.length))return t;const e=new AudioContext,r=await Promise.all(s==null?void 0:s.map(a=>a(e))),n=e.createMediaStreamSource(new MediaStream([t])),i=e.createMediaStreamDestination();try{let a=n;for(let o=0;o<r.length;o+=1)a.connect(r[o]),a=r[o];a.connect(i)}catch(a){return l.error("getTransformedAudioTrack::middleware_execution_failed",{error:a}),t}return i.stream.getAudioTracks()[0]}const R0=s=>(t,e)=>(s.set(t,e),e),ug=Number.MAX_SAFE_INTEGER===void 0?9007199254740991:Number.MAX_SAFE_INTEGER,hg=536870912,pg=hg*2,k0=(s,t)=>e=>{const r=t.get(e);let n=r===void 0?e.size:r<pg?r+1:0;if(!e.has(n))return s(e,n);if(e.size<hg){for(;e.has(n);)n=Math.floor(Math.random()*pg);return s(e,n)}if(e.size>ug)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;e.has(n);)n=Math.floor(Math.random()*ug);return s(e,n)},mg=new WeakMap,I0=R0(mg),$c=k0(I0,mg),A0=s=>s.method!==void 0&&s.method==="call",M0=s=>s.error===null&&typeof s.id=="number",Vc=((s,t)=>{let e=null;return()=>{if(e!==null)return e;const r=new Blob([t],{type:"application/javascript; charset=utf-8"}),n=URL.createObjectURL(r);return e=s(n),setTimeout(()=>URL.revokeObjectURL(n)),e}})(s=>{const t=new Map([[0,()=>{}]]),e=new Map([[0,()=>{}]]),r=new Map,n=new Worker(s);return n.addEventListener("message",({data:u})=>{if(A0(u)){const{params:{timerId:h,timerType:p}}=u;if(p==="interval"){const f=t.get(h);if(typeof f=="number"){const v=r.get(f);if(v===void 0||v.timerId!==h||v.timerType!==p)throw new Error("The timer is in an undefined state.")}else if(typeof f!="undefined")f();else throw new Error("The timer is in an undefined state.")}else if(p==="timeout"){const f=e.get(h);if(typeof f=="number"){const v=r.get(f);if(v===void 0||v.timerId!==h||v.timerType!==p)throw new Error("The timer is in an undefined state.")}else if(typeof f!="undefined")f(),e.delete(h);else throw new Error("The timer is in an undefined state.")}}else if(M0(u)){const{id:h}=u,p=r.get(h);if(p===void 0)throw new Error("The timer is in an undefined state.");const{timerId:f,timerType:v}=p;r.delete(h),v==="interval"?t.delete(f):e.delete(f)}else{const{error:{message:h}}=u;throw new Error(h)}}),{clearInterval:u=>{const h=$c(r);r.set(h,{timerId:u,timerType:"interval"}),t.set(u,h),n.postMessage({id:h,method:"clear",params:{timerId:u,timerType:"interval"}})},clearTimeout:u=>{const h=$c(r);r.set(h,{timerId:u,timerType:"timeout"}),e.set(u,h),n.postMessage({id:h,method:"clear",params:{timerId:u,timerType:"timeout"}})},setInterval:(u,h=0)=>{const p=$c(t);return t.set(p,()=>{u(),typeof t.get(p)=="function"&&n.postMessage({id:null,method:"set",params:{delay:h,now:performance.now(),timerId:p,timerType:"interval"}})}),n.postMessage({id:null,method:"set",params:{delay:h,now:performance.now(),timerId:p,timerType:"interval"}}),p},setTimeout:(u,h=0)=>{const p=$c(e);return e.set(p,u),n.postMessage({id:null,method:"set",params:{delay:h,now:performance.now(),timerId:p,timerType:"timeout"}}),p}}},`(()=>{"use strict";const e=new Map,t=new Map,r=(e,t)=>{let r,o;const i=performance.now();r=i,o=e-Math.max(0,i-t);return{expected:r+o,remainingDelay:o}},o=(e,t,r,i)=>{const s=performance.now();s>r?postMessage({id:null,method:"call",params:{timerId:t,timerType:i}}):e.set(t,setTimeout(o,r-s,e,t,r,i))};addEventListener("message",(i=>{let{data:s}=i;try{if("clear"===s.method){const{id:r,params:{timerId:o,timerType:i}}=s;if("interval"===i)(t=>{const r=e.get(t);if(void 0===r)throw new Error('There is no interval scheduled with the given id "'.concat(t,'".'));clearTimeout(r),e.delete(t)})(o),postMessage({error:null,id:r});else{if("timeout"!==i)throw new Error('The given type "'.concat(i,'" is not supported'));(e=>{const r=t.get(e);if(void 0===r)throw new Error('There is no timeout scheduled with the given id "'.concat(e,'".'));clearTimeout(r),t.delete(e)})(o),postMessage({error:null,id:r})}}else{if("set"!==s.method)throw new Error('The given method "'.concat(s.method,'" is not supported'));{const{params:{delay:i,now:n,timerId:a,timerType:d}}=s;if("interval"===d)((t,i,s)=>{const{expected:n,remainingDelay:a}=r(t,s);e.set(i,setTimeout(o,a,e,i,n,"interval"))})(i,a,n);else{if("timeout"!==d)throw new Error('The given type "'.concat(d,'" is not supported'));((e,i,s)=>{const{expected:n,remainingDelay:a}=r(e,s);t.set(i,setTimeout(o,a,t,i,n,"timeout"))})(i,a,n)}}}}catch(e){postMessage({error:{message:e.message},id:s.id,result:null})}}))})();`),fg=s=>Vc().clearInterval(s),D0=s=>Vc().clearTimeout(s),gg=(s,t)=>Vc().setInterval(s,t),O0=Object.freeze(Object.defineProperty({__proto__:null,clearInterval:fg,clearTimeout:D0,setInterval:gg,setTimeout:(s,t)=>Vc().setTimeout(s,t)},Symbol.toStringTag,{value:"Module"}));class N0{constructor(){S(this,Dn,void 0)}terminateMiddlewareWebWorker(){if(d(this,Dn))try{fg(d(this,Dn)),T(this,Dn,void 0)}catch(t){l.debug("WorkerTimers::terminateMiddlewareWebWorker::failed")}}async getTransformedVideoTrack(t,e,r){if(!(t!=null&&t.length))return e;const n=document.createElement("canvas"),i=await Promise.all(t==null?void 0:t.map(p=>p({canvas:n,WorkerTimers:O0})));if(r.disablePerFrameCanvasRendering)return n.captureStream().getVideoTracks()[0];const a=document.createElement("video"),o=new MediaStream;o.addTrack(e);const c=n.getContext("2d");a.srcObject=o,a.autoplay=!0,this.terminateMiddlewareWebWorker();const u=async()=>{if(e.enabled===!1||e.readyState==="ended"){this.terminateMiddlewareWebWorker(),a.remove(),n.remove();return}try{c.drawImage(a,0,0);for(let p=0;p<i.length;p+=1)typeof i[p]=="function"&&await i[p](n,c)}catch(p){l.error("getTransformedVideoTrack::middleware_execution_failed",{error:p})}};try{a.play()}catch(p){}return a.addEventListener("play",()=>{n.width=a.width||e.getSettings().width,n.height=a.width||e.getSettings().height,T(this,Dn,gg(u,50))},!1),n.captureStream().getVideoTracks()[0]}}Dn=new WeakMap;const vg={gross:{width:{ideal:192},height:{ideal:144}},qvga:{width:{ideal:384},height:{ideal:288}},pvga:{width:{ideal:480},height:{ideal:360}},vga:{width:{ideal:640},height:{ideal:480}},hd:{width:{ideal:1280},height:{ideal:720}},hd_cropped:{width:{ideal:900},height:{ideal:720}},fhd:{width:{ideal:1920},height:{ideal:1080}}},yg={320:[{rid:"q",maxBitrate:25e4,maxFramerate:24,scalabilityMode:"L1T1"}],640:[{rid:"q",scaleResolutionDownBy:2,maxBitrate:25e4,maxFramerate:24,scalabilityMode:"L1T1"},{rid:"h",maxBitrate:7e5,maxFramerate:30,scalabilityMode:"L1T1"}],1280:[{rid:"q",scaleResolutionDownBy:2,maxBitrate:5e5,maxFramerate:24,scalabilityMode:"L1T1"},{rid:"h",maxBitrate:13e5,maxFramerate:30,scalabilityMode:"L1T1"}]},L0={320:[{rid:"q",maxBitrate:25e4,maxFramerate:24,scalabilityMode:"L1T1"}],640:[{rid:"h",maxBitrate:7e5,maxFramerate:30,scalabilityMode:"L1T1"}],1280:[{rid:"h",maxBitrate:14e5,maxFramerate:30,scalabilityMode:"L1T1"}]},Tg={320:[{rid:"q",maxBitrate:25e4,maxFramerate:24,scalabilityMode:"L1T1"}],640:[{rid:"q",scaleResolutionDownBy:2,maxBitrate:25e4,maxFramerate:24,scalabilityMode:"L1T1"},{rid:"h",maxBitrate:7e5,maxFramerate:30,scalabilityMode:"L1T1"}],1280:[{rid:"q",scaleResolutionDownBy:2,maxBitrate:5e5,maxFramerate:24,scalabilityMode:"L1T1"},{rid:"h",maxBitrate:13e5,maxFramerate:30,scalabilityMode:"L1T1"}]};var Q=(s=>(s.WEBCAM="webcam",s.MIC="mic",s.SCREENSHARE_VIDEO="screenshare_video",s.SCREENSHARE_AUDIO="screenshare_audio",s))(Q||{});const F0=_w(),ti=wr(F0.config.media);function x0(s){var e,r;const t={};return s.audio&&(t.audio={enableStereo:(e=s.audio.enableStereo)!=null?e:!1,enableHighBitrate:(r=s.audio.enableHighBitrate)!=null?r:!1}),t.video=s.video.quality,t}class U0{constructor(t,e){S(this,On,void 0);S(this,yd,void 0);m(this,"getScreenShareConstraints",()=>{var u,h,p,f,v,y,P,k,I;const t=(u=d(this,On))==null?void 0:u.screenshare,e=(p=(h=t==null?void 0:t.width)==null?void 0:h.max)!=null?p:1920,r=(v=(f=t==null?void 0:t.height)==null?void 0:f.max)!=null?v:1080,n=(P=(y=t==null?void 0:t.frameRate)==null?void 0:y.max)!=null?P:5;let i=(I=(k=t==null?void 0:t.frameRate)==null?void 0:k.ideal)!=null?I:5;const a=t==null?void 0:t.displaySurface,o=t==null?void 0:t.selfBrowserSurface;j.getValue(J.VAL_MIN_FRAMERATE)&&(i=parseInt(j.getValue(J.VAL_MIN_FRAMERATE),10));let c={width:{max:e},height:{max:r},frameRate:{ideal:i,max:n}};if(j.hasFeature(J.SCREENSHARE_CONSTRAINTS)){const x=j.getValue(J.SCREENSHARE_CONSTRAINTS);c=JSON.parse(x)}return a!==void 0&&["monitor","browser","window"].includes(a)&&(c={...c,displaySurface:a}),o!==void 0&&(c={...c,selfBrowserSurface:o}),{audio:!0,video:c}});m(this,"getAudioConstraints",t=>{var i,a,o,c,u,h,p,f;const e={},r=(i=d(this,On))==null?void 0:i.audio,n=r!=null&&r.enableStereo?2:1;return we.isFirefox()||we.isWebKitBased()?(e.audio={deviceId:t,autoGainControl:(a=r==null?void 0:r.autoGainControl)!=null?a:!0,echoCancellation:(o=r==null?void 0:r.echoCancellation)!=null?o:!0,noiseSuppression:(c=r==null?void 0:r.noiseSupression)!=null?c:!0,channelCount:n},e):(e.audio={},e.audio.optional=[t?{sourceId:t}:{sourceId:"default"},{channelCount:n},{echoCancellation:(u=r==null?void 0:r.echoCancellation)!=null?u:!0},{googEchoCancellation:(h=r==null?void 0:r.echoCancellation)!=null?h:!0},{googAutoGainControl:(p=r==null?void 0:r.autoGainControl)!=null?p:!0},{googNoiseSuppression:(f=r==null?void 0:r.noiseSupression)!=null?f:!0},{googHighpassFilter:!0}],e)});m(this,"getVideoConstraints",t=>{var i,a,o;const e={},r=(i=d(this,On))==null?void 0:i.video;let n=vg.vga;if(typeof r=="string"?n=vg[r]:r!==void 0&&(n.height.ideal=r.height.ideal,n.width.ideal=r.width.ideal),n.frameRate={ideal:(o=(a=n.frameRate)==null?void 0:a.ideal)!=null?o:24},we.isChromiumBased()&&(n.frameRate.max=30),j.hasFeature(J.VIDEO_CONSTRAINTS)){const c=j.getValue(J.VIDEO_CONSTRAINTS);n=JSON.parse(c)}return e.video=n,typeof e.video=="boolean"||(t?e.video.deviceId={exact:t}:e.video.facingMode="user"),e});T(this,yd,t),T(this,On,e)}getUpdatedVideoConstraints(t){return t}}On=new WeakMap,yd=new WeakMap;class du extends Error{constructor(e,r,n){super(r);m(this,"constraints");m(this,"name");this.name=e,this.constraints=n}}class $0{constructor(){m(this,"permissions");this.permissions={audio:"NOT_REQUESTED",video:"NOT_REQUESTED",screenshare:"NOT_REQUESTED"}}async getAudioInputDevices(t){let e=t;return t||(e=await this.getAvailableDevices()),e.filter(r=>r.kind==="audioinput")}async getVideoInputDevices(t){let e=t;return t||(e=await this.getAvailableDevices()),e.filter(r=>r.kind==="videoinput")}async getAudioOutputDevices(t){let e=t;return t||(e=await this.getAvailableDevices()),e.filter(r=>r.kind==="audiooutput")}}var V0=Object.defineProperty,B0=Object.getOwnPropertyDescriptor,hr=(s,t,e,r)=>{for(var n=r>1?void 0:r?B0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&V0(t,e,n),n};let jt=(Av=class extends $0{constructor(t,e){super();m(this,"availableDevices");S(this,ki,void 0);S(this,kr,void 0);S(this,Td,void 0);T(this,Td,t),T(this,kr,new U0(t,e)),T(this,ki,new AbortController),this.availableDevices=[],this.getAvailableDevices()}get constraintsBuilder(){return d(this,kr)}async destruct(){var t;(t=d(this,ki))==null||t.abort()}handlePermissionErrors(t,e){const r=Uc(t,e.name,e.message);return this.permissions[t]=r,w.emit(C.MEDIA_PERMISSION_ERROR,{message:r,constraints:e.constraints,kind:t}),r}async getAudioAndVideoTrack(){const t={audio:d(this,kr).getAudioConstraints().audio,video:d(this,kr).getVideoConstraints().video};try{l.info("getUserMediaWithoutTimeout::requesting_user_media",{constraints:JSON.stringify(t)});const e=await navigator.mediaDevices.getUserMedia(t);l.info("getUserMediaWithoutTimeout::received_user_media",{constraints:JSON.stringify(t)});const r=e.getAudioTracks()[0];let n=e.getVideoTracks()[0];if(this.permissions.audio="ACCEPTED",this.permissions.video="ACCEPTED",j.hasFeature(J.OBS_QUALITY)&&n.label.includes("OBS Virtual")){const o=(await this.getVideoInputDevices()).find(c=>c.label.includes("OBS Virtual"));n=await this.getVideoTrack(o.deviceId)}return w.emit(C.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}),w.emit(C.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"}),{audioTrack:r,videoTrack:n}}catch(e){throw l.error("WebMediaInterface.getAudioAndVideoTrack",{error:e}),new b("Couldnt fetch audio and video track")}}async getAudioTrack(t,e){let r=await this.getAudioInputDevices();if(r.length===0)throw this.permissions.audio="NO_DEVICES_AVAILABLE",w.emit(C.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}),new b("No audio devices available");const n=async i=>{let a;try{r=r.filter(c=>c.deviceId!==i),a=d(this,kr).getAudioConstraints(i),l.info("getUserMediaWithoutTimeout::requesting_user_media",{constraints:JSON.stringify(a)});const[o]=(await navigator.mediaDevices.getUserMedia(a)).getAudioTracks();return l.info("getUserMediaWithoutTimeout::received_user_media",{constraints:JSON.stringify(a)}),o}catch(o){const c=Uc("audio",o.name,o.message),u=new du(o.name,o.message,a);if(c==="COULD_NOT_START"){const h=r.shift();if(!h)throw u;return n(h.deviceId)}throw u}};try{const i=await n(e);return i.enabled=!t,this.permissions.audio!=="ACCEPTED"&&(this.permissions.audio="ACCEPTED",w.emit(C.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"})),i}catch(i){throw i.constraints&&this.handlePermissionErrors("audio",i),new b(i.message,"1601")}}async getVideoTrack(t){var o;const e=j.hasFeature(J.OBS_QUALITY),r=(o=await this.getCurrentDeviceLabel(t))==null?void 0:o.includes("OBS Virtual"),n=e&&r,i=await this.getVideoInputDevices();if(i.length===0)throw this.permissions.video="NO_DEVICES_AVAILABLE",w.emit(C.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"}),new b("No video devices available");const a=async c=>{try{let u=c;const{video:h}=u;n&&typeof h!="boolean"&&(u={video:{deviceId:h.deviceId}}),l.info("getUserMediaWithoutTimeout::requesting_user_media",{constraints:JSON.stringify(u)});const[p]=(await navigator.mediaDevices.getUserMedia(u)).getVideoTracks();if(n&&typeof h!="boolean"&&typeof h.width=="object"){const{width:f,height:v}=p.getSettings(),{ideal:y}=h.width;p.applyConstraints({width:{ideal:y},height:{ideal:Math.floor(v*y/f)},frameRate:h.frameRate})}return l.info("getUserMediaWithoutTimeout::received_user_media",{constraints:JSON.stringify(u)}),p}catch(u){const h=Uc("video",u.name,u.message),p=new du(u.name,u.message,c);if(h==="COULD_NOT_START"){if(!i.shift())throw p;return a({video:c.video})}throw p}};try{const c=d(this,kr).getVideoConstraints(t),u=await a(c);return this.permissions.video!=="ACCEPTED"&&(this.permissions.video="ACCEPTED",w.emit(C.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"})),u}catch(c){throw c.constraints&&this.handlePermissionErrors("video",c),new b(c.message,"1601")}}async getScreenShareTracks(){const t=async e=>{try{l.info("getDisplayMediaWithoutTimeout::requesting_display_media",{constraints:JSON.stringify(e)}),U.screenShareRequested();const r=await navigator.mediaDevices.getDisplayMedia(e);return l.info("getDisplayMediaWithoutTimeout::received_display_media",{constraints:JSON.stringify(e)}),r}catch(r){const n=Uc("video",r.name,r.message),i=new du(r.name,r.message,e),a={video:!0};if(VC(e,a)||!j.hasFeature(J.SCREEENSHARE_CONSTRAINTS_RETRY))throw i;if(n==="COULD_NOT_START")return t(a);throw i}};try{const e=d(this,kr).getScreenShareConstraints(),r=await t(e);return this.permissions.screenshare!=="ACCEPTED"&&(this.permissions.screenshare="ACCEPTED",w.emit(C.MEDIA_PERMISSION_UPDATE,{message:this.permissions.screenshare,kind:"screenshare"})),{audioTrack:r.getAudioTracks()[0],videoTrack:r.getVideoTracks()[0]}}catch(e){throw e.constraints&&this.handlePermissionErrors("screenshare",e),new b(e.message,"1601")}}async getCurrentDeviceLabel(t){const e=await this.getDevice(t||"default");return e==null?void 0:e.label}async getAvailableDevices(){try{const t=await navigator.mediaDevices.enumerateDevices();return this.availableDevices=t,t}catch(t){throw l.error("enumerate_devices_failed",{error:t}),new b("Failed to get available devices")}}async getAvailableDevicesByKind(t){try{return(await navigator.mediaDevices.enumerateDevices()).filter(({kind:e})=>t===e)}catch(e){throw l.error("enumerate_devices_failed",{error:e}),new b("Failed to get available devices by kind")}}async getDevice(t){try{return(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.deviceId===t)[0]}catch(e){throw l.error("enumerate_devices_failed",{error:e}),new b("Failed to get device")}}async onDeviceChange(t){we.supportsDeviceChangeEvent()&&navigator.mediaDevices.addEventListener("devicechange",async e=>{var u,h;const r=p=>`${p.kind}-${p.deviceId}`,n=this.availableDevices,i=new Set(n.map(p=>r(p))),a=await this.getAvailableDevices(),o=new Set(a.map(p=>r(p))),c={added:a.filter(p=>!i.has(r(p))),removed:n.filter(p=>!o.has(r(p))),devices:a};if((u=c.added)!=null&&u.length||(h=c.removed)!=null&&h.length){l.info("repopulated_full_device_list",{devices:JSON.stringify(a)});const p=[...c.added,...c.removed];U.onSafeInitialization(async()=>{p.some(f=>f.kind==="audioinput")&&U.devices("AUDIO",a==null?void 0:a.filter(f=>f.kind==="audioinput")),p.some(f=>f.kind==="videoinput")&&U.devices("VIDEO",a==null?void 0:a.filter(f=>f.kind==="videoinput")),p.some(f=>f.kind==="audiooutput")&&U.devices("SPEAKER",a==null?void 0:a.filter(f=>f.kind==="audiooutput"))}),t(e,c,!1)}},{signal:d(this,ki).signal})}},ki=new WeakMap,kr=new WeakMap,Td=new WeakMap,Av);hr([g.trace("WebMediaInterface.destruct")],jt.prototype,"destruct",1),hr([g.trace("WebMediaInterface.handlePermissionErrors")],jt.prototype,"handlePermissionErrors",1),hr([g.trace("WebMediaInterface.getAudioAndVideoTrack")],jt.prototype,"getAudioAndVideoTrack",1),hr([g.trace("WebMediaInterface.getAudioTrack")],jt.prototype,"getAudioTrack",1),hr([g.trace("WebMediaInterface.getVideoTrack")],jt.prototype,"getVideoTrack",1),hr([g.trace("WebMediaInterface.getScreenShareTracks")],jt.prototype,"getScreenShareTracks",1),hr([g.trace("WebMediaInterface.getAvailableDevices")],jt.prototype,"getAvailableDevices",1),hr([g.trace("WebMediaInterface.getAvailableDevicesByKind")],jt.prototype,"getAvailableDevicesByKind",1),hr([g.trace("WebMediaInterface.getDevice")],jt.prototype,"getDevice",1),hr([g.trace("WebMediaInterface.onDeviceChange")],jt.prototype,"onDeviceChange",1),jt=hr([mt("1600")],jt);const _g=jt,lu={setItem:(s,t)=>{try{localStorage.setItem(s,t)}catch(e){l.error("LocalStorage::setItem::crashed",{error:e,localStorage:{key:s,value:t}})}},getItem:s=>{try{return localStorage.getItem(s)}catch(t){l.error("LocalStorage::getItem::crashed",{error:t,localStorage:{key:s}})}return null}},H0=(s=0)=>new Promise(t=>setTimeout(t,s)),q0=(s,t,e)=>{const r=typeof e=="number"?e:250,n=s.createMediaStreamSource(t),i=s.createAnalyser();i.fftSize=2048,n.connect(i);const a=new Uint8Array(i.fftSize);let o=!1;setTimeout(()=>{o=!0},r);function c(){return o?Promise.resolve(!0):(i.getByteTimeDomainData(a),a.some(u=>u!==128&&u!==0)?Promise.resolve(!1):H0().then(c))}return c().then(u=>(n.disconnect(),u),u=>{throw n.disconnect(),u})},j0=typeof AudioContext!="undefined"?AudioContext:null;class uu{constructor(t){m(this,"_AudioContext");m(this,"audioContext");m(this,"_audioContextRefContainers");const e={AudioContext:j0,...t};Object.defineProperties(this,{_AudioContext:{value:e.AudioContext},audioContext:{value:null,writable:!0},_audioContextRefContainers:{value:new Set},AudioContextProvider:{enumerable:!0,value:uu}})}getOrCreate(t){if(!this._audioContextRefContainers.has(t)&&(this._audioContextRefContainers.add(t),this._AudioContext&&!this.audioContext))try{this.audioContext=new this._AudioContext}catch(e){}return this.audioContext}release(t){this._audioContextRefContainers.has(t)&&(this._audioContextRefContainers.delete(t),!this._audioContextRefContainers.size&&this.audioContext&&(this.audioContext.close(),this.audioContext=null))}}const Sg=new uu,G0=3,W0=250;function J0(s){const t={},e=Sg.getOrCreate(t);let r=G0;function n(){return r-=1,q0(e,s.srcObject,W0).then(i=>i?r>0?n():!0:!1).catch(()=>!0)}return n().finally(()=>{Sg.release(t)})}async function Eg(s){const t=new Audio,e=new MediaStream;e.addTrack(s),t.srcObject=e;let r=!1;try{const n=t.play();n&&await n,r=await J0(t),r&&l.info("checkIfAudioTrackIsSilent::silence_detected")}catch(n){l.error("checkIfAudioTrackIsSilent::failed_to_detect_silence",{error:n})}finally{t.pause(),t.remove()}return r}var K0=Object.defineProperty,z0=Object.getOwnPropertyDescriptor,Y0=(s,t,e,r)=>{for(var n=r>1?void 0:r?z0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&K0(t,e,n),n};let hu=class extends Qn{constructor(t,e,r){super();m(this,"constructorName",this.constructor.name);m(this,"userSelectedDevice");m(this,"mediaInterface");m(this,"isNonPreferredDevice");m(this,"_mediaTrack");m(this,"transformedMediaTrack");m(this,"middlewares",[]);m(this,"currentDevice");this.mediaInterface=t,e&&this.setMediaTrack(e),this.userSelectedDevice=void 0,this.isNonPreferredDevice=r,this.onTrackEnded=this.onTrackEnded.bind(this),this.onTrackMuted=this.onTrackMuted.bind(this)}disableTrack(){var t,e;this.removeMediaTrackListeners(),(t=this._mediaTrack)==null||t.stop(),this._mediaTrack=void 0,(e=this.transformedMediaTrack)==null||e.stop(),this.transformedMediaTrack=void 0}get mediaTrack(){return this._mediaTrack}async setMediaTrack(t){const e=r=>{l.error(`${this.constructorName}.setMediaTrack.error`,{error:r})};try{this.disableTrack()}catch(r){e(r)}this._mediaTrack=await this.conditionallyChangeTrack(t),await this.setTransformedTrack();try{this.addMediaTrackListeners(),await this.setCurrentDevice()}catch(r){e(r)}}get trackEnabled(){return!!this.mediaTrack&&this.mediaTrack.readyState==="live"&&this.mediaTrack.enabled}muteTrack(){if(!this.mediaTrack){l.warn("BaseMediaHandler.muteTrack Tried muting with no track present");return}this.transformedMediaTrack&&(this.transformedMediaTrack.enabled=!1),this.mediaTrack.enabled=!1}async unmuteTrack(){try{this.mediaTrack?this.mediaTrack.enabled=!0:await this.enableTrack(!1)}catch(t){throw l.error(`${this.constructorName}.unmuteTrack.error`,{error:t}),this.disableTrack(),new b("Failed to unmute track")}}async setCurrentDevice(){var t;if(!this.mediaTrack){this.currentDevice=void 0;return}((t=this.currentDevice)==null?void 0:t.deviceId)!==this.mediaTrack.getSettings().deviceId&&(this.currentDevice=await this.mediaInterface.getDevice(this.mediaTrack.getSettings().deviceId))}async addMiddleware(t){if(we.isWebKitBased()&&!j.hasFeature(J.ALLOW_SAFARI_MEDIA_MIDDLEWARES))return{success:!1,message:"Middlewares are not supported in this WebKit engine based browser."};if(this.middlewares.includes(t))return{success:!1,message:"This middleware has been applied, already. Skipping."};try{return this.middlewares.push(t),this.trackEnabled&&await this.setTransformedTrack(),{success:!0,message:"Successfully added the middleware."}}catch(e){return l.error("While adding middleware",{error:e}),this.removeMiddleware(t),{success:!1,message:e==null?void 0:e.message}}}async removeMiddleware(t){const e=this.middlewares.indexOf(t,0);if(e>-1)try{return this.middlewares.splice(e,1),await this.setTransformedTrack(!0),{success:!0,message:"Successfully removed the middleware."}}catch(r){return l.error("While removing middleware",{error:r}),{success:!1,message:r==null?void 0:r.message}}return{success:!1,message:"No such middleware was found. Skipping."}}addMediaTrackListeners(){var t,e,r;this.mediaTrack&&(l.info(`${this.constructorName}.addMediaTrackListeners for deviceId ${(e=(t=this.mediaTrack)==null?void 0:t.getSettings())==null?void 0:e.deviceId} of type ${(r=this.mediaTrack)==null?void 0:r.kind}`),this.mediaTrack.addEventListener("ended",this.onTrackEnded),this.mediaTrack.addEventListener("mute",this.onTrackMuted))}removeMediaTrackListeners(){var t,e,r;this.mediaTrack&&(l.info(`${this.constructorName}.removeMediaTrackListeners for deviceId ${(e=(t=this.mediaTrack)==null?void 0:t.getSettings())==null?void 0:e.deviceId} of type ${(r=this.mediaTrack)==null?void 0:r.kind}`),l.info(`${this.constructorName}.removeMediaTrackListeners`),this.mediaTrack.removeEventListener("ended",this.onTrackEnded),this.mediaTrack.removeEventListener("mute",this.onTrackMuted))}};hu=Y0([mt("1600")],hu);const wg=hu;var Q0=Object.defineProperty,X0=Object.getOwnPropertyDescriptor,pu=(s,t,e,r)=>{for(var n=r>1?void 0:r?X0(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&Q0(t,e,n),n};const mu="[Dyte]nonSilentDeviceLabels";class Bc extends wg{async setDevice(t){if(!t)throw l.warn("AudioMediaHandler.setDevice No device received"),new b("No device received!","1603");if(t.kind!=="audioinput")throw l.warn("AudioMediaHandler.setDevice Received non audio device"),new b("Non audio device received while setting device!","1603");try{const e=this.trackEnabled;this.userSelectedDevice=t.deviceId,await this.setMediaTrack(await this.mediaInterface.getAudioTrack(!e,t.deviceId))}catch(e){throw l.error("AudioMediaHandler.setDevice.error",{error:e}),this.disableTrack(),new b(e.message,"1604")}}async enableTrack(t){if(this.trackEnabled){l.warn("AudioMediaHandler.enableTrack Track already enabled!");return}const e=await this.mediaInterface.getAudioTrack(t,this.userSelectedDevice);await this.setMediaTrack(e)}async setTransformedTrack(t){var e;if(!t&&!((e=this.middlewares)!=null&&e.length)){this.transformedMediaTrack=this.mediaTrack;return}try{this.transformedMediaTrack=await P0(this.middlewares,this.mediaTrack),this.emit("trackChanged")}catch(r){l.error("AudioMediaHandler.setTransformedTrack",{error:r}),this.transformedMediaTrack=this.mediaTrack}}async onTrackEnded(){l.info("AudioMediaHandler.TrackEnded"),this.emit("trackEnded");const t=this.mediaTrack.enabled;this.disableTrack(),await this.enableTrack(!t),await this.setTransformedTrack(),this.emit("trackChanged")}onTrackMuted(){l.info("AudioMediaHandler.TrackMuted"),this.emit("trackMuted")}async conditionallyChangeTrack(t){var o;if(!t||this.userSelectedDevice)return t;let e=t;const r=await this.mediaInterface.getAudioInputDevices(),n=this.isNonPreferredDevice?r.filter(c=>c&&!this.isNonPreferredDevice(c)):r;if(!(n!=null&&n.length))return e;n.find(c=>c.deviceId===t.getSettings().deviceId)||(e.stop(),l.info("localmediahandler::setupstreams::found_audio_non_preferred"),e=await this.mediaInterface.getAudioTrack(!1,n[0].deviceId));const i=JSON.parse(lu.getItem(mu));if(i!=null&&i.devices.some(c=>c.label===e.label))return e;if(!await Eg(e)){const c=(o=i==null?void 0:i.devices.concat({label:e.label}))!=null?o:[{label:e.label}];return lu.setItem(mu,JSON.stringify({devices:c})),e}l.info("AudioMediaHandler.conditionallyChangeTrack.DetectedSilentTrack");const a=e.getSettings().deviceId;return n.filter(c=>c.deviceId!==a).some(async c=>{if(e=await this.mediaInterface.getAudioTrack(!1,c.deviceId),!await Eg(e)){const u=i.devices.concat({label:e.label});return lu.setItem(mu,JSON.stringify({devices:u})),l.info("AudioMediaHandler.conditionallyChangeTrack.SuccesfullyChangedTrack"),!0}return l.info("AudioMediaHandler.conditionallyChangeTrack.AnotherSilentTrackFound"),!1}),e}}pu([g.trace("AudioMediaHandler.setTransformedTrack")],Bc.prototype,"setTransformedTrack",1),pu([g.trace("AudioMediaHandler.onTrackEnded")],Bc.prototype,"onTrackEnded",1),pu([g.trace("AudioMediaHandler.conditionallyChangeTrack")],Bc.prototype,"conditionallyChangeTrack",1);const Z0=Bc;class eD{constructor(t){S(this,Ii,void 0);m(this,"currentDevice");T(this,Ii,t)}async setupSpeaker(t){var r;if(!(d(this,Ii)instanceof _g))return;let e=t;if(t||([e]=await d(this,Ii).getAvailableDevicesByKind("audiooutput")),!e)throw new b("No speaker found");((r=this.currentDevice)==null?void 0:r.deviceId)!==e.deviceId&&(this.currentDevice=e,document.querySelectorAll("audio").forEach(async n=>{if(typeof n.sinkId!="undefined"&&this.currentDevice.deviceId&&n.sinkId!==this.currentDevice.deviceId)try{await n.setSinkId(this.currentDevice.deviceId)}catch(i){}}))}}Ii=new WeakMap;const tD=eD;class rD extends Qn{constructor(e){super();m(this,"mediaInterface");m(this,"audioMediaTrack");m(this,"videoMediaTrack");this.mediaInterface=e}get trackEnabled(){return!!this.videoMediaTrack}async enableScreenShare(){var e,r;try{const{audioTrack:n,videoTrack:i}=await this.mediaInterface.getScreenShareTracks();if(this.audioMediaTrack=n,this.videoMediaTrack=i,this.addMediaTrackListeners(),((r=(e=this.mediaInterface)==null?void 0:e.permissions)==null?void 0:r.screenshare)==="ACCEPTED")return;this.mediaInterface.permissions&&(this.mediaInterface.permissions.screenshare="ACCEPTED",w.emit(C.MEDIA_PERMISSION_UPDATE,{message:this.mediaInterface.permissions.screenshare,kind:"screenshare"}))}catch(n){}}disableScreenShare(){var e,r;this.removeMediaTrackListeners(),(e=this.audioMediaTrack)==null||e.stop(),(r=this.videoMediaTrack)==null||r.stop(),this.videoMediaTrack=void 0,this.audioMediaTrack=void 0}async updateConstraints(e){if(!this.videoMediaTrack)throw new b("No media track enabled!");const r=this.mediaInterface;if(!r.constraintsBuilder)throw new b("update constraints not supported for non web clients","1100");try{this.videoMediaTrack.applyConstraints(r.constraintsBuilder.getUpdatedVideoConstraints(e)),this.addMediaTrackListeners()}catch(n){l.error("ScreenShareHandler.updateConstraints.error",{error:n})}}addMediaTrackListeners(){var e,r;(e=this.videoMediaTrack)==null||e.addEventListener("ended",this.onTrackEnded.bind(this)),we.isWebKitBased()&&((r=this.videoMediaTrack)==null||r.addEventListener("mute",this.onTrackEnded.bind(this)))}removeMediaTrackListeners(){var e,r;(e=this.videoMediaTrack)==null||e.removeEventListener("ended",this.onTrackEnded),(r=this.videoMediaTrack)==null||r.removeEventListener("mute",this.onTrackEnded)}onTrackEnded(){this.emit("trackEnded")}}const sD=rD;var nD=Object.defineProperty,iD=Object.getOwnPropertyDescriptor,Hc=(s,t,e,r)=>{for(var n=r>1?void 0:r?iD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&nD(t,e,n),n};class ya extends wg{constructor(e,r,n){super(e,r,n);S(this,Ai,void 0);S(this,$a,{disablePerFrameCanvasRendering:!1});T(this,Ai,new N0)}async setDevice(e){if(!e)throw l.warn("VideoMediaHandler.setDevice No device received"),new b("No device received!");if(e.kind!=="videoinput")throw l.warn("VideoMediaHandler.setDevice Received non video device",{devices:[e]}),new b("Non video device received while setting video device!");if(this.userSelectedDevice=e.deviceId,!(this.mediaTrack&&this.mediaTrack.enabled)){l.warn("VideoMediaHandler.setDevice Tried switching device with video disabled",{devices:[e]}),this.currentDevice=e;return}try{await this.setMediaTrack(await this.mediaInterface.getVideoTrack(this.userSelectedDevice))}catch(r){throw l.error("VideoMediaHandler.setDevice.error",{error:r}),this.disableTrack(),new b("Failed to change device")}}async enableTrack(){if(this.trackEnabled){l.warn("VideoMediaHandler.enableTrack Track already enabled!");return}await this.setMediaTrack(await this.mediaInterface.getVideoTrack(this.userSelectedDevice))}async setTransformedTrack(e){var r;if(!e&&!((r=this.middlewares)!=null&&r.length)){this.transformedMediaTrack=this.mediaTrack;return}try{this.transformedMediaTrack=await d(this,Ai).getTransformedVideoTrack(this.middlewares,this.mediaTrack,d(this,$a)),this.emit("trackChanged")}catch(n){l.error("VideoMediaHandler.setTransformedTrack",{error:n}),this.transformedMediaTrack=this.mediaTrack}}async setVideoMiddlewareGlobalConfig(e){T(this,$a,e)}async updateConstraints(e){if(!this._mediaTrack)throw new b("No media track enabled!");const r=this.mediaInterface;if(!r.constraintsBuilder)throw new b("update constraints not supported for non web clients","1100");try{this._mediaTrack.applyConstraints(r.constraintsBuilder.getUpdatedVideoConstraints(e)),await this.setTransformedTrack(),this.addMediaTrackListeners(),await this.setCurrentDevice()}catch(n){l.error("VideoMediaHandler.updateConstraints.error",{error:n})}}terminateMiddlewareWebWorker(){d(this,Ai).terminateMiddlewareWebWorker()}async onTrackEnded(){l.info("VideoMediaHandler.TrackEnded"),this.disableTrack(),this.emit("trackEnded")}onTrackMuted(){l.info("VideoMediaHandler.TrackMuted"),this.emit("trackMuted")}async conditionallyChangeTrack(e){if(!e||this.userSelectedDevice)return e;let r=e;const n=await this.mediaInterface.getVideoInputDevices(),i=this.isNonPreferredDevice?n.filter(a=>!this.isNonPreferredDevice(a)):n;return!(i!=null&&i.length)||window.FAST_DYTE||i.find(a=>a.deviceId===e.getSettings().deviceId)||(r.stop(),l.info("localmediahandler::setupstreams::found_video_non_preferred"),r=await this.mediaInterface.getVideoTrack(i[0].deviceId)),r}}Ai=new WeakMap,$a=new WeakMap,Hc([g.trace("VideoMediaHandler.setTransformedTrack")],ya.prototype,"setTransformedTrack",1),Hc([g.trace("VideoMediaHandler.setVideoMiddlewareGlobalConfig")],ya.prototype,"setVideoMiddlewareGlobalConfig",1),Hc([g.trace("VideoMediaHandler.onTrackEnded")],ya.prototype,"onTrackEnded",1),Hc([g.trace("VideoMediaHandler.conditionallyChangeTrack")],ya.prototype,"conditionallyChangeTrack",1);const aD=ya,Cg=wr(wl()),Di=class{constructor(t){S(this,Wt,void 0);S(this,Nn,void 0);S(this,Va,void 0);S(this,Mi,void 0);if(!t)throw new b("Could not load preset.");T(this,Wt,t.config),T(this,Va,t.name),T(this,Nn,t.ui||wr(wl().ui)),T(this,Mi,t.permissions.plugins.config)}static fromResponse(t){return new Di(t)}static default(){return new Di(Cg)}static init(t,e=!0){return!t||e?new Di(Cg):new Di(t)}get setupScreen(){return{isEnabled:!0}}get waitingRoom(){return{isEnabled:!0}}get controlBar(){return{isEnabled:!0,elements:{chat:!0,fullscreen:!0,invite:!1,layout:!1,participants:!0,plugins:!0,polls:!0,reactions:!1,screenshare:!0}}}get header(){return{isEnabled:!0,elements:{logo:d(this,Nn).designTokens.logo,timer:!0,title:!0,participantCount:!0,changeLayout:!1}}}get pipMode(){return!0}get viewType(){return d(this,Wt).viewType}get maxVideoStreams(){return d(this,Wt).maxVideoStreams}get maxScreenShareCount(){return d(this,Wt).maxScreenshareCount}get plugins(){return[]}get disabledPlugins(){return Object.keys(d(this,Mi)).filter(t=>d(this,Mi)[t].disabled)}get designTokens(){return d(this,Nn).designTokens}get configDiff(){return d(this,Nn).configDiff}get mediaConstraints(){var t,e,r,n,i,a,o,c,u,h,p,f,v,y,P,k,I,x,$,O,K,X,oe,Te;return{audio:{enableStereo:(n=(r=(e=(t=d(this,Wt))==null?void 0:t.media)==null?void 0:e.audio)==null?void 0:r.enableStereo)!=null?n:ti.audio.enableStereo,enableHighBitrate:(c=(o=(a=(i=d(this,Wt))==null?void 0:i.media)==null?void 0:a.audio)==null?void 0:o.enableHighBitrate)!=null?c:ti.audio.enableHighBitrate},video:{quality:(f=(p=(h=(u=d(this,Wt))==null?void 0:u.media)==null?void 0:h.video)==null?void 0:p.quality)!=null?f:ti.video.quality,frameRate:(k=(P=(y=(v=d(this,Wt))==null?void 0:v.media)==null?void 0:y.video)==null?void 0:P.frameRate)!=null?k:ti.video.frameRate},screenshare:{quality:(O=($=(x=(I=d(this,Wt))==null?void 0:I.media)==null?void 0:x.screenshare)==null?void 0:$.quality)!=null?O:ti.screenshare.quality,frameRate:(Te=(oe=(X=(K=d(this,Wt))==null?void 0:K.media)==null?void 0:X.screenshare)==null?void 0:oe.frameRate)!=null?Te:ti.screenshare.frameRate}}}get name(){return d(this,Va)}};let fu=Di;Wt=new WeakMap,Nn=new WeakMap,Va=new WeakMap,Mi=new WeakMap;var oD=Object.defineProperty,cD=Object.getOwnPropertyDescriptor,bg=(s,t,e,r)=>{for(var n=r>1?void 0:r?cD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&oD(t,e,n),n};class gu extends Ht{constructor(e){super();S(this,Oi,void 0);m(this,"state","IDLE");m(this,"playbackUrl");m(this,"viewerCount");T(this,Oi,e),this.viewerCount=0}setLivestreamState(e){const r=this.state;this.state=e,r!==e&&this.emitCurrentLivestreamState()}emitCurrentLivestreamState(){this.emit("livestreamUpdate",this.state)}async start(){if(!d(this,Oi).permissions.canLivestream)throw l.error("DyteLivestream::start::permission_denied"),new b("User does not have permission to start livestreaming");this.setLivestreamState("STARTING");try{const r=await Je().startLivestreaming();this.playbackUrl=r}catch(e){throw l.error("DyteRecording::stop::livestream_failed_to_start",{error:e}),this.setLivestreamState("IDLE"),new b("Error while starting livestream")}}async stop(){if(!d(this,Oi).permissions.canLivestream)throw l.error("DyteLivestream::stop::permission_denied"),new b("User does not have permission to stop livestreaming");if(this.state!=="LIVESTREAMING")throw l.error("DyteLivestream::stop::inconsistent_state"),new b("Livestream not started yet");try{this.setLivestreamState("STOPPING"),await Je().stopLivestreaming()}catch(e){throw l.error("DyteLivestream::stop::livestream_failed_to_stop",{error:e}),this.setLivestreamState("STOPPING"),new b("Error while stopping livestream")}}}Oi=new WeakMap,bg([g.trace("livestream.start")],gu.prototype,"start",1),bg([g.trace("livestream.stop")],gu.prototype,"stop",1);var dD=Object.defineProperty,lD=Object.getOwnPropertyDescriptor,uD=(s,t,e,r)=>{for(var n=r>1?void 0:r?lD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&dD(t,e,n),n};class Pg{constructor(t,e){m(this,"livestream");S(this,Ni,void 0);S(this,ks,void 0);this.livestream=new gu(t),T(this,ks,e),this.setupEvents()}async fetchInitialLivestreamingState(){const t=Je(),{status:e,playbackUrl:r}=await t.getActiveLivestream();this.livestream.playbackUrl=r,e==="LIVE"&&this.livestream.setLivestreamState("LIVESTREAMING")}setupEvents(){d(this,ks).on(V.startedLivestream,t=>{this.livestream.playbackUrl=t.playbackUrl,this.livestream.setLivestreamState("LIVESTREAMING")}),d(this,ks).on(V.stoppedLivestream,()=>{this.livestream.setLivestreamState("IDLE"),this.livestream.playbackUrl=void 0}),d(this,ks).on(V.erroredLivestream,()=>{this.livestream.setLivestreamState("IDLE"),this.livestream.playbackUrl=void 0}),d(this,ks).on(V.roomPeerCount,t=>{this.livestream.viewerCount=t.count,this.livestream.emit("viewerCountUpdate",t.count)}),w.on(C.PEER_JOINED_INTERNAL,async t=>{var e;((e=t.flags)==null?void 0:e.hiddenParticipant)===!0&&t.recorderType==="LIVESTREAMER"&&(T(this,Ni,t.id),this.livestream.setLivestreamState("LIVESTREAMING"))}),w.on(C.PEER_CLOSED,t=>{t.id===d(this,Ni)&&(T(this,Ni,void 0),this.livestream.setLivestreamState("IDLE"))}),w.onAsync(C.LEAVE_MEDIA_ROOM,async()=>{this.livestream.playbackUrl||(l.info("Fetching livestreaming state on leave stage"),await this.fetchInitialLivestreamingState())}),w.on(C.SOCKET_SERVICE_ROOM_JOINED,async()=>{try{await this.fetchInitialLivestreamingState()}catch(t){l.error("Error: LivestreamController.fetchLivestream")}})}}Ni=new WeakMap,ks=new WeakMap,uD([g.trace("LivestreamController.setupEvents")],Pg.prototype,"setupEvents",1);var hD=Object.defineProperty,pD=Object.getOwnPropertyDescriptor,Ta=(s,t,e,r)=>{for(var n=r>1?void 0:r?pD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&hD(t,e,n),n};const _a={maxInvocations:5,period:1};class ri{constructor({name:t,socketHandler:e,meetingId:r}){S(this,_d);m(this,"name","");S(this,Tt,{});S(this,Is,"");S(this,As,void 0);m(this,"volatile");m(this,"rateLimitConfig",{maxInvocations:5,period:1});m(this,"bulkRateLimitConfig",{maxInvocations:5,period:1});m(this,"listeners",{});this.name=t,T(this,As,e),T(this,Is,r)}async set(t,e,r=!0,n=!1){d(this,Tt)[t]=e,r&&d(this,As).storeInsertKeys(d(this,Is),this.name,[{key:t,payload:e}]),n&&(this.listeners[t]&&this.listeners[t].forEach(i=>i({[t]:d(this,Tt)[t]})),this.listeners["*"]&&this.listeners["*"].forEach(i=>i({[t]:d(this,Tt)[t]})))}async bulkSet(t){t.forEach(({key:e,payload:r})=>{d(this,Tt)[e]=r}),d(this,As).storeInsertKeys(d(this,Is),this.name,t)}async update(t,e,r=!0){le(this,_d,Bv).call(this,t,e,r)}async delete(t,e=!0,r=!1){if(d(this,Tt)[t]&&delete d(this,Tt)[t],e)return d(this,As).storeDeleteKeys(d(this,Is),this.name,[{key:t}]);r&&(this.listeners[t]&&(this.listeners[t].forEach(n=>n({[t]:void 0})),delete this.listeners[t]),this.listeners["*"]&&this.listeners["*"].forEach(n=>n({[t]:void 0})))}async bulkDelete(t){return t.forEach(({key:e})=>{d(this,Tt)[e]&&delete d(this,Tt)[e]}),d(this,As).storeDeleteKeys(d(this,Is),this.name,t)}get(t){if(d(this,Tt)[t])return d(this,Tt)[t]}getAll(){return d(this,Tt)}get rateLimits(){return this.rateLimitConfig}updateRateLimits(t,e){this.rateLimitConfig.maxInvocations=t,this.rateLimitConfig.period=e}get bulkRateLimits(){return this.bulkRateLimitConfig}updateBulkRateLimits(t,e){this.bulkRateLimitConfig.maxInvocations=t,this.bulkRateLimitConfig.period=e}subscribe(t,e){if(this.listeners[t]){this.listeners[t].push(e);return}this.listeners[t]=[e]}unsubscribe(t,e){var r;if(e){this.listeners[t]=((r=this.listeners[t])==null?void 0:r.filter(n=>n!==e))||[];return}this.listeners[t]&&delete this.listeners[t]}populate(t){T(this,Tt,t)}}Tt=new WeakMap,Is=new WeakMap,As=new WeakMap,_d=new WeakSet,Bv=function(t,e,r=!0){let n;const i=d(this,Tt)[t],a=Object.prototype.toString.call(e),o=Object.prototype.toString.call(i);if(a!==o){this.set(t,e);return}switch(o){case"[object Array]":n=[...i,...e];break;case"[object Object]":n={...i,...e};break;case"[object Map]":n=new Map([...i,...e]);break;case"[object Set]":n=new Set([...i,...e]);break;default:n=e;break}this.set(t,n,r)},Ta([Ot(_a,"rateLimitConfig")],ri.prototype,"set",1),Ta([Ot(_a,"bulkRateLimitConfig")],ri.prototype,"bulkSet",1),Ta([Ot(_a,"rateLimitConfig")],ri.prototype,"update",1),Ta([Ot(_a,"rateLimitConfig")],ri.prototype,"delete",1),Ta([Ot(_a,"bulkRateLimitConfig")],ri.prototype,"bulkDelete",1);class mD{constructor(t,e){S(this,Ba);S(this,Sd);m(this,"stores",new Map);S(this,Ln,void 0);S(this,Fn,"");S(this,Ha,void 0);S(this,Ms,new Map);T(this,Ln,e),T(this,Fn,t.getValue("meetingId")),T(this,Ha,t),le(this,Sd,Hv).call(this)}create(t){const e=new ri({name:t,socketHandler:d(this,Ln),meetingId:d(this,Fn)});return d(this,Ln).storeGetKeys(d(this,Fn),t,[]),new Promise((n,i)=>{const a=setTimeout(()=>i(Error("Failed")),3e3);d(this,Ms).set(t,{rejectTimeout:a,resolve:n,store:e})})}}Ln=new WeakMap,Fn=new WeakMap,Ba=new WeakSet,Gu=function(){return d(this,Ha).getValue("peerId")},Ha=new WeakMap,Ms=new WeakMap,Sd=new WeakSet,Hv=function(){[G.storeInsertKeys,G.storeGetKeys,G.storeDeleteKeys].forEach(t=>{d(this,Ln).on(t,async e=>{var i,a;if(e.pluginId!==d(this,Fn))return;const r=(i=e.storeItems)==null?void 0:i.map(o=>{var c;return{timestamp:o.timestamp,peerId:o.peerId,payload:JSON.parse((c=o.payload)!=null&&c.length?new TextDecoder().decode(o.payload):"{}"),key:o.storeKey}});if(t===G.storeGetKeys){const o=d(this,Ms).get(e.storeName),c=this.stores.get(e.storeName)||(o==null?void 0:o.store);d(this,Ms).get(e.storeName)&&(this.stores.set(e.storeName,o.store),o.resolve(c),clearTimeout(o.rejectTimeout),d(this,Ms).delete(e.storeName)),r.forEach(u=>{c.set(u.key,u.payload,!1,!1)});return}const n=this.stores.get(e.storeName)||((a=d(this,Ms).get(e.storeName))==null?void 0:a.store);n!==void 0&&(t===G.storeInsertKeys&&r.forEach(({key:o,peerId:c,payload:u})=>{c===d(this,Ba,Gu)&&t!==G.storeGetKeys||n.set(o,u,!1,!0)}),t===G.storeDeleteKeys&&r.forEach(({key:o,peerId:c})=>{c!==d(this,Ba,Gu)&&n.delete(o,!1,!0)}))})})};function un(s){var t,e,r,n,i,a,o,c,u,h,p,f,v;return s?{media:{audio:{enabled:s.audioEnabled,trackId:(t=s.audioTrack)==null?void 0:t.id,permission:"mediaPermissions"in s?(e=s.mediaPermissions)==null?void 0:e.audio:null},video:{enabled:s.videoEnabled,trackId:(r=s.videoTrack)==null?void 0:r.id,permission:"mediaPermissions"in s?(n=s.mediaPermissions)==null?void 0:n.video:null},screenshare:{enabled:s.screenShareEnabled,permission:"mediaPermissions"in s?(i=s.mediaPermissions)==null?void 0:i.screenshare:null,audio:{enabled:(o=(a=s.screenShareTracks)==null?void 0:a.audio)==null?void 0:o.enabled,trackId:(u=(c=s.screenShareTracks)==null?void 0:c.audio)==null?void 0:u.id},video:{enabled:(p=(h=s.screenShareTracks)==null?void 0:h.video)==null?void 0:p.enabled,trackId:(v=(f=s.screenShareTracks)==null?void 0:f.video)==null?void 0:v.id}}}}:{}}var fD=Object.defineProperty,gD=Object.getOwnPropertyDescriptor,si=(s,t,e,r)=>{for(var n=r>1?void 0:r?gD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&fD(t,e,n),n};const vD=.8,yD=1.2;let Hr=(Mv=class extends Ht{constructor(t,e,r,n){super();S(this,Ds);S(this,Ui);S(this,ja);m(this,"id");m(this,"userId");m(this,"name");m(this,"picture");m(this,"isHost");m(this,"customParticipantId");m(this,"flags");m(this,"device");m(this,"videoTrack");m(this,"audioTrack");m(this,"screenShareTracks");m(this,"videoEnabled");m(this,"audioEnabled");m(this,"screenShareEnabled");m(this,"producers");m(this,"manualProducerConfig");S(this,Li,void 0);m(this,"supportsRemoteControl",!1);S(this,Fi,void 0);m(this,"presetName");S(this,xi,void 0);S(this,Qr,void 0);S(this,qa,void 0);S(this,Os,new Map);S(this,Xr,1);S(this,Ed,Sr(t=>{if(!this.videoTrack)return;const{clientWidth:e,clientHeight:r}=t,{width:n,height:i}=this.videoTrack.getSettings();if(!n||!i)return;const a=i/r,o=n/e,c=Math.max(a,o);c>yD&&d(this,Xr)===1?(T(this,Xr,0),w.emit(C.MAX_SPATIAL_LAYER_CHANGE,{peerId:this.id,maxSpatialLayer:d(this,Xr)})):c<vD&&d(this,Xr)===0&&(T(this,Xr,1),w.emit(C.MAX_SPATIAL_LAYER_CHANGE,{peerId:this.id,maxSpatialLayer:d(this,Xr)}))},2e3));T(this,xi,t);const{id:i,userId:a,displayName:o,device:c,picture:u,isHost:h,flags:p,clientSpecificId:f,stageStatus:v,customParticipantId:y,audioMuted:P,audioTrack:k,videoEnabled:I=!1,videoTrack:x,producers:$,metadata:O}=e;this.id=i,this.userId=a,this.name=o,this.device=c,this.picture=u,this.isHost=h,this.flags=p,this.manualProducerConfig=Am,T(this,Fi,v!=null?v:"ON_STAGE"),this.customParticipantId=y!=null?y:f,this.audioEnabled=!P,this.audioTrack=k,this.videoEnabled=I,this.videoTrack=x,this.screenShareTracks={audio:void 0,video:void 0},this.producers=$!=null?$:[],this.presetName=O==null?void 0:O.preset_name,T(this,Li,!1),T(this,Qr,r),T(this,qa,n),this.setupEvents(),this.updateVideo=this.updateVideo.bind(this),le(this,ja,Wu).call(this)}get clientSpecificId(){return this.customParticipantId}get stageStatus(){return d(this,Fi)}get roomJoined(){var t;return((t=d(this,Ds,Zi))==null?void 0:t.roomJoined)===!0}setVideoEnabled(t,e=!0){this.videoEnabled=t,e&&(l.info("DyteParticipant::setVideoEnabled::videoUpdate",{...un(this)}),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}))}setAudioEnabled(t,e=!0){this.audioEnabled=t,e&&(l.info("DyteParticipant::setAudioEnabled::audioUpdate",{...un(this)}),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack}))}setScreenShareEnabled(t,e=!0){this.screenShareEnabled=t,e&&this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}setupEvents(){this.on("videoUpdate",le(this,ja,Wu))}async pin(){if(!this.roomJoined)throw new b("Can`t pin participant without joining room");if(!d(this,Qr).permissions.pinParticipant)throw new b("You do not have permission to pin participants.");return d(this,Ds,Zi).pinPeer(this.id)}async unpin(){if(!this.roomJoined)throw new b("Can`t unpin participant without joining room");if(!d(this,Qr).permissions.pinParticipant)throw new b("You do not have permission to unpin participants.");return d(this,Ds,Zi).pinPeer(null)}setIsPinned(t,e=!0){var n;T(this,Li,t);const r=t?"pinned":"unpinned";(n=d(this,Ui,Dd))==null||n.updateSource(this.id,{pinned:t}),e&&this.emit(r,this)}async disableAudio(){const t=this.id;if(l.info("DyteParticipant::disable_audio",{dyteParticipant:{id:t}}),!this.roomJoined)throw new b("Can`t disable participant audio without joining room");if(d(this,Qr).permissions.canDisableParticipantAudio)return d(this,Ds,Zi).disableAudio(t);throw l.error("DyteParticipant::unauthorized_disable_audio",{dyteParticipant:{id:t}}),new b("Unauthorized: User does not have permission to disable participant audio.")}async kick(){const t=this.id;if(l.info("DyteParticipant::kick",{dyteParticipant:{id:t}}),!this.roomJoined)throw new b("Can`t kick participant without joining room");if(d(this,Qr).permissions.kickParticipant){await w.emitAsync(C.KICK_PEER,{peerId:t});return}throw l.error("DyteParticipant::unauthorized_kick",{dyteParticipant:{id:t}}),new b("Unauthorized: User does not have permission to kick participants.")}async disableVideo(){const t=this.id;if(l.info("DyteParticipant::disable_video",{dyteParticipant:{id:t}}),!this.roomJoined)throw new b("Can`t disable participant video without joining room");if(d(this,Qr).permissions.canDisableParticipantVideo)return d(this,Ds,Zi).disableVideo(t);throw l.error("DyteParticipant::unauthorized_disable_video",{dyteParticipant:{id:t}}),new b("Unauthorized: User does not have permission to disable participant video.")}async getPermissions(){return d(this,qa).getUserPermissions(this.userId)}setStageStatus(t){T(this,Fi,t),this.emit("stageStatusUpdate",this)}get isPinned(){return d(this,Li)}registerVideoElement(t){var r,n,i,a;let e;(n=(r=d(this,Os).get(t))==null?void 0:r.observer)==null||n.disconnect(),"ResizeObserver"in window&&(e=new ResizeObserver(()=>d(this,Ed).call(this,t)),e.observe(t)),d(this,Os).set(t,{observer:e}),this.updateVideo(t),(a=d(this,Ui,Dd))==null||a.addSource(this.id,t,this.videoEnabled,this.isPinned,this.name,this.picture,(i=this.raised)!=null?i:!1)}deregisterVideoElement(t){var e,r,n;t.srcObject=void 0,(r=(e=d(this,Os).get(t))==null?void 0:e.observer)==null||r.disconnect(),d(this,Os).delete(t),(n=d(this,Ui,Dd))==null||n.removeSource(this.id)}updateVideo(t){var e;if(this.videoEnabled){if(this.videoTrack==null)return;const r=(e=t.srcObject)==null?void 0:e.getTracks()[0];if((r==null?void 0:r.id)===this.videoTrack.id)return;const n=new MediaStream;n.addTrack(this.videoTrack),t.srcObject=n}else t.srcObject=void 0;t.style.display=this.videoEnabled?"block":"none"}},Li=new WeakMap,Fi=new WeakMap,xi=new WeakMap,Ds=new WeakSet,Zi=function(){return d(this,xi).getValue("roomNodeClient")},Qr=new WeakMap,qa=new WeakMap,Os=new WeakMap,Ui=new WeakSet,Dd=function(){return d(this,xi).getValue("pip")},Xr=new WeakMap,Ed=new WeakMap,ja=new WeakSet,Wu=function(){Array.from(d(this,Os).keys()).forEach(this.updateVideo)},Mv);si([g.trace("DyteParticipant.disableAudio")],Hr.prototype,"disableAudio",1),si([g.trace("DyteParticipant.kick")],Hr.prototype,"kick",1),si([g.trace("DyteParticipant.disableVideo")],Hr.prototype,"disableVideo",1),si([g.trace("DyteParticipant.getPermissions")],Hr.prototype,"getPermissions",1),si([g.trace("DyteParticipant.setStageStatus")],Hr.prototype,"setStageStatus",1),Hr=si([mt("1200")],Hr);class ni extends ag{constructor(t){const{onAddEvent:e="participantJoined",onDeleteEvent:r="participantLeft",onClearEvent:n="participantsCleared"}=t!=null?t:{};super({onAddEvent:e,onDeleteEvent:r,onClearEvent:n})}add(t,e=!0){return this.has(t.id)&&Object.is(this.get(t.id),t)===!1&&this.delete(t.id),super.add(t,e)}clear(t=!0,e=!1){return super.clear(t,e)}delete(t,e=!0,r=!1){return super.delete(t,e,r)}}class TD extends Qn{constructor(){super();S(this,Ns,void 0);T(this,Ns,new Map)}__set(e,r){return d(this,Ns).set(e,r)}__clear(){return d(this,Ns).clear()}get(e){return d(this,Ns).get(e)}toArray(){return Array.from(d(this,Ns).values())}}Ns=new WeakMap;var hn={},qc={},jc={},_D={get exports(){return jc},set exports(s){jc=s}},vu,Rg;function SD(){if(Rg)return vu;Rg=1;var s=1e3,t=s*60,e=t*60,r=e*24,n=r*7,i=r*365.25;vu=function(h,p){p=p||{};var f=typeof h;if(f==="string"&&h.length>0)return a(h);if(f==="number"&&isFinite(h))return p.long?c(h):o(h);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(h))};function a(h){if(h=String(h),!(h.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(h);if(p){var f=parseFloat(p[1]),v=(p[2]||"ms").toLowerCase();switch(v){case"years":case"year":case"yrs":case"yr":case"y":return f*i;case"weeks":case"week":case"w":return f*n;case"days":case"day":case"d":return f*r;case"hours":case"hour":case"hrs":case"hr":case"h":return f*e;case"minutes":case"minute":case"mins":case"min":case"m":return f*t;case"seconds":case"second":case"secs":case"sec":case"s":return f*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return f;default:return}}}}function o(h){var p=Math.abs(h);return p>=r?Math.round(h/r)+"d":p>=e?Math.round(h/e)+"h":p>=t?Math.round(h/t)+"m":p>=s?Math.round(h/s)+"s":h+"ms"}function c(h){var p=Math.abs(h);return p>=r?u(h,p,r,"day"):p>=e?u(h,p,e,"hour"):p>=t?u(h,p,t,"minute"):p>=s?u(h,p,s,"second"):h+" ms"}function u(h,p,f,v){var y=p>=f*1.5;return Math.round(h/f)+" "+v+(y?"s":"")}return vu}function ED(s){e.debug=e,e.default=e,e.coerce=c,e.disable=i,e.enable=n,e.enabled=a,e.humanize=SD(),e.destroy=u,Object.keys(s).forEach(h=>{e[h]=s[h]}),e.names=[],e.skips=[],e.formatters={};function t(h){let p=0;for(let f=0;f<h.length;f++)p=(p<<5)-p+h.charCodeAt(f),p|=0;return e.colors[Math.abs(p)%e.colors.length]}e.selectColor=t;function e(h){let p,f=null,v,y;function P(...k){if(!P.enabled)return;const I=P,x=Number(new Date),$=x-(p||x);I.diff=$,I.prev=p,I.curr=x,p=x,k[0]=e.coerce(k[0]),typeof k[0]!="string"&&k.unshift("%O");let O=0;k[0]=k[0].replace(/%([a-zA-Z%])/g,(X,oe)=>{if(X==="%%")return"%";O++;const Te=e.formatters[oe];if(typeof Te=="function"){const It=k[O];X=Te.call(I,It),k.splice(O,1),O--}return X}),e.formatArgs.call(I,k),(I.log||e.log).apply(I,k)}return P.namespace=h,P.useColors=e.useColors(),P.color=e.selectColor(h),P.extend=r,P.destroy=e.destroy,Object.defineProperty(P,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(v!==e.namespaces&&(v=e.namespaces,y=e.enabled(h)),y),set:k=>{f=k}}),typeof e.init=="function"&&e.init(P),P}function r(h,p){const f=e(this.namespace+(typeof p=="undefined"?":":p)+h);return f.log=this.log,f}function n(h){e.save(h),e.namespaces=h,e.names=[],e.skips=[];let p;const f=(typeof h=="string"?h:"").split(/[\s,]+/),v=f.length;for(p=0;p<v;p++)f[p]&&(h=f[p].replace(/\*/g,".*?"),h[0]==="-"?e.skips.push(new RegExp("^"+h.slice(1)+"$")):e.names.push(new RegExp("^"+h+"$")))}function i(){const h=[...e.names.map(o),...e.skips.map(o).map(p=>"-"+p)].join(",");return e.enable(""),h}function a(h){if(h[h.length-1]==="*")return!0;let p,f;for(p=0,f=e.skips.length;p<f;p++)if(e.skips[p].test(h))return!1;for(p=0,f=e.names.length;p<f;p++)if(e.names[p].test(h))return!0;return!1}function o(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}function c(h){return h instanceof Error?h.stack||h.message:h}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.enable(e.load()),e}var wD=ED;(function(s,t){t.formatArgs=r,t.save=n,t.load=i,t.useColors=e,t.storage=a(),t.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function e(){return typeof window!="undefined"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document!="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function r(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;c.splice(1,0,u,"color: inherit");let h=0,p=0;c[0].replace(/%[a-zA-Z%]/g,f=>{f!=="%%"&&(h++,f==="%c"&&(p=h))}),c.splice(p,0,u)}t.log=console.debug||console.log||(()=>{});function n(c){try{c?t.storage.setItem("debug",c):t.storage.removeItem("debug")}catch(u){}}function i(){let c;try{c=t.storage.getItem("debug")}catch(u){}return!c&&typeof process!="undefined"&&"env"in process&&(c=process.env.DEBUG),c}function a(){try{return localStorage}catch(c){}}s.exports=wD(t);const{formatters:o}=s.exports;o.j=function(c){try{return JSON.stringify(c)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(_D,jc);var CD=Ne&&Ne.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(qc,"__esModule",{value:!0}),qc.Logger=void 0;const ii=CD(jc),ai="awaitqueue";class bD{constructor(t){t?(this._debug=(0,ii.default)(`${ai}:${t}`),this._warn=(0,ii.default)(`${ai}:WARN:${t}`),this._error=(0,ii.default)(`${ai}:ERROR:${t}`)):(this._debug=(0,ii.default)(ai),this._warn=(0,ii.default)(`${ai}:WARN`),this._error=(0,ii.default)(`${ai}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}qc.Logger=bD,Object.defineProperty(hn,"__esModule",{value:!0});var oi=hn.AwaitQueue=hn.AwaitQueueRemovedTaskError=hn.AwaitQueueStoppedError=void 0;const PD=qc,gs=new PD.Logger;class yu extends Error{constructor(t){super(t!=null?t:"AwaitQueue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,yu)}}hn.AwaitQueueStoppedError=yu;class Gc extends Error{constructor(t){super(t!=null?t:"AwaitQueue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Gc)}}hn.AwaitQueueRemovedTaskError=Gc;class RD{constructor(){this.pendingTasks=new Map,this.nextTaskId=0,this.stopping=!1}get size(){return this.pendingTasks.size}async push(t,e){if(e=e!=null?e:t.name,gs.debug(`push() [name:${e}]`),typeof t!="function")throw new TypeError("given task is not a function");if(e)try{Object.defineProperty(t,"name",{value:e})}catch(r){}return new Promise((r,n)=>{const i={id:this.nextTaskId++,task:t,name:e,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:a=>{if(i.completed)return;i.completed=!0,this.pendingTasks.delete(i.id),gs.debug(`resolving task [name:${i.name}]`),r(a);const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)},reject:a=>{if(!i.completed&&(i.completed=!0,this.pendingTasks.delete(i.id),gs.debug(`rejecting task [name:${i.name}]: %s`,String(a)),n(a),!this.stopping)){const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)}}};this.pendingTasks.set(i.id,i),this.pendingTasks.size===1&&this.execute(i)})}stop(){gs.debug("stop()"),this.stopping=!0;for(const t of this.pendingTasks.values())gs.debug(`stop() | stopping task [name:${t.name}]`);this.stopping=!1}remove(t){gs.debug(`remove() [taskIdx:${t}]`);const e=Array.from(this.pendingTasks.values())[t];if(!e){gs.debug(`stop() | no task with given idx [taskIdx:${t}]`);return}e.reject(new Gc)}dump(){const t=Date.now();let e=0;return Array.from(this.pendingTasks.values()).map(r=>({idx:e++,task:r.task,name:r.name,enqueuedTime:r.executedAt?r.executedAt-r.enqueuedAt:t-r.enqueuedAt,executionTime:r.executedAt?t-r.executedAt:0}))}async execute(t){if(gs.debug(`execute() [name:${t.name}]`),t.executedAt)throw new Error("task already being executed");t.executedAt=Date.now();try{const e=await t.task();t.resolve(e)}catch(e){t.reject(e)}}}oi=hn.AwaitQueue=RD;class kg{constructor(){m(this,"meetingTitle");m(this,"roomName");m(this,"roomUUID");S(this,Ga,void 0);m(this,"context");m(this,"authToken");m(this,"maxPreferredStreams");m(this,"roomJoined")}get peerId(){return this.context.getValue("peerId")}get sfuHandler(){return d(this,Ga)}get socketState(){return{state:void 0,reconnected:!1,reconnectionAttempt:void 0}}get mediaState(){return d(this,Ga).transportState}reconnect(){throw new b("Method not implemented.")}async partialJoinRoom(t,e,r=!1,n=void 0){throw new b("Method not implemented.")}async joinRoom(t,e,r={},n=!1,i=!1){throw new b("Method not implemented.")}async leaveRoom(){throw new b("Method not implemented.")}reset(t=!0){throw new b("Method not implemented")}async handleSocketCallbacks(t){throw new b("Method not implemented.")}async handleSockets(t,e){throw new b("Method not implemented.")}async shareMic(t){throw new b("Method not implemented.")}async shareWebcam(t){throw new b("Method not implemented.")}async shareScreen(t){throw new b("Method not implemented.")}async unmuteSelf(){throw new b("Method not implemented.")}async muteSelf(){throw new b("Method not implemented.")}async pauseWebcam(){throw new b("Method not implemented.")}async disableScreenShare(){throw new b("Method not implemented.")}async acceptWaitingRequest(t){throw new b("Method not implemented.")}async rejectWaitingRequest(t){throw new b("Method not implemented.")}async muteAll(t){throw new b("Method not implemented.")}async muteAllVideo(){throw new b("Method not implemented.")}async disableAudio(t){throw new b("Method not implemented.")}async disableVideo(t){throw new b("Method not implemented.")}async kickAll(){throw new b("Method not implemented.")}async kick(t){throw new b("Method not implemented.")}async pinPeer(t){throw new b("Method not implemented.")}getConsumers(){throw new b("Method not implemented.")}stopAllProducers(){throw new b("Method not implemented.")}async activatePeers(t){throw new b("Method not implemented.")}async deactivatePeers(t,e="default"){throw new b("Method not implemented.")}async createConsumers(t){throw new b("Method not implemented.")}async closeConsumers(t){throw new b("Method not implemented.")}async switchConsumersToLayer(t,e){throw new b("Method not implemented.")}}Ga=new WeakMap;var Ig={},Wc={},kD={get exports(){return Wc},set exports(s){Wc=s}},Ag=kD.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(s){return s.encoding?"rtpmap:%d %s/%s/%s":s.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(s){return s.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(s){return s.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(s){return"extmap:%d"+(s.direction?"/%s":"%v")+(s["encrypt-uri"]?" %s":"%v")+" %s"+(s.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(s){return s.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(s){var t="candidate:%s %d %s %d %s %d typ %s";return t+=s.raddr!=null?" raddr %s rport %d":"%v%v",t+=s.tcptype!=null?" tcptype %s":"%v",s.generation!=null&&(t+=" generation %d"),t+=s["network-id"]!=null?" network-id %d":"%v",t+=s["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(s){var t="ssrc:%d";return s.attribute!=null&&(t+=" %s",s.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(s){return s.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(s){return s.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(s){return"imageattr:%s %s %s"+(s.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(s){return"simulcast:%s %s"+(s.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(s){return"ts-refclk:%s"+(s.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(s){var t="mediaclk:";return t+=s.id!=null?"id=%s %s":"%v%s",t+=s.mediaClockValue!=null?"=%s":"",t+=s.rateNumerator!=null?" rate=%s":"",t+=s.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Ag).forEach(function(s){var t=Ag[s];t.forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})}),function(s){var t=function(o){return String(Number(o))===o?Number(o):o},e=function(o,c,u,h){if(h&&!u)c[h]=t(o[1]);else for(var p=0;p<u.length;p+=1)o[p+1]!=null&&(c[u[p]]=t(o[p+1]))},r=function(o,c,u){var h=o.name&&o.names;o.push&&!c[o.push]?c[o.push]=[]:h&&!c[o.name]&&(c[o.name]={});var p=o.push?{}:h?c[o.name]:c;e(u.match(o.reg),p,o.names,o.name),o.push&&c[o.push].push(p)},n=Wc,i=RegExp.prototype.test.bind(/^([a-z])=(.*)/);s.parse=function(o){var c={},u=[],h=c;return o.split(/(\r\n|\r|\n)/).filter(i).forEach(function(p){var f=p[0],v=p.slice(2);f==="m"&&(u.push({rtp:[],fmtp:[]}),h=u[u.length-1]);for(var y=0;y<(n[f]||[]).length;y+=1){var P=n[f][y];if(P.reg.test(v))return r(P,h,v)}}),c.media=u,c};var a=function(o,c){var u=c.split(/=(.+)/,2);return u.length===2?o[u[0]]=t(u[1]):u.length===1&&c.length>1&&(o[u[0]]=void 0),o};s.parseParams=function(o){return o.split(/;\s?/).reduce(a,{})},s.parseFmtpConfig=s.parseParams,s.parsePayloads=function(o){return o.toString().split(" ").map(Number)},s.parseRemoteCandidates=function(o){for(var c=[],u=o.split(" ").map(t),h=0;h<u.length;h+=3)c.push({component:u[h],ip:u[h+1],port:u[h+2]});return c},s.parseImageAttributes=function(o){return o.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(a,{})})},s.parseSimulcastStreamList=function(o){return o.split(";").map(function(c){return c.split(",").map(function(u){var h,p=!1;return u[0]!=="~"?h=t(u):(h=t(u.substring(1,u.length)),p=!0),{scid:h,paused:p}})})}}(Ig);var Tu=Wc,ID=/%[sdv%]/g,AD=function(s){var t=1,e=arguments,r=e.length;return s.replace(ID,function(n){if(t>=r)return n;var i=e[t];switch(t+=1,n){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}})},Sa=function(s,t,e){var r=t.format instanceof Function?t.format(t.push?e:e[t.name]):t.format,n=[s+"="+r];if(t.names)for(var i=0;i<t.names.length;i+=1){var a=t.names[i];t.name?n.push(e[t.name][a]):n.push(e[t.names[i]])}else n.push(e[t.name]);return AD.apply(null,n)},MD=["v","o","s","i","u","e","p","c","b","t","r","z","a"],DD=["i","c","b","a"],OD=function(s,t){t=t||{},s.version==null&&(s.version=0),s.name==null&&(s.name=" "),s.media.forEach(function(i){i.payloads==null&&(i.payloads="")});var e=t.outerOrder||MD,r=t.innerOrder||DD,n=[];return e.forEach(function(i){Tu[i].forEach(function(a){a.name in s&&s[a.name]!=null?n.push(Sa(i,a,s)):a.push in s&&s[a.push]!=null&&s[a.push].forEach(function(o){n.push(Sa(i,a,o))})})}),s.media.forEach(function(i){n.push(Sa("m",Tu.m[0],i)),r.forEach(function(a){Tu[a].forEach(function(o){o.name in i&&i[o.name]!=null?n.push(Sa(a,o,i)):o.push in i&&i[o.push]!=null&&i[o.push].forEach(function(c){n.push(Sa(a,o,c))})})})}),n.join(`\r
`)+`\r
`},pn=Ig,ND=OD,LD=ND,_u=pn.parse;pn.parseParams,pn.parseFmtpConfig,pn.parsePayloads,pn.parseRemoteCandidates,pn.parseImageAttributes,pn.parseSimulcastStreamList;var qr=(s=>(s.INITIALIZING="INITIALIZING",s.INITIALIZED="INITIALIZED",s.NOT_INITIALIZED="NOT_INITIALIZED",s))(qr||{});class Mg extends ce.EventEmitter{}class mn extends ce.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(t,...e){const r=this.listenerCount(t);try{return this.emit(t,...e)}catch(n){return l.error(`EnhancedEventEmitter:: safeEmit() | event listener ${t} threw an error`,{error:n}),Boolean(r)}}async safeEmitAsPromise(t,...e){const r={}.EVENT_PROMISE_TIMEOUT?parseInt({}.EVENT_PROMISE_TIMEOUT,10):1e4;return this.safeEmitAsPromiseWithTimeout(t,r,...e)}async safeEmitAsPromiseWithTimeout(t,e,...r){return new Promise((n,i)=>{setTimeout(i,e,"event request timeout");try{this.emit(t.toString(),...r,n,i)}catch(a){l.error(`EnhancedEventEmitter:: safeEmitAsPromise() | event listener for event ${t.toString()} threw an error [event:%s]:%o`,{error:a}),i(a)}})}}function FD(s,t){const e=new Error(t);return e.name=s,e}class fn extends b{constructor(t){super(t),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,fn):this.stack=new Error(t).stack}}class lt extends b{constructor(t){super(t),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,lt):this.stack=new Error(t).stack}}class Dg extends mn{constructor({id:e,localId:r,producerId:n,producingPeerId:i,producingTransportId:a,handler:o,track:c,appData:u,paused:h,reuseTrack:p,rtpReceiver:f}){super();S(this,eo);S(this,wd);S(this,Cd);m(this,"rtpReceiver");m(this,"observer");S(this,Wa,void 0);S(this,Ja,void 0);S(this,Ka,void 0);S(this,za,void 0);S(this,Ir,void 0);S(this,Ya,void 0);S(this,Qa,void 0);S(this,fr,void 0);S(this,xn,void 0);S(this,Xa,void 0);S(this,Za,void 0);T(this,Wa,e),T(this,Ja,r),T(this,Qa,o),T(this,Za,u),T(this,Xa,i),T(this,za,a),T(this,Ir,!1),T(this,Ka,n),T(this,fr,c),T(this,xn,h!=null?h:!1),T(this,Ya,p),this.observer=new mn,this.rtpReceiver=f,le(this,wd,qv).call(this)}get id(){return d(this,Wa)}get peerId(){return d(this,Xa)}get localId(){return d(this,Ja)}get producerId(){return d(this,Ka)}get producingTransportId(){return d(this,za)}get closed(){return d(this,Ir)}get kind(){return d(this,fr).kind}get track(){return d(this,fr)}get paused(){return d(this,xn)}get remotelyPaused(){return this.paused}get appData(){return d(this,Za)}close(e){d(this,Ir)||(l.debug("Consumer::close() with reason:",{consumer:{id:this.id,appData:this.appData,peerId:this.peerId,closureReason:e,kind:this.kind}}),T(this,Ir,!0),d(this,Ya)||le(this,Cd,jv).call(this),this.emit("close",e),this.observer.safeEmit("close",e))}async getStats(){if(d(this,Ir))throw new lt("closed");return d(this,Qa).getReceiverStats(this.localId)}pause(){if(l.debug("consumer::pause()",{consumer:{id:this.id,appData:this.appData,peerId:this.peerId,kind:this.kind}}),d(this,Ir)){l.error("consumer::pause() | Consumer closed",{consumer:{id:this.id,appData:this.appData,peerId:this.peerId,kind:this.kind}});return}T(this,xn,!0),d(this,fr).enabled=!1,this.observer.safeEmit("pause")}resume(){if(l.debug("consumer::resume()",{consumer:{id:this.id,appData:this.appData,peerId:this.peerId,kind:this.kind}}),d(this,Ir)){l.error("Consumer::resume() | Consumer closed",{consumer:{id:this.id,appData:this.appData,peerId:this.peerId,kind:this.kind}});return}T(this,xn,!1),d(this,fr).enabled=!0,this.observer.safeEmit("resume")}}Wa=new WeakMap,Ja=new WeakMap,Ka=new WeakMap,za=new WeakMap,Ir=new WeakMap,Ya=new WeakMap,Qa=new WeakMap,fr=new WeakMap,xn=new WeakMap,Xa=new WeakMap,Za=new WeakMap,eo=new WeakSet,Ju=function(){l.debug('Consumer::track "ended" event',{consumer:{id:this.id,appData:this.appData,peerId:this.peerId,kind:this.kind}}),this.safeEmit("trackended"),this.observer.safeEmit("trackended")},wd=new WeakSet,qv=function(){d(this,fr).addEventListener("ended",le(this,eo,Ju).bind(this))},Cd=new WeakSet,jv=function(){try{d(this,fr).removeEventListener("ended",le(this,eo,Ju)),d(this,fr).stop()}catch(e){l.error("Consumer::destroyTrack()",{consumer:{id:this.id,appData:this.appData,peerId:this.peerId,kind:this.kind},error:e})}};let xD=class extends Dg{};const Og=s=>new Promise(t=>setTimeout(t,s));async function br(s,t){return new Promise(async(e,r)=>{const{strategy:n,maxRetryCount:i,delayTime:a}={strategy:"linear",maxRetryCount:3,delayTime:10,...t};let o=0,c,u=!1;const h=p=>{u=!0,r(p)};for(;o<i;){try{const p=await s(o,h);return e(p)}catch(p){if(c=p,u)break;if(o<i)n==="linear"?await Og(a*(o+1)):n==="exponential"&&await Og(a*(o+Math.max(0,o-1)));else break}o+=1}return r(c)})}function Jc(s){if(Promise.allSettled)return Promise.allSettled(s);const t=s.map(e=>e.then(r=>({status:"fulfilled",value:r})).catch(r=>({status:"rejected",reason:r})));return Promise.all(t)}function UD(s,t){return typeof s=="undefined"?t:typeof window!="undefined"&&Object.getOwnPropertyDescriptor(window,"structuredClone")?structuredClone(s):JSON.parse(JSON.stringify(s))}function Ng(s){return typeof s=="object"&&!Array.isArray(s)&&s!==null}function Su(s){return Math.random().toString(36).substring(2,2+s)}const Kc=1;function Lg(s){const t=s;return delete t.payload._bolt,t}function $D(s){return s.payload&&Ng(s.payload)}function zc(s){var t,e;return $D(s)&&(e=(t=s.payload._bolt)==null?void 0:t.id)!=null?e:""}const $i=class extends ce.EventEmitter{constructor(e,r,n){super();m(this,"channel");m(this,"queue");m(this,"serverProtocolVersion");S(this,Ls,new Map);m(this,"respond",(e,r,n=!1)=>{let i;n?i=$i.createErrorResponse(e,r):i=$i.createResponse(e,r),this.channel.send(JSON.stringify(i))});m(this,"notify",e=>{const r=$i.createNotification(e);this.channel.send(JSON.stringify(r))});m(this,"request",async e=>{const r=$i.createRequest(e),n=new Promise((i,a)=>{const o=1e3*(5+.1*this.queue.size),{id:c}=r.payload._bolt,u={id:c,method:r.type,resolve:h=>{this.queue.delete(c)&&(clearTimeout(u.timer),i(h))},timer:setTimeout(()=>{this.queue.delete(c)&&a(new Error(`request timeout for message id: ${c}`))},o),cancel:h=>{this.queue.delete(c)&&(clearTimeout(u.timer),a(h))}};this.queue.set(c,u)});return this.channel.send(JSON.stringify(r)),n});m(this,"send",e=>{const r=JSON.stringify(e),n=16384;if(r.length>n){const i=n-200,a=Math.ceil(r.length/i),o=[];for(let u=0;u<a;u+=1){const h=u*i,p=(u+1)*i;o.push(r.slice(h,p))}const c=Ys();for(let u=0;u<a;u+=1){const h=o[u],f=JSON.stringify({id:c,count:a,chunkIndex:u,chunk:h});l.debug(`Sending message chunk over dc: ${f}`),this.channel.send(f)}}else l.debug(`Sending message over dc: ${r}`),this.channel.send(r)});m(this,"processMessage",e=>{var n;d(this,Ls).has(e.id)||d(this,Ls).set(e.id,[]);const r=d(this,Ls).get(e.id);if(r[e.chunkIndex]=e,(r==null?void 0:r.length)===e.count&&!r.some(i=>i===void 0)){const i=d(this,Ls).get(e.id),a=i==null?void 0:i.reduce((c,u)=>c+u.chunk,"");d(this,Ls).delete(e.id);const o=JSON.parse(a);if(!o.payload||!Ng(o.payload))throw new Error("corrupted incoming message over dc",{cause:{code:"CORRUPT_DC_MESSAGE",values:o}});if(this.processBoltHandshake(o))return;if(this.serverProtocolVersion=(n=o.payload._bolt)==null?void 0:n.version,!this.processResponseMsg(o))return o}});m(this,"processResponseMsg",e=>{const{id:r}=e.payload._bolt,n=this.queue.get(r);return n?(l.debug(`resolving pending request with id: ${r}, complete response: ${JSON.stringify(e)}`),e.type==="error"?n.cancel(Lg(e)):n.resolve(Lg(e)),!0):!1});m(this,"processBoltHandshake",e=>{var r,n;return e.type==="_bolt"||e.type==="handshake"?(this.respond((n=(r=e.payload._bolt)==null?void 0:r.id)!=null?n:Su(8),{type:"_bolt",payload:{message:"pong"}}),!0):!1});this.label=r,this.transportId=n,this.channel=e,this.queue=new Map}};let gn=$i;Ls=new WeakMap,m(gn,"createRequest",e=>{var r;if((r=e.payload)!=null&&r._bolt)throw new Error("rpc fields are internal values");return{type:e.type,payload:{...e.payload,_bolt:{id:Su(8),type:"REQUEST",version:Kc}}}}),m(gn,"createResponse",(e,r)=>{var n;if((n=r.payload)!=null&&n._bolt)throw new Error("rpc fields are internal values");return{type:r.type,payload:{...r.payload,_bolt:{id:e,type:"RESPONSE",version:Kc}}}}),m(gn,"createNotification",e=>{var r;if((r=e.payload)!=null&&r._bolt)throw new Error("rpc fields are internal values");return{type:e.type,payload:{...e.payload,bolt:{id:Su(8),type:"NOTIFY",version:Kc}}}}),m(gn,"createErrorResponse",(e,r)=>({type:"error",payload:{error:r.message,_bolt:{id:e,type:"RESPONSE",version:Kc}}}));const Eu="transport closed";class Fg extends mn{constructor({id:e,direction:r,handlerFactory:n,iceServers:i,iceTransportPolicy:a,proprietaryConstraints:o,additionalSettings:c,appData:u,config:h}){var f,v;super();m(this,"awaitQueue");m(this,"observer");m(this,"id");m(this,"serverId");m(this,"closed",!1);m(this,"direction");m(this,"maxSctpMessageSize");m(this,"handler");m(this,"connectionState","new");m(this,"producers");m(this,"consumers");m(this,"datachannels");m(this,"connected",!1);m(this,"eventsDCReadyPromise");m(this,"eventsDCReadyPromiseResolver");m(this,"eventsDCFailureTimer");m(this,"transportConnectionPromise");m(this,"consumerTrackEvents");m(this,"unknownTracksMap");m(this,"consumerTrackPool");m(this,"appData");l.debug(`constructor() [id: ${e}, direction: ${r}]`),this.id=e,this.direction=r;const p=UD(c,{});delete p.iceServers,delete p.iceTransportPolicy,delete p.bundlePolicy,delete p.rtcpMuxPolicy,delete p.sdpSemantics,this.producers=new Map,this.consumers=new Map,this.datachannels=new Map,this.consumerTrackEvents=new Map,this.consumerTrackPool=new Map,this.unknownTracksMap=new Map,this.awaitQueue=new oi,this.observer=new mn,this.handler=n(),this.handler._enableHighBitrate=(f=h==null?void 0:h.enableHighBitrate)!=null?f:!1,this.handler._enableStereo=(v=h==null?void 0:h.enableStereo)!=null?v:!1,this.handler.init({onTrackHandler:this._ontrack.bind(this),direction:r,iceServers:i,iceTransportPolicy:a,additionalSettings:c,proprietaryConstraints:o}),this.appData=u||{},this.transportConnectionPromise=new Promise(y=>{this.observer.once("connected",()=>{y(!0)}),this.observer.once("disconnect",()=>{y(!1)}),this.observer.once("close",()=>{y(!1)})}),this.eventsDCReadyPromise=new Promise(y=>{this.eventsDCReadyPromiseResolver=y}),this.handler.on("@connectionstatechange",y=>{y!==this.connectionState&&(l.debug(`connection state changed to ${y}`),this.connectionState=y,y==="connected"&&(this.connected=!0,this.observer.emit("connected")),y==="disconnected"&&(this.connected=!1,this.observer.emit("disconnect")),(y==="failed"||y==="closed")&&(this.connected=!1,this.observer.emit("close")),this.closed||this.safeEmit("connectionstatechange",y))}),this.handler.on("@icecandidate",({candidate:y})=>{this.closed||this.safeEmit("icecandidate",y)}),this.handler.on("dc_open",y=>{let P=this.datachannels.get(y.label);P||(P||(P=new gn(y,y.label,this.serverId),this.datachannels.set(y.label,P)),this.eventsDCFailureTimer=setTimeout(()=>{y.label==="events"&&(this.eventsDCReadyPromiseResolver(!1),this.safeEmit("dc_error",y.label))},5e3))}),this.handler.on("datachannel",(y,P)=>{y.label==="events"&&(this.eventsDCReadyPromiseResolver(!0),this.eventsDCFailureTimer&&clearTimeout(this.eventsDCFailureTimer));const k=this.datachannels.get(y.label);if(!k){l.error("unregistered datachannel for message",{rtcChannel:{label:y.label,message:P}});return}try{const I=JSON.parse(P);l.debug("datachannel message chunk recieved",{dataChannelMessageChunk:{id:I.id,count:I.count,chunkIndex:I.chunkIndex,chunk:I.chunk,transprtId:this.serverId}});const x=k.processMessage(I);if(!x)return;l.debug(`datachannel message with id:${I.id} on transport:${this.serverId}complete - ${JSON.stringify(x)}`),this.emit(`datachannel:${y.label}`,k.label,x)}catch(I){l.error("error parsing message",{error:I})}})}get isConnected(){return this.transportConnectionPromise}setServerId(e){this.serverId=e}getDatachannel(e){return this.datachannels.get(e)}get isEventsDCReady(){return this.eventsDCReadyPromise}close(){this.closed||(l.debug("Transport close called"),this.connected=!1,this.closed=!0,this.handler.close(),Array.from(this.producers.values()).forEach(e=>{e.close(Eu).catch(()=>{})}),this.producers.clear(),Array.from(this.consumers.values()).forEach(e=>{e.close(Eu)}),this.consumers.clear(),this.consumerTrackPool.clear(),this.consumerTrackEvents.clear(),this.emit("close"),this.observer.emit("close"))}async getStats(){if(this.closed)throw new lt("closed");return this.handler.getTransportStats()}async restartIce(){if(l.debug("restartIce()"),this.closed)throw new lt("closed");return this.handler.restartIce()}async updateIceServers({iceServers:e}={}){if(l.debug("updateIceServers()"),this.closed)throw new lt("closed");return this.handler.updateIceServers(e)}async setRemoteOffer(e){await this.setRemoteDescription(e);const r=await this.handler.pc.createAnswer(),n=_u(r.sdp);return n.media=n.media.map(i=>{if(i.type==="audio"){const a={...i},o=a.fmtp.find(u=>u.payload===111);return o&&(o.config+=";stereo=1;sprop-stereo=1"),a.rtcpFb||(a.rtcpFb=[]),a.rtcpFb.some(u=>u.type==="nack")||a.rtcpFb.push({payload:parseInt(a.payloads,10),type:"nack"}),a}return i}),r.sdp=LD(n),await this.setLocalDescription(r),r}sendErrorOverDC(e,r,n){const i=this.getDatachannel(e);if(!i)throw new Error("datachannel not found",{cause:{code:"DC_NOT_FOUND",values:{label:e}}});i.respond(r,n,!0)}sendResponseOverDC(e,r,n){const i=this.getDatachannel(e);if(!i)throw new Error("datachannel not found",{cause:{code:"DC_NOT_FOUND",values:{label:e}}});i.respond(r,n)}async setRemoteDescription(e){await this.handler.pc.setRemoteDescription(e)}async setLocalDescription(e){l.debug(`${this.direction}() {transportId: ${this.serverId}} | calling pc.setLocalDescription() [offer:${JSON.stringify(e)}]`),await this.handler.pc.setLocalDescription(e)}async createConsumersOverDataChannel(e){const r=this.getDatachannel("events");if(!r)throw FD("DC_NOT_READY","events datachannel not ready");if(!e||e&&e.length===0)throw new Error("list of producers is required");const n={type:"create_consumer",payload:{producers:e.map(({producerId:c,producingTransportId:u})=>({producerId:c,producingTransportId:u}))}},i=new Map;e.forEach(c=>i.set(c.producerId,c));const a=(await r.request(n)).payload;l.info(`createConsumersOverDataChannel::response ${JSON.stringify(a)}`);const o=new Map;return Object.entries(a).forEach(([c,u])=>{const h=i.get(u.producerId);if(!h){l.error(`unknown entry in create consumer response, producerId: ${u.producerId}`,{consumerState:u});return}o.set(u.producerId,{consumerId:c,producingTransportId:h.producingTransportId,producingPeerId:h.producingPeerId,kind:h.kind,paused:h.pause,streamId:u.streamId,trackId:u.trackId,screenShare:h.screenShare,appData:{}})}),o}}class xg extends mn{constructor({id:e,localId:r,track:n,stopTracks:i,disableTrackOnPause:a,zeroRtpOnPause:o,handler:c,appData:u,rtpSender:h}){super();m(this,"_id");m(this,"_localId");m(this,"_closed",!1);m(this,"_handler");m(this,"_track");m(this,"_kind");m(this,"_paused");m(this,"_maxSpatialLayer");m(this,"_stopTracks");m(this,"_disableTrackOnPause");m(this,"_zeroRtpOnPause");m(this,"_appData");m(this,"observer");m(this,"rtpSender");this._id=e,this._localId=r,this._track=n,this._kind=n.kind,this._paused=a?!n.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=i,this._disableTrackOnPause=a,this._zeroRtpOnPause=o,this._appData=u||{},this._onTrackEnded=this._onTrackEnded.bind(this),this._handler=c,this.rtpSender=h,this.observer=new mn,this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get track(){return this._track}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}async close(e){if(this._closed)return;if(l.debug("Producer::close() with reason:"),this._closed=!0,this._destroyTrack(),e===Eu){this.observer.emit("close");return}const{offerSdp:r,callback:n}=await this._handler.stopSending(this.localId);this.observer.emit("close");const{answer:i}=await this.safeEmitAsPromise("close",{offer:r,reason:e});n(i)}async getStats(){if(this._closed)throw new lt("closed");return this._handler.getSenderStats(this.localId)}pause(){l.debug("Producer::pause()",{producer:{id:this.id,appData:this.appData,kind:this.kind}}),this._closed&&l.error("Producer::pause() | Producer closed",{producer:{id:this.id,appData:this.appData,kind:this.kind}}),this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&this._handler.replaceTrack(this.localId,null),this.observer.emit("pause")}resume(){if(l.debug("Producer::resume()",{producer:{id:this.id,appData:this.appData,kind:this.kind}}),this._closed){l.error("Producer::resume() | Producer closed",{producer:{id:this.id,appData:this.appData,kind:this.kind}});return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&this._handler.replaceTrack(this.localId,this._track),this.observer.emit("resume")}async replaceTrack({track:e}){if(l.debug("Producer::replaceTrack()",{producer:{id:this.id,appData:this.appData,kind:this.kind,trackId:e==null?void 0:e.id}}),this._closed){if(e&&this._stopTracks)try{e.stop()}catch(r){l.error("Producer::replaceTrack",{producer:{id:this.id,appData:this.appData,kind:this.kind,trackId:e==null?void 0:e.id},error:r})}throw new lt("closed")}else if(e&&e.readyState==="ended")throw new lt("track ended");if(e===this._track){l.debug("replaceTrack() | same track, ignored",{producer:{id:this.id,appData:this.appData,kind:this.kind,trackId:e==null?void 0:e.id}});return}(!this._zeroRtpOnPause||!this._paused)&&await this._handler.replaceTrack(this.localId,e),this._destroyTrack(),this._track=e,this._handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new lt("closed");if(this._kind!=="video")throw new fn("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");await this._handler.setMaxSpatialLayer(this.localId,e),this._maxSpatialLayer=e}async setRtpEncodingParameters(e){if(this._closed)throw new lt("closed");if(typeof e!="object")throw new TypeError("invalid params");await this._handler.setRtpEncodingParameters(this.localId,e)}_onTrackEnded(){l.debug('Producer::track "ended" event',{producer:{id:this.id,appData:this.appData,kind:this.kind,trackId:this.track.id}}),this.observer.emit("trackended"),this.safeEmit("trackended",this.track.id)}_handleTrack(){this._track&&this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){var e;if(this._track)try{this._track.removeEventListener("ended",this._onTrackEnded),this._stopTracks&&this._track.stop()}catch(r){l.error("Producer::_destroyTrack",{producer:{id:this.id,appData:this.appData,kind:this.kind,trackId:(e=this._track)==null?void 0:e.id},error:r})}}}let VD=class extends xg{},BD=class extends Fg{async consume(t){if(l.debug(`consume() producers: ${JSON.stringify(t)}`),this.closed)throw new lt("closed");if(this.direction!=="recv")throw new fn("not a receiving Transport");if(this.listenerCount("connect")===0&&this.connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(!await this.isConnected)return Promise.reject(new Error("Transport not connected"));const e=[];return(await this.createConsumersOverDataChannel(t)).forEach((n,i)=>{const{consumerId:a,trackId:o,screenShare:c,paused:u,streamId:h,kind:p,appData:f,producingTransportId:v,producingPeerId:y}=n;e.push(this.consumerCreationTask({consumerId:a,trackId:o,streamId:h,kind:p,producerId:i,producingPeerId:y,producingTransportId:v,paused:u,screenShare:c,appData:f}))}),Jc(e)}async connect(){try{const{offerSdp:t,callback:e}=await this.handler.connect(),{answer:r}=await this.safeEmitAsPromise("connect",{offer:t});if(await e(r),!await this.isConnected)throw new Error("ice connection failed");if(!await this.isEventsDCReady)throw new Error("events datachannel not open")}catch(t){throw l.error("transport failed to connect:",t),t}}_ontrack(t){const{track:e,transceiver:r,streams:n}=t;l.info(`track event received [trackId: ${e.id}]`);const i=`${n[0].id}:${e.kind}`;e.addEventListener("ended",()=>{l.info(`rtc consumer track ended [trackId: ${e.id}]`),this.consumerTrackPool.delete(e.id),this.unknownTracksMap.delete(i)}),this.consumerTrackPool.set(e.id,[e,r]);const a=this.consumerTrackEvents.get(i);a?(a(e,r),this.consumerTrackEvents.delete(i)):(l.warn(`track event handler not found ${i}`),this.unknownTracksMap.set(i,t))}async consumerCreationTask({consumerId:t,producerId:e,producingPeerId:r,producingTransportId:n,streamId:i,trackId:a,paused:o,screenShare:c,appData:u,kind:h}){const p=`${i}:${h}`,f={consumerId:t,producerId:e,producingPeerId:r,producingTransportId:n,streamId:i,trackId:a,appData:u,kind:h,paused:o,screenShare:c,name:"consumer creation task error",message:"consumer creation failed"};return new Promise((y,P)=>{const k=setTimeout(()=>{this.consumerTrackEvents.delete(p),f.isTimedout=!0,P(f)},5e3),I=(O,K)=>{try{if(O.readyState==="ended")clearTimeout(k),P(f);else{const X=O;X.enabled=!0,this.handler.midTransceiverMap.set(K.mid,K);const oe=new xD({id:t,localId:K.mid,track:X,paused:o,producerId:e,producingPeerId:r,producingTransportId:n,handler:this.handler,appData:{...u,screenShare:c,peerId:r},reuseTrack:!0,rtpReceiver:K.receiver});this.consumers.set(t,oe),oe.once("close",()=>{this.consumers.delete(oe.id),this.handler.midTransceiverMap.delete(K.mid)}),l.info("consumer created for ",{consumer:{id:t,kind:h,appData:{screenShare:c},peerId:r,producerId:e}}),this.observer.emit("newconsumer",oe),clearTimeout(k),y(oe)}}catch(X){l.warn("error while creating consumer:",X),clearTimeout(k),P(f)}},x=this.consumerTrackPool.get(t);if((x==null?void 0:x.length)===2){I(x[0],x[1]);return}const $=this.unknownTracksMap.get(p);$?(this.unknownTracksMap.delete(p),I($.track,$.transceiver)):this.consumerTrackEvents.set(p,I)})}async retryFailedConsumerCreationTasks(t){return Jc(t.map(async e=>br(async r=>(r>0&&l.warn(`retrying failed consumer creation task: ${JSON.stringify(e)}`),this.consumerCreationTask({...e})))))}async produce({track:t,encodings:e,codecOptions:r,stopTracks:n=!0,disableTrackOnPause:i=!0,zeroRtpOnPause:a=!1,appData:o={}}={}){if(l.debug(`produce() [track:${t.id}]`),t){if(this.direction!=="send")throw new fn("not a sending Transport");if(t.readyState==="ended")throw new lt("track ended");if(this.listenerCount("connect")===0&&this.connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing track");if(!await this.isConnected)return Promise.reject(new Error("Transport not connected"));const{producerId:c,localId:u,rtpSender:h}=await this.awaitQueue.push(async()=>{const{offerSdp:f,callback:v,sender:y,mid:P}=await this.handler.send({track:t,encodings:e,codecOption:r,screenShare:o==null?void 0:o.screenShare}),{answer:k,producerId:I}=await this.safeEmitAsPromise("produce",{offer:f,kind:t.kind,paused:i?!t.enabled:!1,appData:{...o||{},mid:P}}),x=await v(k);return{producerId:I,localId:x,rtpSender:y}},"producer"),p=new VD({id:c,localId:u,track:t,stopTracks:n,disableTrackOnPause:i,zeroRtpOnPause:a,appData:o,handler:this.handler,rtpSender:h});return this.producers.set(c,p),p.observer.on("close",()=>{this.producers.delete(p.id)}),this.emit("newproducer",p),this.observer.emit("newproducer",p),p}};class wu extends mn{constructor(){super();m(this,"_mapMidTransceiver",new Map);m(this,"_enableHighBitrate",!1);m(this,"_enableStereo",!1);this._mapMidTransceiver=new Map,this._enableHighBitrate=!1}get midTransceiverMap(){return this._mapMidTransceiver}}class Cu extends wu{constructor(){super();m(this,"_direction");m(this,"_pc");m(this,"_sendWebStream",new MediaStream);m(this,"_sendScreenShareStream",new MediaStream);m(this,"_transportReady",!1)}static createFactory(){return()=>new Cu}get name(){return"Chrome74"}get pc(){return this._pc}close(){if(l.debug("close()"),this._pc)try{this._pc.close()}catch(e){l.error("pc.close()",e)}}init({direction:e,iceServers:r,iceTransportPolicy:n,additionalSettings:i,proprietaryConstraints:a,onTrackHandler:o}){this._direction=e,this._pc=new RTCPeerConnection({iceServers:r||[],iceTransportPolicy:n||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...i},a),o&&this._pc.addEventListener("track",c=>{o(c)}),this._addEventListeners()}async connect(){const e=this._pc.createDataChannel("dyte"),r=await this._pc.createOffer();return l.info(`connect offer: ${JSON.stringify(r)}`),await this._pc.setLocalDescription(r),{offerSdp:r,callback:async i=>{l.debug(`Chrome74::connect() | calling pc.setRemoteDescription() [answer:${JSON.stringify(i)}]`),await this._pc.setRemoteDescription(i),e.close()}}}async updateIceServers(e){l.debug("updateIceServers()");const r=this._pc.getConfiguration();r.iceServers=e,this._pc.setConfiguration(r)}async restartIce(){l.debug("restartIce()");const e=await this.pc.createOffer({iceRestart:!0});return l.debug(`restartIce() | calling pc.setLocalDescription() [offer:${JSON.stringify(e)}]`),{offerSdp:e,callback:async n=>{l.info(`restartIce() | calling pc.setRemoteDescription() [answer:${JSON.stringify(n)}]`),await this._pc.setRemoteDescription(n)}}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:r,codecOption:n,screenShare:i}){var u;this._assertSendDirection(),l.debug(`send() [kind:${e.kind}, track.id:${e.id}]`);const a=this._pc.addTransceiver(e,{direction:"sendonly",streams:[i?this._sendScreenShareStream:this._sendWebStream],sendEncodings:r});if(!navigator.isReactNative){l.debug("creating new transceiver");const h=RTCRtpSender.getCapabilities(e.kind);l.info(`senders available params: ${JSON.stringify(h)}`);const p=[];if(n){const f=h.codecs.find(v=>v.mimeType.includes(n.name));if(n.parameters){l.info(`codecOption.parameters:${JSON.stringify(n.parameters)}`);const v=((u=f.sdpFmtpLine)==null?void 0:u.split(";"))||[];v.push(...n.parameters);const y=Array.from(new Set(v).values());f.sdpFmtpLine=y.join(";")}p.push(f)}l.info(`selected codecs: ${JSON.stringify(p)}`),a.setCodecPreferences(p)}const o=await this._pc.createOffer();if(!this._transportReady)throw new Error("webrtc transport not connected");if(await this._pc.setLocalDescription(o),n&&n.name==="opus"){const h=this._enableStereo,p=this._enableHighBitrate?h?128e3:64e3:h?64e3:32e3;o.sdp=o.sdp.replace("minptime=10;useinbandfec=1",`minptime=10;useinbandfec=1;usedtx=1${h?"":";stereo=1;sprop-stereo=1"};maxaveragebitrate=${p}`),o.sdp+=`a=rtcp-fb:111 nack\r
`}return{offerSdp:o,callback:async h=>(l.debug(`send() | calling pc.setRemoteDescription() [answer:${JSON.stringify(h)}]`),await this._pc.setRemoteDescription(h),this.midTransceiverMap.set(a.mid,a),a.mid),sender:a.sender,mid:a.mid}}async stopSending(e){this._assertSendDirection(),l.debug(`stopSending() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.sender.replaceTrack(null),this._pc.removeTrack(r.sender),r.direction="inactive";const n=await this._pc.createOffer();return l.debug(`stopSending() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),await this._pc.setLocalDescription(n),{offerSdp:n,callback:async a=>{l.debug(`stopSending() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(e)}}}async replaceTrack(e,r){this._assertSendDirection(),r?l.debug(`replaceTrack() [localId:${e}, track.id:${r.id}]`):l.debug(`replaceTrack() [localId:${e}, no track]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");await n.sender.replaceTrack(r)}async setMaxSpatialLayer(e,r){this._assertSendDirection(),l.debug(`setMaxSpatialLayer() [localId:${e}, spatialLayer:${r}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters();i.encodings.forEach((a,o)=>{o<=r?a.active=!0:a.active=!1}),await n.sender.setParameters(i)}async setRtpEncodingParameters(e,r){this._assertSendDirection(),l.debug(`setRtpEncodingParameters() [localId:${e}, params:${JSON.stringify(r)}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters();i.encodings.forEach((a,o)=>{i.encodings[o]={...a,...r}}),await n.sender.setParameters(i)}getSenderStats(e){this._assertSendDirection();const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");return r.sender.getStats()}async stopReceiving(e){throw this._assertRecvDirection(),l.debug(`stopReceiving() [localId:${e}]`),Error("method not implemented")}async pauseReceiving(e){throw this._assertRecvDirection(),l.debug(`pauseReceiving() [localId:${e}]`),Error("method not implemented")}async resumeReceiving(e){throw this._assertRecvDirection(),l.debug(`resumeReceiving() [localId:${e}]`),Error("method not implemented")}async getReceiverStats(e){this._assertRecvDirection();const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");return r.receiver.getStats()}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}async _generateOffer(){const e=await this._pc.createOffer();return await this._pc.setLocalDescription(e),e}async _setAnswer(e){l.debug(`setAnswer() | calling pc.setRemoteDescription() [answer:${JSON.stringify(e)}]`),await this._pc.setRemoteDescription(e)}_addEventListeners(){this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected"),this._transportReady=!0;break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break;default:l.warn("unknown state");break}}),this._pc.addEventListener("icecandidate",e=>{e.candidate&&this.emit("@icecandidate",{candidate:e.candidate})}),this._pc.addEventListener("negotiationneeded",()=>{this.emit("@negotiationneeded",{}),l.debug("negotiationneeded")}),this._pc.addEventListener("icegatheringstatechange",()=>{switch(this._pc.iceGatheringState){case"gathering":l.debug("icegatheringstatechange | gathering"),this.emit("@icegatheringstatechange","gathering");break;case"complete":l.debug("icegatheringstatechange | complete"),this.emit("@icegatheringstatechange","complete");break;default:l.warn("unknown state");break}}),this._pc.addEventListener("icecandidateerror",e=>{l.error("icecandidateerror",{error:{code:e.errorCode,message:e.errorText}})}),this._pc.addEventListener("datachannel",e=>{l.info("data channel created: ",{rtcChannel:{label:e.channel.label}});const{channel:r}=e;r.onopen=()=>{l.info("data channel open: ",{rtcChannel:{label:e.channel.label}}),this.safeEmit("dc_open",e.channel)},r.onclose=()=>{l.warn("data channel closed: ",{rtcChannel:{label:e.channel.label}})},r.onerror=()=>{l.error("data channel error: ",{rtcChannel:{label:e.channel.label}})},r.onmessage=n=>{this.safeEmit("datachannel",e.channel,String.fromCharCode(...new Uint8Array(n.data)))}})}}class Yc extends wu{constructor(e){super();m(this,"_direction");m(this,"_pc");m(this,"_sendWebStream",new MediaStream);m(this,"_sendScreenShareStream",new MediaStream);m(this,"_transportReady",!1);m(this,"supportsSendEncodings",!1);this.supportsSendEncodings=e.supportsSendEncodings}static createFactory(e){return()=>new Yc(e)}get name(){return"Firefox60"}get pc(){return this._pc}close(){if(l.debug("Firefox60::close()"),this._pc)try{this._pc.close()}catch(e){l.error("Firefox60::pc.close()",{error:e})}}init({direction:e,iceServers:r,iceTransportPolicy:n,additionalSettings:i,proprietaryConstraints:a,onTrackHandler:o}){l.debug("Firefox60::init()"),this._direction=e,this._pc=new RTCPeerConnection({iceServers:r||[],iceTransportPolicy:n||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...i},a),o&&this._pc.addEventListener("track",c=>{o(c)}),this._addEventListeners()}async connect(){const e=this._pc.createDataChannel("dyte"),r=await this._pc.createOffer();return l.info(`Firefox60::connect offer: ${JSON.stringify(r)}`),await this._pc.setLocalDescription(r),{offerSdp:r,callback:async i=>{l.debug(`Firefox60::connect() | calling pc.setRemoteDescription() [answer:${JSON.stringify(i)}]`),await this._pc.setRemoteDescription(i),e.close()}}}async updateIceServers(e){throw l.debug("Firefox60::updateIceServers()"),new Error("not supported")}async restartIce(){l.debug("Firefox60::restartIce()");const e=await this.pc.createOffer({iceRestart:!0});return l.debug(`Firefox60::restartIce() | calling pc.setLocalDescription() [offer:${JSON.stringify(e)}]`),{offerSdp:e,callback:async n=>{l.info(`Firefox60::restartIce() | calling pc.setRemoteDescription() [answer:${JSON.stringify(n)}]`),await this._pc.setRemoteDescription(n)}}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:r,screenShare:n}){this._assertSendDirection(),l.debug(`Firefox60::send() [kind:${e.kind}, track.id:${e.id}]`),l.debug("Firefox60::creating new transceiver");const i=this.supportsSendEncodings&&r!==void 0?{sendEncodings:r}:{},a=this._pc.addTransceiver(e,{direction:"sendonly",streams:[n?this._sendScreenShareStream:this._sendWebStream],...i});if(!this.supportsSendEncodings&&r){r.reverse();const u=a.sender.getParameters();u.encodings=r,await a.sender.setParameters(u)}const o=await this._pc.createOffer();if(!this._transportReady)throw new Error("webrtc transport not connected");if(await this._pc.setLocalDescription(o),e.kind==="audio"){const u=this._enableStereo,h=this._enableHighBitrate?u?128e3:64e3:u?64e3:32e3;o.sdp=o.sdp.replace("minptime=10;useinbandfec=1",`minptime=10;useinbandfec=1;usedtx=1${this.supportsSendEncodings?"":`${u?"":";stereo=1;sprop-stereo=1"};maxaveragebitrate=${h}`}`)}return{offerSdp:o,callback:async u=>(l.debug(`send() | calling pc.setRemoteDescription() [answer:${JSON.stringify(u)}]`),await this._pc.setRemoteDescription(u),this.midTransceiverMap.set(a.mid,a),a.mid),sender:a.sender,mid:a.mid}}async stopSending(e){this._assertSendDirection(),l.debug(`Firefox60::stopSending() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated transceiver not found");r.sender.replaceTrack(null),this._pc.removeTrack(r.sender),r.direction="inactive";const n=await this._pc.createOffer();return l.debug(`stopSending() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),await this._pc.setLocalDescription(n),{offerSdp:n,callback:async a=>{l.debug(`stopSending() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(e)}}}async replaceTrack(e,r){this._assertSendDirection(),r?l.debug(`replaceTrack() [localId:${e}, track.id:${r.id}]`):l.debug(`Firefox60::replaceTrack() [localId:${e}, no track]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");await n.sender.replaceTrack(r)}async setMaxSpatialLayer(e,r){this._assertSendDirection(),l.debug(`setMaxSpatialLayer() [localId:${e}, spatialLayer:${r}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters(),a=i.encodings.length-1-r;i.encodings.forEach((o,c)=>{c>=a?o.active=!0:o.active=!1}),await n.sender.setParameters(i)}async setRtpEncodingParameters(e,r){this._assertSendDirection(),l.debug(`setRtpEncodingParameters() [localId:${e}, params:${JSON.stringify(r)}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters();i.encodings.forEach((a,o)=>{i.encodings[o]={...a,...r}}),await n.sender.setParameters(i)}getSenderStats(e){this._assertSendDirection();const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");return r.sender.getStats()}async stopReceiving(e){this._assertRecvDirection(),l.debug(`Firefox60::stopReceiving() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.direction="inactive",l.info(`Firefox60::active transcievers: ${JSON.stringify(this._pc.getTransceivers())}`);const n=await this._pc.createOffer();return l.debug(`Firefox60::stopRecieving() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),await this._pc.setLocalDescription(n),{offerSdp:n,callback:async a=>{l.debug(`Firefox60::stopRecieving() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(e)}}}async pauseReceiving(e){this._assertRecvDirection(),l.debug(`Firefox60::pauseReceiving() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.direction="inactive";const n=await this._pc.createOffer();return l.debug(`pauseReceiving() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),await this._pc.setLocalDescription(n),{offerSdp:n,callback:async a=>{l.debug(`pauseReceiving() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a)}}}async resumeReceiving(e){this._assertRecvDirection(),l.debug(`Firefox60::resumeReceiving() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.direction="recvonly";const n=await this._generateOffer();return l.debug(`resumeReceiving() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),{offerSdp:n,callback:async a=>{l.debug(`resumeReceiving() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a)}}}async getReceiverStats(e){this._assertRecvDirection();const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");return r.receiver.getStats()}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}async _generateOffer(){const e=await this._pc.createOffer();return await this._pc.setLocalDescription(e),e}async _setAnswer(e){l.debug(`_setAnswer() | calling pc.setRemoteDescription() [answer:${JSON.stringify(e)}]`),await this._pc.setRemoteDescription(e)}_addEventListeners(){this._pc.addEventListener("datachannel",e=>{l.info("Firefox60::data channel created: ",{rtcChannel:{label:e.channel.label}});const{channel:r}=e;r.onopen=()=>{l.info("Firefox60::data channel open: ",{rtcChannel:{label:e.channel.label}}),this.safeEmit("dc_open",e.channel)},r.onclose=()=>{l.warn("data channel closed: ",{rtcChannel:{label:e.channel.label}})},r.onerror=()=>{l.error("Firefox60::data channel error: ",{rtcChannel:{label:e.channel.label}})},r.onmessage=async n=>{const i=await n.data.arrayBuffer();this.safeEmit("datachannel",e.channel,String.fromCharCode(...new Uint8Array(i)))}}),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected"),this._transportReady=!0;break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break;default:l.warn("unknown state");break}}),this._pc.addEventListener("icecandidate",e=>{e.candidate&&this.emit("@icecandidate",{candidate:e.candidate})}),this._pc.addEventListener("negotiationneeded",()=>{this.emit("@negotiationneeded",{}),l.debug("Firefox60::negotiationneeded")}),this._pc.addEventListener("icegatheringstatechange",()=>{switch(this._pc.iceGatheringState){case"gathering":l.debug("Firefox60::icegatheringstatechange | gathering"),this.emit("@icegatheringstatechange","gathering");break;case"complete":l.debug("Firefox60::icegatheringstatechange | complete"),this.emit("@icegatheringstatechange","complete");break;default:l.warn("unknown state");break}}),this._pc.addEventListener("icecandidateerror",e=>{l.error("icecandidateerror",{error:{code:e.errorCode,message:e.errorText}})})}}class bu extends wu{constructor(){super();m(this,"_direction");m(this,"_pc");m(this,"_sendWebStream",new MediaStream);m(this,"_sendScreenShareStream",new MediaStream);m(this,"_transportReady",!1)}static createFactory(){return()=>new bu}get name(){return"Chrome74"}get pc(){return this._pc}close(){if(l.debug("Safari12::close()"),this._pc)try{this._pc.close()}catch(e){l.error("Safari12::pc.close()",e)}}init({direction:e,iceServers:r,iceTransportPolicy:n,additionalSettings:i,proprietaryConstraints:a,onTrackHandler:o}){l.debug("Safari12::init()"),this._direction=e,this._pc=new RTCPeerConnection({iceServers:r||[],iceTransportPolicy:n||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...i},a),o&&this._pc.addEventListener("track",c=>{o(c)}),this._addEventListeners()}async connect(){const e=this._pc.createDataChannel("dyte"),r=await this._pc.createOffer();return l.info(`Safari12::connect offer: ${JSON.stringify(r)}`),await this._pc.setLocalDescription(r),{offerSdp:r,callback:async i=>{l.debug(`Safari12::connect() | calling pc.setRemoteDescription() [answer: ${JSON.stringify(i)}]`),await this._pc.setRemoteDescription(i),e.close()}}}async updateIceServers(e){l.debug("Safari12::updateIceServers()");const r=this._pc.getConfiguration();r.iceServers=e,this._pc.setConfiguration(r)}async restartIce(){l.debug("Safari12::restartIce()");const e=await this.pc.createOffer({iceRestart:!0});return l.debug(`restartIce() | calling pc.setLocalDescription() [offer:${JSON.stringify(e)}]`),{offerSdp:e,callback:async n=>{l.info(`restartIce() | calling pc.setRemoteDescription() [answer:${JSON.stringify(n)}]`),await this._pc.setRemoteDescription(n)}}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:r,codecOption:n,screenShare:i}){var p;this._assertSendDirection(),l.debug(`Safari12::send() [kind: ${e.kind}, track.id: ${e.id}]`),l.debug("Safari12::creating new transceiver");const a=this._pc.addTransceiver(e,{direction:"sendonly",streams:[i?this._sendScreenShareStream:this._sendWebStream],sendEncodings:r}),o=RTCRtpSender.getCapabilities(e.kind);l.info(`Safari12::senders available params: ${JSON.stringify(o)}`);const c=[];if(n){const f=o.codecs.find(v=>v.mimeType.includes(n.name));if(n.parameters){l.info(`Safari12::codecOption.parameters:, ${JSON.stringify(n.parameters)}`);const v=((p=f.sdpFmtpLine)==null?void 0:p.split(";"))||[];v.push(...n.parameters);const y=[...new Set(v).values()];f.sdpFmtpLine=y.join(";")}c.push(f)}l.info(`Safari12::selected codecs: ${JSON.stringify(c)}`),a.setCodecPreferences(c);const u=await this._pc.createOffer();if(!this._transportReady)throw new Error("webrtc transport not connected");if(await this._pc.setLocalDescription(u),e.kind==="audio"){const f=this._enableStereo,v=this._enableHighBitrate?f?128e3:64e3:f?64e3:32e3;u.sdp=u.sdp.replace("minptime=10;useinbandfec=1",`minptime=10;useinbandfec=1;usedtx=1${f?"":";stereo=1;sprop-stereo=1"};maxaveragebitrate=${v}`)}return{offerSdp:u,callback:async f=>(l.debug(`Safari12::send() | calling pc.setRemoteDescription() [answer:${JSON.stringify(f)}]`),await this._pc.setRemoteDescription(f),this.midTransceiverMap.set(a.mid,a),a.mid),sender:a.sender,mid:a.mid}}async stopSending(e){this._assertSendDirection(),l.debug(`Safari12::stopSending() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.sender.replaceTrack(null),this._pc.removeTrack(r.sender),r.direction="inactive";const n=await this._pc.createOffer();return l.debug(`Safari12::stopSending() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),await this._pc.setLocalDescription(n),{offerSdp:n,callback:async a=>{l.debug(`Safari12::stopSending() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(e)}}}async replaceTrack(e,r){this._assertSendDirection(),r?l.debug(`Safari12::replaceTrack() [localId:${e}, track.id:${r.id}]`):l.debug(`Safari12::replaceTrack() [localId:${e}, no track]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");await n.sender.replaceTrack(r)}async setMaxSpatialLayer(e,r){this._assertSendDirection(),l.debug(`setMaxSpatialLayer() [localId:${e}, spatialLayer:${r}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters();i.encodings.forEach((a,o)=>{o<=r?a.active=!0:a.active=!1}),await n.sender.setParameters(i)}async setRtpEncodingParameters(e,r){this._assertSendDirection(),l.debug(`setRtpEncodingParameters() [localId:${e}, params:${JSON.stringify(r)}]`);const n=this.midTransceiverMap.get(e);if(!n)throw new Error("associated RTCRtpTransceiver not found");const i=n.sender.getParameters();i.encodings.forEach((a,o)=>{i.encodings[o]={...a,...r}}),await n.sender.setParameters(i)}getSenderStats(e){this._assertSendDirection();const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");return r.sender.getStats()}async receive(e){this._assertRecvDirection(),l.debug(`recieve() | calling pc.setLocalDescription() [answer:${JSON.stringify(e)}]`);const r=this._pc.getTransceivers().at(-1);return l.info("Safari12::Transceiver is now receiving"),this.midTransceiverMap.set(r.mid,r),{track:r.receiver.track,localId:r.mid}}async stopReceiving(e){this._assertRecvDirection(),l.debug(`Safari12::stopReceiving() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.direction="inactive",l.info(`Safari12::active transcievers: ${JSON.stringify(this._pc.getTransceivers())}`);const n=await this._pc.createOffer();return l.debug(`stopRecieving() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),await this._pc.setLocalDescription(n),{offerSdp:n,callback:async a=>{l.debug(`stopRecieving() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(e)}}}async pauseReceiving(e){this._assertRecvDirection(),l.debug(`Safari12::pauseReceiving() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.direction="inactive";const n=await this._pc.createOffer();return l.debug(`pauseReceiving() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),await this._pc.setLocalDescription(n),{offerSdp:n,callback:async a=>{l.debug(`pauseReceiving() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a)}}}async resumeReceiving(e){this._assertRecvDirection(),l.debug(`Safari12::resumeReceiving() [localId:${e}]`);const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");r.direction="recvonly";const n=await this._generateOffer();return l.debug(`Safari12::resumeReceiving() | calling pc.setLocalDescription() [offer:${JSON.stringify(n)}]`),{offerSdp:n,callback:async a=>{l.debug(`Safari12::resumeReceiving() | calling pc.setRemoteDescription() [answer:${JSON.stringify(a)}]`),await this._pc.setRemoteDescription(a)}}}async getReceiverStats(e){this._assertRecvDirection();const r=this.midTransceiverMap.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");return r.receiver.getStats()}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}async _generateOffer(){const e=await this._pc.createOffer();return await this._pc.setLocalDescription(e),e}async _setAnswer(e){l.debug(`Safari12::_setAnswer() | calling pc.setRemoteDescription() [answer:${JSON.stringify(e)}]`),await this._pc.setRemoteDescription(e)}_addEventListeners(){this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected"),this._transportReady=!0;break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break;default:l.warn("Safari12::unknown state");break}}),this._pc.addEventListener("icecandidate",e=>{e.candidate&&this.emit("@icecandidate",{candidate:e.candidate})}),this._pc.addEventListener("negotiationneeded",()=>{this.emit("@negotiationneeded",{}),l.debug("Safari12::negotiationneeded")}),this._pc.addEventListener("icegatheringstatechange",()=>{switch(this._pc.iceGatheringState){case"gathering":l.debug("Safari12::icegatheringstatechange | gathering"),this.emit("@icegatheringstatechange","gathering");break;case"complete":l.debug("Safari12::icegatheringstatechange | complete"),this.emit("@icegatheringstatechange","complete");break;default:l.warn("Safari12::unknown state");break}}),this._pc.addEventListener("icecandidateerror",e=>{l.error("icecandidateerror",{error:{code:e.errorCode,message:e.errorText}})}),this._pc.ondatachannel=e=>{l.info("Safari12::data channel created: ",{rtcChannel:{label:e.channel.label}});const{channel:r}=e;r.onopen=()=>{l.info("Safari12::data channel open: ",{rtcChannel:{label:e.channel.label}}),this.safeEmit("dc_open",e.channel)},r.onclose=()=>{l.warn("Safari12::data channel closed: ",{rtcChannel:{label:e.channel.label}})},r.onerror=()=>{l.error("Safari12::data channel error: ",{rtcChannel:{label:e.channel.label}})},r.onmessage=async n=>{const i=String.fromCharCode(...new Uint8Array(n.data));this.safeEmit("datachannel",e.channel,i)}}}}function HD(){if(typeof navigator=="object"&&navigator.product==="ReactNative"){if(typeof RTCPeerConnection=="undefined"){l.warn("Device::this._detectDevice() | unsupported ReactNative without RTCPeerConnection");return}return l.debug("Device::this._detectDevice() | ReactNative handler chosen"),"Chrome74"}if(typeof navigator=="object"&&typeof navigator.userAgent=="string"){const s=navigator.userAgent,t=Em.getParser(s),e=t.getEngine();if(t.satisfies({chrome:">=74",chromium:">=74","microsoft edge":">=88"}))return"Chrome74";if(t.satisfies({chrome:">=70",chromium:">=70"}))return"Chrome70";if(t.satisfies({chrome:">=67",chromium:">=67"}))return"Chrome67";if(t.satisfies({chrome:">=55",chromium:">=55"}))return"Chrome55";if(t.satisfies({firefox:">=110"}))return"Firefox110";if(t.satisfies({firefox:">=60"}))return"Firefox60";if(t.satisfies({ios:{OS:">=14.3",firefox:">=30.0"}})||t.satisfies({safari:">=12.0"})&&typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(t.satisfies({safari:">=11"}))return"Safari11";if(t.satisfies({"microsoft edge":">=11"})&&t.satisfies({"microsoft edge":"<=18"}))return"Edge11";if(e.name&&e.name.toLowerCase()==="blink"){const r=s.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(r){const n=Number(r[1]);return n>=74?"Chrome74":n>=70?"Chrome70":n>=67?"Chrome67":"Chrome55"}return"Chrome74"}if(e.name.toLowerCase()==="webkit"&&t.getOS().name.toLowerCase()==="ios")return typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection")?"Safari12":"Safari11";l.warn("Device::this._detectDevice() | browser not supported");return}l.warn("Device::this._detectDevice() | unknown device")}class Ug{constructor({handlerName:t,handlerFactory:e}={}){m(this,"handlerFactory");m(this,"_handlerName");m(this,"_observer");if(l.debug("constructor()"),t&&e)throw new TypeError("just one of handlerName or handlerInterface can be given");if(e)this.handlerFactory=e;else{if(t)l.debug(`Device::constructor() | handler given: ${t}`);else if(t=HD(),t)l.debug(`Device::constructor() | detected handler: ${t}`);else throw new Error("device not supported");switch(t){case"Chrome74":this.handlerFactory=Cu.createFactory();break;case"Safari12":this.handlerFactory=bu.createFactory();break;case"Firefox60":this.handlerFactory=Yc.createFactory({supportsSendEncodings:!1});break;case"Firefox110":this.handlerFactory=Yc.createFactory({supportsSendEncodings:!0});break;default:throw new TypeError(`unknown handlerName "${t}"`)}}const r=this.handlerFactory();this._handlerName=r.name,r.close(),this._observer=new ce}get handlerName(){return this._handlerName}createSendTransport({iceServers:t,iceTransportPolicy:e,additionalSettings:r,proprietaryConstraints:n,appData:i,config:a}){return l.debug("Device::createSendTransport()"),this.createTransport({direction:"send",iceServers:t,iceTransportPolicy:e,additionalSettings:r,proprietaryConstraints:n,appData:i,config:a})}createRecvTransport({iceServers:t,iceTransportPolicy:e,additionalSettings:r,proprietaryConstraints:n,appData:i}){return l.debug("Device::createRecvTransport()"),this.createTransport({direction:"recv",iceServers:t,iceTransportPolicy:e,additionalSettings:r,proprietaryConstraints:n,appData:i})}}let qD=class extends Ug{createTransport({direction:t,iceServers:e,iceTransportPolicy:r,additionalSettings:n,proprietaryConstraints:i,appData:a,config:o}){const c=Ys(),u=new BD({id:c,direction:t,iceServers:e,iceTransportPolicy:r,additionalSettings:n,proprietaryConstraints:i,appData:a,handlerFactory:this.handlerFactory,config:o});return this._observer.emit("newtransport",u),u}};class jD{constructor(t){S(this,_t,void 0);T(this,_t,t)}async joinRoom(t,e,r=!1,n=null){const i={roomUuid:t,displayName:e,prejoined:r};return n&&(i.location=n),(await d(this,_t).sendMessagePromiseWithTimeout({event:se.joinRoom,protobuf:Zm.toBinary(i),timeout:5e3})).payload}async connectTransport(t){const e=(await d(this,_t).sendMessagePromise(se.createWebRTCTransport,Jm.toBinary(t))).payload,{transportId:r,description:n}=xl.fromBinary(e),i={sdp:n==null?void 0:n.sdp,type:n.type};return{transportId:r,answer:i}}async produce(t){var i,a;const e=(await d(this,_t).sendMessagePromise(se.produce,sf.toBinary(t))).payload,r=gf.fromBinary(e);return{answer:{sdp:(i=r==null?void 0:r.description)==null?void 0:i.sdp,type:(a=r==null?void 0:r.description)==null?void 0:a.type},producerId:r.producerId}}async consume(t){const e=(await d(this,_t).sendMessagePromise(se.consume,rf.toBinary(t))).payload,{consumerIdsMap:{map:r}}=ff.fromBinary(e);return r}async closeProducer(t){const e=(await d(this,_t).sendMessagePromise(se.closeProducer,af.toBinary(t))).payload,{description:r}=vf.fromBinary(e);return r}async closeConsumer(t){return(await d(this,_t).sendMessagePromise(se.closeConsumer,of.toBinary(t))).payload}async hostControlForPeer(t,e){const r={audio:e==="audio",screeShare:!1,video:e==="video",participantId:t},n=(await d(this,_t).sendMessagePromise(se.hostControlPeer,lf.toBinary(r))).payload;if(!n)return!1;const{status:i}=_f.fromBinary(n);return i==="success"}async hostControlForAll(t){const e={audio:t==="audio",screenShare:!1,video:t==="video"},r=(await d(this,_t).sendMessagePromise(se.hostControlAllPeers,uf.toBinary(e))).payload;if(!r)return!1;const{status:n}=Sf.fromBinary(r);return n==="success"}async kickAll(){const t={},e=(await d(this,_t).sendMessagePromise(se.kickAll,Ul.toBinary(t))).payload;if(!e)return!1;const{status:r}=Tf.fromBinary(e);return r==="success"}async kickPeer(t){const e=(await d(this,_t).sendMessagePromise(se.kickPeer,cf.toBinary(t))).payload;if(!e)return!1;const{status:r}=yf.fromBinary(e);return r==="success"}async changeDisplayName(t){const e=(await d(this,_t).sendMessagePromise(se.changeDisplayName,df.toBinary(t))).payload;if(!e)return!1;const{status:r}=Ef.fromBinary(e);return r==="success"}async notifySelfJoinComplete(){const t={},e=(await d(this,_t).sendMessagePromise(se.selfJoinComplete,ef.toBinary(t))).payload;return Cc.fromBinary(e)}}_t=new WeakMap;var ut=(s=>(s.NEW="new",s.CONNECTING="connecting",s.RECONNECTING="reconnecting",s.DISCONNECTED="disconnected",s.CONNECTED="connected",s.FAILED="failed",s))(ut||{}),ci=(s=>(s[s.HIVE=1]="HIVE",s[s.ROOM_NODE=2]="ROOM_NODE",s[s.CF=3]="CF",s))(ci||{});const GD=2e3;class WD extends Mg{constructor(e,r){super();m(this,"_device");m(this,"_sendTransport");m(this,"_recvTransport");m(this,"_consumers");m(this,"_producers");m(this,"_producerStatus");m(this,"_producerIdToConsumerIdMap");m(this,"_socket");m(this,"_socketHandler");m(this,"_totalTransportReconnectionCount");m(this,"_transportReconnectFailureCount");m(this,"_consumerCreationFailureCount");m(this,"_producerNotReadyFailureCount");m(this,"_consumerNotBoundFailureCount");m(this,"_transportDisconnectedTimer");m(this,"_iceTransportPolicy","all");m(this,"_transportConnectionFailCount",0);m(this,"lastConnectionTime",0);m(this,"transportState");m(this,"transportDisconnected");S(this,Zr,void 0);T(this,Zr,e),this._device=new qD({}),this._socket=r,this.transportState={consuming:{state:ut.NEW,reconnected:!1},producing:{state:ut.NEW,reconnected:!1}},this.transportDisconnected={consuming:!1,producing:!1},this._socketHandler=new jD(r),this.reset()}get socket(){return this._socket}get producers(){return this._producers}get consumers(){return this._consumers}get producerIdToConsumerIdMap(){return this._producerIdToConsumerIdMap}get hiveSocketHandler(){return this._socketHandler}get sendTransport(){return this._sendTransport}get recvTransport(){return this._recvTransport}reset(){this._producers=new Map,this._consumers=new Map,this._producerStatus=new Map,this._producerIdToConsumerIdMap=new Map,this._transportReconnectFailureCount=0,this._consumerCreationFailureCount=0,this._totalTransportReconnectionCount=0,this._producerNotReadyFailureCount=0,this._consumerNotBoundFailureCount=0,this._transportDisconnectedTimer={consuming:void 0,producing:void 0}}async setupTransports(e){var a,o,c,u,h,p,f,v;const n=await Je().getICEServers().catch(y=>(l.warn(`failed to get iceservers from server: ${y.message}`),[])),i=[];if(e.send){const y=this.createSendTransport({iceServers:n,additionalSettings:{encodedInsertableStreams:(a=d(this,Zr).getValue("modules").e2ee)==null?void 0:a.enabled},config:{enableHighBitrate:(u=(c=(o=d(this,Zr).getValue("defaults").mediaConfiguration)==null?void 0:o.audio)==null?void 0:c.enableHighBitrate)!=null?u:!1,enableStereo:(f=(p=(h=d(this,Zr).getValue("defaults").mediaConfiguration)==null?void 0:h.audio)==null?void 0:p.enableStereo)!=null?f:!1},iceTransportPolicy:this._iceTransportPolicy});i.push(y)}if(e.recv){const y=this.createRecvTransport({iceServers:n,additionalSettings:{encodedInsertableStreams:(v=d(this,Zr).getValue("modules").e2ee)==null?void 0:v.enabled},iceTransportPolicy:this._iceTransportPolicy});i.push(y)}await Promise.all(i)}stopAllTransports(){var e,r,n,i;l.info("closing all the transports"),(e=this._sendTransport)==null||e.close(),(r=this._sendTransport)==null||r.removeAllListeners(),(n=this._recvTransport)==null||n.close(),(i=this._recvTransport)==null||i.removeAllListeners(),this._sendTransport=void 0,this._recvTransport=void 0,this.reset()}async createSendTransport(e){var n,i,a,o;if(this._sendTransport&&this._sendTransport.connected){l.info("sendTransport::already_exists_in_connected_state",{transport:{id:(n=this._sendTransport)==null?void 0:n.id,serverId:(i=this._sendTransport)==null?void 0:i.serverId,type:"send"}});return}l.info("sendTransport::initializing_transport",{transport:{id:(a=this._sendTransport)==null?void 0:a.id,serverId:(o=this._sendTransport)==null?void 0:o.serverId,type:"send"}});const r=this._device.createSendTransport(e);this._transportDisconnectedTimer.producing=void 0,l.info("sendTransport::initialized_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"send"}}),this.handleTransport(r,!1),l.info("sendTransport::connecting_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"send"}});try{await br(async(c,u)=>{this.socket.isConnected||u(new Error("socket is not connected")),r.connectionState==="closed"&&u(new Error("transport is closed")),c>0&&l.debug(`retrying transport connect, count: ${c}`,{transport:{id:r.id,serverId:r.serverId,type:"send"}});try{await r.connect()}catch(h){throw l.error(`failed to connect send transport: ${r.id}`,{error:h,transport:{id:r.id,serverId:r.serverId,type:"send"}}),h.message==="ice connection failed"&&u(h),h}},{delayTime:100,strategy:"exponential",maxRetryCount:j.hasFeature(J.ENABLE_HIVE_INFINITE_RETRIES)?1/0:3}),l.info("sendTransport::connected_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"send"}}),this._transportReconnectFailureCount=Math.max(0,this._transportReconnectFailureCount-1),this._producerNotReadyFailureCount=0,this._sendTransport=r,U.onSafeInitialization(()=>{U.configureSendTransport(r)})}catch(c){throw l.error(`failed to connect send transport after retry:${r.id}`,{error:c,transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"send"}}),r.close(),r.removeAllListeners(),this._transportReconnectFailureCount+=1,this.handleFailure(),c}}async createRecvTransport(e){var n,i,a,o,c;if(this._recvTransport&&this._recvTransport.connected){l.info("recvTransport::already_exists_in_connected_state",{transport:{id:(n=this._recvTransport)==null?void 0:n.id,serverId:(i=this._recvTransport)==null?void 0:i.serverId,type:"recv"}});return}l.info("recvTransport::initializing_transport",{transport:{id:(a=this._recvTransport)==null?void 0:a.id,serverId:(o=this._recvTransport)==null?void 0:o.serverId,type:"recv"}});const r=this._device.createRecvTransport({...e,additionalSettings:{...(c=e.additionalSettings)!=null?c:{},rtcAudioJitterBufferMaxPackets:25,rtcAudioJitterBufferFastAccelerate:!0,rtcAudioJitterBufferMinDelayMs:20}});this._transportDisconnectedTimer.consuming=void 0,l.info("recvTransport::initialized_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}}),this.handleTransport(r,!0),l.info("recvTransport::connecting_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}});try{await br(async(u,h)=>{this.socket.isConnected||h(new Error("socket is not connected")),r.connectionState==="closed"&&h(new Error("transport is closed")),u>0&&l.debug(`retrying transport connect, count: ${u}`,{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}});try{await r.connect()}catch(p){throw l.error(`fail to connect recv transport: ${r.id}`,{error:p,transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}}),p.message==="ice connection failed"&&h(p),p}},{delayTime:100,strategy:"exponential",maxRetryCount:j.hasFeature(J.ENABLE_HIVE_INFINITE_RETRIES)?1/0:3}),l.info("recvTransport::connected_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}}),this._transportReconnectFailureCount=Math.max(0,this._transportReconnectFailureCount-1),this._consumerCreationFailureCount=0,this._consumerNotBoundFailureCount=0,this.producerIdToConsumerIdMap.clear(),this._recvTransport=r,U.onSafeInitialization(()=>{U.configureRecvTransport(r)})}catch(u){throw l.error(`failed to connect recv transport after retry:${r.id}`,{error:u,transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}}),r.close(),r.removeAllListeners(),this._transportReconnectFailureCount+=1,this.handleFailure(),u}}handleTransport(e,r){if(e.on("connect",async({offer:n},i,a)=>{try{const o={consuming:r,description:{sdp:n.sdp,type:n.type,target:r?Bt.SUBSCRIBER:Bt.PUBLISHER}},{transportId:c,answer:u}=await this._socketHandler.connectTransport(o);e.setServerId(c),i({answer:u})}catch(o){l.error(`${r?"consumer":"producer"} transport connection error:`,{error:o,transport:{id:e==null?void 0:e.id,serverId:e==null?void 0:e.serverId,type:r?"recv":"send"}}),a(o)}}),e.on("connectionstatechange",async n=>{this.updateTransportState({state:n,direction:r?"consuming":"producing"}),l.info(`${r?"consumer":"producer"} transport connectionState:`,{transport:{id:e==null?void 0:e.id,serverId:e==null?void 0:e.serverId,type:r?"recv":"send",status:n}});const i=()=>{this._transportDisconnectedTimer[r?"consuming":"producing"]!==void 0&&(clearTimeout(this._transportDisconnectedTimer[r?"consuming":"producing"]),this._transportDisconnectedTimer[r?"consuming":"producing"]=void 0)};switch(n){case"connected":i(),this.lastConnectionTime=performance.now();break;case"disconnected":this._transportDisconnectedTimer[r?"consuming":"producing"]=setTimeout(()=>{this.triggerTransportReconnection(e,r)},GD);break;case"failed":if(e.closed)return;i(),this.triggerTransportReconnection(e,r);break}}),e.on("icecandidate",async n=>{l.debug("sending icecandidate:",{iceCandidate:n})}),e.on("datachannel:events",async(n,i)=>{var a,o;l.debug("got data channel message on event:",{rtcChannel:{label:n,message:i}});try{switch(i.type){case"negotiation":{e.awaitQueue.push(async()=>this.negotiateOverDC(i,zc(i),n,e));break}case"handshake":{const c={type:"handshake",payload:{message:"pong"}};e.sendResponseOverDC(n,zc(i),c);break}case"consumer_toggle":{this.handleConsumerToggle(i.payload);break}case"hub-disconnect":{l.debug(`media hub disconnected, full_reconnect: ${(a=i.payload)==null?void 0:a.full_reconnect}`),((o=i.payload)==null?void 0:o.full_reconnect)===!0&&this.emit("rejoin");break}case"error":{this.handleErrorOverDC(i.payload,e.id);break}default:l.warn(`unknown event received from hive node, event: ${i.type}`);break}}catch(c){l.error(`Unable to handle the incoming datachannel message on channel ${n}`)}}),e.on("dc_error",()=>{e.direction==="recv"&&(l.warn("events datachannel did not open in 5s"),this.handleFailure())}),e.on("negotiate",async({description:n},i,a)=>{try{const o={sdp:n==null?void 0:n.sdp,type:n==null?void 0:n.type},c=await this.negotiate(e,o);i({answer:c})}catch(o){l.error("negotiate error:",{transport:{id:e.id,serverId:e.serverId,type:e.direction},error:o}),a(o)}}),!r){e.on("produce",async({offer:n,kind:i,paused:a,appData:o},c,u)=>{var v;const p=_u(n.sdp).media.filter(y=>i==="video"?y.type==="video":y.type==="audio").at(-1).msid,f={description:{sdp:n.sdp,type:n.type,target:Bt.PUBLISHER},paused:a,kind:i,msid:p,appData:JSON.stringify(o),screenShare:(v=o.screenShare)!=null?v:!1};try{const{answer:y,producerId:P}=await this._socketHandler.produce(f);c({answer:y,producerId:P})}catch(y){l.error("create producer error:",y),u(y)}});return}e.on("consume_peer",async({producingPeerId:n,producerId:i},a,o)=>{l.info("consumePeer:",n);const c={producingPeerId:n,producerId:i};try{const u=await this._socketHandler.consume(c);l.debug(`consumePeer response for ${n}:`,{consumerStateMap:u});const h=new Map;Object.entries(u).forEach(([p,f])=>{var y,P,k;let v={};try{v=JSON.parse(f.producerState.appData)}catch(I){}h.set(p,{consumerId:f.consumerId,trackId:(y=f.producerTrack)==null?void 0:y.trackId,streamId:f.producerTrack.streamId,kind:f.producerState.kind===Dt.VIDEO?"video":"audio",appData:v,screenShare:(P=f.producerState)==null?void 0:P.screenShare,paused:(k=f.producerState)==null?void 0:k.pause,producingPeerId:n})}),a({consumersMap:h})}catch(u){l.error("consumePeer error:",{error:u}),o(u)}}),e.on("consume",async({producerId:n,producingPeerId:i},a,o)=>{var u,h,p,f,v,y,P,k,I;const c={producingPeerId:i,producerId:n};try{const $=(await this._socketHandler.consume(c))[n];let O={};try{O=JSON.parse((u=$.producerState)==null?void 0:u.appData)}catch(K){}l.info("consumer create response:",{consumer:{remotelyPaused:(h=$.producerState)==null?void 0:h.pause,producerId:(p=$.producerState)==null?void 0:p.producerId,kind:(v=(f=$.producerState)==null?void 0:f.kind)==null?void 0:v.toString(),appData:{...O,screenShare:(y=$.producerState)==null?void 0:y.screenShare},id:$.consumerId},consumerState:$}),a({consumerId:$.consumerId,screenShare:(P=$.producerState)==null?void 0:P.screenShare,trackId:(k=$.producerTrack)==null?void 0:k.trackId,streamId:$.producerTrack.streamId,kind:$.producerState.kind===Dt.VIDEO?"video":"audio",paused:(I=$.producerState)==null?void 0:I.pause,appData:O})}catch(x){l.error("error during consuming on server:",x),o(x)}})}async createProducer(e,r,n){var a;if(this._sendTransport===void 0||this._sendTransport.closed)return null;l.info("createProducer::initializing_producer",{producer:{id:"TO_BE_CREATED",kind:e,status:"initializing",appData:r==null?void 0:r.appData}});const i=this._producerStatus.get(e);if((i==null?void 0:i.trackId)===r.track.id&&(i==null?void 0:i.status)===qr.INITIALIZING)return l.info("createProducer::producer getting initializing",{producer:{id:"GETTING_CREATED",status:"initializing",kind:e,appData:r==null?void 0:r.appData}}),null;this._producerStatus.set(e,{trackId:r.track.id,status:qr.INITIALIZING});try{const o=await this._sendTransport.produce(r);return(a=r.appData)!=null&&a.e2ee&&w.emit(C.E2EE_ACTIVE_PRODUCER,o),l.info("createProducer::initialized_producer",{producer:{id:o==null?void 0:o.id,kind:e,status:"producing",appData:r==null?void 0:r.appData}}),o.on("close",async({offer:c,reason:u},h)=>{l.info("producer::closing",{debuggingHint:u,producer:{id:o==null?void 0:o.id,kind:e,status:"closing",appData:r==null?void 0:r.appData}});const p={producerId:o.id,description:{sdp:c.sdp,type:c.type,target:Bt.PUBLISHER}};try{const f=await this._socketHandler.closeProducer(p),v={sdp:f==null?void 0:f.sdp,type:f==null?void 0:f.type};l.info("producer::closed",{producer:{id:o==null?void 0:o.id,kind:e,status:"closed",appData:r==null?void 0:r.appData}}),h({answer:v})}catch(f){l.error("producer close error",f)}this._producerStatus.delete(e),this._producers.delete(e),n(),this.reconfigureWebcamLayers()}),o.on("trackended",()=>{l.info("producer::trackended",{producer:{id:o==null?void 0:o.id,kind:e,status:"UNKNOWN",appData:o==null?void 0:o.appData}}),[Q.MIC,Q.WEBCAM].includes(e)||n()}),this._producers.set(e,o),this._producerStatus.set(e,{trackId:r.track.id,status:qr.INITIALIZED}),this.reconfigureWebcamLayers(),o.track}catch(o){throw this._producerStatus.set(e,{status:qr.NOT_INITIALIZED,trackId:r.track.id}),l.error("createProducer::transport_initialization_failed",{producer:{id:"FAILED_TO_CREATE",kind:e,status:"failed",appData:r==null?void 0:r.appData,error:o}}),o}}async reconfigureWebcamLayers(){if(!j.hasFeature(J.DISABLE_WEBCAM_LAYERS_ON_SCREENSHARE))return;const e=this.producers.get(Q.WEBCAM);e&&await this._switchProducerSpatialLayer(e,this.producers.get(Q.SCREENSHARE_VIDEO)?0:3)}async _switchProducerSpatialLayer(e,r){try{l.debug("switching layer of webcam producer to:",{media:{video:{layer:r}},producer:{id:e.id,kind:e.kind,appData:e.appData}}),await e.setMaxSpatialLayer(r)}catch(n){l.error("failed to switch spatial layer",{error:n})}}_initConsumer(e){e&&(e.observer.on("close",async r=>{l.debug("consumer closed",{consumer:{closureReason:r,id:e.id,kind:e.kind,appData:e.appData}}),this._consumers.delete(e.id),w.emit(C.CONSUMER_CLOSED,{id:e.id})}),this._consumers.set(e.id,e),this.producerIdToConsumerIdMap.set(e.producerId,e.id),w.emit(C.NEW_CONSUMER,{id:e.id,appData:e.appData,peerId:e.peerId}))}async createConsumers(e){if(this._recvTransport===void 0||this._recvTransport.closed||!this._recvTransport.connected)return;if(e.every(n=>this.getProducer(n.producerId))){l.warn("why are you creating a consumer for local producer?");return}await br(async n=>{n>0&&l.debug(`retrying consume call, retryCount: ${n}`),(await this._recvTransport.consume(e).catch(a=>{throw l.error("failed to consume:",{error:a}),a})).forEach(a=>{a.status==="rejected"?(l.error("consumer creation task is failing",a.reason),this._consumerCreationFailureCount+=1,setTimeout(this.handleFailure.bind(this),0)):this._initConsumer(a.value)})}).catch(n=>{l.error("create consumer failed after retries",{error:n}),this._consumerCreationFailureCount+=1,this.handleFailure()})}async pauseProducer(e){const r=this._producers.get(e);if(!r){l.warn(`producer type: ${e} not found`);return}r.pause(),r.appData.e2ee&&w.emit(C.E2EE_INACTIVE_PRODUCER,r),l.info(`Paused the producer of type: ${r.kind}`,{producer:{id:r.id,kind:r.kind,appData:r.appData}})}async resumeProducer(e){const r=this._producers.get(e);if(!r){l.warn(`producer type: ${e} not found`);return}r.resume(),l.info(`Resumed the producer of type: ${r.kind}`,{producer:{id:r.id,kind:r.kind,appData:r.appData}})}async replaceTrack(e,r){const n=this._producers.get(e);if(!n){l.warn(`producer type: ${e} not found`);return}await n.replaceTrack({track:r}),l.info(`Replaced track for the producer of type: ${n.kind}`,{producer:{id:n.id,kind:n.kind,appData:n.appData,trackId:r.id}})}async removeProducer(e,r){const n=this._producers.get(e);if(!n){l.warn(`producer type: ${e} not found`);return}r&&n.track.stop(),await this.sendTransport.awaitQueue.push(n.close.bind(n),"producer").then(()=>{d(this,Zr).getValue("modules").e2ee.enabled&&w.emit(C.E2EE_INACTIVE_PRODUCER,n)}).catch(i=>{l.error("failed to close producer on server",i)})}async pauseConsumer(e){const r=this._consumers.get(e);if(!r){l.warn(`consumer with id: ${e} not found`);return}this.toggleConsumerOverDC(e,!0),l.info(`Paused the consumer of type: ${r.kind}`,{consumer:{id:r.id,kind:r.kind,appData:r.appData}})}async pauseConsumerOverSocket(e){try{const r={consumerId:e.id,pause:!0};await this.socket.sendMessagePromise(se.toggleConsumer,wc.toBinary(r)),e.pause(),w.emit(C.CONSUMER_PAUSED,{id:e.id}),l.info(`Paused the consumer of type: ${e.kind} over socket`,{consumer:{id:e.id,kind:e.kind,appData:e.appData}})}catch(r){l.error("error on pausing consumer",{error:r,consumer:{id:e.id,kind:e.kind,appData:e.appData}})}}async toggleConsumerOverDC(e,r){const n={type:"consumer_toggle",payload:{consumerId:e,mute:r}},i=this._recvTransport.getDatachannel("events");if(!i){l.warn("recvTransport:: events datachannel not found");return}await i.request(n),l.info(`HiveSFUHandler::consumer toggled, consumerId: ${e}, muted: ${r}`)}async resumeConsumer(e){const r=this._consumers.get(e);if(!r){l.warn(`consumer with id: ${e} not found`);return}if(!r.paused){l.warn(`consumer with id:${e} is not paused so not resuming`);return}try{const n={consumerId:e,pause:!1};await this.socket.sendMessagePromise(se.toggleConsumer,wc.toBinary(n)),r.resume(),w.emit(C.CONSUMER_RESUMED,{id:r.id}),l.info(`Resumed the consumer of type: ${r.kind}`,{consumer:{id:r.id,kind:r.kind,appData:r.appData}})}catch(n){l.error("error on resuming consumer",n)}}async closeConsumer(e,r){return this.closeConsumers([e],r)}async closeConsumers(e,r=!1){l.info(`Closing consumers: ${JSON.stringify(e)} with force: ${r}`);let n=!0;const i=e.filter(c=>this._consumers.get(c)?!0:(l.warn(`consumer with id: ${c} not found`),!1));if(!i.length)return;const a={consumerIds:i},o=async()=>{var c;return(c=this._recvTransport)==null?void 0:c.awaitQueue.push(async()=>{await this._socketHandler.closeConsumer(a)},"close_consumer").catch(u=>{l.warn("error on closing consumer:",{error:u}),n=r})};r?o():await o(),n&&i.forEach(c=>{const u=this.consumers.get(c);this.producerIdToConsumerIdMap.delete(u==null?void 0:u.producerId),u.close(r?"force closed":void 0)})}async cleanupConsumers(e){l.debug("cleaning up all consumers");const r=[];this._consumers.forEach(n=>{e?n.peerId===e&&r.push(n.id):r.push(n.id)}),this.closeConsumers(r,!0)}async stopAllProducers(){l.info("stopping all available producers"),this._producers.forEach((e,r)=>{l.debug(`closing producer type: ${r}`,{producer:{id:e==null?void 0:e.id,kind:e.kind,appData:e.appData}}),e.close()})}getProducer(e){return Array.from(this.producers.values()).filter(r=>r.id===e).at(0)}hasProducer(e){return this.getProducer(e)!==void 0}async negotiate(e,r){l.debug(`setting remote offer : ${JSON.stringify(r)} on ${e.direction} transport`,{transport:{id:e.id,serverId:e.serverId,type:e.direction}});const n=await e.setRemoteOffer(r),i={transportId:e.serverId,description:{sdp:n.sdp,type:n.type,target:Bt.SUBSCRIBER}};return l.debug(`sending renegotiate request: ${JSON.stringify(i)} on ${e.direction} transport`,{transport:{id:e.id,serverId:e.serverId,type:e.direction}}),await this.socket.sendMessagePromise(se.renegotiateSessionDescription,Km.toBinary(i)),l.info("renegotiation done",{transport:{id:e.id,serverId:e.serverId,type:e.direction}}),n}async negotiateOverDC(e,r,n,i){const{sdp:a}=e.payload,o={sdp:a,type:"offer"};try{l.debug(`got offer over dc: ${a} for transport: ${i.id}`);const c=await i.setRemoteOffer(o),u={type:"answer",payload:{type:c.type,sdp:c.sdp}};l.debug(`datachannel answer: ${JSON.stringify(u)}`),i.sendResponseOverDC(n,r,u)}catch(c){l.error("datachannel:events::Error:",c),c.code!=="DC_NOT_FOUND"&&i.sendErrorOverDC(n,r,c)}}handleConsumerToggle(e){const{mute:r,trackId:n}=e;l.info(`consumer toggled for trackId: ${n} muted: ${r}`);const i=this.consumers.get(n);if(!i){l.warn(`consumer with trackId: ${n} not found`);return}i.paused!==r&&(l.debug("consumer state is not same",{consumer:{id:i.id,remotelyPaused:i.paused}}),r?(i.pause(),w.emit(C.CONSUMER_PAUSED,{id:i.id})):(i.resume(),w.emit(C.CONSUMER_RESUMED,{id:i.id})))}async handleErrorOverDC(e,r){l.error(`got error over dc: ${JSON.stringify(e)} for transport: ${r}`);const{type:n,error:i,id:a}=e;if(n==="consumer"){if(i==="bind-fail"){if(j.hasFeature(J.CONSUMER_BIND_NO_RETRY))return;if(this._consumerNotBoundFailureCount>=2){this.handleFailure();return}this._consumerNotBoundFailureCount+=1;const o=this.consumers.get(a);if(!o)return;try{await this.closeConsumer(o.id),await this.createConsumers([{kind:o.kind,pause:o.paused,producerId:o.producerId,producingTransportId:o.producingTransportId,screenShare:o.appData.screenShare,producingPeerId:o.peerId}])}catch(c){l.error("failed to recreate consumer on downtrack bound failure,",{consumer:{id:o.id,producerId:o.producerId,kind:o.kind,appData:o.appData}})}}}else if(n==="producer")if(i==="ready-fail"){if(this._producerNotReadyFailureCount>=2){this.handleFailure();return}this._producerNotReadyFailureCount+=1;const[o]=Array.from(this.producers.entries()).find(c=>c[1].id===a);if(!o)return;await this.removeProducer(o).catch(c=>{l.error("failed to remove ready-fail producer:",{error:c,producer:{id:a,kind:o,appData:null}})})}else i==="general-failure"&&(this.updateTransportState({state:ut.RECONNECTING,direction:"producing"}),this.emit("reconnect_transport",this._sendTransport))}async handleFailure(){if(this._transportReconnectFailureCount>0||this._totalTransportReconnectionCount>3){l.warn("transport failure detected"),j.hasFeature(J.ENABLE_HIVE_EXPERIMENTAL_FAIL_RECOVERY)&&(l.debug("rejoining room"),this.emit("rejoin"));return}(this._consumerCreationFailureCount>0||this._consumerNotBoundFailureCount>=2)&&(l.warn("consumer creation failure detected or consumer not bound failure increased"),j.hasFeature(J.ENABLE_HIVE_EXPERIMENTAL_FAIL_RECOVERY)&&(l.debug("reconnecting recv transport"),this._totalTransportReconnectionCount+=1,this.updateTransportState({state:ut.RECONNECTING,direction:"consuming"}),this.emit("reconnect_transport",this._recvTransport))),this._producerNotReadyFailureCount>=2&&(l.warn("producer receiver not getting added needs to reconnect send transport"),this._totalTransportReconnectionCount+=1,this.updateTransportState({state:ut.RECONNECTING,direction:"producing"}),this.emit("reconnect_transport",this._sendTransport))}triggerTransportReconnection(e,r){l.info("triggerTransportReconnection:: reconnecting transport",{transport:{type:e.direction,id:e.id,serverId:e.serverId}});const n=j.hasFeature(J.ENABLE_HIVE_TRANSPORT_RECONNECTION_ON_ICE_FAILED),i=j.hasFeature(J.HIVE_TRANSPORT_FORCE_RELAY_ON_ICE_FAILED);n&&(i&&this._socket.isConnected&&(performance.now()-this.lastConnectionTime>2e4&&(this._transportConnectionFailCount=0),this._transportConnectionFailCount>2&&(l.warn("Multiple disconnections, forcing relay"),this._iceTransportPolicy="relay"),this._transportConnectionFailCount+=1),this.updateTransportState({state:ut.RECONNECTING,direction:r?"consuming":"producing"}),this.emit("reconnect_transport",e))}async switchConsumersToLayer(e,r){const n=this._recvTransport.getDatachannel("events");if(!n){l.warn("events datachannel not found");return}const i={type:"switch_consumer_layer",payload:{consumerIds:e,layer:r}};await n.request(i),l.info(`HiveSFUHandler::consumer id: ${e} layer switched to ${r}`)}updateTransportState(e){const{state:r,direction:n}=e;r==="disconnected"&&(this.transportDisconnected[n]=!0),this.transportState[n]={state:r,reconnected:r==="connected"?this.transportDisconnected[n]:this.transportState[n].reconnected},r==="connected"&&(this.transportDisconnected[n]=!1),w.emit(C.TRANSPORT_STATE_UPDATE,{transport:n,...this.transportState[n]})}}Zr=new WeakMap;var JD=Object.defineProperty,KD=Object.getOwnPropertyDescriptor,ue=(s,t,e,r)=>{for(var n=r>1?void 0:r?KD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&JD(t,e,n),n};const vn={joinAttempted:!1},zD=3e3,$g=(Dv=class extends kg{constructor(t,e){var c,u;super();S(this,Mr);S(this,ye,void 0);S(this,me,void 0);S(this,Ar,void 0);S(this,Un,void 0);S(this,$n,void 0);S(this,Fs,void 0);S(this,to,void 0);S(this,ro,void 0);S(this,so,void 0);S(this,es,void 0);S(this,Vi,void 0);S(this,tr,void 0);m(this,"legacyMode");m(this,"roomNodeUrl");m(this,"peerDisplayName");m(this,"e2ee");m(this,"partialJoinRoomPromise");this.context=t;const{roomName:r,authToken:n,legacyMode:i,socketClient:a,meetingTitle:o}=e;this.roomJoined=!1,this.roomName=r,this.authToken=n,this.legacyMode=i,this.meetingTitle=o,T(this,ye,a),T(this,Ar,!1),T(this,tr,void 0),T(this,me,new WD(t,a)),this.maxPreferredStreams=6,T(this,es,new Set),T(this,Un,!1),T(this,$n,0),T(this,Fs,new oi),this.e2ee=(u=(c=t.getValue("modules").e2ee)==null?void 0:c.enabled)!=null?u:!1,U.legacySwitch(i),this.handleSocketEvents(),this.handleSocketConnectionEvents(),this.handleSFUEvents(),this.handleCallstatsEvents(),T(this,to,Sr(async()=>{if(!vn.joinAttempted)return;const{roomJoined:h}=await this.joinRoom(this.peerDisplayName,this.roomUUID,{},!0,!0);h&&(w.emit(C.RESET_PRODUCER_STATE),w.emit(C.ROOM_NODE_RECONNECTED))},5e3,{leading:!0,maxWait:1e3})),T(this,ro,Sr(async h=>{h.close(),h.removeAllListeners(),await this.sfuHandler.setupTransports({send:!0}),l.info("send transport reconected!"),w.emit(C.RESET_PRODUCER_STATE)},1e3)),T(this,so,Sr(async h=>{h.close(),h.removeAllListeners(),await this.sfuHandler.setupTransports({recv:!0}),l.info("recv transport reconnected!"),w.emit(C.REFRESH_GRID,!0)},1e3))}get socketState(){return d(this,ye).connectionState}get mediaState(){return d(this,me).transportState}static async init(t,e){const{legacyMode:r=!0,meetingId:n,authToken:i,meetingTitle:a,socket:o}=e;return new $g(t,{legacyMode:r,authToken:i,socketClient:o,roomName:n,meetingTitle:a})}get sfuHandler(){return d(this,me)}get rejoinRoom(){return d(this,to)}reset(t=!0){var e,r,n,i;(r=(e=d(this,me))==null?void 0:e.cleanupConsumers)==null||r.call(e),(i=(n=d(this,me))==null?void 0:n.stopAllProducers)==null||i.call(n),d(this,es).clear(),t&&(d(this,Fs).stop(),this.sfuHandler.stopAllTransports(),this.sfuHandler.reset(),T(this,Fs,new oi))}async reconnectTransport(t){l.info(`HiveNodeClient::Room joining state: ${d(this,Ar)}`),!(!t||d(this,Ar))&&(t.direction==="send"?await d(this,ro).call(this,t):await d(this,so).call(this,t))}async setupTransports(){await d(this,me).setupTransports({send:!0,recv:!0})}async stopAllProducers(){await d(this,me).stopAllProducers()}async joinRoom(t,e,r={},n=!1,i=!1){vn.joinAttempted=!0,T(this,Ar,!0),this.reset(n);const a=Je().ipInfo;if(a!=null&&a.loc&&!d(this,Vi)){const c=a.loc.split(",");T(this,Vi,{latitude:parseFloat(c[0]),longitude:parseFloat(c[1])})}let o;try{return o=await d(this,Fs).push(()=>this._joinRoom(t,e,r,i,d(this,Vi)),"joinRoom"),o}catch(c){o={roomJoined:!1}}return o.roomJoined||w.emit(C.ROOM_NODE_FAILED),o}async _partialJoinRoom(t,e,r=!1,n=void 0){const{ipInfo:i}=Je();let a=n;if(i!=null&&i.loc&&!n){const[o,c]=i.loc.split(",").map(parseFloat);a={latitude:o,longitude:c}}await br((o,c)=>(d(this,ye).isConnected||c(new Error("socket is not connected")),o>0&&l.warn(`retrying sending join room request, count: ${o}`),this.sfuHandler.hiveSocketHandler.joinRoom(e,t,r,a).catch(u=>{throw l.error("failed to send join room request, error:",{error:u}),u})),{delayTime:1e3,strategy:"exponential",maxRetryCount:j.hasFeature(J.ENABLE_HIVE_INFINITE_RETRIES)?1/0:3}),await this.setupTransports()}async partialJoinRoom(t,e,r=!1,n=void 0){this.partialJoinRoomPromise=d(this,Fs).push(()=>this._partialJoinRoom(t,e,r,n))}async _joinRoom(t,e,r={},n=!1,i=null){this.peerDisplayName=t;try{return this.partialJoinRoomPromise?await this.partialJoinRoomPromise:await this._partialJoinRoom(t,e,n,i),j.hasFeature(J.INTERNAL_CALL_STATS)&&navigator.product!=="ReactNative"&&setTimeout(async()=>{const c={userId:this.context.getValue("userId"),peerId:this.peerId,displayName:t,roomUUID:e,roomViewType:"groupCall",roomName:this.roomName,deviceInfo:{...we.getDeviceInfo(),userAgent:navigator.userAgent,memory:navigator.deviceMemory,cpus:navigator.hardwareConcurrency},sdkName:this.context.getValue("sdkName"),sdkVersion:this.context.getValue("sdkVersion"),metaData:{},permissions:{}};U.roomJoined(c),r!=null&&r.audio?U.audioOn():U.audioOff(),r!=null&&r.video?U.videoOn():U.videoOff()}),{roomJoined:await this.completeJoinRoom()}}catch(a){return l.error("error on sending join room request",{error:a}),{roomJoined:!1}}finally{this.partialJoinRoomPromise=void 0}}async completeJoinRoom(){try{this.roomJoined=!0;const{maxPreferredStreams:t,roomState:e}=await this.sfuHandler.hiveSocketHandler.notifySelfJoinComplete();return this.roomUUID=e.roomUuid,T(this,Un,!0),T(this,Ar,!1),this.maxPreferredStreams=t!=null?t:6,w.emit(C.REFRESH_GRID,!0),!0}catch(t){return l.error("error on completing join room:",{error:t}),this.roomJoined=!1,!1}}async leaveRoom(){d(this,me).stopAllTransports(),T(this,Un,!1),vn.joinAttempted=!1;const t={closeRoom:!1};d(this,ye).sendMessagePromise(se.leaveRoom,tf.toBinary(t)).then(e=>{var n;((n=mf.fromBinary(e.payload))==null?void 0:n.closed)||l.warn("weird state on peer closed and should not happen")}).catch(e=>{l.error("error on sending leave room request",{error:e})}),U.callEnded(),g.destruct()}getConsumers(){return d(this,me).consumers}async activatePeers(t){return this.createConsumers(t)}async deactivatePeers(t,e="default"){const r=new Set;t.forEach(i=>{i.screenShare&&i.kind==="video"&&r.add(i.producingPeerId)});const n=e==="default"?t.filter(i=>!r.has(i.producingPeerId)).filter(i=>i.kind!=="audio"):t;await Promise.all(n.map(i=>{const a=this.sfuHandler.producerIdToConsumerIdMap.get(i.producerId);if(!a){l.warn(`consumer not found in deactivate producers: ${i.producerId}`);return}return this.sfuHandler.closeConsumer(a)}))}async createConsumers(t){return t.length===0?Promise.resolve():this.sfuHandler.createConsumers(t)}async pauseConsumers(t){t.forEach(e=>{this.sfuHandler.pauseConsumer(e)})}async resumeConsumers(t){t.forEach(e=>{this.sfuHandler.resumeConsumer(e)})}async closeConsumers(t){await Promise.all(t.map(e=>{const r=this.sfuHandler.producerIdToConsumerIdMap.get(e.producerId);if(!r){l.warn(`consumer not found in deactivate producers: ${e.producerId}`);return}return this.sfuHandler.closeConsumer(r)}))}async shareWebcam(t){if(t===void 0)return null;if(d(this,me).producers.has(Q.WEBCAM)){const n=d(this,me).producers.get(Q.WEBCAM);if(!n.closed&&!navigator.isReactNative)return await n.replaceTrack({track:t}),await this.resumeWebcam(),t;await d(this,me).removeProducer(Q.WEBCAM)}const e={track:t,codecOptions:{name:"VP8"},appData:{screenShare:!1,e2ee:this.e2ee},stopTracks:!1};if(j.hasFeature(J.ENABLE_HIVE_SIMULCAST)){let n=t.getConstraints().width;n in yg||(n=320),e.encodings=yg[n]}const r=()=>{l.info("Disabling video due to the producer closure"),this.disableWebcam()};return d(this,me).createProducer(Q.WEBCAM,e,r)}async shareScreen(t){const{video:e,audio:r}=t;if(e===void 0)return;const n={track:e,codecOptions:{name:"VP8"},appData:{screenShare:!0,e2ee:this.e2ee,supportsRemoteControl:we.isElectron()},stopTracks:!1};let i=()=>{l.info("Disabling screenShare due to the producer closure"),this.disableScreenShare()};if(await d(this,me).createProducer(Q.SCREENSHARE_VIDEO,n,i),r){const a={track:r,codecOptions:{name:"opus"},appData:{screenShare:!0,e2ee:this.e2ee,supportsRemoteControl:we.isElectron()},stopTracks:!1,zeroRtpOnPause:!0};i=()=>{},await d(this,me).createProducer(Q.SCREENSHARE_AUDIO,a,i)}U.screenShareStart()}async shareMic(t){try{if(t===void 0)throw new lt("track undefined");if(d(this,me).producers.has(Q.MIC)){const n=d(this,me).producers.get(Q.MIC);if(!n.closed&&!navigator.isReactNative){await n.replaceTrack({track:t}),await this.resumeMic();return}await d(this,me).removeProducer(Q.MIC,!1)}const e={track:t,encodings:[{priority:"high"}],codecOptions:{name:"opus"},appData:{e2ee:this.e2ee},stopTracks:!1,zeroRtpOnPause:!0},r=()=>{l.info("Disabling audio due to the producer closure"),this.disableMic()};await d(this,me).createProducer(Q.MIC,e,r)}catch(e){throw new b(e)}}pauseMic(){const t=d(this,me).producers.get(Q.MIC);if(!t){l.error("pauseMic::could_not_find_mic_producer");return}if(t.paused){l.info("pauseMic::mic_producer_already_paused");return}t.pause();const e={producerId:t.id,pause:!0};d(this,ye).sendMessage(se.toggleProducer,hs.toBinary(e))}async pauseWebcam(){const t=d(this,me).producers.get(Q.WEBCAM);if(!t){l.error("pauseWebcam::could_not_find_webcam_producer");return}t.pause();const e={producerId:t.id,pause:!0};d(this,ye).sendMessage(se.toggleProducer,hs.toBinary(e))}async resumeMic(){const t=d(this,me).producers.get(Q.MIC);if(!t){l.error("resumeMic::could_not_find_mic_producer");return}if(!t.pause){l.info("resumeMic::mic_producer_already_resumed");return}t.resume(),t.appData.e2ee&&w.emit(C.E2EE_ACTIVE_PRODUCER,t);const e={producerId:t.id,pause:!1};d(this,ye).sendMessage(se.toggleProducer,hs.toBinary(e))}async resumeWebcam(){const t=d(this,me).producers.get(Q.WEBCAM);if(!t){l.error("resumeWebcam::could_not_find_webcam_producer");return}t.resume(),t.appData.e2ee&&w.emit(C.E2EE_ACTIVE_PRODUCER,t);const e={producerId:t.id,pause:!1};d(this,ye).sendMessage(se.toggleProducer,hs.toBinary(e))}async disableWebcam(){await d(this,me).removeProducer(Q.WEBCAM)}async disableMic(){await d(this,me).removeProducer(Q.MIC)}async disableScreenShare(){l.info("screen_sharing_stopped"),U.screenShareStop(),await d(this,me).removeProducer(Q.SCREENSHARE_VIDEO),await d(this,me).removeProducer(Q.SCREENSHARE_AUDIO),d(this,es).clear()}async muteSelf(){this.pauseMic()}async unmuteSelf(){}async resetVideoProducers(t,e){t&&(await d(this,me).removeProducer(Q.WEBCAM,!1),this.shareWebcam(t)),e&&(await d(this,me).removeProducer(Q.SCREENSHARE_VIDEO,!1),this.shareScreen({video:e}))}async changeDisplayName(t,e){const r={displayName:t,participantId:e!=null?e:this.peerId};if(!await this.sfuHandler.hiveSocketHandler.changeDisplayName(r))throw new Error("failed to change display name!")}async kick(t){const e={participantId:t};if(!await this.sfuHandler.hiveSocketHandler.kickPeer(e))throw new Error("failed to kickout the participant!")}async kickAll(){if(!await this.sfuHandler.hiveSocketHandler.kickAll())throw new Error("failed to kickout all participant!")}async muteAll(t){if(!await this.sfuHandler.hiveSocketHandler.hostControlForAll("audio"))throw new Error("failed to mute all participant")}async muteAllVideo(){if(!await this.sfuHandler.hiveSocketHandler.hostControlForAll("video"))throw new Error("failed to mute all video participant")}async disableAudio(t){if(!await this.sfuHandler.hiveSocketHandler.hostControlForPeer(t,"audio"))throw new Error("failed to mute given participant")}async disableVideo(t){if(!await this.sfuHandler.hiveSocketHandler.hostControlForPeer(t,"video"))throw new Error("failed to mute video of given participant")}async pinPeer(t){const e={participantId:t!=null?t:""};try{await d(this,ye).sendMessagePromise(se.globalPinPeer,nf.toBinary(e))}catch(r){l.error("Error in pinning peer:",{error:r})}}validateScreenShare(t){return this.peerId===t.peerId&&this.sfuHandler.hasProducer(t.producerId)&&d(this,es).add(t.consumerPeerId),d(this,es).size}async switchConsumersToLayer(t,e){this.sfuHandler.switchConsumersToLayer(t,e)}async handleSocketEvents(){d(this,ye).on(se.peerProducerCreateBroadcast,({payload:t})=>{if(this.roomJoined)try{const{participantId:e,producerState:r}=bf.fromBinary(t);if(e===this.peerId)return;l.info(`producer created broadcast: ${e}, producer state: ${r}`),w.emit(C.NEW_PRODUCER,{peerId:e,producer:{...r,kind:r.kind===Dt.AUDIO?"audio":"video",producingPeerId:e}})}catch(e){l.error("error in peer-producer-create-broadcast",{error:e})}}),d(this,ye).on(se.peerProducerToggleBroadcast,({payload:t})=>{if(this.roomJoined)try{const{participantId:e,producerState:{kind:r,pause:n,producerId:i}}=Pf.fromBinary(t),a=r===Dt.AUDIO?"audio":"video";if(l.info(`producer toggle broadcast: ${e}, producerId: ${i}, kind:${a}, paused:${n}`),e===this.peerId&&n){w.emit(a==="audio"?C.MUTE_SELF:C.MUTE_SELF_VIDEO);return}w.emit(C.PRODUCER_TOGGLE,{peerId:e,producerId:i,paused:n,kind:a}),Array.from(this.getConsumers().values()).filter(c=>c.producerId===i).forEach(c=>{c.paused!==n&&(l.debug(`consumer state mismatched for ${c.id}. updating consumer pause state ${c.paused} to ${n}`),n?(c.pause(),w.emit(C.CONSUMER_PAUSED,{id:c.id})):(c.resume(),w.emit(C.CONSUMER_RESUMED,{id:c.id})))})}catch(e){l.error("error in producer toggle broadcast handler",{error:e})}}),d(this,ye).on(se.peerLeaveBroadcast,({payload:t})=>{if(this.roomJoined)try{const{participantId:e}=bc.fromBinary(t);if(e===this.peerId)return;l.info(`peer left broadcast:${e}`),d(this,es).delete(e),this.sfuHandler.cleanupConsumers(e),w.emit(C.PEER_CLOSED,{id:e})}catch(e){l.error("error in peer left broadcast",{error:e})}}),d(this,ye).on(se.peerProducerCloseBroadcast,({payload:t})=>{if(this.roomJoined)try{const{participantId:e,producerState:{producerId:r}}=Rf.fromBinary(t);if(e===this.peerId)return;l.info(`producer closed broadcast:${e}`),w.emit(C.PRODUCER_CLOSED,{peerId:e,producerId:r});const n=this.sfuHandler.producerIdToConsumerIdMap.get(r);if(!n){l.warn(`no consumer found for producer:${r}`);return}l.info(`closing consumer ${n}, producer id: ${r}`),this.sfuHandler.closeConsumer(n).then(()=>{l.info(`closed consumer: ${n}`),this.sfuHandler.producerIdToConsumerIdMap.delete(r),w.emit(C.CONSUMER_CLOSED,{id:n})}).catch(i=>{l.error("error closing consumer",{error:i})})}catch(e){l.error("error on producer close broadcast",{error:e})}}),d(this,ye).on(se.mediaRoomTerminationBroadcastResponse,()=>{!this.roomJoined&&!d(this,Ar)&&!d(this,Un)||(l.warn("media hub termination broadcast received, rejoining room"),w.emit(C.ROOM_NODE_DISCONNECTED),this.rejoinRoom())})}handleSocketConnectionEvents(){d(this,ye).onStateEvent("connected",async()=>{l.info("SocketService::Connected to socket-edge"),d(this,tr)&&(clearTimeout(d(this,tr)),T(this,tr,void 0)),le(this,Mr,Ks).call(this,"connected")}),d(this,ye).onStateEvent("disconnected",({code:t,reason:e})=>{l.info("SocketService::Disconnected from socket-edge",{error:{code:t,reason:e}});const{consuming:r,producing:n}=this.mediaState;this.partialJoinRoomPromise=void 0,r.state!==ut.CONNECTED||n.state!==ut.CONNECTED?w.emit(C.SOCKET_SERVICE_DISCONNECTED,{joinAttempted:vn.joinAttempted||d(this,ye).joinAttempted}):T(this,tr,setTimeout(()=>{w.emit(C.SOCKET_SERVICE_DISCONNECTED,{joinAttempted:vn.joinAttempted||d(this,ye).joinAttempted}),T(this,tr,void 0)},zD)),le(this,Mr,Ks).call(this,"disconnected"),this.roomJoined=!1}),d(this,ye).onStateEvent("reconnecting",async()=>{l.info("SocketService::Reconnecting to socket-edge"),le(this,Mr,Ks).call(this,"reconnecting")}),d(this,ye).onStateEvent("reconnectAttempt",async({attempt:t})=>{l.info("SocketService::Attempting to reconnect to socket-edge",{socket:{retryAttempt:t}}),le(this,Mr,Ks).call(this,"reconnectAttempt",t)}),d(this,ye).onStateEvent("reconnectFailure",({attempt:t})=>{l.info("SocketService::Reconnect attempt to socket-edge failed",{socket:{retryAttempt:t}}),le(this,Mr,Ks).call(this,"reconnectFailure",t)}),d(this,ye).onStateEvent("reconnected",async()=>{l.info("SocketService::Reconnected to socket-edge",{connectionState:vn}),d(this,tr)&&(clearTimeout(d(this,tr)),T(this,tr,void 0)),w.emit(C.SOCKET_SERVICE_RECONNECTED,{wasJoinAttempted:vn.joinAttempted||d(this,ye).joinAttempted}),le(this,Mr,Ks).call(this,"reconnected")}),d(this,ye).onStateEvent("failed",async()=>{l.info("SocketService::Failed to connect to socket-edge"),w.emit(C.SOCKET_SERVICE_FAILED),le(this,Mr,Ks).call(this,"failed"),this.roomJoined=!1})}handleSFUEvents(){d(this,me).on("reconnect_transport",async t=>{try{await this.reconnectTransport(t),l.info(`transport reconnected [id:${t.id}]`)}catch(e){l.error("error on reconnection transports",{error:e})}}),d(this,me).on("rejoin",t=>{var e;if(((e=this.socketState)==null?void 0:e.state)!=="connected"){l.warn("Ignoring rejoin attempt because socket is not connected");return}if(d(this,$n)>3&&!t){l.warn("cannot rejoin more already rejoined 3 times");return}if(d(this,Ar)&&!t){l.warn("room joining in progress, cannot start rejoining");return}T(this,$n,d(this,$n)+1),l.warn(`rejoining the room because transports are failing. [rejoinCount: ${d(this,$n)}]`),this.roomJoined=!1,w.emit(C.ROOM_NODE_DISCONNECTED),this.rejoinRoom()})}handleCallstatsEvents(){U.onSafeInitialization(()=>{U.onConsumerScore(t=>{t.forEach((e,r)=>{const n=this.sfuHandler.consumers.get(r);n&&w.emit(C.CONSUMER_SCORE_UPDATE,{id:r,kind:n.kind,peerId:n.peerId,score:e.score,scoreStats:e})})}),U.onProducerScore(t=>{t.forEach((e,r)=>{const n=Array.from(this.sfuHandler.producers.values()).find(i=>i.id===r);n&&w.emit(C.PRODUCER_SCORE_UPDATE,{id:r,kind:n.kind,appData:n.appData,score:e.score,scoreStats:e})})})})}},ye=new WeakMap,me=new WeakMap,Ar=new WeakMap,Un=new WeakMap,$n=new WeakMap,Fs=new WeakMap,to=new WeakMap,ro=new WeakMap,so=new WeakMap,es=new WeakMap,Vi=new WeakMap,tr=new WeakMap,Mr=new WeakSet,Ks=function(t,e){let r;const{reconnected:n}=d(this,ye).connectionState;switch(t){case"connected":r={state:"connected",reconnected:n,reconnectionAttempt:void 0};break;case"disconnected":r={state:"disconnected",reconnected:!1,reconnectionAttempt:0};break;case"reconnected":r={state:"connected",reconnected:!0,reconnectionAttempt:void 0};break;case"reconnecting":r={state:"reconnecting",reconnected:n,reconnectionAttempt:0};break;case"reconnectAttempt":r={state:"reconnecting",reconnected:n,reconnectionAttempt:e};break;case"failed":r={state:"failed",reconnected:n,reconnectionAttempt:void 0};break}r&&(w.emit(C.SOCKET_STATE_UPDATE,r),d(this,ye).connectionState=r)},Dv);let ie=$g;ue([g.trace("HiveNodeClient.reset")],ie.prototype,"reset",1),ue([g.trace("HiveNodeClient.reconnect")],ie.prototype,"reconnectTransport",1),ue([g.trace("HiveNodeClient.setupTransport")],ie.prototype,"setupTransports",1),ue([g.trace("HiveNodeClient.stopAllProducers")],ie.prototype,"stopAllProducers",1),ue([g.trace("HiveNodeClient.joinRoom")],ie.prototype,"joinRoom",1),ue([g.trace("HiveNodeClient.completeJoinRoom")],ie.prototype,"completeJoinRoom",1),ue([g.trace("HiveNodeClient.leaveRoom")],ie.prototype,"leaveRoom",1),ue([g.trace("HiveNodeClient.activatePeers")],ie.prototype,"activatePeers",1),ue([g.trace("HiveNodeClient.deactivatePeers")],ie.prototype,"deactivatePeers",1),ue([g.trace("HiveNodeClient.createConsumers")],ie.prototype,"createConsumers",1),ue([g.trace("HiveNodeClient.pauseConsumers")],ie.prototype,"pauseConsumers",1),ue([g.trace("HiveNodeClient.resumeConsumers")],ie.prototype,"resumeConsumers",1),ue([g.trace("HiveNodeClient.closeConsumers")],ie.prototype,"closeConsumers",1),ue([g.trace("HiveNodeClient.shareWebcam")],ie.prototype,"shareWebcam",1),ue([g.trace("HiveNodeClient.shareScreen")],ie.prototype,"shareScreen",1),ue([g.trace("HiveNodeClient.shareMic")],ie.prototype,"shareMic",1),ue([g.trace("HiveNodeClient.pauseMic")],ie.prototype,"pauseMic",1),ue([g.trace("HiveNodeClient.pauseWebcam")],ie.prototype,"pauseWebcam",1),ue([g.trace("HiveNodeClient.resumeMic")],ie.prototype,"resumeMic",1),ue([g.trace("HiveNodeClient.resumeWebcam")],ie.prototype,"resumeWebcam",1),ue([g.trace("HiveNodeClient.disableWebcam")],ie.prototype,"disableWebcam",1),ue([g.trace("HiveClient.disableMic")],ie.prototype,"disableMic",1),ue([g.trace("HiveClient.disableScreenShare")],ie.prototype,"disableScreenShare",1),ue([g.trace("HiveNodeClient.muteSelf")],ie.prototype,"muteSelf",1),ue([g.trace("HiveNodeClient.resetVideoProducers")],ie.prototype,"resetVideoProducers",1),ue([g.trace("HiveNodeClient.changeDisplayName")],ie.prototype,"changeDisplayName",1),ue([g.trace("HiveNodeClient.kickPeer")],ie.prototype,"kick",1),ue([g.trace("HiveNodeClient.kickAllPeers")],ie.prototype,"kickAll",1),ue([g.trace("HiveNodeClient.muteAll")],ie.prototype,"muteAll",1),ue([g.trace("HiveNodeClient.muteAllVideo")],ie.prototype,"muteAllVideo",1),ue([g.trace("HiveNodeClient.disableAudio")],ie.prototype,"disableAudio",1),ue([g.trace("HiveNodeClient.disableVideo")],ie.prototype,"disableVideo",1),ue([g.trace("HiveNodeClient.pinPeer")],ie.prototype,"pinPeer",1),ue([g.trace("HiveNodeClient.validateScreenShare")],ie.prototype,"validateScreenShare",1),ue([g.trace("HiveNodeClient.init")],ie,"init",1);class YD{constructor(){m(this,"_orderedArray");m(this,"_map");this._map=new Map,this._orderedArray=[]}add(t,e){if(!this._map.has(t))return this._map.set(t,{peerId:t,priority:e}),this._orderedArray.splice(Math.max(e-1,0),0,t),this.index(t);const r=this.index(t);this.delete(t);const n=this.add(t,e);return r!==n?n:-1}delete(t){if(this._map.has(t)){const e=this.index(t);this._map.delete(t),this._orderedArray.splice(e,1)}}index(t){return this._map.has(t)?this._orderedArray.indexOf(t):-1}[Symbol.iterator](){return this._orderedArray[Symbol.iterator]()}}class Pu{constructor(){m(this,"_activeSpeakerPeers");m(this,"_compulsoryPeers");this._activeSpeakerPeers=new YD,this._compulsoryPeers=new Set}add(t,e){if(e<0)return this._compulsoryPeers.add(t),0;if(this.compulsoryPeers.includes(t)&&(e>0||e===246267631)){if(l.info("DyteSelectedPeer::removing_compulsory_peer",{selectedPeer:{peerId:t}}),this._removeFromCompulsoryPeer(t),e===246267631)return-1}else if(e===229490415)return this.delete(t),-1;return this._activeSpeakerPeers.add(t,e)}delete(t){l.info("DyteSelectedPeer::deleting_peer_from_selectedPeer",{selectedPeer:{peerId:t}}),this._removeFromCompulsoryPeer(t),this._activeSpeakerPeers.delete(t)}index(t){return this._activeSpeakerPeers.index(t)}get peers(){return Array.from(new Set(this.compulsoryPeers.concat(this.activeSpeakerPeers)))}get compulsoryPeers(){return Array.from(this._compulsoryPeers.values())}get peerPriorities(){return Array.from(this._activeSpeakerPeers).map((t,e)=>e)}get activeSpeakerPeers(){return Array.from(this._activeSpeakerPeers)}_removeFromCompulsoryPeer(t){this._compulsoryPeers.delete(t)}}var QD=Object.defineProperty,XD=Object.getOwnPropertyDescriptor,Gt=(s,t,e,r)=>{for(var n=r>1?void 0:r?XD(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&QD(t,e,n),n};const ZD=["ACTIVE_GRID","PAGINATED","MANUAL"];let Pt=(Ov=class extends Ht{constructor(t,e,r){super();S(this,Ft);m(this,"waitlisted");m(this,"joined");m(this,"active");m(this,"videoSubscribed");m(this,"audioSubscribed");m(this,"pinned");m(this,"all");S(this,xs,void 0);S(this,Us,void 0);S(this,Jt,void 0);m(this,"viewMode");m(this,"currentPage");m(this,"lastActiveSpeaker");m(this,"selectedPeers",new Pu);T(this,xs,t),T(this,Us,e),T(this,Jt,r),this.waitlisted=new ni,this.joined=new ni,this.active=new ni,this.videoSubscribed=new ni,this.audioSubscribed=new ni,this.pinned=new ni,this.selectedPeers=new Pu,this.all=new TD,this.viewMode="ACTIVE_GRID",this.currentPage=0,this.setupEvents()}get pip(){return d(this,xs).getValue("pip")}get roomJoined(){var t;return((t=d(this,Ft,nr))==null?void 0:t.roomJoined)===!0}setupEvents(){w.on(C.E2EE_ACTIVE_CONSUMER,({peerId:t})=>{var e;((e=d(this,xs).getValue("modules").e2ee)==null?void 0:e.enabled)!==!0&&this.emit("media_decode_error",{reason:`Got encrypted media for participantId ${t}, but encryption wasn't enabled in init.defaults`,code:"1702"})})}get count(){return this.joined.size}get maxActiveParticipantsCount(){return d(this,Ft,nr).maxPreferredStreams}setMaxActiveParticipantsCount(t){if(t<0||t>24)throw new b("0 <= Max active participants count limit <= 24");d(this,Ft,nr).maxPreferredStreams=t,d(this,Us).roomJoined&&w.emit(C.REFRESH_GRID)}get pageCount(){if(this.viewMode==="PAGINATED"){const t=this.joined.toArray().filter(e=>e.stageStatus==="ON_STAGE");return Math.ceil(t.length/this.maxActiveParticipantsCount)}return 0}acceptWaitingRoomRequest(t){var r,n;if(!this.roomJoined)throw new b("Can`t accept waiting room request without joining room");const e=(n=(r=this.waitlisted.get(t))==null?void 0:r.userId)!=null?n:t;return d(this,Jt).acceptWaitingRoomRequest([e])}async acceptAllWaitingRoomRequest(t){const e=t.map(r=>{var n,i;return(i=(n=this.waitlisted.get(r))==null?void 0:n.userId)!=null?i:r});return d(this,Jt).acceptWaitingRoomRequest(e)}async rejectWaitingRoomRequest(t){var r,n;if(!this.roomJoined)throw new b("Can`t reject waiting room request without joining room");const e=(n=(r=this.waitlisted.get(t))==null?void 0:r.userId)!=null?n:t;d(this,Jt).rejectWaitingRoomRequest([e])}async setViewMode(t){if(l.info("DyteParticipants::set_view_mode",{pageNavigation:{viewMode:t,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),!(r=>ZD.includes(r))(t))throw l.error("DyteParticipants::setViewMode::invalid_view_mode",{pageNavigation:{viewMode:t,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),new b(`Invalid view mode: ${t}. Try ACTIVE_GRID, PAGINATED or MANUAL.`);if(this.viewMode===t){l.info("DyteParticipants::setViewMode::view_mode_same_as_previous");return}if(t==="MANUAL"&&!(d(this,Ft,nr)instanceof ie))throw new b("Manual Subscription is not enabled for your Organization. Please contact support.");this.viewMode=t,t==="PAGINATED"?(this.currentPage=1,w.emit(C.UPDATE_ACTIVE,{page:this.currentPage})):t==="ACTIVE_GRID"&&(this.currentPage=0,w.emit(C.UPDATE_ACTIVE)),this.emit("viewModeChanged",{viewMode:t,currentPage:this.currentPage,pageCount:this.pageCount})}async subscribe(t,e=["audio","video","screenshareAudio","screenshareVideo"]){if(this.viewMode!=="MANUAL")throw new b("MANUAL subscription mode was not activated.");const r=[];t.forEach(n=>{const i=this.joined.get(n);if(i){if(e.includes("audio")){i.manualProducerConfig={...i.manualProducerConfig,audio:!0},this.videoSubscribed.add(i);const a=i.producers.find(o=>o.kind==="audio"&&!o.screenShare);a&&r.push(a)}if(e.includes("video")){i.manualProducerConfig={...i.manualProducerConfig,video:!0},this.audioSubscribed.add(i);const a=i.producers.find(o=>o.kind==="video"&&!o.screenShare);a&&r.push(a)}if(e.includes("screenshareAudio")){i.manualProducerConfig={...i.manualProducerConfig,screenshareAudio:!0};const a=i.producers.find(o=>o.kind==="audio"&&o.screenShare);r.push(a)}if(e.includes("screenshareVideo")){i.manualProducerConfig={...i.manualProducerConfig,screenshareVideo:!0};const a=i.producers.find(o=>o.kind==="video"&&o.screenShare);r.push(a)}}}),await d(this,Ft,nr).createConsumers(r)}async unsubscribe(t,e=["audio","video","screenshareAudio","screenshareVideo"]){if(this.viewMode!=="MANUAL")throw new b("MANUAL subscription mode was not activated.");const r=[];t.forEach(n=>{const i=this.joined.get(n);if(i){if(e.includes("audio")){i.manualProducerConfig={...i.manualProducerConfig,audio:!1};const a=i.producers.find(o=>o.kind==="audio"&&!o.screenShare);a&&r.push(a)}if(e.includes("video")){i.manualProducerConfig={...i.manualProducerConfig,video:!1};const a=i.producers.find(o=>o.kind==="video"&&!o.screenShare);a&&r.push(a)}if(e.includes("screenshareAudio")){i.manualProducerConfig={...i.manualProducerConfig,screenshareAudio:!1};const a=i.producers.find(o=>o.kind==="audio"&&o.screenShare);r.push(a)}if(e.includes("screenshareVideo")){i.manualProducerConfig={...i.manualProducerConfig,screenshareVideo:!1};const a=i.producers.find(o=>o.kind==="video"&&o.screenShare);r.push(a)}}}),await d(this,Ft,nr).closeConsumers(r)}async subscribe(t){if(this.viewMode!=="MANUAL")throw new b("Please activate MANUAL subscription mode first.");const e={},r=[],n=[];t.forEach(c=>{e[c.id]=!0;const u=this.active.get(c.id);if(!u)r.push(c);else{u.manualProducerConfig=c.producers;const h=async({producers:p,config:f})=>{const v=[];p.forEach(y=>{const P=y.kind==="audio",k=y.kind==="video";(P&&(f.audio&&!y.screenShare||f.screenshareAudio&&y.screenShare)||k&&(f.video&&!y.screenShare||f.screenshareVideo&&y.screenShare))&&v.push(y),d(this,Ft,nr).closeConsumers(v)})};n.push(h({peerId:c.id,config:c.producers,producers:u.producers}))}});const i=[];this.active.forEach(c=>{if(e[c.id])return;const u=async h=>{await d(this,Ft,nr).deactivatePeers(h.producers),this.active.delete(h.id);const p=this.joined.get(h.id);p.manualProducerConfig=Am};i.push(u(c))}),await Promise.all([...i,...n]);const a=(c,u)=>c.reduce((h,p)=>(!p.screenShare&&u[p.kind]&&h.push(p),p.screenShare&&(p.kind==="audio"&&u.screenshareAudio||p.kind==="video"&&u.screenshareVideo)&&h.push(p),h),[]),o=r.map(c=>{const u=this.joined.get(c.id);return this.active.add(u),u.manualProducerConfig=c.producers,a(u.producers,c.producers)}).flat();await d(this,Ft,nr).activatePeers(o),this.active.emit("participantsUpdate")}getPeerIdsForCurrentPage(){l.info("DyteParticipants::getPeerIdsForCurrentPage()",{pageNavigation:{viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}});const{compulsoryPeers:t}=this.selectedPeers,e=t.filter(o=>this.joined.has(o)),r=Array.from(this.pinned.keys()).filter(o=>!e.includes(o)),n=Array.from(this.joined.toArray().filter(o=>o.stageStatus==="ON_STAGE").map(o=>o.id)),i=Math.max((this.currentPage-1)*(this.maxActiveParticipantsCount-e.length-r.length)),a=this.currentPage*(this.maxActiveParticipantsCount-e.length-r.length);return e.concat(r,n.slice(i,a))}async setPage(t){if(l.info("DyteParticipants::set_page",{pageNavigation:{settingPage:t,viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),this.viewMode==="PAGINATED"){if(!Number.isInteger(t))throw l.error("DyteParticipants::invalid_page_number"),new b(`Invalid page: ${t}. Page must be an integer and greater than 0 and less than or equal to .pageCount`);this.currentPage=t,w.emit(C.UPDATE_ACTIVE,{page:t}),this.emit("pageChanged",{viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount})}}async disableAllAudio(t){if(l.info("DyteParticipants::disable_all_audio",{actions:{disableAllAudio:{allowUnmute:t}}}),!this.roomJoined)throw new b("Can`t disable all audio without joining room");if(d(this,Us).permissions.canAllowParticipantAudio)return d(this,Ft,nr).muteAll(t);throw l.error("DyteParticipants::unauthorized_disable_all_audio",{actions:{disableAllAudio:{allowUnmute:t}}}),new b("Unauthorized: User does not have permission to disable peer audio.")}async disableAllVideo(){if(l.info("DyteParticipants::disable_all_video"),!this.roomJoined)throw new b("Can`t disable all video without joining room");if(d(this,Us).permissions.canAllowParticipantVideo)return d(this,Ft,nr).muteAllVideo();throw l.error("DyteParticipants::unauthorized_disable_all_video"),new b("Unauthorized: User does not have permission to disable peer video.")}async disableAudio(t){this.joined.get(t).disableAudio()}async disableVideo(t){this.joined.get(t).disableVideo()}async kick(t){await w.emitAsync(C.KICK_PEER,{peerId:t})}async kickAll(){if(l.info("DyteParticipants::kick_all"),d(this,xs).getValue("viewType")!=="LIVESTREAM"&&!this.roomJoined)throw new b("Can`t kick all without joining room");if(!d(this,Us).permissions.kickParticipant)throw l.error("DyteParticipants::unauthorized_kick_all"),new b("Unauthorized: User does not have permission to kick peers.");const e=j.hasFeature(J.PROPAGATE_KICK_ALL);d(this,Jt).kickAll(e)}async broadcastMessage(t,e,r){if(l.info("DyteParticipants::broadcastMessage"),!this.roomJoined)throw new b("Can`t broadcast message without joining room");if(!(t!=null&&t.trim()))throw new b("`type` must be a non-empty string.");if(r){let n=[];"participantIds"in r?n=r.participantIds:n=this.joined.toArray().filter(i=>{var a;return(a=r.presetNames)==null?void 0:a.includes(i.presetName)}).map(i=>i.id),d(this,Jt).broadcastToPeers(t,n,e)}else d(this,Jt).broadcastMessage(t,e)}async getAllJoinedPeers(t,e,r){return(await d(this,Jt).getRoomPeers(t,e,r)).peers.map(jr.formatSocketServiceMessage)}async updatePermissions(t,e){const r=this.joined.toArray().filter(i=>t.includes(i.id)).map(i=>i.userId),n=[...new Set(r)];if(!n.length)throw new b("Cannot update permissions, no valid userIDs found");d(this,Jt).updatePermissions(n,e)}async getParticipantsInMeetingPreJoin(){return d(this,Jt).getRoomPeersNonPaginated()}},xs=new WeakMap,Ft=new WeakSet,nr=function(){return d(this,xs).getValue("roomNodeClient")},Us=new WeakMap,Jt=new WeakMap,Ov);Gt([g.trace("DyteParticipants.setViewMode")],Pt.prototype,"setViewMode",1),Gt([g.trace("DyteParticipants.setPage")],Pt.prototype,"setPage",1),Gt([g.trace("DyteParticipants.disableAllAudio")],Pt.prototype,"disableAllAudio",1),Gt([g.trace("DyteParticipants.disableAllVideo")],Pt.prototype,"disableAllVideo",1),Gt([g.trace("DyteParticipants.disablePeerAudio")],Pt.prototype,"disableAudio",1),Gt([g.trace("DyteParticipants.disablePeerVideo")],Pt.prototype,"disableVideo",1),Gt([g.trace("DyteParticipants.kickPeer")],Pt.prototype,"kick",1),Gt([g.trace("DyteParticipants.kickAll")],Pt.prototype,"kickAll",1),Gt([g.trace("DyteParticipants.broadcastMessage"),Ot({maxInvocations:500,period:60})],Pt.prototype,"broadcastMessage",1),Gt([g.trace("DyteParticipants.getAllJoinedPeers"),Ot({maxInvocations:10,period:60})],Pt.prototype,"getAllJoinedPeers",1),Gt([g.trace("DyteParticipant.updatePermissions"),Ot({maxInvocations:1e3,period:60})],Pt.prototype,"updatePermissions",1),Gt([g.trace("DyteParticipants.getParticipantsInMeetingPreJoin")],Pt.prototype,"getParticipantsInMeetingPreJoin",1),Pt=Gt([mt("1200")],Pt);var eO=Object.defineProperty,tO=Object.getOwnPropertyDescriptor,di=(s,t,e,r)=>{for(var n=r>1?void 0:r?tO(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&eO(t,e,n),n};const Vg=class{constructor(s,t,e){m(this,"participants");m(this,"self");m(this,"selectedPeers",new Pu);m(this,"currentActiveGridParticipants",new Set);m(this,"maxSpatialLayerUpdates",new Map);m(this,"consumerPeerMap");m(this,"roomSocketHandler");m(this,"context");m(this,"videoPeerConsumerMap",new Map);m(this,"updateConsumerSpatialLayers",Sr(()=>{const s={},t=new Map(this.maxSpatialLayerUpdates);this.maxSpatialLayerUpdates.clear(),Array.from(t.entries()).forEach(([e,r])=>{s[r]===void 0&&(s[r]={layer:r,consumerIds:[]}),s[r].consumerIds.push(e)}),Object.keys(s).forEach(e=>{const r=s[e];l.log(`Switching max spatial layer to ${r.layer}`,{consumerIds:r.consumerIds}),this.roomNodeClient.switchConsumersToLayer(r.consumerIds,r.layer)})},2e3));m(this,"refreshGridParticipants",Sr((s=!1)=>{const t=new Map,e=Array.from(this.participants.joined.toArray().filter(h=>h.stageStatus==="ON_STAGE").map(h=>(t.set(h.id,!0),h.id))),r=this.selectedPeers.peers,n=this.participants.pinned.toArray().reduce((h,p)=>(p.stageStatus!=="ON_STAGE"?this.participants.pinned.delete(p.id):h.push(p.id),h),[]);if(this.participants.viewMode!=="ACTIVE_GRID"){l.warn("ParticipantController::refreshGridParticipants::not_refreshing_grid_in_not_active_grid_mode");return}const i=this.self.stageStatus==="ON_STAGE"?1:0,a=this.participants.maxActiveParticipantsCount-i,o=new Set(r.concat(n).filter(h=>h!==this.self.id&&t.has(h)));let c=Array.from(o);const u=a-o.size;if(u>=0){const h=e.filter(p=>!o.has(p)&&p!==this.self.id).slice(0,u);c=Array.from(o).concat(h)}else c=c.slice(0,a);this.updateActiveParticipants(c,s)},500,{trailing:!0,leading:!0}));this.context=s,this.roomSocketHandler=e,this.participants=new Pt(s,t,this.roomSocketHandler),this.self=t,this.consumerPeerMap=new Map,t.config.viewType!=="CHAT"&&this.setupEventsGlobal()}get roomJoined(){var s;return((s=this.roomNodeClient)==null?void 0:s.roomJoined)===!0}get pip(){return this.context.getValue("pip")}waitingRoomRequestHandler(s){const t=s.requests.filter(r=>!this.participants.waitlisted.toArray().find(n=>n.userId===r.userId)),e=this.participants.waitlisted.toArray().filter(r=>!s.requests.find(n=>n.userId===r.userId));t.forEach(r=>this.participants.waitlisted.add(new Hr(this.context,{id:r.peerId,displayName:r.displayName,audioMuted:!0,videoEnabled:!1,audioTrack:void 0,videoTrack:void 0,stageStatus:"OFF_STAGE",userId:r.userId,flags:{},isHost:!1,customParticipantId:r.customParticipantId,picture:r.picture,metadata:{preset_name:r.presetName}},this.self,this.roomSocketHandler))),e.forEach(r=>this.participants.waitlisted.delete(r.id))}get maxPreferredStreams(){return this.participants.maxActiveParticipantsCount}async updateActiveLegacy({page:s}){if(s&&s!==0){const{compulsoryPeers:t}=this.selectedPeers,e=t.filter(c=>this.participants.joined.has(c)),r=Array.from(this.participants.pinned.keys()).filter(c=>!e.includes(c)),n=Array.from(this.participants.joined.toArray().filter(c=>c.stageStatus==="ON_STAGE").map(c=>c.id)),i=Math.max((s-1)*(this.roomNodeClient.maxPreferredStreams-e.length-r.length)),a=s*(this.roomNodeClient.maxPreferredStreams-e.length-r.length),o=e.concat(r,n.slice(i,a));this.updatePageParticipants(o)}else this.refreshGridParticipants()}async selectPagePeers(s){const{compulsoryPeers:t}=this.selectedPeers,e=t.filter(c=>this.participants.joined.has(c)),r=Array.from(this.participants.pinned.keys()).filter(c=>!e.includes(c)),n=Array.from(this.participants.joined.toArray().filter(c=>c.stageStatus==="ON_STAGE").map(c=>c.id)),i=Math.max((s-1)*(this.roomNodeClient.maxPreferredStreams-e.length-r.length)),a=s*(this.roomNodeClient.maxPreferredStreams-e.length-r.length);return e.concat(r,n.slice(i,a))}async selectActivePeers(){const s=new Map,t=Array.from(this.participants.joined.toArray().filter(u=>u.stageStatus==="ON_STAGE").map(u=>(s.set(u.id,!0),u.id))),e=this.selectedPeers.peers,r=this.participants.pinned.toArray().reduce((u,h)=>(h.stageStatus!=="ON_STAGE"?this.participants.pinned.delete(h.id):u.push(h.id),u),[]);if(this.participants.viewMode!=="ACTIVE_GRID")throw l.warn("ParticipantController::selectActivePeers::not_refreshing_grid_in_not_active_grid_mode"),new Error("Running selectActivePeers, but viewMode is not ACTIVE_GRID");const n=this.self.stageStatus==="ON_STAGE"?1:0,i=this.participants.maxActiveParticipantsCount-n,a=new Set(e.concat(r).filter(u=>u!==this.self.id&&s.has(u)));let o=Array.from(a);const c=i-a.size;if(c>=0){const u=t.filter(h=>!a.has(h)&&h!==this.self.id).slice(0,c);o=Array.from(a).concat(u)}else o=o.slice(0,i);return o}async updateActive(s){let t,e;s&&s!==0?(t=await this.selectPagePeers(s),l.info("ParticipantController::updateActive::updating_current_page_peers",{peerIds:t}),e={video:this.updateParticipantsMap.bind(this),audio:this.updateParticipantsMap.bind(this)}):(t=await this.selectActivePeers(),l.info("ParticipantController::updateActive::updating_current_selected_peers",{peerIds:t}),e={video:this.updateParticipantsMapMinReplacement.bind(this),audio:this.updateParticipantsMap.bind(this)}),this.updateConsumerMaps(t,e)}updatePageParticipants(s){const t=new Set(s),e=new Map(this.participants.active);this.participants.active.forEach((i,a)=>{this.participants.active.delete(a,!t.has(a))}),t.forEach(i=>{if(!this.participants.joined.get(i)){l.warn("updatePageParticipants::participant_not_in_joined_list",{dyteParticipant:{id:i}});return}this.participants.active.add(this.participants.joined.get(i),!e.get(i))}),this.currentActiveGridParticipants=new Set(this.participants.active.keys());let r=[],n=[];return Array.from(e.keys()).forEach(i=>{if(t.has(i))return;const a=this.participants.joined.get(i);a&&(r=r.concat(a.producers))}),this.roomNodeClient.deactivatePeers(r),this.participants.active.forEach(i=>{n=n.concat(i.producers)}),this.roomNodeClient.activatePeers(n),{activePeers:e,peerIdsSet:t}}computeActivateParticipants(s,t){const e=s.map((n,i)=>({peerId:n,priority:i+1})),r=t==null?void 0:t.map((n,i)=>({peerId:n,priority:-(i+1)}));e.push(...r!=null?r:[]),e.length>0&&this.updateActiveParticipantsWithPriorities(e)}fromSocketService(s){const t=Vg.formatSocketServiceMessage(s);return new Hr(this.context,{...t,isHost:!1,videoEnabled:!1,audioMuted:!0,videoTrack:void 0,audioTrack:void 0},this.self,this.roomSocketHandler)}updatePipSource(s,t){var e,r;t?(e=this.pip)==null||e.enableSource(s):(r=this.pip)==null||r.disableSource(s)}async onMediaJoined(s,t){if(!this.roomJoined||s===this.self.id)return;const e=this.participants.joined.get(s);if(!e){l.warn(`Recieved media.peerJoinedBroadcast for non-existent peer ${s}`);return}t.forEach(r=>{r.kind===Dt.AUDIO&&!r.screenShare?e.setAudioEnabled(!r.pause):r.kind===Dt.VIDEO&&!r.screenShare&&(e.setVideoEnabled(!r.pause),this.updatePipSource(e.id,!r.pause)),e.producers.push({...r,producingTransportId:r.producingTransportId,kind:r.kind===Dt.AUDIO?"audio":"video",producingPeerId:s})})}updateParticipantsMapMinReplacement(s,t){const e=Array.from(s.keys()),r=new Map(s),n=[],i=[],a=new Set(t),o=[];return e.forEach((c,u)=>{(!a.has(c)||!this.participants.joined.get(c))&&o.push(u)}),t.forEach(c=>{if(!s.get(c)){if(e.length<t.length){e.push(c),n.push(c);return}e[o.shift()]=c}}),e.forEach((c,u)=>{a.has(c)||i.concat(e.splice(u,1))}),Array.from(s.keys()).forEach(c=>{s.delete(c,!a.has(c))}),e.forEach(c=>{if(!this.participants.joined.get(c)){l.warn("updateActiveParticipants::participant_not_in_joined_list",{dyteParticipant:{id:c}});return}s.add(this.participants.joined.get(c),!r.get(c))}),s.emit("participantsUpdate"),[n,i]}updateParticipantsMap(s,t){const e=Array.from(s.keys()),r=[],n=[];return e.forEach(i=>{t.includes(i)||(s.delete(i,!0),n.push(i))}),t.forEach(i=>{s.get(i)||(s.add(this.participants.joined.get(i)),r.push(i))}),s.emit("participantsUpdate"),[r,n]}updatePinnedParticipants(){this.participants.pinned.forEach(s=>{s.setIsPinned(!1),this.participants.pinned.delete(s.id)})}setupEventsGlobal(){this.roomSocketHandler.on(V.joinRoom,({peer:s})=>{if(!s.waitlisted){if(this.context.getValue("viewType")==="LIVESTREAM"&&s.stageType!==1)return;const e=j.hasFeature(J.DEBUG_SOCKET_JOIN);e&&l.info("Processing socket join",{peers:s.peerId}),this.onParticipantJoined(this.fromSocketService(s)),e&&l.info("Processed socket join",{peers:s.peerId})}}),this.roomSocketHandler.on(V.leaveRoom,s=>{this.selectedPeers.delete(s.peer.peerId),this.onParticipantLeave(s.peer.peerId)}),w.on(C.SOCKET_SERVICE_ROOM_JOINED,()=>{this.self.permissions.acceptWaitingRequests&&this.roomSocketHandler.getWaitingRoomRequests()}),this.self.permissions.on("permissionsUpdate",s=>{const{acceptWaitingRequests:t}=s;t!==void 0&&(t?this.roomSocketHandler.getWaitingRoomRequests():this.participants.waitlisted.clear())}),w.on(C.SOCKET_SERVICE_DISCONNECTED,()=>{Array.from(this.participants.joined.keys()).forEach(s=>{this.participants.joined.delete(s)}),Array.from(this.participants.active.keys()).forEach(s=>{this.participants.active.delete(s)}),Array.from(this.participants.pinned.keys()).forEach(s=>{this.participants.pinned.delete(s)}),this.participants.currentPage=0,this.participants.viewMode="ACTIVE_GRID",this.participants.emit("viewModeChanged",{viewMode:"ACTIVE_GRID",currentPage:this.participants.currentPage,pageCount:this.participants.pageCount}),this.currentActiveGridParticipants=new Set}),w.on(C.CONSUMER_PAUSED,({id:s})=>{this.processConsumerPaused(s)}),w.on(C.CONSUMER_RESUMED,({id:s})=>{this.processConsumerResumed(s)}),w.on(C.NEW_CONSUMER,({id:s})=>{this.processNewConsumer(s)}),w.on(C.CONSUMER_CLOSED,({id:s})=>{this.processConsumerClosed(s)}),w.on(C.ROOM_MESSAGE,async({payload:s,type:t,timestamp:e})=>{this.participants.emit("broadcastedMessage",{type:t,payload:s,timestamp:e})}),w.on(C.MESSAGE,async({payload:s,type:t,timestamp:e})=>{t!=="spotlight"&&this.participants.emit("broadcastedMessage",{type:t,payload:s,timestamp:e})}),w.on(C.LOW_CONSUMER_SCORE,({peerId:s,score:t,kind:e})=>{const r=this.participants.joined.get(s);r&&(r.emit("poorConnection",{score:t,kind:e}),this.participants.emit("poorConnection",{participantId:s,score:t,kind:e}))}),w.on(C.CONSUMER_SCORE_UPDATE,({score:s,kind:t,appData:e,peerId:r,scoreStats:n})=>{var o;const i=t==="video"&&((o=e==null?void 0:e.screenShare)!=null?o:!1),a=this.participants.joined.get(r);a&&(a.emit("mediaScoreUpdate",{kind:t,isScreenshare:i,score:s,participantId:r,scoreStats:n}),this.participants.emit("mediaScoreUpdate",{kind:t,isScreenshare:i,score:s,participantId:r,scoreStats:n}))}),w.onAsync(C.KICK_PEER,async({peerId:s})=>{const t=this.participants.joined.get(s);await this.roomNodeClient.kick(s),await this.roomSocketHandler.kick(s),t?t.emit("kicked"):this.participants.joined.emit("kicked",{id:s})}),w.on(C.UPDATE_ACTIVE,async({page:s}={})=>{await this.updateActiveLegacy({page:s}),await this.updateActive(s)})}async onParticipantPinned(s){if(!s){this.self.isPinned&&this.self.setIsPinned(!1),this.participants.pinned.size!==0&&this.updatePinnedParticipants();return}if(s===this.self.id){this.participants.pinned.size!==0&&this.updatePinnedParticipants(),this.self.setIsPinned(!0);return}const t=this.participants.joined.get(s);this.self.isPinned&&this.self.setIsPinned(!1),this.updatePinnedParticipants(),t.setIsPinned(!0),this.participants.pinned.add(t)}async onParticipantJoined(s){var t,e,r;this.self.id!==s.id&&!((t=s.flags)!=null&&t.recorder)&&!((e=s.flags)!=null&&e.hidden_participant)&&!((r=s.flags)!=null&&r.hiddenParticipant)&&(this.participants.active.delete(s.id),this.participants.joined.add(s),this.participants.waitlisted.delete(s.id),s.stageStatus==="REQUESTED_TO_JOIN_STAGE"&&w.emit(C.UPDATE_STAGE_REQUESTS,{request:{displayName:s.name,userId:s.userId,peerId:s.id},add:!0})),w.emit(C.PEER_JOINED_INTERNAL,s),!(this.self.config.viewType===Xe.Webinar&&s.stageStatus!=="ON_STAGE")&&(this.roomNodeClient===void 0||this.participants.active.size>=this.roomNodeClient.maxPreferredStreams||(this.updateActiveLegacy({page:this.participants.currentPage}),this.updateActive(this.participants.currentPage)))}async onParticipantLeave(s){const t=this.participants.joined.get(s);this.participants.joined.delete(s,!0,!0),this.participants.pinned.delete(s,!0,!0),this.participants.waitlisted.delete(s,!0,!0),t&&t.stageStatus==="REQUESTED_TO_JOIN_STAGE"&&w.emit(C.UPDATE_STAGE_REQUESTS,{request:{displayName:t.name,userId:t.userId,peerId:t.id},add:!1});const{currentPage:e}=this.participants,r=this.maxPreferredStreams*(e-1),n=this.participants.active.get(s);r===0?this.participants.setViewMode("ACTIVE_GRID"):this.participants.joined.size<=r?e===2?this.participants.setViewMode("ACTIVE_GRID"):this.participants.setPage(e-1):n&&(this.updateActiveLegacy({page:e}),this.updateActive(e))}processMedia(s){var h;const t=this.roomNodeClient.getConsumers(),{peerId:e,kind:r,appData:n,remotelyPaused:i,track:a,producerId:o,rtpReceiver:c}=(h=t.get(s))!=null?h:{};if(!e)return l.warn("processMedia::Peer ID is undefined",{consumer:{id:s,kind:r,peerId:e,appData:{supportsRemoteControl:n==null?void 0:n.supportsRemoteControl,screenShare:n==null?void 0:n.screenShare},remotelyPaused:i,producerId:o}}),{};const u=n;return r==="video"&&u.screenShare!==!0&&this.videoPeerConsumerMap.set(e,s),l.info("ParticipantController::processMedia",{consumer:{id:s,peerId:e,kind:r,appData:u,remotelyPaused:i,producerId:o}}),this.consumerPeerMap.set(s,{type:r,peerId:e,appData:u,remotelyPaused:i,producerId:o}),{peerId:e,kind:r,appData:u,remotelyPaused:i,track:a,producerId:o,rtpReceiver:c}}processConsumerClosed(s){const{peerId:t,type:e,appData:r,remotelyPaused:n,producerId:i}=this.consumerPeerMap.get(s)||{},a=this.participants.joined.get(t);if(l.info("ParticipantController::processConsumerClosed",{consumer:{id:s,peerId:t,appData:r,kind:e,remotelyPaused:n,producerId:i}}),this.consumerPeerMap.delete(s),e==="video"&&r.screenShare!==!0&&this.videoPeerConsumerMap.delete(t),!a)return;const o=[];r&&r.screenShare?(a.setScreenShareEnabled(!1),U.consumerSharedMediaState(s,{screen:!1}),a.screenShareTracks.video&&o.push(a.screenShareTracks.video.id),a.screenShareTracks.audio&&o.push(a.screenShareTracks.audio.id),a.screenShareTracks={audio:void 0,video:void 0}):e==="audio"?(a.setAudioEnabled(!1),a.audioTrack&&o.push(a.audioTrack.id),U.consumerSharedMediaState(s,{audio:!1}),a.audioTrack=void 0):e==="video"&&(a.setVideoEnabled(!1),this.updatePipSource(a.id,!1),a.videoTrack&&o.push(a.videoTrack.id),U.consumerSharedMediaState(s,{video:!1}),a.videoTrack=void 0),r.e2ee&&o.forEach(c=>{w.emit(C.E2EE_INACTIVE_CONSUMER,{peerId:t,trackId:c})})}processConsumerResumed(s){const{peerId:t,kind:e,appData:r,track:n,remotelyPaused:i,producerId:a,rtpReceiver:o}=this.processMedia(s);if(!t)return;l.info("ParticipantController::processConsumerResumed",{consumer:{id:s,peerId:t,kind:e,appData:r,remotelyPaused:i,producerId:a}});const c=this.participants.joined.get(t);if(c){if(r.e2ee&&w.emit(C.E2EE_ACTIVE_CONSUMER,{peerId:t,rtpReceiver:o,track:n}),r.screenShare){e==="video"?c.screenShareTracks.video=n:e==="audio"&&(c.screenShareTracks.audio=n),c.setScreenShareEnabled(!0),U.consumerSharedMediaState(s,{screen:!0});return}e==="video"?(c.videoTrack=n,c.setVideoEnabled(!0),this.updatePipSource(c.id,!0),U.consumerSharedMediaState(s,{video:!0})):e==="audio"&&(c.audioTrack=n,c.setAudioEnabled(c.audioEnabled),U.consumerSharedMediaState(s,{audio:c.audioEnabled}))}}processConsumerPaused(s){l.info(`ParticipantController::processConsumerPaused called for consumerId: ${s}`);const{peerId:t,kind:e,track:r,appData:n,remotelyPaused:i,producerId:a}=this.processMedia(s);if(!t)return;l.info("ParticipantController::processConsumerPaused",{consumer:{id:s,peerId:t,kind:e,appData:n,remotelyPaused:i,producerId:a}});const o=this.participants.joined.get(t);o&&(r&&n.e2ee&&w.emit(C.E2EE_INACTIVE_CONSUMER,{peerId:t,trackId:r.id}),e==="video"?(o.videoTrack=r,o.setVideoEnabled(!1),this.updatePipSource(o.id,!1),U.consumerSharedMediaState(s,{video:!1})):e==="audio"&&(o.audioTrack=r,o.setAudioEnabled(o.audioEnabled),U.consumerSharedMediaState(s,{audio:o.audioEnabled})))}processNewConsumer(s){const{peerId:t,kind:e,remotelyPaused:r,track:n,appData:i,producerId:a,rtpReceiver:o}=this.processMedia(s);if(!t)return;l.info("ParticipantController::processNewConsumer",{consumer:{id:s,peerId:t,kind:e,remotelyPaused:r,appData:i,producerId:a}});const c=this.participants.joined.get(t);if(c){if(i.screenShare){e==="video"?c.screenShareTracks.video=n:e==="audio"&&(c.screenShareTracks.audio=n),(!r||this.self.permissions.isRecorder||j.hasFeature(J.SCREEENSHARE_ERR_HACK))&&c.setScreenShareEnabled(!0),i.supportsRemoteControl&&(c.supportsRemoteControl=!0),this.participants.broadcastMessage("screenshareConsumerCreated",{producerId:a,peerId:t,screenShare:!0,consumerId:s,consumerPeerId:this.self.id}),l.info("ParticipantController::newScreenshareConsumer::screenshareConsumerCreated",{consumer:{id:s,peerId:t,kind:e,remotelyPaused:r,appData:i,producerId:a}});return}e==="video"?(c.videoTrack=n,r||(c.setVideoEnabled(!0),this.updatePipSource(c.id,!0)),U.consumerSharedMediaState(s,{video:!r})):e==="audio"&&(c.audioTrack=n,r||c.setAudioEnabled(!0),U.consumerSharedMediaState(s,{audio:!r})),!r&&i.e2ee&&w.emit(C.E2EE_ACTIVE_CONSUMER,{peerId:t,rtpReceiver:o,track:n})}}static formatSocketServiceMessage(s){var e,r,n,i,a,o;if(!s)return;const t=iu(s.stageType);return{id:s.peerId,userId:s.userId,name:s.displayName,displayName:s.displayName,stageType:t,customParticipantId:s.customParticipantId,presetId:s.presetId,picture:s.displayPictureUrl,waitlisted:s.waitlisted,stageStatus:t,metadata:{preset_name:(e=s.flags)==null?void 0:e.presetName},recorderType:(r=s.flags)==null?void 0:r.recorderType,flags:{hiddenParticipant:(n=s.flags)==null?void 0:n.hiddenParticipant,hidden_participant:(i=s.flags)==null?void 0:i.hiddenParticipant,recorder:((a=s.flags)==null?void 0:a.recorderType)!==void 0&&((o=s.flags)==null?void 0:o.recorderType)!=="NONE"}}}updateConsumerMaps(s,t){const[e,r]=t.video(this.participants.videoSubscribed,s),[n,i]=t.audio(this.participants.audioSubscribed,s),a=(h,p)=>p==="screenshare"?h.filter(({screenShare:f})=>!!f):h.filter(({kind:f})=>f===p),o=(h,p)=>{const f=this.participants.joined.get(h);if(f)return a(f.producers,p)},c=[...r.map(h=>o(h,"video")).flat(),...i.map(h=>o(h,"audio")).flat()].filter(h=>!!h),u=[...e.map(h=>o(h,"video")).flat(),...n.map(h=>o(h,"audio")).flat()].filter(h=>!!h);this.roomNodeClient.closeConsumers(c).catch(h=>l.error("Error deactivating peers",{error:h})),this.roomNodeClient.createConsumers(u).catch(h=>l.error("Error activating peers",{error:h}))}updateActiveParticipants(s,t=!1){if(this.updateParticipantsMapMinReplacement(this.participants.active,s),!this.roomJoined)return;l.info("ParticipantController::updateActiveParticipants::updating_current_selected_peers",{debuggingHint:t?"Forcefully updating currentActiveGridParticipants set":null}),t&&(this.currentActiveGridParticipants=new Set);const e=new Set(s),r=[],n=[];if(this.currentActiveGridParticipants.forEach(o=>{e.has(o)||r.push(o)}),e.forEach(o=>{this.currentActiveGridParticipants.has(o)||n.push(o)}),this.currentActiveGridParticipants=e,n.length===0&&r.length===0)return;let i=[],a=[];r.forEach(o=>{const c=this.participants.joined.get(o);c&&(i=i.concat(c.producers))}),this.roomNodeClient.deactivatePeers(i).then(()=>{n.forEach(o=>{const c=this.participants.active.get(o);if(!c){l.warn("peer is not in active map which is going to activate, should not happen",{dyteParticipant:{id:o}});return}a=a.concat(c.producers)}),this.roomNodeClient.activatePeers(a)}).catch(o=>{l.info("Error on deactivating peers",o)})}async onSelectedPeers(s,t){if(this.participants.viewMode!=="ACTIVE_GRID")return;const e=s.map((n,i)=>({peerId:n,priority:i+1})),r=t==null?void 0:t.map((n,i)=>({peerId:n,priority:-(i+1)}));e.push(...r!=null?r:[]),e.length>0&&this.updateActiveParticipantsWithPriorities(e)}updateActiveParticipantsWithPriorities(s,t=!1){if(!this.roomJoined){l.warn("Skipped::ParticipantController::updateActiveParticipantsWithPriorities",{roomJoined:this.roomJoined});return}let e=null;s.forEach(r=>{this.selectedPeers.add(r.peerId,r.priority),(e===null||r.priority<e.priority)&&(e=r)}),e&&e.peerId!==this.participants.lastActiveSpeaker&&(this.participants.lastActiveSpeaker=e.peerId,this.participants.emit("activeSpeaker",{peerId:e.peerId,volume:e.priority})),t&&this.refreshGridParticipants()}};let jr=Vg;di([g.trace("ParticipantController.setupEvents")],jr.prototype,"setupEventsGlobal",1),di([g.trace("ParticipantController.processMedia")],jr.prototype,"processMedia",1),di([g.trace("ParticipantController.processConsumerClosed")],jr.prototype,"processConsumerClosed",1),di([g.trace("ParticipantController.processConsumerResumed")],jr.prototype,"processConsumerResumed",1),di([g.trace("ParticipantController.processConsumerPaused")],jr.prototype,"processConsumerPaused",1),di([g.trace("ParticipantController.processNewConsumer")],jr.prototype,"processNewConsumer",1);var rO=Object.defineProperty,sO=Object.getOwnPropertyDescriptor,nO=(s,t,e,r)=>{for(var n=r>1?void 0:r?sO(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&rO(t,e,n),n};class Bg extends jr{get roomNodeClient(){return this.context.getValue("roomNodeClient")}constructor(t,e,r){super(t,e,r),this.setupEvents()}setupEvents(){this.roomSocketHandler.on(V.getWaitingRoomRequests,this.waitingRoomRequestHandler.bind(this)),w.on(C.SOCKET_PEERS,async t=>{t==null||t.forEach(e=>this.onParticipantJoined(this.fromSocketService(e)))}),this.roomSocketHandler.on(ne.peerJoinedBroadcast,({participant:t})=>this.onMediaJoined(t.peerId,t.producerStates)),this.roomSocketHandler.on(ne.selfJoinComplete,({participants:t,selectedPeers:e,roomState:r})=>{t.forEach(a=>this.onMediaJoined(a.peerId,a.producerStates));const{audioPeers:n,compulsoryPeers:i}=e!=null?e:{};r.pinnedPeerIds.length!==0&&this.onParticipantPinned(r.pinnedPeerIds[0]),this.computeActivateParticipants(n!=null?n:[],i),w.emit(C.REFRESH_GRID,!0)}),w.on(C.MAX_SPATIAL_LAYER_CHANGE,({peerId:t,maxSpatialLayer:e})=>{const r=this.videoPeerConsumerMap.get(t);r&&(this.maxSpatialLayerUpdates.set(r,e),this.updateConsumerSpatialLayers())}),w.on(C.REFRESH_GRID,(t=!1)=>{this.participants.viewMode==="ACTIVE_GRID"&&Sr(()=>{this.refreshGridParticipants(t)},500,{maxWait:1e3,leading:!0})()}),w.on(C.NEW_PRODUCER,({peerId:t,producer:e})=>{const r=this.participants.joined.get(t);if(!r){l.warn("ParticipantController::NEW_PRODUCER::participant not found",{producer:{id:e==null?void 0:e.producerId,kind:e==null?void 0:e.kind,status:"UNKNOWN",appData:{screenShare:e==null?void 0:e.screenShare}},dyteParticipant:{id:t}});return}r.producers.push(e),l.info("ParticipantController::NEW_PRODUCER::producer_added_to_participant",{producer:{id:e==null?void 0:e.producerId,peerId:t,kind:e==null?void 0:e.kind,status:"UNKNOWN",appData:{screenShare:e==null?void 0:e.screenShare}}}),(e==null?void 0:e.kind)==="audio"||e!=null&&e.screenShare||this.currentActiveGridParticipants.has(t)?this.roomNodeClient.createConsumers([e]).catch(n=>{l.error("ParticipantController::createConsumer failed",{error:n})}):l.info("ParticipantController::NEW_PRODUCER::not_consuming_producer",{producer:{id:e==null?void 0:e.producerId,peerId:t,kind:e==null?void 0:e.kind,status:"UNKNOWN",appData:{screenShare:e==null?void 0:e.screenShare}}})}),w.on(C.PRODUCER_CLOSED,({peerId:t,producerId:e})=>{const r=this.participants.joined.get(t);if(!r){l.warn("ParticipantController::NEW_PRODUCER::participant not found",{dyteParticipant:{id:t}});return}r.producers=r.producers.filter(n=>n.producerId!==e)}),w.on(C.PRODUCER_TOGGLE,({peerId:t,producerId:e,paused:r,kind:n})=>{const i=this.participants.joined.get(t);if(i){n==="audio"&&i.setAudioEnabled(!r);const a=i.producers.find(o=>o.producerId===e);a&&(a.pause=r)}}),this.roomSocketHandler.on(ne.globalPeerPinBroadcast,({participantId:t})=>{if(!this.roomJoined)return;const e=t;this.onParticipantPinned(e);const r=this.participants.joined.get(e);this.roomNodeClient.activatePeers(r.producers).catch(n=>{l.error("unable to create consumers",{error:n})})}),this.roomSocketHandler.on(ne.selectedPeer,({audioPeers:t,compulsoryPeers:e})=>{this.roomJoined&&this.onSelectedPeers(e.concat(t))}),this.roomSocketHandler.on(ne.selectedPeerDiff,({entries:t})=>{if(!this.roomJoined||this.participants.viewMode!=="ACTIVE_GRID")return;const e=t.map(r=>({peerId:r.peerId,priority:r.priority}));this.updateActiveParticipantsWithPriorities(e,!0)})}}nO([g.trace("ParticipantController.setupEvents")],Bg.prototype,"setupEvents",1);var iO=Object.defineProperty,aO=Object.getOwnPropertyDescriptor,oO=(s,t,e,r)=>{for(var n=r>1?void 0:r?aO(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&iO(t,e,n),n};class Hg extends jr{get roomNodeClient(){return this.context.getValue("roomNodeClient")}constructor(t,e,r){super(t,e,r),this.setupEvents()}setupEvents(){this.roomSocketHandler.on(V.getWaitingRoomRequests,this.waitingRoomRequestHandler.bind(this)),w.on(C.SOCKET_PEERS,async t=>{const e=j.hasFeature(J.DEBUG_SOCKET_JOIN);if(e){const r=t&&(t==null?void 0:t.length)<20?{peers:JSON.stringify(t.map(n=>n.peerId))}:void 0;l.info("Processing socket peers",r)}t==null||t.forEach(r=>{r.waitlisted||this.onParticipantJoined(this.fromSocketService(r))}),e&&l.info("Processed socket peers")}),this.roomSocketHandler.on(se.peerJoinedBroadcast,({participant:t})=>{j.hasFeature(J.DEBUG_SOCKET_JOIN)&&l.info("mediaEvents.peerJoinedBroadcast",{peers:t.peerId}),this.onMediaJoined(t.peerId,t.producerStates)}),this.roomSocketHandler.on(se.selfJoinComplete,({participants:t,selectedPeers:e,roomState:r})=>{if(j.hasFeature(J.DEBUG_SOCKET_JOIN)){const a=t&&(t==null?void 0:t.length)<20?{peers:JSON.stringify(t.map(o=>o.peerId))}:void 0;l.info("mediaEvents.selfJoinComplete",a)}t.forEach(a=>this.onMediaJoined(a.peerId,a.producerStates));const{audioPeers:n,compulsoryPeers:i}=e!=null?e:{};r.pinnedPeerIds.length!==0&&this.onParticipantPinned(r.pinnedPeerIds[0]),this.computeActivateParticipants(n!=null?n:[],i),w.emit(C.REFRESH_GRID,!0)}),w.on(C.MAX_SPATIAL_LAYER_CHANGE,({peerId:t,maxSpatialLayer:e})=>{const r=this.videoPeerConsumerMap.get(t);r&&(this.maxSpatialLayerUpdates.set(r,e),this.updateConsumerSpatialLayers())}),w.on(C.REFRESH_GRID,(t=!1)=>{this.participants.viewMode==="ACTIVE_GRID"&&(this.refreshGridParticipants(t),this.updateActive())}),w.on(C.NEW_PRODUCER,({peerId:t,producer:e})=>{const r=this.participants.joined.get(t);if(!r){l.warn("ParticipantController::NEW_PRODUCER::participant not found",{producer:{id:e==null?void 0:e.producerId,kind:e==null?void 0:e.kind,status:"UNKNOWN",appData:{screenShare:e==null?void 0:e.screenShare}},dyteParticipant:{id:t}});return}if(r.producers.push(e),l.info("ParticipantController::NEW_PRODUCER::producer_added_to_participant",{producer:{id:e==null?void 0:e.producerId,peerId:t,kind:e==null?void 0:e.kind,status:"UNKNOWN",appData:{screenShare:e==null?void 0:e.screenShare}}}),this.participants.viewMode==="MANUAL"){let n=!1;const i=e.kind==="audio",a=e.kind==="video",o=r.manualProducerConfig;(i&&(o.audio&&!e.screenShare||o.screenshareAudio&&e.screenShare)||a&&(o.video&&!e.screenShare||o.screenshareVideo&&e.screenShare))&&(n=!0),n?this.roomNodeClient.createConsumers([e]):l.info("ParticipantController::NEW_PRODUCER::not_consuming_producer",{producer:{id:e==null?void 0:e.producerId,peerId:t,kind:e==null?void 0:e.kind,status:"UNKNOWN",appData:{screenShare:e==null?void 0:e.screenShare}}});return}(e==null?void 0:e.kind)==="audio"||e!=null&&e.screenShare||this.currentActiveGridParticipants.has(t)?this.roomNodeClient.createConsumers([e]).catch(n=>{l.error("ParticipantController::createConsumer failed",{error:n})}):l.info("ParticipantController::NEW_PRODUCER::not_consuming_producer",{producer:{id:e==null?void 0:e.producerId,peerId:t,kind:e==null?void 0:e.kind,status:"UNKNOWN",appData:{screenShare:e==null?void 0:e.screenShare}}})}),w.on(C.PRODUCER_CLOSED,({peerId:t,producerId:e})=>{const r=this.participants.joined.get(t);if(!r){l.warn("ParticipantController::PRODUCER_CLOSED::participant not found",{dyteParticipant:{id:t}});return}r.producers=r.producers.filter(n=>n.producerId!==e)}),w.on(C.PRODUCER_TOGGLE,({peerId:t,producerId:e,paused:r,kind:n})=>{const i=this.participants.joined.get(t);if(i){n==="audio"&&i.setAudioEnabled(!r);const a=i.producers.find(o=>o.producerId===e);a&&(a.pause=r)}}),this.roomSocketHandler.on(se.globalPeerPinBroadcast,t=>{let e;if(t&&(e=t.participantId),!this.roomJoined)return;const r=e;this.onParticipantPinned(r);const n=this.participants.joined.get(r);n&&this.roomNodeClient.activatePeers(n.producers).catch(i=>{l.error("unable to create consumers",{error:i})})}),this.roomSocketHandler.on(se.selectedPeer,({audioPeers:t,compulsoryPeers:e})=>{this.roomJoined&&this.onSelectedPeers(e.concat(t))}),this.roomSocketHandler.on(se.selectedPeerDiff,({entries:t})=>{if(!this.roomJoined||this.participants.viewMode!=="ACTIVE_GRID")return;const e=t.map(r=>({peerId:r.peerId,priority:r.priority}));this.updateActiveParticipantsWithPriorities(e,!0)})}}oO([g.trace("ParticipantController.setupEvents")],Hg.prototype,"setupEvents",1);const be=wr(wl().permissions),qi=class extends Ht{constructor(e,r,n,i=!1){super();S(this,Rt);S(this,q,void 0);S(this,Bi,void 0);S(this,Hi,void 0);S(this,bd,e=>{var u,h,p;const{chat:r,connectedMeetings:n,plugins:i,polls:a,media:o,...c}=e;if(r&&(r.private&&ls(d(this,q).chat.private,r.private),r.public&&ls(d(this,q).chat.public,r.public),this.emit("chatUpdate")),n&&ls(d(this,q).connectedMeetings,n),o){const f=y=>{switch(y){case ps.NONE:return H.Allowed;case ps.ALLOWED:return H.Allowed;case ps.NOT_ALLOWED:return H.NotAllowed;case ps.CAN_REQUEST:return H.CanRequest;default:return}},v={audio:void 0,video:void 0,screenshare:void 0};(u=o.audio)!=null&&u.canProduce&&(v.audio={canProduce:f(o.audio.canProduce)}),(h=o.video)!=null&&h.canProduce&&(v.video={canProduce:f(o.video.canProduce)}),(p=o.screenshare)!=null&&p.canProduce&&(v.screenshare={canProduce:f(o.screenshare.canProduce)}),ls(d(this,q).media,v)}i&&(ls(d(this,q).plugins,i),this.emit("pluginsUpdate")),a&&(ls(d(this,q).polls,a),this.emit("pollsUpdate")),Object.keys(c).length!==0&&ls(d(this,q),c),this.emit("permissionsUpdate",e)});if(!r)throw l.error("DytePermissionsPreset::load_preset_permissions_failed"),new b("Could not load preset permissions.");T(this,Hi,e),T(this,Bi,n),T(this,q,r),i&&this.setupEvents()}setupEvents(){w.on(C.UPDATE_PERMISSIONS,d(this,bd))}static fromResponse(e,r,n){return new qi(n,e,r,!0)}static default(e,r){return new qi(e,be,r)}static init(e,r,n){let i;return n?i=new qi(e,n,r,!0):i=new qi(e,be,r),i}get mediaRoomType(){const{sfu:e}=d(this,Hi).getValue("roomNodeOptions");return e===ci.CF?"CF":"HIVE"}get stageEnabled(){var e;return((e=d(this,q))==null?void 0:e.stageEnabled)||d(this,Bi)===Xe.Webinar||d(this,Bi)===Xe.Livestream}get acceptStageRequests(){var e,r;return this.stageEnabled?((e=d(this,q))==null?void 0:e.acceptStageRequests)||((r=d(this,q))==null?void 0:r.canAcceptProductionRequests):!1}get stageAccess(){var e,r,n;return((e=d(this,q))==null?void 0:e.stageAccess)===H.NotAllowed?H.NotAllowed:((r=d(this,q))==null?void 0:r.stageAccess)===H.CanRequest?H.CanRequest:((n=d(this,q))==null?void 0:n.stageAccess)===H.Allowed||d(this,q).media.audio.canProduce===H.Allowed||d(this,q).media.video.canProduce===H.Allowed||d(this,q).media.screenshare.canProduce===H.Allowed?H.Allowed:d(this,q).media.audio.canProduce===H.CanRequest||d(this,q).media.video.canProduce===H.CanRequest||d(this,q).media.screenshare.canProduce===H.CanRequest?H.CanRequest:H.NotAllowed}get acceptWaitingRequests(){var e,r;return(r=(e=d(this,q))==null?void 0:e.acceptWaitingRequests)!=null?r:be.acceptWaitingRequests}get requestProduceVideo(){var e,r,n;return((n=(r=(e=d(this,q))==null?void 0:e.media)==null?void 0:r.video)==null?void 0:n.canProduce)===H.CanRequest}get requestProduceAudio(){var e,r,n;return((n=(r=(e=d(this,q))==null?void 0:e.media)==null?void 0:r.audio)==null?void 0:n.canProduce)===H.CanRequest}get requestProduceScreenshare(){var e,r,n;return((n=(r=(e=d(this,q))==null?void 0:e.media)==null?void 0:r.screenshare)==null?void 0:n.canProduce)===H.CanRequest}get canAllowParticipantAudio(){var e,r;return(r=(e=d(this,q))==null?void 0:e.disableParticipantAudio)!=null?r:be.disableParticipantAudio}get canAllowParticipantScreensharing(){var e,r;return(r=(e=d(this,q))==null?void 0:e.canAcceptProductionRequests)!=null?r:be.canAcceptProductionRequests}get canAllowParticipantVideo(){var e,r;return(r=(e=d(this,q))==null?void 0:e.disableParticipantVideo)!=null?r:be.disableParticipantVideo}get canDisableParticipantAudio(){return this.canAllowParticipantAudio}get canDisableParticipantVideo(){return this.canAllowParticipantVideo}get kickParticipant(){var e,r;return(r=(e=d(this,q))==null?void 0:e.kickParticipant)!=null?r:be.kickParticipant}get pinParticipant(){var e,r;return(r=(e=d(this,q))==null?void 0:e.pinParticipant)!=null?r:be.pinParticipant}get canRecord(){var e,r;return(r=(e=d(this,q))==null?void 0:e.canRecord)!=null?r:be.canRecord}get waitingRoomType(){var e,r;return(r=(e=d(this,q))==null?void 0:e.waitingRoomType)!=null?r:be.waitingRoomType}get waitingRoomBehaviour(){var e,r;return(r=(e=d(this,q))==null?void 0:e.waitingRoomType)!=null?r:be.waitingRoomType}get plugins(){var e,r;return(r=(e=d(this,q))==null?void 0:e.plugins)!=null?r:be.plugins}get polls(){var e,r;return(r=(e=d(this,q))==null?void 0:e.polls)!=null?r:be.polls}get produceVideo(){return this.canProduceVideo}get requestProduce(){return d(this,q).media.audio.canProduce===H.CanRequest||d(this,q).media.video.canProduce===H.CanRequest||d(this,q).media.screenshare.canProduce===H.CanRequest}get canProduceVideo(){var r;const e=(r=d(this,q).media.video.canProduce)!=null?r:be.media.video.canProduce;return this.stageEnabled&&(d(this,Rt,Kt)==="ACCEPTED_TO_JOIN_STAGE"||d(this,Rt,Kt)==="ON_STAGE")&&e===H.CanRequest?H.Allowed:this.stageEnabled&&(d(this,Rt,Kt)==="OFF_STAGE"||d(this,Rt,Kt)==="REQUESTED_TO_JOIN_STAGE")&&e===H.Allowed?H.NotAllowed:e}get produceScreenshare(){return this.canProduceScreenshare}get canProduceScreenshare(){var r;const e=(r=d(this,q).media.screenshare.canProduce)!=null?r:be.media.screenshare.canProduce;return this.stageEnabled&&(d(this,Rt,Kt)==="ACCEPTED_TO_JOIN_STAGE"||d(this,Rt,Kt)==="ON_STAGE")&&e===H.CanRequest?H.Allowed:this.stageEnabled&&(d(this,Rt,Kt)==="OFF_STAGE"||d(this,Rt,Kt)==="REQUESTED_TO_JOIN_STAGE")&&e===H.Allowed?H.NotAllowed:e}get produceAudio(){return this.canProduceAudio}get canProduceAudio(){var r;const e=(r=d(this,q).media.audio.canProduce)!=null?r:be.media.audio.canProduce;return this.stageEnabled&&(d(this,Rt,Kt)==="ACCEPTED_TO_JOIN_STAGE"||d(this,Rt,Kt)==="ON_STAGE")&&e===H.CanRequest?H.Allowed:this.stageEnabled&&(d(this,Rt,Kt)==="OFF_STAGE"||d(this,Rt,Kt)==="REQUESTED_TO_JOIN_STAGE")&&e===H.Allowed?H.NotAllowed:e}get chatPublic(){var e,r,n;return(n=(r=(e=d(this,q))==null?void 0:e.chat)==null?void 0:r.public)!=null?n:be.chat.public}get chatPrivate(){var e,r,n;return(n=(r=(e=d(this,q))==null?void 0:e.chat)==null?void 0:r.private)!=null?n:be.chat.private}get chatChannel(){var e,r,n;return(n=(r=(e=d(this,q))==null?void 0:e.chat)==null?void 0:r.channel)!=null?n:be.chat.channel}get chatMessage(){var e,r,n;return(n=(r=(e=d(this,q))==null?void 0:e.chat)==null?void 0:r.message)!=null?n:be.chat.message}get connectedMeetings(){var e,r;return(r=(e=d(this,q))==null?void 0:e.connectedMeetings)!=null?r:be==null?void 0:be.connectedMeetings}get hiddenParticipant(){var e,r;return(r=(e=d(this,q))==null?void 0:e.hiddenParticipant)!=null?r:be.hiddenParticipant}get showParticipantList(){var e;return(e=d(this,q).showParticipantList)!=null?e:be.showParticipantList}get canChangeParticipantRole(){var e,r;return(r=(e=d(this,q))==null?void 0:e.canChangeParticipantPermissions)!=null?r:be.canChangeParticipantPermissions}get canChangeParticipantPermissions(){var e,r;return(r=(e=d(this,q))==null?void 0:e.canChangeParticipantPermissions)!=null?r:be.canChangeParticipantPermissions}get canChangeTheme(){return!1}get canPresent(){return d(this,q).media.audio.canProduce===H.Allowed||d(this,q).media.video.canProduce===H.Allowed||d(this,q).media.screenshare.canProduce===H.Allowed}get acceptPresentRequests(){return this.acceptStageRequests}get canEditDisplayName(){var e;return(e=d(this,q).canEditDisplayName)!=null?e:!1}get maxScreenShareCount(){return 1}get isRecorder(){return d(this,q).isRecorder}get canSpotlight(){return d(this,q).canSpotlight}get canLivestream(){return d(this,q).canLivestream}get transcriptionEnabled(){return d(this,q).transcriptionEnabled}};let Ru=qi;q=new WeakMap,Bi=new WeakMap,Hi=new WeakMap,bd=new WeakMap,Rt=new WeakSet,Kt=function(){return d(this,Hi).getValue("stageStatus")};class cO extends Ht{constructor(){super(...arguments);m(this,"localMediaHandler");S(this,Vu,void 0)}async updatePermission(){var c,u;const e=(h,p)=>{this.mediaPermissions[h]=p;const f={message:this.mediaPermissions[h],kind:h};p==="DENIED"?w.emit(C.MEDIA_PERMISSION_ERROR,f):w.emit(C.MEDIA_PERMISSION_UPDATE,f)};if(we.getName()==="firefox")return;const r="microphone",n="camera",i=await((c=navigator==null?void 0:navigator.permissions)==null?void 0:c.query({name:r})),a=await((u=navigator==null?void 0:navigator.permissions)==null?void 0:u.query({name:n})),o=(h,p)=>{switch(p){case"granted":e(h,"ACCEPTED");break;case"denied":e(h,"DENIED");break;case"prompt":e(h,"NOT_REQUESTED");break}this.localMediaHandler.repopulateAvailableDevices()};i&&(i.onchange=()=>o("audio",i.state)),a&&(a.onchange=()=>o("video",a.state))}async populateMediaPermissionsInCallstats({message:e,kind:r}){U.onSafeInitialization(()=>{switch(r){case"audio":{U.mediaPermission("AUDIO",e),U.mediaPermission("SPEAKER",e);break}case"video":{U.mediaPermission("VIDEO",e);break}case"screenshare":{U.mediaPermission("SCREENSHARE",e);break}}})}async init(e={},r=!1,n=null){var i,a,o,c,u;if(we.init(),!this.localMediaHandler)try{let h=!0;if(n!=null&&n.getValue("defaults").mediaHandler)h=!1,this.localMediaHandler=n.getValue("defaults").mediaHandler.localMediaHandler;else if(navigator.RNLocalMediaHandlerImpl){const{RNLocalMediaHandlerImpl:p}=navigator;this.localMediaHandler=await p.init()}else this.localMediaHandler=new Nt(n,e.constraints,(i=n==null?void 0:n.getValue("defaults"))==null?void 0:i.isNonPreferredDevice,(a=n==null?void 0:n.getValue("defaults"))==null?void 0:a.autoSwitchAudioDevice);if(w.on(C.MEDIA_PERMISSION_UPDATE,async p=>{if(this.populateMediaPermissionsInCallstats({message:p.message,kind:p.kind}),p.message==="NOT_REQUESTED")switch(p==null?void 0:p.kind){case"audio":this.rawAudioTrack&&(l.info("Disabling audio due to media permission update"),this.disableAudio());break;case"video":this.rawVideoTrack&&(l.info("Disabling video due to media permission update"),this.disableVideo());break;default:break}this.emit("mediaPermissionUpdate",p)}),w.on(C.MEDIA_PERMISSION_ERROR,async p=>{const{kind:f,message:v,constraints:y}=p;this.populateMediaPermissionsInCallstats({message:v,kind:f}),f==="audio"?(l.info(`Disabling audio due to media permission error  skipping: ${this.localMediaHandler.audioUpdateInProgress}`),this.localMediaHandler.audioUpdateInProgress===!1&&this.disableAudio()):f==="video"&&(l.info(`Disabling video due to media permission error skipping: ${this.localMediaHandler.videoUpdateInProgress}`),this.localMediaHandler.videoUpdateInProgress===!1&&this.disableVideo()),l.error("SelfController::mediaPermissionError",{error:{message:v},constraints:y,mediaPermissionsErrors:{kind:f,message:v}}),this.emit("mediaPermissionError",p),this.emit("mediaPermissionUpdate",{message:v,kind:f})}),h){l.info(`Setting up DyteSelfMedia streams using media handler. audio:${!!(e!=null&&e.audio)} video:${(o=e==null?void 0:e.video)!=null?o:!0}`);const p=this.localMediaHandler.setupStreams({video:(c=e==null?void 0:e.video)!=null?c:!0,audio:(u=e==null?void 0:e.audio)!=null?u:!0});r||await p}}catch(h){l.error("DyteSelf::init::Failed To Setup Streams",{error:{name:h.name,message:h.message}})}}get audioTrack(){return this.localMediaHandler.audioTrack}get rawAudioTrack(){return this.localMediaHandler.rawAudioTrack}get mediaPermissions(){return this.localMediaHandler.permissions}async addAudioMiddleware(e){return this.localMediaHandler.addAudioMiddleware(e)}async removeAudioMiddleware(e){return this.localMediaHandler.removeAudioMiddleware(e)}get videoTrack(){return this.localMediaHandler.videoTrack}get rawVideoTrack(){return this.localMediaHandler.rawVideoTrack}async addVideoMiddleware(e){return this.localMediaHandler.addVideoMiddleware(e)}async setVideoMiddlewareGlobalConfig(e={disablePerFrameCanvasRendering:!1}){return this.localMediaHandler.setVideoMiddlewareGlobalConfig(e)}async removeVideoMiddleware(e){return this.localMediaHandler.removeVideoMiddleware(e)}get screenShareTracks(){return this.localMediaHandler.screenShareTracks}get audioEnabled(){return this.localMediaHandler.audioEnabled}get videoEnabled(){return this.localMediaHandler.videoEnabled}get screenShareEnabled(){return this.localMediaHandler.screenShareEnabled}async enableAudio(){await this.localMediaHandler.enableAudio(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}async enableVideo(){await this.localMediaHandler.enableVideo(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}async disableAudio(){this.localMediaHandler.disableAudio(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}async enableScreenShare(){await this.localMediaHandler.enableScreenShare(),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}async disableScreenShare(){await this.localMediaHandler.disableScreenShare(),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}async disableVideo(){await this.localMediaHandler.disableVideo(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}getCurrentDevices(){return this.localMediaHandler.getCurrentDevices()}async getAudioDevices(){return await this.localMediaHandler.getAudioDevices()}async getVideoDevices(){return await this.localMediaHandler.getVideoDevices()}async getSpeakerDevices(){return await this.localMediaHandler.getSpeakerDevices()}getDeviceById(e,r){let n;return r==="audio"?n="audioinput":r==="video"?n="videoinput":r==="speaker"&&(n="audiooutput"),this.localMediaHandler.getDeviceById(e,n)}async setDevice(e){switch(e.kind){case"audioinput":try{await this.localMediaHandler.setAudioDevice(e)}catch(r){}finally{this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}break;case"audiooutput":await this.localMediaHandler.setSpeakerDevice(e);break;case"videoinput":try{await this.localMediaHandler.setVideoDevice(e)}catch(r){}finally{this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}break}this.emit("deviceUpdate",{device:e})}}Vu=new WeakMap;const Ea={},vs={executeWithLock({methodName:s,lockName:t,timeout:e}){return(r,n,i)=>{const a=i.value;return i.value=function(...c){if(Ea[t]){const p=new Error(`Unsupported concurrent calls on Dyte method: ${s}.`);throw p.name="UnsupportedConcurrentMethodExecution",l.error("DyteLocker::UnsupportedConcurrentMethodExecution",{error:{stack:p.stack},dyteLocker:{methodName:s,lockName:t}}),p}Ea[t]=!0;const u=setTimeout(()=>delete Ea[t],e),h=a.apply(this,c);return Promise.resolve(h).then(()=>{delete Ea[t],clearTimeout(u)}).catch(()=>{delete Ea[t],clearTimeout(u)}),h},i}}};var dO=Object.defineProperty,lO=Object.getOwnPropertyDescriptor,Lt=(s,t,e,r)=>{for(var n=r>1?void 0:r?lO(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&dO(t,e,n),n};let ht=(Nv=class extends cO{constructor(t,e,r,n,i){var a;super();S(this,Vs);S(this,Ye);S(this,io);m(this,"name");m(this,"picture");m(this,"customParticipantId");m(this,"waitlistStatus");S(this,no,void 0);S(this,xt,void 0);S(this,ji,void 0);m(this,"role");m(this,"userId");m(this,"organizationId");m(this,"supportsRemoteControl",!1);m(this,"device");S(this,$s,void 0);m(this,"presetName");m(this,"roomState","init");S(this,Gi,new Set);S(this,Wi,new Set);T(this,$s,t),this.userId=e.id,this.name=e.name,this.picture=e.picture,this.customParticipantId=(a=e.customParticipantId)!=null?a:e.clientSpecificId,this.waitlistStatus="none",T(this,xt,r),T(this,no,n),T(this,ji,!1),this.organizationId=e.organizationId,this.supportsRemoteControl=we.isElectron(),this.device=we.getDeviceInfo(),this.presetName=i,n.viewType!==Xe.Chat&&this.updatePermission(),this.updateVideo=this.updateVideo.bind(this),le(this,io,Ku).call(this)}get stageStatus(){return d(this,$s).getValue("stageStatus")}get id(){return d(this,$s).getValue("peerId")}static async __init__(t,e,r,n,i,a=!1){var p,f,v,y,P;let o=(f=(p=t.getValue("defaults"))==null?void 0:p.audio)!=null?f:!0,c=(y=(v=t.getValue("defaults"))==null?void 0:v.video)!=null?y:!0;r.canProduceAudio!=="ALLOWED"&&(o=!1),r.canProduceVideo!=="ALLOWED"&&(c=!1);const u=new ht(t,e,r,n,i);if(n.viewType===Xe.Chat)return u;const h=x0(n.mediaConstraints);return ls(h,(P=t.getValue("defaults"))==null?void 0:P.mediaConfiguration),await u.init({audio:o,video:c,constraints:h},a,t),u.setupEvents(),u}setupEvents(){this.on("videoUpdate",le(this,io,Ku)),this.localMediaHandler.on("AUDIO_TRACK_CHANGE",async()=>{if(l.info("DyteSelf::setupEvents::AUDIO_TRACK_CHANGE",{...un(this)}),this.roomJoined&&this.audioEnabled)try{await d(this,Ye,it).shareMic(this.audioTrack)}catch(t){l.error("DyteSelf::setupEvents::Error while sharing mic",{error:t}),this.localMediaHandler.disableAudio()}this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}),this.localMediaHandler.on("VIDEO_TRACK_CHANGE",async()=>{if(l.info("DyteSelf::setupEvents::VIDEO_TRACK_CHANGE",{...un(this)}),this.roomJoined&&this.rawVideoTrack===void 0)l.info("DyteSelf::VIDEO_TRACK_CHANGE::Forcing_disable_video"),this.disableVideo();else if(this.videoEnabled&&this.roomJoined)try{const t=await d(this,Ye,it).shareWebcam(this.videoTrack);t&&t.id!==this.videoTrack.id&&j.hasFeature(J.EXP_RESHARE)&&await d(this,Ye,it).shareWebcam(this.videoTrack)}catch(t){l.error("DyteSelf::setupEvents::failed shareWebcam",{error:t}),this.videoEnabled&&await this.localMediaHandler.disableVideo()}this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}),this.localMediaHandler.on("DEVICE_CHANGE",async({device:t})=>{this.emit("deviceUpdate",{device:t})}),this.localMediaHandler.on("DEVICE_LIST_UPDATED",t=>{this.emit("deviceListUpdate",t)}),this.localMediaHandler.on("SCREENSHARE_TRACK_CHANGE",async()=>{if(!this.roomJoined){l.error("DyteSelf.SCREENSHARE_TRACK_CHANGE.LocalMediaInitialized_WithoutRoomNode");return}if(this.screenShareEnabled)try{await d(this,Ye,it).shareScreen(this.screenShareTracks)}catch(t){l.error("DyteSelf::setupEvents::Error while sharing screen",{error:t}),this.screenShareEnabled&&await this.localMediaHandler.disableScreenShare()}l.info("DyteSelf::setupEvents::SCREENSHARE_TRACK_CHANGE",{...un(this)}),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}),this.localMediaHandler.on("SCREENSHARE_ENDED",async()=>{l.log("Disabling screenshare due to SCREENSHARE_ENDED"),await this.disableScreenShare(),l.info("DyteSelf::setupEvents::SCREENSHARE_ENDED",{...un(this)})}),this.localMediaHandler.on("AUDIO_TRACK_SILENT",()=>{U.mediaTrackMuted("AUDIO")}),this.localMediaHandler.on("FORCE_MUTE_AUDIO",()=>{this.disableAudio()}),this.localMediaHandler.on("FORCE_MUTE_VIDEO",async()=>{this.roomJoined&&await d(this,Ye,it).pauseWebcam(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),U.videoOff()}),d(this,xt).on("permissionsUpdate",t=>{var e,r,n;(e=t==null?void 0:t.media)!=null&&e.audio&&d(this,xt).canProduceAudio!==H.Allowed&&(this.disableAudio(),l.info(`Disabled audio due to dynamic preset change: canProduceAudio: ${this.permissions.canProduceAudio}`)),(r=t==null?void 0:t.media)!=null&&r.video&&d(this,xt).canProduceVideo!==H.Allowed&&(this.disableVideo(),l.info(`Disabled video due to dynamic preset change: canProduceVideo: ${this.permissions.canProduceVideo}`)),(n=t==null?void 0:t.media)!=null&&n.screenshare&&d(this,xt).canProduceScreenshare!==H.Allowed&&(this.disableScreenShare(),l.info(`Disabled screenshare due to dynamic preset change: canProduceScreenshare: ${this.permissions.canProduceScreenshare}`))})}get permissions(){return d(this,xt)}get config(){return d(this,no)}get roomJoined(){var t;return((t=d(this,Ye,it))==null?void 0:t.roomJoined)===!0}setName(t){if(!t)throw new b("Name cannot be empty.");this.name=t}async setupTracks(t={}){var e,r;return t.forceReset&&(d(this,Ye,it).stopAllProducers(),this.localMediaHandler.removeAllTracks()),this.localMediaHandler.setupStreams({video:(e=t.video)!=null?e:!0,audio:(r=t.audio)!=null?r:!0})}async destructMediaHandler(){return this.localMediaHandler.destruct()}async removeDocumentEventListeners(){return this.localMediaHandler.removeDocumentEventListeners()}async enableAudio(){if(this.permissions.canProduceAudio!==H.NotAllowed&&!(d(this,xt).canProduceAudio===H.CanRequest&&(this.stageStatus==="OFF_STAGE"||this.stageStatus==="REQUESTED_TO_JOIN_STAGE"))&&!this.audioEnabled){if(await this.localMediaHandler.enableAudio(),this.roomJoined&&this.stageStatus==="ON_STAGE"){if(this.audioTrack)try{await d(this,Ye,it).shareMic(this.audioTrack)}catch(t){l.error("DyteSelf::enableAudio::Error while sharing mic",{error:t}),this.localMediaHandler.disableAudio()}if(!this.audioEnabled)return;d(this,Ye,it).unmuteSelf()}this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack}),U.audioOn()}}async enableVideo(){if(d(this,xt).canProduceVideo!==H.NotAllowed&&!(d(this,xt).canProduceVideo===H.CanRequest&&(this.stageStatus==="OFF_STAGE"||this.stageStatus==="REQUESTED_TO_JOIN_STAGE"))&&!this.videoEnabled){if(await this.localMediaHandler.enableVideo(),this.roomJoined&&this.stageStatus==="ON_STAGE")try{await d(this,Ye,it).shareWebcam(this.videoTrack)}catch(t){l.error("DyteSelf::enableVideo::Error while sharing video",{error:t}),this.videoEnabled&&await this.localMediaHandler.disableVideo()}this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),l.info("DyteSelf.enableVideo",{...un(this)}),U.videoOn()}}async updateVideoConstraints(t){if(!this.localMediaHandler.updateVideoConstraints)throw new b("Unsupported");await this.localMediaHandler.updateVideoConstraints(t)}async enableScreenShare(){if(!this.roomJoined)throw new b("Can`t enable screenshare without joining room");if(d(this,xt).canProduceScreenshare!==H.NotAllowed&&!(d(this,xt).canProduceScreenshare===H.CanRequest&&(this.stageStatus==="OFF_STAGE"||this.stageStatus==="REQUESTED_TO_JOIN_STAGE"))&&!this.screenShareEnabled&&(await this.localMediaHandler.enableScreenShare(),this.screenShareTracks.audio||this.screenShareTracks.video)){try{await d(this,Ye,it).shareScreen(this.screenShareTracks)}catch(t){l.error("DyteSelf::enableScreenShare::Error while sharing screen",{error:t}),this.screenShareEnabled&&await this.localMediaHandler.disableScreenShare()}this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}}async updateScreenshareConstraints(t){if(!this.localMediaHandler.updateScreenshareConstraints)throw new b("Unsupported");await this.localMediaHandler.updateScreenshareConstraints(t)}async disableAudio(){this.audioEnabled&&(this.localMediaHandler.disableAudio(),this.roomJoined&&d(this,Ye,it).muteSelf(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack}),U.audioOff())}async disableVideo(){this.videoEnabled&&(await this.localMediaHandler.disableVideo(),this.roomJoined&&await d(this,Ye,it).pauseWebcam(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),U.videoOff())}async disableScreenShare(){this.screenShareEnabled&&(await this.localMediaHandler.disableScreenShare(),this.roomJoined&&await d(this,Ye,it).disableScreenShare(),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks}))}getAllDevices(){return this.localMediaHandler.getAllDevices()}setIsPinned(t,e=!0){var n;T(this,ji,t);const r=t?"pinned":"unpinned";(n=d(this,Vs,ea))==null||n.updateSource(this.id,{pinned:t}),e&&this.emit(r,this)}get isPinned(){return d(this,ji)}async pin(){if(!this.roomJoined)throw new b("Can`t pin participants without joining room");return d(this,Ye,it).pinPeer(this.id)}async unpin(){if(!this.roomJoined)throw new b("Can`t unpin participants without joining room");return d(this,Ye,it).pinPeer(null)}async setDevice(t){var r,n,i;if(!t)throw new b("No device selected");const e=this.getCurrentDevices();if(t.deviceId&&(((r=e==null?void 0:e.audio)==null?void 0:r.deviceId)===t.deviceId||((n=e==null?void 0:e.video)==null?void 0:n.deviceId)===t.deviceId||((i=e==null?void 0:e.speaker)==null?void 0:i.deviceId)===t.deviceId)&&(l.warn("DyteSelf.setDevice.setting_to_in_use_device",{devices:[t]}),j.hasFeature(J.SKIP_SETTING_IN_USE_DEVICE)))throw new b("Cannot set device currently in use");switch(t.kind){case"audioinput":try{await this.localMediaHandler.setAudioDevice(t)}catch(a){this.roomJoined&&await d(this,Ye,it).muteSelf(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}break;case"audiooutput":await this.localMediaHandler.setSpeakerDevice(t);break;case"videoinput":try{await this.localMediaHandler.setVideoDevice(t)}catch(a){this.roomJoined&&await d(this,Ye,it).pauseWebcam(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}break}}cleanUpTracks(){var t,e,r,n;(t=this.audioTrack)==null||t.stop(),(e=this.rawAudioTrack)==null||e.stop(),(r=this.videoTrack)==null||r.stop(),(n=this.rawVideoTrack)==null||n.stop()}registerVideoElement(t,e=!1){var r;e?d(this,Gi).add(t):d(this,Wi).add(t),this.updateVideo(t),e||d(this,Vs,ea).addSource(this.id,t,this.videoEnabled,this.isPinned,this.name,this.picture,(r=this.raised)!=null?r:!1)}deregisterVideoElement(t,e=!1){t.srcObject=void 0,e?d(this,Gi).delete(t):(d(this,Wi).delete(t),d(this,Vs,ea).removeSource(this.id))}updateVideo(t,e=!1){var r,n,i;if(this.videoEnabled){if(this.videoTrack==null)return;const a=(r=t.srcObject)==null?void 0:r.getTracks()[0];if((a==null?void 0:a.id)===this.videoTrack.id)return;const o=new MediaStream;o.addTrack(this.videoTrack),t.srcObject=o,e||(n=d(this,Vs,ea))==null||n.enableSource(this.id)}else t.srcObject=void 0,e||(i=d(this,Vs,ea))==null||i.disableSource(this.id);t.style.display=this.videoEnabled?"block":"none"}},no=new WeakMap,xt=new WeakMap,ji=new WeakMap,$s=new WeakMap,Vs=new WeakSet,ea=function(){return d(this,$s).getValue("pip")},Ye=new WeakSet,it=function(){return d(this,$s).getValue("roomNodeClient")},Gi=new WeakMap,Wi=new WeakMap,io=new WeakSet,Ku=function(){Array.from(d(this,Wi)).forEach(t=>this.updateVideo(t,!1)),Array.from(d(this,Gi)).forEach(t=>this.updateVideo(t,!0))},Nv);Lt([g.trace("DyteSelf.setupEvents")],ht.prototype,"setupEvents",1),Lt([g.trace("DyteSelf.setupTracks")],ht.prototype,"setupTracks",1),Lt([g.trace("DyteSelf.destructMediaHandler")],ht.prototype,"destructMediaHandler",1),Lt([g.trace("DyteSelf.removeDocumentEventListeners")],ht.prototype,"removeDocumentEventListeners",1),Lt([vs.executeWithLock({methodName:"meeting.self.enableAudio",lockName:"DyteSelf.toggleAudio",timeout:3e3}),g.trace("DyteSelf.enableAudio")],ht.prototype,"enableAudio",1),Lt([vs.executeWithLock({methodName:"meeting.self.enableVideo",lockName:"DyteSelf.toggleVideo",timeout:3e3}),g.trace("DyteSelf.enableVideo")],ht.prototype,"enableVideo",1),Lt([g.trace("DyteSelf.updateVideoConstraints")],ht.prototype,"updateVideoConstraints",1),Lt([g.trace("DyteSelf.enableScreenShare"),vs.executeWithLock({methodName:"meeting.self.enableScreenShare",lockName:"DyteSelf.toggleScreenShare",timeout:3e3})],ht.prototype,"enableScreenShare",1),Lt([g.trace("DyteSelf.updateScreenshareConstraints")],ht.prototype,"updateScreenshareConstraints",1),Lt([vs.executeWithLock({methodName:"meeting.self.disableAudio",lockName:"DyteSelf.toggleAudio",timeout:3e3}),g.trace("DyteSelf.disableAudio")],ht.prototype,"disableAudio",1),Lt([vs.executeWithLock({methodName:"meeting.self.disableVideo",lockName:"DyteSelf.toggleVideo",timeout:3e3}),g.trace("DyteSelf.disableVideo")],ht.prototype,"disableVideo",1),Lt([vs.executeWithLock({methodName:"meeting.self.disableScreenShare",lockName:"DyteSelf.toggleScreenShare",timeout:3e3}),g.trace("DyteSelf.disableScreenShare")],ht.prototype,"disableScreenShare",1),Lt([g.trace("DyteSelf.setDevice")],ht.prototype,"setDevice",1),ht=Lt([mt("1100")],ht);class uO extends Dg{constructor(e){super(e);m(this,"sessionDescription");this.sessionDescription=e.sessionDescription}}class hO extends xg{}class pO extends Fg{async retryFailedConsumerCreationTasks(t){return Jc(t.map(async e=>br(async r=>(r>0&&l.warn(`retrying failed consumer creation task: ${JSON.stringify(e)}`),this.consumerCreationTask({...e})))))}async consumerCreationTask({consumerId:t,producerId:e,producingPeerId:r,producingTransportId:n,streamId:i,trackId:a,paused:o,screenShare:c,appData:u,kind:h,sessionDescription:p}){const f=`${i}:${h}`,v={consumerId:t,producerId:e,producingPeerId:r,producingTransportId:n,streamId:i,trackId:a,sessionDescription:p,appData:u,kind:h,paused:o,screenShare:c,name:"consumer creation task error",message:"consumer creation failed"};return new Promise(async(P,k)=>{const I=setTimeout(()=>{this.consumerTrackEvents.delete(f),v.isTimedout=!0,k(v)},5e3),x=(K,X)=>{try{if(K.readyState==="ended")clearTimeout(I),k(v);else{const oe=K;oe.enabled=!0,this.handler.midTransceiverMap.set(X.mid,X);const Te=new uO({id:t,localId:X.mid,track:oe,paused:o,producerId:e,producingPeerId:r,handler:this.handler,appData:{...u,screenShare:c,peerId:r},reuseTrack:!0,rtpReceiver:X.receiver,producingTransportId:n,sessionDescription:p});this.consumers.set(t,Te),Te.once("close",()=>{this.consumers.delete(Te.id),this.handler.midTransceiverMap.delete(X.mid)}),l.info("consumer created for ",{consumer:{id:t,kind:h,appData:{screenShare:c},peerId:r,producerId:e}}),this.observer.emit("newconsumer",Te),clearTimeout(I),P(Te)}}catch(oe){l.warn("error while creating consumer:",oe),clearTimeout(I),k(v)}},$=this.consumerTrackPool.get(t);if(($==null?void 0:$.length)===2){x($[0],$[1]);return}const O=this.unknownTracksMap.get(f);O?(this.unknownTracksMap.delete(f),x(O.track,O.transceiver)):this.consumerTrackEvents.set(f,x),p&&await this.safeEmitAsPromise("negotiate",{description:p})})}async connect(){try{const{offerSdp:t,callback:e}=await this.handler.connect(),{answer:r}=await this.safeEmitAsPromise("connect",{offer:t});if(await e(r),!await this.isConnected)throw new Error("ice connection failed")}catch(t){throw l.error("transport failed to connect:",t),t}}_ontrack(t){const{track:e,transceiver:r}=t;l.info(`track event received [trackId: ${e.id}]`);const n=`${r.mid}:${e.kind}`;e.addEventListener("ended",()=>{l.info(`rtc consumer track ended [trackId: ${e.id}]`),this.consumerTrackPool.delete(e.id),this.unknownTracksMap.delete(n)}),this.consumerTrackPool.set(e.id,[e,r]);const i=this.consumerTrackEvents.get(n);i?(i(e,r),this.consumerTrackEvents.delete(n)):(l.warn(`track event handler not found ${n}`),this.unknownTracksMap.set(n,t))}async consume(t){if(l.debug(`consume() producers: ${JSON.stringify(t)}`),this.closed)throw new lt("closed");if(this.direction!=="recv")throw new fn("not a receiving Transport");if(this.listenerCount("connect")===0&&this.connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(!await this.isConnected)return Promise.reject(new Error("Transport not connected"));const e=[],r=new Map;return t.forEach(n=>{var a;const i=(a=r.get(n.producingPeerId))!=null?a:[];r.set(n.producingPeerId,i.concat([n]))}),r.forEach(async(n,i)=>{const{consumersMap:a}=await this.safeEmitAsPromise("consume_peer",{producingPeerId:i});a.forEach((o,c)=>{const{consumerId:u,trackId:h,screenShare:p,paused:f,streamId:v,kind:y,appData:P,producingTransportId:k,sessionDescription:I}=o;e.push(this.consumerCreationTask({consumerId:u,trackId:h,streamId:v,kind:y,producerId:c,producingPeerId:i,producingTransportId:k,paused:f,screenShare:p,appData:P,sessionDescription:I}))})}),Jc(e)}async produce({track:t,encodings:e,codecOptions:r,stopTracks:n=!0,disableTrackOnPause:i=!0,zeroRtpOnPause:a=!1,appData:o={}}={}){if(l.debug(`produce() [track:${t.id}]`),t){if(this.direction!=="send")throw new fn("not a sending Transport");if(t.readyState==="ended")throw new lt("track ended");if(this.listenerCount("connect")===0&&this.connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing track");if(!await this.isConnected)return Promise.reject(new Error("Transport not connected"));const{producerId:c,localId:u,rtpSender:h}=await this.awaitQueue.push(async()=>{const{offerSdp:f,callback:v,sender:y,mid:P}=await this.handler.send({track:t,encodings:e,codecOption:r,screenShare:o==null?void 0:o.screenShare}),{answer:k,producerId:I}=await this.safeEmitAsPromise("produce",{offer:f,kind:t.kind,paused:i?!t.enabled:!1,appData:{...o||{},mid:P}}),x=await v(k);return{producerId:I,localId:x,rtpSender:y}},"producer"),p=new hO({id:c,localId:u,track:t,stopTracks:n,disableTrackOnPause:i,zeroRtpOnPause:a,appData:o,handler:this.handler,rtpSender:h});return this.producers.set(c,p),p.observer.on("close",()=>{this.producers.delete(p.id)}),this.emit("newproducer",p),this.observer.emit("newproducer",p),p}}class mO extends Ug{createTransport({direction:t,iceServers:e,iceTransportPolicy:r,additionalSettings:n,proprietaryConstraints:i,appData:a,config:o}){const c=Ys(),u=new pO({id:c,direction:t,iceServers:e,iceTransportPolicy:r,additionalSettings:n,proprietaryConstraints:i,appData:a,handlerFactory:this.handlerFactory,config:o});return this._observer.emit("newtransport",u),u}}class fO{constructor(t){S(this,St,void 0);T(this,St,t)}async joinRoom(t,e,r=!1,n=null){const i={roomUuid:t,displayName:e,prejoined:r};return n&&(i.location=n),(await d(this,St).sendMessagePromiseWithTimeout({event:ne.joinRoom,protobuf:Zm.toBinary(i),timeout:5e3})).payload}async connectTransport(t){const e=(await d(this,St).sendMessagePromise(ne.createWebRTCTransport,Jm.toBinary(t))).payload,{transportId:r,description:n}=xl.fromBinary(e),i={sdp:n==null?void 0:n.sdp,type:n.type};return{transportId:r,answer:i}}async produce(t){var i,a;const e=(await d(this,St).sendMessagePromise(ne.produce,sf.toBinary(t))).payload,r=gf.fromBinary(e);return{answer:{sdp:(i=r==null?void 0:r.description)==null?void 0:i.sdp,type:(a=r==null?void 0:r.description)==null?void 0:a.type},producerId:r.producerId}}async consume(t){const e=(await d(this,St).sendMessagePromise(ne.consume,rf.toBinary(t))).payload,{consumerIdsMap:{map:r},description:n}=ff.fromBinary(e);return{consumerStateMap:r,sessionDescription:n}}async closeProducer(t){const e=(await d(this,St).sendMessagePromise(ne.closeProducer,af.toBinary(t))).payload,{description:r}=vf.fromBinary(e);return r}async closeConsumer(t){return(await d(this,St).sendMessagePromise(ne.closeConsumer,of.toBinary(t))).payload}async hostControlForPeer(t,e){const r={audio:e==="audio",screeShare:!1,video:e==="video",participantId:t},n=(await d(this,St).sendMessagePromise(ne.hostControlPeer,lf.toBinary(r))).payload;if(!n)return!1;const{status:i}=_f.fromBinary(n);return i==="success"}async hostControlForAll(t){const e={audio:t==="audio",screenShare:!1,video:t==="video"},r=(await d(this,St).sendMessagePromise(ne.hostControlAllPeers,uf.toBinary(e))).payload;if(!r)return!1;const{status:n}=Sf.fromBinary(r);return n==="success"}async kickAll(){const t={},e=(await d(this,St).sendMessagePromise(ne.kickAll,Ul.toBinary(t))).payload;if(!e)return!1;const{status:r}=Tf.fromBinary(e);return r==="success"}async kickPeer(t){const e=(await d(this,St).sendMessagePromise(ne.kickPeer,cf.toBinary(t))).payload;if(!e)return!1;const{status:r}=yf.fromBinary(e);return r==="success"}async changeDisplayName(t){const e=(await d(this,St).sendMessagePromise(ne.changeDisplayName,df.toBinary(t))).payload;if(!e)return!1;const{status:r}=Ef.fromBinary(e);return r==="success"}async notifySelfJoinComplete(){const t={},e=(await d(this,St).sendMessagePromise(ne.selfJoinComplete,ef.toBinary(t))).payload;return Cc.fromBinary(e)}}St=new WeakMap;const gO=Error("task execution aborted");class vO{constructor(t,e){m(this,"id");m(this,"executor");m(this,"cancel");this.id=t,this.executor=e}async execute(){return new Promise((t,e)=>{this.cancel=()=>e(gO),this.executor.then(r=>t(r))})}}let qg=0;const Qc=new Map;class ku{static execute(t){const e=qg;qg+=1;const r=new vO(e,t);return Qc.set(e,r),{id:e,value:r.execute().finally(()=>Qc.delete(e))}}static stop(t){const e=Qc.get(t);e&&(e.cancel(),Qc.delete(t))}}const yO=2e3;class TO extends Mg{constructor(e,r){super();m(this,"_device");m(this,"_sendTransport");m(this,"_recvTransport");m(this,"_consumers");m(this,"_producers");m(this,"_producerStatus");m(this,"_producerIdToConsumerIdMap");m(this,"_socket");m(this,"_socketHandler");m(this,"_totalTransportReconnectionCount");m(this,"_transportReconnectFailureCount");m(this,"_consumerCreationFailureCount");m(this,"_producerNotReadyFailureCount");m(this,"_consumerNotBoundFailureCount");m(this,"_transportDisconnectedTimer");m(this,"_iceTransportPolicy","all");m(this,"_transportConnectionFailCount",0);m(this,"lastConnectionTime",0);m(this,"transportConnectionStatus");m(this,"transportState");m(this,"transportDisconnected");S(this,ts,void 0);T(this,ts,e),this._device=new mO({}),this._socket=r,this.transportState={consuming:{state:ut.NEW,reconnected:!1},producing:{state:ut.NEW,reconnected:!1}},this.transportDisconnected={consuming:!1,producing:!1},this._socketHandler=new fO(r),this.reset()}get socket(){return this._socket}get producers(){return this._producers}get consumers(){return this._consumers}get producerIdToConsumerIdMap(){return this._producerIdToConsumerIdMap}get cfSocketHandler(){return this._socketHandler}get sendTransport(){return this._sendTransport}get recvTransport(){return this._recvTransport}reset(){this._producers=new Map,this._consumers=new Map,this._producerStatus=new Map,this._producerIdToConsumerIdMap=new Map,this.transportConnectionStatus=new Map,this._transportReconnectFailureCount=0,this._consumerCreationFailureCount=0,this._totalTransportReconnectionCount=0,this._producerNotReadyFailureCount=0,this._consumerNotBoundFailureCount=0,this._transportDisconnectedTimer={consuming:void 0,producing:void 0}}async setupTransports(e,r){const i=await Je().getICEServers().catch(o=>(l.warn(`failed to get iceservers from server: ${o.message}`),[])),a=e.map(o=>{var u,h,p,f,v,y,P,k;const c=this.transportConnectionStatus.get(o);if(c&&!r)return c;switch(c&&r&&ku.stop(c.id),o){case"send":{const I=ku.execute(this.createSendTransport({iceServers:i,additionalSettings:{encodedInsertableStreams:(u=d(this,ts).getValue("modules").e2ee)==null?void 0:u.enabled},config:{enableHighBitrate:(f=(p=(h=d(this,ts).getValue("defaults").mediaConfiguration)==null?void 0:h.audio)==null?void 0:p.enableHighBitrate)!=null?f:!1,enableStereo:(P=(y=(v=d(this,ts).getValue("defaults").mediaConfiguration)==null?void 0:v.audio)==null?void 0:y.enableStereo)!=null?P:!1},iceTransportPolicy:this._iceTransportPolicy}));return this.transportConnectionStatus.set(o,I),I.value}case"recv":{const I=ku.execute(this.createRecvTransport({iceServers:i,additionalSettings:{encodedInsertableStreams:(k=d(this,ts).getValue("modules").e2ee)==null?void 0:k.enabled},iceTransportPolicy:this._iceTransportPolicy}));return this.transportConnectionStatus.set(o,I),I.value}default:return l.warn(`What are you thinking when passing this transportType: ${o}?`,{transport:{type:o}}),Promise.reject(Error("TYPE_OF_TRANSPORT_UNKNOWN"))}});return Promise.all(a).finally(()=>{e.forEach(o=>{this.transportConnectionStatus.delete(o)})})}stopAllTransports(){var e,r,n,i;l.info(" closing all the transports"),(e=this._sendTransport)==null||e.close(),(r=this._sendTransport)==null||r.removeAllListeners(),(n=this._recvTransport)==null||n.close(),(i=this._recvTransport)==null||i.removeAllListeners(),this._sendTransport=void 0,this._recvTransport=void 0,this.reset()}async createSendTransport(e){var n,i,a,o;if(this._sendTransport&&this._sendTransport.connected){l.info("sendTransport::already_exists_in_connected_state",{transport:{id:(n=this._sendTransport)==null?void 0:n.id,serverId:(i=this._sendTransport)==null?void 0:i.serverId,type:"send"}});return}l.info("sendTransport::initializing_transport",{transport:{id:(a=this._sendTransport)==null?void 0:a.id,serverId:(o=this._sendTransport)==null?void 0:o.serverId,type:"send"}});const r=this._device.createSendTransport(e);this._transportDisconnectedTimer.producing=void 0,l.info("sendTransport::initialized_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"send"}}),this.handleTransport(r,!1),l.info("sendTransport::connecting_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"send"}});try{await br(async(c,u)=>{this.socket.isConnected||u(new Error("socket is not connected")),r.connectionState==="closed"&&u(new Error("transport is closed")),c>0&&l.debug(`retrying transport connect, count: ${c}`,{transport:{id:r.id,serverId:r.serverId,type:"send"}});try{await r.connect()}catch(h){throw l.error(`failed to connect send transport: ${r.id}`,{error:h,transport:{id:r.id,serverId:r.serverId,type:"send"}}),h.message==="ice connection failed"&&u(h),h}},{delayTime:100,strategy:"exponential",maxRetryCount:j.hasFeature(J.ENABLE_CF_INFINITE_RETRIES)?1/0:3}),l.info("sendTransport::connected_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"send"}}),this._transportReconnectFailureCount=Math.max(0,this._transportReconnectFailureCount-1),this._producerNotReadyFailureCount=0,this._sendTransport=r,U.onSafeInitialization(()=>{U.configureSendTransport(r)})}catch(c){throw l.error(`failed to connect send transport after retry:${r.id}`,{error:c,transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"send"}}),r.close(),r.removeAllListeners(),this._transportReconnectFailureCount+=1,this.handleFailure(),c}}async createRecvTransport(e){var n,i,a,o,c;if(this._recvTransport&&this._recvTransport.connected){l.info("recvTransport::already_exists_in_connected_state",{transport:{id:(n=this._recvTransport)==null?void 0:n.id,serverId:(i=this._recvTransport)==null?void 0:i.serverId,type:"recv"}});return}l.info("recvTransport::initializing_transport",{transport:{id:(a=this._recvTransport)==null?void 0:a.id,serverId:(o=this._recvTransport)==null?void 0:o.serverId,type:"recv"}});const r=this._device.createRecvTransport({...e,additionalSettings:{...(c=e.additionalSettings)!=null?c:{},rtcAudioJitterBufferMaxPackets:25,rtcAudioJitterBufferFastAccelerate:!0,rtcAudioJitterBufferMinDelayMs:20}});this._transportDisconnectedTimer.consuming=void 0,l.info("recvTransport::initialized_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}}),this.handleTransport(r,!0),l.info("recvTransport::connecting_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}});try{await br(async(u,h)=>{this.socket.isConnected||h(new Error("socket is not connected")),r.connectionState==="closed"&&h(new Error("transport is closed")),u>0&&l.debug(`retrying transport connect, count: ${u}`,{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}});try{await r.connect()}catch(p){throw l.error(`fail to connect recv transport: ${r.id}`,{error:p,transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}}),p.message==="ice connection failed"&&h(p),p}},{delayTime:100,strategy:"exponential",maxRetryCount:j.hasFeature(J.ENABLE_CF_INFINITE_RETRIES)?1/0:3}),l.info("recvTransport::connected_transport",{transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}}),this._transportReconnectFailureCount=Math.max(0,this._transportReconnectFailureCount-1),this._consumerCreationFailureCount=0,this._consumerNotBoundFailureCount=0,this.producerIdToConsumerIdMap.clear(),this._recvTransport=r,U.onSafeInitialization(()=>{U.configureRecvTransport(r)})}catch(u){throw l.error(`failed to connect recv transport after retry:${r.id}`,{error:u,transport:{id:r==null?void 0:r.id,serverId:r==null?void 0:r.serverId,type:"recv"}}),r.close(),r.removeAllListeners(),this._transportReconnectFailureCount+=1,this.handleFailure(),u}}handleTransport(e,r){if(e.on("connect",async({offer:n},i,a)=>{try{const o={consuming:r,description:{sdp:n.sdp,type:n.type,target:r?Bt.SUBSCRIBER:Bt.PUBLISHER}},{transportId:c,answer:u}=await this._socketHandler.connectTransport(o);e.setServerId(c),i({answer:u})}catch(o){l.error(`${r?"consumer":"producer"} transport connection error:`,{error:o,transport:{id:e==null?void 0:e.id,serverId:e==null?void 0:e.serverId,type:r?"recv":"send"}}),a(o)}}),e.on("connectionstatechange",async n=>{this.updateTransportState({state:n,direction:r?"consuming":"producing"}),l.info(`${r?"consumer":"producer"} transport connectionState:`,{transport:{id:e==null?void 0:e.id,serverId:e==null?void 0:e.serverId,type:r?"recv":"send",status:n}});const i=()=>{this._transportDisconnectedTimer[r?"consuming":"producing"]!==void 0&&(clearTimeout(this._transportDisconnectedTimer[r?"consuming":"producing"]),this._transportDisconnectedTimer[r?"consuming":"producing"]=void 0)};switch(n){case"connected":i(),this.lastConnectionTime=performance.now();break;case"disconnected":this._transportDisconnectedTimer[r?"consuming":"producing"]=setTimeout(()=>{this.triggerTransportReconnection(e,r)},yO);break;case"failed":if(e.closed)return;i(),this.triggerTransportReconnection(e,r);break}}),e.on("icecandidate",async n=>{l.debug("sending icecandidate:",{iceCandidate:n})}),e.on("datachannel:events",async(n,i)=>{var a,o;l.debug("got data channel message on event:",{rtcChannel:{label:n,message:i}});try{switch(i.type){case"negotiation":{this.negotiateOverDC(i,zc(i),n,e);break}case"handshake":{const c={type:"handshake",payload:{message:"pong"}};e.sendResponseOverDC(n,zc(i),c);break}case"consumer_toggle":{this.handleConsumerToggle(i.payload);break}case"hub-disconnect":{l.debug(`media hub disconnected, full_reconnect: ${(a=i.payload)==null?void 0:a.full_reconnect}`),((o=i.payload)==null?void 0:o.full_reconnect)===!0&&this.emit("rejoin");break}case"error":{this.handleErrorOverDC(i.payload,e.id);break}default:l.warn(`unknown event received from cf node, event: ${i.type}`);break}}catch(c){l.error(`Unable to handle the incoming datachannel message on channel ${n}`)}}),e.on("dc_error",()=>{e.direction==="recv"&&(l.warn("events datachannel did not open in 5s"),this.handleFailure())}),e.on("negotiate",async({description:n},i,a)=>{try{const o={sdp:n==null?void 0:n.sdp,type:n==null?void 0:n.type},c=await this.negotiate(e,o);i({answer:c})}catch(o){l.error("negotiate error:",{transport:{id:e.id,serverId:e.serverId,type:e.direction},error:o}),a(o)}}),!r){e.on("produce",async({offer:n,kind:i,paused:a,appData:o},c,u)=>{var v;const p=_u(n.sdp).media.filter(y=>i==="video"?y.type==="video":y.type==="audio").at(-1).msid,f={description:{sdp:n.sdp,type:n.type,target:Bt.PUBLISHER},paused:a,kind:i,msid:p,appData:JSON.stringify(o),screenShare:(v=o.screenShare)!=null?v:!1};try{const{answer:y,producerId:P}=await this._socketHandler.produce(f);c({answer:y,producerId:P})}catch(y){l.error("create producer error:",{error:y}),u(y)}});return}e.on("consume_peer",async({producingPeerId:n},i,a)=>{l.info("consumePeer:",n);const o={producingPeerId:n};try{const c=await this._socketHandler.consume(o);l.debug(`consumePeer response for ${n}:`,{consumerStateMap:c.consumerStateMap});const u=new Map;Object.entries(c.consumerStateMap).forEach(([h,p])=>{var v,y,P;let f={};try{f=JSON.parse(p.producerState.appData)}catch(k){}u.set(h,{consumerId:p.consumerId,trackId:(v=p.producerTrack)==null?void 0:v.trackId,streamId:p.producerTrack.streamId,kind:p.producerState.kind===Dt.VIDEO?"video":"audio",appData:f,screenShare:(y=p.producerState)==null?void 0:y.screenShare,paused:(P=p.producerState)==null?void 0:P.pause,sessionDescription:c.sessionDescription,producingPeerId:n})}),i({consumersMap:u})}catch(c){l.error("consumePeer error:",{error:c}),a(c)}}),e.on("consume",async({producerId:n,producingPeerId:i},a,o)=>{var u,h,p,f,v,y,P,k,I;const c={producingPeerId:i,producerId:n};try{const x=await this._socketHandler.consume(c),$=x.consumerStateMap[n];let O={};try{O=JSON.parse((u=$.producerState)==null?void 0:u.appData)}catch(K){}l.info("consumer create response:",{consumer:{remotelyPaused:(h=$.producerState)==null?void 0:h.pause,producerId:(p=$.producerState)==null?void 0:p.producerId,kind:(v=(f=$.producerState)==null?void 0:f.kind)==null?void 0:v.toString(),appData:{...O,screenShare:(y=$.producerState)==null?void 0:y.screenShare},id:$.consumerId,sessionDescription:x.sessionDescription},consumerState:$}),a({consumerId:$.consumerId,screenShare:(P=$.producerState)==null?void 0:P.screenShare,trackId:(k=$.producerTrack)==null?void 0:k.trackId,streamId:$.producerTrack.streamId,kind:$.producerState.kind===Dt.VIDEO?"video":"audio",paused:(I=$.producerState)==null?void 0:I.pause,appData:O,sessionDescription:x.sessionDescription})}catch(x){l.error("error during consuming on server:",x),o(x)}})}async createProducer(e,r,n){var a;if(this._sendTransport===void 0||this._sendTransport.closed)return null;l.info("createProducer::initializing_producer",{producer:{id:"TO_BE_CREATED",kind:e,status:"initializing",appData:r==null?void 0:r.appData}});const i=this._producerStatus.get(e);if((i==null?void 0:i.trackId)===r.track.id&&(i==null?void 0:i.status)===qr.INITIALIZING)return l.info("createProducer::producer getting initializing",{producer:{id:"GETTING_CREATED",status:"initializing",kind:e,appData:r==null?void 0:r.appData}}),null;this._producerStatus.set(e,{trackId:r.track.id,status:qr.INITIALIZING});try{const o=await this._sendTransport.produce(r);return(a=r.appData)!=null&&a.e2ee&&w.emit(C.E2EE_ACTIVE_PRODUCER,o),l.info("createProducer::initialized_producer",{producer:{id:o==null?void 0:o.id,kind:e,status:"producing",appData:r==null?void 0:r.appData}}),o.on("close",async({offer:c,reason:u},h)=>{l.info("producer::closing",{debuggingHint:u,producer:{id:o==null?void 0:o.id,kind:e,status:"closing",appData:r==null?void 0:r.appData}});const p={producerId:o.id,description:{sdp:c.sdp,type:c.type,target:Bt.PUBLISHER}};try{const f=await this._socketHandler.closeProducer(p),v={sdp:f==null?void 0:f.sdp,type:f==null?void 0:f.type};l.info("producer::closed",{producer:{id:o==null?void 0:o.id,kind:e,status:"closed",appData:r==null?void 0:r.appData}}),h({answer:v})}catch(f){l.error("producer close error",f)}this._producerStatus.delete(e),this._producers.delete(e),n(),this.reconfigureWebcamLayers()}),o.on("trackended",()=>{l.info("producer::trackended",{producer:{id:o==null?void 0:o.id,kind:e,status:"UNKNOWN",appData:o==null?void 0:o.appData}}),[Q.MIC,Q.WEBCAM].includes(e)||n()}),this._producers.set(e,o),this._producerStatus.set(e,{trackId:r.track.id,status:qr.INITIALIZED}),this.reconfigureWebcamLayers(),o.track}catch(o){throw this._producerStatus.set(e,{status:qr.NOT_INITIALIZED,trackId:r.track.id}),l.error("createProducer::transport_initialization_failed",{producer:{id:"FAILED_TO_CREATE",kind:e,status:"failed",appData:r==null?void 0:r.appData,error:o}}),o}}async reconfigureWebcamLayers(){if(!j.hasFeature(J.DISABLE_WEBCAM_LAYERS_ON_SCREENSHARE))return;const e=this.producers.get(Q.WEBCAM);e&&await this._switchProducerSpatialLayer(e,this.producers.get(Q.SCREENSHARE_VIDEO)?0:3)}async _switchProducerSpatialLayer(e,r){try{l.debug("switching layer of webcam producer to:",{media:{video:{layer:r}},producer:{id:e.id,kind:e.kind,appData:e.appData}}),await e.setMaxSpatialLayer(r)}catch(n){l.error("failed to switch spatial layer",{error:n})}}_initConsumer(e){e&&(e.observer.on("close",async r=>{l.debug("consumer closed",{consumer:{closureReason:r,id:e.id,kind:e.kind,appData:e.appData}}),this._consumers.delete(e.id),w.emit(C.CONSUMER_CLOSED,{id:e.id})}),this._consumers.set(e.id,e),this.producerIdToConsumerIdMap.set(e.producerId,e.id),w.emit(C.NEW_CONSUMER,{id:e.id,appData:e.appData,peerId:e.peerId}))}async createConsumers(e){if(this._recvTransport===void 0||this._recvTransport.closed||!this._recvTransport.connected)return;if(e.every(n=>this.getProducer(n.producerId))){l.warn("why are you creating a consumer for local producer?");return}await br(async n=>{n>0&&l.debug(`retrying consume call, retryCount: ${n}`),(await this._recvTransport.consume(e).catch(a=>{throw l.error("failed to consume:",{error:a}),a})).forEach(a=>{a.status==="rejected"?(l.error("consumer creation task is failing",a.reason),this._consumerCreationFailureCount+=1,setTimeout(this.handleFailure.bind(this),0)):this._initConsumer(a.value)})}).catch(n=>{l.error("create consumer failed after retries",{error:n}),this._consumerCreationFailureCount+=1,this.handleFailure()})}async pauseProducer(e){const r=this._producers.get(e);if(!r){l.warn(`producer type: ${e} not found`);return}r.pause(),r.appData.e2ee&&w.emit(C.E2EE_INACTIVE_PRODUCER,r),l.info(`Paused the producer of type: ${r.kind}`,{producer:{id:r.id,kind:r.kind,appData:r.appData}})}async resumeProducer(e){const r=this._producers.get(e);if(!r){l.warn(`producer type: ${e} not found`);return}r.resume(),l.info(`Resumed the producer of type: ${r.kind}`,{producer:{id:r.id,kind:r.kind,appData:r.appData}})}async replaceTrack(e,r){const n=this._producers.get(e);if(!n){l.warn(`producer type: ${e} not found`);return}await n.replaceTrack({track:r}),l.info(`Replaced track for the producer of type: ${n.kind}`,{producer:{id:n.id,kind:n.kind,appData:n.appData,trackId:r.id}})}async removeProducer(e,r){const n=this._producers.get(e);if(!n){l.warn(`producer type: ${e} not found`);return}r&&n.track.stop(),await this.sendTransport.awaitQueue.push(n.close.bind(n),"producer").then(()=>{d(this,ts).getValue("modules").e2ee.enabled&&w.emit(C.E2EE_INACTIVE_PRODUCER,n)}).catch(i=>{l.error("failed to close producer on server",i)})}async pauseConsumer(e){const r=this._consumers.get(e);if(!r){l.warn(`consumer with id: ${e} not found`);return}this.toggleConsumerOverDC(e,!0),l.info(`Paused the consumer of type: ${r.kind}`,{consumer:{id:r.id,kind:r.kind,appData:r.appData}})}async pauseConsumerOverSocket(e){try{const r={consumerId:e.id,pause:!0};await this.socket.sendMessagePromise(ne.toggleConsumer,wc.toBinary(r)),e.pause(),w.emit(C.CONSUMER_PAUSED,{id:e.id}),l.info(`Paused the consumer of type: ${e.kind} over socket`,{consumer:{id:e.id,kind:e.kind,appData:e.appData}})}catch(r){l.error("error on pausing consumer",{error:r,consumer:{id:e.id,kind:e.kind,appData:e.appData}})}}async toggleConsumerOverDC(e,r){const n={type:"consumer_toggle",payload:{consumerId:e,mute:r}},i=this._recvTransport.getDatachannel("events");if(!i){l.warn("recvTransport:: events datachannel not found");return}await i.request(n),l.info(`HiveSFUHandler::consumer toggled, consumerId: ${e}, muted: ${r}`)}async resumeConsumer(e){const r=this._consumers.get(e);if(!r){l.warn(`consumer with id: ${e} not found`);return}if(!r.paused){l.warn(`consumer with id:${e} is not paused so not resuming`);return}try{const n={consumerId:e,pause:!1};await this.socket.sendMessagePromise(ne.toggleConsumer,wc.toBinary(n)),r.resume(),w.emit(C.CONSUMER_RESUMED,{id:r.id}),l.info(`Resumed the consumer of type: ${r.kind}`,{consumer:{id:r.id,kind:r.kind,appData:r.appData}})}catch(n){l.error("error on resuming consumer",n)}}async closeConsumer(e,r){return this.closeConsumers([e],r)}async closeConsumers(e,r=!1){l.info(`Closing consumers: ${JSON.stringify(e)} with force: ${r}`);let n=!0;const i=e.filter(c=>this._consumers.get(c)?!0:(l.warn(`consumer with id: ${c} not found`),!1));if(!i.length)return;const a={consumerIds:i},o=async()=>{var c;return(c=this._recvTransport)==null?void 0:c.awaitQueue.push(async()=>{await this._socketHandler.closeConsumer(a)},"close_consumer").catch(u=>{l.warn("error on closing consumer:",{error:u}),n=r})};r?o():await o(),n&&i.forEach(c=>{const u=this.consumers.get(c);this.producerIdToConsumerIdMap.delete(u.producerId),u.close(r?"force closed":void 0)})}async cleanupConsumers(e){l.debug("cleaning up all consumers");const r=[];this._consumers.forEach(n=>{e?n.peerId===e&&r.push(n.id):r.push(n.id)}),this.closeConsumers(r,!0)}async stopAllProducers(){l.info("stopping all available producers"),this._producers.forEach((e,r)=>{l.debug(`closing producer type: ${r}`,{producer:{id:e==null?void 0:e.id,kind:e.kind,appData:e.appData}}),e.close()})}getProducer(e){return Array.from(this.producers.values()).filter(r=>r.id===e).at(0)}hasProducer(e){return this.getProducer(e)!==void 0}async negotiate(e,r){l.debug(`setting remote offer : ${JSON.stringify(r)} on ${e.direction} transport`,{transport:{id:e.id,serverId:e.serverId,type:e.direction}});const n=await e.setRemoteOffer(r),i={transportId:e.serverId,description:{sdp:n.sdp,type:n.type,target:Bt.SUBSCRIBER}};return l.debug(`sending renegotiate request: ${JSON.stringify(i)} on ${e.direction} transport`,{transport:{id:e.id,serverId:e.serverId,type:e.direction}}),await this.socket.sendMessagePromise(ne.renegotiateSessionDescription,Km.toBinary(i)),l.info("renegotiation done",{transport:{id:e.id,serverId:e.serverId,type:e.direction}}),n}async negotiateOverDC(e,r,n,i){const{sdp:a}=e.payload,o={sdp:a,type:"offer"};try{l.debug(`got offer over dc: ${a} for transport: ${i.id}`);const c=await i.setRemoteOffer(o),u={type:"answer",payload:{type:c.type,sdp:c.sdp}};l.debug(`datachannel answer: ${JSON.stringify(u)}`),i.sendResponseOverDC(n,r,u)}catch(c){l.error("datachannel:events::Error:",c),c.code!=="DC_NOT_FOUND"&&i.sendErrorOverDC(n,r,c)}}handleConsumerToggle(e){const{mute:r,trackId:n}=e;l.info(`consumer toggled for trackId: ${n} muted: ${r}`);const i=this.consumers.get(n);if(!i){l.warn(`consumer with trackId: ${n} not found`);return}i.paused!==r&&(l.debug("consumer state is not same",{consumer:{id:i.id,remotelyPaused:i.paused}}),r?(i.pause(),w.emit(C.CONSUMER_PAUSED,{id:i.id})):(i.resume(),w.emit(C.CONSUMER_RESUMED,{id:i.id})))}async handleErrorOverDC(e,r){l.error(`got error over dc: ${JSON.stringify(e)} for transport: ${r}`);const{type:n,error:i,id:a}=e;if(n==="consumer"){if(i==="bind-fail"){if(this._consumerNotBoundFailureCount>=2){this.handleFailure();return}this._consumerNotBoundFailureCount+=1;const o=this.consumers.get(a);if(!o)return;try{await this.closeConsumer(o.id),await this.createConsumers([{kind:o.kind,pause:o.paused,producerId:o.producerId,producingTransportId:o.producingTransportId,screenShare:o.appData.screenShare,producingPeerId:o.peerId}])}catch(c){l.error("failed to recreate consumer on downtrack bound failure,",{consumer:{id:o.id,producerId:o.producerId,kind:o.kind,appData:o.appData}})}}}else if(n==="producer")if(i==="ready-fail"){if(this._producerNotReadyFailureCount>=2){this.handleFailure();return}this._producerNotReadyFailureCount+=1;const[o]=Array.from(this.producers.entries()).find(c=>c[1].id===a);if(!o)return;await this.removeProducer(o).catch(c=>{l.error("failed to remove ready-fail producer:",{error:c,producer:{id:a,kind:o,appData:null}})})}else i==="general-failure"&&(this.updateTransportState({state:ut.RECONNECTING,direction:"producing"}),this.emit("reconnect_transport",this._sendTransport))}async handleFailure(){if(this._transportReconnectFailureCount>0||this._totalTransportReconnectionCount>3){l.warn("transport failure detected"),j.hasFeature(J.ENABLE_CF_EXPERIMENTAL_FAIL_RECOVERY)&&(l.debug("rejoining room"),this.emit("rejoin"));return}(this._consumerCreationFailureCount>0||this._consumerNotBoundFailureCount>=2)&&(l.warn("consumer creation failure detected or consumer not bound failure increased"),j.hasFeature(J.ENABLE_CF_EXPERIMENTAL_FAIL_RECOVERY)&&(l.debug("reconnecting recv transport"),this._totalTransportReconnectionCount+=1,this.updateTransportState({state:ut.RECONNECTING,direction:"consuming"}),this.emit("reconnect_transport",this._recvTransport))),this._producerNotReadyFailureCount>=2&&(l.warn("producer receiver not getting added needs to reconnect send transport"),this._totalTransportReconnectionCount+=1,this.updateTransportState({state:ut.RECONNECTING,direction:"producing"}),this.emit("reconnect_transport",this._sendTransport))}triggerTransportReconnection(e,r){l.info("triggerTransportReconnection:: reconnecting transport",{transport:{type:e.direction,id:e.id,serverId:e.serverId}});const n=j.hasFeature(J.ENABLE_CF_TRANSPORT_RECONNECTION_ON_ICE_FAILED),i=j.hasFeature(J.CF_TRANSPORT_FORCE_RELAY_ON_ICE_FAILED);n&&(i&&this._socket.isConnected&&(performance.now()-this.lastConnectionTime>2e4&&(this._transportConnectionFailCount=0),this._transportConnectionFailCount>2&&(l.warn("Multiple disconnections, forcing relay"),this._iceTransportPolicy="relay"),this._transportConnectionFailCount+=1),this.updateTransportState({state:ut.RECONNECTING,direction:r?"consuming":"producing"}),this.emit("reconnect_transport",e))}async switchConsumersToLayer(e,r){const n=this._recvTransport.getDatachannel("events");if(!n){l.warn("events datachannel not found");return}const i={type:"switch_consumer_layer",payload:{consumerIds:e,layer:r}};await n.request(i),l.info(`CFSFUHandler::consumer id: ${e} layer switched to ${r}`)}updateTransportState(e){const{state:r,direction:n}=e;r==="disconnected"&&(this.transportDisconnected[n]=!0),this.transportState[n]={state:r,reconnected:r==="connected"?this.transportDisconnected[n]:this.transportState[n].reconnected},r==="connected"&&(this.transportDisconnected[n]=!1),w.emit(C.TRANSPORT_STATE_UPDATE,{transport:n,...this.transportState[n]})}}ts=new WeakMap;var _O=Object.defineProperty,SO=Object.getOwnPropertyDescriptor,de=(s,t,e,r)=>{for(var n=r>1?void 0:r?SO(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&_O(t,e,n),n};const li={joinAttempted:!1},EO=5e3,jg=(Lv=class extends kg{constructor(t,e){var c,u;super();S(this,Or);S(this,Ae,void 0);S(this,pe,void 0);S(this,Dr,void 0);S(this,Vn,void 0);S(this,Bn,void 0);S(this,Bs,void 0);S(this,ao,void 0);S(this,oo,void 0);S(this,co,void 0);S(this,rs,void 0);S(this,Ji,void 0);S(this,Hs,void 0);m(this,"legacyMode");m(this,"roomNodeUrl");m(this,"peerDisplayName");m(this,"activatedProducingPeerIds");m(this,"e2ee");m(this,"partialJoinRoomPromise");this.context=t;const{roomName:r,authToken:n,legacyMode:i,socketClient:a,meetingTitle:o}=e;this.roomJoined=!1,this.roomName=r,this.authToken=n,this.legacyMode=i,this.meetingTitle=o,T(this,Ae,a),T(this,Dr,!1),T(this,Hs,void 0),T(this,pe,new TO(t,a)),this.maxPreferredStreams=6,this.activatedProducingPeerIds=new Set,T(this,rs,new Set),T(this,Vn,!1),T(this,Bn,0),T(this,Bs,new oi),this.e2ee=(u=(c=t.getValue("modules").e2ee)==null?void 0:c.enabled)!=null?u:!1,U.legacySwitch(i),this.handleSocketEvents(),this.handleSFUEvents(),this.handleSocketConnectionEvents(),this.handleCallstatsEvents(),T(this,ao,Sr(async()=>{if(!li.joinAttempted)return;const{roomJoined:h}=await this.joinRoom(this.peerDisplayName,this.roomUUID,{},!0,!0);h&&(w.emit(C.RESET_PRODUCER_STATE),w.emit(C.ROOM_NODE_RECONNECTED))},5e3,{leading:!0,maxWait:1e3})),T(this,oo,Sr(async h=>{h.close(),h.removeAllListeners(),await this.sfuHandler.setupTransports(["send"]),l.info("send transport reconected!"),w.emit(C.RESET_PRODUCER_STATE)},1e3)),T(this,co,Sr(async h=>{h.close(),h.removeAllListeners(),await this.sfuHandler.setupTransports(["recv"]),l.info("recv transport reconnected!"),this.activatedProducingPeerIds=new Set,w.emit(C.REFRESH_GRID,!0)},1e3))}get socketState(){return d(this,Ae).connectionState}get mediaState(){return d(this,pe).transportState}static async init(t,e){const{legacyMode:r=!0,meetingId:n,authToken:i,meetingTitle:a,socket:o}=e;return new jg(t,{legacyMode:r,authToken:i,socketClient:o,roomName:n,meetingTitle:a})}get sfuHandler(){return d(this,pe)}get rejoinRoom(){return d(this,ao)}reset(t=!0){var e,r,n,i;(r=(e=d(this,pe))==null?void 0:e.cleanupConsumers)==null||r.call(e),(i=(n=d(this,pe))==null?void 0:n.stopAllProducers)==null||i.call(n),d(this,rs).clear(),this.activatedProducingPeerIds.clear(),t&&(d(this,Bs).stop(),this.sfuHandler.stopAllTransports(),this.sfuHandler.reset(),T(this,Bs,new oi))}async reconnectTransport(t){l.info(`CFNodeClient::Room joining state: ${d(this,Dr)}`),!(!t||d(this,Dr))&&(t.direction==="send"?await d(this,oo).call(this,t):await d(this,co).call(this,t))}async setupTransports(t=!1){await d(this,pe).setupTransports(["recv","send"],t)}async stopAllProducers(){await d(this,pe).stopAllProducers()}async joinRoom(t,e,r={},n=!1,i=!1){li.joinAttempted=!0,T(this,Dr,!0),this.reset(n);const a=Je().ipInfo;if(a!=null&&a.loc&&!d(this,Ji)){const c=a.loc.split(",");T(this,Ji,{latitude:parseFloat(c[0]),longitude:parseFloat(c[1])})}let o;try{return o=await d(this,Bs).push(()=>this._joinRoom(t,e,r,i,d(this,Ji)),"joinRoom"),o}catch(c){o={roomJoined:!1}}return o.roomJoined||w.emit(C.ROOM_NODE_FAILED),o}async _partialJoinRoom(t,e,r=!1,n=void 0){const i=Je().ipInfo;let a=n;if(i!=null&&i.loc&&!n){const o=i.loc.split(",");a={latitude:parseFloat(o[0]),longitude:parseFloat(o[1])}}await br((o,c)=>(d(this,Ae).isConnected||c(new Error("socket is not connected")),o>0&&l.warn(`retrying sending join room request, count: ${o}`),this.sfuHandler.cfSocketHandler.joinRoom(e,t,r,a).catch(u=>{throw l.error("failed to send join room request, error:",{error:u}),u})),{delayTime:1e3,strategy:"exponential",maxRetryCount:j.hasFeature(J.ENABLE_CF_INFINITE_RETRIES)?1/0:3}),await this.setupTransports(!0)}async partialJoinRoom(t,e,r=!1,n=void 0){this.partialJoinRoomPromise=d(this,Bs).push(()=>this._partialJoinRoom(t,e,r,n))}async _joinRoom(t,e,r={},n=!1,i=null){this.peerDisplayName=t;try{return this.partialJoinRoomPromise?await this.partialJoinRoomPromise:await this._partialJoinRoom(t,e,n,i),j.hasFeature(J.INTERNAL_CALL_STATS)&&navigator.product!=="ReactNative"&&setTimeout(async()=>{const c={userId:this.context.getValue("userId"),peerId:this.peerId,displayName:t,roomUUID:e,roomViewType:"groupCall",roomName:this.roomName,deviceInfo:{...we.getDeviceInfo(),userAgent:navigator.userAgent,memory:navigator.deviceMemory,cpus:navigator.hardwareConcurrency},sdkName:this.context.getValue("sdkName"),sdkVersion:this.context.getValue("sdkVersion"),metaData:{},permissions:{}};U.roomJoined(c),r!=null&&r.audio?U.audioOn():U.audioOff(),r!=null&&r.video?U.videoOn():U.videoOff()}),{roomJoined:await this.completeJoinRoom()}}catch(a){return l.error("error on sending join room request",{error:a}),{roomJoined:!1}}finally{this.partialJoinRoomPromise=void 0}}async completeJoinRoom(){try{const{maxPreferredStreams:t,roomState:e}=await this.sfuHandler.cfSocketHandler.notifySelfJoinComplete();return this.roomUUID=e.roomUuid,this.maxPreferredStreams=t!=null?t:6,T(this,Dr,!1),T(this,Vn,!0),this.roomJoined=!0,w.emit(C.REFRESH_GRID,!0),!0}catch(t){return l.error("error on completing join room:",{error:t}),!1}}async leaveRoom(){d(this,pe).stopAllTransports(),T(this,Vn,!1),li.joinAttempted=!1;const t={closeRoom:!1};d(this,Ae).sendMessagePromise(ne.leaveRoom,tf.toBinary(t)).then(e=>{var n;((n=mf.fromBinary(e.payload))==null?void 0:n.closed)||l.warn("weird state on peer closed and should not happen")}).catch(e=>{l.error("error on sending leave room request",{error:e})}),U.callEnded(),g.destruct()}getConsumers(){return d(this,pe).consumers}async activatePeers(t){return this.createConsumers(t)}async deactivatePeers(t,e="default"){const r=new Set;t.forEach(i=>{i.screenShare&&i.kind==="video"&&r.add(i.producingPeerId)});const n=e==="default"?t.filter(i=>!r.has(i.producingPeerId)).filter(i=>i.kind!=="audio"):t;await Promise.all(n.map(i=>{const a=this.sfuHandler.producerIdToConsumerIdMap.get(i.producerId);if(!a){l.warn(`consumer not found in deactivate producers: ${i.producerId}`);return}return this.sfuHandler.closeConsumer(a)}))}async createConsumers(t){return this.sfuHandler.createConsumers(t)}async pauseConsumers(t){t.forEach(e=>{this.sfuHandler.pauseConsumer(e)})}async resumeConsumers(t){t.forEach(e=>{this.sfuHandler.resumeConsumer(e)})}async closeConsumers(t){await Promise.all(t.map(e=>{const r=this.sfuHandler.producerIdToConsumerIdMap.get(e.producerId);if(!r){l.warn(`consumer not found in deactivate producers: ${e.producerId}`);return}return this.sfuHandler.closeConsumer(r)}))}async consumePeer(t,e,r){if(l.info(`current activated Peer ids: ${JSON.stringify(Array.from(this.activatedProducingPeerIds.values()))}, forced?:${r}`),!this.activatedProducingPeerIds.has(t)||r)try{await d(this,pe).createConsumers(e),this.activatedProducingPeerIds.add(t)}catch(n){l.error("consumePeer failed in CFNodeClient.ts",{error:n})}else l.info(`not creating consumer for this peerId: ${t}`)}async shareWebcam(t){if(t===void 0)return null;if(d(this,pe).producers.has(Q.WEBCAM)){const i=d(this,pe).producers.get(Q.WEBCAM);if(!i.closed&&!navigator.isReactNative)return await i.replaceTrack({track:t}),await this.resumeWebcam(),t;await d(this,pe).removeProducer(Q.WEBCAM)}const e={track:t,codecOptions:{name:"VP8"},appData:{screenShare:!1,e2ee:this.e2ee},stopTracks:!1};let r=t.getConstraints().width;r in Tg||(r=640),e.encodings=L0[r],j.hasFeature(J.ENABLE_CF_SIMULCAST)&&(e.encodings=Tg[r]);const n=()=>{l.info("Disabling video due to the producer closure"),this.disableWebcam()};return d(this,pe).createProducer(Q.WEBCAM,e,n)}async shareScreen(t){const{video:e,audio:r}=t;if(e===void 0)return;const n={track:e,codecOptions:{name:"VP8"},appData:{screenShare:!0,e2ee:this.e2ee,supportsRemoteControl:we.isElectron()},stopTracks:!1};let i=()=>{l.info("Disabling screenShare due to the producer closure"),this.disableScreenShare()};if(await d(this,pe).createProducer(Q.SCREENSHARE_VIDEO,n,i),r){const a={track:r,codecOptions:{name:"opus"},appData:{screenShare:!0,e2ee:this.e2ee,supportsRemoteControl:we.isElectron()},stopTracks:!1,zeroRtpOnPause:!0};i=()=>{},await d(this,pe).createProducer(Q.SCREENSHARE_AUDIO,a,i)}U.screenShareStart()}async shareMic(t){try{if(t===void 0)throw new lt("track undefined");if(d(this,pe).producers.has(Q.MIC)){const n=d(this,pe).producers.get(Q.MIC);if(!n.closed&&!navigator.isReactNative){await n.replaceTrack({track:t}),await this.resumeMic();return}await d(this,pe).removeProducer(Q.MIC,!1)}const e={track:t,encodings:[{priority:"high"}],codecOptions:{name:"opus"},appData:{e2ee:this.e2ee},stopTracks:!1,zeroRtpOnPause:!0},r=()=>{l.info("Disabling audio due to the producer closure"),this.disableMic()};await d(this,pe).createProducer(Q.MIC,e,r)}catch(e){throw new b(e)}}pauseMic(){const t=d(this,pe).producers.get(Q.MIC);if(!t){l.error("pauseMic::could_not_find_mic_producer");return}if(t.paused){l.info("pauseMic::mic_producer_already_paused");return}t.pause();const e={producerId:t.id,pause:!0};d(this,Ae).sendMessage(ne.toggleProducer,hs.toBinary(e))}async pauseWebcam(){const t=d(this,pe).producers.get(Q.WEBCAM);if(!t){l.error("pauseWebcam::could_not_find_webcam_producer");return}t.pause();const e={producerId:t.id,pause:!0};d(this,Ae).sendMessage(ne.toggleProducer,hs.toBinary(e))}async resumeMic(){const t=d(this,pe).producers.get(Q.MIC);if(!t){l.error("resumeMic::could_not_find_mic_producer");return}if(!t.pause){l.info("resumeMic::mic_producer_already_resumed");return}t.resume(),t.appData.e2ee&&w.emit(C.E2EE_ACTIVE_PRODUCER,t);const e={producerId:t.id,pause:!1};d(this,Ae).sendMessage(ne.toggleProducer,hs.toBinary(e))}async resumeWebcam(){const t=d(this,pe).producers.get(Q.WEBCAM);if(!t){l.error("resumeWebcam::could_not_find_webcam_producer");return}t.resume(),t.appData.e2ee&&w.emit(C.E2EE_ACTIVE_PRODUCER,t);const e={producerId:t.id,pause:!1};d(this,Ae).sendMessage(ne.toggleProducer,hs.toBinary(e))}async disableWebcam(){await d(this,pe).removeProducer(Q.WEBCAM)}async disableMic(){await d(this,pe).removeProducer(Q.MIC)}async disableScreenShare(){l.info("screen_sharing_stopped"),U.screenShareStop(),await d(this,pe).removeProducer(Q.SCREENSHARE_VIDEO),await d(this,pe).removeProducer(Q.SCREENSHARE_AUDIO),d(this,rs).clear()}async muteSelf(){this.pauseMic()}async unmuteSelf(){}async resetVideoProducers(t,e){t&&(await d(this,pe).removeProducer(Q.WEBCAM,!1),this.shareWebcam(t)),e&&(await d(this,pe).removeProducer(Q.SCREENSHARE_VIDEO,!1),this.shareScreen({video:e}))}async changeDisplayName(t,e){const r={displayName:t,participantId:e!=null?e:this.peerId};if(!await this.sfuHandler.cfSocketHandler.changeDisplayName(r))throw new Error("failed to change display name!")}async kick(t){const e={participantId:t};if(!await this.sfuHandler.cfSocketHandler.kickPeer(e))throw new Error("failed to kickout the participant!")}async kickAll(){if(!await this.sfuHandler.cfSocketHandler.kickAll())throw new Error("failed to kickout all participant!")}async muteAll(t){if(!await this.sfuHandler.cfSocketHandler.hostControlForAll("audio"))throw new Error("failed to mute all participant")}async muteAllVideo(){if(!await this.sfuHandler.cfSocketHandler.hostControlForAll("video"))throw new Error("failed to mute all video participant")}async disableAudio(t){if(!await this.sfuHandler.cfSocketHandler.hostControlForPeer(t,"audio"))throw new Error("failed to mute given participant")}async disableVideo(t){if(!await this.sfuHandler.cfSocketHandler.hostControlForPeer(t,"video"))throw new Error("failed to mute video of given participant")}async pinPeer(t){const e={participantId:t!=null?t:""};try{await d(this,Ae).sendMessagePromise(ne.globalPinPeer,nf.toBinary(e))}catch(r){l.error("Error in pinning peer:",{error:r})}}validateScreenShare(t){return this.peerId===t.peerId&&this.sfuHandler.hasProducer(t.producerId)&&d(this,rs).add(t.consumerPeerId),d(this,rs).size}async switchConsumersToLayer(t,e){this.sfuHandler.switchConsumersToLayer(t,e)}async handleSocketEvents(){d(this,Ae).on(ne.peerProducerCreateBroadcast,({payload:t})=>{if(this.roomJoined)try{const{participantId:e,producerState:r}=bf.fromBinary(t);if(e===this.peerId)return;l.info(`producer created broadcast: ${e}, producer state: ${r}`),w.emit(C.NEW_PRODUCER,{peerId:e,producer:{...r,kind:r.kind===Dt.AUDIO?"audio":"video"}})}catch(e){l.error("error in peer-producer-create-broadcast",{error:e})}}),d(this,Ae).on(ne.peerProducerToggleBroadcast,({payload:t})=>{if(this.roomJoined)try{const{participantId:e,producerState:{kind:r,pause:n,producerId:i}}=Pf.fromBinary(t),a=r===Dt.AUDIO?"audio":"video";l.info(`producer toggle broadcast: ${e}, producerId: ${i}, kind:${a}, paused:${n}`),w.emit(C.PRODUCER_TOGGLE,{peerId:e,producerId:i,paused:n,kind:a}),Array.from(this.getConsumers().values()).filter(c=>c.producerId===i).forEach(c=>{c.paused!==n&&(l.debug(`consumer state mismatched for ${c.id}. updating consumer pause state ${c.paused} to ${n}`),n?(c.pause(),w.emit(C.CONSUMER_PAUSED,{id:c.id})):(c.resume(),w.emit(C.CONSUMER_RESUMED,{id:c.id})))})}catch(e){l.error("error in producer toggle broadcast handler",{error:e})}}),d(this,Ae).on(ne.peerLeaveBroadcast,({payload:t})=>{if(this.roomJoined)try{const{participantId:e}=bc.fromBinary(t);if(e===this.peerId)return;l.info(`peer left broadcast:${e}`),d(this,rs).delete(e),this.sfuHandler.cleanupConsumers(e)}catch(e){l.error("error in peer left broadcast",{error:e})}}),d(this,Ae).on(ne.peerProducerCloseBroadcast,({payload:t})=>{if(this.roomJoined)try{const{participantId:e,producerState:{producerId:r}}=Rf.fromBinary(t);if(e===this.peerId)return;l.info(`producer closed broadcast:${e}`),w.emit(C.PRODUCER_CLOSED,{peerId:e,producerId:r});const n=this.sfuHandler.producerIdToConsumerIdMap.get(r);if(!n){l.warn(`no consumer found for producer:${r}`);return}l.info(`closing consumer ${n}, producer id: ${r}`),this.sfuHandler.closeConsumer(n).then(()=>{l.info(`closed consumer: ${n}`),this.sfuHandler.producerIdToConsumerIdMap.delete(r),w.emit(C.CONSUMER_CLOSED,{id:n})}).catch(i=>{l.error("error closing consumer",{error:i})})}catch(e){l.error("error on producer close broadcast",{error:e})}}),d(this,Ae).on(ne.mediaRoomTerminationBroadcastResponse,()=>{!this.roomJoined&&!d(this,Dr)&&!d(this,Vn)||(l.warn("media hub termination broadcast received, rejoining room"),w.emit(C.ROOM_NODE_DISCONNECTED),this.rejoinRoom())})}handleSocketConnectionEvents(){d(this,Ae).onStateEvent("connected",async()=>{l.info("SocketService::Connected to socket-edge"),clearTimeout(d(this,Hs)),T(this,Hs,void 0),le(this,Or,zs).call(this,"connected")}),d(this,Ae).onStateEvent("disconnected",({code:t,reason:e})=>{l.info("SocketService::Disconnected from socket-edge",{error:{code:t,reason:e}});const{consuming:r,producing:n}=this.mediaState;r.state!==ut.CONNECTED||n.state!==ut.CONNECTED?w.emit(C.SOCKET_SERVICE_DISCONNECTED,{joinAttempted:li.joinAttempted}):T(this,Hs,setTimeout(()=>{w.emit(C.SOCKET_SERVICE_DISCONNECTED,{joinAttempted:li.joinAttempted}),T(this,Hs,void 0)},EO)),le(this,Or,zs).call(this,"disconnected"),this.roomJoined=!1}),d(this,Ae).onStateEvent("reconnecting",async()=>{l.info("SocketService::Reconnecting to socket-edge"),le(this,Or,zs).call(this,"reconnecting")}),d(this,Ae).onStateEvent("reconnectAttempt",async({attempt:t})=>{l.info("SocketService::Attempting to reconnect to socket-edge",{socket:{retryAttempt:t}}),le(this,Or,zs).call(this,"reconnectAttempt",t)}),d(this,Ae).onStateEvent("reconnectFailure",({attempt:t})=>{l.info("SocketService::Reconnect attempt to socket-edge failed",{socket:{retryAttempt:t}}),le(this,Or,zs).call(this,"reconnectFailure",t)}),d(this,Ae).onStateEvent("reconnected",async()=>{l.info("SocketService::Reconnected to socket-edge",{connectionState:li}),w.emit(C.SOCKET_SERVICE_RECONNECTED),le(this,Or,zs).call(this,"reconnected")}),d(this,Ae).onStateEvent("failed",async()=>{l.info("SocketService::Failed to connect to socket-edge"),le(this,Or,zs).call(this,"failed")})}handleSFUEvents(){d(this,pe).on("reconnect_transport",async t=>{try{await this.reconnectTransport(t),l.info(`transport reconnected [id:${t.id}]`)}catch(e){l.error("error on reconnection transports",{error:e})}}),d(this,pe).on("rejoin",t=>{if(d(this,Bn)>3&&!t){l.warn("cannot rejoin more already rejoined 3 times");return}if(d(this,Dr)&&!t){l.warn("room joining in progress, cannot start rejoining");return}T(this,Bn,d(this,Bn)+1),l.warn(`rejoining the room because transports are failing. [rejoinCount: ${d(this,Bn)}]`),this.roomJoined=!1,w.emit(C.ROOM_NODE_DISCONNECTED),this.rejoinRoom()})}handleCallstatsEvents(){U.onSafeInitialization(()=>{U.onConsumerScore(t=>{t.forEach((e,r)=>{const n=this.sfuHandler.consumers.get(r);n&&w.emit(C.CONSUMER_SCORE_UPDATE,{id:r,kind:n.kind,peerId:n.peerId,score:e.score,scoreStats:e})})}),U.onProducerScore(t=>{t.forEach((e,r)=>{const n=Array.from(this.sfuHandler.producers.values()).find(i=>i.id===r);n&&w.emit(C.PRODUCER_SCORE_UPDATE,{id:r,kind:n.kind,appData:n.appData,score:e.score,scoreStats:e})})})})}},Ae=new WeakMap,pe=new WeakMap,Dr=new WeakMap,Vn=new WeakMap,Bn=new WeakMap,Bs=new WeakMap,ao=new WeakMap,oo=new WeakMap,co=new WeakMap,rs=new WeakMap,Ji=new WeakMap,Hs=new WeakMap,Or=new WeakSet,zs=function(t,e){let r;const{reconnected:n}=d(this,Ae).connectionState;switch(t){case"connected":r={state:"connected",reconnected:n,reconnectionAttempt:void 0};break;case"disconnected":r={state:"disconnected",reconnected:!1,reconnectionAttempt:0};break;case"reconnected":r={state:"connected",reconnected:!0,reconnectionAttempt:void 0};break;case"reconnecting":r={state:"reconnecting",reconnected:n,reconnectionAttempt:0};break;case"reconnectAttempt":r={state:"reconnecting",reconnected:n,reconnectionAttempt:e};break;case"failed":r={state:"failed",reconnected:n,reconnectionAttempt:void 0};break}r&&(d(this,Ae).connectionState=r,w.emit(C.SOCKET_STATE_UPDATE,r))},Lv);let ae=jg;de([g.trace("CFNodeClient.reset")],ae.prototype,"reset",1),de([g.trace("CFNodeClient.reconnect")],ae.prototype,"reconnectTransport",1),de([g.trace("CFNodeClient.setupTransport")],ae.prototype,"setupTransports",1),de([g.trace("CFNodeClient.stopAllProducers")],ae.prototype,"stopAllProducers",1),de([g.trace("CFNodeClient.joinRoom")],ae.prototype,"joinRoom",1),de([g.trace("CFNodeClient.completeJoinRoom")],ae.prototype,"completeJoinRoom",1),de([g.trace("CFNodeClient.leaveRoom")],ae.prototype,"leaveRoom",1),de([g.trace("CFNodeClient.activatePeers")],ae.prototype,"activatePeers",1),de([g.trace("CFNodeClient.deactivatePeers")],ae.prototype,"deactivatePeers",1),de([g.trace("CFNodeClient.createConsumers")],ae.prototype,"createConsumers",1),de([g.trace("CFNodeClient.pauseConsumers")],ae.prototype,"pauseConsumers",1),de([g.trace("CFNodeClient.resumeConsumers")],ae.prototype,"resumeConsumers",1),de([g.trace("CFNodeClient.closeConsumers")],ae.prototype,"closeConsumers",1),de([g.trace("CFNodeClient.consumePeer")],ae.prototype,"consumePeer",1),de([g.trace("CFNodeClient.shareWebcam")],ae.prototype,"shareWebcam",1),de([g.trace("CFNodeClient.shareScreen")],ae.prototype,"shareScreen",1),de([g.trace("CFNodeClient.shareMic")],ae.prototype,"shareMic",1),de([g.trace("CFNodeClient.pauseMic")],ae.prototype,"pauseMic",1),de([g.trace("CFNodeClient.pauseWebcam")],ae.prototype,"pauseWebcam",1),de([g.trace("CFNodeClient.resumeMic")],ae.prototype,"resumeMic",1),de([g.trace("CFNodeClient.resumeWebcam")],ae.prototype,"resumeWebcam",1),de([g.trace("CFNodeClient.disableWebcam")],ae.prototype,"disableWebcam",1),de([g.trace("CFClient.disableMic")],ae.prototype,"disableMic",1),de([g.trace("CFClient.disableScreenShare")],ae.prototype,"disableScreenShare",1),de([g.trace("CFNodeClient.muteSelf")],ae.prototype,"muteSelf",1),de([g.trace("CFNodeClient.resetVideoProducers")],ae.prototype,"resetVideoProducers",1),de([g.trace("CFNodeClient.changeDisplayName")],ae.prototype,"changeDisplayName",1),de([g.trace("CFNodeClient.kickPeer")],ae.prototype,"kick",1),de([g.trace("CFNodeClient.kickAllPeers")],ae.prototype,"kickAll",1),de([g.trace("CFNodeClient.muteAll")],ae.prototype,"muteAll",1),de([g.trace("CFNodeClient.muteAllVideo")],ae.prototype,"muteAllVideo",1),de([g.trace("CFNodeClient.disableAudio")],ae.prototype,"disableAudio",1),de([g.trace("CFNodeClient.disableVideo")],ae.prototype,"disableVideo",1),de([g.trace("CFNodeClient.pinPeer")],ae.prototype,"pinPeer",1),de([g.trace("CFNodeClient.validateScreenShare")],ae.prototype,"validateScreenShare",1),de([g.trace("CFNodeClient.init")],ae,"init",1);async function wO(s,t){const e=s.getValue("roomNodeClient");if(e){if(e instanceof ie)return e;throw new Error("Room Node Client already setup")}const r=await ie.init(s,t);return s.setValue("roomNodeClient",r),r}async function CO(s,t){const e=s.getValue("roomNodeClient");if(e){if(e instanceof ae)return e;throw new Error("Room Node Client already setup")}const r=await ae.init(s,t);return s.setValue("roomNodeClient",r),r}async function Gg(s,t,e=ci.HIVE){return e===ci.CF?CO(s,t):wO(s,t)}function Wg(s){const t=s.getValue("roomNodeClient");try{t==null||t.leaveRoom()}catch(e){l.error("roomNodeClient::cleanupRoomNodeClient")}s.setValue("roomNodeClient",void 0)}var bO=Object.defineProperty,PO=Object.getOwnPropertyDescriptor,RO=(s,t,e,r)=>{for(var n=r>1?void 0:r?PO(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&bO(t,e,n),n};let yn;const Jg=class{constructor(s){m(this,"socket");this.socket=s,this.handleSocketEvents()}static create(s){return yn||(yn=new Jg(s)),yn}static cleanup(){var s;try{(s=yn==null?void 0:yn.socket)==null||s.disconnect()}catch(t){l.error("roomSocketHandler::cleanup")}yn=void 0}async joinRoom(s,t){var n;this.socket.joinAttempted=!0;const e={capabilities:[],peer:{displayName:(n=s.name)!=null?n:"Participant",customParticipantId:s.customParticipantId,peerId:s.id,userId:s.userId,displayPictureUrl:s.picture,waitlisted:!1},roomUuid:""},r=this.socket.sendMessagePromise(V.joinRoom,BR.toBinary(e));try{const{peer:i}=Yn.fromBinary((await r).payload);w.emit(C.SOCKET_SERVICE_ROOM_JOINED,{peer:i});const a=this.getRoomState();let o=()=>new Promise(h=>{h({peers:[]})});t!==Xe.Livestream&&(o=this.getRoomPeersNonPaginated()),t===Xe.Livestream&&i.stageType===1&&(o=this.getStagePeers());const[{room:c},{peers:u}]=await Promise.all([a,o]);return w.emit(C.ROOM_STATE,c),w.emit(C.SOCKET_PEERS,u),{peer:i}}catch(i){throw l.error("RoomSocketHandler.joinRoom.failed",{error:i}),new b("Error: RoomSocketHandler.joinRoom failed.","0002",i)}}async getAllAddedParticipants(){try{return bk.fromBinary((await this.socket.sendMessagePromise(V.getAllAddedParticipants)).payload).participants.map(({id:t,...e})=>({...e,userId:t}))}catch(s){return[]}}async getRoomPeers(s,t,e){let r;try{const n={seachQuery:s,limit:t,offset:e},i=await this.socket.sendMessagePromise(V.getRoomPeersInfo,MR.toBinary(n));r=Hl.fromBinary(i.payload)}catch(n){l.error("getRoomPeers::binary_decode_error",{error:n})}return r}async getRoomPeersNonPaginated(){let s;try{const t=await this.socket.sendMessagePromise(V.getRoomPeersInfo);s=Hl.fromBinary(t.payload)}catch(t){l.error("getRoomJoinedPeers::binary_decode_error",{error:t})}return s}async getStagePeers(){let s;try{const t=await this.socket.sendMessagePromise(V.getRoomPeersInfo);s=Hl.fromBinary(t.payload)}catch(t){l.error("getRoomJoinedPeers::binary_decode_error",{error:t})}return s}async getPeerInfo(s){let t;try{const e=await this.socket.sendMessagePromise(V.getPeerInfo,Of.toBinary({peerId:s}));t=Yn.fromBinary(e.payload)}catch(e){l.error("getPeerInfo::binary_decode_error",{error:e})}return t}async getRoomState(){let s=Df.create();try{const t=await this.socket.sendMessagePromise(V.getRoomInfo);s=Df.fromBinary(t.payload)}catch(t){l.error("getRoomState::binary_decode_error",{error:t})}return s}async getRoomStageState(){let s=Uf.create();try{const t=await this.socket.sendMessagePromise(V.getRoomStageState);s=Uf.fromBinary(t.payload)}catch(t){l.error("getRoomStageState::binary_decode_error",{error:t})}return s}async broadcastMessage(s,t){const e={type:s,payload:new TextEncoder().encode(JSON.stringify(t)),timestamp:Date.now(),peerIds:[]};return this.socket.sendMessagePromise(V.broadcastMessage,kc.toBinary(e))}async broadcastToPeers(s,t,e){const r={type:s,payload:new TextEncoder().encode(JSON.stringify(e)),timestamp:Date.now(),peerIds:t};return this.socket.sendMessage(V.broadcastToPeers,kc.toBinary(r))}async leaveRoom(){this.socket.joinAttempted=!1,this.socket.sendMessagePromise(V.leaveRoom,qR.toBinary({}))}async kick(s){const t={peerIds:[s]};this.socket.sendMessage(V.kick,Ik.toBinary(t))}async kickAll(s=!1){const t={propagateKickAcrossRooms:s};this.socket.sendMessage(V.kickAll,Ul.toBinary(t))}getWaitingRoomRequests(){this.socket.sendMessage(V.getWaitingRoomRequests)}acceptWaitingRoomRequest(s){const t={userIds:s};this.socket.sendMessage(V.acceptWaitingRoomRequests,Dk.toBinary(t))}rejectWaitingRoomRequest(s){const t={userIds:s};this.socket.sendMessage(V.denyWaitingRoomRequests,Nk.toBinary(t))}async updatePermissions(s,t){const e={updatePeersPresets:[]};return s.forEach(r=>{e.updatePeersPresets.push({userIds:r,patch:t})}),this.socket.sendMessagePromise(Dc.updateUserPreset,dI.toBinary(e))}handleSocketEvents(){this.socket.on(V.broadcastMessage,({payload:s})=>{try{const t=kc.fromBinary(s);w.emit(C.ROOM_MESSAGE,{payload:JSON.parse(new TextDecoder().decode(t.payload)),type:t.type,timestamp:t.timestamp})}catch(t){l.error("failed to decode broadcast message:",t)}}),this.socket.on(V.broadcastToPeers,({payload:s})=>{try{const t=kc.fromBinary(s);w.emit(C.MESSAGE,{payload:JSON.parse(new TextDecoder().decode(t.payload)),type:t.type,timestamp:t.timestamp})}catch(t){l.error("failed to decode peer broadcast message:",t)}})}on(s,t){let e,r;switch(s){case V.joinRoom:case V.leaveRoom:case V.kick:case V.kickAll:{e=Yn.fromBinary.bind(Yn),r=Yn.create();break}case V.getWaitingRoomRequests:{e=(n,i)=>n?xf.fromBinary(n,i):{requests:[]},r=xf.create();break}case V.recordingPaused:case V.recordingStarted:case V.recordingStopped:{e=Yf.fromBinary.bind(Yf);break}case Dc.updateUserPreset:{e=Vf.fromBinary.bind(Vf);break}case ne.peerJoinedBroadcast:case se.peerJoinedBroadcast:{e=wf.fromBinary.bind(wf);break}case ne.selfJoinComplete:case se.selfJoinComplete:{e=Cc.fromBinary.bind(Cc);break}case ne.globalPeerPinBroadcast:case se.globalPeerPinBroadcast:{e=kf.fromBinary.bind(kf);break}case ne.selectedPeer:case se.selectedPeer:{e=$l.fromBinary.bind($l);break}case ne.selectedPeerDiff:case se.selectedPeerDiff:{e=pf.fromBinary.bind(pf);break}case ne.leaveRoom:case se.leaveRoom:{e=bc.fromBinary.bind(bc);break}}this.socket.on(s,({payload:n})=>{let i=r;if(!e)return t(void 0);try{i=e(n)}catch(a){l.error("roomSocketHandler::on::binary_decode_error",{error:a})}return t(i)})}async getUserPermissions(s){const t={userIds:[s]};try{const e=await this.socket.sendMessagePromise(Dc.getUserPresets,rI.toBinary(t)),r=aI.fromBinary(e.payload).peerPresets[0],n=new TextDecoder().decode(r.preset),i=JSON.parse(n).permissions;return{chat:i.chat,polls:i.polls,plugins:i.plugins}}catch(e){throw l.error("Error in getting user preset",{error:e}),e}}};let Xc=Jg;RO([g.trace("RoomSocketHandler.joinRoom")],Xc.prototype,"joinRoom",1);var kO=Object.defineProperty,IO=Object.getOwnPropertyDescriptor,ui=(s,t,e,r)=>{for(var n=r>1?void 0:r?IO(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&kO(t,e,n),n};const Kg=(Fv=class{constructor(s,t,e,r){S(this,Ut);m(this,"self");m(this,"authToken");S(this,qs,void 0);m(this,"viewType");S(this,gr,void 0);S(this,Et,void 0);const{socket:n}=e,i=s.getValue("authToken");this.self=t,T(this,Et,s),this.viewType=r,this.authToken=i,T(this,qs,n),T(this,gr,e),t.config.viewType!==Xe.Chat&&this.setupEvents()}get peerId(){return d(this,Et).getValue("peerId")}static async init(s,t,e,r,n){const i=Je(),a=s.getValue("peerId"),o=!!s.getValue("cachedUserDetails"),c=await ht.__init__(s,e,r,n,n.name,o);if(j.hasFeature(J.INTERNAL_CALL_STATS)&&navigator.product!=="ReactNative"){const u=!j.hasFeature(J.PRECALL_BANDWIDTH_TEST);setTimeout(async()=>{const h=await c.getAllDevices();l.info("populated_full_device_list",{devices:JSON.stringify(h)}),U.onSafeInitialization(async()=>{U.devices("AUDIO",h==null?void 0:h.filter(p=>p.kind==="audioinput")),U.devices("VIDEO",h==null?void 0:h.filter(p=>p.kind==="videoinput")),U.devices("SPEAKER",h==null?void 0:h.filter(p=>p.kind==="audiooutput"))}),U.initialize({peerId:a,engineName:we.getDeviceInfo().engineName,env:s.getValue("env"),iceServers:await i.getICEServers(),apiBase:s.getValue("apiBase"),flags:j.getAllFlags(),logger:l,apiHostnames:Mm(s),skipConnectivityChecks:u})})}return new Kg(s,c,t,n.viewType)}async shareMediaTracks(){var o;const{audioTrack:s,videoTrack:t,permissions:e,audioEnabled:r,videoEnabled:n,screenShareEnabled:i,screenShareTracks:a}=this.self;if(e.canProduceAudio&&r)try{await d(this,Ut,ir).shareMic(s)}catch(c){this.self.disableAudio()}if(e.canProduceVideo&&n)try{const c=await d(this,Ut,ir).shareWebcam(t);c&&c.id!==t.id&&j.hasFeature(J.EXP_RESHARE)&&await d(this,Ut,ir).shareWebcam(c)}catch(c){this.self.disableVideo()}if(e.canProduceScreenshare&&i)try{await((o=d(this,Ut,ir))==null?void 0:o.shareScreen({video:a.video,audio:a.audio}))}catch(c){this.self.disableScreenShare()}}async kickHandler(s){let t="kicked";(s==null?void 0:s.kickType)==="kickAll"&&(t="ended"),this.leaveRoom(t)}waitlistedHandler(){l.info("SelController.waitlisted"),this.self.waitlistStatus="waiting",this.self.roomState="waitlisted",this.self.emit("waitlisted")}waitlistAcceptHandler(){if(l.info("SelController.waitlistAccepted"),this.self.waitlistStatus==="accepted"){l.warn("SelfController.WAITLIST_ACCEPTED.UserAlreadyAccepted");return}this.self.waitlistStatus="accepted",this.joinRoom()}waitlistRejectedHandler(){if(l.info("SelfController.waitlistRejected"),this.self.waitlistStatus==="rejected"){l.warn("SelfController.WAITLIST_REJECTED.UserAlreadyRejected");return}this.self.waitlistStatus="rejected",this.leaveRoom("rejected")}async resetSelf(s){U.callEnded(),d(this,Ut,ir).reset(),s&&await this.joinRoom(s)}setupEvents(){w.on(C.RESET_PRODUCER_STATE,async()=>{this.self.roomJoined&&this.shareMediaTracks()}),w.on(C.ROOM_NODE_RECONNECTED,()=>{this.self.roomState="joined",this.self.emit("roomJoined",{reconnected:!0})}),w.on(C.ROOM_NODE_DISCONNECTED,()=>{this.self.roomState!=="disconnected"&&(this.self.roomState="disconnected",this.self.emit("roomLeft",{state:"disconnected"}))}),w.on(C.ROOM_NODE_FAILED,()=>{this.self.roomState="failed",this.self.emit("roomLeft",{state:"failed"})}),w.on(C.SOCKET_SERVICE_RECONNECTED,({wasJoinAttempted:s})=>{this.resetSelf(s)}),w.on(C.SOCKET_SERVICE_DISCONNECTED,({joinAttempted:s})=>{if(this.self.roomState==="disconnected")return;let{peerId:t}=this;s&&j.hasFeature(J.REFRESH_ID_ON_DISCONNECTION)&&(t=Ys()),d(this,qs).updateURL(t),g.resetPeerId(t),Je().setHeader("dyte-tracing-id",t),pa.remapContext(t,d(this,Et)),this.self.roomState="disconnected",this.self.emit("roomLeft",{state:"disconnected"})}),w.on(C.SOCKET_SERVICE_FAILED,()=>{this.self.roomState="failed",this.self.emit("roomLeft",{state:"failed"})}),d(this,gr).on(V.waitingRoomRequestAccepted,()=>{this.waitlistAcceptHandler()}),d(this,gr).on(Dc.updateUserPreset,s=>{s.updatePeersPresets.forEach(t=>{t.userIds===this.self.userId&&w.emit(C.UPDATE_PERMISSIONS,t.patch)})}),d(this,gr).on(V.waitingRoomRequestDenied,()=>{this.waitlistRejectedHandler()}),d(this,gr).on(V.kick,()=>{this.kickHandler({kickType:"kick"})}),d(this,gr).on(V.kickAll,()=>{this.kickHandler({kickType:"kickAll"})}),w.onAsync(C.JOIN_MEDIA_ROOM,this.joinMediaRoom.bind(this)),w.on(C.PRODUCER_SCORE_UPDATE,({score:s,kind:t,appData:e,scoreStats:r})=>{var i;const n=(i=e==null?void 0:e.screenShare)!=null?i:!1;this.self.emit("mediaScoreUpdate",{kind:t,isScreenshare:n,score:s,participantId:this.self.id,scoreStats:r})}),w.on(C.MUTE_SELF,async()=>{this.self.audioEnabled&&(await this.self.disableAudio(),U.audioOff())}),w.on(C.MUTE_SELF_VIDEO,async()=>{this.self.videoEnabled&&(await this.self.disableVideo(),U.videoOff())}),w.onAsync(C.LEAVE_MEDIA_ROOM,this.leaveMediaRoom.bind(this)),w.on(C.PIP_HANGUP,this.leaveRoom.bind(this))}async joinRoom(s=!1){try{const{peer:t}=await d(this,gr).joinRoom(this.self,this.self.config.viewType);d(this,gr).socket.flush();const e=iu(t.stageType);if(d(this,Et).setValue("stageStatus",e,!1),t.waitlisted){this.waitlistedHandler();return}await this.joinMediaRoom(s),d(this,Et).notify("stageStatus")}catch(t){throw l.error("Error in joinRoom",{error:t}),t}}async leaveRoom(s="left"){var t,e;if(s==="rejected"){try{(t=d(this,qs))==null||t.disconnect()}catch(r){l.error("SelfController::leaveRoom::socketDisconnect")}this.self.roomState=s,this.self.emit("roomLeft",{state:s});return}this.self.setIsPinned(!1),d(this,Et).setValue("stageStatus","OFF_STAGE",!1),await this.leaveMediaRoom(s),d(this,Et).notify("stageStatus");try{(e=d(this,qs))==null||e.disconnect()}catch(r){l.error("SelfController::leaveRoom::socketDisconnect")}Wg(d(this,Et)),Xc.cleanup(),this.self.roomState=s,this.self.emit("roomLeft",{state:s})}partialMediaRoom(){var s;(s=d(this,Ut,ir))==null||s.partialJoinRoom(this.self.name,d(this,Et).getValue("meetingId"),void 0)}async joinMediaRoom(s=!1){var h,p;const{peerId:t,viewType:e,meetingId:r,authToken:n,stageStatus:i,roomNodeOptions:a}=d(this,Et).getAllValues(),{sfu:o,roomNodeUrl:c,meetingTitle:u}=a;try{if(e===Xe.Livestream){if(i!=="ON_STAGE"){this.self.roomState="joined",this.self.emit("roomJoined",{reconnected:s});return}await Gg(d(this,Et),{socket:d(this,qs),peerId:t,meetingId:r,authToken:n,roomNodeUrl:c,meetingTitle:u},o)}const{roomJoined:f}=(p=await((h=d(this,Ut,ir))==null?void 0:h.joinRoom(this.self.name,r,{audio:this.self.audioEnabled,video:this.self.videoEnabled,screen:this.self.screenShareEnabled},s,s)))!=null?p:{};if(!f)return;i==="ON_STAGE"&&await this.shareMediaTracks(),this.self.roomState="joined",this.self.emit("roomJoined",{reconnected:s})}catch(f){throw l.error("Error:SelfController.mediaRoomJoin",f),new b("Error: could not join media room",f)}}async leaveMediaRoom(s){const t=d(this,Et).getValue("viewType");await this.cleanupSelf(),!(s==="stageLeft"&&t===Xe.Webinar)&&d(this,Ut,ir)&&(d(this,Ut,ir).roomJoined&&s!=="disconnected"&&await d(this,Ut,ir).leaveRoom(),!(s==="stageLeft"&&t===Xe.Livestream)&&(d(this,Ut,ir).roomJoined=!1))}async cleanupSelf(){await this.self.disableAudio(),await this.self.disableVideo(),await this.self.disableScreenShare(),this.self.cleanUpTracks(),this.self.destructMediaHandler(),navigator.isReactNative||this.self.removeDocumentEventListeners()}},qs=new WeakMap,gr=new WeakMap,Et=new WeakMap,Ut=new WeakSet,ir=function(){return d(this,Et).getValue("roomNodeClient")},Fv);let Tn=Kg;ui([g.trace("SelfController.resetSelf")],Tn.prototype,"resetSelf",1),ui([g.trace("SelfController.setupEvents")],Tn.prototype,"setupEvents",1),ui([g.trace("SelfController.joinRoom")],Tn.prototype,"joinRoom",1),ui([g.trace("SelfController.leaveRoom")],Tn.prototype,"leaveRoom",1),ui([g.trace("SelfController.joinMediaRoom")],Tn.prototype,"joinMediaRoom",1),ui([g.trace("SelfController.leaveMediaRoom")],Tn.prototype,"leaveMediaRoom",1);class AO{constructor(t){S(this,lo,void 0);T(this,lo,t)}on(t,e){let r;t===V.roomPeerCount?r=Af.fromBinary.bind(Af):r=Wf.fromBinary.bind(Wf),d(this,lo).on(t,({payload:n})=>{const i=r(n);return e(i)})}}lo=new WeakMap;class MO{constructor(t){S(this,uo,void 0);T(this,uo,t)}on(t,e){let r,n;switch(t){case V.transcript:{r=Vl.fromBinary.bind(Vl),n=Vl.create();break}default:{l.debug("AISocketHandler switch case hit default, event not accounted for.");break}}d(this,uo).on(t,({payload:i})=>{let a=n;try{a=r(i)}catch(o){l.error("chatSocketHandler::on::binary_decode_error",{error:o})}return e(a)})}}uo=new WeakMap;var DO=Object.defineProperty,OO=Object.getOwnPropertyDescriptor,Iu=(s,t,e,r)=>{for(var n=r>1?void 0:r?OO(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&DO(t,e,n),n};class Zc{constructor(t){S(this,ss,void 0);T(this,ss,t)}getPolls(){return d(this,ss).sendMessagePromise(Vr.getPolls)}createPoll(t,e,r=!1,n=!1){const i={anonymous:r,hideVotes:n,question:t,options:e};return d(this,ss).sendMessage(Vr.createPoll,tM.toBinary(i))}votePoll(t,e){const r={index:e,pollId:t};return d(this,ss).sendMessage(Vr.votePoll,sM.toBinary(r))}on(t,e){let r,n;switch(t){case Vr.updatePoll:case Vr.createPoll:case Vr.votePoll:{r=Xl.fromBinary.bind(Xl),n=Xl.create();break}}d(this,ss).on(t,({payload:i})=>{let a=n;try{a=r(i)}catch(o){l.error("pollSocketHandler::on::binary_decode_error",{error:o})}return e(a)})}removeListeners(t){d(this,ss).removeListeners(t)}}ss=new WeakMap,Iu([g.trace("PollSocketHandler.getPolls")],Zc.prototype,"getPolls",1),Iu([g.trace("PollSocketHandler.createPoll")],Zc.prototype,"createPoll",1),Iu([g.trace("PollSocketHandler.votePoll")],Zc.prototype,"votePoll",1);class NO{constructor(t){S(this,$t,void 0);T(this,$t,t)}async getStageRequests(){const{payload:t}=await d(this,$t).sendMessagePromise(V.getStageRequests);return t?Ql.fromBinary(t):{stageRequests:[]}}requestAccess(){d(this,$t).sendMessage(V.requestStageAccess)}cancelRequestAccess(){d(this,$t).sendMessage(V.cancelStageRequest)}async grantAccess(t){const e={userIds:t};d(this,$t).sendMessage(V.grantStageAccess,GA.toBinary(e))}async denyAccess(t){const e={userIds:t};d(this,$t).sendMessage(V.denyStageAccess,JA.toBinary(e))}joinStage(){return d(this,$t).sendMessagePromise(V.joinStage,void 0,void 0,V.peerStageStatusUpdate)}leaveStage(t){const e={userIds:[t]};return d(this,$t).sendMessagePromise(V.leaveStage,Kf.toBinary(e),void 0,V.peerStageStatusUpdate)}kick(t){const e={userIds:t};return d(this,$t).sendMessagePromise(V.leaveStage,Kf.toBinary(e))}on(t,e){let r;switch(t){case V.grantStageAccess:case V.denyStageAccess:{r=void 0;break}case V.getStagePeers:{r=Jf.fromBinary.bind(Jf);break}case V.getStageRequests:case V.requestStageAccess:case V.cancelStageRequest:{r=Ql.fromBinary.bind(Ql);break}case V.peerStageStatusUpdate:{r=If.fromBinary.bind(If);break}}d(this,$t).on(t,({payload:n,id:i})=>{if(!n||!r)return e(void 0,i);const a=r(n);return e(a,i)})}async getPeerInfo(t){const e=await d(this,$t).sendMessagePromise(V.getPeerInfo,Of.toBinary({peerId:t}));return Yn.fromBinary(e.payload)}}$t=new WeakMap;class LO{constructor(t){S(this,nt,void 0);T(this,nt,t)}addPlugin(t,e){d(this,nt).sendMessage(G.addPlugin,cA.toBinary({pluginId:t,staggered:e}))}removePlugin(t){d(this,nt).sendMessage(G.removePlugin,lA.toBinary({pluginId:t,staggered:!1}))}async getActivePlugins(){const{payload:t}=await d(this,nt).sendMessagePromise(G.getPlugins);return t?OA.fromBinary(t):{plugins:[]}}customPluginEventToRoom(t,e,r){const n={pluginId:t,pluginData:new TextEncoder().encode(JSON.stringify(e))};d(this,nt).sendMessage(G.customPluginEventToRoom,_A.toBinary(n),r)}customPluginEventToPeers(t,e,r,n){const i={pluginId:t,peerIds:e,pluginData:new TextEncoder().encode(JSON.stringify(r))};d(this,nt).sendMessage(G.customPluginEventToPeers,EA.toBinary(i),n)}enablePluginForRoom(t,e){d(this,nt).sendMessage(G.enablePluginForRoom,hA.toBinary({pluginId:t}),e)}enablePluginForPeers(t,e,r){d(this,nt).sendMessage(G.enablePluginForPeers,gA.toBinary({pluginId:t,peerIds:e}),r)}disablePluginForRoom(t,e){d(this,nt).sendMessage(G.disablePluginForRoom,mA.toBinary({pluginId:t}),e)}disablePluginForPeers(t,e,r){d(this,nt).sendMessage(G.disablePluginForPeers,yA.toBinary({pluginId:t,peerIds:e}),r)}storeInsertKeys(t,e,r,n){const i={pluginId:t,storeName:e,insertKeys:r.map(a=>({storeKey:a.key,payload:new TextEncoder().encode(JSON.stringify(a.payload))}))};d(this,nt).sendMessage(G.storeInsertKeys,Hf.toBinary(i),n)}storeGetKeys(t,e,r,n){const i={pluginId:t,storeName:e,getKeys:r.map(a=>({storeKey:a.key}))};d(this,nt).sendMessage(G.storeGetKeys,PA.toBinary(i),n)}storeDeleteKeys(t,e,r,n){const i={pluginId:t,storeName:e,deleteKeys:r.map(a=>({storeKey:a.key}))};d(this,nt).sendMessage(G.storeDeleteKeys,kA.toBinary(i),n)}storeDelete(t,e,r){d(this,nt).sendMessage(G.storeDelete,AA.toBinary({pluginId:t,storeName:e}),r)}getPluginDataOld(t,e){l.info("getPluginDataOld",{plugin:{id:t,storeName:e}})}storePluginDataOld(t,e,r){const n={pluginId:t,storeName:e,insertKeys:[{storeKey:r.key,payload:new TextEncoder().encode(JSON.stringify(r))}]};d(this,nt).sendMessage(G.storeInsertKeys,Hf.toBinary(n))}on(t,e){let r;switch(t){case G.addPlugin:case G.enablePluginForPeers:case G.enablePluginForRoom:{r=Yl.fromBinary.bind(Yl);break}case G.removePlugin:case G.disablePluginForPeers:case G.disablePluginForRoom:{r=qf.fromBinary.bind(qf);break}case G.customPluginEventToPeers:case G.customPluginEventToRoom:{r=Gf.fromBinary.bind(Gf);break}case G.storeInsertKeys:case G.storeGetKeys:case G.storeDeleteKeys:case G.storeDelete:{r=jf.fromBinary.bind(jf);break}}d(this,nt).on(t,({payload:n,id:i})=>{const a=r(n);return e(a,i)})}}nt=new WeakMap;var FO=Object.defineProperty,xO=(s,t,e)=>t in s?FO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,UO=(s,t,e)=>(xO(s,typeof t!="symbol"?t+"":t,e),e),Au=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)},L=(s,t,e)=>(Au(s,t,"read from private field"),e?e.call(s):t.get(s)),De=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},ve=(s,t,e,r)=>(Au(s,t,"write to private field"),r?r.call(s,e):t.set(s,e),e),Fe=(s,t,e)=>(Au(s,t,"access private method"),e),ys,_n,Sn,qe,En,xe,Ke,Ts,ot,Gr,_s,pr,hi,Wr,Mu,zg,wa,ed,Du,Yg,Ou,Qg,td,Nu,Lu,Xg,Ca,rd,ba,sd,nd,Fu,pi,Pa,Ra,id,xu={exports:{}},mi=typeof Reflect=="object"?Reflect:null,Zg=mi&&typeof mi.apply=="function"?mi.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)},ad;mi&&typeof mi.ownKeys=="function"?ad=mi.ownKeys:Object.getOwnPropertySymbols?ad=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:ad=function(t){return Object.getOwnPropertyNames(t)};function $O(s){console&&console.warn&&console.warn(s)}var ev=Number.isNaN||function(t){return t!==t};function Se(){Se.init.call(this)}xu.exports=Se,xu.exports.once=qO,Se.EventEmitter=Se,Se.prototype._events=void 0,Se.prototype._eventsCount=0,Se.prototype._maxListeners=void 0;var tv=10;function od(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(Se,"defaultMaxListeners",{enumerable:!0,get:function(){return tv},set:function(s){if(typeof s!="number"||s<0||ev(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");tv=s}}),Se.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Se.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||ev(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function rv(s){return s._maxListeners===void 0?Se.defaultMaxListeners:s._maxListeners}Se.prototype.getMaxListeners=function(){return rv(this)},Se.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var n=t==="error",i=this._events;if(i!==void 0)n=n&&i.error===void 0;else if(!n)return!1;if(n){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=i[t];if(c===void 0)return!1;if(typeof c=="function")Zg(c,this,e);else for(var u=c.length,h=ov(c,u),r=0;r<u;++r)Zg(h[r],this,e);return!0};function sv(s,t,e,r){var n,i,a;if(od(e),i=s._events,i===void 0?(i=s._events=Object.create(null),s._eventsCount=0):(i.newListener!==void 0&&(s.emit("newListener",t,e.listener?e.listener:e),i=s._events),a=i[t]),a===void 0)a=i[t]=e,++s._eventsCount;else if(typeof a=="function"?a=i[t]=r?[e,a]:[a,e]:r?a.unshift(e):a.push(e),n=rv(s),n>0&&a.length>n&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=s,o.type=t,o.count=a.length,$O(o)}return s}Se.prototype.addListener=function(t,e){return sv(this,t,e,!1)},Se.prototype.on=Se.prototype.addListener,Se.prototype.prependListener=function(t,e){return sv(this,t,e,!0)};function VO(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function nv(s,t,e){var r={fired:!1,wrapFn:void 0,target:s,type:t,listener:e},n=VO.bind(r);return n.listener=e,r.wrapFn=n,n}Se.prototype.once=function(t,e){return od(e),this.on(t,nv(this,t,e)),this},Se.prototype.prependOnceListener=function(t,e){return od(e),this.prependListener(t,nv(this,t,e)),this},Se.prototype.removeListener=function(t,e){var r,n,i,a,o;if(od(e),n=this._events,n===void 0)return this;if(r=n[t],r===void 0)return this;if(r===e||r.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if(typeof r!="function"){for(i=-1,a=r.length-1;a>=0;a--)if(r[a]===e||r[a].listener===e){o=r[a].listener,i=a;break}if(i<0)return this;i===0?r.shift():BO(r,i),r.length===1&&(n[t]=r[0]),n.removeListener!==void 0&&this.emit("removeListener",t,o||e)}return this},Se.prototype.off=Se.prototype.removeListener,Se.prototype.removeAllListeners=function(t){var e,r,n;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[t]),this;if(arguments.length===0){var i=Object.keys(r),a;for(n=0;n<i.length;++n)a=i[n],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=r[t],typeof e=="function")this.removeListener(t,e);else if(e!==void 0)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this};function iv(s,t,e){var r=s._events;if(r===void 0)return[];var n=r[t];return n===void 0?[]:typeof n=="function"?e?[n.listener||n]:[n]:e?HO(n):ov(n,n.length)}Se.prototype.listeners=function(t){return iv(this,t,!0)},Se.prototype.rawListeners=function(t){return iv(this,t,!1)},Se.listenerCount=function(s,t){return typeof s.listenerCount=="function"?s.listenerCount(t):av.call(s,t)},Se.prototype.listenerCount=av;function av(s){var t=this._events;if(t!==void 0){var e=t[s];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}Se.prototype.eventNames=function(){return this._eventsCount>0?ad(this._events):[]};function ov(s,t){for(var e=new Array(t),r=0;r<t;++r)e[r]=s[r];return e}function BO(s,t){for(;t+1<s.length;t++)s[t]=s[t+1];s.pop()}function HO(s){for(var t=new Array(s.length),e=0;e<t.length;++e)t[e]=s[e].listener||s[e];return t}function qO(s,t){return new Promise(function(e,r){function n(a){s.removeListener(t,i),r(a)}function i(){typeof s.removeListener=="function"&&s.removeListener("error",n),e([].slice.call(arguments))}cv(s,t,i,{once:!0}),t!=="error"&&jO(s,n,{once:!0})})}function jO(s,t,e){typeof s.on=="function"&&cv(s,"error",t,e)}function cv(s,t,e,r){if(typeof s.on=="function")r.once?s.once(t,e):s.on(t,e);else if(typeof s.addEventListener=="function")s.addEventListener(t,function n(i){r.once&&s.removeEventListener(t,n),e(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var GO=xu.exports;class WO extends _{constructor(){super("message.v1.SocketMessage",[{no:1,name:"event",kind:"scalar",T:13},{no:2,name:"id",kind:"scalar",opt:!0,T:9},{no:3,name:"payload",kind:"scalar",opt:!0,T:12},{no:4,name:"metadata",kind:"scalar",opt:!0,T:12}])}}const dv=new WO;class lv{static encode(t){return dv.toBinary(t)}static decode(t){return dv.fromBinary(new Uint8Array(t))}}function JO(s,t){return Math.floor(Math.random()*(t-s+1)+s)}class KO{constructor(t={}){UO(this,"opts"),De(this,ys,void 0),this.opts={initialTimeout:t.initialTimeout||1e3,maxTimeout:t.maxTimeout||1e4,factor:t.factor||2},ve(this,ys,0)}async wait(){ve(this,ys,L(this,ys)+1);const t=JO(0,Math.min(this.opts.maxTimeout,this.opts.initialTimeout*2**L(this,ys)));await new Promise(e=>{setTimeout(e,t)})}getAttempts(){return L(this,ys)}reset(){ve(this,ys,0)}}ys=new WeakMap;const Ss={debug:0,info:1,warn:2,error:3};class zO{constructor(t){De(this,_n,void 0),De(this,Sn,void 0),ve(this,_n,console),ve(this,Sn,t)}debug(...t){Ss[L(this,Sn)]>Ss.debug||L(this,_n).debug("[Sockrates]:",...t)}info(...t){Ss[L(this,Sn)]>Ss.info||L(this,_n).info("[Sockrates]:",...t)}warn(...t){Ss[L(this,Sn)]>Ss.warn||L(this,_n).warn("[Sockrates]:",...t)}error(...t){Ss[L(this,Sn)]>Ss.error||L(this,_n).error("[Sockrates]:",...t)}}_n=new WeakMap,Sn=new WeakMap;var uv=(s=>(s[s.CONNECTING=0]="CONNECTING",s[s.OPEN=1]="OPEN",s[s.CLOSING=2]="CLOSING",s[s.CLOSED=3]="CLOSED",s))(uv||{});const YO="2",QO="3";class XO{constructor(t,e){De(this,Mu),De(this,wa),De(this,Du),De(this,Ou),De(this,td),De(this,Lu),De(this,Ca),De(this,ba),De(this,nd),De(this,pi),De(this,Ra),De(this,qe,void 0),De(this,En,void 0),De(this,xe,void 0),De(this,Ke,void 0),De(this,Ts,void 0),De(this,ot,void 0),De(this,Gr,void 0),De(this,_s,void 0),De(this,pr,void 0),De(this,hi,void 0),De(this,Wr,void 0);var r,n,i,a,o,c,u,h,p,f,v,y,P,k,I,x,$,O,K;ve(this,En,t),ve(this,Ts,[]),ve(this,ot,new GO),ve(this,Gr,!0),ve(this,pr,!1),ve(this,xe,e!=null?e:{}),(n=(r=L(this,xe)).autoReconnect)!=null||(r.autoReconnect=!0),(a=(i=L(this,xe)).retryConnectionInterval)!=null||(i.retryConnectionInterval=1e3),(c=(o=L(this,xe)).pingTimeout)!=null||(o.pingTimeout=3e4),(h=(u=L(this,xe)).connectionTimeout)!=null||(u.connectionTimeout=5e3),(f=(p=L(this,xe)).debug)!=null||(p.debug=!0),(y=(v=L(this,xe)).maxReconnectionAttempts)!=null||(v.maxReconnectionAttempts=10),(k=(P=L(this,xe)).disconnectOnPingTimeout)!=null||(P.disconnectOnPingTimeout=!0),(x=(I=L(this,xe)).queueOnDisconnect)!=null||(I.queueOnDisconnect=!1),(O=($=L(this,xe)).flushOnReconnect)!=null||($.flushOnReconnect=!1),ve(this,_s,{code:void 0,reason:void 0}),ve(this,Ke,(K=L(this,xe).logger)!=null?K:new zO(L(this,xe).debug?"debug":"info")),ve(this,Wr,new KO)}get readyState(){var t;return(t=L(this,qe))==null?void 0:t.readyState}get url(){return L(this,En)}updateURL(t){ve(this,En,t),Fe(this,Lu,Xg).call(this)}get config(){return L(this,xe)}get sendQueue(){return L(this,Ts)}flush(){if(!L(this,xe).queueOnDisconnect)return!1;const t=[];return L(this,Ts).forEach(e=>{this.send(e.event,e.id,e.payload,e.metadata)||t.push(e)}),ve(this,Ts,t),L(this,Ts)}async connect(t=!1){if(!t&&[0,1].includes(this.readyState)){L(this,Ke).debug("Websocket was already connecting or connected.");return}if(L(this,Gr)!==!1)return new Promise((e,r)=>{Fe(this,pi,Pa).call(this),Fe(this,Ra,id).call(this);try{ve(this,qe,new WebSocket(Fe(this,Mu,zg).call(this,L(this,En)))),L(this,qe).binaryType="arraybuffer",L(this,Ke).debug("Connecting to",L(this,En));const n=setTimeout(()=>{L(this,Ke).debug("Connection timeout. Closing socket"),ve(this,Gr,!0),Fe(this,Ra,id).call(this),L(this,qe).close(3001,"Connection Timeout"),L(this,xe).autoReconnect&&!L(this,pr)&&(L(this,ot).emit("reconnecting"),Fe(this,Ca,rd).call(this)),r(new Error("Connection timed out!"))},L(this,xe).connectionTimeout);L(this,qe).onopen=()=>{L(this,Ke).debug(`Ready State: ${uv[L(this,qe).readyState]}`),n&&clearTimeout(n),Fe(this,nd,Fu).call(this),ve(this,_s,{code:void 0,reason:void 0}),L(this,ot).emit("connected"),L(this,xe).flushOnReconnect&&this.flush(),e()},L(this,qe).onclose=i=>{try{n&&clearTimeout(n);const{code:a,reason:o}=i;r(o),L(this,Ke).debug("Socket closed. Close event:",i),L(this,Ke).debug("Connection closed code:",a),L(this,Ke).debug("Connection closed reason:",o),L(this,pr)||Fe(this,td,Nu).call(this,a,o)}catch(a){Fe(this,wa,ed).call(this,a)}},L(this,qe).onerror=i=>{Fe(this,wa,ed).call(this,i)},L(this,qe).onmessage=i=>Fe(this,Du,Yg).call(this,i)}catch(n){Fe(this,wa,ed).call(this,n,r)}})}send(t,e,r,n){const i={event:t,id:e,payload:r,metadata:n};if(L(this,xe).queueOnDisconnect&&(!L(this,qe)||L(this,qe).readyState!==1))return L(this,Ke).debug("Queuing message since socket is not connected!",i),L(this,Ts).push(i),!1;const a=lv.encode(i);return Fe(this,ba,sd).call(this,a)}emit(t,e,r,n){return this.send(t,e,r,n)}sendRaw(t){return Fe(this,ba,sd).call(this,t)}receive(t,e){return L(this,ot).on(t.toString(),e)}on(t,e){if(typeof t=="string"&&(t==="connected"||t==="disconnected"||t==="errored"||t==="reconnected"||t==="reconnecting"||t==="reconnectAttempt"||t==="reconnectFailure"||t==="failed")){L(this,ot).on(t,e);return}this.receive(t,e)}removeAllListeners(){L(this,ot).removeAllListeners()}removeReceiver(t,e){this.removeListener(t,e)}removeListener(t,e){L(this,ot).removeListener(t.toString(),e)}removeReceivers(t){this.removeListeners(t)}removeListeners(t){L(this,ot).listeners(t.toString()).map(e=>this.removeListener(t,e))}disconnect(){ve(this,Gr,!1),Fe(this,pi,Pa).call(this),this.removeAllListeners(),ve(this,_s,{code:1e3,reason:"Sockrates disconnect method called"}),L(this,qe).close(1e3,"Sockrates disconnect method called.")}}qe=new WeakMap,En=new WeakMap,xe=new WeakMap,Ke=new WeakMap,Ts=new WeakMap,ot=new WeakMap,Gr=new WeakMap,_s=new WeakMap,pr=new WeakMap,hi=new WeakMap,Wr=new WeakMap,Mu=new WeakSet,zg=function(s){if(s.startsWith("ws://")||s.startsWith("wss://"))return s;if(s.startsWith("https://"))return`wss://${s.substring(8)}`;if(s.startsWith("http://"))return`ws://${s.substring(7)}`;throw new Error("Invalid URL. URL must start with http(s):// or ws(s)://.")},wa=new WeakSet,ed=function(s,t){L(this,Ke).error("Error:",{error:s}),L(this,ot).emit("errored",{error:s}),t==null||t(s)},Du=new WeakSet,Yg=function(s){if(Fe(this,nd,Fu).call(this),s.data===YO){L(this,Ke).debug("Received ping from server"),Fe(this,ba,sd).call(this,QO);return}const t=lv.decode(s.data),{id:e,payload:r}=t;L(this,Ke).debug("Received message",{event:t.event,messageID:e}),L(this,ot).emit(t.event.toString(),{id:e,payload:r})},Ou=new WeakSet,Qg=function(){return L(this,qe).readyState===1},td=new WeakSet,Nu=function(s,t){ve(this,_s,{reason:t,code:s}),L(this,ot).emit("disconnected",{code:s,reason:t})},Lu=new WeakSet,Xg=function(){const{reason:s,code:t}=L(this,_s);t&&t!==1e3&&L(this,Gr)&&L(this,xe).autoReconnect&&!L(this,pr)&&(L(this,Ke).debug(`Triggering reconnection due to ${s}.`),L(this,ot).emit("reconnecting"),Fe(this,Ca,rd).call(this))},Ca=new WeakSet,rd=async function(s=!0){if(s&&L(this,pr)){L(this,Ke).debug("Reconnect called when already in a reconnect loop. Ignoring.");return}if(L(this,pr)||L(this,Wr).reset(),L(this,xe).maxReconnectionAttempts!==null&&L(this,Wr).getAttempts()>=L(this,xe).maxReconnectionAttempts){L(this,ot).emit("failed"),ve(this,pr,!1);return}ve(this,pr,!0),Fe(this,Ra,id).call(this),Fe(this,pi,Pa).call(this);try{if(await L(this,Wr).wait(),L(this,Gr)===!1)return;if(L(this,Ke).debug(`Reconnection attempt ${L(this,Wr).getAttempts()}`),L(this,ot).emit("reconnectAttempt",{attempt:L(this,Wr).getAttempts()}),await this.connect(),!Fe(this,Ou,Qg).call(this))throw Error("Reconnect Failed");ve(this,pr,!1),ve(this,_s,{code:void 0,reason:void 0}),L(this,ot).emit("reconnected")}catch(t){L(this,Ke).debug("Failed to reconnect."),L(this,ot).emit("reconnectFailure",{attempt:L(this,Wr).getAttempts()}),Fe(this,Ca,rd).call(this,!1)}},ba=new WeakSet,sd=function(s){try{return L(this,qe).send(s),!0}catch(t){return L(this,Ke).error(t.message),!1}},nd=new WeakSet,Fu=function(){this.config.disconnectOnPingTimeout&&(L(this,Ke).debug("Resetting ping timeout"),Fe(this,pi,Pa).call(this),ve(this,hi,setTimeout(()=>{var s;L(this,Ke).debug("Disconnecting the socket due to ping timeout"),ve(this,Gr,!0);const t=3002,e="Ping timeout";(s=L(this,qe))==null||s.close(t,e),Fe(this,td,Nu).call(this,t,e)},L(this,xe).pingTimeout)))},pi=new WeakSet,Pa=function(){L(this,hi)&&(clearTimeout(L(this,hi)),ve(this,hi,void 0))},Ra=new WeakSet,id=function(){L(this,qe)&&(L(this,qe).onopen=void 0,L(this,qe).onerror=void 0,L(this,qe).onmessage=void 0,L(this,qe).onclose=void 0)};var ZO=Object.defineProperty,eN=Object.getOwnPropertyDescriptor,cd=(s,t,e,r)=>{for(var n=r>1?void 0:r?eN(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&ZO(t,e,n),n};const hv=65535,pv=(xv=class{constructor(s,{peerId:t,meetingId:e,authToken:r,capabilities:n}){S(this,ho);S(this,po);S(this,js,void 0);S(this,Be,void 0);m(this,"roomName");m(this,"authToken");m(this,"capabilities");m(this,"connectionState");m(this,"joinAttempted");S(this,Gs,void 0);var i;if(!t||!e||!r)throw new b("peerId, roomName, or authToken can not be empty");this.joinAttempted=!1,T(this,Gs,s),this.capabilities=n,this.roomName=e,this.authToken=r,this.connectionState={state:void 0,reconnected:!1,reconnectionAttempt:void 0},T(this,js,le(this,ho,zu).call(this,t)),T(this,Be,new XO(d(this,js),{autoReconnect:!0,disconnectOnPingTimeout:(i=n.includes("PING"))!=null?i:!1,queueOnDisconnect:!0,flushOnReconnect:!1,logger:l}))}get peerId(){return d(this,Gs).getValue("peerId")}updateURL(s){s!==this.peerId&&(T(this,js,le(this,ho,zu).call(this,s)),l.debug("SocketService:: Connection URL updated.")),d(this,Be).updateURL(d(this,js))}static getSocketEdgeDomain(s){return zn({servicePrefix:"socket-edge",baseURI:s})}get url(){return d(this,js)}async connect(){await d(this,Be).connect(),this.connectionState={state:"connected",reconnected:!1,reconnectionAttempt:void 0}}async disconnect(){d(this,Be).disconnect(),this.connectionState={state:"disconnected",reconnected:!1,reconnectionAttempt:void 0}}get isConnected(){try{return d(this,Be).readyState===1}catch(s){return!1}}sendMessage(s,t,e){const r={};return g.injectContext(r),d(this,Be).send(s,e!=null?e:le(this,po,Yu).call(this),t,new TextEncoder().encode(JSON.stringify(r)))}sendMessagePromise(s,t,e,r){const n=parseInt({}.SOCKET_SERVICE_MESSAGE_REQUEST_TIMEOUT,10)||2e4;return this.sendMessagePromiseWithTimeout({event:s,timeout:n,protobuf:t,messageId:e,resp:r})}sendMessagePromiseWithTimeout({event:s,timeout:t,protobuf:e,messageId:r,resp:n}){const i=n!=null?n:s;return new Promise((a,o)=>{const c=(v,y)=>{d(this,Be).removeListener(i,v),d(this,Be).removeListener(hv,y),d(this,Be).removeListener(se.errorResponse,y),d(this,Be).removeListener(ne.errorResponse,y)},u=r!=null?r:le(this,po,Yu).call(this),h={};g.injectContext(h);const p=({id:v,payload:y})=>{if(u===v){let P;try{const k=OP.fromBinary(y);P=new Error(k.errorMessage)}catch(k){P=new Error("failed to parse error message",{cause:k});try{const I=CR.fromBinary(y);P=new Error(I.message)}catch(I){P=new Error("failed to parse error message",{cause:I})}}o(P),c(f,p)}},f=({id:v,payload:y})=>{u===v&&(a({id:v,payload:y}),c(f,p))};d(this,Be).on(i,f),d(this,Be).on(hv,p),d(this,Be).on(se.errorResponse,p),d(this,Be).on(ne.errorResponse,p),setTimeout(()=>{c(f,p),o(new Error(`request timeout for callback eventId:${s}`))},t),d(this,Be).send(s,u,e,new TextEncoder().encode(JSON.stringify(h)))})}on(s,t){d(this,Be).on(s,t)}onStateEvent(s,t){d(this,Be).on(s,t)}removeListener(s,t){d(this,Be).removeListener(s,t)}removeListeners(s){d(this,Be).removeListeners(s)}flush(){return d(this,Be).flush()}},js=new WeakMap,Be=new WeakMap,Gs=new WeakMap,ho=new WeakSet,zu=function(s){let t=pv.getSocketEdgeDomain(d(this,Gs).getValue("baseURI"));typeof Al(d(this,Gs),"socket_server_base")=="string"&&(t=Al(d(this,Gs),"socket_server_base"));const e=`wss://${t}`,r=new URL(`${e}/ws`),n=this.peerId,i={roomID:this.roomName,peerID:s,authToken:this.authToken,useMediaV2:!0,...n!==s&&{oldPeerID:n},ping:this.capabilities.includes("PING"),capabilities:this.capabilities.map(a=>Pc[a]).join(" "),joinWithDetails:!0};return Object.entries(i).forEach(([a,o])=>{r.searchParams.append(a,o.toString())}),r.href},po=new WeakSet,Yu=function(){return`${this.peerId}-${(Math.random()+1).toString(36).substring(7)}`},xv);let ka=pv;cd([g.trace("SocketService.connect")],ka.prototype,"connect",1),cd([g.trace("SocketService.disconnect")],ka.prototype,"disconnect",1),cd([g.trace("SocketService.sendMessagePromise")],ka.prototype,"sendMessagePromise",1),cd([g.trace("SocketService.sendMessagePromiseWithTimeout")],ka.prototype,"sendMessagePromiseWithTimeout",1);const Ws=class{static handleConnectedRoomsDumpRaw({payload:t}){var i;const e=QR.fromBinary(t),r=e.meetings.map(a=>{var o;return{id:a.id,title:a.title,participants:(o=a.participants)!=null?o:[]}});return{parentMeeting:{id:e.parentMeeting.id,title:e.parentMeeting.title,participants:(i=e.parentMeeting.participants)!=null?i:[]},meetings:r}}static handleTransferPeerRaw({payload:t}){const e=wk.fromBinary(t);return{authToken:e.authToken,meetingId:e.meetingId}}static handleMovedPeerRaw({payload:t}){const e=Ff.fromBinary(t);return{meetingId:e.meetingId,customParticipantId:e.customParticipantId}}static handleConnectedRoomsUpdatedRaw({payload:t}){return Lf.fromBinary(t).payloads.map(r=>({id:r.id,title:r.title}))}static handleConnectedRoomsDeletedRaw({payload:t}){return pk.fromBinary(t).payloads}static async getConnectedRoomsDump(){const t=await Ws.socketService.sendMessagePromise(V.getConnectedRoomsDump);return Ws.handleConnectedRoomsDumpRaw(t)}static async createConnectedRooms(t){const{payload:e}=await Ws.socketService.sendMessagePromise(V.createConnectedRooms,tk.toBinary({payloads:t}));return Lf.fromBinary(e).payloads.map(n=>({id:n.id,title:n.title}))}static async updateConnectedRooms(t){}static async disableConnectedRooms(t){const e=t.map(n=>({id:n})),r=await Ws.socketService.sendMessagePromise(V.deleteConnectedRooms,uk.toBinary({payloads:e}));return Ws.handleConnectedRoomsDeletedRaw(r)}static async movePeersBetweenRooms(t){try{const e=await Ws.socketService.sendMessagePromise(V.movePeers,Tk.toBinary({sourceMeetingId:t.sourceMeetingId,destinationMeetingId:t.destinationMeetingId,participants:t.participants}));return new TextDecoder().decode(e.payload).includes("error")?{success:!1,error:"failed to move participants"}:{success:!0}}catch(e){return{success:!1,error:e}}}};let Oe=Ws;m(Oe,"socketService"),m(Oe,"currentMeetingId");function tN(s,t=2){return s.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w\s]/g,"").trim().split(/\s+/).slice(0,t).map(n=>n.charAt(0)).join("").toUpperCase()}const mv=1080,fv=1920,rN=(s,t,e,r,n,i)=>{let a=.5,o=.5;const c=n,u=i,h=Math.min(e/c,r/u);let p=c*h,f=u*h,v,y,P,k,I=1;return p<e&&(I=e/p),Math.abs(I-1)<1e-14&&f<r&&(I=r/f),p*=I,f*=I,P=c/(p/e),k=u/(f/r),v=(c-P)*a,y=(u-k)*o,v<0&&(v=0),y<0&&(y=0),P>c&&(P=c),k>u&&(k=u),[v,y,P,k,s,t,e,r]},Bu=class extends Ht{constructor(e,r,n,i){super();S(this,rr,void 0);S(this,Ki,void 0);S(this,wt,void 0);S(this,sr,void 0);S(this,je,{height:mv,width:fv});S(this,vr,{brand:"#2160FD",background:"#141414",text:"#000000",videoBackground:"#191919",textOnBrand:"#EEEEEE"});S(this,ns,void 0);S(this,kt,{});S(this,tt,void 0);S(this,zi,void 0);S(this,Yi,void 0);S(this,is,void 0);S(this,Qi,!1);m(this,"cleanupEventListeners",()=>{d(this,Ki).unsubscribe("stageStatus",this.handlePipMediaControls),d(this,tt).removeListener("videoUpdate",this.onSelfVideoUpdateListener),d(this,tt).removeListener("audioUpdate",this.onSelfAudioUpdateListener),d(this,tt).removeListener("roomLeft",()=>this.disable())});m(this,"enablePipMediaControls",()=>{this.mountAudioEvents(),this.mountVideoEvents()});m(this,"onSelfVideoUpdateListener",({videoEnabled:e})=>{this.updateMediaSession("CAMERA",e)});m(this,"onSelfAudioUpdateListener",({audioEnabled:e})=>{this.updateMediaSession("MIC",e)});m(this,"handlePipMediaControls",e=>{e==="ON_STAGE"?this.enablePipMediaControls():this.unmountEvents()});m(this,"eventCallback",e=>{e==="CAMERA"&&(d(this,tt).videoEnabled?d(this,tt).disableVideo():d(this,tt).enableVideo(),this.emit("cameraToggled")),e==="MIC"&&(d(this,tt).audioEnabled?d(this,tt).disableAudio():d(this,tt).enableAudio(),this.emit("micToggled")),e==="END"&&(w.emit(C.PIP_HANGUP),this.cleanupEventListeners(),this.emit("hangup"),this.cleanup())});m(this,"unmountEvents",()=>{navigator.mediaSession===void 0||navigator.mediaSession.setCameraActive===void 0||(navigator.mediaSession.setActionHandler("togglemicrophone",void 0),navigator.mediaSession.setActionHandler("togglecamera",void 0))});m(this,"animate",()=>{if(!this.isActive&&d(this,is)==="active"){this.disable(!0);return}d(this,kt)!==void 0&&this.paintCanvas(),d(this,ns)!==void 0&&T(this,ns,requestAnimationFrame(()=>this.animate()))});m(this,"disable",(e=!1)=>{T(this,is,"idle"),this.cleanupEventListeners(),cancelAnimationFrame(d(this,ns)),e!==!0&&document.body.removeChild(d(this,wt)),T(this,ns,void 0),document.pictureInPictureElement&&document.exitPictureInPicture()});T(this,Ki,e),T(this,is,"idle"),T(this,tt,r),T(this,vr,{brand:r.config.designTokens.colors.brand[500],background:r.config.designTokens.colors.background[1e3],text:r.config.designTokens.colors.text,videoBackground:r.config.designTokens.colors.videoBg,textOnBrand:r.config.designTokens.colors.textOnBrand}),n&&this.setupIcon("pin",n),i&&this.setupIcon("handRaise",i)}static async _init(e,r){let n,i;try{n=await hc(sb),i=await hc(nb)}catch(a){}return new Bu(e,r,n,i)}async setupIcon(e,r){switch(e){case"handRaise":T(this,Yi,r);break;case"pin":T(this,zi,r);break}}async overrideIcon(e,r){switch(e){case"handRaise":T(this,Yi,await hc(r));break;case"pin":T(this,zi,await hc(r));break}}constructImage(e){const r=new Image,n=new Blob([e],{type:"image/svg+xml"}),i=window.URL.createObjectURL(n);return new Promise(a=>{r.onload=()=>{a(r),window.URL.revokeObjectURL(i)},r.src=i})}createVideoContainer(){T(this,wt,document.createElement("div")),d(this,wt).style.width="0.1px",d(this,wt).style.height="0.1px",d(this,wt).style.overflow="hidden",d(this,wt).style.position="absolute",d(this,wt).style.bottom="0",d(this,wt).style.right="0",d(this,wt).style.opacity="0",d(this,wt).appendChild(d(this,sr))}setupEventListeners(){d(this,Ki).subscribe("stageStatus",this.handlePipMediaControls),d(this,tt).addListener("videoUpdate",this.onSelfVideoUpdateListener),d(this,tt).addListener("audioUpdate",this.onSelfAudioUpdateListener),d(this,tt).addListener("roomLeft",()=>this.disable())}createCanvas(){const e=document.createElement("canvas");e.height=d(this,je).height,e.width=d(this,je).width,T(this,rr,e)}setupMediaSessionEvents(){navigator.mediaSession===void 0||navigator.mediaSession.setCameraActive===void 0||(navigator.mediaSession.setActionHandler("hangup",()=>{this.eventCallback("END")}),this.mountAudioEvents(),this.mountVideoEvents())}mountAudioEvents(){navigator.mediaSession===void 0||navigator.mediaSession.setMicrophoneActive===void 0||d(this,tt).permissions.canProduceAudio&&navigator.mediaSession.setActionHandler("togglemicrophone",()=>{this.eventCallback("MIC")})}mountVideoEvents(){navigator.mediaSession===void 0||navigator.mediaSession.setCameraActive===void 0||d(this,tt).permissions.canProduceVideo&&navigator.mediaSession.setActionHandler("togglecamera",()=>{this.eventCallback("CAMERA")})}getSources(){const r=Object.values(d(this,kt)).reduce((n,i)=>(n[i.pinned?"pinned":"regular"].push(i),n),{pinned:[],regular:[]});return[...r.pinned,...r.regular]}drawEmptyTile(e,r,n,i){if(d(this,rr)===void 0)return;const a=d(this,rr).getContext("2d"),o=d(this,rr).width,c=0,u=0,h=r-c*2,p=n-c*2,f=Math.floor(o/h),v=Math.floor(e/f),P=e%f*(h+c)+c,k=v*(p+c)+c,{displayText:I,image:x}=i!=null?i:{};a.fillStyle=I||x?d(this,vr).videoBackground:d(this,vr).background,a.strokeStyle=d(this,vr).brand,a.beginPath(),a.moveTo(P+u,k),a.arcTo(P+h,k,P+h,k+u,u),a.arcTo(P+h,k+p,P+h-u,k+p,u),a.arcTo(P,k+p,P,k+p-u,u),a.arcTo(P,k,P+u,k,u),a.closePath(),a.fill(),a.stroke();const $=h/6,O=h/2+P,K=p/2+k;a.save(),(I||x)&&(a.beginPath(),a.arc(O,K,$,0,Math.PI*2),a.fillStyle=d(this,vr).brand,a.fill(),x?(a.clip(),a.drawImage(x,O-$,K-$,$*2,$*2),a.restore()):I&&(a.fillStyle=d(this,vr).textOnBrand,a.font=`${$/2}px sans-serif`,a.textAlign="center",a.textBaseline="middle",a.fillText(I,O,K)),this.drawIcons(i,P,k,Math.max(h,p)))}drawIcons(e,r,n,i){const a=Math.min(Math.max(i*.15,100),200),o=a*.2,c=a*.2;let u=r+o;const h=n+o,p=f=>{const v=d(this,rr).getContext("2d");v.save(),v.fillStyle=d(this,vr).background,v.beginPath(),v.moveTo(u+c,h),v.arcTo(u+a,h,u+a,h+c,c),v.arcTo(u+a,h+a,u+a-c,h+a,c),v.arcTo(u,h+a,u,h+a-c,c),v.arcTo(u,h,u+c,h,c),v.closePath(),v.fill(),typeof f=="string"?(v.font=`${a/1.5}px sans-serif`,v.fillStyle=d(this,vr).text,v.textAlign="center",v.textBaseline="top",v.fillText(f,a/2+u,h+o)):v.drawImage(f,u+o,h+o,a-o*2,a-o*2),u+=a+o,v.restore()};e.pinned&&p(d(this,zi)),e.handRaised&&p(d(this,Yi))}drawTile(e,r,n){var u,h;if(d(this,rr)===void 0)return;const i=d(this,rr).getContext("2d"),a=this.getSources();let o=0,c=0;for(;o<d(this,je).height-5;){let p=0;for(;p<d(this,je).width-5&&c<n;){if((u=a[c])!=null&&u.enabled){const f=a[c].element,[v,y,P,k,I,x,$,O]=rN(p,o,e,r,f.videoWidth,f.videoHeight);((h=f==null?void 0:f.classList)==null?void 0:h.contains("mirror"))?(i.save(),i.scale(-1,1),i.drawImage(f,v,y,P,k,-1*I,x,-1*$,O),i.restore()):i.drawImage(f,v,y,P,k,I,x,$,O),this.drawIcons(a[c],I,x,Math.max($,O))}else this.drawEmptyTile(c,e,r,a[c]);c+=1,p+=e}o+=r}}calcGridElemSize(e){switch(e){case 0:case 1:return[d(this,je).width,d(this,je).height];case 2:return[Math.floor(d(this,je).width/2),d(this,je).height];case 3:case 4:return[Math.floor(d(this,je).width/2),Math.floor(d(this,je).height/2)];case 5:case 6:return[Math.floor(d(this,je).width/3),Math.floor(d(this,je).height/2)];case 7:case 8:case 9:return[Math.floor(d(this,je).width/3),Math.floor(d(this,je).height/3)];default:return[Math.floor(d(this,je).width/3),Math.floor(d(this,je).height/2)]}}paintCanvas(){let e=this.getSources().length;e!==1&&(e=e%2>0?e+1:e);const[r,n]=this.calcGridElemSize(e);this.drawTile(r,n,e)}isSupported(){return!!window.chrome&&document.pictureInPictureEnabled}get isActive(){return document.pictureInPictureElement!==null}cleanup(){if(T(this,Qi,!1),this.isSupported()&&document.exitPictureInPicture!==void 0&&document.pictureInPictureElement!==null&&document.exitPictureInPicture(),d(this,wt))try{document.body.removeChild(d(this,wt))}catch(e){}this.removeAllSources(),T(this,rr,void 0),T(this,sr,void 0),T(this,ns,void 0)}init({height:e,width:r}={}){if(d(this,Qi))return;T(this,Qi,!0),this.createCanvas(),this.setupMediaSessionEvents();const n=document.createElement("video");T(this,je,{height:e!=null?e:mv,width:r!=null?r:fv}),n.height=d(this,je).height,n.width=d(this,je).width,n.autoplay=!0,n.muted=!0,n.srcObject=d(this,rr).captureStream(24),T(this,sr,n),d(this,sr).onloadedmetadata=()=>{try{this.emit("pipStarted"),d(this,sr).onleavepictureinpicture=()=>{this.emit("pipEnded")}}catch(i){this.emit("pipEnded")}},this.createVideoContainer(),this.paintCanvas()}updateMediaSession(e,r){navigator.mediaSession!==void 0&&(e==="CAMERA"&&navigator.mediaSession.setCameraActive!==void 0&&navigator.mediaSession.setCameraActive(r),e==="MIC"&&navigator.mediaSession.setMicrophoneActive!==void 0&&navigator.mediaSession.setMicrophoneActive(r))}enableSource(e){d(this,kt)[e]!==void 0&&(d(this,kt)[e].enabled=!0)}disableSource(e){d(this,kt)[e]!==void 0&&(d(this,kt)[e].enabled=!1)}async generateAvatar(e,r){const n=new Image,i=await fetch(r).then(o=>o.blob()),a=window.URL.createObjectURL(i);n.onload=()=>{this.updateSource(e,{image:n}),window.URL.revokeObjectURL(a)},n.src=a}addSource(e,r,n,i=!1,a=void 0,o=void 0,c=!1){l.info("DytePIP::AddSource",{pip:{id:e,handRaised:c}}),d(this,kt)[e]={id:e,element:r,enabled:n,pinned:i,displayText:a?tN(a):void 0,imageUrl:o,handRaised:c},o&&this.generateAvatar(e,o)}updateSource(e,r){l.info("DytePIP::UpdateSource",{pip:{id:e,handRaised:r.handRaised}});const n=d(this,kt)[e];n&&(d(this,kt)[e]={...n,...r})}removeSource(e){delete d(this,kt)[e]}removePinnedSource(){Object.values(d(this,kt)).forEach(r=>{r.pinned&&this.removeSource(r.id)})}removeAllSources(){T(this,kt,{})}enable(){T(this,is,"activating"),this.setupEventListeners(),this.updateMediaSession("CAMERA",d(this,tt).videoEnabled),this.updateMediaSession("MIC",d(this,tt).audioEnabled),document.body.appendChild(d(this,wt)),T(this,ns,requestAnimationFrame(()=>this.animate())),d(this,sr).onloadedmetadata=()=>{d(this,sr).requestPictureInPicture().then(()=>{T(this,is,"active")})},d(this,sr).readyState===4&&d(this,sr).requestPictureInPicture().then(()=>{T(this,is,"active")})}};let Uu=Bu;rr=new WeakMap,Ki=new WeakMap,wt=new WeakMap,sr=new WeakMap,je=new WeakMap,vr=new WeakMap,ns=new WeakMap,kt=new WeakMap,tt=new WeakMap,zi=new WeakMap,Yi=new WeakMap,is=new WeakMap,Qi=new WeakMap;var sN=Object.defineProperty,nN=Object.getOwnPropertyDescriptor,dd=(s,t,e,r)=>{for(var n=r>1?void 0:r?nN(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&sN(t,e,n),n};const wn=class{constructor(s,t){m(this,"apiBase");m(this,"selfController");m(this,"pollController");m(this,"chatController");m(this,"metaController");m(this,"storesManager");m(this,"stageController");m(this,"pluginController");m(this,"internalsController");m(this,"recordingController");m(this,"livestreamController");m(this,"participantController");this.apiBase=s,this.storesManager=t.storesManager,this.metaController=t.metaController,this.selfController=t.selfController,this.chatController=t.chatController,this.pollController=t.pollController,this.stageController=t.stageController,this.pluginController=t.pluginController,this.recordingController=t.recordingController,this.internalsController=t.internalsController,this.participantController=t.participantController,this.livestreamController=t.livestreamController}static async init(s){var I;const{peerId:t,apiBase:e,authToken:r,meetingId:n,organizationId:i,cachedUserDetails:a}=s.getAllValues();if(w.reset(),Xc.cleanup(),Wg(s),we.isSupported()===!1)throw new b("Browser not supported","0010",!0);const o=LM(s,{authToken:r,baseURL:e,cachedUserDetails:a});o.setRoomName(n),o.setRoomUUID(n),o.setOrganizationId(i),o.setHeader("dyte-tracing-id",t),s.setValue("apiClient",o);const c=wn.createSocketService(s),u=c.connect(),h=o.getPlugins(),[{sfu:p,userResponse:f,meetingTitle:v,roomNodeUrl:y}]=await Promise.all([wn.getRoomMetadata(),wn.setupFlagsmith(s)]);g.location.country=(I=o.ipInfo)==null?void 0:I.country,s.setValue("roomNodeOptions",{sfu:p,meetingTitle:v,roomNodeUrl:y});const{theme:P,controllers:k}=await wn.setupControllers(c,s,f,h);a0(P)&&wn.createRoomNodeClient(s,c),hb();try{await u,k.selfController.partialMediaRoom()}catch(x){throw l.error("[Socket Service] Failed to connect to socket server:",{error:x}),new b("Failed to connect to websocket","0012")}return new wn(e,k)}static async getRoomMetadata(){const s=Je(),[{roomNodeUrl:t,meetingTitle:e,sfu:r=ci.HIVE},n]=await Promise.all([s.getRoomNodeData(),s.getUserDetails()]);return{sfu:r,roomNodeUrl:t,meetingTitle:e,userResponse:n}}static async setupFlagsmith(s){const{peerId:t,baseURI:e,overrides:r,meetingId:n,organizationId:i}=s.getAllValues(),a=lb(n),o={entity:kl.PEER,clientId:i,isAnonUser:!i,sdkVersion:s.getValue("sdkVersion"),meetingHash:a,roomName:n,...we.getDeviceInfo(),isReactNative:navigator.isReactNative};try{const c=r!=null&&r.whitelabelled_flags_endpoint?zn({servicePrefix:"flags",baseURI:e}):"edge.api.flagsmith.com";await j.identify(`${kl.PEER}_${t}`,JSON.parse(JSON.stringify(o)),!1,5e3,c),l.info("flagsmith::allFlags",{flags:JSON.stringify(j.getAllFlags())},!0)}catch(c){l.error("Failed to fetch flagsmith flags")}}static async setupControllers(s,t,e,r){var W,A,rt;const n=t.getValue("modules"),{preset:i,participant:a}=e,o=t.getValue("defaults"),{sfu:c,meetingTitle:u}=t.getValue("roomNodeOptions"),h=fu.init(i,!n.theme),{viewType:p,mediaConstraints:{audio:f}}=h;t.setValue("viewType",p),t.setValue("defaults",{mediaConfiguration:{audio:{enableHighBitrate:(W=f.enableHighBitrate)!=null?W:!1,enableStereo:(A=f.enableStereo)!=null?A:!1}},...o});const v=Ru.init(t,p,i.permissions);let y,P,k,I,x,$,O,K;const X=new MO(s);Oe.socketService=s;const oe=new Zc(s),Te=new Yt(s),It=new NO(s),Ue=Xc.create(s),At=new LO(s),M=new AO(s),E=new on(s),R=await Tn.init(t,Ue,a,v,h),B=await ng.init(t,R.self,Ue,X,u);if(n.participant&&(c===ci.CF&&(K=new Bg(t,R.self,Ue)),K=new Hg(t,R.self,Ue)),(rt=n.e2ee)!=null&&rt.enabled&&n.e2ee.manager.init(l,w),n.chat&&(P=await ur.init(t,Te,E,R.self,K.participants)),n.internals&&(x=await cu.init()),n.livestream&&h.viewType===Xe.Livestream&&j.hasFeature(J.LIVESTREAM)&&(O=new Pg(R.self,M)),h.viewType!==Xe.Chat){if(n.poll&&(y=await eg.init(t,R.self,oe)),n.recording&&($=new dg(t,R.self,Ue)),n.stage&&(k=new ig(t,It,Ue,R.self,K.participants)),n.plugin){if(!K)throw new b("The plugin module cannot be initialized without the `participant` module");const as=await r;I=await ga.init(t,as,At,Te,P==null?void 0:P.chat,R.self,K.participants)}if(n.pip){const as=await Uu._init(t,R.self);t.setValue("pip",as)}}const Qe={storesManager:new mD(t,At),pollController:y,selfController:R,metaController:B,chatController:P,stageController:k,pluginController:I,recordingController:$,internalsController:x,livestreamController:O,participantController:K};return{theme:h,permissions:v,controllers:Qe}}static async createRoomNodeClient(s,t){const{peerId:e,meetingId:r,authToken:n,roomNodeOptions:i}=s.getAllValues(),{sfu:a,roomNodeUrl:o,meetingTitle:c}=i;return Gg(s,{socket:t,peerId:e,meetingId:r,authToken:n,roomNodeUrl:o,meetingTitle:c},a)}static createSocketService(s){const{peerId:t,meetingId:e,authToken:r}=s.getAllValues(),n=["PING"];return new ka(s,{peerId:t,meetingId:e,authToken:r,capabilities:n})}};let Ia=wn;dd([g.trace("Controller.init")],Ia,"init",1),dd([g.trace("setupFlagsmith")],Ia,"setupFlagsmith",1),dd([g.trace("Controller.createSocketServiceAndRoomNodeClient")],Ia,"createRoomNodeClient",1),dd([g.trace("Controller.createSocketService")],Ia,"createSocketService",1);var iN=Object.defineProperty,aN=Object.getOwnPropertyDescriptor,oN=(s,t,e,r)=>{for(var n=r>1?void 0:r?aN(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&iN(t,e,n),n};class gv extends Ht{constructor(e,r){super();S(this,mo,void 0);m(this,"meetings",[]);m(this,"parentMeeting",null);S(this,Pd,void 0);T(this,Pd,e),T(this,mo,r.self)}get supportsConnectedMeetings(){return d(this,mo).id!==""&&j.hasFeature(J.CONNECTED_MEETINGS)}get isActive(){return this.meetings.length!==0}get currentMeetingId(){return Oe.currentMeetingId}validateConnectedMeetingsAction(){if(!this.supportsConnectedMeetings)throw new Error(`You are not allowed to perform this action.
Please connect with Dyte team to move you to V2 APIs & to enable connected meetings.`)}async getConnectedMeetings(){return this.validateConnectedMeetingsAction(),await Oe.getConnectedRoomsDump()}async createMeetings(e){return this.validateConnectedMeetingsAction(),(await Oe.createConnectedRooms(e)).map(n=>({id:n.id,title:n.title}))}async updateMeetings(e){this.validateConnectedMeetingsAction(),await Oe.updateConnectedRooms(e.map(r=>({meetingId:r.id,title:r.title})))}async deleteMeetings(e){this.validateConnectedMeetingsAction();const r=this.meetings.map(i=>e.includes(i.id)&&i.participants.length!==0?this.moveParticipants(i.id,this.parentMeeting.id,i.participants.map(a=>a.id)):Promise.resolve());return await Promise.all(r),await Oe.disableConnectedRooms(e)}async moveParticipants(e,r,n){this.validateConnectedMeetingsAction();const i=await Oe.movePeersBetweenRooms({sourceMeetingId:e,destinationMeetingId:r,participants:n.map(a=>({id:a}))});return i.success&&this.moveSuccessHandler(e,r,n),i}async moveParticipantsWithCustomPreset(e,r,n){this.validateConnectedMeetingsAction();const i=await Oe.movePeersBetweenRooms({sourceMeetingId:e,destinationMeetingId:r,participants:n});return i.success&&this.moveSuccessHandler(e,r,n.map(a=>a.id)),i}moveSuccessHandler(e,r,n){const i=new Map;[...this.parentMeeting.participants,...this.meetings.flatMap(a=>a.participants)].forEach(a=>i.set(a.id,a)),r===this.parentMeeting.id&&(this.parentMeeting.participants=this.parentMeeting.participants.concat(n.map(a=>i.get(a)))),e===this.parentMeeting.id&&(this.parentMeeting.participants=this.parentMeeting.participants.filter(a=>!n.includes(a.id))),this.meetings=this.meetings.map(a=>{if(r===a.id){const o=a.participants.concat(n.map(c=>i.get(c)));return{...a,participants:o}}if(e===a.id){const o=a.participants.filter(c=>!n.includes(c.id));return{...a,participants:o}}return a})}}mo=new WeakMap,Pd=new WeakMap,oN([Ot({maxInvocations:60,period:60})],gv.prototype,"getConnectedMeetings",1);var cN=Object.defineProperty,dN=Object.getOwnPropertyDescriptor,$u=(s,t,e,r)=>{for(var n=r>1?void 0:r?dN(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&cN(t,e,n),n};const Es=(Hu=class{constructor(s,t,e){m(this,"connectedMeetings");S(this,Xi,void 0);S(this,Js,void 0);S(this,Rd,void 0);T(this,Rd,s),T(this,Xi,e),this.connectedMeetings=new gv(s,t),this.setCurrentMeeting(t)}static init(s,t,e){return Es.instance||(Es.instance=new Es(s,t,e)),Es.instance.connectedMeetings.supportsConnectedMeetings&&(Es.instance.setupEvents(),t.self.once("roomJoined",()=>Es.instance.getConnectedMeetings())),Es.instance}setCurrentMeeting(s){T(this,Js,s),Oe.currentMeetingId=s.meta.meetingId}getConnectedMeetings(){this.connectedMeetings.getConnectedMeetings()}setupEvents(){Oe.socketService&&(Oe.socketService.on(V.getConnectedRoomsDump,this.handleConnectedRoomsDump.bind(this)),Oe.socketService.on(V.transferPeer,this.handleTransferPeer.bind(this)),Oe.socketService.on(V.movedPeer,this.handleMovedPeer.bind(this)),Oe.socketService.on(V.connectedRoomsUpdated,this.handleConnectedRoomsUpdated.bind(this)),Oe.socketService.on(V.connectedRoomsDeleted,this.handleConnectedRoomsDeleted.bind(this)))}handleTransferPeer(s){const t=Oe.handleTransferPeerRaw(s);return this.switchMeeting(t)}async switchMeeting({authToken:s,meetingId:t}){if(!this.connectedMeetings.supportsConnectedMeetings)throw new Error(`You are not allowed to perform this action.
Please connect with Dyte team to move you to V2 APIs & to enable connected meetings.`);this.connectedMeetings.emit("changingMeeting",t),await d(this,Js).leave("connected-meeting"),Oe.socketService=void 0;const e=await yv.init({...d(this,Xi),cachedUserDetails:null,defaults:{...d(this,Xi).defaults,video:d(this,Js).self.videoEnabled,audio:d(this,Js).self.audioEnabled},authToken:s});e.self.setName(d(this,Js).self.name);try{await e.join()}catch(r){g.addLogInCurrentSpan("error","ConnectedMeetingsController.joinRoom",{error:r})}return this.connectedMeetings.emit("meetingChanged",e),this.setCurrentMeeting(e),e}handleConnectedRoomsDump(s){const t=Oe.handleConnectedRoomsDumpRaw(s);this.connectedMeetings.meetings=t.meetings.map(e=>({id:e.id,title:e.title,participants:e.participants||[]})),this.connectedMeetings.parentMeeting={id:t.parentMeeting.id,title:t.parentMeeting.title,participants:t.parentMeeting.participants},this.emitStateUpdate()}handleMovedPeer(s){return Oe.handleMovedPeerRaw(s)}handleConnectedRoomsUpdated(s){const t=Oe.handleConnectedRoomsUpdatedRaw(s),e=new Map;this.connectedMeetings.meetings.forEach(r=>{e.set(r.id,r)}),t.forEach(r=>{e.has(r.id)?e.get(r.id).title=r.title:e.set(r.id,{...r,participants:[]})}),this.connectedMeetings.meetings=Array.from(e.values()),this.emitStateUpdate()}handleConnectedRoomsDeleted(s){const e=Oe.handleConnectedRoomsDeletedRaw(s).map(r=>r.id);this.connectedMeetings.meetings=this.connectedMeetings.meetings.filter(r=>!e.includes(r.id)),this.emitStateUpdate()}emitStateUpdate(){this.connectedMeetings.emit("stateUpdate",{meetings:this.connectedMeetings.meetings,parentMeeting:this.connectedMeetings.parentMeeting})}},Xi=new WeakMap,Js=new WeakMap,Rd=new WeakMap,m(Hu,"instance"),Hu);let ld=Es;$u([g.trace("ConnectedMeetingsController.getConnectedMeetings")],ld.prototype,"getConnectedMeetings",1),$u([g.trace("ConnectedMeetingsController.setupEvents")],ld.prototype,"setupEvents",1),$u([g.trace("ConnectedMeetingsController.switchMeeting")],ld.prototype,"switchMeeting",1);class lN{constructor(){m(this,"battery");m(this,"init",async()=>{try{"getBattery"in navigator&&(this.battery=await navigator.getBattery(),this.battery.addEventListener("chargingchange",this.updateChargeInfo),this.battery.addEventListener("levelchange",this.updateLevelInfo),this.updateLevelInfo(),this.updateChargeInfo())}catch(t){l.error("Error getting battery",t)}});m(this,"updateChargeInfo",()=>{var t;l.log(`Battery charging? ${(t=this.battery)!=null&&t.charging?"Yes":"No"}`)});m(this,"updateLevelInfo",()=>{if(!this.battery){l.log("Battery level: Not known");return}l.log(`Battery level: ${this.battery.level*100}%`)});m(this,"cleanup",()=>{var t,e;"getBattery"in navigator&&((t=this.battery)==null||t.removeEventListener("chargingchange",this.updateChargeInfo),(e=this.battery)==null||e.removeEventListener("levelchange",this.updateLevelInfo))})}}const vv=new lN;function uN(s,t){try{const{meetingId:e,orgId:r,participantId:n}=JSON.parse(atob(s.split(".")[1]));if(!e)throw Error(`Received V1 auth token ${s}`);let i="dyte.io";t&&(i=t);const a=`https://api.${i}`;return{meetingId:e,orgId:r,participantId:n,baseURI:i,apiBase:a}}catch(e){throw l.error("constants::decodeAuthToken",{error:e,debuggingHint:`Unable to decode auth token: ${s}`},!0),new b("Invalid auth token")}}var hN=Object.defineProperty,pN=Object.getOwnPropertyDescriptor,ud=(s,t,e,r)=>{for(var n=r>1?void 0:r?pN(t,e):t,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(r?a(t,e,n):a(n))||n);return r&&n&&hN(t,e,n),n};let ws=(Uv=class{constructor(t,e){S(this,kd);S(this,ct,void 0);S(this,fo,void 0);S(this,go,void 0);T(this,go,t),T(this,ct,e)}static async init(t){var h,p,f,v,y;ob(),we.init();const e=Ys();vv.init();const{authToken:r,baseURI:n}=t,{meetingId:i,...a}=uN(r,n);window.__zone_symbol__DISABLE_WRAPPING_UNCAUGHT_PROMISE_REJECTION=!0;const o=ws.setupContext(e,t,i,a);g.meetingMetadata.roomName=i,g.meetingMetadata.userId=a.participantId,g.meetingMetadata.organizationId=a.orgId,g.init(o,(p=(h=t.modules)==null?void 0:h.tracing)!=null?p:!0),l.info("DyteClient::init::options",{dyteClientInitOptions:{...t,authToken:`${(f=t.authToken)==null?void 0:f.slice(0,10)}...
${(v=t.authToken)==null?void 0:v.slice(-10)}`}});const c=await Ia.init(o),u=new ws(o,c);return le(y=u,kd,Gv).call(y,t),u}static setupContext(t,e,r,n){var o;const i=pa.createContext(t,e),a={...tb,...e==null?void 0:e.modules};return i.setValue("peerId",t),i.setValue("modules",a),i.setValue("sdkName","web-core"),i.setValue("meetingId",r),i.setValue("apiBase",n.apiBase),i.setValue("baseURI",n.baseURI),i.setValue("userId",n.participantId),i.setValue("organizationId",n.orgId),i.setValue("authToken",e.authToken),i.setValue("overrides",(o=e.overrides)!=null?o:{}),i.setValue("env",rb({baseURI:n.baseURI})),i.setValue("defaults",e.defaults||{audio:!0,video:!0}),i.setValue("cachedUserDetails",wr(e.cachedUserDetails)),i.setValue("sdkVersion","2.1.8-staging.7"),i}async join(){const{selfController:t}=d(this,ct);return t.self.roomJoined?null:t.joinRoom()}async leave(t){vv.cleanup();const{selfController:e}=d(this,ct);return e.leaveRoom(t)}get participants(){var t;return(t=d(this,ct).participantController)==null?void 0:t.participants}get self(){var t;return(t=d(this,ct).selfController)==null?void 0:t.self}get meta(){var t;return(t=d(this,ct).metaController)==null?void 0:t.meta}get ai(){var t;return(t=d(this,ct).metaController)==null?void 0:t.ai}get plugins(){var t;return(t=d(this,ct).pluginController)==null?void 0:t.plugins}get chat(){var t;return(t=d(this,ct).chatController)==null?void 0:t.chat}get polls(){var t;return(t=d(this,ct).pollController)==null?void 0:t.polls}get connectedMeetings(){var t;return(t=d(this,fo))==null?void 0:t.connectedMeetings}get recording(){var t;return(t=d(this,ct).recordingController)==null?void 0:t.recording}get livestream(){var t;return(t=d(this,ct).livestreamController)==null?void 0:t.livestream}get stage(){var t;return(t=d(this,ct).stageController)==null?void 0:t.stage}get stores(){return d(this,ct).storesManager}get __internals__(){var t;return(t=d(this,ct).internalsController)==null?void 0:t.internals}async joinRoom(){return this.join()}async leaveRoom(t){return this.leave(t)}},ct=new WeakMap,fo=new WeakMap,go=new WeakMap,kd=new WeakSet,Gv=function(t){T(this,fo,ld.init(d(this,go),this,t))},Uv);ud([mt("0002"),vs.executeWithLock({methodName:"meeting.join",lockName:"DyteClient.join",timeout:3e3})],ws.prototype,"join",1),ud([mt("0003")],ws.prototype,"leave",1),ud([mt("0001"),vs.executeWithLock({methodName:"DyteClient.init",lockName:"DyteClient.init",timeout:3e3})],ws,"init",1),ws=ud([mt("0000")],ws);const yv=ws;return yv}();
